<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>AFLæºç é˜…è¯»ï¼ˆäºŒï¼‰ï¼šMain Payload æ±‡ç¼–</title>
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" type="text/css" href="../assets/built/screen%EF%B9%96v=792c672b3c.css" />

    <meta name="description" content="AFL æºç é˜…è¯»çš„ç¬¬äºŒç¯‡ã€‚æœ¬æ–‡è¯¦ç»†è§£è¯»äº† AFL main payload æ±‡ç¼–ä»£ç ï¼Œåˆ†æäº†å…±äº«å†…å­˜åŒºåŸŸçš„å»ºç«‹æ–¹å¼å’Œ fork server é€»è¾‘ã€‚" />
    <link rel="icon" href="../content/images/size/w256h256/2020/02/small-3.png" type="image/png" />
    <link rel="canonical" href="index.html" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    <link rel="amphtml" href="amp/index.html" />
    
    <meta property="og:site_name" content="Pion1eer" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="AFLæºç é˜…è¯»ï¼ˆäºŒï¼‰ï¼šMain Payload æ±‡ç¼–" />
    <meta property="og:description" content="AFL æºç é˜…è¯»çš„ç¬¬äºŒç¯‡ã€‚æœ¬æ–‡è¯¦ç»†è§£è¯»äº† AFL main payload æ±‡ç¼–ä»£ç ï¼Œåˆ†æäº†å…±äº«å†…å­˜åŒºåŸŸçš„å»ºç«‹æ–¹å¼å’Œ fork server é€»è¾‘ã€‚" />
    <meta property="og:url" content="https://www.ruanx.net/afl-source-2/" />
    <meta property="og:image" content="https://www.ruanx.net/content/images/2023/05/output-3.jpg" />
    <meta property="article:published_time" content="2023-05-16T03:35:25.000Z" />
    <meta property="article:modified_time" content="2023-05-16T06:41:34.000Z" />
    <meta property="article:tag" content="Fuzzing" />
    
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="AFLæºç é˜…è¯»ï¼ˆäºŒï¼‰ï¼šMain Payload æ±‡ç¼–" />
    <meta name="twitter:description" content="AFL æºç é˜…è¯»çš„ç¬¬äºŒç¯‡ã€‚æœ¬æ–‡è¯¦ç»†è§£è¯»äº† AFL main payload æ±‡ç¼–ä»£ç ï¼Œåˆ†æäº†å…±äº«å†…å­˜åŒºåŸŸçš„å»ºç«‹æ–¹å¼å’Œ fork server é€»è¾‘ã€‚" />
    <meta name="twitter:url" content="https://www.ruanx.net/afl-source-2/" />
    <meta name="twitter:image" content="https://www.ruanx.net/content/images/2023/05/output-3.jpg" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Ruan Xingzhi" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Fuzzing" />
    <meta property="og:image:width" content="640" />
    <meta property="og:image:height" content="480" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Pion1eer",
        "url": "https://www.ruanx.net/",
        "logo": {
            "@type": "ImageObject",
            "url": "https://www.ruanx.net/content/images/size/w256h256/2020/02/small-3.png",
            "width": 60,
            "height": 60
        }
    },
    "author": {
        "@type": "Person",
        "name": "Ruan Xingzhi",
        "image": {
            "@type": "ImageObject",
            "url": "https://www.ruanx.net/content/images/2020/05/blue.jpeg",
            "width": 1024,
            "height": 1024
        },
        "url": "../author/blue/index.html",
        "sameAs": []
    },
    "headline": "AFLæºç é˜…è¯»ï¼ˆäºŒï¼‰ï¼šMain Payload æ±‡ç¼–",
    "url": "https://www.ruanx.net/afl-source-2/",
    "datePublished": "2023-05-16T03:35:25.000Z",
    "dateModified": "2023-05-16T06:41:34.000Z",
    "image": {
        "@type": "ImageObject",
        "url": "https://www.ruanx.net/content/images/2023/05/output-3.jpg",
        "width": 640,
        "height": 480
    },
    "keywords": "Fuzzing",
    "description": "AFL æºç é˜…è¯»çš„ç¬¬äºŒç¯‡ã€‚æœ¬æ–‡è¯¦ç»†è§£è¯»äº† AFL main payload æ±‡ç¼–ä»£ç ï¼Œåˆ†æäº†å…±äº«å†…å­˜åŒºåŸŸçš„å»ºç«‹æ–¹å¼å’Œ fork server é€»è¾‘ã€‚",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://www.ruanx.net/"
    }
}
    </script>

    <meta name="generator" content="Ghost 5.8" />
    <link rel="alternate" type="application/rss+xml" title="Pion1eer" href="../rss/index.rss" />
    <script defer src="https://cdn.jsdelivr.net/npm/@tryghost/portal@~2.5/umd/portal.min.js" data-ghost="https://www.ruanx.net/" data-key="595acd8f13c14d79a10527399d" data-api="https://www.ruanx.net/ghost/api/content/" crossorigin="anonymous"></script><style id="gh-members-styles">.gh-post-upgrade-cta-content,
.gh-post-upgrade-cta {
    display: flex;
    flex-direction: column;
    align-items: center;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    text-align: center;
    width: 100%;
    color: #ffffff;
    font-size: 16px;
}

.gh-post-upgrade-cta-content {
    border-radius: 8px;
    padding: 40px 4vw;
}

.gh-post-upgrade-cta h2 {
    color: #ffffff;
    font-size: 28px;
    letter-spacing: -0.2px;
    margin: 0;
    padding: 0;
}

.gh-post-upgrade-cta p {
    margin: 20px 0 0;
    padding: 0;
}

.gh-post-upgrade-cta small {
    font-size: 16px;
    letter-spacing: -0.2px;
}

.gh-post-upgrade-cta a {
    color: #ffffff;
    cursor: pointer;
    font-weight: 500;
    box-shadow: none;
    text-decoration: underline;
}

.gh-post-upgrade-cta a:hover {
    color: #ffffff;
    opacity: 0.8;
    box-shadow: none;
    text-decoration: underline;
}

.gh-post-upgrade-cta a.gh-btn {
    display: block;
    background: #ffffff;
    text-decoration: none;
    margin: 28px 0 0;
    padding: 8px 18px;
    border-radius: 4px;
    font-size: 16px;
    font-weight: 600;
}

.gh-post-upgrade-cta a.gh-btn:hover {
    opacity: 0.92;
}</style>
    <script defer src="https://cdn.jsdelivr.net/npm/@tryghost/sodo-search@~1.1/umd/sodo-search.min.js" data-key="595acd8f13c14d79a10527399d" data-styles="https://cdn.jsdelivr.net/npm/@tryghost/sodo-search@~1.1/umd/main.css" data-sodo-search="https://www.ruanx.net/" crossorigin="anonymous"></script>
    <script defer src="../public/cards.min%EF%B9%96v=792c672b3c.js"></script>
    <link rel="stylesheet" type="text/css" href="../public/cards.min%EF%B9%96v=792c672b3c.css">
    <!-- link href="https://fonts.googleapis.com/css?family=Noto+Serif+SC&display=swap" rel="stylesheet" -->

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fira+Mono&amp;family=Noto+Serif+SC&amp;display=swap" rel="stylesheet">

<style>.post-content,.post-card-excerpt{font-family: 'Noto Serif SC', "PingFang SC","Helvetica Neue",Helvetica,"Hiragino Sans GB","Microsoft YaHei","å¾®è½¯é›…é»‘",Arial,sans-serif;}
    .post-full-content{font-size: 100%;}
    .post-full-custom-excerpt {font-size: 1.8rem;}
    .post-full-title {font-size:3.2rem;}
    .post-full-content blockquote{margin:20px;padding: 1em;  background-color: #3eb0ef14; }
    .post-full-content blockquote p {font-style:normal;}
    .post-full-image {display:none;}
    
    /* .post-full-content figcaption {margin: .4em 0 .5em  !important} */
    
    .kg-callout-card {width: 100%; margin-bottom: 1em;}
    
    .post-full-content figure {margin: 0.8em 0 1em;}
    
    p {margin: 0.2em 0 0.5em !important;}
    
    .post-full-content img{border-radius:5px;}
    
    code {font-family: 'Noto Serif SC';}
</style>


<style>:root {--ghost-accent-color: #15171A;}</style>

</head>
<body class="post-template tag-fuzzing">

    <div class="site-wrapper">

        

<header class="site-header">
    <div class="outer site-nav-main">
    <div class="inner">
        <nav class="site-nav">
    <div class="site-nav-left-wrapper">
        <div class="site-nav-left">
                <a class="site-nav-logo" href="../index.html">Pion1eer</a>
            <div class="site-nav-content">
                    <ul class="nav">
    <li class="nav-home"><a href="../index.html">Home</a></li>
    <li class="nav-about"><a href="../about/index.html">About</a></li>
</ul>

                    <span class="nav-post-title dash">AFLæºç é˜…è¯»ï¼ˆäºŒï¼‰ï¼šMain Payload æ±‡ç¼–</span>
            </div>
        </div>
    </div>
    <div class="site-nav-right">
            <div class="social-links">
            </div>
                <a class="rss-button" href="https://feedly.com/i/subscription/feed/https://www.ruanx.net/rss/" title="RSS" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="6.18" cy="17.82" r="2.18"/><path d="M4 4.44v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/></svg>
</a>

    </div>
</nav>
    </div>
</div>

<script>
 MathJax = {
        tex:{
                inlineMath: [['$', '$'], ['\\(', '\\)']]
            },
        svg:{
                fontCache: 'global'
            }
        }; 
    </script>
    <script src="https://cdn.staticfile.org/babel-polyfill/7.12.1/polyfill.min.js?features=es6"></script>
    <script type="text/javascript" id="MathJax-script" async  src="https://cdn.staticfile.org/mathjax/3.2.2/es5/tex-mml-chtml.js"></script>

<style>@media (prefers-color-scheme: light) {
		.post-full-content  
    pre{background:#fafafa;margin:10px 10px 20px 10px;border-style: solid;border-color:#DCDFE6;}
}
</style>

<link rel="stylesheet" href="https://cdn.ruanx.net/css/atom-one-dark.css">
<link rel="stylesheet" media="(prefers-color-scheme: light)" href="https://cdn.ruanx.net/css/atom-one-light.min.css">
<style>.post-full-content  code{font-family: 'Fira Mono', 'Jetbrains mono', 'ubuntu mono', consolas, 'monospace' !important;}
</style>

</header>


<main id="site-main" class="site-main outer">
    <div class="inner">

        <article class="post-full post tag-fuzzing ">

            <header class="post-full-header">

                <section class="post-full-tags">
                    <a href="../tag/fuzzing/index.html">Fuzzing</a>
                </section>

                <h1 class="post-full-title">AFLæºç é˜…è¯»ï¼ˆäºŒï¼‰ï¼šMain Payload æ±‡ç¼–</h1>

                <p class="post-full-custom-excerpt">AFL æºç é˜…è¯»çš„ç¬¬äºŒç¯‡ã€‚æœ¬æ–‡è¯¦ç»†è§£è¯»äº† AFL main payload æ±‡ç¼–ä»£ç ï¼Œåˆ†æäº†å…±äº«å†…å­˜åŒºåŸŸçš„å»ºç«‹æ–¹å¼å’Œ fork server é€»è¾‘ã€‚</p>

                <div class="post-full-byline">

                    <section class="post-full-byline-content">

                        <ul class="author-list">
                            <li class="author-list-item">

                                <div class="author-card">
                                    <img class="author-profile-image" src="../content/images/size/w100/2020/05/blue.jpeg" alt="Ruan Xingzhi" />
                                    <div class="author-info">
                                        <div class="bio">
                                            <h2>Ruan Xingzhi</h2>
                                            <p>Welcome to my site and hope you have fun.</p>
                                            <p><a href="../author/blue/index.html">More posts</a> by Ruan Xingzhi.</p>
                                        </div>
                                    </div>
                                </div>

                                <a href="../author/blue/index.html" class="author-avatar">
                                    <img class="author-profile-image" src="../content/images/size/w100/2020/05/blue.jpeg" alt="Ruan Xingzhi" />
                                </a>

                            </li>
                        </ul>

                        <section class="post-full-byline-meta">
                            <h4 class="author-name"><a href="../author/blue/index.html">Ruan Xingzhi</a></h4>
                            <div class="byline-meta-content">
                                <time class="byline-meta-date" datetime="2023-05-16">16 May 2023</time>
                                <span class="byline-reading-time"><span class="bull">&bull;</span> 12 min read</span>
                            </div>
                        </section>

                    </section>


                </div>
            </header>

            <figure class="post-full-image">
                <img
                    srcset="../content/images/size/w300/2023/05/output-3.jpg 300w,
                            ../content/images/size/w600/2023/05/output-3.jpg 600w,
                            ../content/images/size/w1000/2023/05/output-3.jpg 1000w,
                            ../content/images/size/w2000/2023/05/output-3.jpg 2000w"
                    sizes="(max-width: 800px) 400px,
                        (max-width: 1170px) 1170px,
                            2000px"
                    src="../content/images/size/w2000/2023/05/output-3.jpg"
                    alt="AFLæºç é˜…è¯»ï¼ˆäºŒï¼‰ï¼šMain Payload æ±‡ç¼–"
                />
            </figure>

            <section class="post-full-content">
                <div class="post-content">
                    <p>ã€€ã€€åœ¨<a href="../afl-source-1/index.html">ä¸Šæ–‡</a>ä¸­ï¼Œæˆ‘ä»¬åˆ†æäº† AFL æ’å…¥åŸºæœ¬å—å…¥å£çš„æ¡©ä»£ç ã€‚å…¶ä¸­æœ‰ä¸€ä¸ª <code>__afl_maybe_log</code> å‡½æ•°è¢«ç”¨äºä¿®æ”¹ shm å†…å­˜åŒºåŸŸï¼Œè€Œè¿™å—å†…å­˜åŒºåŸŸçš„åˆå§‹åŒ–ã€fork server ç­‰å†…å®¹ï¼Œéƒ½åœ¨ main payload è¿™ä¸€æ®µçº¦ 300 è¡Œçš„æ±‡ç¼–ä¸­ã€‚</p><p>ã€€ã€€æœ¬æ–‡ä¾¿æ¥è§£æè¿™ä¸€å¥— main payloadã€‚æˆ‘ä»¬æš‚ä¸”åªå…³å¿ƒ x64 Linux å¹³å°ä¸‹çš„ç‰ˆæœ¬ã€‚</p><h3 id="0x01-%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E5%88%9D%E5%A7%8B%E5%8C%96">0x01 å…±äº«å†…å­˜åˆå§‹åŒ–</h3><p>ã€€ã€€å…ˆç”¨ IDA çœ‹ä¸€ä¸‹åŸºæœ¬å—ï¼š</p><figure class="kg-card kg-image-card"><img src="../content/images/2023/05/image-5.png" class="kg-image" alt loading="lazy" width="2000" height="1093" srcset="../content/images/size/w600/2023/05/image-5.png 600w, ../content/images/size/w1000/2023/05/image-5.png 1000w, ../content/images/size/w1600/2023/05/image-5.png 1600w, ../content/images/2023/05/image-5.png 2118w" sizes="(min-width: 720px) 720px"></figure><p>ã€€ã€€å¯è§è¿™æ®µä»£ç çš„å…¥å£ç‚¹æœ‰ä¸”ä»…æœ‰ <code>__afl_maybe_log</code>ã€‚åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å·²ç»è¿½è¸ªè¿‡ AFL æ˜¯å¦‚ä½•è®°å½•åŸºæœ¬å—è·³è½¬çš„ï¼šç®€è€Œè¨€ä¹‹ï¼Œæ¡©ä»£ç å°†å‡ ä¸ªå¯„å­˜å™¨çš„å€¼ä¿å­˜åœ¨æ ˆä¸Šï¼Œç„¶åè°ƒç”¨ <code>__afl_maybe_log</code> ï¼›<code>__afl_maybe_log</code> é¦–å…ˆä¿å­˜å½“å‰ EFLAGS å¯„å­˜å™¨çŠ¶æ€ï¼Œç„¶åæ£€æŸ¥ shm åŒºåŸŸæ˜¯å¦å‡†å¤‡å¥½ï¼›å¦‚æœå·²ç»å‡†å¤‡å¥½ï¼Œåˆ™è¿›å…¥ <code>__afl_store</code> è¿‡ç¨‹ï¼Œç»™ shm åŒºåŸŸå¢åŠ  hit count åè¿”å›ã€‚</p><p>ã€€ã€€é‚£ä¹ˆï¼Œå¦‚æœæ­¤æ—¶ shm åŒºåŸŸæ²¡æœ‰å‡†å¤‡å¥½å‘¢ï¼Ÿè¿™å°±æ˜¯æœ¬æ–‡çš„å…³æ³¨ç‚¹ã€‚</p><figure class="kg-card kg-code-card"><pre><code class="language-c">__afl_maybe_log:

  lahf
  seto  %al

  /* Check if SHM region is already mapped. */

  movq  __afl_area_ptr(%rip), %rdx
  testq %rdx, %rdx
  je    __afl_setup

__afl_store:

  /* Calculate and store hit for the code location specified in rcx. */

  xorq __afl_prev_loc(%rip), %rcx
  xorq %rcx, __afl_prev_loc(%rip)
  shrq $1, __afl_prev_loc(%rip)

  incb (%rdx, %rcx, 1)

__afl_return:

  addb $127, %al
  sahf
  ret
</code></pre><figcaption>â–² ä¸Šä¸€ç¯‡æ–‡ç« åˆ†æçš„&nbsp;<code>__afl_maybe_log</code> ä»£ç ã€‚å¦‚æœ shm åŒºåŸŸå·²ç»å‡†å¤‡å¥½ï¼Œåˆ™ç›´æ¥å†™å…¥ shm åè¿”å›</figcaption></figure><p>ã€€ã€€ä»æ±‡ç¼–ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°ï¼Œå¦‚æœ <code>__afl_area_ptr</code> ç­‰äº 0ï¼Œåˆ™è®¤ä¸º shm æ²¡æœ‰æ˜ å°„å¥½ï¼Œè¿›å…¥ <code>__afl_setup</code> é€»è¾‘ã€‚è¿™é‡Œæä¸€å¥ï¼Œ <code>afl_area_ptr</code> è¿™ä¸ª 8 å­—èŠ‚çš„å˜é‡æ˜¯å®šä¹‰åœ¨ main payload çš„æœ«å°¾ï¼Œä¸€ä¸ª <code>.lcomm</code> ä¼ªæŒ‡ä»¤ã€‚åœ¨æ±‡ç¼–é˜¶æ®µå®Œæˆåï¼Œå®ƒè¢«æ”¾åœ¨ <code>.bss</code> æ®µã€‚</p><p>ã€€ã€€è·Ÿè¿› <code>__afl_setup</code> ï¼š</p><pre><code class="language-c">__afl_setup:

  /* Do not retry setup if we had previous failures. */

  cmpb $0, __afl_setup_failure(%rip)
  jne __afl_return

  /* Check out if we have a global pointer on file. */

  movq  __afl_global_area_ptr@GOTPCREL(%rip), %rdx
  movq  (%rdx), %rdx
  testq %rdx, %rdx
  je    __afl_setup_first

  movq %rdx, __afl_area_ptr(%rip)
  jmp  __afl_store</code></pre><p>ã€€ã€€é¦–å…ˆï¼Œå¦‚æœå‘ç° <code>__afl_setup_failure</code> å˜é‡ä¸ç­‰äº 0ï¼Œåˆ™ç›´æ¥è¿”å›ï¼›æ¥ç€ï¼Œå°è¯•ä» GOT è¡¨ä¸­å– <code>__afl_global_area_ptr</code>ï¼Œå¦‚æœå‘ç°æœ‰å€¼ï¼Œåˆ™ç”¨å…¶è¦†ç›– <code>__afl_area_ptr</code> ï¼Œè·³è½¬åˆ° <code>__afl_store</code> ï¼Œæ‰§è¡Œå¸¸è§„çš„ hit count++ï¼›å¦‚æœå‘ç° GOT è¡¨ä¸­çš„è¿™ä¸ª <code>__afl_global_area_ptr</code> æŒ‡é’ˆä¸º 0ï¼Œåˆ™è·³è½¬åˆ° <code>__afl_setup_first</code> ï¼Œå¼€å§‹åˆå§‹åŒ–å…±äº«å†…å­˜åŒºåŸŸã€‚</p><pre><code class="language-c">__afl_setup_first:

  /* Save everything that is not yet saved and that may be touched by
     getenv() and several other libcalls we'll be relying on. */

  leaq -352(%rsp), %rsp

  movq %rax,   0(%rsp)
  movq %rcx,   8(%rsp)
  movq %rdi,  16(%rsp)
  movq %rsi,  32(%rsp)
  movq %r8,   40(%rsp)
  movq %r9,   48(%rsp)
  movq %r10,  56(%rsp)
  movq %r11,  64(%rsp)

  movq %xmm0,  96(%rsp)
  movq %xmm1,  112(%rsp)
  movq %xmm2,  128(%rsp)
  movq %xmm3,  144(%rsp)
  movq %xmm4,  160(%rsp)
  movq %xmm5,  176(%rsp)
  movq %xmm6,  192(%rsp)
  movq %xmm7,  208(%rsp)
  movq %xmm8,  224(%rsp)
  movq %xmm9,  240(%rsp)
  movq %xmm10, 256(%rsp)
  movq %xmm11, 272(%rsp)
  movq %xmm12, 288(%rsp)
  movq %xmm13, 304(%rsp)
  movq %xmm14, 320(%rsp)
  movq %xmm15, 336(%rsp)

  /* Map SHM, jumping to __afl_setup_abort if something goes wrong. */

  /* The 64-bit ABI requires 16-byte stack alignment. We'll keep the
     original stack ptr in the callee-saved r12. */

  pushq %r12
  movq  %rsp, %r12
  subq  $16, %rsp
  andq  $0xfffffffffffffff0, %rsp

  leaq .AFL_SHM_ENV(%rip), %rdi
call getenv@PLT

  testq %rax, %rax
  je    __afl_setup_abort

  movq  %rax, %rdi
call atoi@PLT

  xorq %rdx, %rdx   /* shmat flags    */
  xorq %rsi, %rsi   /* requested addr */
  movq %rax, %rdi   /* SHM ID         */
call shmat@PLT

  cmpq $-1, %rax
  je   __afl_setup_abort

  /* Store the address of the SHM region. */

  movq %rax, %rdx
  movq %rax, __afl_area_ptr(%rip)

  movq __afl_global_area_ptr@GOTPCREL(%rip), %rdx
  movq %rax, (%rdx)
  movq %rax, %rdx

__afl_forkserver:
/* ...... */</code></pre><p>ã€€ã€€è§‚å¯Ÿ <code>__afl_setup_first</code> è¿‡ç¨‹ã€‚å®ƒé¦–å…ˆæŠŠä¸€äº› caller-save å¯„å­˜å™¨ä¿å­˜åœ¨æ ˆä¸Šï¼ˆè¿™æ˜¯ä¸ºäº†æ–¹ä¾¿åç»­åœ¨ fork server ä¸­æ¢å¤åŸæœ‰å¯„å­˜å™¨çŠ¶æ€ï¼‰ã€‚åœ¨åšå®Œè¿™äº›ä¿å­˜å·¥ä½œä¹‹åï¼Œä½œè€…å†™äº†è¿™å››è¡Œä»£ç ï¼š</p><pre><code class="language-c">  /* The 64-bit ABI requires 16-byte stack alignment. We'll keep the
     original stack ptr in the callee-saved r12. */

  pushq %r12
  movq  %rsp, %r12
  subq  $16, %rsp
  andq  $0xfffffffffffffff0, %rsp</code></pre><p>ã€€ã€€ä¿å­˜ r12 å¯„å­˜å™¨çš„å€¼ï¼›ç„¶åç”¨ r12 å¯„å­˜å™¨è®°å½•åŸå§‹çš„ rspï¼›æŠŠ rsp å‡å» 16ï¼Œå¹¶æ¸…ç©ºæœ€ä½ 4 bitã€‚æ³¨é‡Šä¸­æåˆ°ï¼Œæ ¹æ® <a href="https://docs.oracle.com/cd/E19253-01/816-5138/fcowb/index.html">ABI</a> è¦æ±‚ï¼Œæ ˆåœ°å€è¦åš 16 å­—èŠ‚å¯¹é½ã€‚è¿™æ ·ä¸€é¡¿æ“ä½œä¹‹åï¼Œ rsp ä¸€å®šæ˜¯ 16 çš„å€æ•°äº†ã€‚</p><p>ã€€ã€€ç»§ç»­å¾€ä¸‹çœ‹ï¼š</p><pre><code class="language-c">  leaq .AFL_SHM_ENV(%rip), %rdi
call getenv@PLT

  testq %rax, %rax
  je    __afl_setup_abort
</code></pre><p>ã€€ã€€è°ƒç”¨ <code>getenv("__AFL_SHM_ID")</code>ï¼Œå¦‚æœè¿”å› 0 åˆ™è¿›å…¥ <code>__afl_setup_abort</code> é”™è¯¯å¤„ç†æµç¨‹ï¼Œå¦åˆ™å¾€ä¸‹ç»§ç»­æ‰§è¡Œã€‚æˆ‘ä»¬å…ˆå»çœ‹é”™è¯¯å¤„ç†æµç¨‹ï¼š</p><pre><code class="language-c">__afl_setup_abort:

  /* Record setup failure so that we don't keep calling
     shmget() / shmat() over and over again. */

  incb __afl_setup_failure(%rip)

  movq %r12, %rsp
  popq %r12

  movq  0(%rsp), %rax
  movq  8(%rsp), %rcx
  movq 16(%rsp), %rdi
  movq 32(%rsp), %rsi
  movq 40(%rsp), %r8
  movq 48(%rsp), %r9
  movq 56(%rsp), %r10
  movq 64(%rsp), %r11

  movq  96(%rsp), %xmm0
  movq 112(%rsp), %xmm1
  movq 128(%rsp), %xmm2
  movq 144(%rsp), %xmm3
  movq 160(%rsp), %xmm4
  movq 176(%rsp), %xmm5
  movq 192(%rsp), %xmm6
  movq 208(%rsp), %xmm7
  movq 224(%rsp), %xmm8
  movq 240(%rsp), %xmm9
  movq 256(%rsp), %xmm10
  movq 272(%rsp), %xmm11
  movq 288(%rsp), %xmm12
  movq 304(%rsp), %xmm13
  movq 320(%rsp), %xmm14
  movq 336(%rsp), %xmm15

  leaq 352(%rsp), %rsp

  jmp __afl_return</code></pre><p>ã€€ã€€è¿™å°±æ˜¯æŠŠ <code>__afl_setup_failure</code> å˜é‡è‡ªå¢ï¼Œè¿˜åŸæ‰€æœ‰å¯„å­˜å™¨å¹¶è¿”å›ã€‚è‡³æ­¤ï¼Œæˆ‘ä»¬å‘ç°ï¼Œå¦‚æœç¯å¢ƒå˜é‡ <code>__AFL_SHM_ID</code> ä¸å­˜åœ¨ï¼Œåˆ™å…±äº«å†…å­˜çš„åˆå§‹åŒ–ä¼šå¤±è´¥ï¼Œä½†æ•´ä¸ªæ¡©ä»£ç å¯¹äºç›®æ ‡ç¨‹åºæ˜¯é€æ˜çš„â€”â€”æ— éæ˜¯ä¿å­˜äº†ä¸€äº›å¯„å­˜å™¨ã€æ‰§è¡Œäº†ä¸€äº›æ— å‰¯ä½œç”¨çš„ä»£ç ã€æœ€åæ¢å¤å¯„å­˜å™¨â€”â€”å› æ­¤ç›®æ ‡ç¨‹åºå¯ä»¥æ­£å¸¸æ‰§è¡Œã€‚è¿™ä¹Ÿè§£é‡Šäº†ä¸ºä½•æˆ‘ä»¬ä¸ä½¿ç”¨ <code>afl-fuzz</code> è€Œç›´æ¥è¿è¡Œæ’æ¡©åçš„ç›®æ ‡ç¨‹åºï¼Œä¹Ÿèƒ½æ‰§è¡Œå¦‚å¸¸ã€‚è¿™ä¸ªè®¾è®¡ä½“ç°äº† AFL çš„ç”¨æˆ·å‹å¥½æ€§ã€‚</p><p>ã€€ã€€å›è¿‡å¤´æ¥çœ‹ï¼Œå¦‚æœç¯å¢ƒå˜é‡ <code>__AFL_SHM_ID</code> å­˜åœ¨ï¼Œå°†ä¼šå‘ç”Ÿä»€ä¹ˆäº‹æƒ…ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><pre><code class="language-c">/* æ­¤æ—¶ %rax æ˜¯æŒ‡å‘ç¯å¢ƒå˜é‡ __AFL_SHM_ID çš„æŒ‡é’ˆ  */
  movq  %rax, %rdi
call atoi@PLT

  xorq %rdx, %rdx   /* shmat flags    */
  xorq %rsi, %rsi   /* requested addr */
  movq %rax, %rdi   /* SHM ID         */
call shmat@PLT

  cmpq $-1, %rax
  je   __afl_setup_abort
</code></pre><p>ã€€ã€€é¦–å…ˆæŠŠ <code>__AFL_SHM_ID</code> ä»å­—ç¬¦ä¸²è½¬æˆæ•´æ•°ï¼Œç„¶åè°ƒç”¨ <code>shmat(shmid, 0, 0)</code> ã€‚</p><div class="kg-card kg-callout-card kg-callout-card-grey"><div class="kg-callout-emoji">ğŸ““</div><div class="kg-callout-text">æŸ¥é˜…<a href="https://linux.die.net/man/2/shmat">æ–‡æ¡£</a>ï¼Œå¾—çŸ¥ <code>shmat</code> æ˜¯ shared memory attach çš„ç¼©å†™ï¼Œç”¨äº attach å…±äº«å†…å­˜ã€‚<br><br>ä¸‰ä¸ªå‚æ•°åˆ†åˆ«ä¸º <code>(int shmid, const void *shmaddr, int shmflg)</code> ï¼š<br>- <code>shmid</code> æ˜¯ç¯å¢ƒå˜é‡æä¾›çš„ï¼›<br>- <code>shmaddr</code> ç­‰äº 0ï¼Œåˆ™äº¤ç”±æ“ä½œç³»ç»Ÿè‡ªè¡Œé€‰æ‹©ä¸€ç‰‡åœ°å€ç©ºé—´ï¼›<br>- <code>shmflg</code> ç­‰äº 0ï¼Œé‡‡ç”¨é»˜è®¤è®¾ç½®ã€‚<br><br>å‡½æ•°çš„è¿”å›å€¼æ˜¯å…±äº«å†…å­˜èµ·ç‚¹çš„ä½ç½®ã€‚è‹¥ attach å¤±è´¥ï¼Œåˆ™è¿”å› $-1$ã€‚</div></div><p>ã€€ã€€ä¸Šé¢çš„æ±‡ç¼–ä»£ç ä¸­ï¼Œå¦‚æœå‘ç° attach å¤±è´¥ï¼Œåˆ™è¿›å…¥ AFL çš„é”™è¯¯å¤„ç†æµç¨‹ã€‚ä¸è¿‡è¯»åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªå°ç–‘é—®ï¼šä¸€ç‰‡å…±äº«å†…å­˜ï¼Œé¦–å…ˆåº”å½“ç”± <code>shmget()</code> åˆ›å»ºï¼Œå†ç”± <code>shmat()</code> æ˜ å°„åˆ°å½“å‰ç¨‹åºçš„è™šæ‹Ÿå†…å­˜ç©ºé—´ä¸­ã€‚é‚£ä¹ˆï¼Œ<strong>è¿™ç‰‡è™šæ‹Ÿå†…å­˜æ˜¯ä»€ä¹ˆæ—¶å€™åˆ›å»ºçš„ï¼Ÿ</strong>ç­”æ¡ˆæ˜¯ <code>afl-fuzz</code> åœ¨ <code>setup_shm()</code> æµç¨‹ä¸­è°ƒç”¨ <code>shmget()</code> åˆ›å»ºäº†è™šæ‹Ÿå†…å­˜ï¼Œå¹¶å°† shm id å†™å…¥ <code>__AFL_SHM_ID</code> ç¯å¢ƒå˜é‡ã€‚å¦‚æœæˆ‘ä»¬å¹¶éé€šè¿‡ <code>afl-fuzz</code> è¿è¡Œç¨‹åºï¼Œè‡ªç„¶è¿™ç‰‡è™šæ‹Ÿå†…å­˜ä¸ä¼šè¢«åˆ›å»ºï¼Œä¹Ÿä¸ä¼šå­˜åœ¨ <code>__AFL_SHM_ID</code> ç¯å¢ƒå˜é‡äº†ã€‚</p><p>ã€€ã€€è‡³æ­¤ï¼Œç¨‹åºæˆåŠŸåœ°å°† <code>afl-fuzz</code> è¿›ç¨‹æ‰€åˆ›å»ºçš„ä¸€ç‰‡å…±äº«å†…å­˜ï¼Œæ˜ å°„åˆ°äº†è‡ªå·±çš„è™šæ‹Ÿåœ°å€ç©ºé—´å†…ã€‚æ¥ç€çœ‹æ±‡ç¼–ï¼š</p><pre><code class="language-c">  /* Store the address of the SHM region. */

  movq %rax, %rdx
  movq %rax, __afl_area_ptr(%rip)

  movq __afl_global_area_ptr@GOTPCREL(%rip), %rdx
  movq %rax, (%rdx)
  movq %rax, %rdx

__afl_forkserver:
/* ...... */</code></pre><p>ã€€ã€€å°†å…±äº«å†…å­˜åŒºåŸŸçš„åœ°å€å­˜è¿› <code>__afl_area_ptr</code>ï¼Œå¹¶å†™è¿› GOT è¡¨ä¸­çš„ <code>__afl_global_area_ptr</code> æ¡ç›®ã€‚æœ€åï¼Œç”¨ rdx å¯„å­˜å™¨å­˜æ”¾å…±äº«å†…å­˜åœ°å€ï¼Œè¿›å…¥ fork serverã€‚</p><p>ã€€ã€€<strong>ä¸ºä½•åŒæ—¶æœ‰ </strong><code><strong>__afl_area_ptr</strong></code><strong> å’Œ </strong><code><strong>__afl_global_area_ptr</strong></code><strong> ï¼Ÿ</strong>æˆ‘ä»¬æ¥çœ‹å®ƒä»¬çš„å®šä¹‰ï¼Œä½äº main payload å°¾éƒ¨ï¼š</p><pre><code class="language-c">.AFL_VARS:

  .lcomm   __afl_area_ptr, 8
  .lcomm   __afl_prev_loc, 8
  .lcomm   __afl_fork_pid, 4
  .lcomm   __afl_temp, 4
  .lcomm   __afl_setup_failure, 1
  .comm    __afl_global_area_ptr, 8, 8

.AFL_SHM_ENV:
  .asciz "__AFL_SHM_ID"

/* --- END --- */</code></pre><p>ã€€ã€€å¯ä»¥çœ‹åˆ°ï¼Œ<code>__afl_area_ptr</code> æ˜¯ä¸€ä¸ª <code>lcomm</code>ï¼Œè€Œ <code>__afl_global_area_ptr</code> æ˜¯ä¸€ä¸ª <code>comm</code> ã€‚æ ¹æ®ä¸€ç¯‡ <a href="https://stackoverflow.com/questions/34157895/asm-what-is-a-local-common-area-and-difference-between-lcomm-and-comm">Stackoverflow é—®ç­”</a>ï¼Œ<code>lcomm</code> æœ‰ç‚¹ç±»ä¼¼äºå…¨å±€ static å˜é‡ï¼Œä¸åŒæ–‡ä»¶ä¸­çš„é‡å <code>lcomm</code> æ˜¯æŒ‡å‘ä¸åŒçš„åœ°å€ï¼›ä½† <code>comm</code> æœ‰ç‚¹ç±»ä¼¼äºå…¨å±€å˜é‡ï¼Œä¸åŒæ–‡ä»¶ä¸­çš„é‡å <code>comm</code> æŒ‡å‘åŒä¸€ä¸ªåœ°å€ã€‚</p><p>ã€€ã€€å› æ­¤ï¼Œè¿™ä¸ªé—®é¢˜çš„è§£ç­”æ˜¯ï¼šå‡å¦‚ç›®æ ‡ç¨‹åºæ˜¯å¤šä»½ä»£ç é“¾æ¥å½¢æˆçš„ï¼Œé‚£ä¹ˆï¼Œæ¯ä»½æ±‡ç¼–æ–‡ä»¶éƒ½æ‹¥æœ‰ AFL main payloadï¼›å¯¹äºç¼–è¯‘å‡ºçš„æ¯ä¸ªä»£ç ç‰‡æ®µï¼Œéƒ½ä¼šæœ‰è‡ªå·±å¯¹åº”çš„ <code>__afl_area_ptr</code> ã€‚ä½† <code>__afl_global_area_ptr</code> åªæœ‰ä¸€ä»½ï¼Œåªéœ€è¦ä¼˜å…ˆå‚è€ƒ <code>__afl_global_area_ptr</code> ï¼Œå°±èƒ½è®©æ‰€æœ‰æ¡©ä»£ç è®¿é—®çš„ shm ä¿æŒä¸€è‡´ã€‚</p><p>ã€€ã€€å®éªŒä¸€ä¸‹ã€‚å†™ä¸¤ä»½ä»£ç ï¼Œåˆå¹¶ç¼–è¯‘ï¼Œè§‚å¯Ÿ bss æ®µï¼Œè¯æ˜æˆ‘ä»¬çš„è§£é‡Šæ˜¯æ­£ç¡®çš„ï¼š</p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="../content/images/2023/05/image-6.png" class="kg-image" alt loading="lazy" width="1882" height="1006" srcset="../content/images/size/w600/2023/05/image-6.png 600w, ../content/images/size/w1000/2023/05/image-6.png 1000w, ../content/images/size/w1600/2023/05/image-6.png 1600w, ../content/images/2023/05/image-6.png 1882w" sizes="(min-width: 720px) 720px"><figcaption>â–² ç¼–è¯‘æŒ‡ä»¤ <code>afl-gcc main.c fun.c</code> ï¼Œæœ‰ä¸¤ä¸ªä¸åŒçš„ <code>__afl_area_ptr</code> ï¼Œä½†åªæœ‰ä¸€ä¸ª <code>__afl_global_area_ptr</code>&nbsp;</figcaption></figure><p> ã€€ã€€ä»¥ä¸Šï¼Œæˆ‘ä»¬åˆ†æå®Œäº† shm æ˜¯å¦‚ä½•åˆå§‹åŒ–çš„ã€‚æ¥ä¸‹æ¥ï¼Œè¯¥åˆ†æ fork server äº†ã€‚</p><h3 id="0x02-fork-server">0x02 fork server</h3><p>ã€€ã€€<a href="https://xidoo.top/2022/01/afl-white-book/#10-%E5%A4%8D%E5%88%B6%E6%9C%8D%E5%8A%A1%E5%99%A8-the-fork-server">AFL ç™½çš®ä¹¦</a>ä¸­æåˆ°ï¼Œ<code>execve()</code> çš„æ•ˆç‡æ¯”è¾ƒä½ã€‚fuzzer éœ€è¦é«˜é¢‘ç‡åœ°æ‰§è¡Œç›®æ ‡ç¨‹åºï¼Œæ˜¾ç„¶ä¸å®œåœ¨ <code>execve()</code> ä¸Šæµªè´¹è¿‡å¤šæ—¶é—´ã€‚AFL çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨ fork serverï¼šè®©ç¨‹åºåœ¨ç¬¬ä¸€ä¸ªåŸºæœ¬å—å¤„åœä¸‹ï¼Œç­‰å¾… fuzzer å‘é€æŒ‡ä»¤ï¼›æ”¶åˆ°æŒ‡ä»¤åç»§ç»­æ‰§è¡Œç¨‹åºï¼›æ‰§è¡Œå®Œæ¯•åï¼Œæ¢å¤ fork æ—¶çš„çŠ¶æ€ã€‚å¾—ç›Šäº copy-on-write æŠ€æœ¯ï¼Œæˆ‘ä»¬å¯ä»¥é«˜æ•ˆåœ°å®ç°è¿™ä¸€éœ€æ±‚ã€‚</p><p>ã€€ã€€æ¥çœ‹æ±‡ç¼–ä»£ç ï¼š</p><pre><code class="language-c">__afl_forkserver:

  /* Enter the fork server mode to avoid the overhead of execve() calls. We
     push rdx (area ptr) twice to keep stack alignment neat. */

  /* æ­¤æ—¶ %rdx å†…ä¿å­˜ shm åœ°å€ */
  pushq %rdx
  pushq %rdx

  /* Phone home and tell the parent that we're OK. (Note that signals with
     no SA_RESTART will mess it up). If this fails, assume that the fd is
     closed because we were execve()d from an instrumented binary, or because
     the parent doesn't want to use the fork server. */

  movq $4, %rdx               /* length    */
  leaq __afl_temp(%rip), %rsi /* data      */
  movq $(198 + 1), %rdi       /* file desc */
call write@PLT

  cmpq $4, %rax
  jne  __afl_fork_resume

__afl_fork_wait_loop:
/* ...... */</code></pre><p>ã€€ã€€æŠŠ shm åœ°å€è¿ç»­å‹æ ˆä¸¤æ¬¡ï¼ˆä»¥ä¿è¯ esp ä»ç„¶æ˜¯ 16 çš„å€æ•°ï¼‰ï¼Œç„¶åè°ƒç”¨ <code>write(198+1, __afl_temp, 4)</code>ã€‚å…¶ä¸­ï¼Œ198 è¿™ä¸€ magic numberï¼Œæ˜¯ <code>config.h</code> ä¸­çš„ <code>FORKSRV_FD</code> å¸¸é‡ã€‚fork server ä½¿ç”¨ 198ã€199 è¿™ä¸¤ä¸ª fd ä¼ é€’æŒ‡ä»¤ã€‚è€Œ <code>__afl_temp</code> æ˜¯ bss æ®µçš„é•¿åº¦ 4 å­—èŠ‚çš„å˜é‡ã€‚</p><p>ã€€ã€€å¦‚æœè¿™å››ä¸ªå­—èŠ‚å†™å…¥å¤±è´¥ï¼ˆ<code>write()</code> çš„è¿”å›ä¸ç­‰äº 4ï¼‰ï¼Œåˆ™ç›´æ¥è¿›å…¥ <code>__afl_fork_resume</code> é€»è¾‘ï¼›å¦åˆ™ï¼Œè¿›å…¥ <code>__afl_fork_wait_loop</code> é€»è¾‘ã€‚</p><p>ã€€ã€€è·Ÿè¿› <code>__afl_fork_wait_loop</code>ï¼š</p><pre><code class="language-c">__afl_fork_wait_loop:

  /* Wait for parent by reading from the pipe. Abort if read fails. */

  movq $4, %rdx               /* length    */
  leaq __afl_temp(%rip), %rsi /* data      */
  movq $198, %rdi             /* file desc */
call read@PLT
  cmpq $4, %rax
  jne  __afl_die
</code></pre><p>ã€€ã€€ä» fd 198 ä¸­è¯»å–å››ä¸ªå­—èŠ‚ï¼ˆæ³¨æ„ <code>read()</code> å‡½æ•°æ˜¯é˜»å¡çš„ï¼‰ã€‚å¦‚æœè¯»å–å¤±è´¥ï¼Œåˆ™è·³è½¬åˆ° <code>__afl_die</code>ã€‚å¦‚æœè¯»å–æˆåŠŸï¼Œåˆ™æ‰§è¡Œä¸‹é¢çš„ä»£ç ï¼š</p><pre><code class="language-c">  /* Once woken up, create a clone of our process. This is an excellent use
     case for syscall(__NR_clone, 0, CLONE_PARENT), but glibc boneheadedly
     caches getpid() results and offers no way to update the value, breaking
     abort(), raise(), and a bunch of other things :-( */

call fork@PLT
  cmpq $0, %rax
  jl   __afl_die
  je   __afl_fork_resume
</code></pre><p>ã€€ã€€åœ¨è¿™é‡Œè¿›è¡Œ forkï¼Œå¦‚æœå¤±è´¥äº†åˆ™è·³è½¬åˆ° <code>__afl_die</code>ã€‚å¯¹äºå­è¿›ç¨‹ï¼Œè·³è½¬åˆ° <code>__afl_fork_resume</code> ï¼›å¯¹äºçˆ¶è¿›ç¨‹ï¼Œåˆ™ç»§ç»­æ‰§è¡Œä»¥ä¸‹é€»è¾‘ï¼š</p><pre><code class="language-c">  /* In parent process: write PID to pipe, then wait for child. */

  movl %eax, __afl_fork_pid(%rip)

  movq $4, %rdx                   /* length    */
  leaq __afl_fork_pid(%rip), %rsi /* data      */
  movq $(198 + 1), %rdi             /* file desc */
call write@PLT

  movq $0, %rdx                   /* no flags  */
  leaq __afl_temp(%rip), %rsi     /* status    */
  movq __afl_fork_pid(%rip), %rdi /* PID       */
call waitpid@PLT
  cmpq $0, %rax
  jle  __afl_die

  /* Relay wait status to pipe, then loop back. */

  movq $4, %rdx               /* length    */
  leaq __afl_temp(%rip), %rsi /* data      */
  movq $(198 + 1), %rdi         /* file desc */
call write@PLT

  jmp  __afl_fork_wait_loop
</code></pre><p>ã€€ã€€è¿™æ®µä»£ç é€»è¾‘æ˜¯ï¼šå°†å­è¿›ç¨‹çš„ pid ä¿å­˜åˆ° <code>__afl_fork_pid</code> å˜é‡ï¼›å‘ fd 199 å†™å…¥å­è¿›ç¨‹çš„ pidï¼›è°ƒç”¨ <code>waitpid()</code> ç­‰å¾…å­è¿›ç¨‹æ‰§è¡Œå®Œæ¯•ï¼ˆå¦‚æœç­‰å¾…å¤±è´¥ï¼Œåˆ™è¿›å…¥ <code>__afl_die</code>ï¼‰ï¼›å°†å­è¿›ç¨‹çš„é€€å‡ºåŸå› å†™è¿› fd 199ï¼Œå¹¶å›åˆ° <code>__afl_fork_wait_loop</code>ã€‚</p><p>ã€€ã€€ä¹‹å‰æåˆ°ï¼Œfork ä¹‹åï¼Œå­è¿›ç¨‹ä¼šè·³è½¬åˆ° <code>__afl_fork_resume</code> é€»è¾‘ã€‚è·Ÿè¿›ï¼š</p><pre><code class="language-c">__afl_fork_resume:

  /* In child process: close fds, resume execution. */

  movq $198, %rdi
call close@PLT

  movq $(198 + 1), %rdi
call close@PLT

  popq %rdx
  popq %rdx

  movq %r12, %rsp
  popq %r12

  movq  0(%rsp), %rax
  movq  8(%rsp), %rcx
  movq 16(%rsp), %rdi
  movq 32(%rsp), %rsi
  movq 40(%rsp), %r8
  movq 48(%rsp), %r9
  movq 56(%rsp), %r10
  movq 64(%rsp), %r11

  movq  96(%rsp), %xmm0
  movq 112(%rsp), %xmm1
  movq 128(%rsp), %xmm2
  movq 144(%rsp), %xmm3
  movq 160(%rsp), %xmm4
  movq 176(%rsp), %xmm5
  movq 192(%rsp), %xmm6
  movq 208(%rsp), %xmm7
  movq 224(%rsp), %xmm8
  movq 240(%rsp), %xmm9
  movq 256(%rsp), %xmm10
  movq 272(%rsp), %xmm11
  movq 288(%rsp), %xmm12
  movq 304(%rsp), %xmm13
  movq 320(%rsp), %xmm14
  movq 336(%rsp), %xmm15

  leaq 352(%rsp), %rsp

  jmp  __afl_store
</code></pre><p>ã€€ã€€é¦–å…ˆå…³é—­ä»çˆ¶è¿›ç¨‹é‚£é‡Œç»§æ‰¿æ¥çš„ fd 198ã€199ï¼Œç„¶åæ¢å¤æ‰€æœ‰å¯„å­˜å™¨ï¼Œæ¢å¤æ ˆåœ°å€ï¼Œè·³è½¬åˆ° <code>__afl_store</code>ã€‚è€Œ <code>__afl_store</code> åœ¨å¢åŠ  hit count ä¹‹åï¼Œè·³è½¬å› AFL å¾€åŸºæœ¬å—å¤´éƒ¨æ’å…¥çš„æ¡©ä»£ç â€”â€”åˆ°æ­¤ä¸ºæ­¢ï¼Œå­è¿›ç¨‹æ¢å¤æ‰€æœ‰çŠ¶æ€ï¼Œå¼€å§‹äº†ç¨‹åºä¸­ç¬¬ä¸€ä¸ªåŸºæœ¬å—çš„æ‰§è¡Œã€‚</p><h3 id="0x03-%E6%80%BB%E7%BB%93">0x03 æ€»ç»“</h3><p>ã€€ã€€AFL main payload è®¾è®¡å¾—ç›¸å½“ç²¾å¦™ã€‚å®ƒè®©ç¨‹åºåœ¨ç¬¬ä¸€ä¸ªåŸºæœ¬å—å¤„åœä¸‹ï¼Œåˆå§‹åŒ–å…±äº«å†…å­˜ï¼Œå¹¶æ¯æ¬¡ä»è¿™ä¸ªä½ç½® fork å‡ºå­è¿›ç¨‹ã€æ¢å¤ç¨‹åºçŠ¶æ€ã€ç»§ç»­æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼›å­è¿›ç¨‹æ‰§è¡Œå®Œåï¼Œfork server åˆ™å‘ fuzzer æŠ¥å‘Šæ‰§è¡Œæƒ…å†µï¼Œå¼€å§‹æ–°ä¸€è½®æ‰§è¡Œã€‚é€šè¿‡ fork serverï¼ŒAFL å¾—ä»¥é¿å…é¢‘ç¹çš„ <code>execve</code> è°ƒç”¨ï¼Œä»è€Œæå‡äº† fuzz æ•ˆç‡ã€‚</p><p>ã€€ã€€å…±äº«å†…å­˜ç”± <code>afl-fuzz</code> ç¨‹åºå»ºç«‹ï¼Œå…¶ shm id è®°å½•åœ¨ç¯å¢ƒå˜é‡ <code>__AFL_SHM_ID</code> ä¸­ã€‚ç›®æ ‡ç¨‹åºåˆå§‹åŒ–æ—¶ï¼Œä¼šå°†è¿™å—å…±äº«å†…å­˜ attach åˆ°è‡ªå·±çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œä»è€Œ <code>afl-fuzz</code> è¿›ç¨‹å¯ä»¥ç»Ÿè®¡ hit countã€‚</p><p>ã€€ã€€fork server çš„åŠ¨ä½œç”± <code>afl-fuzz</code> è¿›ç¨‹æ§åˆ¶ã€‚ç›®æ ‡ç¨‹åºä¸ <code>afl-fuzz</code> é€è¿‡ fd ä¼ é€’ä¿¡æ¯â€”â€”fd 198 ç”¨äº fuzzer å‘ fork server å‘é€å¯åŠ¨æŒ‡ä»¤ï¼Œfd 199 ç”¨äº fork server å‘ fuzzer æŠ¥å‘Šå­è¿›ç¨‹çš„ pid å’Œæ‰§è¡Œç»“æœã€‚</p><p>ã€€ã€€ä¸ç›´è§‰ç›¸åï¼Œä¸€ä¸ªè¿è¡Œè¶…æ—¶çš„å­è¿›ç¨‹ï¼Œå¹¶ä¸æ˜¯ç”± fork server ç»“æŸçš„ï¼Œè€Œæ˜¯ç”± <code>afl-fuzz</code> ç»“æŸçš„ã€‚è¿™äº›å†…å®¹è¦ç­‰åˆ°æˆ‘ä»¬é˜…è¯» <code>afl-fuzz.c</code> æ—¶æ‰èƒ½ç»†è‡´æŒæ¡ã€‚</p><p>ã€€ã€€æ€»ä¹‹ï¼Œæˆ‘ä»¬å·²ç»é˜…è¯»å®Œäº† <code>afl-gcc.c</code> å’Œ <code>afl-as.c</code> è¿™ä¸¤ä»½ä»£ç ï¼Œå¯¹æ’æ¡©è¿‡ç¨‹æœ‰äº†è¯¦ç»†çš„äº†è§£ã€‚æŒ‰ç…§è®¡åˆ’ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å°†é˜…è¯» <code>afl-tmin.c</code> ï¼Œä»¥äº†è§£ AFL æ˜¯å¦‚ä½•æ”¶é›†ã€å¤„ç†ç¨‹åºçš„è¦†ç›–åº¦ä¿¡æ¯ã€‚</p>
                </div>
            </section>


            <div id="gitalk-container"></div>

            <link rel="stylesheet" href="https://cdn.staticfile.org/gitalk/1.6.2/gitalk.css">
            <script src="https://cdn.staticfile.org/gitalk/1.6.2/gitalk.min.js"></script>

            <script>
                const gitalk = new Gitalk({

                    proxy: 'https://cors.pion1eer.workers.dev/?https://github.com/login/oauth/access_token',

                    clientID: '9f7e67174f5ab8b1a2b9',
                    clientSecret: 'ddee425a0b50ed02a05fdedb1a4ea039e01b3170',
                    repo: 'blogComment',
                    owner: 'Ruanxingzhi',
                    admin: ['Ruanxingzhi'],
                    id: location.pathname,      // Ensure uniqueness and length less than 50
                    distractionFreeMode: false  // Facebook-like distraction free mode

                    });

                gitalk.render('gitalk-container');
            </script>

        </article>

    </div>
</main>

<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
                <article class="read-next-card">
                    <header class="read-next-card-header">
                        <h3><span>More in</span> <a href="../tag/fuzzing/index.html">Fuzzing</a></h3>
                    </header>
                    <div class="read-next-card-content">
                        <ul>
                            <li>
                                <h4><a href="../afl-source-1/index.html">AFLæºç é˜…è¯»ï¼ˆä¸€ï¼‰ï¼šå¯ç¨‹</a></h4>
                                <div class="read-next-card-meta">
                                    <p><time datetime="2023-05-07">7 May 2023</time> â€“
                                        25 min read</p>
                                </div>
                            </li>
                            <li>
                                <h4><a href="../fuzzing101-wp-5/index.html">Fuzzing101-5ï¼šLibXML2</a></h4>
                                <div class="read-next-card-meta">
                                    <p><time datetime="2022-11-02">2 Nov 2022</time> â€“
                                        5 min read</p>
                                </div>
                            </li>
                            <li>
                                <h4><a href="../fuzzing101-wp-4/index.html">Fuzzing101-4ï¼šLibTIFF</a></h4>
                                <div class="read-next-card-meta">
                                    <p><time datetime="2022-10-30">30 Oct 2022</time> â€“
                                        5 min read</p>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <footer class="read-next-card-footer">
                        <a href="../tag/fuzzing/index.html">See all 8 posts
                            â†’</a>
                    </footer>
                </article>


                <article class="post-card post tag-fuzzing ">

    <a class="post-card-image-link" href="../afl-source-1/index.html">
        <img class="post-card-image"
            srcset="../content/images/size/w300/2023/05/output-2.jpg 300w,
                    ../content/images/size/w600/2023/05/output-2.jpg 600w,
                    ../content/images/size/w1000/2023/05/output-2.jpg 1000w,
                    ../content/images/size/w2000/2023/05/output-2.jpg 2000w"
            sizes="(max-width: 1000px) 400px, 700px"
            src="../content/images/size/w600/2023/05/output-2.jpg"
            alt="AFLæºç é˜…è¯»ï¼ˆä¸€ï¼‰ï¼šå¯ç¨‹"
        />
    </a>

    <div class="post-card-content">

        <a class="post-card-content-link" href="../afl-source-1/index.html">

            <header class="post-card-header">
                    <div class="post-card-primary-tag">Fuzzing</div>
                <h2 class="post-card-title">AFLæºç é˜…è¯»ï¼ˆä¸€ï¼‰ï¼šå¯ç¨‹</h2>
            </header>

            <section class="post-card-excerpt">
                    <p>å¼€å§‹é˜…è¯» AFL çš„æºç ã€‚æœ¬æ–‡åˆ†æäº† AFL é¡¹ç›®çš„æ–‡ä»¶ç»“æ„ï¼Œç¡®å®šäº†é˜…è¯»ä»£ç çš„é¡ºåºï¼Œå¹¶è¯¦ç»†è§£é‡Šäº† afl-gcc å’Œ afl-as ä»£ç ã€‚</p>
            </section>

        </a>

        <footer class="post-card-meta">
            <ul class="author-list">
                <li class="author-list-item">
            
                    <div class="author-name-tooltip">
                        Ruan Xingzhi
                    </div>
            
                    <a href="../author/blue/index.html" class="static-avatar">
                        <img class="author-profile-image" src="../content/images/size/w100/2020/05/blue.jpeg" alt="Ruan Xingzhi" />
                    </a>
                </li>
            </ul>
            <div class="post-card-byline-content">
                <span><a href="../author/blue/index.html">Ruan Xingzhi</a></span>
                <span class="post-card-byline-date"><time datetime="2023-05-07">7 May 2023</time> <span class="bull">&bull;</span> 25 min read</span>
            </div>
        </footer>

    </div>

</article>
        </div>
    </div>
</aside>




        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="../index.html">Pion1eer</a> &copy; 2023</section>
                <nav class="site-footer-nav">
                    <a href="http://beian.miit.gov.cn/" target="_blank">æ¹˜ICPå¤‡20008720å·-1</a>
                    <a href="../index.html">Latest Posts</a>
                    
                    
                    <a href="https://ghost.org" target="_blank" rel="noopener">Ghost</a>
                </nav>
            </div>
        </footer>

    </div>

<!--

    <div class="subscribe-success-message">
        <a class="subscribe-close" href="javascript:;"></a>
        You've successfully subscribed to Pion1eer!
    </div>

    <div id="subscribe" class="subscribe-overlay">
        <a class="subscribe-close" href="#"></a>
        <div class="subscribe-overlay-content">
            <div class="subscribe-form">
                <h1 class="subscribe-overlay-title">Subscribe to Pion1eer</h1>
                <p class="subscribe-overlay-description">Stay up to date! Get all the latest & greatest posts delivered straight to your inbox</p>
                <form data-members-form="subscribe">
                    <div class="form-group">
                        <input class="subscribe-email" data-members-email placeholder="youremail@example.com"
                            autocomplete="false" />
                        <button class="button primary" type="submit">
                            <span class="button-content">Subscribe</span>
                            <span class="button-loader"><svg version="1.1" id="loader-1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px"
    y="0px" width="40px" height="40px" viewBox="0 0 40 40" enable-background="new 0 0 40 40" xml:space="preserve">
    <path opacity="0.2" fill="#000" d="M20.201,5.169c-8.254,0-14.946,6.692-14.946,14.946c0,8.255,6.692,14.946,14.946,14.946
s14.946-6.691,14.946-14.946C35.146,11.861,28.455,5.169,20.201,5.169z M20.201,31.749c-6.425,0-11.634-5.208-11.634-11.634
c0-6.425,5.209-11.634,11.634-11.634c6.425,0,11.633,5.209,11.633,11.634C31.834,26.541,26.626,31.749,20.201,31.749z" />
    <path fill="#000" d="M26.013,10.047l1.654-2.866c-2.198-1.272-4.743-2.012-7.466-2.012h0v3.312h0
C22.32,8.481,24.301,9.057,26.013,10.047z">
        <animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 20 20" to="360 20 20"
            dur="0.5s" repeatCount="indefinite" />
    </path>
</svg></span>
                        </button>
                    </div>
                    <div class="message-success">
                        <strong>Great!</strong> Check your inbox and click the link to confirm your subscription.
                    </div>
                    <div class="message-error">
                        Please enter a valid email address!
                    </div>
                </form>
            </div>
        </div>
    </div>

-->

    <script
        src="https://cdn.ruanx.net/js/jquery.min.js"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
        crossorigin="anonymous">
    </script>
    <script src="../assets/built/casper%EF%B9%96v=792c672b3c.js"></script>

    <script>
        // Parse the URL parameter
        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        // Give the parameter a variable name
        var action = getParameterByName('action');

        $(document).ready(function () {
            if (action == 'subscribe') {
                $('body').addClass("subscribe-success");
            }

            $('.subscribe-success-message .subscribe-close').click(function () {
                $('.subscribe-success-message').addClass('close');
            });

            // Reset form on opening subscrion overlay
            $('.subscribe-button').click(function() {
                $('.subscribe-overlay form').removeClass();
                $('.subscribe-email').val('');
            });
        });
    </script>

    <script>
    $(document).ready(function () {
        // FitVids - start
        var $postContent = $(".post-full-content");
        $postContent.fitVids();
        // FitVids - end

        // Replace nav with title on scroll - start
        Casper.stickyNavTitle({
            navSelector: '.site-nav-main',
            titleSelector: '.post-full-title',
            activeClass: 'nav-post-title-active'
        });
        // Replace nav with title on scroll - end

        // Hover on avatar
        var hoverTimeout;
        $('.author-list-item').hover(function () {
            var $this = $(this);

            clearTimeout(hoverTimeout);

            $('.author-card').removeClass('hovered');
            $(this).children('.author-card').addClass('hovered');

        }, function () {
            var $this = $(this);

            hoverTimeout = setTimeout(function () {
                $this.children('.author-card').removeClass('hovered');
            }, 800);
        });
    });
</script>

<script src="https://cdn.staticfile.org/highlight.js/10.1.1/highlight.min.js"></script>
<script >hljs.initHighlightingOnLoad();</script>



    <style>.kg-bookmark-metadata > .kg-bookmark-publisher:before {
    content: "" !important; 
    margin: 0 !important;
}
</style>

</body>
</html>
