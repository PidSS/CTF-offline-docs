<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>AFL源码阅读（二）：Main Payload 汇编</title>
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" type="text/css" href="../assets/built/screen%EF%B9%96v=792c672b3c.css" />

    <meta name="description" content="AFL 源码阅读的第二篇。本文详细解读了 AFL main payload 汇编代码，分析了共享内存区域的建立方式和 fork server 逻辑。" />
    <link rel="icon" href="../content/images/size/w256h256/2020/02/small-3.png" type="image/png" />
    <link rel="canonical" href="index.html" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    <link rel="amphtml" href="amp/index.html" />
    
    <meta property="og:site_name" content="Pion1eer" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="AFL源码阅读（二）：Main Payload 汇编" />
    <meta property="og:description" content="AFL 源码阅读的第二篇。本文详细解读了 AFL main payload 汇编代码，分析了共享内存区域的建立方式和 fork server 逻辑。" />
    <meta property="og:url" content="https://www.ruanx.net/afl-source-2/" />
    <meta property="og:image" content="https://www.ruanx.net/content/images/2023/05/output-3.jpg" />
    <meta property="article:published_time" content="2023-05-16T03:35:25.000Z" />
    <meta property="article:modified_time" content="2023-05-16T06:41:34.000Z" />
    <meta property="article:tag" content="Fuzzing" />
    
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="AFL源码阅读（二）：Main Payload 汇编" />
    <meta name="twitter:description" content="AFL 源码阅读的第二篇。本文详细解读了 AFL main payload 汇编代码，分析了共享内存区域的建立方式和 fork server 逻辑。" />
    <meta name="twitter:url" content="https://www.ruanx.net/afl-source-2/" />
    <meta name="twitter:image" content="https://www.ruanx.net/content/images/2023/05/output-3.jpg" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Ruan Xingzhi" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Fuzzing" />
    <meta property="og:image:width" content="640" />
    <meta property="og:image:height" content="480" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Pion1eer",
        "url": "https://www.ruanx.net/",
        "logo": {
            "@type": "ImageObject",
            "url": "https://www.ruanx.net/content/images/size/w256h256/2020/02/small-3.png",
            "width": 60,
            "height": 60
        }
    },
    "author": {
        "@type": "Person",
        "name": "Ruan Xingzhi",
        "image": {
            "@type": "ImageObject",
            "url": "https://www.ruanx.net/content/images/2020/05/blue.jpeg",
            "width": 1024,
            "height": 1024
        },
        "url": "../author/blue/index.html",
        "sameAs": []
    },
    "headline": "AFL源码阅读（二）：Main Payload 汇编",
    "url": "https://www.ruanx.net/afl-source-2/",
    "datePublished": "2023-05-16T03:35:25.000Z",
    "dateModified": "2023-05-16T06:41:34.000Z",
    "image": {
        "@type": "ImageObject",
        "url": "https://www.ruanx.net/content/images/2023/05/output-3.jpg",
        "width": 640,
        "height": 480
    },
    "keywords": "Fuzzing",
    "description": "AFL 源码阅读的第二篇。本文详细解读了 AFL main payload 汇编代码，分析了共享内存区域的建立方式和 fork server 逻辑。",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://www.ruanx.net/"
    }
}
    </script>

    <meta name="generator" content="Ghost 5.8" />
    <link rel="alternate" type="application/rss+xml" title="Pion1eer" href="../rss/index.rss" />
    <script defer src="https://cdn.jsdelivr.net/npm/@tryghost/portal@~2.5/umd/portal.min.js" data-ghost="https://www.ruanx.net/" data-key="595acd8f13c14d79a10527399d" data-api="https://www.ruanx.net/ghost/api/content/" crossorigin="anonymous"></script><style id="gh-members-styles">.gh-post-upgrade-cta-content,
.gh-post-upgrade-cta {
    display: flex;
    flex-direction: column;
    align-items: center;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    text-align: center;
    width: 100%;
    color: #ffffff;
    font-size: 16px;
}

.gh-post-upgrade-cta-content {
    border-radius: 8px;
    padding: 40px 4vw;
}

.gh-post-upgrade-cta h2 {
    color: #ffffff;
    font-size: 28px;
    letter-spacing: -0.2px;
    margin: 0;
    padding: 0;
}

.gh-post-upgrade-cta p {
    margin: 20px 0 0;
    padding: 0;
}

.gh-post-upgrade-cta small {
    font-size: 16px;
    letter-spacing: -0.2px;
}

.gh-post-upgrade-cta a {
    color: #ffffff;
    cursor: pointer;
    font-weight: 500;
    box-shadow: none;
    text-decoration: underline;
}

.gh-post-upgrade-cta a:hover {
    color: #ffffff;
    opacity: 0.8;
    box-shadow: none;
    text-decoration: underline;
}

.gh-post-upgrade-cta a.gh-btn {
    display: block;
    background: #ffffff;
    text-decoration: none;
    margin: 28px 0 0;
    padding: 8px 18px;
    border-radius: 4px;
    font-size: 16px;
    font-weight: 600;
}

.gh-post-upgrade-cta a.gh-btn:hover {
    opacity: 0.92;
}</style>
    <script defer src="https://cdn.jsdelivr.net/npm/@tryghost/sodo-search@~1.1/umd/sodo-search.min.js" data-key="595acd8f13c14d79a10527399d" data-styles="https://cdn.jsdelivr.net/npm/@tryghost/sodo-search@~1.1/umd/main.css" data-sodo-search="https://www.ruanx.net/" crossorigin="anonymous"></script>
    <script defer src="../public/cards.min%EF%B9%96v=792c672b3c.js"></script>
    <link rel="stylesheet" type="text/css" href="../public/cards.min%EF%B9%96v=792c672b3c.css">
    <!-- link href="https://fonts.googleapis.com/css?family=Noto+Serif+SC&display=swap" rel="stylesheet" -->

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fira+Mono&amp;family=Noto+Serif+SC&amp;display=swap" rel="stylesheet">

<style>.post-content,.post-card-excerpt{font-family: 'Noto Serif SC', "PingFang SC","Helvetica Neue",Helvetica,"Hiragino Sans GB","Microsoft YaHei","微软雅黑",Arial,sans-serif;}
    .post-full-content{font-size: 100%;}
    .post-full-custom-excerpt {font-size: 1.8rem;}
    .post-full-title {font-size:3.2rem;}
    .post-full-content blockquote{margin:20px;padding: 1em;  background-color: #3eb0ef14; }
    .post-full-content blockquote p {font-style:normal;}
    .post-full-image {display:none;}
    
    /* .post-full-content figcaption {margin: .4em 0 .5em  !important} */
    
    .kg-callout-card {width: 100%; margin-bottom: 1em;}
    
    .post-full-content figure {margin: 0.8em 0 1em;}
    
    p {margin: 0.2em 0 0.5em !important;}
    
    .post-full-content img{border-radius:5px;}
    
    code {font-family: 'Noto Serif SC';}
</style>


<style>:root {--ghost-accent-color: #15171A;}</style>

</head>
<body class="post-template tag-fuzzing">

    <div class="site-wrapper">

        

<header class="site-header">
    <div class="outer site-nav-main">
    <div class="inner">
        <nav class="site-nav">
    <div class="site-nav-left-wrapper">
        <div class="site-nav-left">
                <a class="site-nav-logo" href="../index.html">Pion1eer</a>
            <div class="site-nav-content">
                    <ul class="nav">
    <li class="nav-home"><a href="../index.html">Home</a></li>
    <li class="nav-about"><a href="../about/index.html">About</a></li>
</ul>

                    <span class="nav-post-title dash">AFL源码阅读（二）：Main Payload 汇编</span>
            </div>
        </div>
    </div>
    <div class="site-nav-right">
            <div class="social-links">
            </div>
                <a class="rss-button" href="https://feedly.com/i/subscription/feed/https://www.ruanx.net/rss/" title="RSS" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="6.18" cy="17.82" r="2.18"/><path d="M4 4.44v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/></svg>
</a>

    </div>
</nav>
    </div>
</div>

<script>
 MathJax = {
        tex:{
                inlineMath: [['$', '$'], ['\\(', '\\)']]
            },
        svg:{
                fontCache: 'global'
            }
        }; 
    </script>
    <script src="https://cdn.staticfile.org/babel-polyfill/7.12.1/polyfill.min.js?features=es6"></script>
    <script type="text/javascript" id="MathJax-script" async  src="https://cdn.staticfile.org/mathjax/3.2.2/es5/tex-mml-chtml.js"></script>

<style>@media (prefers-color-scheme: light) {
		.post-full-content  
    pre{background:#fafafa;margin:10px 10px 20px 10px;border-style: solid;border-color:#DCDFE6;}
}
</style>

<link rel="stylesheet" href="https://cdn.ruanx.net/css/atom-one-dark.css">
<link rel="stylesheet" media="(prefers-color-scheme: light)" href="https://cdn.ruanx.net/css/atom-one-light.min.css">
<style>.post-full-content  code{font-family: 'Fira Mono', 'Jetbrains mono', 'ubuntu mono', consolas, 'monospace' !important;}
</style>

</header>


<main id="site-main" class="site-main outer">
    <div class="inner">

        <article class="post-full post tag-fuzzing ">

            <header class="post-full-header">

                <section class="post-full-tags">
                    <a href="../tag/fuzzing/index.html">Fuzzing</a>
                </section>

                <h1 class="post-full-title">AFL源码阅读（二）：Main Payload 汇编</h1>

                <p class="post-full-custom-excerpt">AFL 源码阅读的第二篇。本文详细解读了 AFL main payload 汇编代码，分析了共享内存区域的建立方式和 fork server 逻辑。</p>

                <div class="post-full-byline">

                    <section class="post-full-byline-content">

                        <ul class="author-list">
                            <li class="author-list-item">

                                <div class="author-card">
                                    <img class="author-profile-image" src="../content/images/size/w100/2020/05/blue.jpeg" alt="Ruan Xingzhi" />
                                    <div class="author-info">
                                        <div class="bio">
                                            <h2>Ruan Xingzhi</h2>
                                            <p>Welcome to my site and hope you have fun.</p>
                                            <p><a href="../author/blue/index.html">More posts</a> by Ruan Xingzhi.</p>
                                        </div>
                                    </div>
                                </div>

                                <a href="../author/blue/index.html" class="author-avatar">
                                    <img class="author-profile-image" src="../content/images/size/w100/2020/05/blue.jpeg" alt="Ruan Xingzhi" />
                                </a>

                            </li>
                        </ul>

                        <section class="post-full-byline-meta">
                            <h4 class="author-name"><a href="../author/blue/index.html">Ruan Xingzhi</a></h4>
                            <div class="byline-meta-content">
                                <time class="byline-meta-date" datetime="2023-05-16">16 May 2023</time>
                                <span class="byline-reading-time"><span class="bull">&bull;</span> 12 min read</span>
                            </div>
                        </section>

                    </section>


                </div>
            </header>

            <figure class="post-full-image">
                <img
                    srcset="../content/images/size/w300/2023/05/output-3.jpg 300w,
                            ../content/images/size/w600/2023/05/output-3.jpg 600w,
                            ../content/images/size/w1000/2023/05/output-3.jpg 1000w,
                            ../content/images/size/w2000/2023/05/output-3.jpg 2000w"
                    sizes="(max-width: 800px) 400px,
                        (max-width: 1170px) 1170px,
                            2000px"
                    src="../content/images/size/w2000/2023/05/output-3.jpg"
                    alt="AFL源码阅读（二）：Main Payload 汇编"
                />
            </figure>

            <section class="post-full-content">
                <div class="post-content">
                    <p>　　在<a href="../afl-source-1/index.html">上文</a>中，我们分析了 AFL 插入基本块入口的桩代码。其中有一个 <code>__afl_maybe_log</code> 函数被用于修改 shm 内存区域，而这块内存区域的初始化、fork server 等内容，都在 main payload 这一段约 300 行的汇编中。</p><p>　　本文便来解析这一套 main payload。我们暂且只关心 x64 Linux 平台下的版本。</p><h3 id="0x01-%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E5%88%9D%E5%A7%8B%E5%8C%96">0x01 共享内存初始化</h3><p>　　先用 IDA 看一下基本块：</p><figure class="kg-card kg-image-card"><img src="../content/images/2023/05/image-5.png" class="kg-image" alt loading="lazy" width="2000" height="1093" srcset="../content/images/size/w600/2023/05/image-5.png 600w, ../content/images/size/w1000/2023/05/image-5.png 1000w, ../content/images/size/w1600/2023/05/image-5.png 1600w, ../content/images/2023/05/image-5.png 2118w" sizes="(min-width: 720px) 720px"></figure><p>　　可见这段代码的入口点有且仅有 <code>__afl_maybe_log</code>。在上一篇文章中，我们已经追踪过 AFL 是如何记录基本块跳转的：简而言之，桩代码将几个寄存器的值保存在栈上，然后调用 <code>__afl_maybe_log</code> ；<code>__afl_maybe_log</code> 首先保存当前 EFLAGS 寄存器状态，然后检查 shm 区域是否准备好；如果已经准备好，则进入 <code>__afl_store</code> 过程，给 shm 区域增加 hit count 后返回。</p><p>　　那么，如果此时 shm 区域没有准备好呢？这就是本文的关注点。</p><figure class="kg-card kg-code-card"><pre><code class="language-c">__afl_maybe_log:

  lahf
  seto  %al

  /* Check if SHM region is already mapped. */

  movq  __afl_area_ptr(%rip), %rdx
  testq %rdx, %rdx
  je    __afl_setup

__afl_store:

  /* Calculate and store hit for the code location specified in rcx. */

  xorq __afl_prev_loc(%rip), %rcx
  xorq %rcx, __afl_prev_loc(%rip)
  shrq $1, __afl_prev_loc(%rip)

  incb (%rdx, %rcx, 1)

__afl_return:

  addb $127, %al
  sahf
  ret
</code></pre><figcaption>▲ 上一篇文章分析的&nbsp;<code>__afl_maybe_log</code> 代码。如果 shm 区域已经准备好，则直接写入 shm 后返回</figcaption></figure><p>　　从汇编中，我们看到，如果 <code>__afl_area_ptr</code> 等于 0，则认为 shm 没有映射好，进入 <code>__afl_setup</code> 逻辑。这里提一句， <code>afl_area_ptr</code> 这个 8 字节的变量是定义在 main payload 的末尾，一个 <code>.lcomm</code> 伪指令。在汇编阶段完成后，它被放在 <code>.bss</code> 段。</p><p>　　跟进 <code>__afl_setup</code> ：</p><pre><code class="language-c">__afl_setup:

  /* Do not retry setup if we had previous failures. */

  cmpb $0, __afl_setup_failure(%rip)
  jne __afl_return

  /* Check out if we have a global pointer on file. */

  movq  __afl_global_area_ptr@GOTPCREL(%rip), %rdx
  movq  (%rdx), %rdx
  testq %rdx, %rdx
  je    __afl_setup_first

  movq %rdx, __afl_area_ptr(%rip)
  jmp  __afl_store</code></pre><p>　　首先，如果发现 <code>__afl_setup_failure</code> 变量不等于 0，则直接返回；接着，尝试从 GOT 表中取 <code>__afl_global_area_ptr</code>，如果发现有值，则用其覆盖 <code>__afl_area_ptr</code> ，跳转到 <code>__afl_store</code> ，执行常规的 hit count++；如果发现 GOT 表中的这个 <code>__afl_global_area_ptr</code> 指针为 0，则跳转到 <code>__afl_setup_first</code> ，开始初始化共享内存区域。</p><pre><code class="language-c">__afl_setup_first:

  /* Save everything that is not yet saved and that may be touched by
     getenv() and several other libcalls we'll be relying on. */

  leaq -352(%rsp), %rsp

  movq %rax,   0(%rsp)
  movq %rcx,   8(%rsp)
  movq %rdi,  16(%rsp)
  movq %rsi,  32(%rsp)
  movq %r8,   40(%rsp)
  movq %r9,   48(%rsp)
  movq %r10,  56(%rsp)
  movq %r11,  64(%rsp)

  movq %xmm0,  96(%rsp)
  movq %xmm1,  112(%rsp)
  movq %xmm2,  128(%rsp)
  movq %xmm3,  144(%rsp)
  movq %xmm4,  160(%rsp)
  movq %xmm5,  176(%rsp)
  movq %xmm6,  192(%rsp)
  movq %xmm7,  208(%rsp)
  movq %xmm8,  224(%rsp)
  movq %xmm9,  240(%rsp)
  movq %xmm10, 256(%rsp)
  movq %xmm11, 272(%rsp)
  movq %xmm12, 288(%rsp)
  movq %xmm13, 304(%rsp)
  movq %xmm14, 320(%rsp)
  movq %xmm15, 336(%rsp)

  /* Map SHM, jumping to __afl_setup_abort if something goes wrong. */

  /* The 64-bit ABI requires 16-byte stack alignment. We'll keep the
     original stack ptr in the callee-saved r12. */

  pushq %r12
  movq  %rsp, %r12
  subq  $16, %rsp
  andq  $0xfffffffffffffff0, %rsp

  leaq .AFL_SHM_ENV(%rip), %rdi
call getenv@PLT

  testq %rax, %rax
  je    __afl_setup_abort

  movq  %rax, %rdi
call atoi@PLT

  xorq %rdx, %rdx   /* shmat flags    */
  xorq %rsi, %rsi   /* requested addr */
  movq %rax, %rdi   /* SHM ID         */
call shmat@PLT

  cmpq $-1, %rax
  je   __afl_setup_abort

  /* Store the address of the SHM region. */

  movq %rax, %rdx
  movq %rax, __afl_area_ptr(%rip)

  movq __afl_global_area_ptr@GOTPCREL(%rip), %rdx
  movq %rax, (%rdx)
  movq %rax, %rdx

__afl_forkserver:
/* ...... */</code></pre><p>　　观察 <code>__afl_setup_first</code> 过程。它首先把一些 caller-save 寄存器保存在栈上（这是为了方便后续在 fork server 中恢复原有寄存器状态）。在做完这些保存工作之后，作者写了这四行代码：</p><pre><code class="language-c">  /* The 64-bit ABI requires 16-byte stack alignment. We'll keep the
     original stack ptr in the callee-saved r12. */

  pushq %r12
  movq  %rsp, %r12
  subq  $16, %rsp
  andq  $0xfffffffffffffff0, %rsp</code></pre><p>　　保存 r12 寄存器的值；然后用 r12 寄存器记录原始的 rsp；把 rsp 减去 16，并清空最低 4 bit。注释中提到，根据 <a href="https://docs.oracle.com/cd/E19253-01/816-5138/fcowb/index.html">ABI</a> 要求，栈地址要做 16 字节对齐。这样一顿操作之后， rsp 一定是 16 的倍数了。</p><p>　　继续往下看：</p><pre><code class="language-c">  leaq .AFL_SHM_ENV(%rip), %rdi
call getenv@PLT

  testq %rax, %rax
  je    __afl_setup_abort
</code></pre><p>　　调用 <code>getenv("__AFL_SHM_ID")</code>，如果返回 0 则进入 <code>__afl_setup_abort</code> 错误处理流程，否则往下继续执行。我们先去看错误处理流程：</p><pre><code class="language-c">__afl_setup_abort:

  /* Record setup failure so that we don't keep calling
     shmget() / shmat() over and over again. */

  incb __afl_setup_failure(%rip)

  movq %r12, %rsp
  popq %r12

  movq  0(%rsp), %rax
  movq  8(%rsp), %rcx
  movq 16(%rsp), %rdi
  movq 32(%rsp), %rsi
  movq 40(%rsp), %r8
  movq 48(%rsp), %r9
  movq 56(%rsp), %r10
  movq 64(%rsp), %r11

  movq  96(%rsp), %xmm0
  movq 112(%rsp), %xmm1
  movq 128(%rsp), %xmm2
  movq 144(%rsp), %xmm3
  movq 160(%rsp), %xmm4
  movq 176(%rsp), %xmm5
  movq 192(%rsp), %xmm6
  movq 208(%rsp), %xmm7
  movq 224(%rsp), %xmm8
  movq 240(%rsp), %xmm9
  movq 256(%rsp), %xmm10
  movq 272(%rsp), %xmm11
  movq 288(%rsp), %xmm12
  movq 304(%rsp), %xmm13
  movq 320(%rsp), %xmm14
  movq 336(%rsp), %xmm15

  leaq 352(%rsp), %rsp

  jmp __afl_return</code></pre><p>　　这就是把 <code>__afl_setup_failure</code> 变量自增，还原所有寄存器并返回。至此，我们发现，如果环境变量 <code>__AFL_SHM_ID</code> 不存在，则共享内存的初始化会失败，但整个桩代码对于目标程序是透明的——无非是保存了一些寄存器、执行了一些无副作用的代码、最后恢复寄存器——因此目标程序可以正常执行。这也解释了为何我们不使用 <code>afl-fuzz</code> 而直接运行插桩后的目标程序，也能执行如常。这个设计体现了 AFL 的用户友好性。</p><p>　　回过头来看，如果环境变量 <code>__AFL_SHM_ID</code> 存在，将会发生什么事情。代码如下：</p><pre><code class="language-c">/* 此时 %rax 是指向环境变量 __AFL_SHM_ID 的指针  */
  movq  %rax, %rdi
call atoi@PLT

  xorq %rdx, %rdx   /* shmat flags    */
  xorq %rsi, %rsi   /* requested addr */
  movq %rax, %rdi   /* SHM ID         */
call shmat@PLT

  cmpq $-1, %rax
  je   __afl_setup_abort
</code></pre><p>　　首先把 <code>__AFL_SHM_ID</code> 从字符串转成整数，然后调用 <code>shmat(shmid, 0, 0)</code> 。</p><div class="kg-card kg-callout-card kg-callout-card-grey"><div class="kg-callout-emoji">📓</div><div class="kg-callout-text">查阅<a href="https://linux.die.net/man/2/shmat">文档</a>，得知 <code>shmat</code> 是 shared memory attach 的缩写，用于 attach 共享内存。<br><br>三个参数分别为 <code>(int shmid, const void *shmaddr, int shmflg)</code> ：<br>- <code>shmid</code> 是环境变量提供的；<br>- <code>shmaddr</code> 等于 0，则交由操作系统自行选择一片地址空间；<br>- <code>shmflg</code> 等于 0，采用默认设置。<br><br>函数的返回值是共享内存起点的位置。若 attach 失败，则返回 $-1$。</div></div><p>　　上面的汇编代码中，如果发现 attach 失败，则进入 AFL 的错误处理流程。不过读到这里，我们有一个小疑问：一片共享内存，首先应当由 <code>shmget()</code> 创建，再由 <code>shmat()</code> 映射到当前程序的虚拟内存空间中。那么，<strong>这片虚拟内存是什么时候创建的？</strong>答案是 <code>afl-fuzz</code> 在 <code>setup_shm()</code> 流程中调用 <code>shmget()</code> 创建了虚拟内存，并将 shm id 写入 <code>__AFL_SHM_ID</code> 环境变量。如果我们并非通过 <code>afl-fuzz</code> 运行程序，自然这片虚拟内存不会被创建，也不会存在 <code>__AFL_SHM_ID</code> 环境变量了。</p><p>　　至此，程序成功地将 <code>afl-fuzz</code> 进程所创建的一片共享内存，映射到了自己的虚拟地址空间内。接着看汇编：</p><pre><code class="language-c">  /* Store the address of the SHM region. */

  movq %rax, %rdx
  movq %rax, __afl_area_ptr(%rip)

  movq __afl_global_area_ptr@GOTPCREL(%rip), %rdx
  movq %rax, (%rdx)
  movq %rax, %rdx

__afl_forkserver:
/* ...... */</code></pre><p>　　将共享内存区域的地址存进 <code>__afl_area_ptr</code>，并写进 GOT 表中的 <code>__afl_global_area_ptr</code> 条目。最后，用 rdx 寄存器存放共享内存地址，进入 fork server。</p><p>　　<strong>为何同时有 </strong><code><strong>__afl_area_ptr</strong></code><strong> 和 </strong><code><strong>__afl_global_area_ptr</strong></code><strong> ？</strong>我们来看它们的定义，位于 main payload 尾部：</p><pre><code class="language-c">.AFL_VARS:

  .lcomm   __afl_area_ptr, 8
  .lcomm   __afl_prev_loc, 8
  .lcomm   __afl_fork_pid, 4
  .lcomm   __afl_temp, 4
  .lcomm   __afl_setup_failure, 1
  .comm    __afl_global_area_ptr, 8, 8

.AFL_SHM_ENV:
  .asciz "__AFL_SHM_ID"

/* --- END --- */</code></pre><p>　　可以看到，<code>__afl_area_ptr</code> 是一个 <code>lcomm</code>，而 <code>__afl_global_area_ptr</code> 是一个 <code>comm</code> 。根据一篇 <a href="https://stackoverflow.com/questions/34157895/asm-what-is-a-local-common-area-and-difference-between-lcomm-and-comm">Stackoverflow 问答</a>，<code>lcomm</code> 有点类似于全局 static 变量，不同文件中的重名 <code>lcomm</code> 是指向不同的地址；但 <code>comm</code> 有点类似于全局变量，不同文件中的重名 <code>comm</code> 指向同一个地址。</p><p>　　因此，这个问题的解答是：假如目标程序是多份代码链接形成的，那么，每份汇编文件都拥有 AFL main payload；对于编译出的每个代码片段，都会有自己对应的 <code>__afl_area_ptr</code> 。但 <code>__afl_global_area_ptr</code> 只有一份，只需要优先参考 <code>__afl_global_area_ptr</code> ，就能让所有桩代码访问的 shm 保持一致。</p><p>　　实验一下。写两份代码，合并编译，观察 bss 段，证明我们的解释是正确的：</p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="../content/images/2023/05/image-6.png" class="kg-image" alt loading="lazy" width="1882" height="1006" srcset="../content/images/size/w600/2023/05/image-6.png 600w, ../content/images/size/w1000/2023/05/image-6.png 1000w, ../content/images/size/w1600/2023/05/image-6.png 1600w, ../content/images/2023/05/image-6.png 1882w" sizes="(min-width: 720px) 720px"><figcaption>▲ 编译指令 <code>afl-gcc main.c fun.c</code> ，有两个不同的 <code>__afl_area_ptr</code> ，但只有一个 <code>__afl_global_area_ptr</code>&nbsp;</figcaption></figure><p> 　　以上，我们分析完了 shm 是如何初始化的。接下来，该分析 fork server 了。</p><h3 id="0x02-fork-server">0x02 fork server</h3><p>　　<a href="https://xidoo.top/2022/01/afl-white-book/#10-%E5%A4%8D%E5%88%B6%E6%9C%8D%E5%8A%A1%E5%99%A8-the-fork-server">AFL 白皮书</a>中提到，<code>execve()</code> 的效率比较低。fuzzer 需要高频率地执行目标程序，显然不宜在 <code>execve()</code> 上浪费过多时间。AFL 的解决方案是使用 fork server：让程序在第一个基本块处停下，等待 fuzzer 发送指令；收到指令后继续执行程序；执行完毕后，恢复 fork 时的状态。得益于 copy-on-write 技术，我们可以高效地实现这一需求。</p><p>　　来看汇编代码：</p><pre><code class="language-c">__afl_forkserver:

  /* Enter the fork server mode to avoid the overhead of execve() calls. We
     push rdx (area ptr) twice to keep stack alignment neat. */

  /* 此时 %rdx 内保存 shm 地址 */
  pushq %rdx
  pushq %rdx

  /* Phone home and tell the parent that we're OK. (Note that signals with
     no SA_RESTART will mess it up). If this fails, assume that the fd is
     closed because we were execve()d from an instrumented binary, or because
     the parent doesn't want to use the fork server. */

  movq $4, %rdx               /* length    */
  leaq __afl_temp(%rip), %rsi /* data      */
  movq $(198 + 1), %rdi       /* file desc */
call write@PLT

  cmpq $4, %rax
  jne  __afl_fork_resume

__afl_fork_wait_loop:
/* ...... */</code></pre><p>　　把 shm 地址连续压栈两次（以保证 esp 仍然是 16 的倍数），然后调用 <code>write(198+1, __afl_temp, 4)</code>。其中，198 这一 magic number，是 <code>config.h</code> 中的 <code>FORKSRV_FD</code> 常量。fork server 使用 198、199 这两个 fd 传递指令。而 <code>__afl_temp</code> 是 bss 段的长度 4 字节的变量。</p><p>　　如果这四个字节写入失败（<code>write()</code> 的返回不等于 4），则直接进入 <code>__afl_fork_resume</code> 逻辑；否则，进入 <code>__afl_fork_wait_loop</code> 逻辑。</p><p>　　跟进 <code>__afl_fork_wait_loop</code>：</p><pre><code class="language-c">__afl_fork_wait_loop:

  /* Wait for parent by reading from the pipe. Abort if read fails. */

  movq $4, %rdx               /* length    */
  leaq __afl_temp(%rip), %rsi /* data      */
  movq $198, %rdi             /* file desc */
call read@PLT
  cmpq $4, %rax
  jne  __afl_die
</code></pre><p>　　从 fd 198 中读取四个字节（注意 <code>read()</code> 函数是阻塞的）。如果读取失败，则跳转到 <code>__afl_die</code>。如果读取成功，则执行下面的代码：</p><pre><code class="language-c">  /* Once woken up, create a clone of our process. This is an excellent use
     case for syscall(__NR_clone, 0, CLONE_PARENT), but glibc boneheadedly
     caches getpid() results and offers no way to update the value, breaking
     abort(), raise(), and a bunch of other things :-( */

call fork@PLT
  cmpq $0, %rax
  jl   __afl_die
  je   __afl_fork_resume
</code></pre><p>　　在这里进行 fork，如果失败了则跳转到 <code>__afl_die</code>。对于子进程，跳转到 <code>__afl_fork_resume</code> ；对于父进程，则继续执行以下逻辑：</p><pre><code class="language-c">  /* In parent process: write PID to pipe, then wait for child. */

  movl %eax, __afl_fork_pid(%rip)

  movq $4, %rdx                   /* length    */
  leaq __afl_fork_pid(%rip), %rsi /* data      */
  movq $(198 + 1), %rdi             /* file desc */
call write@PLT

  movq $0, %rdx                   /* no flags  */
  leaq __afl_temp(%rip), %rsi     /* status    */
  movq __afl_fork_pid(%rip), %rdi /* PID       */
call waitpid@PLT
  cmpq $0, %rax
  jle  __afl_die

  /* Relay wait status to pipe, then loop back. */

  movq $4, %rdx               /* length    */
  leaq __afl_temp(%rip), %rsi /* data      */
  movq $(198 + 1), %rdi         /* file desc */
call write@PLT

  jmp  __afl_fork_wait_loop
</code></pre><p>　　这段代码逻辑是：将子进程的 pid 保存到 <code>__afl_fork_pid</code> 变量；向 fd 199 写入子进程的 pid；调用 <code>waitpid()</code> 等待子进程执行完毕（如果等待失败，则进入 <code>__afl_die</code>）；将子进程的退出原因写进 fd 199，并回到 <code>__afl_fork_wait_loop</code>。</p><p>　　之前提到，fork 之后，子进程会跳转到 <code>__afl_fork_resume</code> 逻辑。跟进：</p><pre><code class="language-c">__afl_fork_resume:

  /* In child process: close fds, resume execution. */

  movq $198, %rdi
call close@PLT

  movq $(198 + 1), %rdi
call close@PLT

  popq %rdx
  popq %rdx

  movq %r12, %rsp
  popq %r12

  movq  0(%rsp), %rax
  movq  8(%rsp), %rcx
  movq 16(%rsp), %rdi
  movq 32(%rsp), %rsi
  movq 40(%rsp), %r8
  movq 48(%rsp), %r9
  movq 56(%rsp), %r10
  movq 64(%rsp), %r11

  movq  96(%rsp), %xmm0
  movq 112(%rsp), %xmm1
  movq 128(%rsp), %xmm2
  movq 144(%rsp), %xmm3
  movq 160(%rsp), %xmm4
  movq 176(%rsp), %xmm5
  movq 192(%rsp), %xmm6
  movq 208(%rsp), %xmm7
  movq 224(%rsp), %xmm8
  movq 240(%rsp), %xmm9
  movq 256(%rsp), %xmm10
  movq 272(%rsp), %xmm11
  movq 288(%rsp), %xmm12
  movq 304(%rsp), %xmm13
  movq 320(%rsp), %xmm14
  movq 336(%rsp), %xmm15

  leaq 352(%rsp), %rsp

  jmp  __afl_store
</code></pre><p>　　首先关闭从父进程那里继承来的 fd 198、199，然后恢复所有寄存器，恢复栈地址，跳转到 <code>__afl_store</code>。而 <code>__afl_store</code> 在增加 hit count 之后，跳转回 AFL 往基本块头部插入的桩代码——到此为止，子进程恢复所有状态，开始了程序中第一个基本块的执行。</p><h3 id="0x03-%E6%80%BB%E7%BB%93">0x03 总结</h3><p>　　AFL main payload 设计得相当精妙。它让程序在第一个基本块处停下，初始化共享内存，并每次从这个位置 fork 出子进程、恢复程序状态、继续执行业务逻辑；子进程执行完后，fork server 则向 fuzzer 报告执行情况，开始新一轮执行。通过 fork server，AFL 得以避免频繁的 <code>execve</code> 调用，从而提升了 fuzz 效率。</p><p>　　共享内存由 <code>afl-fuzz</code> 程序建立，其 shm id 记录在环境变量 <code>__AFL_SHM_ID</code> 中。目标程序初始化时，会将这块共享内存 attach 到自己的虚拟地址空间，从而 <code>afl-fuzz</code> 进程可以统计 hit count。</p><p>　　fork server 的动作由 <code>afl-fuzz</code> 进程控制。目标程序与 <code>afl-fuzz</code> 透过 fd 传递信息——fd 198 用于 fuzzer 向 fork server 发送启动指令，fd 199 用于 fork server 向 fuzzer 报告子进程的 pid 和执行结果。</p><p>　　与直觉相反，一个运行超时的子进程，并不是由 fork server 结束的，而是由 <code>afl-fuzz</code> 结束的。这些内容要等到我们阅读 <code>afl-fuzz.c</code> 时才能细致掌握。</p><p>　　总之，我们已经阅读完了 <code>afl-gcc.c</code> 和 <code>afl-as.c</code> 这两份代码，对插桩过程有了详细的了解。按照计划，我们接下来将阅读 <code>afl-tmin.c</code> ，以了解 AFL 是如何收集、处理程序的覆盖度信息。</p>
                </div>
            </section>


            <div id="gitalk-container"></div>

            <link rel="stylesheet" href="https://cdn.staticfile.org/gitalk/1.6.2/gitalk.css">
            <script src="https://cdn.staticfile.org/gitalk/1.6.2/gitalk.min.js"></script>

            <script>
                const gitalk = new Gitalk({

                    proxy: 'https://cors.pion1eer.workers.dev/?https://github.com/login/oauth/access_token',

                    clientID: '9f7e67174f5ab8b1a2b9',
                    clientSecret: 'ddee425a0b50ed02a05fdedb1a4ea039e01b3170',
                    repo: 'blogComment',
                    owner: 'Ruanxingzhi',
                    admin: ['Ruanxingzhi'],
                    id: location.pathname,      // Ensure uniqueness and length less than 50
                    distractionFreeMode: false  // Facebook-like distraction free mode

                    });

                gitalk.render('gitalk-container');
            </script>

        </article>

    </div>
</main>

<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
                <article class="read-next-card">
                    <header class="read-next-card-header">
                        <h3><span>More in</span> <a href="../tag/fuzzing/index.html">Fuzzing</a></h3>
                    </header>
                    <div class="read-next-card-content">
                        <ul>
                            <li>
                                <h4><a href="../afl-source-1/index.html">AFL源码阅读（一）：启程</a></h4>
                                <div class="read-next-card-meta">
                                    <p><time datetime="2023-05-07">7 May 2023</time> –
                                        25 min read</p>
                                </div>
                            </li>
                            <li>
                                <h4><a href="../fuzzing101-wp-5/index.html">Fuzzing101-5：LibXML2</a></h4>
                                <div class="read-next-card-meta">
                                    <p><time datetime="2022-11-02">2 Nov 2022</time> –
                                        5 min read</p>
                                </div>
                            </li>
                            <li>
                                <h4><a href="../fuzzing101-wp-4/index.html">Fuzzing101-4：LibTIFF</a></h4>
                                <div class="read-next-card-meta">
                                    <p><time datetime="2022-10-30">30 Oct 2022</time> –
                                        5 min read</p>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <footer class="read-next-card-footer">
                        <a href="../tag/fuzzing/index.html">See all 8 posts
                            →</a>
                    </footer>
                </article>


                <article class="post-card post tag-fuzzing ">

    <a class="post-card-image-link" href="../afl-source-1/index.html">
        <img class="post-card-image"
            srcset="../content/images/size/w300/2023/05/output-2.jpg 300w,
                    ../content/images/size/w600/2023/05/output-2.jpg 600w,
                    ../content/images/size/w1000/2023/05/output-2.jpg 1000w,
                    ../content/images/size/w2000/2023/05/output-2.jpg 2000w"
            sizes="(max-width: 1000px) 400px, 700px"
            src="../content/images/size/w600/2023/05/output-2.jpg"
            alt="AFL源码阅读（一）：启程"
        />
    </a>

    <div class="post-card-content">

        <a class="post-card-content-link" href="../afl-source-1/index.html">

            <header class="post-card-header">
                    <div class="post-card-primary-tag">Fuzzing</div>
                <h2 class="post-card-title">AFL源码阅读（一）：启程</h2>
            </header>

            <section class="post-card-excerpt">
                    <p>开始阅读 AFL 的源码。本文分析了 AFL 项目的文件结构，确定了阅读代码的顺序，并详细解释了 afl-gcc 和 afl-as 代码。</p>
            </section>

        </a>

        <footer class="post-card-meta">
            <ul class="author-list">
                <li class="author-list-item">
            
                    <div class="author-name-tooltip">
                        Ruan Xingzhi
                    </div>
            
                    <a href="../author/blue/index.html" class="static-avatar">
                        <img class="author-profile-image" src="../content/images/size/w100/2020/05/blue.jpeg" alt="Ruan Xingzhi" />
                    </a>
                </li>
            </ul>
            <div class="post-card-byline-content">
                <span><a href="../author/blue/index.html">Ruan Xingzhi</a></span>
                <span class="post-card-byline-date"><time datetime="2023-05-07">7 May 2023</time> <span class="bull">&bull;</span> 25 min read</span>
            </div>
        </footer>

    </div>

</article>
        </div>
    </div>
</aside>




        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="../index.html">Pion1eer</a> &copy; 2023</section>
                <nav class="site-footer-nav">
                    <a href="http://beian.miit.gov.cn/" target="_blank">湘ICP备20008720号-1</a>
                    <a href="../index.html">Latest Posts</a>
                    
                    
                    <a href="https://ghost.org" target="_blank" rel="noopener">Ghost</a>
                </nav>
            </div>
        </footer>

    </div>

<!--

    <div class="subscribe-success-message">
        <a class="subscribe-close" href="javascript:;"></a>
        You've successfully subscribed to Pion1eer!
    </div>

    <div id="subscribe" class="subscribe-overlay">
        <a class="subscribe-close" href="#"></a>
        <div class="subscribe-overlay-content">
            <div class="subscribe-form">
                <h1 class="subscribe-overlay-title">Subscribe to Pion1eer</h1>
                <p class="subscribe-overlay-description">Stay up to date! Get all the latest & greatest posts delivered straight to your inbox</p>
                <form data-members-form="subscribe">
                    <div class="form-group">
                        <input class="subscribe-email" data-members-email placeholder="youremail@example.com"
                            autocomplete="false" />
                        <button class="button primary" type="submit">
                            <span class="button-content">Subscribe</span>
                            <span class="button-loader"><svg version="1.1" id="loader-1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px"
    y="0px" width="40px" height="40px" viewBox="0 0 40 40" enable-background="new 0 0 40 40" xml:space="preserve">
    <path opacity="0.2" fill="#000" d="M20.201,5.169c-8.254,0-14.946,6.692-14.946,14.946c0,8.255,6.692,14.946,14.946,14.946
s14.946-6.691,14.946-14.946C35.146,11.861,28.455,5.169,20.201,5.169z M20.201,31.749c-6.425,0-11.634-5.208-11.634-11.634
c0-6.425,5.209-11.634,11.634-11.634c6.425,0,11.633,5.209,11.633,11.634C31.834,26.541,26.626,31.749,20.201,31.749z" />
    <path fill="#000" d="M26.013,10.047l1.654-2.866c-2.198-1.272-4.743-2.012-7.466-2.012h0v3.312h0
C22.32,8.481,24.301,9.057,26.013,10.047z">
        <animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 20 20" to="360 20 20"
            dur="0.5s" repeatCount="indefinite" />
    </path>
</svg></span>
                        </button>
                    </div>
                    <div class="message-success">
                        <strong>Great!</strong> Check your inbox and click the link to confirm your subscription.
                    </div>
                    <div class="message-error">
                        Please enter a valid email address!
                    </div>
                </form>
            </div>
        </div>
    </div>

-->

    <script
        src="https://cdn.ruanx.net/js/jquery.min.js"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
        crossorigin="anonymous">
    </script>
    <script src="../assets/built/casper%EF%B9%96v=792c672b3c.js"></script>

    <script>
        // Parse the URL parameter
        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        // Give the parameter a variable name
        var action = getParameterByName('action');

        $(document).ready(function () {
            if (action == 'subscribe') {
                $('body').addClass("subscribe-success");
            }

            $('.subscribe-success-message .subscribe-close').click(function () {
                $('.subscribe-success-message').addClass('close');
            });

            // Reset form on opening subscrion overlay
            $('.subscribe-button').click(function() {
                $('.subscribe-overlay form').removeClass();
                $('.subscribe-email').val('');
            });
        });
    </script>

    <script>
    $(document).ready(function () {
        // FitVids - start
        var $postContent = $(".post-full-content");
        $postContent.fitVids();
        // FitVids - end

        // Replace nav with title on scroll - start
        Casper.stickyNavTitle({
            navSelector: '.site-nav-main',
            titleSelector: '.post-full-title',
            activeClass: 'nav-post-title-active'
        });
        // Replace nav with title on scroll - end

        // Hover on avatar
        var hoverTimeout;
        $('.author-list-item').hover(function () {
            var $this = $(this);

            clearTimeout(hoverTimeout);

            $('.author-card').removeClass('hovered');
            $(this).children('.author-card').addClass('hovered');

        }, function () {
            var $this = $(this);

            hoverTimeout = setTimeout(function () {
                $this.children('.author-card').removeClass('hovered');
            }, 800);
        });
    });
</script>

<script src="https://cdn.staticfile.org/highlight.js/10.1.1/highlight.min.js"></script>
<script >hljs.initHighlightingOnLoad();</script>



    <style>.kg-bookmark-metadata > .kg-bookmark-publisher:before {
    content: "" !important; 
    margin: 0 !important;
}
</style>

</body>
</html>
