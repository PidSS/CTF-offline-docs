<!DOCTYPE html>
<html âš¡>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">

    <title>AFLæºç é˜…è¯»ï¼ˆäºŒï¼‰ï¼šMain Payload æ±‡ç¼–</title>

    <meta name="description" content="AFL æºç é˜…è¯»çš„ç¬¬äºŒç¯‡ã€‚æœ¬æ–‡è¯¦ç»†è§£è¯»äº† AFL main payload æ±‡ç¼–ä»£ç ï¼Œåˆ†æäº†å…±äº«å†…å­˜åŒºåŸŸçš„å»ºç«‹æ–¹å¼å’Œ fork server é€»è¾‘ã€‚" />
    <link rel="icon" href="../../content/images/size/w256h256/2020/02/small-3.png" type="image/png" />
    <link rel="canonical" href="../index.html" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    
    <meta property="og:site_name" content="Pion1eer" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="AFLæºç é˜…è¯»ï¼ˆäºŒï¼‰ï¼šMain Payload æ±‡ç¼–" />
    <meta property="og:description" content="AFL æºç é˜…è¯»çš„ç¬¬äºŒç¯‡ã€‚æœ¬æ–‡è¯¦ç»†è§£è¯»äº† AFL main payload æ±‡ç¼–ä»£ç ï¼Œåˆ†æäº†å…±äº«å†…å­˜åŒºåŸŸçš„å»ºç«‹æ–¹å¼å’Œ fork server é€»è¾‘ã€‚" />
    <meta property="og:url" content="https://www.ruanx.net/afl-source-2/" />
    <meta property="og:image" content="https://www.ruanx.net/content/images/2023/05/output-3.jpg" />
    <meta property="article:published_time" content="2023-05-16T03:35:25.000Z" />
    <meta property="article:modified_time" content="2023-05-16T06:41:34.000Z" />
    <meta property="article:tag" content="Fuzzing" />
    
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="AFLæºç é˜…è¯»ï¼ˆäºŒï¼‰ï¼šMain Payload æ±‡ç¼–" />
    <meta name="twitter:description" content="AFL æºç é˜…è¯»çš„ç¬¬äºŒç¯‡ã€‚æœ¬æ–‡è¯¦ç»†è§£è¯»äº† AFL main payload æ±‡ç¼–ä»£ç ï¼Œåˆ†æäº†å…±äº«å†…å­˜åŒºåŸŸçš„å»ºç«‹æ–¹å¼å’Œ fork server é€»è¾‘ã€‚" />
    <meta name="twitter:url" content="https://www.ruanx.net/afl-source-2/" />
    <meta name="twitter:image" content="https://www.ruanx.net/content/images/2023/05/output-3.jpg" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Ruan Xingzhi" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Fuzzing" />
    <meta property="og:image:width" content="640" />
    <meta property="og:image:height" content="480" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Pion1eer",
        "url": "https://www.ruanx.net/",
        "logo": {
            "@type": "ImageObject",
            "url": "https://www.ruanx.net/content/images/size/w256h256/2020/02/small-3.png",
            "width": 60,
            "height": 60
        }
    },
    "author": {
        "@type": "Person",
        "name": "Ruan Xingzhi",
        "image": {
            "@type": "ImageObject",
            "url": "https://www.ruanx.net/content/images/2020/05/blue.jpeg",
            "width": 1024,
            "height": 1024
        },
        "url": "https://www.ruanx.net/author/blue/",
        "sameAs": []
    },
    "headline": "AFLæºç é˜…è¯»ï¼ˆäºŒï¼‰ï¼šMain Payload æ±‡ç¼–",
    "url": "https://www.ruanx.net/afl-source-2/",
    "datePublished": "2023-05-16T03:35:25.000Z",
    "dateModified": "2023-05-16T06:41:34.000Z",
    "image": {
        "@type": "ImageObject",
        "url": "https://www.ruanx.net/content/images/2023/05/output-3.jpg",
        "width": 640,
        "height": 480
    },
    "keywords": "Fuzzing",
    "description": "AFL æºç é˜…è¯»çš„ç¬¬äºŒç¯‡ã€‚æœ¬æ–‡è¯¦ç»†è§£è¯»äº† AFL main payload æ±‡ç¼–ä»£ç ï¼Œåˆ†æäº†å…±äº«å†…å­˜åŒºåŸŸçš„å»ºç«‹æ–¹å¼å’Œ fork server é€»è¾‘ã€‚",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://www.ruanx.net/"
    }
}
    </script>

    <meta name="generator" content="Ghost 5.8" />
    <link rel="alternate" type="application/rss+xml" title="Pion1eer" href="../../rss/index.rss" />

    <style amp-custom>*,
    *::before,
    *::after {
        box-sizing: border-box;
    }

    html {
        overflow-x: hidden;
        overflow-y: scroll;
        font-size: 62.5%;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
    }

    body {
        min-height: 100vh;
        margin: 0;
        padding: 0;
        color: #3a4145;
        font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;
        font-size: 1.7rem;
        line-height: 1.55em;
        font-weight: 400;
        font-style: normal;
        background: #fff;
        scroll-behavior: smooth;
        overflow-x: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    p,
    ul,
    ol,
    li,
    dl,
    dd,
    hr,
    pre,
    form,
    table,
    video,
    figure,
    figcaption,
    blockquote {
        margin: 0;
        padding: 0;
    }

    ul[class],
    ol[class] {
        padding: 0;
        list-style: none;
    }

    img {
        display: block;
        max-width: 100%;
    }

    input,
    button,
    select,
    textarea {
        font: inherit;
        -webkit-appearance: none;
    }

    fieldset {
        margin: 0;
        padding: 0;
        border: 0;
    }

    label {
        display: block;
        font-size: 0.9em;
        font-weight: 700;
    }

    hr {
        position: relative;
        display: block;
        width: 100%;
        height: 1px;
        border: 0;
        border-top: 1px solid currentcolor;
        opacity: 0.1;
    }

    ::selection {
        text-shadow: none;
        background: #cbeafb;
    }

    mark {
        background-color: #fdffb6;
    }

    small {
        font-size: 80%;
    }

    sub,
    sup {
        position: relative;
        font-size: 75%;
        line-height: 0;
        vertical-align: baseline;
    }
    sup {
        top: -0.5em;
    }
    sub {
        bottom: -0.25em;
    }

    ul li + li {
        margin-top: 0.6em;
    }

    a {
        color: var(--ghost-accent-color, #1292EE);
        text-decoration-skip-ink: auto;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
        margin: 0;
        font-weight: 700;
        color: #121212;
        line-height: 1.4em;
    }

    h1 {
        font-size: 3.4rem;
        line-height: 1.1em;
    }

    h2 {
        font-size: 2.4rem;
        line-height: 1.2em;
    }

    h3 {
        font-size: 1.8rem;
    }

    h4 {
        font-size: 1.7rem;
    }

    h5 {
        font-size: 1.6rem;
    }

    h6 {
        font-size: 1.6rem;
    }

    amp-img {
        height: 100%;
        width: 100%;
        max-width: 100%;
        max-height: 100%;
    }

    amp-img img {
        object-fit: cover;
    }

    .page-header {
        padding: 50px 5vmin 30px;
        text-align: center;
        font-size: 2rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .page-header a {
        color: #121212;
        font-weight: 700;
        text-decoration: none;
        font-size: 1.6rem;
        letter-spacing: -0.1px;
    }

    .post {
        max-width: 680px;
        margin: 0 auto;
    }

    .post-header {
        margin: 0 5vmin 5vmin;
        text-align: center;
    }

    .post-meta {
        margin: 1rem 0 0 0;
        text-transform: uppercase;
        color: #738a94;
        font-weight: 500;
        font-size: 1.3rem;
    }

    .post-image {
        margin: 0 0 5vmin;
    }

    .post-image img {
        display: block;
        width: 100%;
        height: auto;
    }

    .post-content {
        padding: 0 5vmin;
    }

    .post-content > * + * {
        margin-top: 1.5em;
    }

    .post-content [id]:not(:first-child) {
        margin: 2em 0 0;
    }

    .post-content > [id] + * {
        margin-top: 1rem;
    }

    .post-content [id] + .kg-card,
    .post-content blockquote + .kg-card {
        margin-top: 40px;
    }

    .post-content > ul,
    .post-content > ol,
    .post-content > dl {
        padding-left: 1.9em;
    }

    .post-content hr {
        margin-top: 40px;
    }

    .post .post-content hr + * {
        margin-top: 40px;
    }

    .post-content amp-img {
        background-color: #f8f8f8;
    }

    .post-content blockquote {
        position: relative;
        font-style: italic;
    }

    .post-content blockquote::before {
        content: "";
        position: absolute;
        left: -1.5em;
        top: 0;
        bottom: 0;
        width: 0.3rem;
        background: var(--ghost-accent-color, #1292EE);
    }

    .post-content blockquote.kg-blockquote-alt {
        font-size: 1.2em;
        font-style: italic;
        line-height: 1.6em;
        text-align: center;
        color: #738a94;
        padding: 0.75em 3em 1.25em;
    }

    .post-content blockquote.kg-blockquote-alt::before {
        display: none;
    }

    .post-content :not(.kg-card):not([id]) + .kg-card {
        margin-top: 40px;
    }

    .post-content .kg-card + :not(.kg-card) {
        margin-top: 40px;
    }

    .kg-card figcaption {
        padding: 1.5rem 1.5rem 0;
        text-align: center;
        font-weight: 500;
        font-size: 1.3rem;
        line-height: 1.4em;
        opacity: 0.6;
    }

    .kg-card figcaption strong {
        color: rgba(0,0,0,0.8);
    }

    .post-content :not(pre) code {
        vertical-align: middle;
        padding: 0.15em 0.4em 0.15em;
        border: #e1eaef 1px solid;
        font-weight: 400;
        font-size: 0.9em;
        line-height: 1em;
        color: #15171a;
        background: #f0f6f9;
        border-radius: 0.25em;
    }

    .post-content > pre {
        overflow: scroll;
        padding: 16px 20px;
        color: #fff;
        background: #1F2428;
        border-radius: 5px;
        box-shadow: 0 2px 6px -2px rgba(0,0,0,.1), 0 0 1px rgba(0,0,0,.4);
    }

    .kg-embed-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
    }

    .kg-image-card img {
        margin: auto;
    }

    .kg-gallery-card + .kg-gallery-card {
        margin-top: 0.75em;
    }

    .kg-gallery-container {
        position: relative;
    }

    .kg-gallery-row {
        display: flex;
        flex-direction: row;
        justify-content: center;
    }

    .kg-gallery-image {
        width: 100%;
        height: 100%;
    }

    .kg-gallery-row:not(:first-of-type) {
        margin: 0.75em 0 0 0;
    }

    .kg-gallery-image:not(:first-of-type) {
        margin: 0 0 0 0.75em;
    }

    .kg-bookmark-card,
    .kg-bookmark-publisher {
        position: relative;
    }

    .kg-bookmark-container,
    .kg-bookmark-container:hover {
        display: flex;
        flex-wrap: wrap;
        flex-direction: row-reverse;
        color: currentColor;
        background: rgba(255,255,255,0.6);
        font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;
        text-decoration: none;
        border-radius: 3px;
        box-shadow: 0 2px 6px -2px rgba(0, 0, 0, 0.1), 0 0 1px rgba(0, 0, 0, 0.4);
        overflow: hidden;
    }

    .kg-bookmark-content {
        flex-basis: 0;
        flex-grow: 999;
        padding: 20px;
        order: 1;
    }

    .kg-bookmark-title {
        font-weight: 600;
        font-size: 1.5rem;
        line-height: 1.3em;
    }

    .kg-bookmark-description {
        display: -webkit-box;
        max-height: 45px;
        margin: 0.5em 0 0 0;
        font-size: 1.4rem;
        line-height: 1.55em;
        overflow: hidden;
        opacity: 0.8;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    .kg-bookmark-metadata {
        margin-top: 20px;
    }

    .kg-bookmark-metadata {
        display: flex;
        align-items: center;
        font-weight: 500;
        font-size: 1.3rem;
        line-height: 1.3em;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .kg-bookmark-description {
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2;
        overflow: hidden;
    }

    .kg-bookmark-metadata amp-img {
        width: 18px;
        height: 18px;
        max-width: 18px;
        max-height: 18px;
        margin-right: 10px;
    }

    .kg-bookmark-thumbnail {
        display: flex;
        flex-basis: 20rem;
        flex-grow: 1;
        justify-content: flex-end;
    }

    .kg-bookmark-thumbnail amp-img {
        max-height: 200px;
    }

    .kg-bookmark-author {
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
    }

    .kg-bookmark-publisher::before {
        content: "â€¢";
        margin: 0 .5em;
    }

    .kg-toggle-card-icon {
        display: none;
    }

    .kg-toggle-content {
        margin-top: 0.8rem;
    }

    .kg-product-card-container {
        background: transparent;
        padding: 20px;
        width: 100%;
        border-radius: 5px;
        box-shadow: inset 0 0 0 1px rgb(124 139 154 / 25%);
    }

    .kg-product-card-description p {
        margin-top: 1.5em;
    }

    .kg-product-card-description ul {
        margin-left: 24px;
    }

    .kg-product-card-title {
        font-size: 1.9rem;
        font-weight: 700;
    }

    .kg-product-card-rating-star {
        height: 28px;
        width: 20px;
        margin-right: 2px;
    }

    .kg-product-card-rating-star svg {
    width: 16px;
    height: 16px;
    fill: currentColor;
    opacity: 0.15;
    }

    .kg-product-card-rating-active.kg-product-card-rating-star svg {
    opacity: 1;
    }

    .kg-nft-card-container {
        position: relative;
        display: flex;
        flex: auto;
        flex-direction: column;
        text-decoration: none;
        font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;
        font-size: 1.4rem;
        font-weight: 400;
        box-shadow: 0 2px 6px -2px rgb(0 0 0 / 10%), 0 0 1px rgb(0 0 0 / 40%);
        width: 100%;
        max-width: 512px;
        color: #15212A;
        background: #fff;
        border-radius: 5px;
        transition: none;
        margin: 0 auto;
    }

    .kg-nft-metadata {
        padding: 2.0rem;
    }

    .kg-nft-image-container {
        position: relative;
    }

    .kg-nft-image {
        display: flex;
        border-radius: 5px 5px 0 0;
    }

    .kg-nft-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 20px;
    }

    .kg-nft-header h4.kg-nft-title {
        font-size: 1.9rem;
        font-weight: 700;
        margin: 0;
        color: #15212A;
    }

    .kg-nft-header amp-img {
        max-width: 114px;
        max-height: 26px;
    }

    .kg-nft-opensea-logo {
        margin-top: 2px;
        width: 100px;
    }

    .kg-nft-creator {
        font-family: inherit;
        color: #95A1AD;
    }

    .kg-nft-creator span {
        font-weight: 500;
        color: #15212A;
    }

    .kg-nft-card p.kg-nft-description {
        font-size: 1.4rem;
        line-height: 1.4em;
        margin: 2.0rem 0 0;
        color: #222;
    }

    .kg-button-card {
        display: flex;
        position: static;
        align-items: center;
        width: 100%;
        justify-content: center;
    }

    .kg-btn {
        display: flex;
        position: static;
        align-items: center;
        padding: 0 2.0rem;
        height: 4.0rem;
        line-height: 4.0rem;
        font-size: 1.65rem;
        font-weight: 600;
        text-decoration: none;
        border-radius: 5px;
        transition: opacity 0.2s ease-in-out;
    }

    .kg-btn:hover {
        opacity: 0.85;
    }

    .kg-btn-accent {
        background-color: var(--ghost-accent-color, #1292EE);
        color: #fff;
    }

    .kg-callout-card {
        display: flex;
        padding: 20px 28px;
        border-radius: 3px;
    }

    .kg-callout-card-grey {
        background: rgba(124, 139, 154, 0.13);
    }

    .kg-callout-card-white {
        background: transparent;
        box-shadow: inset 0 0 0 1px rgba(124, 139, 154, 0.25);
    }

    .kg-callout-card-blue {
        background: rgba(33, 172, 232, 0.12);
    }

    .kg-callout-card-green {
        background: rgba(52, 183, 67, 0.12);
    }

    .kg-callout-card-yellow {
        background: rgba(240, 165, 15, 0.13);
    }

    .kg-callout-card-red {
        background: rgba(209, 46, 46, 0.11);
    }

    .kg-callout-card-pink {
        background: rgba(225, 71, 174, 0.11);
    }

    .kg-callout-card-purple {
        background: rgba(135, 85, 236, 0.12);
    }

    .kg-callout-card-accent {
        background: var(--ghost-accent-color);
        color: #fff;
    }

    .kg-callout-card-accent a {
        color: #fff;
    }

    .kg-callout-emoji {
        padding-right: 16px;
        line-height: 1.3;
        font-size: 1.25em;
    }

    .kg-header-card {
        padding: 6em 3em;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
    }

    .kg-header-card.kg-size-small {
        padding-top: 4em;
        padding-bottom: 4em;
    }

    .kg-header-card.kg-size-large {
        padding-top: 12em;
        padding-bottom: 12em;
    }

    .kg-header-card.kg-width-full {
        padding-left: 4em;
        padding-right: 4em;
    }

    .kg-header-card.kg-align-left {
        text-align: left;
        align-items: flex-start;
    }

    .kg-header-card.kg-style-dark {
        background: #15171a;
        color: #ffffff;
    }

    .kg-header-card.kg-style-light {
        color: #15171a;
        border: 1px solid rgba(124, 139, 154, 0.25);
        border-width: 1px 0;
    }

    .kg-header-card.kg-style-accent {
        background-color: var(--ghost-accent-color);
    }

    .kg-header-card.kg-style-image {
        background-color: #e7e7eb;
        background-size: cover;
        background-position: center center;
    }

    .kg-header-card h2 {
        font-size: 4em;
        font-weight: 700;
        line-height: 1.1em;
        margin: 0;
    }

    .kg-header-card h2 strong {
        font-weight: 800;
    }

    .kg-header-card.kg-size-small h2 {
        font-size: 3em;
    }

    .kg-header-card.kg-size-large h2 {
        font-size: 5em;
    }

    .kg-header-card h3 {
        font-size: 1.25em;
        font-weight: 500;
        line-height: 1.3em;
        margin: 0;
    }

    .kg-header-card h3 strong {
        font-weight: 600;
    }

    .kg-header-card.kg-size-small h3 {
        font-size: 1em;
    }

    .kg-header-card.kg-size-large h3 {
        font-size: 1.5em;
    }

    .kg-header-card:not(.kg-style-light) h2,
    .kg-header-card:not(.kg-style-light) h3 {
        color: #ffffff;
    }

    .kg-header-card a.kg-header-card-button {
        display: flex;
        position: static;
        align-items: center;
        padding: 0 1.2em;
        height: 2.4em;
        line-height: 1em;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
        font-size: 0.95em;
        font-weight: 600;
        text-decoration: none;
        border-radius: 5px;
        transition: opacity 0.2s ease-in-out;
        background-color: var(--ghost-accent-color);
        color: #ffffff;
        margin: 1.75em 0 0;
    }

    .kg-header-card a.kg-header-card-button:hover {
        opacity: 0.85;
    }

    .kg-header-card.kg-size-large a.kg-header-card-button {
        margin-top: 2em;
    }

    .kg-header-card.kg-size-small a.kg-header-card-button {
        margin-top: 1.5em;
    }

    .kg-header-card.kg-style-image a.kg-header-card-button,
    .kg-header-card.kg-style-dark a.kg-header-card-button {
        background: #ffffff;
        color: #15171a;
    }

    .kg-header-card.kg-style-accent a.kg-header-card-button {
        background: #ffffff;
        color: var(--ghost-accent-color);
    }

    .kg-audio-card {
        display: flex;
        width: 100%;
        box-shadow: inset 0 0 0 1px rgba(124, 139, 154, 0.25);
    }

    .kg-audio-thumbnail {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 80px;
        min-width: 80px;
        height: 80px;
        background: transparent;
        object-fit: cover;
        aspect-ratio: 1/1;
        border-radius: 3px 0 0 3px;
    }

    .kg-audio-thumbnail.placeholder {
        background: var(--ghost-accent-color);
    }

    .kg-audio-thumbnail.placeholder svg {
        width: 24px;
        height: 24px;
        fill: white;
    }

    .kg-audio-player-container {
        position: relative;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        width: 100%;
        --seek-before-width: 0%;
        --volume-before-width: 100%;
        --buffered-width: 0%;
    }

    .kg-audio-title {
        width: 100%;
        padding: 8px 12px 0;
        border: none;
        font-family: inherit;
        font-size: 1.1em;
        font-weight: 700;
        background: transparent;
    }

    .kg-audio-player {
        display: none;
    }

    .kg-width-full.kg-card-hascaption {
        display: grid;
        grid-template-columns: inherit;
    }

    .post-content table {
        border-collapse: collapse;
        width: 100%;
    }

    .post-content th {
        padding: 0.5em 0.8em;
        text-align: left;
        font-size: .75em;
        text-transform: uppercase;
    }

    .post-content td {
        padding: 0.4em 0.7em;
    }

    .post-content tbody tr:nth-child(2n + 1) {
        background-color: rgba(0,0,0,0.1);
        padding: 1px;
    }

    .post-content tbody tr:nth-child(2n + 2) td:last-child {
        box-shadow:
            inset 1px 0 rgba(0,0,0,0.1),
            inset -1px 0 rgba(0,0,0,0.1);
    }

    .post-content tbody tr:nth-child(2n + 2) td {
        box-shadow: inset 1px 0 rgba(0,0,0,0.1);
    }

    .post-content tbody tr:last-child {
        border-bottom: 1px solid rgba(0,0,0,.1);
    }

    .page-footer {
        padding: 60px 5vmin;
        margin: 60px auto 0;
        text-align: center;
        background-color: #f8f8f8;
    }

    .page-footer h3 {
        margin: 0.5rem 0 0 0;
    }

    .page-footer p {
        max-width: 500px;
        margin: 1rem auto 1.5rem;
        font-size: 1.7rem;
        line-height: 1.5em;
        color: rgba(0,0,0,0.6)
    }

    .powered {
        display: inline-flex;
        align-items: center;
        margin: 30px 0 0;
        padding: 6px 9px 6px 6px;
        border: rgba(0,0,0,0.1) 1px solid;
        font-size: 12px;
        line-height: 12px;
        letter-spacing: -0.2px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
        font-weight: 500;
        color: #222;
        text-decoration: none;
        background: #fff;
        border-radius: 6px;
    }

    .powered svg {
        height: 16px;
        width: 16px;
        margin: 0 6px 0 0;
    }

    @media (max-width: 600px) {
        body {
            font-size: 1.6rem;
        }
        h1 {
            font-size: 3rem;
        }

        h2 {
            font-size: 2.2rem;
        }
    }

    @media (max-width: 400px) {
        h1 {
            font-size: 2.6rem;
            line-height: 1.15em;
        }
        h2 {
            font-size: 2rem;
            line-height: 1.2em;
        }
        h3 {
            font-size: 1.7rem;
        }
    }

    :root {--ghost-accent-color: #15171A;}
    </style>

    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async src="https://cdn.ampproject.org/v0.js"></script>

    

</head>

<body class="amp-template">
    <header class="page-header">
        <a href="../../index.html">
                <amp-img class="site-icon" src="https://www.ruanx.net/content/images/2020/02/small-3.png" width="50" height="50" layout="fixed" alt="Pion1eer"></amp-img>
        </a>
    </header>

    <main class="content" role="main">
        <article class="post">

            <header class="post-header">
                <h1 class="post-title">AFLæºç é˜…è¯»ï¼ˆäºŒï¼‰ï¼šMain Payload æ±‡ç¼–</h1>
                <section class="post-meta">
                    Ruan Xingzhi -
                    <time class="post-date" datetime="2023-05-16">16 May 2023</time>
                </section>
            </header>
            <figure class="post-image">
                <amp-img src="https://www.ruanx.net/content/images/2023/05/output-3.jpg" width="600" height="340" layout="responsive" 
                alt="AFLæºç é˜…è¯»ï¼ˆäºŒï¼‰ï¼šMain Payload æ±‡ç¼–"
                ></amp-img>
            </figure>
            <section class="post-content">

                <p>ã€€ã€€åœ¨<a href="../../afl-source-1/index.html">ä¸Šæ–‡</a>ä¸­ï¼Œæˆ‘ä»¬åˆ†æäº† AFL æ’å…¥åŸºæœ¬å—å…¥å£çš„æ¡©ä»£ç ã€‚å…¶ä¸­æœ‰ä¸€ä¸ª <code>__afl_maybe_log</code> å‡½æ•°è¢«ç”¨äºä¿®æ”¹ shm å†…å­˜åŒºåŸŸï¼Œè€Œè¿™å—å†…å­˜åŒºåŸŸçš„åˆå§‹åŒ–ã€fork server ç­‰å†…å®¹ï¼Œéƒ½åœ¨ main payload è¿™ä¸€æ®µçº¦ 300 è¡Œçš„æ±‡ç¼–ä¸­ã€‚</p><p>ã€€ã€€æœ¬æ–‡ä¾¿æ¥è§£æè¿™ä¸€å¥— main payloadã€‚æˆ‘ä»¬æš‚ä¸”åªå…³å¿ƒ x64 Linux å¹³å°ä¸‹çš„ç‰ˆæœ¬ã€‚</p><h3 id="0x01-%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E5%88%9D%E5%A7%8B%E5%8C%96">0x01 å…±äº«å†…å­˜åˆå§‹åŒ–</h3><p>ã€€ã€€å…ˆç”¨ IDA çœ‹ä¸€ä¸‹åŸºæœ¬å—ï¼š</p><figure class="kg-card kg-image-card"><amp-img src="https://www.ruanx.net/content/images/2023/05/image-5.png" class="kg-image" alt width="2118" height="1157" srcset="https://www.ruanx.net/content/images/size/w600/2023/05/image-5.png 600w, https://www.ruanx.net/content/images/size/w1000/2023/05/image-5.png 1000w, https://www.ruanx.net/content/images/size/w1600/2023/05/image-5.png 1600w, https://www.ruanx.net/content/images/2023/05/image-5.png 2118w" layout="responsive"></amp-img></figure><p>ã€€ã€€å¯è§è¿™æ®µä»£ç çš„å…¥å£ç‚¹æœ‰ä¸”ä»…æœ‰ <code>__afl_maybe_log</code>ã€‚åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å·²ç»è¿½è¸ªè¿‡ AFL æ˜¯å¦‚ä½•è®°å½•åŸºæœ¬å—è·³è½¬çš„ï¼šç®€è€Œè¨€ä¹‹ï¼Œæ¡©ä»£ç å°†å‡ ä¸ªå¯„å­˜å™¨çš„å€¼ä¿å­˜åœ¨æ ˆä¸Šï¼Œç„¶åè°ƒç”¨ <code>__afl_maybe_log</code> ï¼›<code>__afl_maybe_log</code> é¦–å…ˆä¿å­˜å½“å‰ EFLAGS å¯„å­˜å™¨çŠ¶æ€ï¼Œç„¶åæ£€æŸ¥ shm åŒºåŸŸæ˜¯å¦å‡†å¤‡å¥½ï¼›å¦‚æœå·²ç»å‡†å¤‡å¥½ï¼Œåˆ™è¿›å…¥ <code>__afl_store</code> è¿‡ç¨‹ï¼Œç»™ shm åŒºåŸŸå¢åŠ  hit count åè¿”å›ã€‚</p><p>ã€€ã€€é‚£ä¹ˆï¼Œå¦‚æœæ­¤æ—¶ shm åŒºåŸŸæ²¡æœ‰å‡†å¤‡å¥½å‘¢ï¼Ÿè¿™å°±æ˜¯æœ¬æ–‡çš„å…³æ³¨ç‚¹ã€‚</p><figure class="kg-card kg-code-card"><pre><code class="language-c">__afl_maybe_log:

  lahf
  seto  %al

  /* Check if SHM region is already mapped. */

  movq  __afl_area_ptr(%rip), %rdx
  testq %rdx, %rdx
  je    __afl_setup

__afl_store:

  /* Calculate and store hit for the code location specified in rcx. */

  xorq __afl_prev_loc(%rip), %rcx
  xorq %rcx, __afl_prev_loc(%rip)
  shrq $1, __afl_prev_loc(%rip)

  incb (%rdx, %rcx, 1)

__afl_return:

  addb $127, %al
  sahf
  ret
</code></pre><figcaption>â–² ä¸Šä¸€ç¯‡æ–‡ç« åˆ†æçš„Â <code>__afl_maybe_log</code> ä»£ç ã€‚å¦‚æœ shm åŒºåŸŸå·²ç»å‡†å¤‡å¥½ï¼Œåˆ™ç›´æ¥å†™å…¥ shm åè¿”å›</figcaption></figure><p>ã€€ã€€ä»æ±‡ç¼–ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°ï¼Œå¦‚æœ <code>__afl_area_ptr</code> ç­‰äº 0ï¼Œåˆ™è®¤ä¸º shm æ²¡æœ‰æ˜ å°„å¥½ï¼Œè¿›å…¥ <code>__afl_setup</code> é€»è¾‘ã€‚è¿™é‡Œæä¸€å¥ï¼Œ <code>afl_area_ptr</code> è¿™ä¸ª 8 å­—èŠ‚çš„å˜é‡æ˜¯å®šä¹‰åœ¨ main payload çš„æœ«å°¾ï¼Œä¸€ä¸ª <code>.lcomm</code> ä¼ªæŒ‡ä»¤ã€‚åœ¨æ±‡ç¼–é˜¶æ®µå®Œæˆåï¼Œå®ƒè¢«æ”¾åœ¨ <code>.bss</code> æ®µã€‚</p><p>ã€€ã€€è·Ÿè¿› <code>__afl_setup</code> ï¼š</p><pre><code class="language-c">__afl_setup:

  /* Do not retry setup if we had previous failures. */

  cmpb $0, __afl_setup_failure(%rip)
  jne __afl_return

  /* Check out if we have a global pointer on file. */

  movq  __afl_global_area_ptr@GOTPCREL(%rip), %rdx
  movq  (%rdx), %rdx
  testq %rdx, %rdx
  je    __afl_setup_first

  movq %rdx, __afl_area_ptr(%rip)
  jmp  __afl_store</code></pre><p>ã€€ã€€é¦–å…ˆï¼Œå¦‚æœå‘ç° <code>__afl_setup_failure</code> å˜é‡ä¸ç­‰äº 0ï¼Œåˆ™ç›´æ¥è¿”å›ï¼›æ¥ç€ï¼Œå°è¯•ä» GOT è¡¨ä¸­å– <code>__afl_global_area_ptr</code>ï¼Œå¦‚æœå‘ç°æœ‰å€¼ï¼Œåˆ™ç”¨å…¶è¦†ç›– <code>__afl_area_ptr</code> ï¼Œè·³è½¬åˆ° <code>__afl_store</code> ï¼Œæ‰§è¡Œå¸¸è§„çš„ hit count++ï¼›å¦‚æœå‘ç° GOT è¡¨ä¸­çš„è¿™ä¸ª <code>__afl_global_area_ptr</code> æŒ‡é’ˆä¸º 0ï¼Œåˆ™è·³è½¬åˆ° <code>__afl_setup_first</code> ï¼Œå¼€å§‹åˆå§‹åŒ–å…±äº«å†…å­˜åŒºåŸŸã€‚</p><pre><code class="language-c">__afl_setup_first:

  /* Save everything that is not yet saved and that may be touched by
     getenv() and several other libcalls we'll be relying on. */

  leaq -352(%rsp), %rsp

  movq %rax,   0(%rsp)
  movq %rcx,   8(%rsp)
  movq %rdi,  16(%rsp)
  movq %rsi,  32(%rsp)
  movq %r8,   40(%rsp)
  movq %r9,   48(%rsp)
  movq %r10,  56(%rsp)
  movq %r11,  64(%rsp)

  movq %xmm0,  96(%rsp)
  movq %xmm1,  112(%rsp)
  movq %xmm2,  128(%rsp)
  movq %xmm3,  144(%rsp)
  movq %xmm4,  160(%rsp)
  movq %xmm5,  176(%rsp)
  movq %xmm6,  192(%rsp)
  movq %xmm7,  208(%rsp)
  movq %xmm8,  224(%rsp)
  movq %xmm9,  240(%rsp)
  movq %xmm10, 256(%rsp)
  movq %xmm11, 272(%rsp)
  movq %xmm12, 288(%rsp)
  movq %xmm13, 304(%rsp)
  movq %xmm14, 320(%rsp)
  movq %xmm15, 336(%rsp)

  /* Map SHM, jumping to __afl_setup_abort if something goes wrong. */

  /* The 64-bit ABI requires 16-byte stack alignment. We'll keep the
     original stack ptr in the callee-saved r12. */

  pushq %r12
  movq  %rsp, %r12
  subq  $16, %rsp
  andq  $0xfffffffffffffff0, %rsp

  leaq .AFL_SHM_ENV(%rip), %rdi
call getenv@PLT

  testq %rax, %rax
  je    __afl_setup_abort

  movq  %rax, %rdi
call atoi@PLT

  xorq %rdx, %rdx   /* shmat flags    */
  xorq %rsi, %rsi   /* requested addr */
  movq %rax, %rdi   /* SHM ID         */
call shmat@PLT

  cmpq $-1, %rax
  je   __afl_setup_abort

  /* Store the address of the SHM region. */

  movq %rax, %rdx
  movq %rax, __afl_area_ptr(%rip)

  movq __afl_global_area_ptr@GOTPCREL(%rip), %rdx
  movq %rax, (%rdx)
  movq %rax, %rdx

__afl_forkserver:
/* ...... */</code></pre><p>ã€€ã€€è§‚å¯Ÿ <code>__afl_setup_first</code> è¿‡ç¨‹ã€‚å®ƒé¦–å…ˆæŠŠä¸€äº› caller-save å¯„å­˜å™¨ä¿å­˜åœ¨æ ˆä¸Šï¼ˆè¿™æ˜¯ä¸ºäº†æ–¹ä¾¿åç»­åœ¨ fork server ä¸­æ¢å¤åŸæœ‰å¯„å­˜å™¨çŠ¶æ€ï¼‰ã€‚åœ¨åšå®Œè¿™äº›ä¿å­˜å·¥ä½œä¹‹åï¼Œä½œè€…å†™äº†è¿™å››è¡Œä»£ç ï¼š</p><pre><code class="language-c">  /* The 64-bit ABI requires 16-byte stack alignment. We'll keep the
     original stack ptr in the callee-saved r12. */

  pushq %r12
  movq  %rsp, %r12
  subq  $16, %rsp
  andq  $0xfffffffffffffff0, %rsp</code></pre><p>ã€€ã€€ä¿å­˜ r12 å¯„å­˜å™¨çš„å€¼ï¼›ç„¶åç”¨ r12 å¯„å­˜å™¨è®°å½•åŸå§‹çš„ rspï¼›æŠŠ rsp å‡å» 16ï¼Œå¹¶æ¸…ç©ºæœ€ä½ 4 bitã€‚æ³¨é‡Šä¸­æåˆ°ï¼Œæ ¹æ® <a href="https://docs.oracle.com/cd/E19253-01/816-5138/fcowb/index.html">ABI</a> è¦æ±‚ï¼Œæ ˆåœ°å€è¦åš 16 å­—èŠ‚å¯¹é½ã€‚è¿™æ ·ä¸€é¡¿æ“ä½œä¹‹åï¼Œ rsp ä¸€å®šæ˜¯ 16 çš„å€æ•°äº†ã€‚</p><p>ã€€ã€€ç»§ç»­å¾€ä¸‹çœ‹ï¼š</p><pre><code class="language-c">  leaq .AFL_SHM_ENV(%rip), %rdi
call getenv@PLT

  testq %rax, %rax
  je    __afl_setup_abort
</code></pre><p>ã€€ã€€è°ƒç”¨ <code>getenv("__AFL_SHM_ID")</code>ï¼Œå¦‚æœè¿”å› 0 åˆ™è¿›å…¥ <code>__afl_setup_abort</code> é”™è¯¯å¤„ç†æµç¨‹ï¼Œå¦åˆ™å¾€ä¸‹ç»§ç»­æ‰§è¡Œã€‚æˆ‘ä»¬å…ˆå»çœ‹é”™è¯¯å¤„ç†æµç¨‹ï¼š</p><pre><code class="language-c">__afl_setup_abort:

  /* Record setup failure so that we don't keep calling
     shmget() / shmat() over and over again. */

  incb __afl_setup_failure(%rip)

  movq %r12, %rsp
  popq %r12

  movq  0(%rsp), %rax
  movq  8(%rsp), %rcx
  movq 16(%rsp), %rdi
  movq 32(%rsp), %rsi
  movq 40(%rsp), %r8
  movq 48(%rsp), %r9
  movq 56(%rsp), %r10
  movq 64(%rsp), %r11

  movq  96(%rsp), %xmm0
  movq 112(%rsp), %xmm1
  movq 128(%rsp), %xmm2
  movq 144(%rsp), %xmm3
  movq 160(%rsp), %xmm4
  movq 176(%rsp), %xmm5
  movq 192(%rsp), %xmm6
  movq 208(%rsp), %xmm7
  movq 224(%rsp), %xmm8
  movq 240(%rsp), %xmm9
  movq 256(%rsp), %xmm10
  movq 272(%rsp), %xmm11
  movq 288(%rsp), %xmm12
  movq 304(%rsp), %xmm13
  movq 320(%rsp), %xmm14
  movq 336(%rsp), %xmm15

  leaq 352(%rsp), %rsp

  jmp __afl_return</code></pre><p>ã€€ã€€è¿™å°±æ˜¯æŠŠ <code>__afl_setup_failure</code> å˜é‡è‡ªå¢ï¼Œè¿˜åŸæ‰€æœ‰å¯„å­˜å™¨å¹¶è¿”å›ã€‚è‡³æ­¤ï¼Œæˆ‘ä»¬å‘ç°ï¼Œå¦‚æœç¯å¢ƒå˜é‡ <code>__AFL_SHM_ID</code> ä¸å­˜åœ¨ï¼Œåˆ™å…±äº«å†…å­˜çš„åˆå§‹åŒ–ä¼šå¤±è´¥ï¼Œä½†æ•´ä¸ªæ¡©ä»£ç å¯¹äºç›®æ ‡ç¨‹åºæ˜¯é€æ˜çš„â€”â€”æ— éæ˜¯ä¿å­˜äº†ä¸€äº›å¯„å­˜å™¨ã€æ‰§è¡Œäº†ä¸€äº›æ— å‰¯ä½œç”¨çš„ä»£ç ã€æœ€åæ¢å¤å¯„å­˜å™¨â€”â€”å› æ­¤ç›®æ ‡ç¨‹åºå¯ä»¥æ­£å¸¸æ‰§è¡Œã€‚è¿™ä¹Ÿè§£é‡Šäº†ä¸ºä½•æˆ‘ä»¬ä¸ä½¿ç”¨ <code>afl-fuzz</code> è€Œç›´æ¥è¿è¡Œæ’æ¡©åçš„ç›®æ ‡ç¨‹åºï¼Œä¹Ÿèƒ½æ‰§è¡Œå¦‚å¸¸ã€‚è¿™ä¸ªè®¾è®¡ä½“ç°äº† AFL çš„ç”¨æˆ·å‹å¥½æ€§ã€‚</p><p>ã€€ã€€å›è¿‡å¤´æ¥çœ‹ï¼Œå¦‚æœç¯å¢ƒå˜é‡ <code>__AFL_SHM_ID</code> å­˜åœ¨ï¼Œå°†ä¼šå‘ç”Ÿä»€ä¹ˆäº‹æƒ…ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><pre><code class="language-c">/* æ­¤æ—¶ %rax æ˜¯æŒ‡å‘ç¯å¢ƒå˜é‡ __AFL_SHM_ID çš„æŒ‡é’ˆ  */
  movq  %rax, %rdi
call atoi@PLT

  xorq %rdx, %rdx   /* shmat flags    */
  xorq %rsi, %rsi   /* requested addr */
  movq %rax, %rdi   /* SHM ID         */
call shmat@PLT

  cmpq $-1, %rax
  je   __afl_setup_abort
</code></pre><p>ã€€ã€€é¦–å…ˆæŠŠ <code>__AFL_SHM_ID</code> ä»å­—ç¬¦ä¸²è½¬æˆæ•´æ•°ï¼Œç„¶åè°ƒç”¨ <code>shmat(shmid, 0, 0)</code> ã€‚</p><div class="kg-card kg-callout-card kg-callout-card-grey"><div class="kg-callout-emoji">ğŸ““</div><div class="kg-callout-text">æŸ¥é˜…<a href="https://linux.die.net/man/2/shmat">æ–‡æ¡£</a>ï¼Œå¾—çŸ¥ <code>shmat</code> æ˜¯ shared memory attach çš„ç¼©å†™ï¼Œç”¨äº attach å…±äº«å†…å­˜ã€‚<br /><br />ä¸‰ä¸ªå‚æ•°åˆ†åˆ«ä¸º <code>(int shmid, const void *shmaddr, int shmflg)</code> ï¼š<br />- <code>shmid</code> æ˜¯ç¯å¢ƒå˜é‡æä¾›çš„ï¼›<br />- <code>shmaddr</code> ç­‰äº 0ï¼Œåˆ™äº¤ç”±æ“ä½œç³»ç»Ÿè‡ªè¡Œé€‰æ‹©ä¸€ç‰‡åœ°å€ç©ºé—´ï¼›<br />- <code>shmflg</code> ç­‰äº 0ï¼Œé‡‡ç”¨é»˜è®¤è®¾ç½®ã€‚<br /><br />å‡½æ•°çš„è¿”å›å€¼æ˜¯å…±äº«å†…å­˜èµ·ç‚¹çš„ä½ç½®ã€‚è‹¥ attach å¤±è´¥ï¼Œåˆ™è¿”å› $-1$ã€‚</div></div><p>ã€€ã€€ä¸Šé¢çš„æ±‡ç¼–ä»£ç ä¸­ï¼Œå¦‚æœå‘ç° attach å¤±è´¥ï¼Œåˆ™è¿›å…¥ AFL çš„é”™è¯¯å¤„ç†æµç¨‹ã€‚ä¸è¿‡è¯»åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªå°ç–‘é—®ï¼šä¸€ç‰‡å…±äº«å†…å­˜ï¼Œé¦–å…ˆåº”å½“ç”± <code>shmget()</code> åˆ›å»ºï¼Œå†ç”± <code>shmat()</code> æ˜ å°„åˆ°å½“å‰ç¨‹åºçš„è™šæ‹Ÿå†…å­˜ç©ºé—´ä¸­ã€‚é‚£ä¹ˆï¼Œ<strong>è¿™ç‰‡è™šæ‹Ÿå†…å­˜æ˜¯ä»€ä¹ˆæ—¶å€™åˆ›å»ºçš„ï¼Ÿ</strong>ç­”æ¡ˆæ˜¯ <code>afl-fuzz</code> åœ¨ <code>setup_shm()</code> æµç¨‹ä¸­è°ƒç”¨ <code>shmget()</code> åˆ›å»ºäº†è™šæ‹Ÿå†…å­˜ï¼Œå¹¶å°† shm id å†™å…¥ <code>__AFL_SHM_ID</code> ç¯å¢ƒå˜é‡ã€‚å¦‚æœæˆ‘ä»¬å¹¶éé€šè¿‡ <code>afl-fuzz</code> è¿è¡Œç¨‹åºï¼Œè‡ªç„¶è¿™ç‰‡è™šæ‹Ÿå†…å­˜ä¸ä¼šè¢«åˆ›å»ºï¼Œä¹Ÿä¸ä¼šå­˜åœ¨ <code>__AFL_SHM_ID</code> ç¯å¢ƒå˜é‡äº†ã€‚</p><p>ã€€ã€€è‡³æ­¤ï¼Œç¨‹åºæˆåŠŸåœ°å°† <code>afl-fuzz</code> è¿›ç¨‹æ‰€åˆ›å»ºçš„ä¸€ç‰‡å…±äº«å†…å­˜ï¼Œæ˜ å°„åˆ°äº†è‡ªå·±çš„è™šæ‹Ÿåœ°å€ç©ºé—´å†…ã€‚æ¥ç€çœ‹æ±‡ç¼–ï¼š</p><pre><code class="language-c">  /* Store the address of the SHM region. */

  movq %rax, %rdx
  movq %rax, __afl_area_ptr(%rip)

  movq __afl_global_area_ptr@GOTPCREL(%rip), %rdx
  movq %rax, (%rdx)
  movq %rax, %rdx

__afl_forkserver:
/* ...... */</code></pre><p>ã€€ã€€å°†å…±äº«å†…å­˜åŒºåŸŸçš„åœ°å€å­˜è¿› <code>__afl_area_ptr</code>ï¼Œå¹¶å†™è¿› GOT è¡¨ä¸­çš„ <code>__afl_global_area_ptr</code> æ¡ç›®ã€‚æœ€åï¼Œç”¨ rdx å¯„å­˜å™¨å­˜æ”¾å…±äº«å†…å­˜åœ°å€ï¼Œè¿›å…¥ fork serverã€‚</p><p>ã€€ã€€<strong>ä¸ºä½•åŒæ—¶æœ‰ </strong><code><strong>__afl_area_ptr</strong></code><strong> å’Œ </strong><code><strong>__afl_global_area_ptr</strong></code><strong> ï¼Ÿ</strong>æˆ‘ä»¬æ¥çœ‹å®ƒä»¬çš„å®šä¹‰ï¼Œä½äº main payload å°¾éƒ¨ï¼š</p><pre><code class="language-c">.AFL_VARS:

  .lcomm   __afl_area_ptr, 8
  .lcomm   __afl_prev_loc, 8
  .lcomm   __afl_fork_pid, 4
  .lcomm   __afl_temp, 4
  .lcomm   __afl_setup_failure, 1
  .comm    __afl_global_area_ptr, 8, 8

.AFL_SHM_ENV:
  .asciz "__AFL_SHM_ID"

/* --- END --- */</code></pre><p>ã€€ã€€å¯ä»¥çœ‹åˆ°ï¼Œ<code>__afl_area_ptr</code> æ˜¯ä¸€ä¸ª <code>lcomm</code>ï¼Œè€Œ <code>__afl_global_area_ptr</code> æ˜¯ä¸€ä¸ª <code>comm</code> ã€‚æ ¹æ®ä¸€ç¯‡ <a href="https://stackoverflow.com/questions/34157895/asm-what-is-a-local-common-area-and-difference-between-lcomm-and-comm">Stackoverflow é—®ç­”</a>ï¼Œ<code>lcomm</code> æœ‰ç‚¹ç±»ä¼¼äºå…¨å±€ static å˜é‡ï¼Œä¸åŒæ–‡ä»¶ä¸­çš„é‡å <code>lcomm</code> æ˜¯æŒ‡å‘ä¸åŒçš„åœ°å€ï¼›ä½† <code>comm</code> æœ‰ç‚¹ç±»ä¼¼äºå…¨å±€å˜é‡ï¼Œä¸åŒæ–‡ä»¶ä¸­çš„é‡å <code>comm</code> æŒ‡å‘åŒä¸€ä¸ªåœ°å€ã€‚</p><p>ã€€ã€€å› æ­¤ï¼Œè¿™ä¸ªé—®é¢˜çš„è§£ç­”æ˜¯ï¼šå‡å¦‚ç›®æ ‡ç¨‹åºæ˜¯å¤šä»½ä»£ç é“¾æ¥å½¢æˆçš„ï¼Œé‚£ä¹ˆï¼Œæ¯ä»½æ±‡ç¼–æ–‡ä»¶éƒ½æ‹¥æœ‰ AFL main payloadï¼›å¯¹äºç¼–è¯‘å‡ºçš„æ¯ä¸ªä»£ç ç‰‡æ®µï¼Œéƒ½ä¼šæœ‰è‡ªå·±å¯¹åº”çš„ <code>__afl_area_ptr</code> ã€‚ä½† <code>__afl_global_area_ptr</code> åªæœ‰ä¸€ä»½ï¼Œåªéœ€è¦ä¼˜å…ˆå‚è€ƒ <code>__afl_global_area_ptr</code> ï¼Œå°±èƒ½è®©æ‰€æœ‰æ¡©ä»£ç è®¿é—®çš„ shm ä¿æŒä¸€è‡´ã€‚</p><p>ã€€ã€€å®éªŒä¸€ä¸‹ã€‚å†™ä¸¤ä»½ä»£ç ï¼Œåˆå¹¶ç¼–è¯‘ï¼Œè§‚å¯Ÿ bss æ®µï¼Œè¯æ˜æˆ‘ä»¬çš„è§£é‡Šæ˜¯æ­£ç¡®çš„ï¼š</p><figure class="kg-card kg-image-card kg-card-hascaption"><amp-img src="https://www.ruanx.net/content/images/2023/05/image-6.png" class="kg-image" alt width="1882" height="1006" srcset="https://www.ruanx.net/content/images/size/w600/2023/05/image-6.png 600w, https://www.ruanx.net/content/images/size/w1000/2023/05/image-6.png 1000w, https://www.ruanx.net/content/images/size/w1600/2023/05/image-6.png 1600w, https://www.ruanx.net/content/images/2023/05/image-6.png 1882w" layout="responsive"></amp-img><figcaption>â–² ç¼–è¯‘æŒ‡ä»¤ <code>afl-gcc main.c fun.c</code> ï¼Œæœ‰ä¸¤ä¸ªä¸åŒçš„ <code>__afl_area_ptr</code> ï¼Œä½†åªæœ‰ä¸€ä¸ª <code>__afl_global_area_ptr</code>Â </figcaption></figure><p> ã€€ã€€ä»¥ä¸Šï¼Œæˆ‘ä»¬åˆ†æå®Œäº† shm æ˜¯å¦‚ä½•åˆå§‹åŒ–çš„ã€‚æ¥ä¸‹æ¥ï¼Œè¯¥åˆ†æ fork server äº†ã€‚</p><h3 id="0x02-fork-server">0x02 fork server</h3><p>ã€€ã€€<a href="https://xidoo.top/2022/01/afl-white-book/#10-%E5%A4%8D%E5%88%B6%E6%9C%8D%E5%8A%A1%E5%99%A8-the-fork-server">AFL ç™½çš®ä¹¦</a>ä¸­æåˆ°ï¼Œ<code>execve()</code> çš„æ•ˆç‡æ¯”è¾ƒä½ã€‚fuzzer éœ€è¦é«˜é¢‘ç‡åœ°æ‰§è¡Œç›®æ ‡ç¨‹åºï¼Œæ˜¾ç„¶ä¸å®œåœ¨ <code>execve()</code> ä¸Šæµªè´¹è¿‡å¤šæ—¶é—´ã€‚AFL çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨ fork serverï¼šè®©ç¨‹åºåœ¨ç¬¬ä¸€ä¸ªåŸºæœ¬å—å¤„åœä¸‹ï¼Œç­‰å¾… fuzzer å‘é€æŒ‡ä»¤ï¼›æ”¶åˆ°æŒ‡ä»¤åç»§ç»­æ‰§è¡Œç¨‹åºï¼›æ‰§è¡Œå®Œæ¯•åï¼Œæ¢å¤ fork æ—¶çš„çŠ¶æ€ã€‚å¾—ç›Šäº copy-on-write æŠ€æœ¯ï¼Œæˆ‘ä»¬å¯ä»¥é«˜æ•ˆåœ°å®ç°è¿™ä¸€éœ€æ±‚ã€‚</p><p>ã€€ã€€æ¥çœ‹æ±‡ç¼–ä»£ç ï¼š</p><pre><code class="language-c">__afl_forkserver:

  /* Enter the fork server mode to avoid the overhead of execve() calls. We
     push rdx (area ptr) twice to keep stack alignment neat. */

  /* æ­¤æ—¶ %rdx å†…ä¿å­˜ shm åœ°å€ */
  pushq %rdx
  pushq %rdx

  /* Phone home and tell the parent that we're OK. (Note that signals with
     no SA_RESTART will mess it up). If this fails, assume that the fd is
     closed because we were execve()d from an instrumented binary, or because
     the parent doesn't want to use the fork server. */

  movq $4, %rdx               /* length    */
  leaq __afl_temp(%rip), %rsi /* data      */
  movq $(198 + 1), %rdi       /* file desc */
call write@PLT

  cmpq $4, %rax
  jne  __afl_fork_resume

__afl_fork_wait_loop:
/* ...... */</code></pre><p>ã€€ã€€æŠŠ shm åœ°å€è¿ç»­å‹æ ˆä¸¤æ¬¡ï¼ˆä»¥ä¿è¯ esp ä»ç„¶æ˜¯ 16 çš„å€æ•°ï¼‰ï¼Œç„¶åè°ƒç”¨ <code>write(198+1, __afl_temp, 4)</code>ã€‚å…¶ä¸­ï¼Œ198 è¿™ä¸€ magic numberï¼Œæ˜¯ <code>config.h</code> ä¸­çš„ <code>FORKSRV_FD</code> å¸¸é‡ã€‚fork server ä½¿ç”¨ 198ã€199 è¿™ä¸¤ä¸ª fd ä¼ é€’æŒ‡ä»¤ã€‚è€Œ <code>__afl_temp</code> æ˜¯ bss æ®µçš„é•¿åº¦ 4 å­—èŠ‚çš„å˜é‡ã€‚</p><p>ã€€ã€€å¦‚æœè¿™å››ä¸ªå­—èŠ‚å†™å…¥å¤±è´¥ï¼ˆ<code>write()</code> çš„è¿”å›ä¸ç­‰äº 4ï¼‰ï¼Œåˆ™ç›´æ¥è¿›å…¥ <code>__afl_fork_resume</code> é€»è¾‘ï¼›å¦åˆ™ï¼Œè¿›å…¥ <code>__afl_fork_wait_loop</code> é€»è¾‘ã€‚</p><p>ã€€ã€€è·Ÿè¿› <code>__afl_fork_wait_loop</code>ï¼š</p><pre><code class="language-c">__afl_fork_wait_loop:

  /* Wait for parent by reading from the pipe. Abort if read fails. */

  movq $4, %rdx               /* length    */
  leaq __afl_temp(%rip), %rsi /* data      */
  movq $198, %rdi             /* file desc */
call read@PLT
  cmpq $4, %rax
  jne  __afl_die
</code></pre><p>ã€€ã€€ä» fd 198 ä¸­è¯»å–å››ä¸ªå­—èŠ‚ï¼ˆæ³¨æ„ <code>read()</code> å‡½æ•°æ˜¯é˜»å¡çš„ï¼‰ã€‚å¦‚æœè¯»å–å¤±è´¥ï¼Œåˆ™è·³è½¬åˆ° <code>__afl_die</code>ã€‚å¦‚æœè¯»å–æˆåŠŸï¼Œåˆ™æ‰§è¡Œä¸‹é¢çš„ä»£ç ï¼š</p><pre><code class="language-c">  /* Once woken up, create a clone of our process. This is an excellent use
     case for syscall(__NR_clone, 0, CLONE_PARENT), but glibc boneheadedly
     caches getpid() results and offers no way to update the value, breaking
     abort(), raise(), and a bunch of other things :-( */

call fork@PLT
  cmpq $0, %rax
  jl   __afl_die
  je   __afl_fork_resume
</code></pre><p>ã€€ã€€åœ¨è¿™é‡Œè¿›è¡Œ forkï¼Œå¦‚æœå¤±è´¥äº†åˆ™è·³è½¬åˆ° <code>__afl_die</code>ã€‚å¯¹äºå­è¿›ç¨‹ï¼Œè·³è½¬åˆ° <code>__afl_fork_resume</code> ï¼›å¯¹äºçˆ¶è¿›ç¨‹ï¼Œåˆ™ç»§ç»­æ‰§è¡Œä»¥ä¸‹é€»è¾‘ï¼š</p><pre><code class="language-c">  /* In parent process: write PID to pipe, then wait for child. */

  movl %eax, __afl_fork_pid(%rip)

  movq $4, %rdx                   /* length    */
  leaq __afl_fork_pid(%rip), %rsi /* data      */
  movq $(198 + 1), %rdi             /* file desc */
call write@PLT

  movq $0, %rdx                   /* no flags  */
  leaq __afl_temp(%rip), %rsi     /* status    */
  movq __afl_fork_pid(%rip), %rdi /* PID       */
call waitpid@PLT
  cmpq $0, %rax
  jle  __afl_die

  /* Relay wait status to pipe, then loop back. */

  movq $4, %rdx               /* length    */
  leaq __afl_temp(%rip), %rsi /* data      */
  movq $(198 + 1), %rdi         /* file desc */
call write@PLT

  jmp  __afl_fork_wait_loop
</code></pre><p>ã€€ã€€è¿™æ®µä»£ç é€»è¾‘æ˜¯ï¼šå°†å­è¿›ç¨‹çš„ pid ä¿å­˜åˆ° <code>__afl_fork_pid</code> å˜é‡ï¼›å‘ fd 199 å†™å…¥å­è¿›ç¨‹çš„ pidï¼›è°ƒç”¨ <code>waitpid()</code> ç­‰å¾…å­è¿›ç¨‹æ‰§è¡Œå®Œæ¯•ï¼ˆå¦‚æœç­‰å¾…å¤±è´¥ï¼Œåˆ™è¿›å…¥ <code>__afl_die</code>ï¼‰ï¼›å°†å­è¿›ç¨‹çš„é€€å‡ºåŸå› å†™è¿› fd 199ï¼Œå¹¶å›åˆ° <code>__afl_fork_wait_loop</code>ã€‚</p><p>ã€€ã€€ä¹‹å‰æåˆ°ï¼Œfork ä¹‹åï¼Œå­è¿›ç¨‹ä¼šè·³è½¬åˆ° <code>__afl_fork_resume</code> é€»è¾‘ã€‚è·Ÿè¿›ï¼š</p><pre><code class="language-c">__afl_fork_resume:

  /* In child process: close fds, resume execution. */

  movq $198, %rdi
call close@PLT

  movq $(198 + 1), %rdi
call close@PLT

  popq %rdx
  popq %rdx

  movq %r12, %rsp
  popq %r12

  movq  0(%rsp), %rax
  movq  8(%rsp), %rcx
  movq 16(%rsp), %rdi
  movq 32(%rsp), %rsi
  movq 40(%rsp), %r8
  movq 48(%rsp), %r9
  movq 56(%rsp), %r10
  movq 64(%rsp), %r11

  movq  96(%rsp), %xmm0
  movq 112(%rsp), %xmm1
  movq 128(%rsp), %xmm2
  movq 144(%rsp), %xmm3
  movq 160(%rsp), %xmm4
  movq 176(%rsp), %xmm5
  movq 192(%rsp), %xmm6
  movq 208(%rsp), %xmm7
  movq 224(%rsp), %xmm8
  movq 240(%rsp), %xmm9
  movq 256(%rsp), %xmm10
  movq 272(%rsp), %xmm11
  movq 288(%rsp), %xmm12
  movq 304(%rsp), %xmm13
  movq 320(%rsp), %xmm14
  movq 336(%rsp), %xmm15

  leaq 352(%rsp), %rsp

  jmp  __afl_store
</code></pre><p>ã€€ã€€é¦–å…ˆå…³é—­ä»çˆ¶è¿›ç¨‹é‚£é‡Œç»§æ‰¿æ¥çš„ fd 198ã€199ï¼Œç„¶åæ¢å¤æ‰€æœ‰å¯„å­˜å™¨ï¼Œæ¢å¤æ ˆåœ°å€ï¼Œè·³è½¬åˆ° <code>__afl_store</code>ã€‚è€Œ <code>__afl_store</code> åœ¨å¢åŠ  hit count ä¹‹åï¼Œè·³è½¬å› AFL å¾€åŸºæœ¬å—å¤´éƒ¨æ’å…¥çš„æ¡©ä»£ç â€”â€”åˆ°æ­¤ä¸ºæ­¢ï¼Œå­è¿›ç¨‹æ¢å¤æ‰€æœ‰çŠ¶æ€ï¼Œå¼€å§‹äº†ç¨‹åºä¸­ç¬¬ä¸€ä¸ªåŸºæœ¬å—çš„æ‰§è¡Œã€‚</p><h3 id="0x03-%E6%80%BB%E7%BB%93">0x03 æ€»ç»“</h3><p>ã€€ã€€AFL main payload è®¾è®¡å¾—ç›¸å½“ç²¾å¦™ã€‚å®ƒè®©ç¨‹åºåœ¨ç¬¬ä¸€ä¸ªåŸºæœ¬å—å¤„åœä¸‹ï¼Œåˆå§‹åŒ–å…±äº«å†…å­˜ï¼Œå¹¶æ¯æ¬¡ä»è¿™ä¸ªä½ç½® fork å‡ºå­è¿›ç¨‹ã€æ¢å¤ç¨‹åºçŠ¶æ€ã€ç»§ç»­æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼›å­è¿›ç¨‹æ‰§è¡Œå®Œåï¼Œfork server åˆ™å‘ fuzzer æŠ¥å‘Šæ‰§è¡Œæƒ…å†µï¼Œå¼€å§‹æ–°ä¸€è½®æ‰§è¡Œã€‚é€šè¿‡ fork serverï¼ŒAFL å¾—ä»¥é¿å…é¢‘ç¹çš„ <code>execve</code> è°ƒç”¨ï¼Œä»è€Œæå‡äº† fuzz æ•ˆç‡ã€‚</p><p>ã€€ã€€å…±äº«å†…å­˜ç”± <code>afl-fuzz</code> ç¨‹åºå»ºç«‹ï¼Œå…¶ shm id è®°å½•åœ¨ç¯å¢ƒå˜é‡ <code>__AFL_SHM_ID</code> ä¸­ã€‚ç›®æ ‡ç¨‹åºåˆå§‹åŒ–æ—¶ï¼Œä¼šå°†è¿™å—å…±äº«å†…å­˜ attach åˆ°è‡ªå·±çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œä»è€Œ <code>afl-fuzz</code> è¿›ç¨‹å¯ä»¥ç»Ÿè®¡ hit countã€‚</p><p>ã€€ã€€fork server çš„åŠ¨ä½œç”± <code>afl-fuzz</code> è¿›ç¨‹æ§åˆ¶ã€‚ç›®æ ‡ç¨‹åºä¸ <code>afl-fuzz</code> é€è¿‡ fd ä¼ é€’ä¿¡æ¯â€”â€”fd 198 ç”¨äº fuzzer å‘ fork server å‘é€å¯åŠ¨æŒ‡ä»¤ï¼Œfd 199 ç”¨äº fork server å‘ fuzzer æŠ¥å‘Šå­è¿›ç¨‹çš„ pid å’Œæ‰§è¡Œç»“æœã€‚</p><p>ã€€ã€€ä¸ç›´è§‰ç›¸åï¼Œä¸€ä¸ªè¿è¡Œè¶…æ—¶çš„å­è¿›ç¨‹ï¼Œå¹¶ä¸æ˜¯ç”± fork server ç»“æŸçš„ï¼Œè€Œæ˜¯ç”± <code>afl-fuzz</code> ç»“æŸçš„ã€‚è¿™äº›å†…å®¹è¦ç­‰åˆ°æˆ‘ä»¬é˜…è¯» <code>afl-fuzz.c</code> æ—¶æ‰èƒ½ç»†è‡´æŒæ¡ã€‚</p><p>ã€€ã€€æ€»ä¹‹ï¼Œæˆ‘ä»¬å·²ç»é˜…è¯»å®Œäº† <code>afl-gcc.c</code> å’Œ <code>afl-as.c</code> è¿™ä¸¤ä»½ä»£ç ï¼Œå¯¹æ’æ¡©è¿‡ç¨‹æœ‰äº†è¯¦ç»†çš„äº†è§£ã€‚æŒ‰ç…§è®¡åˆ’ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å°†é˜…è¯» <code>afl-tmin.c</code> ï¼Œä»¥äº†è§£ AFL æ˜¯å¦‚ä½•æ”¶é›†ã€å¤„ç†ç¨‹åºçš„è¦†ç›–åº¦ä¿¡æ¯ã€‚</p>

            </section>

        </article>
    </main>
    <footer class="page-footer">
            <amp-img class="site-icon" src="https://www.ruanx.net/content/images/2020/02/small-3.png" width="50" height="50" layout="fixed" alt="Pion1eer"></amp-img>
        <h3>Pion1eer</h3>
            <p>Stand with Ukraine ğŸ’™ğŸ’›</p>
        <p><a href="../../index.html">Read more posts â†’</a></p>
        <a class="powered" href="https://ghost.org" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 156 156"><g fill="none" fill-rule="evenodd"><rect fill="#15212B" width="156" height="156" rx="27"/><g transform="translate(36 36)" fill="#F6F8FA"><path d="M0 71.007A4.004 4.004 0 014 67h26a4 4 0 014 4.007v8.986A4.004 4.004 0 0130 84H4a4 4 0 01-4-4.007v-8.986zM50 71.007A4.004 4.004 0 0154 67h26a4 4 0 014 4.007v8.986A4.004 4.004 0 0180 84H54a4 4 0 01-4-4.007v-8.986z"/><rect y="34" width="84" height="17" rx="4"/><path d="M0 4.007A4.007 4.007 0 014.007 0h41.986A4.003 4.003 0 0150 4.007v8.986A4.007 4.007 0 0145.993 17H4.007A4.003 4.003 0 010 12.993V4.007z"/><rect x="67" width="17" height="17" rx="4"/></g></g></svg> Published with Ghost</a>
    </footer>
    
</body>
</html>
