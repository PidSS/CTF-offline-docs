<!DOCTYPE html>
<html âš¡>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">

    <title>AFLæºç é˜…è¯»ï¼ˆä¸€ï¼‰ï¼šå¯ç¨‹</title>

    <meta name="description" content="å¼€å§‹é˜…è¯» AFL çš„æºç ã€‚æœ¬æ–‡åˆ†æäº† AFL é¡¹ç›®çš„æ–‡ä»¶ç»“æ„ï¼Œç¡®å®šäº†é˜…è¯»ä»£ç çš„é¡ºåºï¼Œå¹¶è¯¦ç»†è§£é‡Šäº† afl-gcc å’Œ afl-as ä»£ç ã€‚" />
    <link rel="icon" href="../../content/images/size/w256h256/2020/02/small-3.png" type="image/png" />
    <link rel="canonical" href="../index.html" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    
    <meta property="og:site_name" content="Pion1eer" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="AFLæºç é˜…è¯»ï¼ˆä¸€ï¼‰ï¼šå¯ç¨‹" />
    <meta property="og:description" content="å¼€å§‹é˜…è¯» AFL çš„æºç ã€‚æœ¬æ–‡åˆ†æäº† AFL é¡¹ç›®çš„æ–‡ä»¶ç»“æ„ï¼Œç¡®å®šäº†é˜…è¯»ä»£ç çš„é¡ºåºï¼Œå¹¶è¯¦ç»†è§£é‡Šäº† afl-gcc å’Œ afl-as ä»£ç ã€‚" />
    <meta property="og:url" content="https://www.ruanx.net/afl-source-1/" />
    <meta property="og:image" content="https://www.ruanx.net/content/images/2023/05/output-2.jpg" />
    <meta property="article:published_time" content="2023-05-07T12:45:20.000Z" />
    <meta property="article:modified_time" content="2023-05-08T07:00:12.000Z" />
    <meta property="article:tag" content="Fuzzing" />
    
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="AFLæºç é˜…è¯»ï¼ˆä¸€ï¼‰ï¼šå¯ç¨‹" />
    <meta name="twitter:description" content="å¼€å§‹é˜…è¯» AFL çš„æºç ã€‚æœ¬æ–‡åˆ†æäº† AFL é¡¹ç›®çš„æ–‡ä»¶ç»“æ„ï¼Œç¡®å®šäº†é˜…è¯»ä»£ç çš„é¡ºåºï¼Œå¹¶è¯¦ç»†è§£é‡Šäº† afl-gcc å’Œ afl-as ä»£ç ã€‚" />
    <meta name="twitter:url" content="https://www.ruanx.net/afl-source-1/" />
    <meta name="twitter:image" content="https://www.ruanx.net/content/images/2023/05/output-2.jpg" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Ruan Xingzhi" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Fuzzing" />
    <meta property="og:image:width" content="640" />
    <meta property="og:image:height" content="480" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Pion1eer",
        "url": "https://www.ruanx.net/",
        "logo": {
            "@type": "ImageObject",
            "url": "https://www.ruanx.net/content/images/size/w256h256/2020/02/small-3.png",
            "width": 60,
            "height": 60
        }
    },
    "author": {
        "@type": "Person",
        "name": "Ruan Xingzhi",
        "image": {
            "@type": "ImageObject",
            "url": "https://www.ruanx.net/content/images/2020/05/blue.jpeg",
            "width": 1024,
            "height": 1024
        },
        "url": "https://www.ruanx.net/author/blue/",
        "sameAs": []
    },
    "headline": "AFLæºç é˜…è¯»ï¼ˆä¸€ï¼‰ï¼šå¯ç¨‹",
    "url": "https://www.ruanx.net/afl-source-1/",
    "datePublished": "2023-05-07T12:45:20.000Z",
    "dateModified": "2023-05-08T07:00:12.000Z",
    "image": {
        "@type": "ImageObject",
        "url": "https://www.ruanx.net/content/images/2023/05/output-2.jpg",
        "width": 640,
        "height": 480
    },
    "keywords": "Fuzzing",
    "description": "å¼€å§‹é˜…è¯» AFL çš„æºç ã€‚æœ¬æ–‡åˆ†æäº† AFL é¡¹ç›®çš„æ–‡ä»¶ç»“æ„ï¼Œç¡®å®šäº†é˜…è¯»ä»£ç çš„é¡ºåºï¼Œå¹¶è¯¦ç»†è§£é‡Šäº† afl-gcc å’Œ afl-as ä»£ç ã€‚",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://www.ruanx.net/"
    }
}
    </script>

    <meta name="generator" content="Ghost 5.8" />
    <link rel="alternate" type="application/rss+xml" title="Pion1eer" href="../../rss/index.rss" />

    <style amp-custom>*,
    *::before,
    *::after {
        box-sizing: border-box;
    }

    html {
        overflow-x: hidden;
        overflow-y: scroll;
        font-size: 62.5%;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
    }

    body {
        min-height: 100vh;
        margin: 0;
        padding: 0;
        color: #3a4145;
        font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;
        font-size: 1.7rem;
        line-height: 1.55em;
        font-weight: 400;
        font-style: normal;
        background: #fff;
        scroll-behavior: smooth;
        overflow-x: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    p,
    ul,
    ol,
    li,
    dl,
    dd,
    hr,
    pre,
    form,
    table,
    video,
    figure,
    figcaption,
    blockquote {
        margin: 0;
        padding: 0;
    }

    ul[class],
    ol[class] {
        padding: 0;
        list-style: none;
    }

    img {
        display: block;
        max-width: 100%;
    }

    input,
    button,
    select,
    textarea {
        font: inherit;
        -webkit-appearance: none;
    }

    fieldset {
        margin: 0;
        padding: 0;
        border: 0;
    }

    label {
        display: block;
        font-size: 0.9em;
        font-weight: 700;
    }

    hr {
        position: relative;
        display: block;
        width: 100%;
        height: 1px;
        border: 0;
        border-top: 1px solid currentcolor;
        opacity: 0.1;
    }

    ::selection {
        text-shadow: none;
        background: #cbeafb;
    }

    mark {
        background-color: #fdffb6;
    }

    small {
        font-size: 80%;
    }

    sub,
    sup {
        position: relative;
        font-size: 75%;
        line-height: 0;
        vertical-align: baseline;
    }
    sup {
        top: -0.5em;
    }
    sub {
        bottom: -0.25em;
    }

    ul li + li {
        margin-top: 0.6em;
    }

    a {
        color: var(--ghost-accent-color, #1292EE);
        text-decoration-skip-ink: auto;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
        margin: 0;
        font-weight: 700;
        color: #121212;
        line-height: 1.4em;
    }

    h1 {
        font-size: 3.4rem;
        line-height: 1.1em;
    }

    h2 {
        font-size: 2.4rem;
        line-height: 1.2em;
    }

    h3 {
        font-size: 1.8rem;
    }

    h4 {
        font-size: 1.7rem;
    }

    h5 {
        font-size: 1.6rem;
    }

    h6 {
        font-size: 1.6rem;
    }

    amp-img {
        height: 100%;
        width: 100%;
        max-width: 100%;
        max-height: 100%;
    }

    amp-img img {
        object-fit: cover;
    }

    .page-header {
        padding: 50px 5vmin 30px;
        text-align: center;
        font-size: 2rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .page-header a {
        color: #121212;
        font-weight: 700;
        text-decoration: none;
        font-size: 1.6rem;
        letter-spacing: -0.1px;
    }

    .post {
        max-width: 680px;
        margin: 0 auto;
    }

    .post-header {
        margin: 0 5vmin 5vmin;
        text-align: center;
    }

    .post-meta {
        margin: 1rem 0 0 0;
        text-transform: uppercase;
        color: #738a94;
        font-weight: 500;
        font-size: 1.3rem;
    }

    .post-image {
        margin: 0 0 5vmin;
    }

    .post-image img {
        display: block;
        width: 100%;
        height: auto;
    }

    .post-content {
        padding: 0 5vmin;
    }

    .post-content > * + * {
        margin-top: 1.5em;
    }

    .post-content [id]:not(:first-child) {
        margin: 2em 0 0;
    }

    .post-content > [id] + * {
        margin-top: 1rem;
    }

    .post-content [id] + .kg-card,
    .post-content blockquote + .kg-card {
        margin-top: 40px;
    }

    .post-content > ul,
    .post-content > ol,
    .post-content > dl {
        padding-left: 1.9em;
    }

    .post-content hr {
        margin-top: 40px;
    }

    .post .post-content hr + * {
        margin-top: 40px;
    }

    .post-content amp-img {
        background-color: #f8f8f8;
    }

    .post-content blockquote {
        position: relative;
        font-style: italic;
    }

    .post-content blockquote::before {
        content: "";
        position: absolute;
        left: -1.5em;
        top: 0;
        bottom: 0;
        width: 0.3rem;
        background: var(--ghost-accent-color, #1292EE);
    }

    .post-content blockquote.kg-blockquote-alt {
        font-size: 1.2em;
        font-style: italic;
        line-height: 1.6em;
        text-align: center;
        color: #738a94;
        padding: 0.75em 3em 1.25em;
    }

    .post-content blockquote.kg-blockquote-alt::before {
        display: none;
    }

    .post-content :not(.kg-card):not([id]) + .kg-card {
        margin-top: 40px;
    }

    .post-content .kg-card + :not(.kg-card) {
        margin-top: 40px;
    }

    .kg-card figcaption {
        padding: 1.5rem 1.5rem 0;
        text-align: center;
        font-weight: 500;
        font-size: 1.3rem;
        line-height: 1.4em;
        opacity: 0.6;
    }

    .kg-card figcaption strong {
        color: rgba(0,0,0,0.8);
    }

    .post-content :not(pre) code {
        vertical-align: middle;
        padding: 0.15em 0.4em 0.15em;
        border: #e1eaef 1px solid;
        font-weight: 400;
        font-size: 0.9em;
        line-height: 1em;
        color: #15171a;
        background: #f0f6f9;
        border-radius: 0.25em;
    }

    .post-content > pre {
        overflow: scroll;
        padding: 16px 20px;
        color: #fff;
        background: #1F2428;
        border-radius: 5px;
        box-shadow: 0 2px 6px -2px rgba(0,0,0,.1), 0 0 1px rgba(0,0,0,.4);
    }

    .kg-embed-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
    }

    .kg-image-card img {
        margin: auto;
    }

    .kg-gallery-card + .kg-gallery-card {
        margin-top: 0.75em;
    }

    .kg-gallery-container {
        position: relative;
    }

    .kg-gallery-row {
        display: flex;
        flex-direction: row;
        justify-content: center;
    }

    .kg-gallery-image {
        width: 100%;
        height: 100%;
    }

    .kg-gallery-row:not(:first-of-type) {
        margin: 0.75em 0 0 0;
    }

    .kg-gallery-image:not(:first-of-type) {
        margin: 0 0 0 0.75em;
    }

    .kg-bookmark-card,
    .kg-bookmark-publisher {
        position: relative;
    }

    .kg-bookmark-container,
    .kg-bookmark-container:hover {
        display: flex;
        flex-wrap: wrap;
        flex-direction: row-reverse;
        color: currentColor;
        background: rgba(255,255,255,0.6);
        font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;
        text-decoration: none;
        border-radius: 3px;
        box-shadow: 0 2px 6px -2px rgba(0, 0, 0, 0.1), 0 0 1px rgba(0, 0, 0, 0.4);
        overflow: hidden;
    }

    .kg-bookmark-content {
        flex-basis: 0;
        flex-grow: 999;
        padding: 20px;
        order: 1;
    }

    .kg-bookmark-title {
        font-weight: 600;
        font-size: 1.5rem;
        line-height: 1.3em;
    }

    .kg-bookmark-description {
        display: -webkit-box;
        max-height: 45px;
        margin: 0.5em 0 0 0;
        font-size: 1.4rem;
        line-height: 1.55em;
        overflow: hidden;
        opacity: 0.8;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    .kg-bookmark-metadata {
        margin-top: 20px;
    }

    .kg-bookmark-metadata {
        display: flex;
        align-items: center;
        font-weight: 500;
        font-size: 1.3rem;
        line-height: 1.3em;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .kg-bookmark-description {
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2;
        overflow: hidden;
    }

    .kg-bookmark-metadata amp-img {
        width: 18px;
        height: 18px;
        max-width: 18px;
        max-height: 18px;
        margin-right: 10px;
    }

    .kg-bookmark-thumbnail {
        display: flex;
        flex-basis: 20rem;
        flex-grow: 1;
        justify-content: flex-end;
    }

    .kg-bookmark-thumbnail amp-img {
        max-height: 200px;
    }

    .kg-bookmark-author {
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
    }

    .kg-bookmark-publisher::before {
        content: "â€¢";
        margin: 0 .5em;
    }

    .kg-toggle-card-icon {
        display: none;
    }

    .kg-toggle-content {
        margin-top: 0.8rem;
    }

    .kg-product-card-container {
        background: transparent;
        padding: 20px;
        width: 100%;
        border-radius: 5px;
        box-shadow: inset 0 0 0 1px rgb(124 139 154 / 25%);
    }

    .kg-product-card-description p {
        margin-top: 1.5em;
    }

    .kg-product-card-description ul {
        margin-left: 24px;
    }

    .kg-product-card-title {
        font-size: 1.9rem;
        font-weight: 700;
    }

    .kg-product-card-rating-star {
        height: 28px;
        width: 20px;
        margin-right: 2px;
    }

    .kg-product-card-rating-star svg {
    width: 16px;
    height: 16px;
    fill: currentColor;
    opacity: 0.15;
    }

    .kg-product-card-rating-active.kg-product-card-rating-star svg {
    opacity: 1;
    }

    .kg-nft-card-container {
        position: relative;
        display: flex;
        flex: auto;
        flex-direction: column;
        text-decoration: none;
        font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;
        font-size: 1.4rem;
        font-weight: 400;
        box-shadow: 0 2px 6px -2px rgb(0 0 0 / 10%), 0 0 1px rgb(0 0 0 / 40%);
        width: 100%;
        max-width: 512px;
        color: #15212A;
        background: #fff;
        border-radius: 5px;
        transition: none;
        margin: 0 auto;
    }

    .kg-nft-metadata {
        padding: 2.0rem;
    }

    .kg-nft-image-container {
        position: relative;
    }

    .kg-nft-image {
        display: flex;
        border-radius: 5px 5px 0 0;
    }

    .kg-nft-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 20px;
    }

    .kg-nft-header h4.kg-nft-title {
        font-size: 1.9rem;
        font-weight: 700;
        margin: 0;
        color: #15212A;
    }

    .kg-nft-header amp-img {
        max-width: 114px;
        max-height: 26px;
    }

    .kg-nft-opensea-logo {
        margin-top: 2px;
        width: 100px;
    }

    .kg-nft-creator {
        font-family: inherit;
        color: #95A1AD;
    }

    .kg-nft-creator span {
        font-weight: 500;
        color: #15212A;
    }

    .kg-nft-card p.kg-nft-description {
        font-size: 1.4rem;
        line-height: 1.4em;
        margin: 2.0rem 0 0;
        color: #222;
    }

    .kg-button-card {
        display: flex;
        position: static;
        align-items: center;
        width: 100%;
        justify-content: center;
    }

    .kg-btn {
        display: flex;
        position: static;
        align-items: center;
        padding: 0 2.0rem;
        height: 4.0rem;
        line-height: 4.0rem;
        font-size: 1.65rem;
        font-weight: 600;
        text-decoration: none;
        border-radius: 5px;
        transition: opacity 0.2s ease-in-out;
    }

    .kg-btn:hover {
        opacity: 0.85;
    }

    .kg-btn-accent {
        background-color: var(--ghost-accent-color, #1292EE);
        color: #fff;
    }

    .kg-callout-card {
        display: flex;
        padding: 20px 28px;
        border-radius: 3px;
    }

    .kg-callout-card-grey {
        background: rgba(124, 139, 154, 0.13);
    }

    .kg-callout-card-white {
        background: transparent;
        box-shadow: inset 0 0 0 1px rgba(124, 139, 154, 0.25);
    }

    .kg-callout-card-blue {
        background: rgba(33, 172, 232, 0.12);
    }

    .kg-callout-card-green {
        background: rgba(52, 183, 67, 0.12);
    }

    .kg-callout-card-yellow {
        background: rgba(240, 165, 15, 0.13);
    }

    .kg-callout-card-red {
        background: rgba(209, 46, 46, 0.11);
    }

    .kg-callout-card-pink {
        background: rgba(225, 71, 174, 0.11);
    }

    .kg-callout-card-purple {
        background: rgba(135, 85, 236, 0.12);
    }

    .kg-callout-card-accent {
        background: var(--ghost-accent-color);
        color: #fff;
    }

    .kg-callout-card-accent a {
        color: #fff;
    }

    .kg-callout-emoji {
        padding-right: 16px;
        line-height: 1.3;
        font-size: 1.25em;
    }

    .kg-header-card {
        padding: 6em 3em;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
    }

    .kg-header-card.kg-size-small {
        padding-top: 4em;
        padding-bottom: 4em;
    }

    .kg-header-card.kg-size-large {
        padding-top: 12em;
        padding-bottom: 12em;
    }

    .kg-header-card.kg-width-full {
        padding-left: 4em;
        padding-right: 4em;
    }

    .kg-header-card.kg-align-left {
        text-align: left;
        align-items: flex-start;
    }

    .kg-header-card.kg-style-dark {
        background: #15171a;
        color: #ffffff;
    }

    .kg-header-card.kg-style-light {
        color: #15171a;
        border: 1px solid rgba(124, 139, 154, 0.25);
        border-width: 1px 0;
    }

    .kg-header-card.kg-style-accent {
        background-color: var(--ghost-accent-color);
    }

    .kg-header-card.kg-style-image {
        background-color: #e7e7eb;
        background-size: cover;
        background-position: center center;
    }

    .kg-header-card h2 {
        font-size: 4em;
        font-weight: 700;
        line-height: 1.1em;
        margin: 0;
    }

    .kg-header-card h2 strong {
        font-weight: 800;
    }

    .kg-header-card.kg-size-small h2 {
        font-size: 3em;
    }

    .kg-header-card.kg-size-large h2 {
        font-size: 5em;
    }

    .kg-header-card h3 {
        font-size: 1.25em;
        font-weight: 500;
        line-height: 1.3em;
        margin: 0;
    }

    .kg-header-card h3 strong {
        font-weight: 600;
    }

    .kg-header-card.kg-size-small h3 {
        font-size: 1em;
    }

    .kg-header-card.kg-size-large h3 {
        font-size: 1.5em;
    }

    .kg-header-card:not(.kg-style-light) h2,
    .kg-header-card:not(.kg-style-light) h3 {
        color: #ffffff;
    }

    .kg-header-card a.kg-header-card-button {
        display: flex;
        position: static;
        align-items: center;
        padding: 0 1.2em;
        height: 2.4em;
        line-height: 1em;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
        font-size: 0.95em;
        font-weight: 600;
        text-decoration: none;
        border-radius: 5px;
        transition: opacity 0.2s ease-in-out;
        background-color: var(--ghost-accent-color);
        color: #ffffff;
        margin: 1.75em 0 0;
    }

    .kg-header-card a.kg-header-card-button:hover {
        opacity: 0.85;
    }

    .kg-header-card.kg-size-large a.kg-header-card-button {
        margin-top: 2em;
    }

    .kg-header-card.kg-size-small a.kg-header-card-button {
        margin-top: 1.5em;
    }

    .kg-header-card.kg-style-image a.kg-header-card-button,
    .kg-header-card.kg-style-dark a.kg-header-card-button {
        background: #ffffff;
        color: #15171a;
    }

    .kg-header-card.kg-style-accent a.kg-header-card-button {
        background: #ffffff;
        color: var(--ghost-accent-color);
    }

    .kg-audio-card {
        display: flex;
        width: 100%;
        box-shadow: inset 0 0 0 1px rgba(124, 139, 154, 0.25);
    }

    .kg-audio-thumbnail {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 80px;
        min-width: 80px;
        height: 80px;
        background: transparent;
        object-fit: cover;
        aspect-ratio: 1/1;
        border-radius: 3px 0 0 3px;
    }

    .kg-audio-thumbnail.placeholder {
        background: var(--ghost-accent-color);
    }

    .kg-audio-thumbnail.placeholder svg {
        width: 24px;
        height: 24px;
        fill: white;
    }

    .kg-audio-player-container {
        position: relative;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        width: 100%;
        --seek-before-width: 0%;
        --volume-before-width: 100%;
        --buffered-width: 0%;
    }

    .kg-audio-title {
        width: 100%;
        padding: 8px 12px 0;
        border: none;
        font-family: inherit;
        font-size: 1.1em;
        font-weight: 700;
        background: transparent;
    }

    .kg-audio-player {
        display: none;
    }

    .kg-width-full.kg-card-hascaption {
        display: grid;
        grid-template-columns: inherit;
    }

    .post-content table {
        border-collapse: collapse;
        width: 100%;
    }

    .post-content th {
        padding: 0.5em 0.8em;
        text-align: left;
        font-size: .75em;
        text-transform: uppercase;
    }

    .post-content td {
        padding: 0.4em 0.7em;
    }

    .post-content tbody tr:nth-child(2n + 1) {
        background-color: rgba(0,0,0,0.1);
        padding: 1px;
    }

    .post-content tbody tr:nth-child(2n + 2) td:last-child {
        box-shadow:
            inset 1px 0 rgba(0,0,0,0.1),
            inset -1px 0 rgba(0,0,0,0.1);
    }

    .post-content tbody tr:nth-child(2n + 2) td {
        box-shadow: inset 1px 0 rgba(0,0,0,0.1);
    }

    .post-content tbody tr:last-child {
        border-bottom: 1px solid rgba(0,0,0,.1);
    }

    .page-footer {
        padding: 60px 5vmin;
        margin: 60px auto 0;
        text-align: center;
        background-color: #f8f8f8;
    }

    .page-footer h3 {
        margin: 0.5rem 0 0 0;
    }

    .page-footer p {
        max-width: 500px;
        margin: 1rem auto 1.5rem;
        font-size: 1.7rem;
        line-height: 1.5em;
        color: rgba(0,0,0,0.6)
    }

    .powered {
        display: inline-flex;
        align-items: center;
        margin: 30px 0 0;
        padding: 6px 9px 6px 6px;
        border: rgba(0,0,0,0.1) 1px solid;
        font-size: 12px;
        line-height: 12px;
        letter-spacing: -0.2px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
        font-weight: 500;
        color: #222;
        text-decoration: none;
        background: #fff;
        border-radius: 6px;
    }

    .powered svg {
        height: 16px;
        width: 16px;
        margin: 0 6px 0 0;
    }

    @media (max-width: 600px) {
        body {
            font-size: 1.6rem;
        }
        h1 {
            font-size: 3rem;
        }

        h2 {
            font-size: 2.2rem;
        }
    }

    @media (max-width: 400px) {
        h1 {
            font-size: 2.6rem;
            line-height: 1.15em;
        }
        h2 {
            font-size: 2rem;
            line-height: 1.2em;
        }
        h3 {
            font-size: 1.7rem;
        }
    }

    :root {--ghost-accent-color: #15171A;}
    </style>

    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async src="https://cdn.ampproject.org/v0.js"></script>

    

</head>

<body class="amp-template">
    <header class="page-header">
        <a href="../../index.html">
                <amp-img class="site-icon" src="https://www.ruanx.net/content/images/2020/02/small-3.png" width="50" height="50" layout="fixed" alt="Pion1eer"></amp-img>
        </a>
    </header>

    <main class="content" role="main">
        <article class="post">

            <header class="post-header">
                <h1 class="post-title">AFLæºç é˜…è¯»ï¼ˆä¸€ï¼‰ï¼šå¯ç¨‹</h1>
                <section class="post-meta">
                    Ruan Xingzhi -
                    <time class="post-date" datetime="2023-05-07">07 May 2023</time>
                </section>
            </header>
            <figure class="post-image">
                <amp-img src="https://www.ruanx.net/content/images/2023/05/output-2.jpg" width="600" height="340" layout="responsive" 
                alt="AFLæºç é˜…è¯»ï¼ˆä¸€ï¼‰ï¼šå¯ç¨‹"
                ></amp-img>
            </figure>
            <section class="post-content">

                <p>ã€€ã€€ç¬”è€…æ˜å¹´å¹´åº•å°±è¯¥ç ”ç©¶ç”Ÿæ¯•ä¸šäº†ï¼Œç„¶è€Œæ¯•ä¸šè®ºæ–‡çš„é¢˜ç›®è¿˜æ²¡æœ‰ç€è½ã€‚ä¸€ç•ªè€ƒå¯Ÿä¹‹åï¼Œè®¤ä¸º fuzzing æ–¹å‘è¿˜ç®—æ˜¯æœ‰äº‹å¯åšï¼›äºæ˜¯æ‰“ç®—åœ¨ fuzzing é¢†åŸŸç ”ç©¶å¾—æ›´æ·±ä¸€äº›ã€‚</p><p>ã€€ã€€ä¼—æ‰€å‘¨çŸ¥ï¼ŒAFL ç³»çš„ fuzzer æœ‰å‡ ä¸ªç¼ºé™·ï¼š</p><ol><li>å‘ç°çš„ã€Œæœ‰ä»·å€¼çš„æ¼æ´ã€å¤ªå°‘ã€‚fuzzer æŒ‡å‡ºçš„å¤§é‡ bug éƒ½æ˜¯ã€Œæ— å…³ç´§è¦ã€çš„ï¼Œä¾‹å¦‚ç¼ºä¹éªŒè¯è€Œæ‰§è¡Œä¸€ä¸ª division by zeroï¼Œä»¤ç¨‹åºæ”¶åˆ° FPE å´©æºƒã€‚è¿™ç±»æ¼æ´è¦ä¹ˆæœ¬èº«å°±ç¼ºä¹ä»·å€¼ï¼Œè¦ä¹ˆå°±å¾ˆéš¾ä»¥åˆ©ç”¨ï¼Œä»¥è‡³äºéœ€è¦é€šè¿‡è®²æ•…äº‹çš„æ–¹å¼æ„é€ å‡ºä¸€ä¸ªåˆ©ç”¨åœºæ™¯ã€‚è€Œå¦ä¸€æ–¹é¢ï¼ŒAFL å¿½ç•¥äº†é€»è¾‘æ¼æ´ï¼Œå› ä¸ºåªæœ‰ crash æ‰ä¼šè¢«æŠ¥å‘Šã€‚</li><li>fuzzer çš„æœç´¢èƒ½åŠ›å¤ªå·®ã€‚ä¾‹å¦‚ï¼ŒAFL éš¾ä»¥æ„é€ å‡ºèƒ½é€šè¿‡ magic numberã€checksum æ£€æŸ¥çš„è¾“å…¥ï¼Œå®è·µä¸Šå¾€å¾€éœ€è¦ç ”ç©¶å‘˜æ‰‹åŠ¨æ³¨é‡Šæ‰è¿™äº›æ£€æŸ¥ã€‚</li></ol><p>ã€€ã€€å…³äºç¬¬ä¸€ä¸ªå›°éš¾ï¼Œç¬”è€…è®¤ä¸ºæš‚ä¸”æ²¡æœ‰å¾ˆå¥½çš„è§£å†³æ€è·¯ã€‚å½’æ ¹ç»“åº•ï¼Œä¸€ä¸ªæ¼æ´åˆ°åº•æœ‰æ²¡æœ‰ä»·å€¼ï¼Œéœ€è¦å¾ˆå¤šå¤–éƒ¨çŸ¥è¯†â€”â€”ä¾‹å¦‚ï¼Œå‡å¦‚æŸä¸ªè¾“å…¥èƒ½è®©ç¨‹åºé¢å¤–è¿è¡Œä¸€ç§’é’Ÿï¼Œè¿™å¯¹äº nginx æ¥è¯´æ˜¯å·¨å¤§é—®é¢˜ï¼›ä½†å¯¹äº checkpng ä¹‹ç±»çš„å°ç¨‹åºï¼Œä¾¿æ˜¯æ— å…³ç´§è¦çš„ã€‚ä¸€ä¸ªç¼“å†²åŒº over-read æ¼æ´ï¼Œå¯¹äº openssl æ˜¯è‡´å‘½çš„ï¼Œä½†å¯¹äº gimp è¿™ç±»ç¨‹åºè€Œè¨€ï¼Œåªæ˜¯å¤šäº†ä¸ªè®©ç¨‹åºå´©æºƒçš„ bugï¼Œå¤§å®¶å¹¶ä¸ç‰¹åˆ«å…³å¿ƒå…¶å®‰å…¨æ–¹é¢çš„å±é™©ã€‚ç”±äºä¸€ä¸ªæ¼æ´çš„ä»·å€¼éš¾ä»¥è¡¡é‡ï¼Œç¬”è€…å†³å®šä¸é’»ç ”è¿™ä¸ªé—®é¢˜ï¼Œä»ä»¥ crash æ•°é‡ä¸ºè¡¡é‡ fuzzer å¥½åçš„ç¬¬ä¸€æ ‡å‡†ã€‚</p><p>ã€€ã€€è€Œç¬¬äºŒä¸ªå›°éš¾ï¼Œä¾¿æ˜¯å¾ˆæœ‰å¯èƒ½åšå‡ºæ”¹è¿›çš„åœ°æ–¹ã€‚é¦–å…ˆï¼Œfuzzer ä¸å¯èƒ½æœå‡ºæ‰€æœ‰ bugâ€”â€”ä½¿ç”¨åè¯æ³•ï¼Œå‡è®¾å­˜åœ¨è¿™æ ·çš„ fuzzerï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±èƒ½è·å¾—ä¸€ä¸ªæ±‚è§£ä»»æ„çº¦æŸé—®é¢˜çš„ oracleã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬æä¾›ä¸‹é¢çš„ç¨‹åºï¼š</p><pre><code class="language-python">cin &gt;&gt; p;
if(N % p == 0)
    abort();</code></pre><p>ã€€ã€€å¦‚æœçœŸçš„å­˜åœ¨ä¸€ä¸ª fuzzer èƒ½æ‰¾åˆ°ç¨‹åºä¸­çš„æ‰€æœ‰æ¼æ´ï¼Œé‚£å®ƒå°±ä¸€å®šèƒ½æŠ¥å‘Šä¸€ä¸ª $p$ ä½¿å¾— $p \mid n$ï¼Œä»è€Œä»¤ç¨‹åº crashã€‚è¿™åƒæ˜¯å¤©æ–¹å¤œè°­ï¼Œç°é˜¶æ®µæˆ‘ä»¬ä¸å­˜åœ¨è¿™æ ·å¼ºå¤§çš„æ±‚è§£å™¨ã€‚</p><p>ã€€ã€€æ—¢ç„¶ä¸å­˜åœ¨å®Œç¾çš„æ±‚è§£å™¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯èƒ½ä¼šè€ƒè™‘è®© fuzzer æ‹¥æœ‰æ›´åŠ ç»†è‡´çš„æ±‚è§£èƒ½åŠ›ã€‚ä½†è¿™æ ·çš„èƒ½åŠ›å¾€å¾€ä¸ fuzz æ•ˆç‡æ˜¯è´Ÿç›¸å…³çš„ï¼šä»¥ç¬¦å·æ‰§è¡Œæ–¹æ³•å¯»æ‰¾ bugï¼Œå®é™…è¡¨ç°å¹¶ä¸æ¯” AFL æ›´å¥½ã€‚<strong>AFL çš„è®¾è®¡å“²å­¦ä¸­æœ‰è¿™æ ·ä¸€ä¸ªè§‚ç‚¹ï¼šå¦‚æœä¸€æ¡è·¯å¾„éœ€è¦å¾ˆè‰°éš¾åœ°è§¦å‘ï¼Œé‚£æˆ‘ä»¬å¯ä»¥è€ƒè™‘åŠ å¿« fuzz é€Ÿåº¦ï¼Œä»¥å°è¯•å¯»æ‰¾æ›´ç®€å•çš„è§¦å‘æ–¹æ³•ã€‚</strong>æ²¿ç€è¿™æ¡è®¾è®¡æ€è·¯ï¼ŒAFL ä¸¥æ ¼åœ°æ§åˆ¶æ¯æ¬¡ç¨‹åºæ‰§è¡Œçš„æ—¶é—´ã€‚</p><p>ã€€ã€€æ˜æ˜¾ï¼Œfuzzer éœ€è¦åœ¨æ‰§è¡Œé€Ÿåº¦ä¸æ±‚è§£èƒ½åŠ›ä¸Šä½œå‡ºæƒè¡¡ã€‚æœ‰ä¸€äº›æ–¹æ³•è¯•å›¾åœ¨ä¸å¤ªå½±å“æ€§èƒ½çš„æƒ…å†µä¸‹ï¼ŒåŠ å¼º AFL çš„æ±‚è§£èƒ½åŠ›ã€‚ä¾‹å¦‚ï¼Œ<a href="https://nesa.zju.edu.cn/download/lcy_pdf_ems_ndss22.pdf">EMS</a> æ–¹æ³•è®¤ä¸ºï¼Œä» fuzz ä¸€ä¸ªç¨‹åºçš„è¿‡ç¨‹ä¸­å­¦åˆ°çš„ç»éªŒï¼Œèƒ½å¸®åŠ©æˆ‘ä»¬ fuzz å…¶ä»–ç¨‹åºã€‚æ˜¾è€Œæ˜“è§ï¼Œæˆ‘ä»¬å¯¹ libpng è¿›è¡Œ fuzzï¼Œå¯ä»¥å­¦åˆ°å¾ˆå¤š PNG æ ¼å¼ç›¸å…³çš„ magic numberï¼›æ‹¿è¿™äº›çŸ¥è¯†å» fuzz imagemagickï¼Œå¾ˆå¯èƒ½æ˜¯æœ‰æ•ˆæœçš„ã€‚EMS å¹¶æœªå¼•å…¥çº¦æŸæ±‚è§£å™¨ï¼Œè€Œæ˜¯ä»å…¶ä»–ç¨‹åºæ ·æœ¬ä¸­å­¦ä¹ ã€Œ$A\to B$ã€è¿™æ ·çš„å˜å¼‚æ¨¡å¼ï¼Œåœ¨å®è§‚ä¸Šçœ‹ï¼Œç¡®å®æå‡äº† AFL çš„æœç´¢èƒ½åŠ›ã€‚</p><p>ã€€ã€€ç¬”è€…ä¹Ÿæ‰“ç®—ä»ã€Œæ‰§è¡Œé€Ÿåº¦ä¸æ±‚è§£èƒ½åŠ›çš„æƒè¡¡ã€è¿™æ–¹é¢ç€æ‰‹ï¼Œå»ä¼˜åŒ– AFLã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç¬”è€…å¸Œæœ›å¯»æ‰¾ä¸€äº›ä¸å¤ªå½±å“ fuzz æ‰§è¡Œé€Ÿåº¦çš„æ–¹æ³•ï¼Œå»ä¼˜åŒ– fuzzer çš„æœç´¢èƒ½åŠ›ã€‚è¿™æ ·ï¼ŒåŠ¿å¿…è¦å¯¹ AFL è¿›è¡Œä¸€äº›ä¿®æ”¹ï¼Œå› æ­¤ç¬”è€…å†³å®šé˜…è¯»ä¸€é AFL æºç ã€‚</p><p>ã€€ã€€å¦ç‡åœ°è®²ï¼Œè¿™æ˜¯ç¬”è€…ç¬¬ä¸€æ¬¡å…¨é¢é˜…è¯»ä¸­ç­‰è§„æ¨¡é¡¹ç›®çš„æºç ã€‚å› æ­¤æ“ä½œæµç¨‹ä¸Šä¸€å®šæœ‰ä¸è§„èŒƒçš„åœ°æ–¹ï¼Œæœ›è¯»è€…åœ¨è¯„è®ºåŒºæŒ‡æ­£ã€‚</p><h3 id="0x00-%E9%A1%B9%E7%9B%AE%E6%96%87%E4%BB%B6%E5%88%86%E6%9E%90">0x00 é¡¹ç›®æ–‡ä»¶åˆ†æ</h3><p>ã€€ã€€ç¬”è€…é€‰æ‹©é˜…è¯» AFL çš„æºç è€Œé AFL++ï¼Œå› ä¸º AFL++ å¼•å…¥äº†ä¸å°‘æ–°åŠŸèƒ½å’Œä¼˜åŒ–æŠ€æœ¯ï¼Œä»£ç åº”è¯¥æ¯” AFL æ›´åŠ ç¹æ‚ã€‚å¦å¤–ï¼Œç¬”è€…æ‰“ç®—åœ¨ AFL çš„åŸºç¡€ä¸Šè¿›è¡Œä¿®æ”¹ï¼Œå› æ­¤é€‰æ‹©åŸå§‹ AFL æ˜¯æœ€å¥½çš„ã€‚</p><p>ã€€ã€€AFL é¡¹ç›®çš„ä»“åº“æ˜¯ <a href="https://github.com/google/AFL">https://github.com/google/AFL</a>ï¼Œç°å·²åœæ­¢å¼€å‘ã€‚æ®é˜…è¯» Linux æºç çš„äººè¯´ï¼Œè¯»æºç å¯ä»¥å…ˆä»æœ€åˆå‡ ä¸ª commit ç€æ‰‹ï¼Œå› ä¸ºå½“æ—¶æ²¡æœ‰å¤ªå¤šå†—æ‚åŠŸèƒ½ï¼Œcore insight æ¯”è¾ƒçªå‡ºã€‚ä¸è¿‡ Github ä¸Šå¹¶æ²¡æœ‰ 2013 å¹´ç‰ˆæœ¬çš„ AFLï¼Œå› æ­¤ä½œç½¢ï¼Œç›´æ¥é˜…è¯»æœ€æ–°ç‰ˆä»£ç ã€‚</p><p>ã€€ã€€æŠŠé¡¹ç›®å¯¼å…¥ Understand æºç é˜…è¯»å™¨ï¼Œçœ‹ä¸€ä¸‹ Metrics Treemapï¼š</p><figure class="kg-card kg-image-card kg-width-wide"><amp-img src="https://www.ruanx.net/content/images/2023/05/image-1.png" class="kg-image" alt width="3267" height="1431" srcset="https://www.ruanx.net/content/images/size/w600/2023/05/image-1.png 600w, https://www.ruanx.net/content/images/size/w1000/2023/05/image-1.png 1000w, https://www.ruanx.net/content/images/size/w1600/2023/05/image-1.png 1600w, https://www.ruanx.net/content/images/size/w2400/2023/05/image-1.png 2400w" layout="responsive"></amp-img></figure><p>ã€€ã€€å¯è§ <code>afl-fuzz.c</code> æœ‰ 8000 ä½™è¡Œï¼Œæ˜¯æœ€å¤§çš„æºç æ–‡ä»¶ã€‚å…¶ä½™çš„ <code>afl-tim.c, afl-analyze.c, afl-showmap.c</code> ç­‰æ–‡ä»¶æœ‰ 1000 è¡Œå·¦å³ã€‚è§‚å¯Ÿä¸€ä¸‹ä»£ç ä¾èµ–å…³ç³»ï¼š</p><figure class="kg-card kg-image-card"><amp-img src="https://www.ruanx.net/content/images/2023/05/image-2.png" class="kg-image" alt width="1075" height="1040" srcset="https://www.ruanx.net/content/images/size/w600/2023/05/image-2.png 600w, https://www.ruanx.net/content/images/size/w1000/2023/05/image-2.png 1000w, https://www.ruanx.net/content/images/2023/05/image-2.png 1075w" layout="responsive"></amp-img></figure><p>ã€€ã€€æˆ‘ä»¬æ¥çœ‹è¿™ä¸ªé¡¹ç›®çš„ CI é…ç½®ï¼Œå³ <code>.travis.yml</code> æ–‡ä»¶ã€‚</p><pre><code class="language-yaml">language: c

env:
  - AFL_I_DONT_CARE_ABOUT_MISSING_CRASHES=1 AFL_NO_UI=1 AFL_STOP_MANUALLY=1
  - AFL_I_DONT_CARE_ABOUT_MISSING_CRASHES=1 AFL_NO_UI=1 AFL_EXIT_WHEN_DONE=1
 # TODO: test AFL_BENCH_UNTIL_CRASH once we have a target that crashes
  - AFL_I_DONT_CARE_ABOUT_MISSING_CRASHES=1 AFL_NO_UI=1 AFL_BENCH_JUST_ONE=1

before_install:
  - sudo apt update
  - sudo apt install -y libtool libtool-bin automake bison libglib2.0

# TODO: Look into splitting off some builds using a build matrix.
# TODO: Move this all into a bash script so we don't need to write bash in yaml.
script:
  - make
  - ./afl-gcc ./test-instr.c -o test-instr-gcc
  - mkdir seeds
  - echo "" &gt; seeds/nil_seed
  - if [ -z "$AFL_STOP_MANUALLY" ];
    then ./afl-fuzz -i seeds -o out/ -- ./test-instr-gcc;
    else timeout --preserve-status 5s ./afl-fuzz -i seeds -o out/ -- ./test-instr-gcc;
    fi
  - .travis/check_fuzzer_stats.sh -o out -k peak_rss_mb -v 1 -p 3
  - rm -r out/*
  - ./afl-clang ./test-instr.c -o test-instr-clang
  - if [ -z "$AFL_STOP_MANUALLY" ];
    then ./afl-fuzz -i seeds -o out/ -- ./test-instr-clang;
    else timeout --preserve-status 5s ./afl-fuzz -i seeds -o out/ -- ./test-instr-clang;
    fi
  - .travis/check_fuzzer_stats.sh -o out -k peak_rss_mb -v 1 -p 2
  - make clean
  - CC=clang CXX=clang++ make
  - cd llvm_mode
  # TODO: Build with different versions of clang/LLVM since LLVM passes don't
  # have a stable API.
  - CC=clang CXX=clang++ LLVM_CONFIG=llvm-config make
  - cd ..
  - rm -r out/*
  - ./afl-clang-fast ./test-instr.c -o test-instr-clang-fast
  - if [ -z "$AFL_STOP_MANUALLY" ];
    then ./afl-fuzz -i seeds -o out/ -- ./test-instr-clang-fast;
    else timeout --preserve-status 5s ./afl-fuzz -i seeds -o out/ -- ./test-instr-clang-fast;
    fi
  - .travis/check_fuzzer_stats.sh -o out -k peak_rss_mb -v 1 -p 3
  # Test fuzzing libFuzzer targets and trace-pc-guard instrumentation.
  - clang -g -fsanitize-coverage=trace-pc-guard ./test-libfuzzer-target.c -c
  - clang -c -w llvm_mode/afl-llvm-rt.o.c
  - wget https://raw.githubusercontent.com/llvm/llvm-project/main/compiler-rt/lib/fuzzer/afl/afl_driver.cpp
  - clang++ afl_driver.cpp afl-llvm-rt.o.o test-libfuzzer-target.o -o test-libfuzzer-target
  - timeout --preserve-status 5s ./afl-fuzz -i seeds -o out/ -- ./test-libfuzzer-target
  - cd qemu_mode
  - ./build_qemu_support.sh
  - cd ..
  - gcc ./test-instr.c -o test-no-instr
  - if [ -z "$AFL_STOP_MANUALLY" ];
    then ./afl-fuzz -Q -i seeds -o out/ -- ./test-no-instr;
    else timeout --preserve-status 5s ./afl-fuzz -Q -i seeds -o out/ -- ./test-no-instr;
    fi
  - .travis/check_fuzzer_stats.sh -o out -k peak_rss_mb -v 12 -p 9</code></pre><p>ã€€ã€€è¿™ä¸ª CI æµç¨‹æ˜¯å…ˆç¼–è¯‘ AFLï¼Œå†æ‰§è¡Œä¸€äº›æµ‹è¯•ã€‚æˆ‘ä»¬é€æ¡è§£é‡Šè¿™äº›è„šæœ¬ï¼š</p><pre><code class="language-bash"># ç¼–è¯‘ AFL
make

# ç”¨ afl-gcc ç¼–è¯‘é¶æ ‡ç¨‹åº
./afl-gcc ./test-instr.c -o test-instr-gcc

# å‡†å¤‡è¯­æ–™é›†
mkdir seeds
echo "" &gt; seeds/nil_seed

# æ‰§è¡Œä¸€æ¬¡æ—¶é•¿ 5s çš„ fuzz
if [ -z "$AFL_STOP_MANUALLY" ];
then ./afl-fuzz -i seeds -o out/ -- ./test-instr-gcc;
else timeout --preserve-status 5s ./afl-fuzz -i seeds -o out/ -- ./test-instr-gcc;
fi

# æ£€æŸ¥ fuzzer æ˜¯å¦æ­£ç¡®ç”Ÿæˆäº† fuzzer_stats æ–‡ä»¶ï¼ˆè¿™ä¸ªæ–‡ä»¶ä¿å­˜äº† fuzzer çš„å½“å‰çŠ¶æ€ï¼Œä»¥ä¾¿æ¢å¤ fuzzï¼‰
.travis/check_fuzzer_stats.sh -o out -k peak_rss_mb -v 1 -p 3

# æ¸…ç†
rm -r out/*

# ç”¨ afl-clang æ‰§è¡Œä¸€é fuzzï¼Œå¤§è‡´ä¸ afl-gcc çš„æµç¨‹ä¸€è‡´
./afl-clang ./test-instr.c -o test-instr-clang
if [ -z "$AFL_STOP_MANUALLY" ];
then ./afl-fuzz -i seeds -o out/ -- ./test-instr-clang;
else timeout --preserve-status 5s ./afl-fuzz -i seeds -o out/ -- ./test-instr-clang;
fi
.travis/check_fuzzer_stats.sh -o out -k peak_rss_mb -v 1 -p 2
make clean

# ç”¨ llvm_mode æ‰§è¡Œä¸€é fuzz
CC=clang CXX=clang++ make
cd llvm_mode
CC=clang CXX=clang++ LLVM_CONFIG=llvm-config make
cd ..
rm -r out/*
./afl-clang-fast ./test-instr.c -o test-instr-clang-fast
if [ -z "$AFL_STOP_MANUALLY" ];
then ./afl-fuzz -i seeds -o out/ -- ./test-instr-clang-fast;
else timeout --preserve-status 5s ./afl-fuzz -i seeds -o out/ -- ./test-instr-clang-fast;
fi
.travis/check_fuzzer_stats.sh -o out -k peak_rss_mb -v 1 -p 3

# æµ‹è¯•å¯¹ libFuzzer çš„å…¼å®¹æ€§
clang -g -fsanitize-coverage=trace-pc-guard ./test-libfuzzer-target.c -c
clang -c -w llvm_mode/afl-llvm-rt.o.c
wget https://raw.githubusercontent.com/llvm/llvm-project/main/compiler-rt/lib/fuzzer/afl/afl_driver.cpp
clang++ afl_driver.cpp afl-llvm-rt.o.o test-libfuzzer-target.o -o test-libfuzzer-target
timeout --preserve-status 5s ./afl-fuzz -i seeds -o out/ -- ./test-libfuzzer-target

# æµ‹è¯• qemu mode
cd qemu_mode
./build_qemu_support.sh
cd ..
gcc ./test-instr.c -o test-no-instr
if [ -z "$AFL_STOP_MANUALLY" ];
  then ./afl-fuzz -Q -i seeds -o out/ -- ./test-no-instr;
  else timeout --preserve-status 5s ./afl-fuzz -Q -i seeds -o out/ -- ./test-no-instr;
  fi
.travis/check_fuzzer_stats.sh -o out -k peak_rss_mb -v 12 -p 9</code></pre><h3 id="0x01-%E5%86%B3%E5%AE%9A%E9%98%85%E8%AF%BB%E9%A1%BA%E5%BA%8F">0x01 å†³å®šé˜…è¯»é¡ºåº</h3><p>ã€€ã€€AFL ä¸æ˜¯ä¸€ä¸ªç®€å•çš„ CRUD é¡¹ç›®ï¼Œå…¶å†…éƒ¨å……æ–¥ç€å„ç§ç²¾ç»†çš„ä¼˜åŒ–æ‰‹æ®µã€‚æˆ‘ä»¬ç°åœ¨éœ€è¦å¯»æ‰¾ä¸€ä¸ªåˆ‡å…¥ç‚¹ï¼Œå»é˜…è¯»é¡¹ç›®æºç ã€‚ç›´æ¥é˜…è¯» <code>afl-fuzz.c</code> ææ€•ä¼šé™·å…¥ã€Œçœ‹åˆ°ä¸€ä¸ªå‡½æ•° -&gt; å¯»æ‰¾å‡½æ•°å®šä¹‰ -&gt; çœ‹åˆ°é‡Œé¢è°ƒç”¨äº†å¦ä¸€ä¸ªå‡½æ•°â€¦â€¦ã€è¿™æ ·çš„å¾ªç¯ï¼Œå› æ­¤ç¬”è€…å‡†å¤‡å…ˆè¯»é¡¹ç›®çš„å…¶ä»–éƒ¨åˆ†ï¼Œç§¯æ”’ä¸€äº›ç†è§£ï¼Œç„¶åå†è¯» <code>afl-fuzz.c</code>ã€‚è¿™å°±å¦‚åŒåœ¨é˜…è¯»ä¸€ä¸ªå›¾ç‰‡å¤„ç†åº“çš„æ ¸å¿ƒæºç ä¹‹å‰ï¼Œå…ˆè¯»ä¸€ä¸ªè°ƒç”¨äº†è¿™ä¸ªåº“çš„å°ç¨‹åºçš„æºç ï¼Œç†Ÿæ‚‰å„ç§ API çš„ç”¨é€”ï¼Œä»è€Œè¯»æ ¸å¿ƒæºç çš„æ—¶å€™ä¹Ÿæ›´å®¹æ˜“ã€‚</p><p>ã€€ã€€æˆ‘ä»¬é˜…è¯»æºç çš„ä¸»è¦ç›®æ ‡åº”è¯¥æ˜¯ï¼š</p><ol><li>ç†æ¸…é™æ€æ’æ¡©è¿‡ç¨‹ï¼ˆgccã€clangã€llvm modeï¼‰</li><li>ç†æ¸… fuzz è¿‡ç¨‹ï¼šå¦‚ä½•å˜å¼‚ã€å¦‚ä½•å°† input ä¼ é€’ç»™ç¨‹åºã€å¦‚ä½•æ”¶é›†è¦†ç›–åº¦ä¿¡æ¯</li><li>ç†æ¸… qemu mode çš„æ’æ¡©å’Œæ‰§è¡Œè¿‡ç¨‹</li></ol><p>ã€€ã€€å› æ­¤ï¼Œæˆ‘ä»¬å†³å®šé˜…è¯»é¡ºåºï¼š</p><ol><li>é˜…è¯» <code>afl-gcc.c</code> å’Œ <code>afl-as.c</code>ï¼Œå³é™æ€æ’æ¡©ç›¸å…³ä»£ç </li><li>é˜…è¯» <code>afl-tmin.c</code> ï¼Œè¿™ä¸ªå·¥å…·çš„ç”¨é€”æ˜¯ã€Œå°†ä¸€ä¸ª input case ç¼©å°ï¼Œä½†ä¸åŸ input æ‹¥æœ‰ç›¸åŒçš„è¦†ç›–åº¦ã€ã€‚å®ƒä¼šå®Œæ•´åœ°æ¼”ç¤ºå¦‚ä½•æ”¶é›†ç¨‹åºçš„è¦†ç›–åº¦ä¿¡æ¯ï¼Œè€Œä¸æ¶‰åŠ <code>afl-fuzz.c</code> ä¸­çš„å…¶ä»–æµç¨‹ã€‚è¿™å°†ç»™æˆ‘ä»¬æä¾›ä¸€ä¸ªç»ä½³çš„åˆ‡é¢ï¼Œä»¥ç ”ç©¶ AFL æ”¶é›†è¦†ç›–åº¦çš„æ–¹æ³•</li><li>é˜…è¯» <code>afl-fuzz.c</code></li></ol><p>ã€€ã€€é‚£ä¹ˆï¼Œæˆ‘ä»¬ç°åœ¨ä» <code>afl-gcc.c</code> å¼€å§‹ã€‚</p><h3 id="0x02-afl-gcc-%E7%BC%96%E8%AF%91%E5%91%BD%E4%BB%A4%E7%94%9F%E6%88%90%E5%99%A8">0x02 afl-gcc ç¼–è¯‘å‘½ä»¤ç”Ÿæˆå™¨</h3><p>ã€€ã€€ç”±äºé˜…è¯»è¿‡ç¨‹ä¸­å°‘ä¸äº†åŠ¨æ€è°ƒè¯•ï¼Œæˆ‘ä»¬ç”¨ VS Code è¿œç¨‹è¿æ¥åˆ° Linux è™šæ‹Ÿæœºä¸Šã€‚å¯¼å…¥æºç ï¼Œå‘ç° clangd æ’ä»¶æ‰¾ä¸åˆ° <code>AFL_PATH</code> å¸¸é‡ã€‚</p><figure class="kg-card kg-image-card kg-card-hascaption"><amp-img src="https://www.ruanx.net/content/images/2023/05/image-3.png" class="kg-image" alt width="1827" height="718" srcset="https://www.ruanx.net/content/images/size/w600/2023/05/image-3.png 600w, https://www.ruanx.net/content/images/size/w1000/2023/05/image-3.png 1000w, https://www.ruanx.net/content/images/size/w1600/2023/05/image-3.png 1600w, https://www.ruanx.net/content/images/2023/05/image-3.png 1827w" layout="responsive"></amp-img><figcaption>â–² clangd æ‰¾ä¸åˆ° <code>AFL_PATH</code></figcaption></figure><p>ã€€ã€€çœ‹ä¸€çœ¼ Makefileï¼š</p><pre><code class="language-makefile">PREFIX     ?= /usr/local
BIN_PATH    = $(PREFIX)/bin
HELPER_PATH = $(PREFIX)/lib/afl
DOC_PATH    = $(PREFIX)/share/doc/afl
MISC_PATH   = $(PREFIX)/share/afl</code></pre><p>ã€€ã€€åŸæ¥è¿™äº›å¸¸é‡éƒ½æ˜¯ make æŒ‡å®šçš„ã€‚æ ¹æ®ä¸€ç¯‡ <a href="https://stackoverflow.com/questions/67887552/make-clangd-aware-of-macros-given-from-the-compiler">Stackoverflow</a> å›ç­”ï¼Œå‘ç° clangd å¯ä»¥ä» <code>compile_commands.json</code> ä¸­è·å–ç¼–è¯‘ flagï¼› æ ¹æ® <a href="https://clangd.llvm.org/installation#project-setup">clangd å®˜ç½‘</a>ï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å°±èƒ½ç”Ÿæˆè¿™ä¸ª jsonï¼š</p><pre><code class="language-bash">make clean
bear -- make</code></pre><p>ã€€ã€€å°è¯•ä¸€ä¸‹ä¹‹åï¼Œé—®é¢˜æœç„¶è§£å†³äº†ã€‚ä¸‹é¢æ¥çœ‹ä»£ç ã€‚</p><p></p><p>ã€€ã€€æ ¹æ®æ³¨é‡Šï¼Œ <code>afl-gcc</code> æ˜¯ <code>gcc, g++, clang, clang++</code> çš„åŒ…è£…å™¨ã€‚å®ƒçš„ä½œç”¨æ˜¯è®¾ç½®ä¸€äº›ç¼–è¯‘å‚æ•°ï¼Œç„¶åè°ƒç”¨è¿™äº›ç¼–è¯‘å™¨ã€‚äº‹å®ä¸Šï¼Œ<strong>ç¼–è¯‘å‡ºæ¥çš„ <code>afl-clang, afl-g++</code> ç­‰æ–‡ä»¶éƒ½æ˜¯æŒ‡å‘ <code>afl-gcc</code> çš„è½¯é“¾æ¥ã€‚</strong></p><p>ã€€ã€€<code>afl-gcc</code> éœ€è¦çŸ¥é“ <code>afl-as</code> çš„è·¯å¾„ã€‚<code>afl-as</code> æ˜¯æ’æ¡©å™¨ï¼Œæˆ‘ä»¬å°†ä¼šåœ¨åæ–‡åˆ†æå®ƒçš„é€»è¾‘ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œ <code>afl-as</code> ä½äº <code>/usr/local/lib/afl/</code> ï¼Œä¸è¿‡ä¹Ÿå¯ä»¥é€è¿‡ <code>AFL_PATH</code> æŒ‡å®šã€‚</p><div class="kg-card kg-callout-card kg-callout-card-grey"><div class="kg-callout-emoji">ğŸ““</div><div class="kg-callout-text"><strong>ä¸€äº›ç»†èŠ‚ï¼š</strong> <br />å¦‚æœ <code>AFL_HARDEN</code> æ‰“å¼€ï¼Œ <code>afl-gcc</code> ä¼šç»™ä¸‹æ¸¸ç¼–è¯‘å™¨ä¼ é€’ä¸€äº›å¼€å…³ï¼ˆ <code>-D_FORTIFY_SOURCE=2, -fstack-protector-all</code>ï¼‰ï¼Œä½¿å¾—å†…å­˜ bug æ›´å®¹æ˜“æš´éœ²å’Œå¤ç°ã€‚å¦‚æœ <code>AFL_USE_ASAN</code> æ‰“å¼€ï¼Œå°†ä¼šä½¿ç”¨ ASanã€‚<br /><br />å¦å¤–ï¼Œ <code>afl-gcc</code> å…è®¸ç”¨æˆ·ä½¿ç”¨éæ ‡å‡†çš„ä¸‹æ¸¸ç¼–è¯‘å™¨ï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼Œå¹¶é gcc æˆ– clangï¼‰ã€‚è®¾ç½® <code>AFL_CC</code> å’Œ <code>AFL_CXX</code> å³å¯ã€‚</div></div><p>ã€€ã€€ã€€å…ˆçœ‹ <code>main</code> å‡½æ•°ï¼š</p><pre><code class="language-c">/* Main entry point */

int main(int argc, char** argv) {

  // å¦‚æœä¸æ˜¯ QUIET æ¨¡å¼ï¼Œåˆ™è¾“å‡ºä½œè€…ä¿¡æ¯
  if (isatty(2) &amp;&amp; !getenv("AFL_QUIET")) {
    SAYF(cCYA "afl-cc " cBRI VERSION cRST " by &lt;lcamtuf@google.com&gt;\n");
  } else be_quiet = 1;

  // å¦‚æœä¸å¸¦å‚æ•°è°ƒç”¨ï¼Œåˆ™è¾“å‡ºå¸®åŠ©æ–‡æ¡£åé€€å‡º
  if (argc &lt; 2) {
    SAYF("\n"
         "This is a helper application for afl-fuzz. It serves as a drop-in replacement\n"
         "for gcc or clang, letting you recompile third-party code with the required\n"
         "runtime instrumentation. A common use pattern would be one of the following:\n\n"

         "  CC=%s/afl-gcc ./configure\n"
         "  CXX=%s/afl-g++ ./configure\n\n"

         "You can specify custom next-stage toolchain via AFL_CC, AFL_CXX, and AFL_AS.\n"
         "Setting AFL_HARDEN enables hardening optimizations in the compiled code.\n\n",
         BIN_PATH, BIN_PATH);

    exit(1);
  }

  // å¯»æ‰¾ afl-as
  find_as(argv[0]);

  // ä¿®æ”¹ç¼–è¯‘å‚æ•°
  edit_params(argc, argv);

  // æ‰§è¡Œä¸‹æ¸¸ç¼–è¯‘å™¨
  execvp(cc_params[0], (char**)cc_params);

  FATAL("Oops, failed to execute '%s' - check your PATH", cc_params[0]);

  return 0;

}</code></pre><p>ã€€ã€€é€»è¾‘å¾ˆæ¸…æ™°ï¼š<strong>å…ˆè°ƒç”¨ <code>find_as(argv[0])</code> å¯»æ‰¾ <code>afl-as</code> ï¼›ç„¶åä¿®æ”¹ç¼–è¯‘å™¨å‚æ•°ï¼Œå¹¶æ‰§è¡Œä¸‹æ¸¸ç¼–è¯‘å™¨ã€‚</strong>æˆ‘ä»¬æŒ‰é¡ºåºçœ‹ï¼Œå…ˆè§‚å¯Ÿè´Ÿè´£å¯»æ‰¾ <code>afl-as</code> çš„ <code>find_as</code> å‡½æ•°ï¼š</p><pre><code class="language-c">/* Try to find our "fake" GNU assembler in AFL_PATH or at the location derived
   from argv[0]. If that fails, abort. */

static void find_as(u8* argv0) {
  // ä»ç¯å¢ƒå˜é‡ä¸­è¯»å– $AFL_PATH
  u8 *afl_path = getenv("AFL_PATH");
  u8 *slash, *tmp;

  // å¦‚æœå­˜åœ¨ç¯å¢ƒå˜é‡ $AFL_PATHï¼Œä¸” $AFL_PATH/as å­˜åœ¨ï¼Œåˆ™æˆåŠŸæ‰¾åˆ°
  if (afl_path) {

    tmp = alloc_printf("%s/as", afl_path);

    if (!access(tmp, X_OK)) {
      as_path = afl_path;
      ck_free(tmp);
      return;
    }

    ck_free(tmp);

  }

  // äº argv[0] æ‰€åœ¨çš„ç›®å½•ä¸‹å¯»æ‰¾ afl-as
  slash = strrchr(argv0, '/');

  if (slash) {

    u8 *dir;

    *slash = 0;
    dir = ck_strdup(argv0);
    *slash = '/';

    tmp = alloc_printf("%s/afl-as", dir);

    if (!access(tmp, X_OK)) {
      as_path = dir;
      ck_free(tmp);
      return;
    }

    ck_free(tmp);
    ck_free(dir);

  }

  // fallbackï¼Œå¦‚æœå‰ä¸¤ä¸ªä½ç½®éƒ½æ‰¾ä¸åˆ°ï¼Œåˆ™å»ç¼–è¯‘ afl-gcc æ—¶å®šä¹‰çš„ AFL_PATH å»æ‰¾
  // é»˜è®¤æƒ…å†µä¸‹ï¼ŒAFL_PATH ç”± Makefile å®šä¹‰æˆ "/usr/local/lib/afl"
  if (!access(AFL_PATH "/as", X_OK)) {
    as_path = AFL_PATH;
    return;
  }

  FATAL("Unable to find AFL wrapper binary for 'as'. Please set AFL_PATH");
 
}</code></pre><p>ã€€ã€€æˆ‘ä»¬å¹³æ—¶ä¸€èˆ¬ä½¿ç”¨ <code>/work/afl/afl-gcc</code> æ¥è°ƒç”¨ <code>afl-gcc</code>ï¼Œæ‰€ä»¥æ­£å¸¸æƒ…å†µä¸‹ï¼Œä¼šæ‰¾åˆ° <code>/work/afl/afl-as</code> è¿™ä¸ªæ–‡ä»¶ã€‚</p><hr></hr><p>ã€€ã€€æ¥ä¸‹æ¥ï¼Œé˜…è¯» <code>edit_params</code> å‡½æ•°ï¼Œçœ‹çœ‹ä¸‹æ¸¸ç¼–è¯‘å™¨çš„å‚æ•°æ˜¯å¦‚ä½•ç”Ÿæˆçš„ã€‚</p><p>ã€€ã€€é¦–å…ˆï¼Œåˆ†æè‡ªå·±çš„ <code>argv[0]</code> ï¼Œç¡®å®šè‡ªå·±éœ€è¦è°ƒç”¨å“ªä¸ªä¸‹æ¸¸ç¼–è¯‘å™¨â€”â€”ä¾‹å¦‚ï¼Œå¦‚æœ <code>argv[0]</code> æ˜¯ <code>/work/afl/afl-clang++</code> ï¼Œåˆ™ä¸‹æ¸¸ç¼–è¯‘å™¨æ˜¯ <code>clang++</code> ã€‚å¦å¤–ï¼Œä¸Šæ–‡æåˆ°è¿‡ï¼ŒAFL å…è®¸ç”¨æˆ·è‡ªå·±æŒ‡å®šä¸‹æ¸¸ç¼–è¯‘å™¨ï¼Œå¦‚æœ <code>AFL_CC</code> å’Œ <code>AFL_CXX</code> å­˜åœ¨ï¼Œåˆ™ä¼šè¦†ç›–æ‰é»˜è®¤ç¼–è¯‘å™¨ã€‚</p><p>ã€€ã€€æ¥ä¸‹æ¥ï¼Œ<strong>å°†è‡ªå·±çš„ <code>argv[]</code> å¤åˆ¶ä¸€ä»½ï¼Œç¨åå°†ä¼šåŸæ ·ä¼ é€’ç»™ä¸‹æ¸¸ç¼–è¯‘å™¨ã€‚</strong>ç”±äºè¿™ä¸€æ­¥éª¤çš„å­˜åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ <code>afl-gcc</code> ä»£æ›¿åŸæœ‰çš„ <code>gcc</code> æŒ‡ä»¤ã€‚</p><ul><li><code>-integrated-as</code> å’Œ <code>-pipe</code> å¼€å…³ä¼šè¢«å¿½ç•¥ã€‚</li><li><code>-B</code> å‚æ•°ä¼šè¢«è¦†ç›–ä¸º <code>as_path</code> ã€‚æ ¹æ® gcc æ–‡æ¡£ï¼šThis option specifies where to find the executables, libraries, include files, and data files <strong>of the compiler itself</strong>.</li><li>å¦‚æœæ˜¯ clang æ¨¡å¼ï¼Œåˆ™æ‰“å¼€ <code>-no-integrated-as</code> å¼€å…³ã€‚</li><li>å¦‚æœ <code>AFL_HARDEN</code> æ‰“å¼€ï¼Œåˆ™è®¾ç½® <code>-fstack-protector-all</code> å’Œ <code>-D_FORTIFY_SOURCE=2</code> ã€‚</li><li>è‹¥ä¼ å…¥çš„ç¼–è¯‘å‚æ•°ä¸­æœ¬æ¥å°±æœ‰ <code>-fsanitize=address</code> æˆ– <code>-fsanitize=memory</code>ï¼Œåˆ™è®¾ç½®ç¯å¢ƒå˜é‡ <code>AFL_USE_ASAN</code> ä¸º 1ï¼›<br />å¦åˆ™æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š <br />- å¦‚æœ <code>AFL_USE_ASAN</code> æ‰“å¼€ï¼Œåˆ™è®¾ç½® <code>-U_FORTIFY_SOURCE</code> å’Œ <code>-fsanitize=address</code><br />- å¦‚æœ <code>AFL_USE_MSAN</code> æ‰“å¼€ï¼Œåˆ™è®¾ç½® <code>-U_FORTIFY_SOURCE</code> å’Œ <code>-fsanitize=memory</code></li></ul><p>ã€€ã€€é»˜è®¤æƒ…å†µä¸‹ï¼ˆæœªè®¾ç½® <code>AFL_DONT_OPTIMIZE</code> ç¯å¢ƒå˜é‡ï¼‰ï¼Œä¼šåŠ å…¥ä»¥ä¸‹ä¼˜åŒ–å¼€å…³ï¼š</p><pre><code class="language-plaintext">-g -O3 -funroll-loops -D__AFL_COMPILER=1 -DFUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION=1</code></pre><p>ã€€ã€€å¦‚æœ <code>AFL_NO_BUILTIN</code> ç¯å¢ƒå˜é‡è¢«æ‰“å¼€ï¼Œåˆ™åŠ å…¥ä»¥ä¸‹å¼€å…³ï¼š</p><figure class="kg-card kg-code-card"><pre><code class="language-plaintext">-fno-builtin-strcmp
-fno-builtin-strncmp
-fno-builtin-strcasecmp
-fno-builtin-strncasecmp
-fno-builtin-memcmp
-fno-builtin-strstr
-fno-builtin-strcasestr</code></pre><figcaption>â–² å…³äºè¿™äº› no-builtin å¼€å…³çš„ç”¨é€”ï¼Œè¯¦è§ <a href="https://stackoverflow.com/questions/54281780/what-exactly-is-fno-builtin-doing-here">Stackoverflow è®¨è®º</a>Â </figcaption></figure><p>ã€€ã€€ä»¥ä¸Šå°±æ˜¯ <code>edit_params</code> çš„å…¨æµç¨‹ã€‚æ³¨æ„åˆ°ï¼Œ<strong>æœ€å…³é”®çš„ä¸€æ­¥æ˜¯åŠ å…¥äº† <code>-B as_path</code> è¿™ä¸ª flagï¼Œä½¿å¾—ä¸‹æ¸¸ç¼–è¯‘å™¨åœ¨æ±‡ç¼–è¿‡ç¨‹ä¸­ï¼Œä»¥ <code>afl-as</code> æ›¿æ¢äº†åŸç”Ÿçš„æ±‡ç¼–å™¨ã€‚</strong>è€Œå…·ä½“çš„æ’æ¡©è¿‡ç¨‹ï¼Œåˆ™æ˜¯ <code>afl-as</code> è´Ÿè´£å®ç°ã€‚æˆ‘ä»¬åœ¨ä¸‹ä¸€ç« èŠ‚å»é˜…è¯» <code>afl-as</code> çš„æºç ã€‚</p><p>ã€€ã€€æœ¬èŠ‚é˜…è¯»çš„ <code>edit_params</code> å‡½æ•°æºç å¦‚ä¸‹ï¼š</p><pre><code class="language-c">/* Copy argv to cc_params, making the necessary edits. */

static void edit_params(u32 argc, char** argv) {
  u8 fortify_set = 0, asan_set = 0;
  u8 *name;

#if defined(__FreeBSD__) &amp;&amp; defined(__x86_64__)
  u8 m32_set = 0;
#endif

  // ç¡®å®šä½¿ç”¨å“ªä¸ªä¸‹æ¸¸ç¼–è¯‘å™¨
  cc_params = ck_alloc((argc + 128) * sizeof(u8*));

  name = strrchr(argv[0], '/');
  if (!name) name = argv[0]; else name++;

  if (!strncmp(name, "afl-clang", 9)) {

    clang_mode = 1;

    setenv(CLANG_ENV_VAR, "1", 1);

    if (!strcmp(name, "afl-clang++")) {
      u8* alt_cxx = getenv("AFL_CXX");
      cc_params[0] = alt_cxx ? alt_cxx : (u8*)"clang++";
    } else {
      u8* alt_cc = getenv("AFL_CC");
      cc_params[0] = alt_cc ? alt_cc : (u8*)"clang";
    }

  } else {

    /* With GCJ and Eclipse installed, you can actually compile Java! The
       instrumentation will work (amazingly). Alas, unhandled exceptions do
       not call abort(), so afl-fuzz would need to be modified to equate
       non-zero exit codes with crash conditions when working with Java
       binaries. Meh. */

#ifdef __APPLE__

    if (!strcmp(name, "afl-g++")) cc_params[0] = getenv("AFL_CXX");
    else if (!strcmp(name, "afl-gcj")) cc_params[0] = getenv("AFL_GCJ");
    else cc_params[0] = getenv("AFL_CC");

    if (!cc_params[0]) {

      SAYF("\n" cLRD "[-] " cRST
           "On Apple systems, 'gcc' is usually just a wrapper for clang. Please use the\n"
           "    'afl-clang' utility instead of 'afl-gcc'. If you really have GCC installed,\n"
           "    set AFL_CC or AFL_CXX to specify the correct path to that compiler.\n");

      FATAL("AFL_CC or AFL_CXX required on MacOS X");

    }

#else

    if (!strcmp(name, "afl-g++")) {
      u8* alt_cxx = getenv("AFL_CXX");
      cc_params[0] = alt_cxx ? alt_cxx : (u8*)"g++";
    } else if (!strcmp(name, "afl-gcj")) {
      u8* alt_cc = getenv("AFL_GCJ");
      cc_params[0] = alt_cc ? alt_cc : (u8*)"gcj";
    } else {
      u8* alt_cc = getenv("AFL_CC");
      cc_params[0] = alt_cc ? alt_cc : (u8*)"gcc";
    }

#endif /* __APPLE__ */

  }


  // å¤åˆ¶è‡ªå·±çš„ argv
  while (--argc) {
    u8* cur = *(++argv);

    if (!strncmp(cur, "-B", 2)) {

      if (!be_quiet) WARNF("-B is already set, overriding");

      if (!cur[2] &amp;&amp; argc &gt; 1) { argc--; argv++; }
      continue;

    }

    if (!strcmp(cur, "-integrated-as")) continue;

    if (!strcmp(cur, "-pipe")) continue;

#if defined(__FreeBSD__) &amp;&amp; defined(__x86_64__)
    if (!strcmp(cur, "-m32")) m32_set = 1;
#endif

    if (!strcmp(cur, "-fsanitize=address") ||
        !strcmp(cur, "-fsanitize=memory")) asan_set = 1;

    if (strstr(cur, "FORTIFY_SOURCE")) fortify_set = 1;

    cc_params[cc_par_cnt++] = cur;

  }

  cc_params[cc_par_cnt++] = "-B";
  cc_params[cc_par_cnt++] = as_path;

  if (clang_mode)
    cc_params[cc_par_cnt++] = "-no-integrated-as";

  if (getenv("AFL_HARDEN")) {

    cc_params[cc_par_cnt++] = "-fstack-protector-all";

    if (!fortify_set)
      cc_params[cc_par_cnt++] = "-D_FORTIFY_SOURCE=2";

  }

  // è‹¥ä¼ å…¥çš„ç¼–è¯‘å‚æ•°ä¸­æœ¬æ¥å°±æ‰“å¼€äº† ASan æˆ– MSanï¼Œåˆ™è¿™é‡ŒæŠŠ $AFL_USE_ASAN ä¹Ÿæ‰“å¼€
  if (asan_set) {

    /* Pass this on to afl-as to adjust map density. */

    setenv("AFL_USE_ASAN", "1", 1);

  } else if (getenv("AFL_USE_ASAN")) {

    if (getenv("AFL_USE_MSAN"))
      FATAL("ASAN and MSAN are mutually exclusive");

    if (getenv("AFL_HARDEN"))
      FATAL("ASAN and AFL_HARDEN are mutually exclusive");

    cc_params[cc_par_cnt++] = "-U_FORTIFY_SOURCE";
    cc_params[cc_par_cnt++] = "-fsanitize=address";

  } else if (getenv("AFL_USE_MSAN")) {

    if (getenv("AFL_USE_ASAN"))
      FATAL("ASAN and MSAN are mutually exclusive");

    if (getenv("AFL_HARDEN"))
      FATAL("MSAN and AFL_HARDEN are mutually exclusive");

    cc_params[cc_par_cnt++] = "-U_FORTIFY_SOURCE";
    cc_params[cc_par_cnt++] = "-fsanitize=memory";


  }

  if (!getenv("AFL_DONT_OPTIMIZE")) {

#if defined(__FreeBSD__) &amp;&amp; defined(__x86_64__)

    /* On 64-bit FreeBSD systems, clang -g -m32 is broken, but -m32 itself
       works OK. This has nothing to do with us, but let's avoid triggering
       that bug. */

    if (!clang_mode || !m32_set)
      cc_params[cc_par_cnt++] = "-g";

#else

      cc_params[cc_par_cnt++] = "-g";

#endif

    cc_params[cc_par_cnt++] = "-O3";
    cc_params[cc_par_cnt++] = "-funroll-loops";

    /* Two indicators that you're building for fuzzing; one of them is
       AFL-specific, the other is shared with libfuzzer. */

    cc_params[cc_par_cnt++] = "-D__AFL_COMPILER=1";
    cc_params[cc_par_cnt++] = "-DFUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION=1";

  }

  if (getenv("AFL_NO_BUILTIN")) {

    cc_params[cc_par_cnt++] = "-fno-builtin-strcmp";
    cc_params[cc_par_cnt++] = "-fno-builtin-strncmp";
    cc_params[cc_par_cnt++] = "-fno-builtin-strcasecmp";
    cc_params[cc_par_cnt++] = "-fno-builtin-strncasecmp";
    cc_params[cc_par_cnt++] = "-fno-builtin-memcmp";
    cc_params[cc_par_cnt++] = "-fno-builtin-strstr";
    cc_params[cc_par_cnt++] = "-fno-builtin-strcasestr";

  }

  cc_params[cc_par_cnt] = NULL;

}</code></pre><h3 id="0x03-afl-as-%E9%9D%99%E6%80%81%E6%8F%92%E6%A1%A9%E5%99%A8">0x03 afl-as é™æ€æ’æ¡©å™¨</h3><p>ã€€ã€€<code>afl-as</code> æ˜¯åŸç”Ÿ GNU as çš„ wrapperã€‚æˆ‘ä»¬å…ˆé˜…è¯» <code>main</code> å‡½æ•°ï¼š</p><pre><code class="language-c">/* Main entry point */

int main(int argc, char** argv) {

  s32 pid;
  u32 rand_seed;
  int status;
  u8* inst_ratio_str = getenv("AFL_INST_RATIO");

  struct timeval tv;
  struct timezone tz;

  clang_mode = !!getenv(CLANG_ENV_VAR);

  if (isatty(2) &amp;&amp; !getenv("AFL_QUIET")) {

    SAYF(cCYA "afl-as " cBRI VERSION cRST " by &lt;lcamtuf@google.com&gt;\n");
 
  } else be_quiet = 1;

  if (argc &lt; 2) {

    SAYF("\n"
         "This is a helper application for afl-fuzz. It is a wrapper around GNU 'as',\n"
         "executed by the toolchain whenever using afl-gcc or afl-clang. You probably\n"
         "don't want to run this program directly.\n\n"

         "Rarely, when dealing with extremely complex projects, it may be advisable to\n"
         "set AFL_INST_RATIO to a value less than 100 in order to reduce the odds of\n"
         "instrumenting every discovered branch.\n\n");

    exit(1);

  }

  gettimeofday(&amp;tv, &amp;tz);

  rand_seed = tv.tv_sec ^ tv.tv_usec ^ getpid();

  srandom(rand_seed);

  edit_params(argc, argv);

  if (inst_ratio_str) {

    if (sscanf(inst_ratio_str, "%u", &amp;inst_ratio) != 1 || inst_ratio &gt; 100) 
      FATAL("Bad value of AFL_INST_RATIO (must be between 0 and 100)");

  }

  if (getenv(AS_LOOP_ENV_VAR))
    FATAL("Endless loop when calling 'as' (remove '.' from your PATH)");

  setenv(AS_LOOP_ENV_VAR, "1", 1);

  /* When compiling with ASAN, we don't have a particularly elegant way to skip
     ASAN-specific branches. But we can probabilistically compensate for
     that... */

  if (getenv("AFL_USE_ASAN") || getenv("AFL_USE_MSAN")) {
    sanitizer = 1;
    inst_ratio /= 3;
  }

  if (!just_version) add_instrumentation();

  if (!(pid = fork())) {

    execvp(as_params[0], (char**)as_params);
    FATAL("Oops, failed to execute '%s' - check your PATH", as_params[0]);

  }

  if (pid &lt; 0) PFATAL("fork() failed");

  if (waitpid(pid, &amp;status, 0) &lt;= 0) PFATAL("waitpid() failed");

  if (!getenv("AFL_KEEP_ASSEMBLY")) unlink(modified_file);

  exit(WEXITSTATUS(status));

}</code></pre><p>ã€€ã€€å¯è§å·¥ä½œæµç¨‹æ˜¯ï¼š</p><ol><li>åˆå§‹åŒ–éšæœºæ•°ç§å­</li><li>åœ¨æ±‡ç¼–æŒ‡ä»¤åºåˆ—ä¸Šæ’æ¡© Â </li><li>ä¿®æ”¹ as å‚æ•°</li><li>è°ƒç”¨ as ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¹¶æ¸…ç†ç°åœº</li></ol><p>ã€€ã€€å…ˆæ¥çœ‹ <code>afl-as</code> æ˜¯å¦‚ä½•è¯»å–å¹¶ä¿®æ”¹ as å‚æ•°çš„ã€‚æºç ä¸­æœ‰å¾ˆå¤šå¯¹åº” MacOS çš„å†…å®¹ï¼Œæˆ‘ä»¬åªå…³æ³¨ Linux x86ï¼Œæ•…åˆ å»è¿™äº›æ®µè½ã€‚ç²¾ç®€åçš„ä»£ç å¦‚ä¸‹ï¼š</p><pre><code class="language-c">/* Examine and modify parameters to pass to 'as'. Note that the file name
   is always the last parameter passed by GCC, so we exploit this property
   to keep the code simple. */

static void edit_params(int argc, char** argv) {

  u8 *tmp_dir = getenv("TMPDIR"), *afl_as = getenv("AFL_AS");
  u32 i;

  /* Although this is not documented, GCC also uses TEMP and TMP when TMPDIR
     is not set. We need to check these non-standard variables to properly
     handle the pass_thru logic later on. */

  if (!tmp_dir) tmp_dir = getenv("TEMP");
  if (!tmp_dir) tmp_dir = getenv("TMP");
  if (!tmp_dir) tmp_dir = "/tmp";

  as_params = ck_alloc((argc + 32) * sizeof(u8*));

  as_params[0] = afl_as ? afl_as : (u8*)"as";

  as_params[argc] = 0;

  for (i = 1; i &lt; argc - 1; i++) {

    if (!strcmp(argv[i], "--64")) use_64bit = 1;
    else if (!strcmp(argv[i], "--32")) use_64bit = 0;

    as_params[as_par_cnt++] = argv[i];

  }

  input_file = argv[argc - 1];

  if (input_file[0] == '-') {

    if (!strcmp(input_file + 1, "-version")) {
      just_version = 1;
      modified_file = input_file;
      goto wrap_things_up;
    }

    if (input_file[1]) FATAL("Incorrect use (not called through afl-gcc?)");
    else input_file = NULL;

  } else {

    /* Check if this looks like a standard invocation as a part of an attempt
       to compile a program, rather than using gcc on an ad-hoc .s file in
       a format we may not understand. This works around an issue compiling
       NSS. */

    if (strncmp(input_file, tmp_dir, strlen(tmp_dir)) &amp;&amp;
        strncmp(input_file, "/var/tmp/", 9) &amp;&amp;
        strncmp(input_file, "/tmp/", 5)) pass_thru = 1;

  }

  modified_file = alloc_printf("%s/.afl-%u-%u.s", tmp_dir, getpid(),
                               (u32)time(NULL));

wrap_things_up:

  as_params[as_par_cnt++] = modified_file;
  as_params[as_par_cnt]   = NULL;

}</code></pre><p>ã€€ã€€å¯è§ï¼Œè¿™ä¸ªè¿‡ç¨‹å¾ˆç±»ä¼¼äº <code>afl-gcc</code> ä¿®æ”¹å‚æ•°çš„é€»è¾‘ï¼š</p><ol><li>é¦–å…ˆç¡®å®š as ç¨‹åºçš„åå­—ï¼Œé»˜è®¤å°±æ˜¯ GNU asï¼Œä½†ç”¨æˆ·ä¹Ÿå¯ä»¥æä¾› <code>AFL_AS</code> æ¥è¦†ç›–</li><li>è®¾ç½®ä¸´æ—¶æ–‡ä»¶ <code>modified_file</code> è·¯å¾„ä¸º <code>/tmp/.afl-pid-timestamp.s</code></li><li>å°†è‡ªå·±ç¨‹åºçš„ <code>argv</code> åŸæ ·å¤åˆ¶ç»™ <code>as</code> </li></ol><p>ã€€ã€€é‚£ä¹ˆï¼Œæ•´ä¸ª <code>afl-as</code> ç¨‹åºçš„é€»è¾‘å°±æ˜¯ï¼šè¯»å…¥åŸæ¥çš„æ±‡ç¼–ä»£ç ï¼Œç”Ÿæˆä¸€ä¸ªæ’äº†æ¡©çš„æ–°æ±‡ç¼–ä»£ç ï¼ˆå­˜æ”¾åœ¨ä¸´æ—¶ç›®å½•ï¼‰ï¼Œè°ƒç”¨ GNU as æ¥å°†æ–°æ±‡ç¼–ä»£ç è½¬åŒ–æˆæœºå™¨ç ã€‚</p><p>ã€€ã€€æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é˜…è¯»æ’æ¡©è¿‡ç¨‹çš„æ ¸å¿ƒéƒ¨åˆ†ã€‚</p><hr></hr><p>ã€€ã€€<code>add_instrumentation</code> æ˜¯ä¸€ä¸ª 200 å¤šè¡Œçš„å‡½æ•°ï¼Œå…¶ä¸­é€»è¾‘æ¯”è¾ƒå¤æ‚ã€‚æˆ‘ä»¬ä¸å¦¨å…ˆå®é™…æ‰§è¡Œä¸€é as è¿‡ç¨‹ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•æ’æ¡©çš„ã€‚</p><p>ã€€ã€€ç¼–å†™ä¸€æ®µç®€å•çš„ä»£ç ï¼š</p><pre><code class="language-c">#include &lt;stdio.h&gt;

void work() {
    for(int i=1; i&lt;=10; i++) {
        printf("Hello, world %d\n", i);
    }
}

int main(void) {
    work();
    return 0;
}</code></pre><p>ã€€ã€€ç¼–è¯‘ã€æ’æ¡©ï¼š</p><figure class="kg-card kg-code-card"><pre><code class="language-bash">AFL_DONT_OPTIMIZE=1 ../afl-gcc target.c -o target -O0 -fno-asynchronous-unwind-tables</code></pre><figcaption>â–² ä½¿ç”¨ <code>-fno-asynchronous-unwind-tables</code> ä»¥å»é™¤ .cfi æŒ‡ä»¤ã€‚è§ <a href="https://stackoverflow.com/questions/2529185/what-are-cfi-directives-in-gnu-assembler-gas-used-for">Stackoverflow</a>Â </figcaption></figure><p>ã€€ã€€æˆ‘ä»¬ä¿®æ”¹äº† <code>afl-as</code> çš„æºç ï¼Œè®©å®ƒå°†æ’æ¡©å‰ã€æ’æ¡©åçš„æ±‡ç¼–ä»£ç éƒ½ä¿ç•™åˆ°æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚æ’æ¡©å‰çš„æ±‡ç¼–ä»£ç ä¸ºï¼š </p><pre><code class="language-c">	.file	"target.c"
	.text
	.section	.rodata
.LC0:
	.string	"Hello, world %d\n"
	.text
	.globl	work
	.type	work, @function
work:
	pushq	%rbp
	movq	%rsp, %rbp
	subq	$16, %rsp
	movl	$1, -4(%rbp)
	jmp	.L2
.L3:
	movl	-4(%rbp), %eax
	movl	%eax, %esi
	leaq	.LC0(%rip), %rax
	movq	%rax, %rdi
	movl	$0, %eax
	call	printf@PLT
	addl	$1, -4(%rbp)
.L2:
	cmpl	$10, -4(%rbp)
	jle	.L3
	nop
	nop
	leave
	ret
	.size	work, .-work
	.globl	main
	.type	main, @function
main:
	pushq	%rbp
	movq	%rsp, %rbp
	movl	$0, %eax
	call	work
	movl	$0, %eax
	popq	%rbp
	ret
	.size	main, .-main
	.ident	"GCC: (Debian 12.2.0-14) 12.2.0"
	.section	.note.GNU-stack,"",@progbits
</code></pre><p>ã€€ã€€æ’æ¡©åçš„ä»£ç ä¸ºï¼š</p><pre><code class="language-c">	.file	"target.c"
	.text
	.section	.rodata
.LC0:
	.string	"Hello, world %d\n"
	.text
	.globl	work
	.type	work, @function
work:

/* --- AFL TRAMPOLINE (64-BIT) --- */

.align 4

leaq -(128+24)(%rsp), %rsp
movq %rdx,  0(%rsp)
movq %rcx,  8(%rsp)
movq %rax, 16(%rsp)
movq $0x00000af3, %rcx
call __afl_maybe_log
movq 16(%rsp), %rax
movq  8(%rsp), %rcx
movq  0(%rsp), %rdx
leaq (128+24)(%rsp), %rsp

/* --- END --- */

	pushq	%rbp
	movq	%rsp, %rbp
	subq	$16, %rsp
	movl	$1, -4(%rbp)
	jmp	.L2
.L3:

/* --- AFL TRAMPOLINE (64-BIT) --- */

.align 4

leaq -(128+24)(%rsp), %rsp
movq %rdx,  0(%rsp)
movq %rcx,  8(%rsp)
movq %rax, 16(%rsp)
movq $0x00003d9b, %rcx
call __afl_maybe_log
movq 16(%rsp), %rax
movq  8(%rsp), %rcx
movq  0(%rsp), %rdx
leaq (128+24)(%rsp), %rsp

/* --- END --- */

	movl	-4(%rbp), %eax
	movl	%eax, %esi
	leaq	.LC0(%rip), %rax
	movq	%rax, %rdi
	movl	$0, %eax
	call	printf@PLT
	addl	$1, -4(%rbp)
.L2:

/* --- AFL TRAMPOLINE (64-BIT) --- */

.align 4

leaq -(128+24)(%rsp), %rsp
movq %rdx,  0(%rsp)
movq %rcx,  8(%rsp)
movq %rax, 16(%rsp)
movq $0x0000d5a5, %rcx
call __afl_maybe_log
movq 16(%rsp), %rax
movq  8(%rsp), %rcx
movq  0(%rsp), %rdx
leaq (128+24)(%rsp), %rsp

/* --- END --- */

	cmpl	$10, -4(%rbp)
	jle	.L3

/* --- AFL TRAMPOLINE (64-BIT) --- */

.align 4

leaq -(128+24)(%rsp), %rsp
movq %rdx,  0(%rsp)
movq %rcx,  8(%rsp)
movq %rax, 16(%rsp)
movq $0x000078e0, %rcx
call __afl_maybe_log
movq 16(%rsp), %rax
movq  8(%rsp), %rcx
movq  0(%rsp), %rdx
leaq (128+24)(%rsp), %rsp

/* --- END --- */

	nop
	nop
	leave
	ret
	.size	work, .-work
	.globl	main
	.type	main, @function
main:

/* --- AFL TRAMPOLINE (64-BIT) --- */

.align 4

leaq -(128+24)(%rsp), %rsp
movq %rdx,  0(%rsp)
movq %rcx,  8(%rsp)
movq %rax, 16(%rsp)
movq $0x0000c35b, %rcx
call __afl_maybe_log
movq 16(%rsp), %rax
movq  8(%rsp), %rcx
movq  0(%rsp), %rdx
leaq (128+24)(%rsp), %rsp

/* --- END --- */

	pushq	%rbp
	movq	%rsp, %rbp
	movl	$0, %eax
	call	work
	movl	$0, %eax
	popq	%rbp
	ret
	.size	main, .-main
	.ident	"GCC: (Debian 12.2.0-14) 12.2.0"
	.section	.note.GNU-stack,"",@progbits

/* --- AFL MAIN PAYLOAD (64-BIT) --- */
/* æ­¤å¤„çœç•¥ 300 ä½™è¡Œ */</code></pre><p>ã€€ã€€å¯è§ï¼Œåœ¨æ¯ä¸€ä¸ªåŸºæœ¬å—å…¥å£å¤„ï¼Œafl-as æ’å…¥äº†ä¸€æ®µä»£ç ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œåœ¨æ•´ä¸ªç¨‹åºçš„æœ«å°¾ï¼Œæ’å…¥äº†ä¸€æ®µ 300 å¤šè¡Œçš„ AFL main payloadã€‚æš‚ä¸”å…ˆä¸ç®¡ AFL main payloadï¼Œæˆ‘ä»¬å…ˆåˆ†æåœ¨æ¯ä¸ª branch å¼€å§‹çš„ä½ç½®æ’å…¥çš„ä»£ç ï¼Œè¿™ç±»ä»£ç å½¢å¦‚ï¼š</p><pre><code class="language-c">/* --- AFL TRAMPOLINE (64-BIT) --- */
.align 4

leaq -(128+24)(%rsp), %rsp
movq %rdx,  0(%rsp)
movq %rcx,  8(%rsp)
movq %rax, 16(%rsp)
movq $0x000078e0, %rcx
call __afl_maybe_log
movq 16(%rsp), %rax
movq  8(%rsp), %rcx
movq  0(%rsp), %rdx
leaq (128+24)(%rsp), %rsp
/* --- END --- */</code></pre><p>ã€€ã€€<a href="https://github.com/google/AFL/blob/master/docs/technical_details.txt">AFL ç™½çš®ä¹¦</a>ä¸­è¯´ï¼Œä¸Šè¿°ä»£ç æœ¬è´¨ä¸Šå®ç°äº†å¦‚ä¸‹é€»è¾‘ï¼š</p><pre><code class="language-c">cur_location = &lt;COMPILE_TIME_RANDOM&gt;;
shared_mem[cur_location ^ prev_location]++; 
prev_location = cur_location &gt;&gt; 1;</code></pre><p>ã€€ã€€è¿™é‡Œæœ‰ä¸€ç‚¹å€¼å¾—æ³¨æ„ï¼šä¸ºä»€ä¹ˆéœ€è¦æŠŠ <code>cur_location</code> å³ç§»ä¸€ä½å†èµ‹å€¼ç»™ <code>prev_location</code> ï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ã€‚è®¾ä¸¤ä¸ªå…¥å£ç‚¹çš„éšæœºå€¼åˆ†åˆ«ä¸º $A, B$ï¼Œå‡è®¾ä¸å­˜åœ¨è¿™ä¸ªå³ç§»ï¼Œé‚£ä¹ˆç”±äºå¼‚æˆ–è¿ç®—çš„äº¤æ¢å¾‹ï¼Œ$A\to B$ å’Œ $B \to A$ éƒ½ä¼šä½¿å¾— <code>mem[A ^ B]++</code>ï¼Œè¿™æ ·å°±ä¸¢å¤±äº†æ–¹å‘ä¿¡æ¯ã€‚è€Œ AFL ä¸­å­˜åœ¨è¿™ä¸ªå³ç§»ï¼Œä½¿å¾— $A\to B$ å®é™…ä¸Šå¼•å‘çš„æ˜¯ <code>mem[(A&gt;&gt;1)^B]++</code> ï¼Œè€Œ $B\to A$ å¼•å‘ <code>mem[(B&gt;&gt;1)^A]++</code> ï¼Œå·§å¦™åœ°åŒºåˆ†å¼€äº†è¿™ä¸¤ç§ä¸åŒæ–¹å‘ã€‚</p><p>ã€€ã€€ç°åœ¨æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹è¿™æ®µæ±‡ç¼–ï¼Œçœ‹å®ƒæ˜¯å¦‚ä½•å®ç°ä¸Šè¿°ä¼ªä»£ç é€»è¾‘çš„ã€‚</p><ol><li>å°† <code>rsp</code> ä¸‹é™ä¸€æ®µè·ç¦»</li><li>å°† <code>rdx, rcx, rax</code> çš„å€¼å­˜æ”¾åˆ°æ ˆä¸Š</li><li>å°† <code>rcx</code> è®¾ä¸ºä¸€ä¸ªç«‹å³æ•°ï¼ˆç”± afl-as éšæœºç”Ÿæˆï¼‰</li><li>è°ƒç”¨ <code>__afl_maybe_log</code></li><li>æ¢å¤ <code>rdx, rcx, rax</code> å’Œ <code>rsp</code> </li></ol><p>ã€€ã€€è¿™å·²ç»è§£é‡Šäº† <code>cur_location</code> çš„æ¥å†ã€‚å®ƒæ˜¯éšæœºç”Ÿæˆçš„ï¼Œç°åœ¨å­˜æ”¾åœ¨ <code>rcx</code> å¯„å­˜å™¨ä¸­ã€‚æ¥ä¸‹æ¥è°ƒç”¨ <code>__afl_maybe_log</code> ï¼Œå¯ä»¥çŒœæµ‹ï¼Œå®ƒè¦å®ç°ã€Œ<code>mem</code> è‡ªå¢ã€å’Œã€Œä¿å­˜ <code>prev_location</code>ã€ä¸¤é¡¹ä»»åŠ¡ã€‚</p><p>ã€€ã€€è·Ÿè¿› <code>__afl_maybe_log</code> çœ‹çœ‹ï¼š</p><pre><code class="language-c">__afl_maybe_log:

  lahf
  seto  %al

  /* Check if SHM region is already mapped. */

  movq  __afl_area_ptr(%rip), %rdx
  testq %rdx, %rdx
  je    __afl_setup

__afl_store:

  /* Calculate and store hit for the code location specified in rcx. */

  xorq __afl_prev_loc(%rip), %rcx
  xorq %rcx, __afl_prev_loc(%rip)
  shrq $1, __afl_prev_loc(%rip)

  incb (%rdx, %rcx, 1)

__afl_return:

  addb $127, %al
  sahf
  ret</code></pre><p>ã€€ã€€é¦–å…ˆè§£é‡Šä¸€ä¸‹ <code>lahf</code> å’Œ <code>seto Â %al</code> è¿™ä¸¤è¡Œä»£ç çš„æ„æ€ã€‚å®ƒä»¬æ˜¯è´Ÿè´£å­˜å‚¨ eflags å¯„å­˜å™¨çš„å€¼â€”â€”å°†ä½ 8 ä½ä¿å­˜åœ¨ <code>ah</code>ï¼Œå°† OF ä½ä¿å­˜åœ¨ <code>al</code>ï¼Œå¹¶åœ¨æ¡©ä»£ç é€€å‡ºæ—¶æ‰§è¡Œ <code>addb $127, %al</code> å’Œ <code>sahf</code> æ¢å¤ç°åœºï¼Œ<strong>ä½¿å¾—æ•´ä¸ªæ¡©ä»£ç å¯¹åŸç¨‹åºé€æ˜</strong>ã€‚</p><p>ã€€ã€€<code>__afl_maybe_log</code> å…ˆæ£€æŸ¥å…±äº«å†…å­˜åŒºåŸŸæ˜¯å¦å·²ç»æ˜ å°„ã€‚å¦‚æœè¿˜æœªæ˜ å°„ï¼Œåˆ™è·³è½¬åˆ° <code>__afl_setup</code> è¿›è¡Œåˆå§‹åŒ–ï¼›å¦åˆ™ç»§ç»­æ‰§è¡Œ <code>__afl_store</code> é€»è¾‘ï¼Œ<code>rdx</code> å¯„å­˜å™¨æŒ‡å‘å…±äº«å†…å­˜åŒºå—ã€‚</p><p>ã€€ã€€<code>__afl_store</code> æ‰§è¡Œè¿‡ç¨‹ä¸ºï¼š</p><ol><li>å°†ç›®å‰å­˜å‚¨ç€ <code>cur_loc</code> çš„ <code>rcx</code> å¯„å­˜å™¨å¼‚æˆ–ä¸Š <code>prev_loc</code> </li><li>å°† <code>prev_loc</code> è®¾ä¸º <code>cur_loc</code> ï¼ˆè¿™é‡Œåˆ©ç”¨äº†å¼‚æˆ–è¿ç®—çš„è‡ªåæ€§ï¼‰</li><li>å°† <code>prev_loc</code> å³ç§»ä¸€ä½</li><li>å¢åŠ  hit count</li></ol><p>ã€€ã€€è¿™äº›è¿‡ç¨‹æ‰§è¡Œå®Œåï¼Œæ¢å¤ eflags å¹¶è¿”å›ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å¼„æ¸…äº†æ’å…¥åˆ°åŸºæœ¬å—èµ·å§‹å¤„çš„æ¡©ä»£ç çš„é€»è¾‘ã€‚è‡³äº <code>AFL MAIN PAYLOAD</code> é‚£ä¸€æ®µå‡ ç™¾è¡Œçš„æ±‡ç¼–ï¼Œä¸ fork server æœ‰å…³ï¼Œæˆ‘ä»¬ä¸‹ä¸€ç¯‡æ–‡ç« å†ç ”ç©¶ã€‚</p><p>ã€€ã€€åœ¨ç ”ç©¶æ˜ç™½ <code>afl-as</code> çš„è¡Œä¸ºä¹‹åï¼Œå›å¤´å†çœ‹ <code>add_instrumentation</code> å‡½æ•°ã€‚å¯ä»¥å‘ç°å®ƒæ˜¯ä¸€ä¸ª parserï¼Œæ¯æ¬¡æ‰«æå¹¶åŸæ ·è¾“å‡ºä¸€è¡Œæ±‡ç¼–ç ï¼Œå¦‚æœå‘ç°è¿™ä¸ªåœ°æ–¹è¦æ’æ¡©ï¼Œåˆ™æŠŠæ¡©ä»£ç æ’è¿›å»ã€‚è‡³äºå…·ä½“çš„æ¡©ä»£ç ï¼Œå®ƒä»¬å®šä¹‰åœ¨ <code>afl-as.h</code> ä¸­ï¼Œæœ‰ 32 ä½ã€64 ä½ä¸¤ä¸ªç‰ˆæœ¬ã€‚æˆ‘ä»¬ä¸Šæ–‡å·²ç»è¯¦ç»†è§£é‡Šäº† 64 ä½ç‰ˆæœ¬ã€‚</p><p>ã€€ã€€åœ¨æ‰«æå®Œæˆä¹‹åï¼Œäºæ–‡ä»¶æœ«å°¾å†™å…¥ main payloadã€‚å®ƒä¹Ÿæ˜¯æœ‰ 32 ä½å’Œ 64 ä½ç‰ˆæœ¬ã€‚</p><p>ã€€ã€€ä»¥ä¸Šï¼Œæˆ‘ä»¬ç†è§£äº†æ’æ¡©è¿‡ç¨‹æ˜¯å¦‚ä½•è¿›è¡Œçš„ã€‚è€Œ <code>add_instrumentation</code> å‡½æ•°ä¹‹å®ç°ç»†èŠ‚ï¼Œæ­£å¦‚æˆ‘ä»¬æ‰€ç†Ÿæ‚‰çš„å„ç§è¯æ³•åˆ†æå™¨ä¸€æ ·ï¼Œå†™å¾—å¾ˆçç¢ï¼šå¤§éƒ¨åˆ†ä»£ç æ˜¯åœ¨åˆ†ç±»è®¨è®ºå„ç§ tokenï¼ˆLinux çš„ã€MacOS çš„ã€OpenBSD çš„ï¼‰ï¼Œæ²¡æœ‰ä»”ç»†ç ”è¯»çš„å¿…è¦ã€‚</p><hr></hr><p>ã€€ã€€åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬é˜…è¯»äº† <code>afl-gcc</code> å’Œ <code>afl-as</code> çš„æºç ï¼Œåˆæ­¥äº†è§£äº† AFL ç¼–è¯‘å’Œæ’æ¡©è¿‡ç¨‹ã€‚æœ¬æ–‡åªåˆ†æäº†æ’å…¥åˆ°åŸºæœ¬å—å…¥å£çš„æ¡©ä»£ç ï¼Œå¹¶æœªè¯¦ç»†è§£é‡Šæ’å…¥åˆ°æ•´ä¸ªæ±‡ç¼–ä»£ç æ–‡ä»¶æœ«å°¾çš„ main payloadã€‚è¿™éƒ¨åˆ†å†…å®¹ç•™åˆ°ä¸‹ä¸€ç¯‡æ–‡ç« ã€‚</p><p></p>

            </section>

        </article>
    </main>
    <footer class="page-footer">
            <amp-img class="site-icon" src="https://www.ruanx.net/content/images/2020/02/small-3.png" width="50" height="50" layout="fixed" alt="Pion1eer"></amp-img>
        <h3>Pion1eer</h3>
            <p>Stand with Ukraine ğŸ’™ğŸ’›</p>
        <p><a href="../../index.html">Read more posts â†’</a></p>
        <a class="powered" href="https://ghost.org" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 156 156"><g fill="none" fill-rule="evenodd"><rect fill="#15212B" width="156" height="156" rx="27"/><g transform="translate(36 36)" fill="#F6F8FA"><path d="M0 71.007A4.004 4.004 0 014 67h26a4 4 0 014 4.007v8.986A4.004 4.004 0 0130 84H4a4 4 0 01-4-4.007v-8.986zM50 71.007A4.004 4.004 0 0154 67h26a4 4 0 014 4.007v8.986A4.004 4.004 0 0180 84H54a4 4 0 01-4-4.007v-8.986z"/><rect y="34" width="84" height="17" rx="4"/><path d="M0 4.007A4.007 4.007 0 014.007 0h41.986A4.003 4.003 0 0150 4.007v8.986A4.007 4.007 0 0145.993 17H4.007A4.003 4.003 0 010 12.993V4.007z"/><rect x="67" width="17" height="17" rx="4"/></g></g></svg> Published with Ghost</a>
    </footer>
    
</body>
</html>
