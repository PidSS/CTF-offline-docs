<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>用74LS595控制8个LED</title>
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" type="text/css" href="../assets/built/screen%EF%B9%96v=792c672b3c.css" />

    <meta name="description" content="这个月开始学习嵌入式开发，写了一个用 74LS595 芯片控制 8 位 LED 的程序。主要功能是把串行传输的输入转换为并行输出。" />
    <link rel="icon" href="../content/images/size/w256h256/2020/02/small-3.png" type="image/png" />
    <link rel="canonical" href="index.html" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    <link rel="amphtml" href="amp/index.html" />
    
    <meta property="og:site_name" content="Pion1eer" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="用74LS595控制8个LED" />
    <meta property="og:description" content="这个月开始学习嵌入式开发，写了一个用 74LS595 芯片控制 8 位 LED 的程序。主要功能是把串行传输的输入转换为并行输出。" />
    <meta property="og:url" content="https://www.ruanx.net/control-leds-by-74ls595/" />
    <meta property="og:image" content="https://www.ruanx.net/content/images/2022/01/--.jpg" />
    <meta property="article:published_time" content="2021-05-26T05:25:19.000Z" />
    <meta property="article:modified_time" content="2021-05-26T07:23:44.000Z" />
    <meta property="article:tag" content="embedded" />
    <meta property="article:tag" content="stm32" />
    
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="用74LS595控制8个LED" />
    <meta name="twitter:description" content="这个月开始学习嵌入式开发，写了一个用 74LS595 芯片控制 8 位 LED 的程序。主要功能是把串行传输的输入转换为并行输出。" />
    <meta name="twitter:url" content="https://www.ruanx.net/control-leds-by-74ls595/" />
    <meta name="twitter:image" content="https://www.ruanx.net/content/images/2022/01/--.jpg" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Ruan Xingzhi" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="embedded, stm32" />
    <meta property="og:image:width" content="2000" />
    <meta property="og:image:height" content="1250" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Pion1eer",
        "url": "https://www.ruanx.net/",
        "logo": {
            "@type": "ImageObject",
            "url": "https://www.ruanx.net/content/images/size/w256h256/2020/02/small-3.png",
            "width": 60,
            "height": 60
        }
    },
    "author": {
        "@type": "Person",
        "name": "Ruan Xingzhi",
        "image": {
            "@type": "ImageObject",
            "url": "https://www.ruanx.net/content/images/2020/05/blue.jpeg",
            "width": 1024,
            "height": 1024
        },
        "url": "https://www.ruanx.net/author/blue/",
        "sameAs": []
    },
    "headline": "用74LS595控制8个LED",
    "url": "https://www.ruanx.net/control-leds-by-74ls595/",
    "datePublished": "2021-05-26T05:25:19.000Z",
    "dateModified": "2021-05-26T07:23:44.000Z",
    "keywords": "embedded, stm32",
    "description": "这个月开始学习嵌入式开发，写了一个用 74LS595 芯片控制 8 位 LED 的程序。主要功能是把串行传输的输入转换为并行输出。",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://www.ruanx.net/"
    }
}
    </script>

    <meta name="generator" content="Ghost 5.8" />
    <link rel="alternate" type="application/rss+xml" title="Pion1eer" href="../rss/index.rss" />
    <script defer src="https://cdn.jsdelivr.net/npm/@tryghost/portal@~2.5/umd/portal.min.js" data-ghost="https://www.ruanx.net/" data-key="595acd8f13c14d79a10527399d" data-api="https://www.ruanx.net/ghost/api/content/" crossorigin="anonymous"></script><style id="gh-members-styles">.gh-post-upgrade-cta-content,
.gh-post-upgrade-cta {
    display: flex;
    flex-direction: column;
    align-items: center;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    text-align: center;
    width: 100%;
    color: #ffffff;
    font-size: 16px;
}

.gh-post-upgrade-cta-content {
    border-radius: 8px;
    padding: 40px 4vw;
}

.gh-post-upgrade-cta h2 {
    color: #ffffff;
    font-size: 28px;
    letter-spacing: -0.2px;
    margin: 0;
    padding: 0;
}

.gh-post-upgrade-cta p {
    margin: 20px 0 0;
    padding: 0;
}

.gh-post-upgrade-cta small {
    font-size: 16px;
    letter-spacing: -0.2px;
}

.gh-post-upgrade-cta a {
    color: #ffffff;
    cursor: pointer;
    font-weight: 500;
    box-shadow: none;
    text-decoration: underline;
}

.gh-post-upgrade-cta a:hover {
    color: #ffffff;
    opacity: 0.8;
    box-shadow: none;
    text-decoration: underline;
}

.gh-post-upgrade-cta a.gh-btn {
    display: block;
    background: #ffffff;
    text-decoration: none;
    margin: 28px 0 0;
    padding: 8px 18px;
    border-radius: 4px;
    font-size: 16px;
    font-weight: 600;
}

.gh-post-upgrade-cta a.gh-btn:hover {
    opacity: 0.92;
}</style>
    <script defer src="https://cdn.jsdelivr.net/npm/@tryghost/sodo-search@~1.1/umd/sodo-search.min.js" data-key="595acd8f13c14d79a10527399d" data-styles="https://cdn.jsdelivr.net/npm/@tryghost/sodo-search@~1.1/umd/main.css" data-sodo-search="https://www.ruanx.net/" crossorigin="anonymous"></script>
    <script defer src="../public/cards.min%EF%B9%96v=792c672b3c.js"></script>
    <link rel="stylesheet" type="text/css" href="../public/cards.min%EF%B9%96v=792c672b3c.css">
    <!-- link href="https://fonts.googleapis.com/css?family=Noto+Serif+SC&display=swap" rel="stylesheet" -->

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fira+Mono&amp;family=Noto+Serif+SC&amp;display=swap" rel="stylesheet">

<style>.post-content,.post-card-excerpt{font-family: 'Noto Serif SC', "PingFang SC","Helvetica Neue",Helvetica,"Hiragino Sans GB","Microsoft YaHei","微软雅黑",Arial,sans-serif;}
    .post-full-content{font-size: 100%;}
    .post-full-custom-excerpt {font-size: 1.8rem;}
    .post-full-title {font-size:3.2rem;}
    .post-full-content blockquote{margin:20px;padding: 1em;  background-color: #3eb0ef14; }
    .post-full-content blockquote p {font-style:normal;}
    .post-full-image {display:none;}
    
    /* .post-full-content figcaption {margin: .4em 0 .5em  !important} */
    
    .kg-callout-card {width: 100%; margin-bottom: 1em;}
    
    .post-full-content figure {margin: 0.8em 0 1em;}
    
    p {margin: 0.2em 0 0.5em !important;}
    
    .post-full-content img{border-radius:5px;}
    
    code {font-family: 'Noto Serif SC';}
</style>


<style>:root {--ghost-accent-color: #15171A;}</style>

</head>
<body class="post-template tag-embedded tag-stm32">

    <div class="site-wrapper">

        

<header class="site-header">
    <div class="outer site-nav-main">
    <div class="inner">
        <nav class="site-nav">
    <div class="site-nav-left-wrapper">
        <div class="site-nav-left">
                <a class="site-nav-logo" href="../index.html">Pion1eer</a>
            <div class="site-nav-content">
                    <ul class="nav">
    <li class="nav-home"><a href="../index.html">Home</a></li>
    <li class="nav-about"><a href="../about/index.html">About</a></li>
</ul>

                    <span class="nav-post-title dash">用74LS595控制8个LED</span>
            </div>
        </div>
    </div>
    <div class="site-nav-right">
            <div class="social-links">
            </div>
                <a class="rss-button" href="https://feedly.com/i/subscription/feed/https://www.ruanx.net/rss/" title="RSS" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="6.18" cy="17.82" r="2.18"/><path d="M4 4.44v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/></svg>
</a>

    </div>
</nav>
    </div>
</div>

<script>
 MathJax = {
        tex:{
                inlineMath: [['$', '$'], ['\\(', '\\)']]
            },
        svg:{
                fontCache: 'global'
            }
        }; 
    </script>
    <script src="https://cdn.staticfile.org/babel-polyfill/7.12.1/polyfill.min.js?features=es6"></script>
    <script type="text/javascript" id="MathJax-script" async  src="https://cdn.staticfile.org/mathjax/3.2.2/es5/tex-mml-chtml.js"></script>

<style>@media (prefers-color-scheme: light) {
		.post-full-content  
    pre{background:#fafafa;margin:10px 10px 20px 10px;border-style: solid;border-color:#DCDFE6;}
}
</style>

<link rel="stylesheet" href="https://cdn.ruanx.net/css/atom-one-dark.css">
<link rel="stylesheet" media="(prefers-color-scheme: light)" href="https://cdn.ruanx.net/css/atom-one-light.min.css">
<style>.post-full-content  code{font-family: 'Fira Mono', 'Jetbrains mono', 'ubuntu mono', consolas, 'monospace' !important;}
</style>

</header>


<main id="site-main" class="site-main outer">
    <div class="inner">

        <article class="post-full post tag-embedded tag-stm32 no-image no-image">

            <header class="post-full-header">

                <section class="post-full-tags">
                    <a href="../tag/embedded/index.html">embedded</a>
                </section>

                <h1 class="post-full-title">用74LS595控制8个LED</h1>

                <p class="post-full-custom-excerpt">这个月开始学习嵌入式开发，写了一个用 74LS595 芯片控制 8 位 LED 的程序。主要功能是把串行传输的输入转换为并行输出。</p>

                <div class="post-full-byline">

                    <section class="post-full-byline-content">

                        <ul class="author-list">
                            <li class="author-list-item">

                                <div class="author-card">
                                    <img class="author-profile-image" src="../content/images/size/w100/2020/05/blue.jpeg" alt="Ruan Xingzhi" />
                                    <div class="author-info">
                                        <div class="bio">
                                            <h2>Ruan Xingzhi</h2>
                                            <p>Welcome to my site and hope you have fun.</p>
                                            <p><a href="../author/blue/index.html">More posts</a> by Ruan Xingzhi.</p>
                                        </div>
                                    </div>
                                </div>

                                <a href="../author/blue/index.html" class="author-avatar">
                                    <img class="author-profile-image" src="../content/images/size/w100/2020/05/blue.jpeg" alt="Ruan Xingzhi" />
                                </a>

                            </li>
                        </ul>

                        <section class="post-full-byline-meta">
                            <h4 class="author-name"><a href="../author/blue/index.html">Ruan Xingzhi</a></h4>
                            <div class="byline-meta-content">
                                <time class="byline-meta-date" datetime="2021-05-26">26 May 2021</time>
                                <span class="byline-reading-time"><span class="bull">&bull;</span> 10 min read</span>
                            </div>
                        </section>

                    </section>


                </div>
            </header>


            <section class="post-full-content">
                <div class="post-content">
                    <p>　　本月刚开始的时候，由于学校里教的东西实在是无聊，在找一些新的事情做；@t123yh 劝我学习单片机，从此便入了单片机的坑。我先买了个 arduino Uno R3 官方开发板，以及一些 esp8266、esp32 的板子，在上面用 arduino 和 micropython 写了些程序。但 arduino 是一个 toy model，接口抽象程度非常高，方便了新手的学习，但不可避免地掩盖了底层的功能；micropython 亦然。采用 arduino 很难组织稍微大一点的项目，迫使我考虑其他开发板和开发环境。</p><p>　　esp32 有官方 C++ SDK，叫 esp-idf，搭建起来本身就是个麻烦事。我在 windows 下始终不得要领，于是切换到 debian 上装 esp-idf。装上之后用 VS Code 写代码确实顺利，不过很缺乏 IDE 的支持。加之 esp32 虽然是个好模块，但库和框架都少，对我这种新人的学习可能不利，后来我又买了点 stm32 的板子，用 Jetbrains 的 CLion 开发程序，终于觉得很方便了。今天把途中遇到的坑写一下。</p><h3 id="0x01-%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE">0x01 环境配置</h3><p>　　这个开发环境还是很容易配的，Linux 下就不说了，win10 可以采用 choco 这个程序把 OpenOCD 和 gcc-arm-embedded 装上。但有一个大坑：choco 虽然可以通过软件包 <code>mingw-w64</code> 装上 gcc/g++，但没有带 gdb！我也不知道软件源维护者的脑子里进了什么东西，总之评论区全是吐槽：</p><figure class="kg-card kg-image-card"><img src="../content/images/2021/05/image.png" class="kg-image" alt loading="lazy" width="2000" height="911" srcset="../content/images/size/w600/2021/05/image.png 600w, ../content/images/size/w1000/2021/05/image.png 1000w, ../content/images/size/w1600/2021/05/image.png 1600w, ../content/images/size/w2400/2021/05/image.png 2400w" sizes="(min-width: 720px) 720px"></figure><p>　　最后我用 mingw 官方的程序装上了 gcc 全家桶。gcc 版本很旧，只有 6.x（与之对比，mingw-w64 的版本是 8.x），但够我用来开发单片机了。总之折腾一下午之后终于配好了环境。</p><p>　　顺便说一句为什么不用官方的 STM32CubeIDE。我买了几块 stm32 的板子，其中只有一块 F3 Discovery 板子是官方版，自带 ST-LINK V2；另外几块板子是需要外部 ST-LINK 的。我在淘宝买了个寨版 ST-LINK，发现栽了跟头：寨版固件版本是 V2.J17.S4，而想用 STM32CubeIDE 进行调试，必须先把 ST-LINK 固件升级到 V2.J37.S7，升级失败。看了一下淘宝评价，发现这寨版根本不能升。于是放弃了 STM32CubeIDE，去寻替代品。Jetbrains 家的 IDE 我用得挺熟练的，所以选了 CLion 来开发。</p><h3 id="0x02-%E5%88%9D%E5%A7%8B%E5%8C%96">0x02 初始化</h3><p>　　CLion 采用 CubeMX 来生成初始代码，交互上做得还很不好。总之我们先点击左上角的 MCU 型号，把板子换成 F3 Discovery；于是原来的项目名就木大了，变成「Untitled」。给项目改名（要和 CLion 项目的名字一模一样），最终如下：</p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="../content/images/2021/05/image-1.png" class="kg-image" alt loading="lazy" width="2000" height="1126" srcset="../content/images/size/w600/2021/05/image-1.png 600w, ../content/images/size/w1000/2021/05/image-1.png 1000w, ../content/images/size/w1600/2021/05/image-1.png 1600w, ../content/images/size/w2400/2021/05/image-1.png 2400w" sizes="(min-width: 720px) 720px"><figcaption>▲ CLion 的项目名误写成了「74hc595」，这边也只能将错就错</figcaption></figure><p>　　然后配置 GPIO 用途。我们把 <code>PB12</code>、<code>PB13</code> 、<code>PB14</code> 用于数字信号输出。</p><h3 id="0x03-%E5%85%B3%E4%BA%8E-74ls595">0x03 关于 74LS595</h3><p>　　我们的目标是控制 8 个 LED 的通断。如果按一般的做法，那就是从单片机上的 8 个 GPIO 各引一条线到对应的 LED。然而 MCU 上的 GPIO 是很宝贵的，这样一次性占 8 个 GPIO 对很多应用场景来说，都不合适。</p><p>　　首先说一下这里为什么用 74LS 芯片而不用 74HC 芯片。</p><ol><li>我打算用 3.3V 的电源去驱动芯片和 LED，而 74HC 芯片是 5V 电平，虽然逻辑上也能工作，但我毕竟第一次用这块芯片，还是准备按标准来。</li><li>74LS 芯片默认上拉，管脚悬空视为高电平。这样我可以少接几根线。</li></ol><p>　　来看 74LS595 的管脚定义：</p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="../content/images/2021/05/image-2.png" class="kg-image" alt loading="lazy" width="1515" height="1008" srcset="../content/images/size/w600/2021/05/image-2.png 600w, ../content/images/size/w1000/2021/05/image-2.png 1000w, ../content/images/2021/05/image-2.png 1515w" sizes="(min-width: 720px) 720px"><figcaption>▲ 74LS595 datasheet，图源 TI&nbsp;官网</figcaption></figure><p>　　我手上的芯片是右上角那种。各个引脚的定义如下：</p><ul><li><code>QA-QH</code> 是数据输出，我用来控制 8 个 LED。</li><li><code>SER</code> 是数据输入。</li><li><code>SRCK</code> 是时钟信号，上升沿触发。触发后，把 <code>SER</code> 的值压进移位寄存器中。这里只是把数据压进 shift register 里面去，并不改变输出。</li><li><code>RCK</code> 也是上升沿触发的时钟信号，触发后用 shift register 的值覆盖掉 storage register，改变芯片的输出。</li><li><code>QH'</code> 是级联输出，如果级联多个 74LS595 的话，把 <code>QH'</code> 连到下一个芯片的 <code>SER</code> 管脚，就能把自己移位时抛掉的 bit 送进下一个芯片。我这里只需要操控 8 个 LED，不用级联，故把这个管脚悬空。</li><li><code>G</code> 在高电平时阻止输出（把输出变成高阻态），换句话讲就是低电平的时候使能输出端。我们希望 LED 常亮，所以 <code>G</code> 应该接到 <code>GND</code> 来拉低。</li><li><code>SRCLR</code> 是低电平有效的清零端，方便我们用程序直接清零芯片（而不是连续压 8 个 0 进去）。不过我们这里为了节省 GPIO，不采用这个清零渠道，故把 <code>SRCLR</code> 拉到 VCC。</li></ul><p>　　74LS595 提供了「锁定输出端」的功能，这是为了防止在移位过程中产生的各种中间状态被输出。我们之后会演示这个情形。这个特性是我们选择 74LS595 而非普通移位寄存器的主要原因。顺便一提，SN74LS595 的官方描述是「Shift Registers With Output Latches」，带输出锁的移位寄存器。</p><p>　　现在我想把这 8 个 LED 设为一个状态（例如 10101010），需要干的事情如下：</p><ol><li>把 <code>SER</code> 置为对应的信号。</li><li>做一个 <code>SRCK</code> 的上升沿，把刚刚设置的信号压进去。</li><li>重复上述过程 8 次，于是 shift register 里面变成了我们期望的那 8 位数据。做一个 <code>RCK</code> 的上升沿，来把 storage register 改成这 8 位，从而点亮我们期望的那些 LED。</li></ol><p>　　原理很简单。接下来开始焊板子。</p><h3 id="0x04-%E7%84%8A-%E6%AD%A6-%E5%B8%9D">0x04 焊 武 帝</h3><p>　　至于为什么不用面包板来做，是因为 74LS595 芯片是 DIP16 封装，而我的 LED 的直径大于 100mil（2.54mm），占用面包板的不止一列，所以如果要采用面包板，杜邦线必须飞得到处都是……最终决定在万能板上面飞线来做这个事。</p><p>　　首先摆好芯片、LED 和排针，五个排针分别对应 <code>GND</code>, <code>VCC</code>, <code>SER</code>, <code>RCK</code>, <code>SRCK</code> ，然后开始焊。</p><figure class="kg-card kg-gallery-card kg-width-wide kg-card-hascaption"><div class="kg-gallery-container"><div class="kg-gallery-row"><div class="kg-gallery-image"><img src="../content/images/2021/05/1622006569806-1.jpg" width="2000" height="1500" loading="lazy" alt srcset="../content/images/size/w600/2021/05/1622006569806-1.jpg 600w, ../content/images/size/w1000/2021/05/1622006569806-1.jpg 1000w, ../content/images/size/w1600/2021/05/1622006569806-1.jpg 1600w, ../content/images/size/w2400/2021/05/1622006569806-1.jpg 2400w" sizes="(min-width: 720px) 720px"></div><div class="kg-gallery-image"><img src="../content/images/2021/05/1622006569922.jpg" width="2000" height="1500" loading="lazy" alt srcset="../content/images/size/w600/2021/05/1622006569922.jpg 600w, ../content/images/size/w1000/2021/05/1622006569922.jpg 1000w, ../content/images/size/w1600/2021/05/1622006569922.jpg 1600w, ../content/images/size/w2400/2021/05/1622006569922.jpg 2400w" sizes="(min-width: 720px) 720px"></div></div></div><figcaption>▲ 把元件焊到万能板上</figcaption></figure><p>　　这个飞线采用的是漆包线，外面有一层绝缘膜，但是在焊点处是接通的，所以不用刮漆，非常好用。具体原理我也不知道，也许是加热过程会破坏外层漆吧……总之好用就完事了。然后连接板子和 stm32 开发板，最终是下面的样子：</p><figure class="kg-card kg-image-card"><img src="../content/images/2021/05/1622006570046.jpg" class="kg-image" alt loading="lazy" width="2000" height="1500" srcset="../content/images/size/w600/2021/05/1622006570046.jpg 600w, ../content/images/size/w1000/2021/05/1622006570046.jpg 1000w, ../content/images/size/w1600/2021/05/1622006570046.jpg 1600w, ../content/images/size/w2400/2021/05/1622006570046.jpg 2400w" sizes="(min-width: 720px) 720px"></figure><h3 id="0x05-%E5%86%99%E4%BB%A3%E7%A0%81">0x05 写代码</h3><p>　　我们开始写代码。为了方便复用，我们写一个 <code>led595.h</code> 来定义几个函数：</p><figure class="kg-card kg-image-card"><img src="../content/images/2021/05/image-3.png" class="kg-image" alt loading="lazy" width="1850" height="1026" srcset="../content/images/size/w600/2021/05/image-3.png 600w, ../content/images/size/w1000/2021/05/image-3.png 1000w, ../content/images/size/w1600/2021/05/image-3.png 1600w, ../content/images/2021/05/image-3.png 1850w" sizes="(min-width: 720px) 720px"></figure><p>　　然后在 <code>led595.c</code> 里面实现之。注意 <code>.h</code> 和 <code>.c</code> 的文件放置位置不一样，前者目录是 <code>Core/Inc</code> ，后者目录是 <code>Core/Src</code> 。在使用的时候，只需要包含 <code>led595.h</code> ，如下：</p><figure class="kg-card kg-image-card"><img src="../content/images/2021/05/image-6.png" class="kg-image" alt loading="lazy" width="2000" height="993" srcset="../content/images/size/w600/2021/05/image-6.png 600w, ../content/images/size/w1000/2021/05/image-6.png 1000w, ../content/images/size/w1600/2021/05/image-6.png 1600w, ../content/images/2021/05/image-6.png 2390w" sizes="(min-width: 720px) 720px"></figure><p>　　具体实现如下，写在 <code>led595.c</code> 里面：</p><pre><code class="language-c">//
// Created by blue on 2021/5/26.
//

#include &lt;main.h&gt;

#define PIN_SER GPIO_PIN_12
#define PIN_RCK GPIO_PIN_13
#define PIN_SCK GPIO_PIN_14

#define MS_TO_DELAY 1

void set_led_state(unsigned state) {
    HAL_GPIO_WritePin(GPIOB, PIN_SCK, 0);       // 拉低 SCK、RCK，以便之后产生上升沿
    HAL_GPIO_WritePin(GPIOB, PIN_RCK, 0);

    for(int i=7; i&gt;=0; i--)
    {
        HAL_GPIO_WritePin(GPIOB, PIN_SER, (state &amp; (1&lt;&lt;i)) &gt; 0);       // 写 state 的对应位

        HAL_GPIO_WritePin(GPIOB, PIN_SCK, 1);

        HAL_Delay(MS_TO_DELAY);
        HAL_GPIO_WritePin(GPIOB, PIN_SCK, 0);
        HAL_Delay(MS_TO_DELAY);
    }

    HAL_GPIO_WritePin(GPIOB, PIN_RCK, 1);   // 从移位寄存器的暂存值，输出到数据寄存器
    HAL_Delay(MS_TO_DELAY);
    HAL_GPIO_WritePin(GPIOB, PIN_RCK, 0);
}

void set_led_state_with_shifting(unsigned state) {
    HAL_GPIO_WritePin(GPIOB, PIN_SCK, 0);       // 拉低 SCK、RCK，以便之后产生上升沿
    HAL_GPIO_WritePin(GPIOB, PIN_RCK, 0);

    for(int i=7; i&gt;=0; i--)
    {
        HAL_GPIO_WritePin(GPIOB, PIN_SER, (state &amp; (1&lt;&lt;i)) &gt; 0);       // 写 state 的对应位

        HAL_GPIO_WritePin(GPIOB, PIN_SCK, 1);

        HAL_Delay(MS_TO_DELAY);
        HAL_GPIO_WritePin(GPIOB, PIN_SCK, 0);
        HAL_Delay(MS_TO_DELAY);

        HAL_GPIO_WritePin(GPIOB, PIN_RCK, 1);   // 从移位寄存器的暂存值，输出到数据寄存器
        HAL_Delay(MS_TO_DELAY);
        HAL_GPIO_WritePin(GPIOB, PIN_RCK, 0);
    }
}

</code></pre><p>　　我们这里演示了两种方法，<code>set_led_state</code> 是按照我们之前描述的方案来做，而 <code>set_led_state_with_shifting</code> 是模拟了一个纯粹的移位寄存器，直接把 shift register 的内容输出。为了演示这两种方案的不同，我们把 <code>MS_TO_DELAY</code> 设成几百毫秒。烧录程序，开跑：</p><figure class="kg-card kg-image-card"><img src="../content/images/2021/05/image-4.png" class="kg-image" alt loading="lazy" width="2000" height="1133" srcset="../content/images/size/w600/2021/05/image-4.png 600w, ../content/images/size/w1000/2021/05/image-4.png 1000w, ../content/images/size/w1600/2021/05/image-4.png 1600w, ../content/images/size/w2400/2021/05/image-4.png 2400w" sizes="(min-width: 720px) 720px"></figure><h3 id="0x06-%E4%B8%A4%E7%A7%8D%E7%A7%BB%E4%BD%8D%E5%AF%84%E5%AD%98%E5%99%A8%E6%96%B9%E6%A1%88%E7%9A%84%E6%AF%94%E8%BE%83">0x06 两种移位寄存器方案的比较</h3><p>　　常规的移位寄存器是这样的：</p><figure class="kg-card kg-image-card"><img src="../content/images/2021/05/without.gif" class="kg-image" alt loading="lazy" width="640" height="360"></figure><p>　　可见，为了输出 <code>10101010</code> ，不得不经过一大堆中间状态。而带锁的移位寄存器是这样的：</p><figure class="kg-card kg-image-card"><img src="../content/images/2021/05/lock.gif" class="kg-image" alt loading="lazy" width="640" height="360"></figure><p>　　一步到位，非常文明！</p><h3 id="0x07-%E4%BA%8C%E8%BF%9B%E5%88%B6%E8%AE%A1%E6%97%B6%E5%99%A8">0x07 二进制计时器</h3><p>　　KDE plasma 里面有个桌面部件叫做「二进制时钟」，拿像素块来显示时间，很有意思。我们这边的 LED 数量不够做二进制时钟，但是可以做个二进制计时器：LED 显示 <code>cnt</code> 的二进制值，每隔 300ms 执行一次 <code>cnt++</code> 。</p><figure class="kg-card kg-image-card"><img src="../content/images/2021/05/image-5.png" class="kg-image" alt loading="lazy" width="2000" height="1013" srcset="../content/images/size/w600/2021/05/image-5.png 600w, ../content/images/size/w1000/2021/05/image-5.png 1000w, ../content/images/size/w1600/2021/05/image-5.png 1600w, ../content/images/size/w2400/2021/05/image-5.png 2400w" sizes="(min-width: 720px) 720px"></figure><p>　　最终效果如图所示：</p><figure class="kg-card kg-image-card"><img src="../content/images/2021/05/cnt.gif" class="kg-image" alt loading="lazy" width="640" height="360"></figure><h3 id="0x08-%E6%80%BB%E7%BB%93">0x08 总结</h3><p>　　我们用三个输出端口（一个数据、两个时钟），完成了 8 个 LED 的控制。串口转并口要付出频率的代价，不过我们这个应用里面，频率除以 8 是毫无问题的。事实上，用这三个输出端口可以控制更多的 LED，只需要级联几块 74LS595。</p><p>　　GPIO 直接连接 LED 的情况下，可以通过 PWM 来调控 LED 亮度。74LS595 的速度很快，我隐约感觉 PWM 调 8 个 LED 亮度是可行的。但是现在的代码跑得太慢，即使 <code>MS_TO_DELAY</code> 设成 0，计数 256 也要耗掉 2s 左右，算下来切换得最频繁的 LED0 大概才 100Hz，闪烁很明显。优化一下，改一改时钟频率，也许能达到 PWM 的要求，但是我要复习去了。复习完了再摸一摸罢。</p>
                </div>
            </section>


            <div id="gitalk-container"></div>

            <link rel="stylesheet" href="https://cdn.staticfile.org/gitalk/1.6.2/gitalk.css">
            <script src="https://cdn.staticfile.org/gitalk/1.6.2/gitalk.min.js"></script>

            <script>
                const gitalk = new Gitalk({

                    proxy: 'https://cors.pion1eer.workers.dev/?https://github.com/login/oauth/access_token',

                    clientID: '9f7e67174f5ab8b1a2b9',
                    clientSecret: 'ddee425a0b50ed02a05fdedb1a4ea039e01b3170',
                    repo: 'blogComment',
                    owner: 'Ruanxingzhi',
                    admin: ['Ruanxingzhi'],
                    id: location.pathname,      // Ensure uniqueness and length less than 50
                    distractionFreeMode: false  // Facebook-like distraction free mode

                    });

                gitalk.render('gitalk-container');
            </script>

        </article>

    </div>
</main>

<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
                <article class="read-next-card">
                    <header class="read-next-card-header">
                        <h3><span>More in</span> <a href="../tag/embedded/index.html">embedded</a></h3>
                    </header>
                    <div class="read-next-card-content">
                        <ul>
                            <li>
                                <h4><a href="../stm8-ws2812b/index.html">用 STM8 控制 WS2812B LED</a></h4>
                                <div class="read-next-card-meta">
                                    <p><time datetime="2022-11-24">24 Nov 2022</time> –
                                        9 min read</p>
                                </div>
                            </li>
                            <li>
                                <h4><a href="../totp/index.html">二步验证 TOTP 协议及其实现</a></h4>
                                <div class="read-next-card-meta">
                                    <p><time datetime="2022-11-18">18 Nov 2022</time> –
                                        5 min read</p>
                                </div>
                            </li>
                            <li>
                                <h4><a href="../lilac-pcb/index.html">Lilac 战队纪念：PCB 尺</a></h4>
                                <div class="read-next-card-meta">
                                    <p><time datetime="2021-12-30">30 Dec 2021</time> –
                                        3 min read</p>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <footer class="read-next-card-footer">
                        <a href="../tag/embedded/index.html">See all 3 posts
                            →</a>
                    </footer>
                </article>

                <article class="post-card post tag-red-teaming no-image no-image">


    <div class="post-card-content">

        <a class="post-card-content-link" href="https://www.ruanx.net/attack-notes/">

            <header class="post-card-header">
                    <div class="post-card-primary-tag">red-teaming</div>
                <h2 class="post-card-title">ATT&amp;CK 学习笔记</h2>
            </header>

            <section class="post-card-excerpt">
                    <p>MITRE ATT&CK 是一个攻防知识库，描述了攻击者的战术、技法和程序。这里是 ATT&CK 的学习笔记。</p>
            </section>

        </a>

        <footer class="post-card-meta">
            <ul class="author-list">
                <li class="author-list-item">
            
                    <div class="author-name-tooltip">
                        Ruan Xingzhi
                    </div>
            
                    <a href="../author/blue/index.html" class="static-avatar">
                        <img class="author-profile-image" src="../content/images/size/w100/2020/05/blue.jpeg" alt="Ruan Xingzhi" />
                    </a>
                </li>
            </ul>
            <div class="post-card-byline-content">
                <span><a href="../author/blue/index.html">Ruan Xingzhi</a></span>
                <span class="post-card-byline-date"><time datetime="2021-07-31">31 Jul 2021</time> <span class="bull">&bull;</span> 1 min read</span>
            </div>
        </footer>

    </div>

</article>

                <article class="post-card post tag-reproduce no-image no-image">


    <div class="post-card-content">

        <a class="post-card-content-link" href="../zhuan-zai-qing-qing-de-hu-xi/index.html">

            <header class="post-card-header">
                    <div class="post-card-primary-tag">reproduce</div>
                <h2 class="post-card-title">转载：轻轻的呼吸</h2>
            </header>

            <section class="post-card-excerpt">
                    <p>俄国文学家蒲宁的作品。</p>
            </section>

        </a>

        <footer class="post-card-meta">
            <ul class="author-list">
                <li class="author-list-item">
            
                    <div class="author-name-tooltip">
                        reproduce
                    </div>
            
                    <a href="../author/reproduce/index.html" class="static-avatar">
                        <img class="author-profile-image" src="../content/images/size/w100/2020/06/world-908894_640.png" alt="reproduce" />
                    </a>
                </li>
            </ul>
            <div class="post-card-byline-content">
                <span><a href="../author/reproduce/index.html">reproduce</a></span>
                <span class="post-card-byline-date"><time datetime="2021-03-29">29 Mar 2021</time> <span class="bull">&bull;</span> 13 min read</span>
            </div>
        </footer>

    </div>

</article>
        </div>
    </div>
</aside>




        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="../index.html">Pion1eer</a> &copy; 2023</section>
                <nav class="site-footer-nav">
                    <a href="http://beian.miit.gov.cn/" target="_blank">湘ICP备20008720号-1</a>
                    <a href="../index.html">Latest Posts</a>
                    
                    
                    <a href="https://ghost.org" target="_blank" rel="noopener">Ghost</a>
                </nav>
            </div>
        </footer>

    </div>

<!--

    <div class="subscribe-success-message">
        <a class="subscribe-close" href="javascript:;"></a>
        You've successfully subscribed to Pion1eer!
    </div>

    <div id="subscribe" class="subscribe-overlay">
        <a class="subscribe-close" href="#"></a>
        <div class="subscribe-overlay-content">
            <div class="subscribe-form">
                <h1 class="subscribe-overlay-title">Subscribe to Pion1eer</h1>
                <p class="subscribe-overlay-description">Stay up to date! Get all the latest & greatest posts delivered straight to your inbox</p>
                <form data-members-form="subscribe">
                    <div class="form-group">
                        <input class="subscribe-email" data-members-email placeholder="youremail@example.com"
                            autocomplete="false" />
                        <button class="button primary" type="submit">
                            <span class="button-content">Subscribe</span>
                            <span class="button-loader"><svg version="1.1" id="loader-1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px"
    y="0px" width="40px" height="40px" viewBox="0 0 40 40" enable-background="new 0 0 40 40" xml:space="preserve">
    <path opacity="0.2" fill="#000" d="M20.201,5.169c-8.254,0-14.946,6.692-14.946,14.946c0,8.255,6.692,14.946,14.946,14.946
s14.946-6.691,14.946-14.946C35.146,11.861,28.455,5.169,20.201,5.169z M20.201,31.749c-6.425,0-11.634-5.208-11.634-11.634
c0-6.425,5.209-11.634,11.634-11.634c6.425,0,11.633,5.209,11.633,11.634C31.834,26.541,26.626,31.749,20.201,31.749z" />
    <path fill="#000" d="M26.013,10.047l1.654-2.866c-2.198-1.272-4.743-2.012-7.466-2.012h0v3.312h0
C22.32,8.481,24.301,9.057,26.013,10.047z">
        <animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 20 20" to="360 20 20"
            dur="0.5s" repeatCount="indefinite" />
    </path>
</svg></span>
                        </button>
                    </div>
                    <div class="message-success">
                        <strong>Great!</strong> Check your inbox and click the link to confirm your subscription.
                    </div>
                    <div class="message-error">
                        Please enter a valid email address!
                    </div>
                </form>
            </div>
        </div>
    </div>

-->

    <script
        src="https://cdn.ruanx.net/js/jquery.min.js"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
        crossorigin="anonymous">
    </script>
    <script src="../assets/built/casper%EF%B9%96v=792c672b3c.js"></script>

    <script>
        // Parse the URL parameter
        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        // Give the parameter a variable name
        var action = getParameterByName('action');

        $(document).ready(function () {
            if (action == 'subscribe') {
                $('body').addClass("subscribe-success");
            }

            $('.subscribe-success-message .subscribe-close').click(function () {
                $('.subscribe-success-message').addClass('close');
            });

            // Reset form on opening subscrion overlay
            $('.subscribe-button').click(function() {
                $('.subscribe-overlay form').removeClass();
                $('.subscribe-email').val('');
            });
        });
    </script>

    <script>
    $(document).ready(function () {
        // FitVids - start
        var $postContent = $(".post-full-content");
        $postContent.fitVids();
        // FitVids - end

        // Replace nav with title on scroll - start
        Casper.stickyNavTitle({
            navSelector: '.site-nav-main',
            titleSelector: '.post-full-title',
            activeClass: 'nav-post-title-active'
        });
        // Replace nav with title on scroll - end

        // Hover on avatar
        var hoverTimeout;
        $('.author-list-item').hover(function () {
            var $this = $(this);

            clearTimeout(hoverTimeout);

            $('.author-card').removeClass('hovered');
            $(this).children('.author-card').addClass('hovered');

        }, function () {
            var $this = $(this);

            hoverTimeout = setTimeout(function () {
                $this.children('.author-card').removeClass('hovered');
            }, 800);
        });
    });
</script>

<script src="https://cdn.staticfile.org/highlight.js/10.1.1/highlight.min.js"></script>
<script >hljs.initHighlightingOnLoad();</script>



    <style>.kg-bookmark-metadata > .kg-bookmark-publisher:before {
    content: "" !important; 
    margin: 0 !important;
}
</style>

</body>
</html>
