<!DOCTYPE html>
<html lang="en">
<head>

    <title>从DNS和sinkhole视角看WannaCry蠕虫</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" type="text/css" href="https://blog.netlab.360.com/assets/built/screen.css?v=d04ad8085d" />

    <link rel="icon" href="https://blog.netlab.360.com/content/images/size/w256h256/2019/02/netlab_xs-2.png" type="image/png" />
    <link rel="canonical" href="index.html" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    <link rel="amphtml" href="https://blog.netlab.360.com/wannacry-from-dns-and-sinkhole-view/amp/" />
    
    <meta property="og:site_name" content="360 Netlab Blog - Network Security Research Lab at 360" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="从DNS和sinkhole视角看WannaCry蠕虫" />
    <meta property="og:description" content="编注：本文来源自《中国计算机学会通讯》2017年第7期《WannaCry勒索蠕虫专刊》，作者是360网络安全研究院李丰沛。在本博客发布时，文章的字句和排版略有调整，以适应本技术博客。我们将该文章发布在本技术博客的动机之一，是因为这篇文章中对WannaCry的感染情况做了一个定量分析，本技术博客的后续其他分析文章可以参考做一个基准。


域名系统(Domain Name System, DNS)数据作为全网流量数据的一种采样方式，可以在大网尺度对域名做有效的度量和分析。我们利用DNS数据，在过去数年里对多个安全事件，包括Mirai等僵尸网络、DGA等恶意域名，以及黑色产业链条进行跟踪和分析。对于最近爆发的WannaCry蠕虫病毒，利用DNS数据进行分析，也是很有意义的。


众所周知，WannaCry蠕虫病毒有一个开关域名，即www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com，该域名相关详细内容见《WannaCry勒索蠕虫专刊》其他文章。在蠕虫感染过程中，有效载荷通过445端口上的 MS17-010漏洞投递并成功启动后，会尝试访问特定域名的" />
    <meta property="og:url" content="https://blog.netlab.360.com/wannacry-from-dns-and-sinkhole-view/" />
    <meta property="og:image" content="https://blog.netlab.360.com/content/images/2019/02/astronomy-constellation-dark-998641-4.jpg" />
    <meta property="article:published_time" content="2017-07-17T13:38:10.000Z" />
    <meta property="article:modified_time" content="2018-10-06T09:02:17.000Z" />
    <meta property="article:tag" content="DNS" />
    <meta property="article:tag" content="Sinkhole" />
    <meta property="article:tag" content="Measurement" />
    <meta property="article:tag" content="WannaCry" />
    <meta property="article:tag" content="PassiveDNS" />
    <meta property="article:tag" content="Chinese" />
    <meta property="article:tag" content="Import 2022-11-30 11:16" />
    
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="从DNS和sinkhole视角看WannaCry蠕虫" />
    <meta name="twitter:description" content="编注：本文来源自《中国计算机学会通讯》2017年第7期《WannaCry勒索蠕虫专刊》，作者是360网络安全研究院李丰沛。在本博客发布时，文章的字句和排版略有调整，以适应本技术博客。我们将该文章发布在本技术博客的动机之一，是因为这篇文章中对WannaCry的感染情况做了一个定量分析，本技术博客的后续其他分析文章可以参考做一个基准。


域名系统(Domain Name System, DNS)数据作为全网流量数据的一种采样方式，可以在大网尺度对域名做有效的度量和分析。我们利用DNS数据，在过去数年里对多个安全事件，包括Mirai等僵尸网络、DGA等恶意域名，以及黑色产业链条进行跟踪和分析。对于最近爆发的WannaCry蠕虫病毒，利用DNS数据进行分析，也是很有意义的。


众所周知，WannaCry蠕虫病毒有一个开关域名，即www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com，该域名相关详细内容见《WannaCry勒索蠕虫专刊》其他文章。在蠕虫感染过程中，有效载荷通过445端口上的 MS17-010漏洞投递并成功启动后，会尝试访问特定域名的" />
    <meta name="twitter:url" content="https://blog.netlab.360.com/wannacry-from-dns-and-sinkhole-view/" />
    <meta name="twitter:image" content="https://blog.netlab.360.com/content/images/2019/02/astronomy-constellation-dark-998641-4.jpg" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Li Fengpei" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="DNS, Sinkhole, Measurement, WannaCry, PassiveDNS, Chinese, Import 2022-11-30 11:16" />
    <meta name="twitter:site" content="@360Netlab" />
    <meta property="og:image:width" content="2000" />
    <meta property="og:image:height" content="1333" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "360 Netlab Blog - Network Security Research Lab at 360",
        "url": "https://blog.netlab.360.com/",
        "logo": {
            "@type": "ImageObject",
            "url": "https://blog.netlab.360.com/content/images/2019/02/netlab-brand-5.png"
        }
    },
    "author": {
        "@type": "Person",
        "name": "Li Fengpei",
        "image": {
            "@type": "ImageObject",
            "url": "https://blog.netlab.360.com/content/images/2016/11/Penguins.jpg",
            "width": 1024,
            "height": 768
        },
        "url": "https://blog.netlab.360.com/author/li/",
        "sameAs": []
    },
    "headline": "从DNS和sinkhole视角看WannaCry蠕虫",
    "url": "https://blog.netlab.360.com/wannacry-from-dns-and-sinkhole-view/",
    "datePublished": "2017-07-17T13:38:10.000Z",
    "dateModified": "2018-10-06T09:02:17.000Z",
    "keywords": "DNS, Sinkhole, Measurement, WannaCry, PassiveDNS, Chinese, Import 2022-11-30 11:16",
    "description": "编注：本文来源自《中国计算机学会通讯》2017年第7期《WannaCry勒索蠕虫专刊》，作者是360网络安全研究院李丰沛。在本博客发布时，文章的字句和排版略有调整，以适应本技术博客。我们将该文章发布在本技术博客的动机之一，是因为这篇文章中对WannaCry的感染情况做了一个定量分析，本技术博客的后续其他分析文章可以参考做一个基准。\n\n\n域名系统(Domain Name System, DNS)数据作为全网流量数据的一种采样方式，可以在大网尺度对域名做有效的度量和分析。我们利用DNS数据，在过去数年里对多个安全事件，包括Mirai等僵尸网络、DGA等恶意域名，以及黑色产业链条进行跟踪和分析。对于最近爆发的WannaCry蠕虫病毒，利用DNS数据进行分析，也是很有意义的。\n\n\n众所周知，WannaCry蠕虫病毒有一个开关域名，即www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com，该域名相关详细内容见《WannaCry勒索蠕虫专刊》其他文章。在蠕虫感染过程中，有效载荷通过445端口上的 MS17-010漏洞投递并成功启动后，会尝试访问特定域名的",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://blog.netlab.360.com/"
    }
}
    </script>

    <meta name="generator" content="Ghost 5.22" />
    <link rel="alternate" type="application/rss+xml" title="360 Netlab Blog - Network Security Research Lab at 360" href="https://blog.netlab.360.com/rss/" />
    
    <script defer src="https://cdn.jsdelivr.net/ghost/sodo-search@~1.1/umd/sodo-search.min.js" data-key="db8c743e6bb1457403d255d83f" data-styles="https://cdn.jsdelivr.net/ghost/sodo-search@~1.1/umd/main.css" data-sodo-search="https://blog.netlab.360.com/" crossorigin="anonymous"></script>
    <script defer src="https://blog.netlab.360.com/public/cards.min.js?v=d04ad8085d"></script>
    <link rel="stylesheet" type="text/css" href="https://blog.netlab.360.com/public/cards.min.css?v=d04ad8085d">
    <style type='text/css'>#ghost-portal-root {
        display: none;
    }
</style><style>:root {--ghost-accent-color: #eca265;}</style>

</head>
<body class="post-template tag-dns tag-sinkhole tag-measurement tag-wannacry tag-pdns tag-chinese tag-import-2022-11-30-11-16 has-cover">
<div class="viewport">

    <header id="gh-head" class="gh-head outer">
        <nav class="gh-head-inner inner">

            <div class="gh-head-brand">
                <a class="gh-head-logo" href="https://blog.netlab.360.com">
                        <img src="https://blog.netlab.360.com/content/images/2019/02/netlab-brand-5.png" alt="360 Netlab Blog - Network Security Research Lab at 360" />
                </a>
                <div class="gh-head-brand-wrapper">
                    <button class="gh-search" data-ghost-search><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button>
                    <a class="gh-burger" role="button">
                        <div class="gh-burger-box">
                            <div class="gh-burger-inner"></div>
                        </div>
                    </a>
                </div>
            </div>
            <div class="gh-head-menu">
                <ul class="nav">
    <li class="nav-botnet"><a href="https://blog.netlab.360.com/tag/botnet/">Botnet</a></li>
    <li class="nav-dnsmon"><a href="https://blog.netlab.360.com/tag/dnsmon/">DNSMon</a></li>
    <li class="nav-ddos"><a href="https://blog.netlab.360.com/tag/ddos/">DDoS</a></li>
    <li class="nav-passivedns"><a href="https://blog.netlab.360.com/tag/pdns/">PassiveDNS</a></li>
    <li class="nav-mirai"><a href="https://blog.netlab.360.com/tag/mirai/">Mirai</a></li>
    <li class="nav-dta"><a href="https://blog.netlab.360.com/tag/dta/">DTA</a></li>
</ul>

            </div>
            <div class="gh-head-actions">
                <div class="gh-social">
                        <a class="gh-social-link gh-social-twitter" href="https://twitter.com/360Netlab" title="Twitter" target="_blank" rel="me noopener"><svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><path d="M23.954 4.569c-.885.389-1.83.654-2.825.775 1.014-.611 1.794-1.574 2.163-2.723-.951.555-2.005.959-3.127 1.184-.896-.959-2.173-1.559-3.591-1.559-2.717 0-4.92 2.203-4.92 4.917 0 .39.045.765.127 1.124C7.691 8.094 4.066 6.13 1.64 3.161c-.427.722-.666 1.561-.666 2.475 0 1.71.87 3.213 2.188 4.096-.807-.026-1.566-.248-2.228-.616v.061c0 2.385 1.693 4.374 3.946 4.827-.413.111-.849.171-1.296.171-.314 0-.615-.03-.916-.086.631 1.953 2.445 3.377 4.604 3.417-1.68 1.319-3.809 2.105-6.102 2.105-.39 0-.779-.023-1.17-.067 2.189 1.394 4.768 2.209 7.557 2.209 9.054 0 13.999-7.496 13.999-13.986 0-.209 0-.42-.015-.63.961-.689 1.8-1.56 2.46-2.548l-.047-.02z"/></svg></a>
                        <a class="gh-social-link gh-social-feedly" href="https://feedly.com/i/subscription/feed/https://blog.netlab.360.com/rss/" title="RSS" target="_blank" rel="me noopener"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><circle cx="6.18" cy="17.82" r="2.18"/><path d="M4 4.44v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/></svg>
</a>
                </div>
            </div>
        </nav>
    </header>

    <div class="site-content">
             <div class="floating-header">
    <div class="floating-header-logo">
        <a href="https://blog.netlab.360.com">
                <img src="https://blog.netlab.360.com/content/images/size/w30/2019/02/netlab_xs-2.png" alt="360 Netlab Blog - Network Security Research Lab at 360 icon" />
            <span>360 Netlab Blog - Network Security Research Lab at 360</span>
        </a>
    </div>
    <span class="floating-header-divider">&mdash;</span>
    <div class="floating-header-title">从DNS和sinkhole视角看WannaCry蠕虫</div>
    <div class="floating-header-share">
        <div class="floating-header-share-label">Share this <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M7.5 15.5V4a1.5 1.5 0 1 1 3 0v4.5h2a1 1 0 0 1 1 1h2a1 1 0 0 1 1 1H18a1.5 1.5 0 0 1 1.5 1.5v3.099c0 .929-.13 1.854-.385 2.748L17.5 23.5h-9c-1.5-2-5.417-8.673-5.417-8.673a1.2 1.2 0 0 1 1.76-1.605L7.5 15.5zm6-6v2m-3-3.5v3.5m6-1v2"/>
</svg>
</div>
        <a class="floating-header-share-tw" href="https://twitter.com/share?text=%E4%BB%8EDNS%E5%92%8Csinkhole%E8%A7%86%E8%A7%92%E7%9C%8BWannaCry%E8%A0%95%E8%99%AB&amp;url=https://blog.netlab.360.com/wannacry-from-dns-and-sinkhole-view/"
            onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;">
            <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><path d="M23.954 4.569c-.885.389-1.83.654-2.825.775 1.014-.611 1.794-1.574 2.163-2.723-.951.555-2.005.959-3.127 1.184-.896-.959-2.173-1.559-3.591-1.559-2.717 0-4.92 2.203-4.92 4.917 0 .39.045.765.127 1.124C7.691 8.094 4.066 6.13 1.64 3.161c-.427.722-.666 1.561-.666 2.475 0 1.71.87 3.213 2.188 4.096-.807-.026-1.566-.248-2.228-.616v.061c0 2.385 1.693 4.374 3.946 4.827-.413.111-.849.171-1.296.171-.314 0-.615-.03-.916-.086.631 1.953 2.445 3.377 4.604 3.417-1.68 1.319-3.809 2.105-6.102 2.105-.39 0-.779-.023-1.17-.067 2.189 1.394 4.768 2.209 7.557 2.209 9.054 0 13.999-7.496 13.999-13.986 0-.209 0-.42-.015-.63.961-.689 1.8-1.56 2.46-2.548l-.047-.02z"/></svg>        </a>
        <a class="floating-header-share-fb" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.netlab.360.com/wannacry-from-dns-and-sinkhole-view/"
            onclick="window.open(this.href, 'share-facebook','width=580,height=296');return false;">
            <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><path d="M23.9981 11.9991C23.9981 5.37216 18.626 0 11.9991 0C5.37216 0 0 5.37216 0 11.9991C0 17.9882 4.38789 22.9522 10.1242 23.8524V15.4676H7.07758V11.9991H10.1242V9.35553C10.1242 6.34826 11.9156 4.68714 14.6564 4.68714C15.9692 4.68714 17.3424 4.92149 17.3424 4.92149V7.87439H15.8294C14.3388 7.87439 13.8739 8.79933 13.8739 9.74824V11.9991H17.2018L16.6698 15.4676H13.8739V23.8524C19.6103 22.9522 23.9981 17.9882 23.9981 11.9991Z"/></svg>        </a>
    </div>
    <progress id="reading-progress" class="progress" value="0">
        <div class="progress-container">
            <span class="progress-bar"></span>
        </div>
    </progress>
</div>


  <main id="site-main" class="site-main">
    <article class="article post tag-dns tag-sinkhole tag-measurement tag-wannacry tag-pdns tag-chinese tag-import-2022-11-30-11-16 no-image ">

      <header class="article-header gh-canvas">

        <div class="article-tag post-card-tags">
          <span class="post-card-primary-tag">
            <a href="https://blog.netlab.360.com/tag/dns/">DNS</a>
          </span>
        </div>

        <h1 class="article-title">从DNS和sinkhole视角看WannaCry蠕虫</h1>


        <div class="article-byline">
          <section class="article-byline-content">

            <ul class="author-list">
              <li class="author-list-item">
                <a href="https://blog.netlab.360.com/author/li/" class="author-avatar">
                  <img class="author-profile-image" src="https://blog.netlab.360.com/content/images/2016/11/Penguins.jpg" alt="Li Fengpei" />
                </a>
              </li>
            </ul>

            <div class="article-byline-meta">
              <h4 class="author-name"><a href="https://blog.netlab.360.com/author/li/">Li Fengpei</a></h4>
              <div class="byline-meta-content">
                <time class="byline-meta-date" datetime=" 2017-07-17">Jul 17, 2017</time>
                <span class="byline-reading-time"><span class="bull">&bull;</span> 14 min read</span>
              </div>
            </div>

          </section>
        </div>


      </header>

      <section class="gh-content gh-canvas">
        <!--kg-card-begin: markdown--><p>编注：本文来源自《中国计算机学会通讯》2017年第7期《WannaCry勒索蠕虫专刊》，作者是360网络安全研究院李丰沛。在本博客发布时，文章的字句和排版略有调整，以适应本技术博客。我们将该文章发布在本技术博客的动机之一，是因为这篇文章中对WannaCry的感染情况做了一个定量分析，本技术博客的后续其他分析文章可以参考做一个基准。</p>
<p>域名系统(Domain Name System, DNS)数据作为全网流量数据的一种采样方式，可以在大网尺度对域名做有效的度量和分析。我们利用DNS数据，在过去数年里对多个安全事件，包括Mirai等僵尸网络、DGA等恶意域名，以及黑色产业链条进行跟踪和分析。对于最近爆发的WannaCry蠕虫病毒，利用DNS数据进行分析，也是很有意义的。</p>
<p>众所周知，WannaCry蠕虫病毒有一个开关域名，即www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com，该域名相关详细内容见《WannaCry勒索蠕虫专刊》其他文章。在蠕虫感染过程中，有效载荷通过445端口上的 MS17-010漏洞投递并成功启动后，会尝试访问特定域名的网页。如果成功访问网页，则随即退出，蠕虫会被压制，不会进一步发作；如果访问网页失败，蠕虫会开始破坏动作，并随后弹框勒索赎金。本文首先从我们手头的DNS数据视角，就开关域名和其他域名的访问情况，描绘本次WannaCry蠕虫病毒在国内的感染和防御情况。</p>
<p>尽管在注册开关域名时，Kryptos Logic Vantage (www.kryptoslogic.com)的研究人员并没有意识到这个域名的重要作用，但实际上，正是这个开关域名成功抑制了WannaCry蠕虫的蔓延，研究人员因此自嘲说“意外地拯救了世界”。得益于Kryptos Logic Vantage对我们的信任，我们获得了关键域名sinkhole的部分日志数据。本文的第二部分，将基于sinkhole日志的统计信息，分析WannaCry的感染情况。</p>
<h3 id="dnswannacry">从DNS视角看WannaCry在国内的感染和防御情况</h3>
<p>这里，有必要先介绍一下我们在DNS方面“看见”的能力，从而向读者确认我们所见的数据能够代表中国地区。我们及合作伙伴的DNS数据源每日高峰期处理超过100万次/秒的DNS请求和响应，客户来源覆盖国内各地理区域、行业、运营商等不同领域。</p>
<p>在这次WannaCry事件中，我们估算能够看到全国大约10%的相关DNS流量。如果将整个国内互联网视为一个复杂系统，DNSPAI则是对DNS流量的一个采样，而全部的DNS流量是对整个复杂系统在协议维度的一个采样。在这个尺度上，即使只有1%的采样比也是非常惊人的。通过合理设定数据处理管道和充分运用大数据分析技术，我们能够对中国大陆地区的网络安全情况有一个较为全面的了解。</p>
<h4 id="wannacry">WannaCry在国内的感染趋势</h4>
<h5 id="1">1. 早期感染阶段</h5>
<p>5月12日（周五）15:20（北京时间，下同），我们看到了首个访问该域名的DNS请求。此时的域名解析是不成功的，自然无法访问到目标网页，机器一旦感染蠕虫，就会发作。这个阶段的DNS访问曲线如图1所示。</p>
<p><img src="https://blog.netlab.360.com/content/images/2017/07/01-early-infection.png" alt="" loading="lazy"><br>
图1  早期感染阶段DNS访问曲线</p>
<p>这段时间又可以划分为如下若干更小的时间片。</p>
<ul>
<li>15:00～17:00之间，每个小时的感染数量分别是 9，25和202，每个小时扩大约一个数量级，这是极早期快速感染阶段；</li>
<li>17:00～22:00之间，每小时新增感染达到了一个较高水平，最高达到2800/小时，这是第一次高峰阶段；</li>
<li>22:00～23:00之间，感染速度逐渐下降，这应该是夜间更多机器关机导致，可以归纳为夜间自然下降阶段；</li>
</ul>
<p>仔细观察这段时间的感染情况，可以得出以下结论：</p>
<ul>
<li>我们有理由认为15:00附近就是国内蠕虫最初感染发作的时间，尽管我们看到的仅是国内DNS数据的采样而非全部。这是因为最初的感染速度非常小，为个位数，并且在随后的每个小时内扩充约1个数量级，如果我们把时间向前追溯，就可以得到这个结论。</li>
<li>压制域名的上线有重大意义：在整个早期感染阶段，蠕虫扩张的速度非常快，如果不是压制域名争取了时间，所有后续的防御行动都会困难很多。事实上，周五这天晚上22:00附近就是WannaCry感染速度的历史最高水平，即使是后来的周一早上上班大开机的时刻也没能超过这个水平。</li>
</ul>
<h5 id="2">2.  域名压制阶段</h5>
<p>开关域名于周五23:30左右上线，开始了对WannaCry的压制。这段时间也可以继续细分为如下若干时间片段。</p>
<ul>
<li>压制域名同步到全网阶段。由于DNS本身的缓存，压制域名虽然最早于23:30左右上线，但是这个案例中还需要大约30分钟才能让全网所有节点都能感知到。在这30分钟里，全网范围内DNS应答中，NXDOMAIN（域名不存在）和A（回应IP地址）两种类型同时存在。前者在回落，后者在上升。域名上线后大约5～10分钟时，两条曲线出现十字交叉，域名上线30分钟后，NXDOMAIN被压制到地板附近（见图2）</li>
<li>平稳控制阶段。NXDOMAIN被压制以后，过度到了平稳控制阶段。在这个阶段，一方面，微软补丁更新和安全社区的共同努力减少了感染机器的数量；另一方面，总有机器因为各种原因被新增感染。总体而言，总感染量处于动态平衡状态，并且会随着时间推移最终平稳下降。从既往其他类似情况看，下降过程也许会耗费数年，并且往往会出现以周为单位的规律性波动（见图3）。</li>
</ul>
<p><img src="https://blog.netlab.360.com/content/images/2017/07/02-kill-switch-domain-go-online.png" alt="" loading="lazy"><br>
图2 压制域名同步到全网阶段<br>
<img src="https://blog.netlab.360.com/content/images/2017/07/03-for-the-next-two-weeks-infection-are-under-control.png" alt="" loading="lazy"><br>
图3 平稳控制阶段</p>
<p>在这个阶段，有以下情况值得一提。</p>
<p>在5月17日以后，DNS数据中信噪比逐渐下降，逐渐变得不再适合用来做分析和度量。这主要是由于开关域名被媒体和公众大量关注，越来越多的针对开关域名的访问是来自浏览器而非WannaCry。</p>
<p>尽管如此，每天的DNS访问曲线仍然是不多的风向标之一。在感染的早期，每个人都无法预测WannaCry的后续发展趋向，只能严密监视域名访问情况。白天相对夜晚有个波峰，这是正常现象；周日的波峰比周六更高一些，没人知道这是个什么样的兆头；直到周一早晨9:00的波峰开始回落，确认周一读数小于周五，我们才能基本认为感染情况大体得到控制；随后，在周三和周四感染情况有所反弹，每个人的心又提到嗓子眼；直到再下一周数据整体回落，我们才能最终确认局势受控，从应急状态回到平稳的工作状态。</p>
<h4 id="wannacry">WannaCry不同变种感染情况对比</h4>
<p>随着时间推移，不断有WannaCry的不同变种被曝光，有的样本去掉了对开关域名的检测（但是幸运的是该样本被改坏了，无法正常启动），有的样本使用了不同的开关域名，但是从DNS数据层面来看，除了原始版本，其他版本并没有得到广泛传播。</p>
<p>我们至少捕获到以下WannaCry变种样本：</p>
<ul>
<li>hxxp://www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com</li>
<li>hxxp://www.ifferfsodp9ifjaposdfjhgosurijfaewrwergwea.com</li>
<li>hxxp://www.udhridhfowhgibe9vheiviehfiehbfvieheifheih.com</li>
<li>hxxp://www.iuqssfsodp9ifjaposdfjhgosurijfaewrwergwea.com</li>
<li>hxxp://www.ayylmaotjhsstasdfasdfasdfasdfasdfasdfasdf.com</li>
</ul>
<p>对应域名的DNS访问曲线如图4所示。</p>
<ul>
<li>传播的主体，是iuqerf的原始版本；</li>
<li>ifferf版本有少量传播，比原始版本小了一个数量级；</li>
<li>其他版本只有零星访问或者干脆没有访问。</li>
</ul>
<p><img src="https://blog.netlab.360.com/content/images/2017/07/04-comparation-between-different-variants.png" alt="" loading="lazy"><br>
图4  对应域名的DNS访问曲线</p>
<p>变种版本的感染范围远小于原始版本，也许可以归为补丁防御工作开始启动。无论如何，可以预期后续变种如果仅仅修改了开源域名，并不会比 ifferf版本带来更大影响。总体而言，在这个案例中，非原始版本的WannaCry的感染情况不值得引起安全社区的密切关注。</p>
<h4 id="wsus">微软WSUS补丁更新服务的访问情况</h4>
<p>微软补丁是本次WannaCry防御体系的关键，理应获得比WannaCry变种更多的关注。查询微软WSUS服务的官网可知，WSUS服务与下列域名访问有关：</p>
<ul>
<li>hxxp://windowsupdate.microsoft.com</li>
<li>hxxp://download.windowsupdate.com</li>
<li>hxxp://download.microsoft.com</li>
<li>hxxp://test.stats.update.microsoft.com</li>
<li>hxxp://ntservicepack.microsoft.com</li>
</ul>
<p>简单查询可知，download.windowsupdate.com的访问量最大，我们选用这个域名的DNS访问情况来代表补丁更新情况，如图5所示。<br>
<img src="https://blog.netlab.360.com/content/images/2017/07/05-dns-traffic-on-wsus.png" alt="" loading="lazy"><br>
图5  download.windowsupdate.com域名的DNS访问情况</p>
<p>通常而言，补丁更新分发的高峰是在“星期二补丁日”的第二天。按照惯例，微软是在每个月第二周的星期二发补丁，第二天（周三）是中国区用户更新的高峰时间。但是这一次，5月15日（周一）当天出现了一个波峰。这种情况可以理解为系统网络管理员、个人在经过周六和周日的宣传后，大量用户在周一更新了微软补丁。</p>
<p>从这个意义上来说，这一次整个安全社区在周六、周日紧急行动起来，向社会和公众说明情况，提供防御手段和解决方案，是非常必要的。如果错过了周六和周日宣传准备的时间窗口，周一早上的开机时刻也许就是灾难时刻。</p>
<h3 id="sinkholewannacry">从sinkhole视角看WannaCry的感染情况</h3>
<p>如前所述，得益于Kryptos Logic Vantage对我们的信任，我们获得了域名sinkhole的关键日志。这段数据覆盖了全球，是WannaCry事件中全球视角的唯一权威数据。Kryptos Logic Vantage授权我们展示部分统计信息。</p>
<p>我们得到的sinkhole数据，发生在北京时间5月12日23:40～5月16日8:10，缺失了5月13日10:30～5月14日00:20之间的数据。这段数据显示，开关域名共计被访问了266万次，涉及16万个独立来源IP。</p>
<h4 id="sinkholedns">Sinkhole与DNS数据对比分析</h4>
<p>将sinkhole数据与DNS数据放在一起对比，可以清晰地进行分析。如图6所示，蓝色部分为sinkhole数据，红色部分为DNS数据。DNS数据在纵轴上缩放了10倍，以便清晰地展示数据的趋势。</p>
<p><img src="https://blog.netlab.360.com/content/images/2017/07/06-comparation-between-sinkhole-and-dns.png" alt="" loading="lazy"><br>
图6  sinkhole数据与DNS数据对比分析</p>
<p>按时间顺序解读图6，可以得知：</p>
<ul>
<li>域名刚刚上线后的5个小时之内是sinkhole访问的历史高峰，每分钟约3500次；</li>
<li>上线6小时后sinkhole访问数量开始持续回落，到北京时间5月14日6时许降低到高峰时段的十分之一，到15日3时为最低点，约为历史高峰水平的三十分之一。可以认为，域名上线，有效压制了蠕虫的发展；</li>
</ul>
<p>以上观察结果与之前DNS数据观察结果一致。我们猜测，缺失的14个小时的数据，趋势也是一直在下降。</p>
<h4 id="windows">来源端口和Windows动态端口范围设定</h4>
<p>除了时序方面，来源端口方面的数据分布也引起了我们的注意。端口49150前后的来源访问次数差别非常大，端口1024前后也有一个局部的暴涨。图7～9分别是全端口分布、端口49150附近数据缩放以及端口1024附近数据缩放。</p>
<p><img src="https://blog.netlab.360.com/content/images/2017/07/07-source-port-distribution-in-sinkhole-view.png" alt="" loading="lazy"><br>
图7  全端口分布<br>
<img src="https://blog.netlab.360.com/content/images/2017/07/08-distribution-burst-around-port-49150.png" alt="" loading="lazy"><br>
图8  端口49150附近数据缩放<br>
<img src="https://blog.netlab.360.com/content/images/2017/07/09-distribution-burst-around-port-1024.png" alt="" loading="lazy"><br>
图9  端口1024附近数据缩放</p>
<p>我们查到，Windows操作系统对动态端口范围有如表1所示的设定。</p>
<p>表1 Windows操作系统对动态端口范围的设定<br>
<img src="https://blog.netlab.360.com/content/images/2017/07/10-windows-dynamic-port-assign-policy.png" alt="" loading="lazy"></p>
<p>基于以上事实，我们有如下推测。</p>
<ul>
<li>相当比例机器被感染的时机，发生在Windows刚刚启动完成的阶段，这时动态端口几乎都没有被使用，操作系统按照预设范围由低到高，给请求分配了范围下限附近的端口；</li>
<li>处在下限边缘但很少被使用到的端口，例如，49152/49153/49154和1024/1025/1026/1027，也许是被操作系统自身在启动过程中用掉；</li>
<li>绝大部分被感染版本是Windows Vista/Windows 7/WindowsServer2008及以后版本，之前版本感染的不多。</li>
</ul>
<h4 id="">致谢</h4>
<p>我们特别致谢Kryptos Logic Vantage，不仅因为他们允许我们获得sinkhole的日志，从而得以从更多角度深入WannaCry蠕虫病毒；更主要是因为Kryptos Logic Vantage的sinkhole在此次案例中，为所有安全社区工作者争取了宝贵的时间，维护了所有人（也许病毒作者除外）的利益。</p>
<h4 id="">参考文献</h4>
<p>[1] Windows服务器系统的服务概述和网络端口要求[OL].<a href="https://support.microsoft.com/zh-cn/help/832017/service-overview-and-network-port-requirements-for-windows">https://support.microsoft.com/zh-cn/help/832017/service-overview-and-network-port-requirements-for-windows</a></p>
<!--kg-card-end: markdown-->
      </section>



      <div id="disqus_thread" class="disqus-comments gh-canvas"></div>
      <script>
        var disqus_config = function () {
          this.page.url = "https://blog.netlab.360.com/wannacry-from-dns-and-sinkhole-view/";
          this.page.identifier = "ghost-57"
        };
        (function () {
          var d = document, s = d.createElement('script');
          s.src = 'https://blog-netlab-360.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
        })();
      </script>
    </article>

  </main>


    <aside class="read-more-wrap outer">
      <div class="inner">
        <div class="read-more-feed">
            <article class="read-more-card" 
                  style="background-image: url(https://blog.netlab.360.com/content/images/2019/02/astronomy-constellation-dark-998641-4.jpg)" 
              >
              <header class="read-more-card-header">
                <small class="read-more-card-header-sitetitle">&mdash; 360 Netlab Blog - Network Security Research Lab at 360 &mdash;</small>
                <h3 class="read-more-card-header-title"><a href="https://blog.netlab.360.com/tag/dns/">DNS</a></h3>
              </header>
              <div class="read-more-divider"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 14.5s2 3 5 3 5.5-2.463 5.5-5.5S21 6.5 18 6.5c-5 0-7 11-12 11C2.962 17.5.5 15.037.5 12S3 6.5 6 6.5s4.5 3.5 4.5 3.5"/></svg>
</div>
              <div class="read-more-card-content">
                <ul>
                  <li><a href="https://blog.netlab.360.com/b1txor20-use-of-dns-tunneling_cn/">新威胁：使用DNS Tunnel技术的Linux后门B1txor20正在通过Log4j漏洞传播</a></li>
                  <li><a href="https://blog.netlab.360.com/the-pitfall-of-threat-intelligence-whitelisting-specter-botnet-is-taking-over-top-legit-dns-domains-by-using-cloudns-service/">The Pitfall of Threat Intelligence Whitelisting: Specter Botnet is &#x27;taking over&#x27; Top Legit DNS Domains By Using ClouDNS Service</a></li>
                  <li><a href="https://blog.netlab.360.com/specter-domain-whitelist-abuse/">白名单之殇：Specter僵尸网络滥用ClouDNS服务，github.com无辜躺枪</a></li>
                </ul>
              </div>
              <footer class="read-more-card-footer">
                <a href="https://blog.netlab.360.com/tag/dns/">See all 5 posts →</a>
              </footer>
            </article>

          
<article class="post-card post tag-iot-botnet tag-hajime tag-english tag-import-2022-11-30-11-16 no-image">


  <div class="post-card-content">

    <a class="post-card-content-link" href="https://blog.netlab.360.com/hajime-status-report-en/">
      <header class="post-card-header">
        <div class="post-card-tags">
          <span class="post-card-primary-tag">IoT Botnet</span>
        </div>
        <h2 class="post-card-title">
          Is Hajime botnet dead?
        </h2>
      </header>
      <div class="post-card-excerpt">Overview


The mysterious Hajime botnet was first discovered by Rapiditynetworks in Oct 2016, and it was all over the news earlier this year, but it seems that nobody talks about it any more now, is this botnet gone?


The answer is no, our team has been tracking this botnet for</div>
    </a>

    <footer class="post-card-meta">
      <ul class="author-list">
        <li class="author-list-item">
          <div class="author-name-tooltip">
            RootKiter
          </div>

          <a href="https://blog.netlab.360.com/author/rootkiter/" class="static-avatar">
            <img class="author-profile-image" src="https://blog.netlab.360.com/content/images/2017/04/--.png" alt="RootKiter" />
          </a>
        </li>
      </ul>
      <time class="post-card-meta-date" datetime=" 2017-09-20">Sep 20, 2017</time>
      <span class="post-card-meta-length">6 min read</span>
    </footer>

  </div>

</article>
          
<article class="post-card post tag-new-threat tag-reverse-engineering tag-iot-botnet tag-http81 tag-english tag-import-2022-11-30-11-16 no-image">


  <div class="post-card-content">

    <a class="post-card-content-link" href="https://blog.netlab.360.com/http-81-botnet-the-comparison-against-mirai-and-new-findings-en/">
      <header class="post-card-header">
        <div class="post-card-tags">
          <span class="post-card-primary-tag">New Threat</span>
        </div>
        <h2 class="post-card-title">
          Http 81 Botnet: the Comparison against MIRAI and New Findings
        </h2>
      </header>
      <div class="post-card-excerpt">Overview


In our previous blog, we introduced a new IoT botnet spreading over http 81. We will name it in this blog the http81 IoT botnet, while some anti-virus software name it Persirai, and some other name it after MIRAI.


In this blog, we will compare http81 against mirai at</div>
    </a>

    <footer class="post-card-meta">
      <ul class="author-list">
        <li class="author-list-item">
          <div class="author-name-tooltip">
            RootKiter
          </div>

          <a href="https://blog.netlab.360.com/author/rootkiter/" class="static-avatar">
            <img class="author-profile-image" src="https://blog.netlab.360.com/content/images/2017/04/--.png" alt="RootKiter" />
          </a>
        </li>
      </ul>
      <time class="post-card-meta-date" datetime=" 2017-04-28">Apr 28, 2017</time>
      <span class="post-card-meta-length">5 min read</span>
    </footer>

  </div>

</article>
        </div>
      </div>
    </aside>



    </div>

    <footer class="site-footer outer">
        <div class="inner">
            <section class="copyright"><a href="https://blog.netlab.360.com">360 Netlab Blog - Network Security Research Lab at 360</a> &copy; 2023</section>
            <div><a href="https://ghost.org/" target="_blank" rel="noopener">Powered by Ghost</a></div>
        </div>
    </footer>

</div>


<script
    src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
    crossorigin="anonymous">
</script>
<script src="https://blog.netlab.360.com/assets/built/casper.js?v=d04ad8085d"></script>
<script>
$(document).ready(function () {
    // Mobile Menu Trigger
    $('.gh-burger').click(function () {
        $('body').toggleClass('gh-head-open');
    });
    // FitVids - Makes video embeds responsive
    $(".gh-content").fitVids();

    // floating-header
    // Start fitVids
      var $postContent = $(".gh-content");
      $postContent.fitVids();
      // End fitVids

      var progressBar = document.querySelector('#reading-progress');
      var header = document.querySelector('.floating-header');
      var title = document.querySelector('.article-title');

      var lastScrollY = window.scrollY;
      var lastWindowHeight = window.innerHeight;
      var lastDocumentHeight = $(document).height();
      var ticking = false;

      function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
      }

      function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
      }

      function requestTick() {
        if (!ticking) {
          requestAnimationFrame(update);
        }
        ticking = true;
      }

      function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        // show/hide floating header
        if (lastScrollY >= trigger + triggerOffset) {
          header.classList.add('floating-active');
        } else {
          header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
      }

      window.addEventListener('scroll', onScroll, { passive: true });
      window.addEventListener('resize', onResize, false);

      update();
});
</script>



</body>
</html>
