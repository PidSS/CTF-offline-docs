
<!DOCTYPE html>
<html lang=en>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="HandheldFriendly" content="True">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <meta name="description" content="phith0n的小站，长期存在与分享关于网络安全与各种编程的原创文章。">
  <meta name="keywords" content="phith0n,网络安全,代码审计,信息安全,漏洞挖掘,php,C++,mysql,python">
  <link rel="shortcut icon" href="../static/cactus/images/favicon.ico">
  <link rel="icon" type="image/png" href="../static/cactus/images/favicon-192x192.png" sizes="192x192">
  <link rel="apple-touch-icon" sizes="180x180" href="../static/cactus/images/apple-touch-icon.png">
  <link rel="alternate" type="application/atom+xml" href="../feed/index.rss" title="离别歌"/>

  <title>有安全研究者混入了PHP 8.0开发组！ | 离别歌</title>
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.staticfile.org/bootstrap/5.1.3/css/bootstrap-grid.min.css">
  <link rel="stylesheet" href="../static/cactus/css/style%EF%B9%96v=20220521.css">
  
  <link rel="stylesheet" href="../static/cactus/css/code%EF%B9%96v=20211026.css">
  <link href="https://cdn.staticfile.org/fancybox/2.1.7/css/jquery.fancybox.min.css" rel="stylesheet">

</head>
<body>



  <div class="sticky">
    <a href="#" id="menu-icon" class="menu-icon active"><i class="fa fa-bars fa-lg"></i></a>
    <div class="menu">
      <ul>
        <li><a href="../index.html">主页</a></li>
        <li><a href="javascript:history.back(-1)">返回</a></li>
      </ul>
      <br>
    </div>
    <div class="clearfix"></div>
    <div class="info" style="position: fixed">
      <span id="i-top" style="display: none">Back to top</span>
      <span id="i-share" style="display: none">Share post</span>
    </div>
    <ul class="actions">
      <li><a class="icon" href="#" id="back-top"><i
          class="fa fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();"
          onmouseout="$('#i-top').toggle();"></i></a></li>
      <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true"
                                      onmouseover="$('#i-share').toggle();"
                                      onmouseout="$('#i-share').toggle();"
                                      onclick="$('#share').toggleClass('hidden');return false;"></i></a></li>
    </ul>
    <div id="share" class="hidden">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3A//www.leavesongs.com/PHP/php-8-0-release.html"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https%3A//www.leavesongs.com/PHP/php-8-0-release.html&amp;text=%E6%9C%89%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6%E8%80%85%E6%B7%B7%E5%85%A5%E4%BA%86PHP%208.0%E5%BC%80%E5%8F%91%E7%BB%84%EF%BC%81"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3A//www.leavesongs.com/PHP/php-8-0-release.html&amp;title=%E6%9C%89%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6%E8%80%85%E6%B7%B7%E5%85%A5%E4%BA%86PHP%208.0%E5%BC%80%E5%8F%91%E7%BB%84%EF%BC%81"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3A//www.leavesongs.com/PHP/php-8-0-release.html&amp;is_video=false&amp;description=%E6%9C%89%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6%E8%80%85%E6%B7%B7%E5%85%A5%E4%BA%86PHP%208.0%E5%BC%80%E5%8F%91%E7%BB%84%EF%BC%81"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=%E6%9C%89%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6%E8%80%85%E6%B7%B7%E5%85%A5%E4%BA%86PHP%208.0%E5%BC%80%E5%8F%91%E7%BB%84%EF%BC%81&amp;body=Check out this article: https%3A//www.leavesongs.com/PHP/php-8-0-release.html"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https%3A//www.leavesongs.com/PHP/php-8-0-release.html&amp;title=%E6%9C%89%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6%E8%80%85%E6%B7%B7%E5%85%A5%E4%BA%86PHP%208.0%E5%BC%80%E5%8F%91%E7%BB%84%EF%BC%81"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https%3A//www.leavesongs.com/PHP/php-8-0-release.html&amp;title=%E6%9C%89%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6%E8%80%85%E6%B7%B7%E5%85%A5%E4%BA%86PHP%208.0%E5%BC%80%E5%8F%91%E7%BB%84%EF%BC%81"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3A//www.leavesongs.com/PHP/php-8-0-release.html&amp;title=%E6%9C%89%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6%E8%80%85%E6%B7%B7%E5%85%A5%E4%BA%86PHP%208.0%E5%BC%80%E5%8F%91%E7%BB%84%EF%BC%81"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https%3A//www.leavesongs.com/PHP/php-8-0-release.html&amp;title=%E6%9C%89%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6%E8%80%85%E6%B7%B7%E5%85%A5%E4%BA%86PHP%208.0%E5%BC%80%E5%8F%91%E7%BB%84%EF%BC%81"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https%3A//www.leavesongs.com/PHP/php-8-0-release.html&amp;name=%E6%9C%89%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6%E8%80%85%E6%B7%B7%E5%85%A5%E4%BA%86PHP%208.0%E5%BC%80%E5%8F%91%E7%BB%84%EF%BC%81&amp;description="><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>
    </div>
  </div>

  <div class="container-md">
    <div class="article row justify-content-center min-height">
      <div class="col-lg-8 col-md-10 col-sm-12">
        <article itemscope itemtype="http://schema.org/BlogPosting">
          <header class="post-header">
            <h1 class="color-main h1 mb-0" itemprop="name headline">有安全研究者混入了PHP 8.0开发组！</h1>
            <div class="meta">
              <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
                <span itemprop="name">phithon</span>
              </span>

              <div class="postdate">
                <time datetime="2020年11月28日 18:13" itemprop="datePublished">
                  2020 十一月 28 18:13
                </time>
              </div>

              <div class="article-tag">
                阅读：62778
              </div>

              
                <div class="article-tag">
                  <i class="fa fa-bookmark"></i>
                  <a class="tag-link" href="../sort/PHP.html">PHP</a>
                </div>
              

              
                <div class="article-tag">
                  <i class="fa fa-tag"></i>
                  
                    <a class="tag-link" href="../tag/PHP%E5%AE%89%E5%85%A8.html">PHP安全</a>
                  
                </div>
              
            </div>
          </header>
          <div class="content" itemprop="articleBody">
            <blockquote>
<p>本文首发在我的『<a href="https://mp.weixin.qq.com/s/0HSAPYY2PjbwEN3MhI4SkA">代码审计</a>』公众号，欢迎关注</p>
</blockquote>
<p>经历了近半年的alpha版本测试后，PHP在2020年11月26号正式发布了8.0版本：<a href="https://www.php.net/releases/8.0/en.php">https://www.php.net/releases/8.0/en.php</a></p>
<p>今天我们就来浏览一下PHP 8.0中出现的主要特性，以及它给我们安全研究人员带来的挑战。</p>
<h2 id="named-arguments"><a class="toclink" href="#named-arguments">命名参数 Named Arguments</a></h2>
<p>PHP 8 以前，如果我们需要给一个函数的第N个参数传参，那么这个参数前面的所有参数，我们都需要传参。但是实际上有些参数是具有默认值的，这样做显得多此一举。</p>
<p>比如，我们要给<code>htmlspecialchars</code>的第4个参数传递<code>false</code>，在PHP 8 以前需要传入4个参数：</p>
<div class="codehilite"><pre><span></span><code><span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$string</span><span class="p">,</span> <span class="nx">ENT_COMPAT</span> <span class="o">|</span> <span class="nx">ENT_HTML401</span><span class="p">,</span> <span class="s1">&#39;UTF-8&#39;</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
</code></pre></div>

<p>在8.0以后增加了命名参数，我们只需要传递必需的参数和命名参数即可，方便了很多：</p>
<div class="codehilite"><pre><span></span><code><span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$string</span><span class="p">,</span> <span class="nx">double_encode</span><span class="o">:</span> <span class="k">false</span><span class="p">);</span>
</code></pre></div>

<h2 id="attributes"><a class="toclink" href="#attributes">属性注释 Attributes</a></h2>
<p>属性注释是我自己取得名字，在英文原文中是单词<strong>Attributes</strong>（在C++、C#、Rust里也是相同的单词，但翻译有些差别）。这个新语法有点类似Python里的修饰器，以及Java里的Annotation。</p>
<p>但是，PHP里Attributes的作用还是更偏向于替换以前的doc-block，用于给一个类或函数增加元信息，而不是类似Python的修饰器那样，可以动态地劫持函数的输入与输出。</p>
<p>属性注释的简单例子：</p>
<div class="codehilite"><pre><span></span><code><span class="c1">#[ListensTo(&#39;error&#39;)]</span>
<span class="k">function</span> <span class="nf">onerror</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// do something</span>
<span class="p">}</span>
</code></pre></div>

<p>上面这个例子实际测试你会发现，属性注释里的东西也真的只是一个注释，执行上述的代码也不会去调用ListensTo类。这也印证了上面所说的，Attributes只是对以前doc-block的一个接纳，而非创造了一种HOOK函数的方式。</p>
<p>如果你需要执行Attributes里面的代码，仍然需要通过反射来做到，比如：</p>
<div class="codehilite"><pre><span></span><code><span class="c1">#[Attribute]</span>
<span class="k">class</span> <span class="nc">ListensTo</span> <span class="p">{</span>
    <span class="k">public</span> <span class="nx">string</span> <span class="nv">$event</span><span class="p">;</span>

    <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$event</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">event</span> <span class="o">=</span> <span class="nv">$event</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">#[ListensTo(&#39;error&#39;)]</span>
<span class="k">function</span> <span class="nf">onerror</span><span class="p">()</span> 
<span class="p">{</span>
    <span class="c1">// do something</span>
<span class="p">}</span>

<span class="nv">$listeners</span> <span class="o">=</span> <span class="p">[];</span>
<span class="nv">$f</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ReflectionFunction</span><span class="p">(</span><span class="s1">&#39;onerror&#39;</span><span class="p">);</span>
<span class="k">foreach</span><span class="p">(</span><span class="nv">$f</span><span class="o">-&gt;</span><span class="na">getAttributes</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$attribute</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$listener</span> <span class="o">=</span> <span class="nv">$attribute</span><span class="o">-&gt;</span><span class="na">newInstance</span><span class="p">();</span>
    <span class="nv">$listeners</span><span class="p">[</span><span class="nv">$listener</span><span class="o">-&gt;</span><span class="na">event</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$f</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>我模拟了一个设计模式中监听模式的事件处理方法注册过程，相比于以前解析Doc-Block的过程，这个流程要更加简单。</p>
<p>相比于其他的新特性，框架或IDE的设计者可能会研究的更深，普通开发者只需要按照框架的文档简单使用这个语法即可。</p>
<h2 id="constructor-property-promotion"><a class="toclink" href="#constructor-property-promotion">构造器属性提升 Constructor property promotion</a></h2>
<p>这是一个利国利民的好特性，可以延长键盘的寿命……PHP 8以前，我们定义一个类时，可能会从构造函数里接收大量参数并赋值给类属性，如：</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">Point</span> <span class="p">{</span>
  <span class="k">public</span> <span class="nx">float</span> <span class="nv">$x</span><span class="p">;</span>
  <span class="k">public</span> <span class="nx">float</span> <span class="nv">$y</span><span class="p">;</span>
  <span class="k">public</span> <span class="nx">float</span> <span class="nv">$z</span><span class="p">;</span>

  <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span>
    <span class="nx">float</span> <span class="nv">$x</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="nx">float</span> <span class="nv">$y</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="nx">float</span> <span class="nv">$z</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">x</span> <span class="o">=</span> <span class="nv">$x</span><span class="p">;</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">y</span> <span class="o">=</span> <span class="nv">$y</span><span class="p">;</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">z</span> <span class="o">=</span> <span class="nv">$z</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>实际上这已经形成了一种范式，我们要不厌其烦地进行定义-&gt;传递-&gt;赋值的过程。PHP 8以后给出了一种更加简单的语法：</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">Point</span> <span class="p">{</span>
  <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span>
    <span class="k">public</span> <span class="nx">float</span> <span class="nv">$x</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="k">public</span> <span class="nx">float</span> <span class="nv">$y</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="k">public</span> <span class="nx">float</span> <span class="nv">$z</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
  <span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>
</code></pre></div>

<p>直接在构造函数的参数列表位置完成了类属性的定义与赋值的过程，减少了大概三分之二的代码量。</p>
<p>另外提一句，这个RFC的作者是Nikita Popov，也就是著名的开源项目PHP-Parser的作者，做PHP代码分析的同学应该经常和这个项目打交道。他今年去了PHPStorm团队，相信这个老牌IDE在Nikita的加持下会变得更加好用。</p>
<h2 id="union-types"><a class="toclink" href="#union-types">联合类型 Union types</a></h2>
<p>PHP 8 以前的Type Hinting，只支持使用一个具体的Type，比如：</p>
<div class="codehilite"><pre><span></span><code><span class="k">function</span> <span class="nf">sample</span><span class="p">(</span><span class="k">array</span> <span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">var_dump</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>这个功能鸡肋的一点是，有些地方接受参数类型可能有多个类型，或者支持传入null。</p>
<p>在7.1时解决了null的问题：</p>
<div class="codehilite"><pre><span></span><code><span class="k">function</span> <span class="nf">sample</span><span class="p">(</span><span class="o">?</span><span class="k">array</span> <span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">var_dump</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>但是仍然无法指定多个类型hint。</p>
<p>PHP 8 中总算支持了Union types，我们可以通过<code>|</code>来指定多个类型Hint了：</p>
<div class="codehilite"><pre><span></span><code><span class="k">function</span> <span class="nf">sample</span><span class="p">(</span><span class="k">array</span><span class="o">|</span><span class="nx">string</span><span class="o">|</span><span class="k">null</span> <span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">var_dump</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="match"><a class="toclink" href="#match">Match 语法</a></h2>
<p>这是一个新的关键字<code>match</code>，这也是一个利国利民的好特性，又一次延长了键盘的寿命……</p>
<p>在PHP 8.0以前，我们要根据一个名字来获取一个值，通常需要借助switch或者数组，比如：</p>
<div class="codehilite"><pre><span></span><code><span class="k">switch</span> <span class="p">(</span><span class="nv">$extension</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">case</span> <span class="s1">&#39;gif&#39;</span><span class="o">:</span>
    <span class="nv">$content_type</span> <span class="o">=</span> <span class="s2">&quot;image/gif&quot;</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="s1">&#39;jpg&#39;</span><span class="o">:</span>
    <span class="nv">$content_type</span> <span class="o">=</span> <span class="s2">&quot;image/jpeg&quot;</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="s1">&#39;png&#39;</span><span class="o">:</span>
    <span class="nv">$content_type</span> <span class="o">=</span> <span class="s2">&quot;image/png&quot;</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">echo</span> <span class="nv">$content_type</span><span class="p">;</span>
</code></pre></div>

<p>现在可以简化成一个<strong>表达式</strong>了：</p>
<div class="codehilite"><pre><span></span><code><span class="k">echo</span> <span class="nx">match</span> <span class="p">(</span><span class="nv">$extension</span><span class="p">)</span> <span class="p">{</span>
    <span class="s1">&#39;gif&#39;</span> <span class="o">=&gt;</span> <span class="s2">&quot;image/gif&quot;</span><span class="p">,</span>
    <span class="s1">&#39;jpg&#39;</span> <span class="o">=&gt;</span> <span class="s2">&quot;image/jpeg&quot;</span><span class="p">,</span>
    <span class="s1">&#39;png&#39;</span> <span class="o">=&gt;</span> <span class="s2">&quot;image/png&quot;</span>
<span class="p">};</span>
</code></pre></div>

<h2 id="null-nullsafe-operator"><a class="toclink" href="#null-nullsafe-operator">Null安全的操作符 Nullsafe operator</a></h2>
<p>这又又又是一个利国利民的好特性，又又又一次延长了键盘的寿命……</p>
<p>在PHP 8以前，如果封装的较多，我们经常出现一种情况：一个函数接受X对象，但又可能是null，此时我在使用X对象属性前，就需要对null进行判断，以免出现错误。</p>
<p>在对象较多时，容易出现多层嵌套判断的情况，比如：</p>
<div class="codehilite"><pre><span></span><code><span class="nv">$country</span> <span class="o">=</span>  <span class="k">null</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$session</span> <span class="o">!==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
  <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$session</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nv">$user</span> <span class="o">!==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$address</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">getAddress</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$address</span> <span class="o">!==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$country</span> <span class="o">=</span> <span class="nv">$address</span><span class="o">-&gt;</span><span class="na">country</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>PHP 8 以后增加了一个新语法：<code>?-&gt;</code>，非常类似于PHP7里引入的<code>??</code>。就是在取属性前，PHP会对对象进行判断，如果对象是null，那么就直接返回null了，不再取其属性：</p>
<div class="codehilite"><pre><span></span><code><span class="nv">$country</span> <span class="o">=</span> <span class="nv">$session</span><span class="o">?-&gt;</span><span class="na">user</span><span class="o">?-&gt;</span><span class="na">getAddress</span><span class="p">()</span><span class="o">?-&gt;</span><span class="na">country</span><span class="p">;</span>
</code></pre></div>

<h2 id="_1"><a class="toclink" href="#_1">字符串数字弱类型比较优化</a></h2>
<p>这一个改动可能会对安全漏洞挖掘的影响较大。PHP 8 以前，在使用<code>==</code>比较或任何有弱类型转换的情况时，字符串都会先转换成数字，再和数字进行比较。</p>
<p>比如，这个代码在PHP 8以前的结果是true和0，在PHP 8以后得到的则是false和1：</p>
<div class="codehilite"><pre><span></span><code><span class="nb">var_dump</span><span class="p">(</span><span class="s1">&#39;a&#39;</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">switch</span> <span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
        <span class="k">echo</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">default</span><span class="o">:</span>
        <span class="k">echo</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>老的弱类型可能会有什么安全问题呢？我曾经挖掘到的一个真实案例，大概代码是这样：</p>
<div class="codehilite"><pre><span></span><code><span class="nv">$type</span> <span class="o">=</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">];</span>
<span class="k">switch</span> <span class="p">(</span><span class="nv">$type</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
        <span class="nv">$sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM `type_one` WHERE `type` = </span><span class="si">{</span><span class="nv">$type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
        <span class="nv">$sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM `type_two` WHERE `type` = </span><span class="si">{</span><span class="nv">$type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">default</span><span class="o">:</span>
        <span class="nv">$sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM `type_default`&quot;</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>开发者认为<code>$type</code>是1和2的时候才会进入SQL语句拼接中，但实际我们传入<code>1 and 1=2</code>即可进入<code>case 1</code>，导致SQL注入漏洞。</p>
<p>PHP 8以后彻底杜绝了这种漏洞的产生。</p>
<h2 id="_2"><a class="toclink" href="#_2">内部函数严格参数检查</a></h2>
<p>在PHP 8 以前，如果我们使用内部函数时传入的参数有误（比如，参数类型错误，参数取值错误等），有时会抛出一个异常，有时是一个错误，有时只是一个警告。在PHP 8 以后，所有这类错误都将是一个异常，并且导致解释器停止运行，比如：</p>
<div class="codehilite"><pre><span></span><code><span class="nb">strlen</span><span class="p">([]);</span> <span class="c1">// TypeError: strlen(): Argument #1 ($str) must be of type string, array given</span>
<span class="nb">array_chunk</span><span class="p">([],</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// ValueError: array_chunk(): Argument #2 ($length) must be greater than 0</span>
</code></pre></div>

<p>这个改动可能会影响一些安全漏洞的利用，有一些我们之前通过弱类型等tricks构造的POC，在老版本PHP中只是一个警告，不会影响解释器的执行，但8.0之后将会导致错误，也就中断了执行。</p>
<h2 id="jit"><a class="toclink" href="#jit">JIT</a></h2>
<p>JIT（Just-In-Time）被鸟哥称为PHP 8 中最重要的改动，我来简单介绍一下PHP 8 的JIT。</p>
<p>PHP 8 的JIT附加在opcache这个扩展中，opcache本身就是对PHP解释器的优化。没有使用opcache时，PHP解释器是在运行PHP脚本的时候进行“编译-&gt;Zend虚拟机执行”的过程。而opcache的出现实际上就是节省了编译的时间，代码在第一次运行时会编译成opcache能识别的缓存（opcode），之后运行时就免除了编译的过程，直接执行这段opcode。</p>
<p>而JIT的出现再次优化了这个过程，JIT会将一些执行次数较多的opcode直接翻译成机器码。这样PHP解释器在执行时，机器码会直接交给CPU来执行，又减少了Zend虚拟机执行opcode的时间。</p>
<p>普通开发者可能对JIT比较无感，毕竟大家的性能瓶颈多半出现在IO等问题中，但对于性能要求极高的人或企业来说，JIT的确是对PHP的重要改进。</p>
<h2 id="_3"><a class="toclink" href="#_3">其他可能和安全相关的改动</a></h2>
<p>作为安全研究者，我会更关注的是和安全相关的改动。除了前面提到了弱类型方面的改动外，PHP 8还进行了如下一些和安全相关的改动：</p>
<ul>
<li><code>assert()</code>不再支持执行代码，少了一个执行任意代码的函数，这个影响还是挺大的。</li>
<li><code>create_function()</code>函数被彻底移除了，我们又少了一个可以执行任意代码的函数。</li>
<li>libxml依赖最低2.9.0起，也就是说，XXE漏洞彻底消失在PHP里了。</li>
<li>继<code>preg_replace()</code>中的e模式被移除后，<code>mb_ereg_replace()</code>中的e模式也被彻底移除，再次少了一个执行任意代码的函数。</li>
<li>Phar中的元信息不再自动进行反序列化了，<code>phar://</code>触发反序列化的姿势也告别了。</li>
<li><code>parse_str()</code>必须传入第二个参数了，少了一种全局变量覆盖的方法。</li>
<li><code>php://filter</code>中的<code>string.strip_tags</code>被移除了，我在文章《<a href="../PENETRATION/php-filter-magic.html">谈一谈php://filter的妙用</a>》中提到的去除死亡exit的方法之一也就失效了。</li>
<li><code>strpos()</code>等函数中的参数必须要传入字符串了，以前通过传入数组进行弱类型利用的方法也失效了。</li>
</ul>
<p>这些改动，改的我心拔凉拔凉的……我一度认为PHP核心团队里混入了安全研究者，为什么我们常用的小trick都被改没了呢？</p>
<h2 id="_4"><a class="toclink" href="#_4">总结</a></h2>
<p>总结一下PHP 8，我只有两个感想：</p>
<ul>
<li>我不用担心键盘的寿命了，但是我的头顶变凉了</li>
<li>比头顶更凉的是我的心，安全真是越来越难做了</li>
</ul>
<p>好在，现在很多人慢慢转战Java，Java可以吃的饭应该还有很多。</p>
<p>参考链接：</p>
<ul>
<li><a href="https://www.php.net/releases/8.0/en.php">https://www.php.net/releases/8.0/en.php</a></li>
<li><a href="https://wiki.php.net/rfc/attributes_v2">https://wiki.php.net/rfc/attributes_v2</a></li>
<li><a href="https://wiki.php.net/rfc/shorter_attribute_syntax">https://wiki.php.net/rfc/shorter_attribute_syntax</a></li>
<li><a href="https://stitcher.io/blog/attributes-in-php-8">https://stitcher.io/blog/attributes-in-php-8</a></li>
<li><a href="https://www.laruence.com/2020/06/27/5963.html">https://www.laruence.com/2020/06/27/5963.html</a></li>
</ul>
          </div>
        </article>

        
          <h1 class="h1 color-main">赞赏</h1>
          <div class="zan text-center">
            <p>喜欢这篇文章？打赏1元</p>
            <p class="m-0"><img src="../static/wx.jpg" width="280" alt=""></p>
          </div>
        

        <div id="reply-list">
          <h1 class="h1 color-main">评论</h1>
          
            
              <div class="flex mb-2" id="comment-3615">
                <div class="gravatar">
                  <img src="../static/placeholder.jpg" width="40px" height="40px" alt="">
                </div>
                <div class="ps-2">
                  <p class="comment-meta title">
                    <a href="" target="_blank" rel="nofollow noopener">’a=1 or &#x27;1&#x27;=&#x27;1</a>
                    <time datetime="2021年2月7日 18:40" itemprop="datePublished">
                      2021 二月 07 18:40
                    </time>
                    <a href="javascript:reply_to('3615', '%E2%80%99a%5Cu003D1%20or%20%5Cu00271%5Cu0027%5Cu003D%5Cu00271')">回复</a>
                  </p>
                  <p class="comment-meta">为啥不能是php的核心开发者混入了安全研究者。</p>
                </div>
              </div>
              
            
              <div class="flex mb-2" id="comment-3600">
                <div class="gravatar">
                  <img src="https://secure.gravatar.com/avatar/b7faad25bfa6acc8129764fe9f117ab6.jpg?s=100&amp;d=mm&amp;r=g" width="40px" height="40px" alt="">
                </div>
                <div class="ps-2">
                  <p class="comment-meta title">
                    <a href="https://www.gov-bid.com/" target="_blank" rel="nofollow noopener">招投标</a>
                    <time datetime="2021年1月15日 18:41" itemprop="datePublished">
                      2021 一月 15 18:41
                    </time>
                    <a href="javascript:reply_to('3600', '%E6%8B%9B%E6%8A%95%E6%A0%87')">回复</a>
                  </p>
                  <p class="comment-meta">各种漏洞都有</p>
                </div>
              </div>
              
            
              <div class="flex mb-2" id="comment-3582">
                <div class="gravatar">
                  <img src="https://secure.gravatar.com/avatar/69f6d48aa271db33d6f7de165dde2281.jpg?s=100&amp;d=mm&amp;r=g" width="40px" height="40px" alt="">
                </div>
                <div class="ps-2">
                  <p class="comment-meta title">
                    <a href="" target="_blank" rel="nofollow noopener">采购查询</a>
                    <time datetime="2020年11月30日 17:41" itemprop="datePublished">
                      2020 十一月 30 17:41
                    </time>
                    <a href="javascript:reply_to('3582', '%E9%87%87%E8%B4%AD%E6%9F%A5%E8%AF%A2')">回复</a>
                  </p>
                  <p class="comment-meta">博客很棒 欢迎回访</p>
                </div>
              </div>
              
            
          
        </div>

        

        <form method="post" enctype="multipart/form-data" action="#reply" id="reply" class="mb-4">
          <div class="container-fluid px-0">
            
            <div class="row">
              <div class="col">
                <textarea name="content" cols="40" rows="6" required id="id_content">
</textarea>
              </div>
            </div>
            <div class="row gx-2">
              <div class="col-4">
                <input type="text" name="nickname" placeholder="昵称" maxlength="64" required id="id_nickname">
              </div>
              <div class="col-4">
                <input type="text" name="email" placeholder="邮箱（可留空）" maxlength="254" id="id_email">
              </div>
              <div class="col-4">
                <input type="text" name="url" placeholder="链接（可留空）" maxlength="200" id="id_url">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-4">
              <div class="row gx-2" style="margin-top: 8px"><div class="col-6"><input autocomplete="off" id="id_captcha_1" name="captcha_1" type="text" placeholder="验证码" /> <input id="id_captcha_0" name="captcha_0" type="hidden" value="d5405d4d41e77c9cbdb33acb57b1406c1630d9a5" />
</div><div class="col-6">
<img src="../captcha/image/d5405d4d41e77c9cbdb33acb57b1406c1630d9a5/index.png" alt="captcha" class="captcha" /></div></div>
            </div>
          </div>
          <div class="row">
            <div class="col">
              <input type="submit" class="ui-button ui-button-sgreen" value="提交">
            </div>
          </div>
          <input type="hidden" name="archive" value="459" id="id_archive">
          <input type="hidden" name="parent" id="id_parent">
          <input type="hidden" name="csrfmiddlewaretoken" value="lCMgrCwEJ1aAgpiQaZ7LZ7Oarp4niMVT7aa7ZH7n7nojOX6ec04wWARfMMlyRo7b">
        </form>
      </div>
    </div>
    <div class="row justify-content-center">
      <div class="col-lg-7 col-md-10 col-sm-12">
        <footer class="footer mx-auto">
  <div class="footer-left">
    Copyright &copy; 2023 Powered by talkbook
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <li><a href="../index.html">首页</a></li>
        <li><a href="../feed/index.rss" target="_blank">RSS订阅</a></li>
        <li><a href="http://weibo.com/101yx" target="_blank">微博</a></li>
        <li><a href="https://github.com/phith0n" target="_blank">项目</a></li>
        <li><a href="../index.html">更换模板</a></li>
      </ul>
    </nav>
  </div>
</footer>
      </div>
    </div>
  </div>

<script src="https://cdn.staticfile.org/jquery/2.2.4/jquery.min.js"></script>
<script src="../static/cactus/js/main%EF%B9%96v=2021102502.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-FF5KPQ1CZ6"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-FF5KPQ1CZ6');
</script>

  <script src="https://cdn.staticfile.org/fancybox/2.1.7/js/jquery.fancybox.min.js"></script>
  <script>
      $(document).ready(function () {
          $(".content a").each(function (i, e) {
              if (e.host != 'www.leavesongs.com') {
                  e.target = '_blank';
              }
          });
          $(".content img").each(function (i, e) {
              if (e.parentNode.tagName.toUpperCase() != 'A') {
                  $(e).wrap('<a href="' + escapeHtml(e.src) + '" class="fancybox"></a>');
              } else {
                  $(e.parentNode).addClass('fancybox');
              }
          });
          $('.fancybox').fancybox();
      })
  </script>

</body>
</html>