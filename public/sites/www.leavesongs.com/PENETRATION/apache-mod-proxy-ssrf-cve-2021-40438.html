
<!DOCTYPE html>
<html lang=en>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="HandheldFriendly" content="True">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <meta name="description" content="phith0n的小站，长期存在与分享关于网络安全与各种编程的原创文章。">
  <meta name="keywords" content="phith0n,网络安全,代码审计,信息安全,漏洞挖掘,php,C++,mysql,python">
  <link rel="shortcut icon" href="../static/cactus/images/favicon.ico">
  <link rel="icon" type="image/png" href="../static/cactus/images/favicon-192x192.png" sizes="192x192">
  <link rel="apple-touch-icon" sizes="180x180" href="../static/cactus/images/apple-touch-icon.png">
  <link rel="alternate" type="application/atom+xml" href="../feed/index.rss" title="离别歌"/>

  <title>Apache mod_proxy SSRF（CVE-2021-40438）的一点分析和延伸 | 离别歌</title>
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.staticfile.org/bootstrap/5.1.3/css/bootstrap-grid.min.css">
  <link rel="stylesheet" href="../static/cactus/css/style%EF%B9%96v=20220521.css">
  
  <link rel="stylesheet" href="../static/cactus/css/code%EF%B9%96v=20211026.css">
  <link href="https://cdn.staticfile.org/fancybox/2.1.7/css/jquery.fancybox.min.css" rel="stylesheet">

</head>
<body>



  <div class="sticky">
    <a href="#" id="menu-icon" class="menu-icon active"><i class="fa fa-bars fa-lg"></i></a>
    <div class="menu">
      <ul>
        <li><a href="../index.html">主页</a></li>
        <li><a href="javascript:history.back(-1)">返回</a></li>
      </ul>
      <br>
    </div>
    <div class="clearfix"></div>
    <div class="info" style="position: fixed">
      <span id="i-top" style="display: none">Back to top</span>
      <span id="i-share" style="display: none">Share post</span>
    </div>
    <ul class="actions">
      <li><a class="icon" href="#" id="back-top"><i
          class="fa fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();"
          onmouseout="$('#i-top').toggle();"></i></a></li>
      <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true"
                                      onmouseover="$('#i-share').toggle();"
                                      onmouseout="$('#i-share').toggle();"
                                      onclick="$('#share').toggleClass('hidden');return false;"></i></a></li>
    </ul>
    <div id="share" class="hidden">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3A//www.leavesongs.com/PENETRATION/apache-mod-proxy-ssrf-cve-2021-40438.html"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https%3A//www.leavesongs.com/PENETRATION/apache-mod-proxy-ssrf-cve-2021-40438.html&amp;text=Apache%20mod_proxy%20SSRF%EF%BC%88CVE-2021-40438%EF%BC%89%E7%9A%84%E4%B8%80%E7%82%B9%E5%88%86%E6%9E%90%E5%92%8C%E5%BB%B6%E4%BC%B8"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3A//www.leavesongs.com/PENETRATION/apache-mod-proxy-ssrf-cve-2021-40438.html&amp;title=Apache%20mod_proxy%20SSRF%EF%BC%88CVE-2021-40438%EF%BC%89%E7%9A%84%E4%B8%80%E7%82%B9%E5%88%86%E6%9E%90%E5%92%8C%E5%BB%B6%E4%BC%B8"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3A//www.leavesongs.com/PENETRATION/apache-mod-proxy-ssrf-cve-2021-40438.html&amp;is_video=false&amp;description=Apache%20mod_proxy%20SSRF%EF%BC%88CVE-2021-40438%EF%BC%89%E7%9A%84%E4%B8%80%E7%82%B9%E5%88%86%E6%9E%90%E5%92%8C%E5%BB%B6%E4%BC%B8"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Apache%20mod_proxy%20SSRF%EF%BC%88CVE-2021-40438%EF%BC%89%E7%9A%84%E4%B8%80%E7%82%B9%E5%88%86%E6%9E%90%E5%92%8C%E5%BB%B6%E4%BC%B8&amp;body=Check out this article: https%3A//www.leavesongs.com/PENETRATION/apache-mod-proxy-ssrf-cve-2021-40438.html"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https%3A//www.leavesongs.com/PENETRATION/apache-mod-proxy-ssrf-cve-2021-40438.html&amp;title=Apache%20mod_proxy%20SSRF%EF%BC%88CVE-2021-40438%EF%BC%89%E7%9A%84%E4%B8%80%E7%82%B9%E5%88%86%E6%9E%90%E5%92%8C%E5%BB%B6%E4%BC%B8"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https%3A//www.leavesongs.com/PENETRATION/apache-mod-proxy-ssrf-cve-2021-40438.html&amp;title=Apache%20mod_proxy%20SSRF%EF%BC%88CVE-2021-40438%EF%BC%89%E7%9A%84%E4%B8%80%E7%82%B9%E5%88%86%E6%9E%90%E5%92%8C%E5%BB%B6%E4%BC%B8"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3A//www.leavesongs.com/PENETRATION/apache-mod-proxy-ssrf-cve-2021-40438.html&amp;title=Apache%20mod_proxy%20SSRF%EF%BC%88CVE-2021-40438%EF%BC%89%E7%9A%84%E4%B8%80%E7%82%B9%E5%88%86%E6%9E%90%E5%92%8C%E5%BB%B6%E4%BC%B8"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https%3A//www.leavesongs.com/PENETRATION/apache-mod-proxy-ssrf-cve-2021-40438.html&amp;title=Apache%20mod_proxy%20SSRF%EF%BC%88CVE-2021-40438%EF%BC%89%E7%9A%84%E4%B8%80%E7%82%B9%E5%88%86%E6%9E%90%E5%92%8C%E5%BB%B6%E4%BC%B8"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https%3A//www.leavesongs.com/PENETRATION/apache-mod-proxy-ssrf-cve-2021-40438.html&amp;name=Apache%20mod_proxy%20SSRF%EF%BC%88CVE-2021-40438%EF%BC%89%E7%9A%84%E4%B8%80%E7%82%B9%E5%88%86%E6%9E%90%E5%92%8C%E5%BB%B6%E4%BC%B8&amp;description="><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>
    </div>
  </div>

  <div class="container-md">
    <div class="article row justify-content-center min-height">
      <div class="col-lg-8 col-md-10 col-sm-12">
        <article itemscope itemtype="http://schema.org/BlogPosting">
          <header class="post-header">
            <h1 class="color-main h1 mb-0" itemprop="name headline">Apache mod_proxy SSRF（CVE-2021-40438）的一点分析和延伸</h1>
            <div class="meta">
              <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
                <span itemprop="name">phithon</span>
              </span>

              <div class="postdate">
                <time datetime="2021年10月18日 10:05" itemprop="datePublished">
                  2021 十月 18 10:05
                </time>
              </div>

              <div class="article-tag">
                阅读：43709
              </div>

              
                <div class="article-tag">
                  <i class="fa fa-bookmark"></i>
                  <a class="tag-link" href="../sort/PENETRATION.html">网络安全</a>
                </div>
              

              
                <div class="article-tag">
                  <i class="fa fa-tag"></i>
                  
                    <a class="tag-link" href="../tag/mod_proxy.html">mod_proxy</a>,
                  
                  
                    <a class="tag-link" href="../tag/ssrf%E6%BC%8F%E6%B4%9E.html">ssrf漏洞</a>,
                  
                  
                    <a class="tag-link" href="../tag/apache.html">apache</a>
                  
                </div>
              
            </div>
          </header>
          <div class="content" itemprop="articleBody">
            <p>周五晚上开始学习Apache HTTP Server（后文简称为Apache）mod_proxy的SSRF漏洞（CVE-2021-40438），并在星球简单介绍了一下编译、调试Apache服务器的方法，今天继续深入分析一下这个漏洞的成因，以及一些延伸的问题研究。</p>
<p>我很久不发漏洞分析了，因为不是自己挖的漏洞，我自己的思考其实是不够的，再加上很多出漏洞的软件我都没用过，也更谈不上深入的理解，很容易落俗套变成流水账；另外这些年网友们也很积极，不缺我的一篇漏洞分析文章，所以我就写的少了。不过最近Apache HTTP Server出的几个漏洞，还是值得分析一下。</p>
<p>另外，阅读本文前，建议按照我在这两篇帖子里发的方式<a href="https://t.zsxq.com/RvfmEu3">https://t.zsxq.com/RvfmEu3</a>、<a href="https://t.zsxq.com/7qNfeie">https://t.zsxq.com/7qNfeie</a>下载好apr、apr-util、apache的源码并编译，便于后续调试以理解文章。</p>
<h2 id="0x01-apache-module"><a class="toclink" href="#0x01-apache-module">0x01 Apache Module综述</a></h2>
<p>如果我们要部署一个PHP运行环境，且将Apache作为Web应用服务器，那么常用的有三种方法：</p>
<ol>
<li>Apache以CGI的形式运行PHP脚本</li>
<li>PHP以mod_php的方式作为Apache的一个模块运行</li>
<li>PHP以FPM的方式运行为独立服务，Apache使用mod_proxy_fcgi模块作为反代服务器将请求代理给PHP-FPM</li>
</ol>
<p>第一种方式比较古老，性能较差，基本已经淘汰；第二种方式在Apache环境下使用较广，配置最为简单；第三种方法也有较大用户体量，不过Apache仅作为一个中间的反代服务器，更多新的用户会选择使用性能更好的Nginx替代。</p>
<p>这其中，第三种方法使用的mod_proxy_fcgi就是本文主角mod_proxy模块的一个子模块。mod_proxy是Apache服务器中用于反代后端服务的一个模块，而它拥有数个不同功能的子模块，分别用于支持不同通信协议的后端，比如常见的有：</p>
<ul>
<li>mod_proxy_fcgi 用于反代后端是fastcgi协议的服务，比如php-fpm</li>
<li>mod_proxy_http 用于反代后端是http、https协议的服务</li>
<li>mod_proxy_uwsgi 用于反代后端是uwsgi协议的服务，主要针对uWSGI</li>
<li>mod_proxy_ajp 用于反代后端是ajp协议的服务，主要针对Tomcat</li>
<li>mod_proxy_ftp 用于反代后端是ftp协议的服务</li>
</ul>
<p>除去mod_proxy_fcgi用于反代PHP，我们在使用Node.js、Python等脚本语言编写的应用也常常会使用mod_proxy_http作为一层反代服务器，这样中间层可以做ACL、静态文件服务等。</p>
<p>这次的SSRF漏洞是出在mod_proxy这个模块中的，我们就来从代码的层面分析一下它的原理是什么，究竟影响有多大。</p>
<h2 id="0x02"><a class="toclink" href="#0x02">0x02 漏洞原理分析</a></h2>
<p>《<a href="https://firzen.de/building-a-poc-for-cve-2021-40438">Building a POC for CVE-2021-40438</a>》这篇文章中提到了这个漏洞的复现方法：当目标环境使用了mod_proxy做反向代理，比如<code>ProxyPass / "http://localhost:8000/"</code>，此时通过请求<code>http://target/?unix:{'A'*5000}|http://example.com/</code>即可向<code>http://example.com</code>发送请求，造成一个SSRF攻击。</p>
<p>这里面，Apache代码中犯得错误是在modules/proxy/proxy_util.c的fix_uds_filename函数：</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/*</span>
<span class="cm"> * In the case of the reverse proxy, we need to see if we</span>
<span class="cm"> * were passed a UDS url (eg: from mod_proxy) and adjust uds_path</span>
<span class="cm"> * as required.  </span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fix_uds_filename</span><span class="p">(</span><span class="n">request_rec</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">url</span><span class="p">)</span> 
<span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr2</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span> <span class="o">||</span> <span class="o">!</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;proxy:&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span><span class="n">ptr2</span> <span class="o">=</span> <span class="n">ap_strcasestr</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;unix:&quot;</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">ap_strchr</span><span class="p">(</span><span class="n">ptr2</span><span class="p">,</span> <span class="sc">&#39;|&#39;</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">apr_uri_t</span> <span class="n">urisock</span><span class="p">;</span>
        <span class="n">apr_status_t</span> <span class="n">rv</span><span class="p">;</span>
        <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="n">apr_uri_parse</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="n">ptr2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">urisock</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="n">APR_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">char</span> <span class="o">*</span><span class="n">rurl</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
            <span class="kt">char</span> <span class="o">*</span><span class="n">sockpath</span> <span class="o">=</span> <span class="n">ap_runtime_dir_relative</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="n">urisock</span><span class="p">.</span><span class="n">path</span><span class="p">);</span>
            <span class="n">apr_table_setn</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">notes</span><span class="p">,</span> <span class="s">&quot;uds_path&quot;</span><span class="p">,</span> <span class="n">sockpath</span><span class="p">);</span>
            <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="n">apr_pstrdup</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="n">rurl</span><span class="p">);</span> <span class="cm">/* so we get the scheme for the uds */</span>
            <span class="cm">/* r-&gt;filename starts w/ &quot;proxy:&quot;, so add after that */</span>
            <span class="n">memmove</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">filename</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="n">rurl</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">rurl</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
            <span class="n">ap_log_rerror</span><span class="p">(</span><span class="n">APLOG_MARK</span><span class="p">,</span> <span class="n">APLOG_TRACE2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span>
                    <span class="s">&quot;*: rewrite of url due to UDS(%s): %s (%s)&quot;</span><span class="p">,</span>
                    <span class="n">sockpath</span><span class="p">,</span> <span class="o">*</span><span class="n">url</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="sc">&#39;|&#39;</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Apache在配置反代的后端服务器时，有两种情况：</p>
<ul>
<li>直接使用某个协议反代到某个IP和端口，比如<code>ProxyPass / "http://localhost:8080"</code></li>
<li>使用某个协议反代到unix套接字，比如<code>ProxyPass / "unix:/var/run/www.sock|http://localhost:8080/"</code></li>
</ul>
<p>第一种情况比较好理解，第二种情况的设计我觉得不是很好，相当于让用户可以使用一个Apache自创的写法来配置后端地址。那么这时候就会涉及到parse的过程，需要将这种自创的语法转换成能兼容正常socket连接的结构，而fix_uds_filename函数就是做这个事情的。</p>
<p>使用字符串文法来表示多种含义的方式通常暗藏一些漏洞，比如这里，进入这个if语句需要满足三个条件：</p>
<ul>
<li><code>r-&gt;filename</code>的前6个字符等于<code>proxy:</code></li>
<li><code>r-&gt;filename</code>的字符串中含有关键字<code>unix:</code></li>
<li><code>unix:</code>关键字后的部分含有字符<code>|</code></li>
</ul>
<p>当满足这三个条件后，将<code>unix:</code>后面的内容进行解析，设置成<code>uds_path</code>的值；将字符<code>|</code>后面的内容，设置成<code>rurl</code>的值。</p>
<p>举个例子，前面介绍中的<code>ProxyPass / "unix:/var/run/www.sock|http://localhost:8080/"</code>，在解析完成后，<code>uds_path</code>的值等于<code>/var/run/www.sock</code>，<code>rurl</code>的值等于<code>http://localhost:8080/</code>。</p>
<p>看到这里其实都没有什么问题，那么我们肯定会思考，<code>r-&gt;filename</code>是从哪来的，用户可控吗，为什么？</p>
<p>这时就要说到另一个函数，<code>proxy_hook_canon_handler</code>，这个函数用于注册canon handler，比如：</p>
<p><a href="../media/attachment/2021/10/18/680efae6-3053-462f-845b-fd7ab0031fb4.png"><img alt="image-20211017234354615.png" src="../media/attachment/2021/10/18/680efae6-3053-462f-845b-fd7ab0031fb4.1b0edecec059.png" /></a></p>
<p>可以看到，每一个<code>mod_proxy_xxx</code>都会注册一个自己的canon handler，canon handler会在反代的时候被调用，用于告诉Apache主程序它应该把这个请求交给哪个处理方法来处理。</p>
<p>比如，我们看到<code>mod_proxy_http</code>的<code>proxy_http_canon</code>函数：</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span> <span class="kt">int</span> <span class="nf">proxy_http_canon</span><span class="p">(</span><span class="n">request_rec</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">url</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="c1">// first part</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">strncasecmp</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s">&quot;http:&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">url</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
        <span class="n">scheme</span> <span class="o">=</span> <span class="s">&quot;http&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncasecmp</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s">&quot;https:&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">url</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">;</span>
        <span class="n">scheme</span> <span class="o">=</span> <span class="s">&quot;https&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">DECLINED</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">port</span> <span class="o">=</span> <span class="n">def_port</span> <span class="o">=</span> <span class="n">ap_proxy_port_of_scheme</span><span class="p">(</span><span class="n">scheme</span><span class="p">);</span>

    <span class="c1">// second part</span>
    <span class="n">ap_proxy_canon_netloc</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">url</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="p">);</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">proxyreq</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">default</span><span class="o">:</span> <span class="cm">/* wtf are we doing here? */</span>
    <span class="k">case</span> <span class="nl">PROXYREQ_REVERSE</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">apr_table_get</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">notes</span><span class="p">,</span> <span class="s">&quot;proxy-nocanon&quot;</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">url</span><span class="p">;</span>   <span class="cm">/* this is the raw path */</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">ap_proxy_canonenc</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">url</span><span class="p">),</span>
                                     <span class="n">enc_path</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">proxyreq</span><span class="p">);</span>
            <span class="n">search</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">PROXYREQ_PROXY</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">url</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">path</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HTTP_BAD_REQUEST</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">!=</span> <span class="n">def_port</span><span class="p">)</span>
        <span class="n">apr_snprintf</span><span class="p">(</span><span class="n">sport</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sport</span><span class="p">),</span> <span class="s">&quot;:%d&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
    <span class="k">else</span>
        <span class="n">sport</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ap_strchr_c</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* if literal IPv6 address */</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">apr_pstrcat</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="s">&quot;[&quot;</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="s">&quot;]&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// fourth part</span>
    <span class="n">r</span><span class="o">-&gt;</span><span class="n">filename</span> <span class="o">=</span> <span class="n">apr_pstrcat</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="s">&quot;proxy:&quot;</span><span class="p">,</span> <span class="n">scheme</span><span class="p">,</span> <span class="s">&quot;://&quot;</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">sport</span><span class="p">,</span>
            <span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="p">(</span><span class="n">search</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;?&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">search</span><span class="p">)</span> <span class="o">?</span> <span class="nl">search</span> <span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">OK</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>这个函数中有三个主要的部分，第一部分检查了配置中的url的开头是不是<code>http:</code>或<code>https:</code>，如果不是，说明这个请求不该由<code>mod_proxy_http</code>模块处理，后续的过程跳过；第二部分，用各种方式获取到scheme、host、port、path、search等几个URL的组成变量；第三部分，拼接<code>proxy:</code>、scheme、<code>://</code>、host、sport、<code>/</code>、path、search，成为一个字符串，赋值给<code>r-&gt;filename</code>。</p>
<p>这里面，scheme、host、sport来自于配置文件中配置的ProxyPass，而path、search来自于用户发送的数据包。也就是说，<code>r-&gt;filename</code>中的后半部分是用户可控的。</p>
<p>那我们回看前面的<code>fix_uds_filename</code>函数，它在<code>r-&gt;filename</code>中查找关键字<code>unix:</code>，并将这个关键字后面直到<code>|</code>的部分作为unix套接字地址，而将<code>|</code>后面的部分作为反代的后端地址。</p>
<p>我们可以通过请求的path或者search来控制这两个部分，控制了反代的后端地址，这也就是为什么这里会出现SSRF的原因。</p>
<h2 id="0x03"><a class="toclink" href="#0x03">0x03 限制绕过</a></h2>
<p>当然，这里面有一个问题，那就是Apache在正常情况下，因为识别到了unix套接字，所以会把用户请求发送给这个本地文件套接字，而不是后端URL。</p>
<p>可以来做个测试，我们发送这样一个请求：</p>
<div class="codehilite"><pre><span></span><code><span class="nf">GET</span> <span class="nn">/?unix:/var/run/test.sock|http://example.com/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="err">...</span>
</code></pre></div>

<p>此时会得到一个503错误，错误日志会反馈这样的结果：</p>
<div class="codehilite"><pre><span></span><code><span class="p">[</span><span class="n">Mon</span> <span class="n">Oct</span> <span class="mi">18</span> <span class="mi">00</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mf">38.634795</span> <span class="mi">2021</span><span class="p">]</span> <span class="p">[</span><span class="n">proxy</span><span class="p">:</span><span class="n">error</span><span class="p">]</span> <span class="p">[</span><span class="n">pid</span> <span class="mi">782180</span><span class="p">:</span><span class="n">tid</span> <span class="mi">140737306797824</span><span class="p">]</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="n">No</span> <span class="n">such</span> <span class="n">file</span> <span class="ow">or</span> <span class="n">directory</span><span class="p">:</span> <span class="n">AH02454</span><span class="p">:</span> <span class="n">HTTP</span><span class="p">:</span> <span class="n">attempt</span> <span class="n">to</span> <span class="n">connect</span> <span class="n">to</span> <span class="n">Unix</span> <span class="n">domain</span> <span class="n">socket</span> <span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">test</span><span class="o">.</span><span class="n">sock</span> <span class="p">(</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">1.1</span><span class="p">)</span> <span class="n">failed</span>
<span class="p">[</span><span class="n">Mon</span> <span class="n">Oct</span> <span class="mi">18</span> <span class="mi">00</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mf">38.634875</span> <span class="mi">2021</span><span class="p">]</span> <span class="p">[</span><span class="n">proxy_http</span><span class="p">:</span><span class="n">error</span><span class="p">]</span> <span class="p">[</span><span class="n">pid</span> <span class="mi">782180</span><span class="p">:</span><span class="n">tid</span> <span class="mi">140737306797824</span><span class="p">]</span> <span class="p">[</span><span class="n">client</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.142</span><span class="p">:</span><span class="mi">59696</span><span class="p">]</span> <span class="n">AH01114</span><span class="p">:</span> <span class="n">HTTP</span><span class="p">:</span> <span class="n">failed</span> <span class="n">to</span> <span class="n">make</span> <span class="n">connection</span> <span class="n">to</span> <span class="n">backend</span><span class="p">:</span> <span class="n">httpd</span><span class="o">-</span><span class="n">UDS</span>
</code></pre></div>

<p>找不到unix套接字<code>/var/run/test.sock</code>，这是当然。</p>
<p>我们不能让他把请求发送到unix套接字上，而是发送给我们需要的<code>|</code>后面的地址。</p>
<p>国外那位作者给出了一个非常巧妙的方法，在<code>fix_uds_filename</code>函数中，unix套接字的地址来自于下面这两行代码：</p>
<div class="codehilite"><pre><span></span><code><span class="kt">char</span> <span class="o">*</span><span class="n">sockpath</span> <span class="o">=</span> <span class="n">ap_runtime_dir_relative</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="n">urisock</span><span class="p">.</span><span class="n">path</span><span class="p">);</span>
<span class="n">apr_table_setn</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">notes</span><span class="p">,</span> <span class="s">&quot;uds_path&quot;</span><span class="p">,</span> <span class="n">sockpath</span><span class="p">);</span>
</code></pre></div>

<p>如果这里<code>ap_runtime_dir_relative</code>函数返回值是null，则后面获取<code>uds_path</code>时将不会使用unix套接字地址，而变成普通的TCP连接：</p>
<div class="codehilite"><pre><span></span><code><span class="n">uds_path</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">worker</span><span class="o">-&gt;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">uds_path</span> <span class="o">?</span> <span class="n">worker</span><span class="o">-&gt;</span><span class="n">s</span><span class="o">-&gt;</span><span class="nl">uds_path</span> <span class="p">:</span> <span class="n">apr_table_get</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">notes</span><span class="p">,</span> <span class="s">&quot;uds_path&quot;</span><span class="p">));</span>
<span class="k">if</span> <span class="p">(</span><span class="n">uds_path</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">uds_path</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* use (*conn)-&gt;pool instead of worker-&gt;cp-&gt;pool to match lifetime */</span>
        <span class="n">conn</span><span class="o">-&gt;</span><span class="n">uds_path</span> <span class="o">=</span> <span class="n">apr_pstrdup</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="n">uds_path</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// ...</span>
    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">hostname</span> <span class="o">=</span> <span class="s">&quot;httpd-UDS&quot;</span><span class="p">;</span>
    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">else</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">hostname</span> <span class="o">=</span> <span class="n">apr_pstrdup</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="n">uri</span><span class="o">-&gt;</span><span class="n">hostname</span><span class="p">);</span>
    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">uri</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>

<p>那么如何让<code>ap_runtime_dir_relative</code>的返回值是null？<code>ap_runtime_dir_relative</code>函数最后引用了apr库中的<code>apr_filepath_merge</code>函数，它的主要作用就是路径的join，用于处理相对路径、绝对路径、<code>../</code>连接。</p>
<p>这个函数中，当待join的两段路径长度+4大于<code>APR_PATH_MAX</code>，也就是4096的时候，则函数会返回一个路径过长的状态码，导致最后unix套接字的值是null：</p>
<div class="codehilite"><pre><span></span><code><span class="n">rootlen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">rootpath</span><span class="p">);</span>
<span class="n">maxlen</span> <span class="o">=</span> <span class="n">rootlen</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">addpath</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* 4 for slashes at start, after</span>
<span class="cm">                                             * root, and at end, plus trailing</span>
<span class="cm">                                             * null */</span>
<span class="k">if</span> <span class="p">(</span><span class="n">maxlen</span> <span class="o">&gt;</span> <span class="n">APR_PATH_MAX</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">APR_ENAMETOOLONG</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>也就是说，我们只需要在<code>unix:</code>与<code>|</code>之间传入内容长度大概超过4092的字符串，就能构造出<code>uds_path</code>为null的结果，让Apache不再发送请求给unix套接字。</p>
<p>最后，这样构造出的请求成功触发SSRF漏洞：</p>
<p><a href="../media/attachment/2021/10/18/63c7b37a-9efc-4fa3-8536-82651cfc562a.png"><img alt="image-20211018010400594.png" src="../media/attachment/2021/10/18/63c7b37a-9efc-4fa3-8536-82651cfc562a.a720503c487f.png" /></a></p>
<p>Apache官方对这个漏洞的修复也比较简单，因为用户只能控制<code>r-&gt;filename</code>的后半部分，而前半部分<code>proxy:{scheme}://{host}{sport}/</code>来自于配置文件，所以最新版改成检查其开头是不是<code>proxy:unix:</code>，这一部分用户无法控制。</p>
<h2 id="0x04-mod_proxy_fcgi"><a class="toclink" href="#0x04-mod_proxy_fcgi">0x04 mod_proxy_fcgi是否存在漏洞？</a></h2>
<p>我们前文都以mod_proxy_http作为例子来研究，而在Apache+PHP环境下，mod_proxy_fcgi的使用频率更高，那么它是否也会被SSRF漏洞影响呢？</p>
<p>这个漏洞出现在modules/proxy/proxy_util.c的fix_uds_filename函数，理论上是mod_proxy的漏洞，那么它的子模块应该都会被影响，但这个漏洞中有一个很关键的变量是<code>r-&gt;filename</code>，他是否可控决定了后面的利用是否可以成功。</p>
<p>我们看一下mod_proxy_fcgi的canon函数：</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span> <span class="kt">int</span> <span class="nf">proxy_fcgi_canon</span><span class="p">(</span><span class="n">request_rec</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">url</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="n">sport</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">err</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
    <span class="n">apr_port_t</span> <span class="n">port</span><span class="p">,</span> <span class="n">def_port</span><span class="p">;</span>
    <span class="n">fcgi_req_config_t</span> <span class="o">*</span><span class="n">rconf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pathinfo_type</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ap_cstr_casecmpn</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s">&quot;fcgi:&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">url</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">DECLINED</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// ...</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">apr_table_get</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">notes</span><span class="p">,</span> <span class="s">&quot;proxy-nocanon&quot;</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">url</span><span class="p">;</span>   <span class="cm">/* this is the raw path */</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">ap_proxy_canonenc</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">url</span><span class="p">),</span> <span class="n">enc_path</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                             <span class="n">r</span><span class="o">-&gt;</span><span class="n">proxyreq</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">path</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HTTP_BAD_REQUEST</span><span class="p">;</span>

    <span class="n">r</span><span class="o">-&gt;</span><span class="n">filename</span> <span class="o">=</span> <span class="n">apr_pstrcat</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="s">&quot;proxy:fcgi://&quot;</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">sport</span><span class="p">,</span> <span class="s">&quot;/&quot;</span><span class="p">,</span>
                              <span class="n">path</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>

<p>可见，这里的<code>r-&gt;filename</code>等于<code>proxy:fcgi://{host}{sport}/{path}</code>，相比于mod_proxy_http少了search。不过，path仍然是用户可以控制的，我们可以尝试发送这样的数据包：</p>
<div class="codehilite"><pre><span></span><code><span class="nf">GET</span> <span class="nn">/unix:testtest|http://example.com/1.php</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="err">...</span>
</code></pre></div>

<p>经过调试可见，path中的<code>|</code>被<code>ap_proxy_canonenc</code>函数编码成了%7C：</p>
<p><a href="../media/attachment/2021/10/18/a3282ae9-7552-4098-a555-1b255796692d.png"><img alt="image-20211018013708745.png" src="../media/attachment/2021/10/18/a3282ae9-7552-4098-a555-1b255796692d.59af18316786.png" /></a></p>
<p>没有<code>|</code>，后面也就无法完成SSRF利用了。</p>
<h2 id="0x05"><a class="toclink" href="#0x05">0x05 哪些模块受到影响</a></h2>
<p>那么，我们其实可以认为，如果<code>r-&gt;filename</code>有部分可控，且可控的部分没有被编码（不是path），这个模块就会受到SSRF漏洞的影响。</p>
<p>对这个结论我没有逐一测试考证，我仅挑选另一个较为常用的模块mod_proxy_ajp来复现漏洞。</p>
<p>mod_proxy_ajp是用于反代Tomcat的一个Apache模块，Tomcat在8.5.51版本以前默认会开启两个端口8080和8009，分别对应HTTP协议和AJP协议。HTTP协议好理解，AJP协议是一个二进制协议，通信协议相比起来效率更高。所以以前很多运维人员会将Tomcat假设在Apache之后，然后二者之间使用AJP协议通信。</p>
<blockquote>
<p>Tomcat 8.5.51之后的版本受到<a href="https://www.chaitin.cn/en/ghostcat">Ghostcat漏洞</a>影响不再默认开放8009端口。</p>
</blockquote>
<p>Apache下有两个模块能实现AJP的反代通信：</p>
<ul>
<li>mod_proxy_ajp 这就是mod_proxy的一个子模块，由Apache HTTPd官方维护</li>
<li>mod_jk 这是Tomcat官方维护的一个Apache模块，更加出名用户也更多</li>
</ul>
<p>由于mod_jk不是用mod_proxy的代码，所以不受到影响，我们今天仅测试mod_proxy_ajp。</p>
<p>简单部署一个开放8009端口的Tomcat服务器，并配置好mod_proxy_ajp进行调试，可见其<code>proxy_ajp_canon</code>函数<code>r-&gt;filename</code>中是包含search的：</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span> <span class="kt">int</span> <span class="nf">proxy_ajp_canon</span><span class="p">(</span><span class="n">request_rec</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">url</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="n">sport</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">search</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">err</span><span class="p">;</span>
    <span class="n">apr_port_t</span> <span class="n">port</span><span class="p">,</span> <span class="n">def_port</span><span class="p">;</span>

    <span class="cm">/* ap_port_of_scheme() */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">strncasecmp</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s">&quot;ajp:&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">url</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">DECLINED</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// ...</span>
    <span class="n">r</span><span class="o">-&gt;</span><span class="n">filename</span> <span class="o">=</span> <span class="n">apr_pstrcat</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="s">&quot;proxy:ajp://&quot;</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">sport</span><span class="p">,</span>
                              <span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="p">(</span><span class="n">search</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;?&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
                              <span class="p">(</span><span class="n">search</span><span class="p">)</span> <span class="o">?</span> <span class="nl">search</span> <span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">OK</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>那么按照我们的预测，这里也会存在SSRF漏洞。果然测试成功：</p>
<p><a href="../media/attachment/2021/10/18/d5946673-06ae-42d5-8516-2ae2e57eb2d1.png"><img alt="image-20211018020259288.png" src="../media/attachment/2021/10/18/d5946673-06ae-42d5-8516-2ae2e57eb2d1.ad31e6993dbd.png" /></a></p>
<p>那么，mod_proxy_http2、mod_proxy_balancer、mod_proxy_wstunnel等这些模块也会受到影响，而mod_proxy_uwsgi、mod_proxy_scgi等模块不受影响。我没有严格验证，有兴趣的同学可以自己下去调试一下，也许还能找到绕过方法。</p>
<h2 id="0x06"><a class="toclink" href="#0x06">0x06 几个常见问题和总结</a></h2>
<p>一个大家问的比较多的问题：这个SSRF漏洞是否能够POST？答案是肯定的，理解了原理的同学肯定能明白，我们实际上是控制了反向代理的目标服务器地址。既然是反向代理，那么实际上用户请求的大部分原始数据都会被直接转发给后端，所以，我们只需要发送POST请求，即可让执行POST的SSRF，比如：</p>
<p><a href="../media/attachment/2021/10/18/ea559ecd-09e5-4226-b5a0-dd458b0c9ff6.png"><img alt="image-20211018021607377.png" src="../media/attachment/2021/10/18/ea559ecd-09e5-4226-b5a0-dd458b0c9ff6.ce85e5784b24.png" /></a></p>
<p>另一个，这个SSRF漏洞是否可以打本地的unix socket？答案是肯定的。原本这个漏洞的第一请求目标就是本地的unix套接字，我们使用4092个超长search绕过了这个限制让他可以打任意远程地址，只要让它回归原本的方法就可以打本地的unix套接字了：</p>
<p><a href="../media/attachment/2021/10/18/c41876eb-afce-40a6-8c3d-99c9ffaad80b.png"><img alt="image-20211018021945460.png" src="../media/attachment/2021/10/18/c41876eb-afce-40a6-8c3d-99c9ffaad80b.79f10df7d599.png" /></a></p>
<p>打本地unix套接字的好处是可以攻击类似于Docker、Supervisor这样的本地服务。</p>
<p>最后一个问题，这个SSRF漏洞是否可以攻击一些非HTTP协议的服务？答案也是肯定的。TCP是一个数据流，即使我们打出的数据包前面有HTTP头，这并不影响后续正常的满足二进制协议的数据流的发送与接收。不过有一个例外情况，如果目标服务有一些特殊的操作，类似于高版本redis读取到一些特殊的HTTP数据段就断开TCP连接这样的操作，那么可能需要进行一些额外绕过了。</p>
<p>总结一下，这个SSRF漏洞的本质是Apache在解析反代服务URL的时候，由于对<code>unix:</code>位置要求不严格，导致用户的输入可以控制反代的逻辑，最终导致反代URL被控制，造成SSRF漏洞。</p>
<p>参考链接：</p>
<ul>
<li><a href="https://firzen.de/building-a-poc-for-cve-2021-40438">https://firzen.de/building-a-poc-for-cve-2021-40438</a></li>
<li><a href="https://t.zsxq.com/RvfmEu3">https://t.zsxq.com/RvfmEu3</a></li>
<li><a href="https://t.zsxq.com/7qNfeie">https://t.zsxq.com/7qNfeie</a></li>
</ul>
          </div>
        </article>

        
          <h1 class="h1 color-main">赞赏</h1>
          <div class="zan text-center">
            <p>喜欢这篇文章？打赏1元</p>
            <p class="m-0"><img src="../static/wx.jpg" width="280" alt=""></p>
          </div>
        

        <div id="reply-list">
          <h1 class="h1 color-main">评论</h1>
          
            
              <div class="flex mb-2" id="comment-3709">
                <div class="gravatar">
                  <img src="../static/placeholder.jpg" width="40px" height="40px" alt="">
                </div>
                <div class="ps-2">
                  <p class="comment-meta title">
                    <a href="" target="_blank" rel="nofollow noopener">怎么可以怎么6</a>
                    <time datetime="2021年11月1日 16:30" itemprop="datePublished">
                      2021 十一月 01 16:30
                    </time>
                    <a href="javascript:reply_to('3709', '%E6%80%8E%E4%B9%88%E5%8F%AF%E4%BB%A5%E6%80%8E%E4%B9%886')">回复</a>
                  </p>
                  <p class="comment-meta">按理说这个漏洞应该影响很广啊。。。。。</p>
                </div>
              </div>
              
            
          
        </div>

        

        <form method="post" enctype="multipart/form-data" action="#reply" id="reply" class="mb-4">
          <div class="container-fluid px-0">
            
            <div class="row">
              <div class="col">
                <textarea name="content" cols="40" rows="6" required id="id_content">
</textarea>
              </div>
            </div>
            <div class="row gx-2">
              <div class="col-4">
                <input type="text" name="nickname" placeholder="昵称" maxlength="64" required id="id_nickname">
              </div>
              <div class="col-4">
                <input type="text" name="email" placeholder="邮箱（可留空）" maxlength="254" id="id_email">
              </div>
              <div class="col-4">
                <input type="text" name="url" placeholder="链接（可留空）" maxlength="200" id="id_url">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-4">
              <div class="row gx-2" style="margin-top: 8px"><div class="col-6"><input autocomplete="off" id="id_captcha_1" name="captcha_1" type="text" placeholder="验证码" /> <input id="id_captcha_0" name="captcha_0" type="hidden" value="cae031de106948b9c97a1ee4d512f16ed191b437" />
</div><div class="col-6">
<img src="../captcha/image/cae031de106948b9c97a1ee4d512f16ed191b437/index.png" alt="captcha" class="captcha" /></div></div>
            </div>
          </div>
          <div class="row">
            <div class="col">
              <input type="submit" class="ui-button ui-button-sgreen" value="提交">
            </div>
          </div>
          <input type="hidden" name="archive" value="468" id="id_archive">
          <input type="hidden" name="parent" id="id_parent">
          <input type="hidden" name="csrfmiddlewaretoken" value="9Wn1YvCWivBQbg5K9vLmLYB7DUnxMFEMVuLSwAdFGRPzJOT8bwI7IrEcYhEIlhQ4">
        </form>
      </div>
    </div>
    <div class="row justify-content-center">
      <div class="col-lg-7 col-md-10 col-sm-12">
        <footer class="footer mx-auto">
  <div class="footer-left">
    Copyright &copy; 2023 Powered by talkbook
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <li><a href="../index.html">首页</a></li>
        <li><a href="../feed/index.rss" target="_blank">RSS订阅</a></li>
        <li><a href="http://weibo.com/101yx" target="_blank">微博</a></li>
        <li><a href="https://github.com/phith0n" target="_blank">项目</a></li>
        <li><a href="../index.html">更换模板</a></li>
      </ul>
    </nav>
  </div>
</footer>
      </div>
    </div>
  </div>

<script src="https://cdn.staticfile.org/jquery/2.2.4/jquery.min.js"></script>
<script src="../static/cactus/js/main%EF%B9%96v=2021102502.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-FF5KPQ1CZ6"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-FF5KPQ1CZ6');
</script>

  <script src="https://cdn.staticfile.org/fancybox/2.1.7/js/jquery.fancybox.min.js"></script>
  <script>
      $(document).ready(function () {
          $(".content a").each(function (i, e) {
              if (e.host != 'www.leavesongs.com') {
                  e.target = '_blank';
              }
          });
          $(".content img").each(function (i, e) {
              if (e.parentNode.tagName.toUpperCase() != 'A') {
                  $(e).wrap('<a href="' + escapeHtml(e.src) + '" class="fancybox"></a>');
              } else {
                  $(e.parentNode).addClass('fancybox');
              }
          });
          $('.fancybox').fancybox();
      })
  </script>

</body>
</html>