

<html class="no-js">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="keywords" content="" />
    <meta name="description" content="phith0n的小站，长期存在与分享关于网络安全与各种编程的原创文章。" />
    <title>Fastcgi协议分析 &amp;&amp; PHP-FPM未授权访问漏洞 &amp;&amp; Exp编写 | 离别歌</title>
    <link rel="alternate" type="application/atom+xml" href="../feed/index.rss" title="离别歌" />
    <link href="../static/deep/css/base.css" rel="stylesheet" type="text/css" />
    <link href="../static/deep/css/style.css" rel="stylesheet" type="text/css" />
    <link rel="shortcut icon" href="../static/deep/images/favicon.ico" />
    
<style>div.row .col-xs-4 {
  float: left;
  margin-left: 4px;
}
div.row .col-xs-4 img {
  margin-left: 5px;
}
</style>
<link href="https://cdn.staticfile.org/fancybox/2.1.7/css/jquery.fancybox.min.css" rel="stylesheet">
<link rel="stylesheet" href="../static/deep/css/code.css">

</head>
<body>
<!--[if lt IE 8]>
    <div class="browsehappy" role="dialog">当前网页 <strong>不支持</strong> 你正在使用的浏览器. 为了正常的访问, 请 <a href="http://browsehappy.com/">升级你的浏览器</a>.</div>
<![endif]-->
<div id="header">
    <div class="container">
        <h1 class="h1-title">
            <a href="../index.html">
               <img src="../static/deep/images/logo.png" alt="离别歌" />
            </a>
        </h1>
        <div id="nav">
        <input type="checkbox" id="button">
        <label for="button" onclick>菜单</label>
        
        <ul>
            
            <li class="item ">
                <a href="../index.html" >首页</a>
            </li>
            
            <li class="item ">
                <a href="../list/index.html" >文章</a>
            </li>
            
            <li class="item ">
                <a href="../other/tinger.html" >关于</a>
            </li>
            
            <li class="item ">
                <a href="../other/friends-link.html" >友链</a>
            </li>
            
            <li class="item ">
                <a href="https://github.com/phith0n" target="_blank" >项目</a>
            </li>
            
            <li class="item ">
                <a href="https://www.leavesongs.com/PENETRATION/code-auditor-secret-group.html" target="_blank" >代码审计</a>
            </li>
            
        </ul>
        
        </div>
    </div>
</div>

<div class="banner-bar">
    <div class="container">
        <div class="col-12 columns">
            <div class="place">
                <a href="../index.html">首页</a>
                &raquo;
                
                网络安全 &raquo; <a href="fastcgi-and-php-fpm.html">Fastcgi协议分析 &amp;&amp; PHP-FPM未授权访问漏洞 &amp;&amp; Exp编写</a>
                
            </div>
        </div>
    </div>
</div>
<div class="container">
    <div class="col-11 columns" id="mainbody" role="main">
        <div class="post-single type-post">
            <h1 class="article-h1">Fastcgi协议分析 &amp;&amp; PHP-FPM未授权访问漏洞 &amp;&amp; Exp编写</h1>
            <div class="details-up">
  <span class="author">作者: phithon</span>
  
  <span class="category">分类: <a href="../sort/PENETRATION.html">网络安全</a></span>
  
  <span class="date">时间: 2017-4-25 22:46</span>
  <span class="comments-top" itemprop="interactionCount">评论：<a itemprop="discussionUrl" href="#reply-list">42条评论</a></span>
  <span class="comments-top" itemprop="interactionCount">浏览：<a itemprop="discussionUrl" href="fastcgi-and-php-fpm.html">56556人看过</a></span>
  
  <span class="date">标签:
    
        <a href="../tag/php-fpm.html">php-fpm</a>
    
        <a href="../tag/fastcgi.html">fastcgi</a>
    
  </span>
  
</div>
            <div class="entry">
                <p>搭过php相关环境的同学应该对fastcgi不陌生，那么fastcgi究竟是什么东西，为什么nginx可以通过fastcgi来对接php？</p>
<h2 id="fastcgi-record"><a class="toclink" href="#fastcgi-record">Fastcgi Record</a></h2>
<p>Fastcgi其实是一个通信协议，和HTTP协议一样，都是进行数据交换的一个通道。</p>
<p>HTTP协议是浏览器和服务器中间件进行数据交换的协议，浏览器将HTTP头和HTTP体用某个规则组装成数据包，以TCP的方式发送到服务器中间件，服务器中间件按照规则将数据包解码，并按要求拿到用户需要的数据，再以HTTP协议的规则打包返回给服务器。</p>
<p>类比HTTP协议来说，fastcgi协议则是服务器中间件和某个语言后端进行数据交换的协议。Fastcgi协议由多个record组成，record也有header和body一说，服务器中间件将这二者按照fastcgi的规则封装好发送给语言后端，语言后端解码以后拿到具体数据，进行指定操作，并将结果再按照该协议封装好后返回给服务器中间件。</p>
<p>和HTTP头不同，record的头固定8个字节，body是由头中的contentLength指定，其结构如下：</p>
<div class="codehilite"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="cm">/* Header */</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">version</span><span class="p">;</span> <span class="c1">// 版本</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">type</span><span class="p">;</span> <span class="c1">// 本次record的类型</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">requestIdB1</span><span class="p">;</span> <span class="c1">// 本次record对应的请求id</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">requestIdB0</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">contentLengthB1</span><span class="p">;</span> <span class="c1">// body体的大小</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">contentLengthB0</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">paddingLength</span><span class="p">;</span> <span class="c1">// 额外块大小</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reserved</span><span class="p">;</span> 

  <span class="cm">/* Body */</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">contentData</span><span class="p">[</span><span class="n">contentLength</span><span class="p">];</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">paddingData</span><span class="p">[</span><span class="n">paddingLength</span><span class="p">];</span>
<span class="p">}</span> <span class="n">FCGI_Record</span><span class="p">;</span>
</pre></div>


<p>头由8个uchar类型的变量组成，每个变量1字节。其中，<code>requestId</code>占两个字节，一个唯一的标志id，以避免多个请求之间的影响；<code>contentLength</code>占两个字节，表示body的大小。</p>
<p>语言端解析了fastcgi头以后，拿到<code>contentLength</code>，然后再在TCP流里读取大小等于<code>contentLength</code>的数据，这就是body体。</p>
<p>Body后面还有一段额外的数据（Padding），其长度由头中的paddingLength指定，起保留作用。不需要该Padding的时候，将其长度设置为0即可。</p>
<p>可见，一个fastcgi record结构最大支持的body大小是<code>2^16</code>，也就是65536字节。</p>
<h2 id="fastcgi-type"><a class="toclink" href="#fastcgi-type">Fastcgi Type</a></h2>
<p>刚才我介绍了fastcgi一个record中各个结构的含义，其中第二个字节<code>type</code>我没详说。</p>
<p><code>type</code>就是指定该record的作用。因为fastcgi一个record的大小是有限的，作用也是单一的，所以我们需要在一个TCP流里传输多个record。通过<code>type</code>来标志每个record的作用，用<code>requestId</code>作为同一次请求的id。</p>
<p>也就是说，每次请求，会有多个record，他们的<code>requestId</code>是相同的。</p>
<p>借用<a href="http://blog.csdn.net/shreck66/article/details/50355729">该文章</a>中的一个表格，列出最主要的几种<code>type</code>：</p>
<p><a href="../media/attachment/2017/04/25/e29518b1-3574-426f-b75f-8cabbb89a15a.jpg"><img alt="14931267923354.jpg" src="../media/attachment/2017/04/25/e29518b1-3574-426f-b75f-8cabbb89a15a.9efc537226ce.jpg" /></a></p>
<p>看了这个表格就很清楚了，服务器中间件和后端语言通信，第一个数据包就是<code>type</code>为1的record，后续互相交流，发送<code>type</code>为4、5、6、7的record，结束时发送<code>type</code>为2、3的record。</p>
<p>当后端语言接收到一个<code>type</code>为4的record后，就会把这个record的body按照对应的结构解析成key-value对，这就是环境变量。环境变量的结构如下：</p>
<div class="codehilite"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">nameLengthB0</span><span class="p">;</span>  <span class="cm">/* nameLengthB0  &gt;&gt; 7 == 0 */</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">valueLengthB0</span><span class="p">;</span> <span class="cm">/* valueLengthB0 &gt;&gt; 7 == 0 */</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">nameData</span><span class="p">[</span><span class="n">nameLength</span><span class="p">];</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">valueData</span><span class="p">[</span><span class="n">valueLength</span><span class="p">];</span>
<span class="p">}</span> <span class="n">FCGI_NameValuePair11</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">nameLengthB0</span><span class="p">;</span>  <span class="cm">/* nameLengthB0  &gt;&gt; 7 == 0 */</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">valueLengthB3</span><span class="p">;</span> <span class="cm">/* valueLengthB3 &gt;&gt; 7 == 1 */</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">valueLengthB2</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">valueLengthB1</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">valueLengthB0</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">nameData</span><span class="p">[</span><span class="n">nameLength</span><span class="p">];</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">valueData</span><span class="p">[</span><span class="n">valueLength</span>
          <span class="p">((</span><span class="n">B3</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">B2</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">B1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">B0</span><span class="p">];</span>
<span class="p">}</span> <span class="n">FCGI_NameValuePair14</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">nameLengthB3</span><span class="p">;</span>  <span class="cm">/* nameLengthB3  &gt;&gt; 7 == 1 */</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">nameLengthB2</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">nameLengthB1</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">nameLengthB0</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">valueLengthB0</span><span class="p">;</span> <span class="cm">/* valueLengthB0 &gt;&gt; 7 == 0 */</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">nameData</span><span class="p">[</span><span class="n">nameLength</span>
          <span class="p">((</span><span class="n">B3</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">B2</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">B1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">B0</span><span class="p">];</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">valueData</span><span class="p">[</span><span class="n">valueLength</span><span class="p">];</span>
<span class="p">}</span> <span class="n">FCGI_NameValuePair41</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">nameLengthB3</span><span class="p">;</span>  <span class="cm">/* nameLengthB3  &gt;&gt; 7 == 1 */</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">nameLengthB2</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">nameLengthB1</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">nameLengthB0</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">valueLengthB3</span><span class="p">;</span> <span class="cm">/* valueLengthB3 &gt;&gt; 7 == 1 */</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">valueLengthB2</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">valueLengthB1</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">valueLengthB0</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">nameData</span><span class="p">[</span><span class="n">nameLength</span>
          <span class="p">((</span><span class="n">B3</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">B2</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">B1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">B0</span><span class="p">];</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">valueData</span><span class="p">[</span><span class="n">valueLength</span>
          <span class="p">((</span><span class="n">B3</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">B2</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">B1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">B0</span><span class="p">];</span>
<span class="p">}</span> <span class="n">FCGI_NameValuePair44</span><span class="p">;</span>
</pre></div>


<p>这其实是4个结构，至于用哪个结构，有如下规则：</p>
<ol>
<li>key、value均小于128字节，用<code>FCGI_NameValuePair11</code></li>
<li>key大于128字节，value小于128字节，用<code>FCGI_NameValuePair41</code></li>
<li>key小于128字节，value大于128字节，用<code>FCGI_NameValuePair14</code></li>
<li>key、value均大于128字节，用<code>FCGI_NameValuePair44</code></li>
</ol>
<p>为什么我只介绍<code>type</code>为4的record？因为环境变量在后面PHP-FPM里有重要作用，之后写代码也会写到这个结构。<code>type</code>的其他情况，大家可以自己翻文档理解理解。</p>
<h2 id="php-fpmfastcgi"><a class="toclink" href="#php-fpmfastcgi">PHP-FPM（FastCGI进程管理器）</a></h2>
<p>那么，PHP-FPM又是什么东西？</p>
<p>FPM其实是一个fastcgi协议解析器，Nginx等服务器中间件将用户请求按照fastcgi的规则打包好通过TCP传给谁？其实就是传给FPM。</p>
<p>FPM按照fastcgi的协议将TCP流解析成真正的数据。</p>
<p>举个例子，用户访问<code>http://127.0.0.1/index.php?a=1&amp;b=2</code>，如果web目录是<code>/var/www/html</code>，那么Nginx会将这个请求变成如下key-value对：</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="s1">&#39;GATEWAY_INTERFACE&#39;</span><span class="p">:</span> <span class="s1">&#39;FastCGI/1.0&#39;</span><span class="p">,</span>
    <span class="s1">&#39;REQUEST_METHOD&#39;</span><span class="p">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SCRIPT_FILENAME&#39;</span><span class="p">:</span> <span class="s1">&#39;/var/www/html/index.php&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SCRIPT_NAME&#39;</span><span class="p">:</span> <span class="s1">&#39;/index.php&#39;</span><span class="p">,</span>
    <span class="s1">&#39;QUERY_STRING&#39;</span><span class="p">:</span> <span class="s1">&#39;?a=1&amp;b=2&#39;</span><span class="p">,</span>
    <span class="s1">&#39;REQUEST_URI&#39;</span><span class="p">:</span> <span class="s1">&#39;/index.php?a=1&amp;b=2&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DOCUMENT_ROOT&#39;</span><span class="p">:</span> <span class="s1">&#39;/var/www/html&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SERVER_SOFTWARE&#39;</span><span class="p">:</span> <span class="s1">&#39;php/fcgiclient&#39;</span><span class="p">,</span>
    <span class="s1">&#39;REMOTE_ADDR&#39;</span><span class="p">:</span> <span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span>
    <span class="s1">&#39;REMOTE_PORT&#39;</span><span class="p">:</span> <span class="s1">&#39;12345&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SERVER_ADDR&#39;</span><span class="p">:</span> <span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SERVER_PORT&#39;</span><span class="p">:</span> <span class="s1">&#39;80&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SERVER_NAME&#39;</span><span class="p">:</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
    <span class="s1">&#39;SERVER_PROTOCOL&#39;</span><span class="p">:</span> <span class="s1">&#39;HTTP/1.1&#39;</span>
<span class="p">}</span>
</pre></div>


<p>这个数组其实就是PHP中<code>$_SERVER</code>数组的一部分，也就是PHP里的环境变量。但环境变量的作用不仅是填充<code>$_SERVER</code>数组，也是告诉fpm：“我要执行哪个PHP文件”。</p>
<p>PHP-FPM拿到fastcgi的数据包后，进行解析，得到上述这些环境变量。然后，执行<code>SCRIPT_FILENAME</code>的值指向的PHP文件，也就是<code>/var/www/html/index.php</code>。</p>
<h2 id="nginxiis7"><a class="toclink" href="#nginxiis7">Nginx（IIS7）解析漏洞</a></h2>
<p>Nginx和IIS7曾经出现过一个PHP相关的解析漏洞（测试环境<code>https://github.com/phith0n/vulhub/tree/master/nginx_parsing_vulnerability</code>），该漏洞现象是，在用户访问<code>http://127.0.0.1/favicon.ico/.php</code>时，访问到的文件是favicon.ico，但却按照.php后缀解析了。</p>
<p>用户请求<code>http://127.0.0.1/favicon.ico/.php</code>，nginx将会发送如下环境变量到fpm里：</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="o">...</span>
    <span class="s1">&#39;SCRIPT_FILENAME&#39;</span><span class="p">:</span> <span class="s1">&#39;/var/www/html/favicon.ico/.php&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SCRIPT_NAME&#39;</span><span class="p">:</span> <span class="s1">&#39;/favicon.ico/.php&#39;</span><span class="p">,</span>
    <span class="s1">&#39;REQUEST_URI&#39;</span><span class="p">:</span> <span class="s1">&#39;/favicon.ico/.php&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DOCUMENT_ROOT&#39;</span><span class="p">:</span> <span class="s1">&#39;/var/www/html&#39;</span><span class="p">,</span>
    <span class="o">...</span>
<span class="p">}</span>
</pre></div>


<p>正常来说，<code>SCRIPT_FILENAME</code>的值是一个不存在的文件<code>/var/www/html/favicon.ico/.php</code>，是PHP设置中的一个选项<code>fix_pathinfo</code>导致了这个漏洞。PHP为了支持Path Info模式而创造了<code>fix_pathinfo</code>，在这个选项被打开的情况下，fpm会判断<code>SCRIPT_FILENAME</code>是否存在，如果不存在则去掉最后一个<code>/</code>及以后的所有内容，再次判断文件是否存在，往次循环，直到文件存在。</p>
<p>所以，第一次fpm发现<code>/var/www/html/favicon.ico/.php</code>不存在，则去掉<code>/.php</code>，再判断<code>/var/www/html/favicon.ico</code>是否存在。显然这个文件是存在的，于是被作为PHP文件执行，导致解析漏洞。</p>
<p>正确的解决方法有两种，一是在Nginx端使用<code>fastcgi_split_path_info</code>将path info信息去除后，用tryfiles判断文件是否存在；二是借助PHP-FPM的<code>security.limit_extensions</code>配置项，避免其他后缀文件被解析。</p>
<h2 id="securitylimit_extensions"><a class="toclink" href="#securitylimit_extensions"><code>security.limit_extensions</code>配置</a></h2>
<p>写到这里，PHP-FPM未授权访问漏洞也就呼之欲出了。PHP-FPM默认监听9000端口，如果这个端口暴露在公网，则我们可以自己构造fastcgi协议，和fpm进行通信。</p>
<p>此时，<code>SCRIPT_FILENAME</code>的值就格外重要了。因为fpm是根据这个值来执行php文件的，如果这个文件不存在，fpm会直接返回404：</p>
<p><a href="../media/attachment/2017/04/25/703367c4-af98-4702-85f0-794b30776a4f.jpg"><img alt="14931285844835.jpg" src="../media/attachment/2017/04/25/703367c4-af98-4702-85f0-794b30776a4f.073e567856db.jpg" /></a></p>
<p>在fpm某个版本之前，我们可以将<code>SCRIPT_FILENAME</code>的值指定为任意后缀文件，比如<code>/etc/passwd</code>；但后来，fpm的默认配置中增加了一个选项<code>security.limit_extensions</code>：</p>
<div class="codehilite"><pre><span></span>; Limits the extensions of the main script FPM will allow to parse. This can
; prevent configuration mistakes on the web server side. You should only limit
; FPM to .php extensions to prevent malicious users to use other extensions to
; exectute php code.
; Note: set an empty value to allow all extensions.
; Default Value: .php
;security.limit_extensions = .php .php3 .php4 .php5 .php7
</pre></div>


<p>其限定了只有某些后缀的文件允许被fpm执行，默认是<code>.php</code>。所以，当我们再传入<code>/etc/passwd</code>的时候，将会返回<code>Access denied.</code>：</p>
<p><a href="../media/attachment/2017/04/25/99d10f40-7dc3-46f3-a0bb-dae71e9d550b.jpg"><img alt="14931290357686.jpg" src="../media/attachment/2017/04/25/99d10f40-7dc3-46f3-a0bb-dae71e9d550b.30fa707133a3.jpg" /></a></p>
<blockquote>
<p>ps. 这个配置也会影响Nginx解析漏洞，我觉得应该是因为Nginx当时那个解析漏洞，促成PHP-FPM增加了这个安全选项。另外，也有少部分发行版安装中<code>security.limit_extensions</code>默认为空，此时就没有任何限制了。</p>
</blockquote>
<p>由于这个配置项的限制，如果想利用PHP-FPM的未授权访问漏洞，首先就得找到一个已存在的PHP文件。</p>
<p>万幸的是，通常使用源安装php的时候，服务器上都会附带一些php后缀的文件，我们使用<code>find / -name "*.php"</code>来全局搜索一下默认环境：</p>
<p><a href="../media/attachment/2017/04/25/15695b8e-79ae-4f32-b061-cc5f52236e18.jpg"><img alt="14931297810961.jpg" src="../media/attachment/2017/04/25/15695b8e-79ae-4f32-b061-cc5f52236e18.a5365d20818a.jpg" /></a></p>
<p>找到了不少。这就给我们提供了一条思路，假设我们爆破不出来目标环境的web目录，我们可以找找默认源安装后可能存在的php文件，比如<code>/usr/local/lib/php/PEAR.php</code>。</p>
<h2 id="_1"><a class="toclink" href="#_1">任意代码执行</a></h2>
<p>那么，为什么我们控制fastcgi协议通信的内容，就能执行任意PHP代码呢？</p>
<p>理论上当然是不可以的，即使我们能控制<code>SCRIPT_FILENAME</code>，让fpm执行任意文件，也只是执行目标服务器上的文件，并不能执行我们需要其执行的文件。</p>
<p>但PHP是一门强大的语言，PHP.INI中有两个有趣的配置项，<code>auto_prepend_file</code>和<code>auto_append_file</code>。</p>
<p><code>auto_prepend_file</code>是告诉PHP，在执行目标文件之前，先包含<code>auto_prepend_file</code>中指定的文件；<code>auto_append_file</code>是告诉PHP，在执行完成目标文件后，包含<code>auto_append_file</code>指向的文件。</p>
<p>那么就有趣了，假设我们设置<code>auto_prepend_file</code>为<code>php://input</code>，那么就等于在执行任何php文件前都要包含一遍POST的内容。所以，我们只需要把待执行的代码放在Body中，他们就能被执行了。（当然，还需要开启远程文件包含选项<code>allow_url_include</code>）</p>
<p>那么，我们怎么设置<code>auto_prepend_file</code>的值？</p>
<p>这又涉及到PHP-FPM的两个环境变量，<code>PHP_VALUE</code>和<code>PHP_ADMIN_VALUE</code>。这两个环境变量就是用来设置PHP配置项的，<code>PHP_VALUE</code>可以设置模式为<code>PHP_INI_USER</code>和<code>PHP_INI_ALL</code>的选项，<code>PHP_ADMIN_VALUE</code>可以设置所有选项。（<code>disable_functions</code>除外，这个选项是PHP加载的时候就确定了，在范围内的函数直接不会被加载到PHP上下文中）</p>
<p>所以，我们最后传入如下环境变量：</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="s1">&#39;GATEWAY_INTERFACE&#39;</span><span class="p">:</span> <span class="s1">&#39;FastCGI/1.0&#39;</span><span class="p">,</span>
    <span class="s1">&#39;REQUEST_METHOD&#39;</span><span class="p">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SCRIPT_FILENAME&#39;</span><span class="p">:</span> <span class="s1">&#39;/var/www/html/index.php&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SCRIPT_NAME&#39;</span><span class="p">:</span> <span class="s1">&#39;/index.php&#39;</span><span class="p">,</span>
    <span class="s1">&#39;QUERY_STRING&#39;</span><span class="p">:</span> <span class="s1">&#39;?a=1&amp;b=2&#39;</span><span class="p">,</span>
    <span class="s1">&#39;REQUEST_URI&#39;</span><span class="p">:</span> <span class="s1">&#39;/index.php?a=1&amp;b=2&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DOCUMENT_ROOT&#39;</span><span class="p">:</span> <span class="s1">&#39;/var/www/html&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SERVER_SOFTWARE&#39;</span><span class="p">:</span> <span class="s1">&#39;php/fcgiclient&#39;</span><span class="p">,</span>
    <span class="s1">&#39;REMOTE_ADDR&#39;</span><span class="p">:</span> <span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span>
    <span class="s1">&#39;REMOTE_PORT&#39;</span><span class="p">:</span> <span class="s1">&#39;12345&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SERVER_ADDR&#39;</span><span class="p">:</span> <span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SERVER_PORT&#39;</span><span class="p">:</span> <span class="s1">&#39;80&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SERVER_NAME&#39;</span><span class="p">:</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
    <span class="s1">&#39;SERVER_PROTOCOL&#39;</span><span class="p">:</span> <span class="s1">&#39;HTTP/1.1&#39;</span>
    <span class="s1">&#39;PHP_VALUE&#39;</span><span class="p">:</span> <span class="s1">&#39;auto_prepend_file = php://input&#39;</span><span class="p">,</span>
    <span class="s1">&#39;PHP_ADMIN_VALUE&#39;</span><span class="p">:</span> <span class="s1">&#39;allow_url_include = On&#39;</span>
<span class="p">}</span>
</pre></div>


<p>设置<code>auto_prepend_file = php://input</code>且<code>allow_url_include = On</code>，然后将我们需要执行的代码放在Body中，即可执行任意代码。</p>
<p>效果如下：</p>
<p><a href="../media/attachment/2017/04/25/e3c3329d-4e0e-4eec-9ea6-4e621cf01f9b.jpg"><img alt="14931311523859.jpg" src="../media/attachment/2017/04/25/e3c3329d-4e0e-4eec-9ea6-4e621cf01f9b.f4321b6236f8.jpg" /></a></p>
<h2 id="exp"><a class="toclink" href="#exp">EXP编写</a></h2>
<p>上图中用到的EXP，就是根据之前介绍的fastcgi协议来编写的，代码如下：<a href="https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75">https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75</a> 。兼容Python2和Python3，方便在内网用。</p>
<p>之前好些人总是拿着一个GO写的工具在用，又不太好用。实际上理解了fastcgi协议，再看看这个源码，就很简单了。</p>
<p>EXP编写我就不讲了，自己读代码吧。</p>
            </div>
            <div itemprop="keywords" class="tags-meta">
                标签:
                
                    <a href="../tag/php-fpm.html">php-fpm</a>
                
                    <a href="../tag/fastcgi.html">fastcgi</a>
                
            </div>
            <br>
<!--MOB SHARE BEGIN-->
<div class="-mob-share-ui-button -mob-share-open">分享</div>
<div class="-mob-share-ui" style="display: none">
    <ul class="-mob-share-list">
        <li class="-mob-share-weibo"><p>新浪微博</p></li>
        <li class="-mob-share-qzone"><p>QQ空间</p></li>
        <li class="-mob-share-qq"><p>QQ好友</p></li>
        <li class="-mob-share-weixin"><p>微信</p></li>
        <li class="-mob-share-douban"><p>豆瓣</p></li>
        <li class="-mob-share-facebook"><p>Facebook</p></li>
        <li class="-mob-share-twitter"><p>Twitter</p></li>
        <li class="-mob-share-pocket"><p>Pocket</p></li>
        <li class="-mob-share-google"><p>Google+</p></li>
        <li class="-mob-share-youdao"><p>有道云笔记</p></li>
        <li class="-mob-share-mingdao"><p>明道</p></li>
        <li class="-mob-share-tumblr"><p>Tumblr</p></li>
        <li class="-mob-share-instapaper"><p>Instapaper</p></li>
        <li class="-mob-share-linkedin"><p>LinkedIn</p></li>
    </ul>
    <div class="-mob-share-close">取消</div>
</div>
<div class="-mob-share-ui-bg"></div>
<script id="-mob-share" src="https://f1.webshare.mob.com/code/mob-share.js?appkey=af155d9007c8"></script>
<!--MOB SHARE END-->

        <div class="qqlist">
          <h3>订阅本站<small>(RSS)</small></h3>
          <form method="post" target="_blank" action="https://list.qq.com/cgi-bin/qf_compose_send">
          <input type="hidden" value="qf_booked_feedback" name="t" />
          <input type="hidden" value="dace5c2b356504de449e7f3fc2bb59f3f6124d6563786446" name="id" />
          <input type="text" placeholder="E-mail" value="" class="rsstxt" name="to" id="to" />
          <button type="submit" >订阅&rarr;</button>
          </form>
        </div>


        </div>

        
        <div class="post-single type-post text-center">
            <h3 style="margin-top: 0">喜欢这篇文章，扫码和我成为赞友！</h3>
            <img src="../static/wx.jpg" width="280" alt="">
        </div>
        

        <!-- 评论位置 -->
        <div id="comments" class="comments">
          <h3>已有 42 条评论</h3>
            <ol class="comment-list">
            
            
              <li class="comment-body" id="comment-4395">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="../static/placeholder.jpg">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">test</a></div>
                    <p>感谢复现成功。<br>python3 fpm-未授权exp.py &quot;127.0.0.1&quot; -c &#x27;&lt;?system(&quot;whoami&quot;);?&gt;&#x27; -p &quot;9000&quot; /usr/local/lib/php/peclcmd.php<br>X-Powered-By: PHP/8.2.5<br>Content-type: text/html; charset=UTF-8<br><br>www-data</p>
                    <span class="comment-time">时间: 2023-04-26 10:44</span>
                    <span class="comment-reply"><a href="#comment-4395" onclick="reply_to('4395','test')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-4391">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="../static/placeholder.jpg">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">test</a></div>
                    <p>我确认php-fpm在9000端口生效。但是运行报错<br> python3 PHP-FPM-RCE.py 127.0.0.1:9000 /www/server/php/70/lib/php/PEAR.php<br>-c &#x27;&lt;?echo &quot;123&quot;?&gt;&#x27;<br>gaierror(-2, &#x27;Name or service not known&#x27;)<br>connect failure! please check your fasctcgi-server !!<br>None<br>╭─root</p>
                    <span class="comment-time">时间: 2023-04-25 16:23</span>
                    <span class="comment-reply"><a href="#comment-4391" onclick="reply_to('4391','test')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3756">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="https://secure.gravatar.com/avatar/d97850adf795ae279a9dd35f853640c2.jpg?s=100&amp;d=mm&amp;r=g">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">阿菜</a></div>
                    <p>你好，这个漏洞有cve编号吗</p>
                    <span class="comment-time">时间: 2021-12-06 11:13</span>
                    <span class="comment-reply"><a href="#comment-3756" onclick="reply_to('3756','阿菜')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3656">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="../static/placeholder.jpg">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">anycall</a></div>
                    <p>试了，不生效<br>             $client=new \library\FastCGIClient(&#x27;127.0.0.1&#x27;, &#x27;9000&#x27;);<br>        $content = &quot;&lt;?php echo 666;exit;?&gt;&quot;;<br>        //($content)<br>        echo $client-&gt;request(<br>                array(<br>                        &#x27;SCRIPT_FILENAME&#x27; =&gt; &#x27;C://Users//zhong//Documents//index.php&#x27;,<br>                        &#x27;SCRIPT_NAME&#x27;=&gt; &#x27;/index.php&#x27;,<br>                        &#x27;PHP_VALUE&#x27; =&gt; &#x27;auto_prepend_file = php://input&#x27;,<br>                        &#x27;PHP_ADMIN_VALUE&#x27; =&gt; &#x27;allow_url_include = On&#x27;,<br>                        &#x27;CONTENT_TYPE&#x27;=&gt; &#x27;application/text&#x27;,<br>                        &#x27;CONTENT_LENGTH&#x27; =&gt; strlen($content)<br>                ),<br>                $content<br>        );</p>
                    <span class="comment-time">时间: 2021-05-26 18:16</span>
                    <span class="comment-reply"><a href="#comment-3656" onclick="reply_to('3656','anycall')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3657">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="../static/placeholder.jpg">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">anycall</a></div>
                    <p>@anycall php://input 注入的代码不执行</p>
                    <span class="comment-time">时间: 2021-05-26 18:19</span>
                    <span class="comment-reply"><a href="#comment-3657" onclick="reply_to('3657','anycall')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3658">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="https://secure.gravatar.com/avatar/c4267eb6d17276fa31c547ac71611e90.jpg?s=100&amp;d=mm&amp;r=g">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="../index.html" target="_blank" rel="nofollow noopener">phithon</a></div>
                    <p>@anycall 没试过Windows。</p>
                    <span class="comment-time">时间: 2021-05-27 14:24</span>
                    <span class="comment-reply"><a href="#comment-3658" onclick="reply_to('3658','phithon')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3659">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="../static/placeholder.jpg">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">anycall</a></div>
                    <p>@phithon php7.4版本试了，无法执行 php://input 注入的代码</p>
                    <span class="comment-time">时间: 2021-05-27 15:38</span>
                    <span class="comment-reply"><a href="#comment-3659" onclick="reply_to('3659','anycall')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3660">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="../static/placeholder.jpg">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">anycall</a></div>
                    <p>@anycall 请问是什么原因</p>
                    <span class="comment-time">时间: 2021-05-27 15:39</span>
                    <span class="comment-reply"><a href="#comment-3660" onclick="reply_to('3660','anycall')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3661">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="https://secure.gravatar.com/avatar/c4267eb6d17276fa31c547ac71611e90.jpg?s=100&amp;d=mm&amp;r=g">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="../index.html" target="_blank" rel="nofollow noopener">phithon</a></div>
                    <p>@anycall 不清楚，自行研究吧。可以使用Vulhub搭建环境来复现：https://github.com/vulhub/vulhub/tree/master/php/fpm</p>
                    <span class="comment-time">时间: 2021-05-27 15:44</span>
                    <span class="comment-reply"><a href="#comment-3661" onclick="reply_to('3661','phithon')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3599">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="https://secure.gravatar.com/avatar/e37b9fc550a5bfd041d8df52c2d8bc0f.jpg?s=100&amp;d=mm&amp;r=g">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">7rac3</a></div>
                    <p>P师傅，请问你在windows下测试过嘛？我修改了exp的路径，在windows下测试，存在的php文件执行了，但是-C 的代码没有执行。搜索了很多也没找到结果。我的环境是php 7.2.34 nginx 1.6.3 windows 2012。实在不知道为什么，望回复。</p>
                    <span class="comment-time">时间: 2021-01-14 12:03</span>
                    <span class="comment-reply"><a href="#comment-3599" onclick="reply_to('3599','7rac3')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3557">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="https://secure.gravatar.com/avatar/74bc4970433881161506940ee40986f4.jpg?s=100&amp;d=mm&amp;r=g">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">flythief</a></div>
                    <p>如果配置中用的是socket通信是不是就没办法利用了</p>
                    <span class="comment-time">时间: 2020-10-24 23:45</span>
                    <span class="comment-reply"><a href="#comment-3557" onclick="reply_to('3557','flythief')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3562">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="https://secure.gravatar.com/avatar/c4267eb6d17276fa31c547ac71611e90.jpg?s=100&amp;d=mm&amp;r=g">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="../index.html" target="_blank" rel="nofollow noopener">phithon</a></div>
                    <p>@flythief 你说的是unix domain socket吧，访问不到就不行，但可以利用SSRF这样的漏洞间接访问</p>
                    <span class="comment-time">时间: 2020-10-27 12:58</span>
                    <span class="comment-reply"><a href="#comment-3562" onclick="reply_to('3562','phithon')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3442">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="../static/placeholder.jpg">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">围观的白菜哥哥</a></div>
                    <p>p牛你好，security.limit_extensions设置为空后。执行 <br>python fpm3.py /etc/passwd <br>如果不加-c参数的话选择任何文件都返回phpinfo()的内容<br>不会返回文件内容，而是返回phpinfo.php的内容。但是如果执行  <br>python fpm3.py /etc/passwd  -c &quot;&lt;?php echo &quot;aaaa&quot;?&gt;&quot; <br>passwd内容和aaaa都会输出<br>我看你的博客的意思不加-c参数的话因该是直接输出文件内容，是我理解错了吗？</p>
                    <span class="comment-time">时间: 2019-11-14 10:41</span>
                    <span class="comment-reply"><a href="#comment-3442" onclick="reply_to('3442','围观的白菜哥哥')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3443">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="https://secure.gravatar.com/avatar/c4267eb6d17276fa31c547ac71611e90.jpg?s=100&amp;d=mm&amp;r=g">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="../index.html" target="_blank" rel="nofollow noopener">phithon</a></div>
                    <p>@围观的白菜哥哥 因为我在-c的代码后面加了exit;</p>
                    <span class="comment-time">时间: 2019-11-14 11:00</span>
                    <span class="comment-reply"><a href="#comment-3443" onclick="reply_to('3443','phithon')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3444">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="../static/placeholder.jpg">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">围观的白菜哥哥</a></div>
                    <p>@phithon 哈哈，我刚去看了代码发现了，结果回来你就回复我了，谢谢谢谢！</p>
                    <span class="comment-time">时间: 2019-11-14 11:07</span>
                    <span class="comment-reply"><a href="#comment-3444" onclick="reply_to('3444','围观的白菜哥哥')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3372">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="../static/placeholder.jpg">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">安安</a></div>
                    <p>Windows下面怎么利用呢？</p>
                    <span class="comment-time">时间: 2019-06-30 00:58</span>
                    <span class="comment-reply"><a href="#comment-3372" onclick="reply_to('3372','安安')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3329">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="../static/placeholder.jpg">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">pikapika</a></div>
                    <p>大佬，exp的链接打不开了&gt; &lt;</p>
                    <span class="comment-time">时间: 2019-04-13 10:14</span>
                    <span class="comment-reply"><a href="#comment-3329" onclick="reply_to('3329','pikapika')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3331">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="https://secure.gravatar.com/avatar/c4267eb6d17276fa31c547ac71611e90.jpg?s=100&amp;d=mm&amp;r=g">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="../index.html" target="_blank" rel="nofollow noopener">phithon</a></div>
                    <p>@pikapika 翻墙</p>
                    <span class="comment-time">时间: 2019-04-14 22:47</span>
                    <span class="comment-reply"><a href="#comment-3331" onclick="reply_to('3331','phithon')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3324">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="../static/placeholder.jpg">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">k4i</a></div>
                    <p>想請教一下<br>最近碰到類似的場景，能透過SSRF改寫ADMIN_VALUE配置<br>但可能exp沒寫好，總是會噴500 error (But 能成功寫掉ADMIN_VALUE)<br>可是卻不像前面你所說的只影響一個進程，而是全部進程的ADMIN_VALUE都被改寫<br>這可能是啥原因呢? <br>是因為500 error那個request會不斷重複嘗試Request其他進程嗎?<br>感謝</p>
                    <span class="comment-time">时间: 2019-04-11 04:51</span>
                    <span class="comment-reply"><a href="#comment-3324" onclick="reply_to('3324','k4i')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3326">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="../static/placeholder.jpg">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">k4i</a></div>
                    <p>@k4i 我知道問題了... 我一直請求同一個exploit php file，所以會變成死循環把每個進程設定都寫掉</p>
                    <span class="comment-time">时间: 2019-04-12 02:31</span>
                    <span class="comment-reply"><a href="#comment-3326" onclick="reply_to('3326','k4i')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3328">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="https://secure.gravatar.com/avatar/c4267eb6d17276fa31c547ac71611e90.jpg?s=100&amp;d=mm&amp;r=g">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="../index.html" target="_blank" rel="nofollow noopener">phithon</a></div>
                    <p>@k4i 嗯，其实大部分问题自己dig一下很容易找到答案~</p>
                    <span class="comment-time">时间: 2019-04-12 16:50</span>
                    <span class="comment-reply"><a href="#comment-3328" onclick="reply_to('3328','phithon')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3010">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="../static/placeholder.jpg">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">zzm</a></div>
                    <p>想请教一下，如果没有php环境该怎么办？遇到一个站怎么打都是超时。。。本地没啥问题</p>
                    <span class="comment-time">时间: 2018-01-11 18:55</span>
                    <span class="comment-reply"><a href="#comment-3010" onclick="reply_to('3010','zzm')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3011">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="https://secure.gravatar.com/avatar/c4267eb6d17276fa31c547ac71611e90.jpg?s=100&amp;d=mm&amp;r=g">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="../index.html" target="_blank" rel="nofollow noopener">phithon</a></div>
                    <p>@zzm 这是php-fpm的漏洞，目标如果非php或者没有开启fastcgi的端口，是不能成功的。</p>
                    <span class="comment-time">时间: 2018-01-13 18:48</span>
                    <span class="comment-reply"><a href="#comment-3011" onclick="reply_to('3011','phithon')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3012">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="../static/placeholder.jpg">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">zzm</a></div>
                    <p>@phithon soga~谢谢！</p>
                    <span class="comment-time">时间: 2018-01-15 23:19</span>
                    <span class="comment-reply"><a href="#comment-3012" onclick="reply_to('3012','zzm')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-2695">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="../static/placeholder.jpg">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">闷声发大财</a></div>
                    <p>可以很清真</p>
                    <span class="comment-time">时间: 2017-05-07 16:13</span>
                    <span class="comment-reply"><a href="#comment-2695" onclick="reply_to('2695','闷声发大财')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-2692">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="../static/placeholder.jpg">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">MT</a></div>
                    <p>分析的好详细，学习了</p>
                    <span class="comment-time">时间: 2017-05-04 12:17</span>
                    <span class="comment-reply"><a href="#comment-2692" onclick="reply_to('2692','MT')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-2684">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="https://secure.gravatar.com/avatar/9524eba58e101ec8f5caa070564a861f.jpg?s=100&amp;d=mm&amp;r=g">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">wofeiwo</a></div>
                    <p>go 写的那个exp是我写的，的确不太好用，懒得维护了 ：）。 <br>还是赞作者的认真分析，研究深入的确很有意思。 <br><br>security.limit_extensions 这个选项其实是我和php官方通知了暴露在外网可以执行任意命令之后才添加的选项。并不是nginx的漏洞出来时候。 <br><br>另外，在某些基于语言做的沙盒执行环境里，当年利用fpm还可以做到越狱效果（曾经的sae）。</p>
                    <span class="comment-time">时间: 2017-05-02 19:30</span>
                    <span class="comment-reply"><a href="#comment-2684" onclick="reply_to('2684','wofeiwo')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-2685">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="https://secure.gravatar.com/avatar/c4267eb6d17276fa31c547ac71611e90.jpg?s=100&amp;d=mm&amp;r=g">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="../index.html" target="_blank" rel="nofollow noopener">phithon</a></div>
                    <p>@wofeiwo <br>厉害，GO不好用主要是因为没源码，否则就好办多了。<br>绕过沙盒的我15年也做过，当时目标没有限制dl函数，直接用fpm设置extension_dir和enable_dl，加载自己的扩展，执行任意命令。一直没舍得往外说，哈哈哈~<br>师傅您是wooyun里的GaRY么，我记得当时是您首发的这个方法？十分惊艳！</p>
                    <span class="comment-time">时间: 2017-05-02 19:43</span>
                    <span class="comment-reply"><a href="#comment-2685" onclick="reply_to('2685','phithon')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-2688">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="https://secure.gravatar.com/avatar/9524eba58e101ec8f5caa070564a861f.jpg?s=100&amp;d=mm&amp;r=g">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">wofeiwo</a></div>
                    <p>@phithon 源代码其实在zone的原帖中我是和二进制一起附上的，果然当时golang没人注意么。。？<br><br>https://gist.github.com/wofeiwo/96ccb6ad699691732309e30670281b47</p>
                    <span class="comment-time">时间: 2017-05-03 09:42</span>
                    <span class="comment-reply"><a href="#comment-2688" onclick="reply_to('2688','wofeiwo')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-2689">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="https://secure.gravatar.com/avatar/9524eba58e101ec8f5caa070564a861f.jpg?s=100&amp;d=mm&amp;r=g">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">wofeiwo</a></div>
                    <p>@phithon 顺带关于沙盒逃逸。我当时写了个，主要为了过safe_mode/open_basedir去执行命令，现在已经没有意义了。后来我在zone中有公开过，不过应该没人发现我有更新，lol<br><br>https://gist.github.com/wofeiwo/4f41381a388accbf91f8</p>
                    <span class="comment-time">时间: 2017-05-03 09:48</span>
                    <span class="comment-reply"><a href="#comment-2689" onclick="reply_to('2689','wofeiwo')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-2690">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="https://secure.gravatar.com/avatar/c4267eb6d17276fa31c547ac71611e90.jpg?s=100&amp;d=mm&amp;r=g">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="../index.html" target="_blank" rel="nofollow noopener">phithon</a></div>
                    <p>@wofeiwo 惊，这两个代码我好像没注意到，但您说过的safe_mode绕过我记得~</p>
                    <span class="comment-time">时间: 2017-05-03 14:50</span>
                    <span class="comment-reply"><a href="#comment-2690" onclick="reply_to('2690','phithon')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-2672">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="../static/placeholder.jpg">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">噬魂</a></div>
                    <p>大佬是不是一定要开放9000端口？</p>
                    <span class="comment-time">时间: 2017-04-28 10:56</span>
                    <span class="comment-reply"><a href="#comment-2672" onclick="reply_to('2672','噬魂')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-2675">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="https://secure.gravatar.com/avatar/c4267eb6d17276fa31c547ac71611e90.jpg?s=100&amp;d=mm&amp;r=g">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="../index.html" target="_blank" rel="nofollow noopener">phithon</a></div>
                    <p>@噬魂 是的。如果没有对外开放9000端口，利用SSRF漏洞也可以攻击。</p>
                    <span class="comment-time">时间: 2017-04-28 17:12</span>
                    <span class="comment-reply"><a href="#comment-2675" onclick="reply_to('2675','phithon')">回复</a></span>
                    </div>
                </div>
              </li>
            
            
            </ol>
            
<div class="type-post" id="pagination"><ol class="page-navigator">
    
</ol></div>

        </div>

        <div id="reply"></div>
        <div id="comment-place">
            <div id="comment-post" class="respond none-resize">
             <div id="respond">
                <h3 id="response">添加新评论</h3>
                <form method="post" id="comment-form" role="form" action="#comments">
                    <p>
                        <label for="author" class="required">称呼</label>
                        <input type="text" name="nickname" placeholder="昵称" maxlength="64" required id="id_nickname">
                    </p>
                    <p>
                        <label for="mail">Email</label>
                        <input type="text" name="email" placeholder="邮箱（可留空）" maxlength="254" id="id_email">
                    </p>
                    <p>
                        <label for="url">网站</label>
                        <input type="text" name="url" placeholder="链接（可留空）" maxlength="200" id="id_url">
                    </p>
                    <p>
                        <label for="textarea" class="required">内容</label>
                        <textarea name="content" cols="40" rows="6" required id="id_content">
</textarea>
                    </p>
                    <p>
                        <label style="float:left;">验证码</label>
                        <div class="row gx-2" style="margin-top: 8px"><div class="col-6"><input autocomplete="off" id="id_captcha_1" name="captcha_1" type="text" placeholder="验证码" /> <input id="id_captcha_0" name="captcha_0" type="hidden" value="074ede55035464a8e64008d60025e655ce9ed2c5" />
</div><div class="col-6">
<img src="../captcha/image/074ede55035464a8e64008d60025e655ce9ed2c5/index.png" alt="captcha" class="captcha" /></div></div>
                    </p>
                    <p>
                        <button type="submit" class="submit">提交评论</button>
                        <input type="hidden" name="parent" id="id_parent">
                        <input type="hidden" name="archive" value="416" id="id_archive">
                        <input type="hidden" name="csrfmiddlewaretoken" value="6wj4gXuwBFiAsXNaDdgiFV9MutDb59hJS4HVO25fZ1wj0vByFed3CocRPQUmELt1">
                    </p>
                </form>
                </div>
            </div>
        </div>

    </div>
    



<div  class="col-5 columns" id="sidebar" role="complementary">

  <div class="widget widget_search">
    <h3>搜索</h3>
    <form action="https://www.leavesongs.com/search/" id="searchform" method="get">
        <input type="text" id="searchkey" name="keyword" value="" class="searchkey" placeholder="Search..."/>
        <button type="submit"  id="searchsubmit">Go</button>
    </form>
  </div>

  
  <div class="widget">
	<h3 class="widget-title">最新评论</h3>
	<ul class="widget-list" id="recent-comment">
    
    
        <li id="comment" class="clearfix">
            <img class="avatar" src="../static/placeholder.jpg" alt="%s" width="40" height="40">
            <div class="comments-link"><cite>木木</cite>：<a href="../THINK/europe-trip-2022.html#comment-4523">虽然物价对比不出什么，但是还是觉得很高昂</a></div>
        </li>
    
        <li id="comment" class="clearfix">
            <img class="avatar" src="../static/placeholder.jpg" alt="%s" width="40" height="40">
            <div class="comments-link"><cite>dongdong4fei</cite>：<a href="../THINK/using-chatgpt-for-antispam.html#comment-4520">肯德基疯狂星期四！ 疯狂星期四！  https://m.kfc.com.cn/wechatco...</a></div>
        </li>
    
        <li id="comment" class="clearfix">
            <img class="avatar" src="../static/placeholder.jpg" alt="%s" width="40" height="40">
            <div class="comments-link"><cite>dongdong4fei</cite>：<a href="../THINK/using-chatgpt-for-antispam.html#comment-4519">小猪咪小猪咪小猪咪</a></div>
        </li>
    
        <li id="comment" class="clearfix">
            <img class="avatar" src="../static/placeholder.jpg" alt="%s" width="40" height="40">
            <div class="comments-link"><cite>sam</cite>：<a href="javascript-prototype-pollution-attack.html#comment-4518">还得是P神，文章一看就懂</a></div>
        </li>
    
        <li id="comment" class="clearfix">
            <img class="avatar" src="../static/placeholder.jpg" alt="%s" width="40" height="40">
            <div class="comments-link"><cite>程序</cite>：<a href="discuz72-sql-injection.html#comment-4517">很不错的文章</a></div>
        </li>
    
    </ul>
  </div>

  <div class="widget widget-category">
	<h3>分类</h3>
	<ul id="blogsort" class="widget-list">
    
    
    <li>
        <a href="../sort/PENETRATION.html">网络安全<em>143</em></a>
    </li>
    
    <li>
        <a href="../sort/C.html">C/C++<em>32</em></a>
    </li>
    
    <li>
        <a href="../sort/THINK.html">心得与体会<em>24</em></a>
    </li>
    
    <li>
        <a href="../sort/PYTHON.html">Python<em>19</em></a>
    </li>
    
    <li>
        <a href="../sort/SHARE.html">资源分享<em>16</em></a>
    </li>
    
    </ul>
  </div>

  <div class="widget widget-tag">
	<h3>随机标签</h3>
	<div class="tag-cloud">
        
        
        <a rel="tag" href="../tag/%E5%A4%A7%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86.html">大文件处理</a>
        
        <a rel="tag" href="../tag/%E5%9B%9E%E8%B0%83%E5%90%8E%E9%97%A8.html">回调后门</a>
        
        <a rel="tag" href="../tag/iOS.html">iOS</a>
        
        <a rel="tag" href="../tag/%E4%BD%8D%E8%BF%90%E7%AE%97.html">位运算</a>
        
        <a rel="tag" href="../tag/%E6%A1%A5%E6%8E%A5.html">桥接</a>
        
        <a rel="tag" href="../tag/writeup.html">writeup</a>
        
        <a rel="tag" href="../tag/IIS.html">IIS</a>
        
        <a rel="tag" href="../tag/WTForm.html">WTForm</a>
        
        <a rel="tag" href="../tag/apache.html">apache</a>
        
        <a rel="tag" href="../tag/web%E6%8C%87%E7%BA%B9.html">web指纹</a>
        
        <a rel="tag" href="../tag/%E6%B1%89%E8%AF%BA%E5%A1%94.html">汉诺塔</a>
        
        <a rel="tag" href="../tag/cmd%E5%90%8E%E9%97%A8.html">cmd后门</a>
        
        <a rel="tag" href="../tag/Linux.html">Linux</a>
        
        <a rel="tag" href="../tag/CSP.html">CSP</a>
        
        <a rel="tag" href="../tag/%E5%9B%A2%E9%98%9F.html">团队</a>
        
        <a rel="tag" href="../tag/phpwind.html">phpwind</a>
        
        <a rel="tag" href="../tag/%E6%80%BB%E7%BB%93.html">总结</a>
        
        <a rel="tag" href="../tag/%E9%81%8D%E5%8E%86%E7%9B%AE%E5%BD%95.html">遍历目录</a>
        
        <a rel="tag" href="../tag/C-FREE.html">C-FREE</a>
        
        <a rel="tag" href="../tag/var_dump.html">var_dump</a>
        
        <a rel="tag" href="../tag/disable_functions.html">disable_functions</a>
        
        <a rel="tag" href="../tag/%E6%8A%A5%E7%BA%B8.html">报纸</a>
        
        <a rel="tag" href="../tag/%E8%B6%8A%E6%9D%83%E6%BC%8F%E6%B4%9E.html">越权漏洞</a>
        
        <a rel="tag" href="../tag/web%E5%BA%94%E7%94%A8.html">web应用</a>
        
        <a rel="tag" href="../tag/360webscan.html">360webscan</a>
        
        <a rel="tag" href="../tag/asyncore.html">asyncore</a>
        
        <a rel="tag" href="../tag/%E6%B2%99%E7%9B%92%E7%BB%95%E8%BF%87.html">沙盒绕过</a>
        
        <a rel="tag" href="../tag/fckeditor.html">fckeditor</a>
        
        <a rel="tag" href="../tag/%E6%95%B0%E6%8D%AE%E5%BA%93%E9%80%9F%E5%BA%A6.html">数据库速度</a>
        
        <a rel="tag" href="../tag/kali.html">kali</a>
        
    </div>
  </div>

  <div class="widget widget-recent-entries">
	<h3 class="widget-title">热门日志</h3>
	<ul id="hotlog" class="widget-list">
    
    
        <li><a href="../other/tinger.html">About.Me</a></li>
    
        <li><a href="detect-django.html">如何判断目标站点是否为Django开发</a></li>
    
        <li><a href="webshell-without-alphanum-advanced.html">无字母数字webshell之提高篇</a></li>
    
        <li><a href="webshell-without-alphanum.html">一些不包含数字和字母的webshell</a></li>
    
        <li><a href="php-filter-magic.html">谈一谈php://filter的妙用</a></li>
    
    </ul>
  </div>
  

</div>
</div>

<div id="footer">
	<!-- copyright -->
	<div class="container">
		<div class="row remove-bottom">
			<div class="col-6 columns">
			<h3>Little About</h3>
			<p>Phithon 非强迫症小青年  <br>
现居先 <br>
爱好：种花、买书、收藏明信片 <br>
欢迎各大组织收留 <br>
E-mail：root@leavesongs.com </p>
			</div>

			<div class="col-10 columns">

				<h3 class="mobile-hide">Follow me</h3>
        <div id="social-links">
          <a href="http://weibo.com/101yx" class="sweibo" target="_blank" title="新浪微博">新浪微博</a>
          <a href="javascript:alert(/没有腾讯微博哟/)" class="qweibo" target="_blank" title="腾讯微博">腾讯微博</a>
          <a href="javascript:alert(/墙外有什么/);window.open('http://google.com')" class="google" target="_blank" title="墙外的世界">google+</a>
          <a href="https://github.com/phith0n" class="github" target="_blank" title="Github">github</a>
          <a href="javascript:confirm(/mailto:root#leavesongs.com/)" class="mail" target="_blank" title="私信给我">私信给我</a>
          <a href="../feed/index.rss" target="_blank" class="rss" title="离别歌">RSS订阅</a>
        </div>
        <div class="bot-line"></div>
				<p class="copyright">
	Copyright &copy; Powered by talkbook
				&nbsp;&nbsp;<i>Designed and built with all the love in the world by <a href="../index.html" target="_blank">Phithon</a> && deepsky </i>
                    <a href="../index.html">更换模板</a>
				</p>
			</div>
		</div>
	</div>
	<!-- /copyright -->
</div>
<a href="#" id="go-top">Top ↑</a>
<script src="https://cdn.staticfile.org/jquery/1.12.4/jquery.min.js"></script>
<script src="https://cdn.staticfile.org/jquery.appear/0.4.1/jquery.appear.min.js"></script>
<script src="../static/deep/js/common_tpl.js" type="text/javascript"></script>
<script src="../static/deep/js/config.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-FF5KPQ1CZ6"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-FF5KPQ1CZ6');
</script>

<script src="https://cdn.staticfile.org/fancybox/2.1.7/js/jquery.fancybox.min.js"></script>
<script>
$(document).ready(function () {
    $(".entry a").each(function (i, e) {
        if(e.host != 'www.leavesongs.com') {
            e.target = '_blank';
        }
    });
    $(".entry img").each(function (i, e) {
        if(e.parentNode.tagName.toUpperCase() != 'A') {
            $(e).wrap('<a href="'+escapeHtml(e.src)+'" class="fancybox"></a>');
        } else {
            $(e.parentNode).addClass('fancybox');
        }
    });
    $('.fancybox').fancybox();
})
</script>

</body>

</html>