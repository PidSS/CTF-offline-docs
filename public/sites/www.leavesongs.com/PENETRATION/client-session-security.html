

<html class="no-js">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="keywords" content="" />
    <meta name="description" content="phith0n的小站，长期存在与分享关于网络安全与各种编程的原创文章。" />
    <title>客户端 session 导致的安全问题 | 离别歌</title>
    <link rel="alternate" type="application/atom+xml" href="../feed/index.rss" title="离别歌" />
    <link href="../static/deep/css/base.css" rel="stylesheet" type="text/css" />
    <link href="../static/deep/css/style.css" rel="stylesheet" type="text/css" />
    <link rel="shortcut icon" href="../static/deep/images/favicon.ico" />
    
<style>div.row .col-xs-4 {
  float: left;
  margin-left: 4px;
}
div.row .col-xs-4 img {
  margin-left: 5px;
}
</style>
<link href="https://cdn.staticfile.org/fancybox/2.1.7/css/jquery.fancybox.min.css" rel="stylesheet">
<link rel="stylesheet" href="../static/deep/css/code.css">

</head>
<body>
<!--[if lt IE 8]>
    <div class="browsehappy" role="dialog">当前网页 <strong>不支持</strong> 你正在使用的浏览器. 为了正常的访问, 请 <a href="http://browsehappy.com/">升级你的浏览器</a>.</div>
<![endif]-->
<div id="header">
    <div class="container">
        <h1 class="h1-title">
            <a href="../index.html">
               <img src="../static/deep/images/logo.png" alt="离别歌" />
            </a>
        </h1>
        <div id="nav">
        <input type="checkbox" id="button">
        <label for="button" onclick>菜单</label>
        
        <ul>
            
            <li class="item ">
                <a href="../index.html" >首页</a>
            </li>
            
            <li class="item ">
                <a href="../list/index.html" >文章</a>
            </li>
            
            <li class="item ">
                <a href="../other/tinger.html" >关于</a>
            </li>
            
            <li class="item ">
                <a href="../other/friends-link.html" >友链</a>
            </li>
            
            <li class="item ">
                <a href="https://github.com/phith0n" target="_blank" >项目</a>
            </li>
            
            <li class="item ">
                <a href="https://www.leavesongs.com/PENETRATION/code-auditor-secret-group.html" target="_blank" >代码审计</a>
            </li>
            
        </ul>
        
        </div>
    </div>
</div>

<div class="banner-bar">
    <div class="container">
        <div class="col-12 columns">
            <div class="place">
                <a href="../index.html">首页</a>
                &raquo;
                
                网络安全 &raquo; <a href="client-session-security.html">客户端 session 导致的安全问题</a>
                
            </div>
        </div>
    </div>
</div>
<div class="container">
    <div class="col-11 columns" id="mainbody" role="main">
        <div class="post-single type-post">
            <h1 class="article-h1">客户端 session 导致的安全问题</h1>
            <div class="details-up">
  <span class="author">作者: phithon</span>
  
  <span class="category">分类: <a href="../sort/PENETRATION.html">网络安全</a></span>
  
  <span class="date">时间: 2018-3-26 10:27</span>
  <span class="comments-top" itemprop="interactionCount">评论：<a itemprop="discussionUrl" href="#reply-list">9条评论</a></span>
  <span class="comments-top" itemprop="interactionCount">浏览：<a itemprop="discussionUrl" href="client-session-security.html">63039人看过</a></span>
  
  <span class="date">标签:
    
        <a href="../tag/flask.html">flask</a>
    
  </span>
  
</div>
            <div class="entry">
                <p>在Web中，session是认证用户身份的凭证，它具备如下几个特点：</p>
<ol>
<li>用户不可以任意篡改</li>
<li>A用户的session无法被B用户获取</li>
</ol>
<p>也就是说，session的设计目的是为了做用户身份认证。但是，很多情况下，session被用作了别的用途，将产生一些安全问题，我们今天就来谈谈“客户端session”（client session）导致的安全问题。</p>
<h2 id="0x01-session"><a class="toclink" href="#0x01-session">0x01 什么是客户端session</a></h2>
<p>在传统PHP开发中，<code>$_SESSION</code>变量的内容默认会被保存在服务端的一个文件中，通过一个叫“PHPSESSID”的Cookie来区分用户。这类session是“服务端session”，用户看到的只是session的名称（一个随机字符串），其内容保存在服务端。</p>
<p>然而，并不是所有语言都有默认的session存储机制，也不是任何情况下我们都可以向服务器写入文件。所以，很多Web框架都会另辟蹊径，比如Django默认将session存储在数据库中，而对于flask这里并不包含数据库操作的框架，就只能将session存储在cookie中。</p>
<p>因为cookie实际上是存储在客户端（浏览器）中的，所以称之为“客户端session”。</p>
<h2 id="0x02-session"><a class="toclink" href="#0x02-session">0x02 保护客户端session</a></h2>
<p>将session存储在客户端cookie中，最重要的就是解决session不能被篡改的问题。</p>
<p>我们看看flask是如何处理的：</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">SecureCookieSessionInterface</span><span class="p">(</span><span class="n">SessionInterface</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The default session interface that stores sessions in signed cookies</span>
<span class="sd">    through the :mod:`itsdangerous` module.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#: the salt that should be applied on top of the secret key for the</span>
    <span class="c1">#: signing of cookie based sessions.</span>
    <span class="n">salt</span> <span class="o">=</span> <span class="s1">&#39;cookie-session&#39;</span>
    <span class="c1">#: the hash function to use for the signature. The default is sha1</span>
    <span class="n">digest_method</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">)</span>
    <span class="c1">#: the name of the itsdangerous supported key derivation. The default</span>
    <span class="c1">#: is hmac.</span>
    <span class="n">key_derivation</span> <span class="o">=</span> <span class="s1">&#39;hmac&#39;</span>
    <span class="c1">#: A python serializer for the payload. The default is a compact</span>
    <span class="c1">#: JSON derived serializer with support for some extra Python types</span>
    <span class="c1">#: such as datetime objects or tuples.</span>
    <span class="n">serializer</span> <span class="o">=</span> <span class="n">session_json_serializer</span>
    <span class="n">session_class</span> <span class="o">=</span> <span class="n">SecureCookieSession</span>

    <span class="k">def</span> <span class="nf">get_signing_serializer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">app</span><span class="o">.</span><span class="n">secret_key</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="n">signer_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">key_derivation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">key_derivation</span><span class="p">,</span>
            <span class="n">digest_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">digest_method</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">URLSafeTimedSerializer</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">secret_key</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">salt</span><span class="p">,</span>
                                      <span class="n">serializer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">serializer</span><span class="p">,</span>
                                      <span class="n">signer_kwargs</span><span class="o">=</span><span class="n">signer_kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">open_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_signing_serializer</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">session_cookie_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">val</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_class</span><span class="p">()</span>
        <span class="n">max_age</span> <span class="o">=</span> <span class="n">total_seconds</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">permanent_session_lifetime</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="n">max_age</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_class</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">BadSignature</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_class</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">save_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cookie_domain</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cookie_path</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
        <span class="c1"># Delete case. If there is no session we bail early.</span>
        <span class="c1"># If the session was modified to be empty we remove the</span>
        <span class="c1"># whole cookie.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">modified</span><span class="p">:</span>
                <span class="n">response</span><span class="o">.</span><span class="n">delete_cookie</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">session_cookie_name</span><span class="p">,</span>
                                       <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># Modification case. There are upsides and downsides to</span>
        <span class="c1"># emitting a set-cookie header each request. The behavior</span>
        <span class="c1"># is controlled by the :meth:`should_set_cookie` method</span>
        <span class="c1"># which performs a quick check to figure out if the cookie</span>
        <span class="c1"># should be set or not. This is controlled by the</span>
        <span class="c1"># SESSION_REFRESH_EACH_REQUEST config flag as well as</span>
        <span class="c1"># the permanent flag on the session itself.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">should_set_cookie</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="n">httponly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cookie_httponly</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
        <span class="n">secure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cookie_secure</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
        <span class="n">expires</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_expiration_time</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_signing_serializer</span><span class="p">(</span><span class="n">app</span><span class="p">)</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">session</span><span class="p">))</span>
        <span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">session_cookie_name</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span>
                            <span class="n">expires</span><span class="o">=</span><span class="n">expires</span><span class="p">,</span> <span class="n">httponly</span><span class="o">=</span><span class="n">httponly</span><span class="p">,</span>
                            <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">secure</span><span class="o">=</span><span class="n">secure</span><span class="p">)</span>
</pre></div>


<p>主要看最后两行代码，新建了<code>URLSafeTimedSerializer</code>类 ，用它的<code>dumps</code>方法将类型为字典的session对象序列化成字符串，然后用<code>response.set_cookie</code>将最后的内容保存在cookie中。</p>
<p>那么我们可以看一下<code>URLSafeTimedSerializer</code>是做什么的：</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Signer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># ...</span>
    <span class="k">def</span> <span class="nf">sign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Signs the given string.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">value</span> <span class="o">+</span> <span class="n">want_bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_signature</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_signature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the signature for the given value&quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">want_bytes</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">derive_key</span><span class="p">()</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">get_signature</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">base64_encode</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Serializer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">default_serializer</span> <span class="o">=</span> <span class="n">json</span>
    <span class="n">default_signer</span> <span class="o">=</span> <span class="n">Signer</span>
    <span class="c1"># ....</span>
    <span class="k">def</span> <span class="nf">dumps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a signed string serialized with the internal serializer.</span>
<span class="sd">        The return value can be either a byte or unicode string depending</span>
<span class="sd">        on the format of the internal serializer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">want_bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dump_payload</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_signer</span><span class="p">(</span><span class="n">salt</span><span class="p">)</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_text_serializer</span><span class="p">:</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="n">rv</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rv</span>

    <span class="k">def</span> <span class="nf">dump_payload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dumps the encoded object. The return value is always a</span>
<span class="sd">        bytestring. If the internal serializer is text based the value</span>
<span class="sd">        will automatically be encoded to utf-8.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">want_bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serializer</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">URLSafeSerializerMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mixed in with a regular serializer it will attempt to zlib compress</span>
<span class="sd">    the string to make it shorter if necessary. It will also base64 encode</span>
<span class="sd">    the string so that it can safely be placed in a URL.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">load_payload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
        <span class="n">decompress</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">payload</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">decompress</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">json</span> <span class="o">=</span> <span class="n">base64_decode</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BadPayload</span><span class="p">(</span><span class="s1">&#39;Could not base64 decode the payload because of &#39;</span>
                <span class="s1">&#39;an exception&#39;</span><span class="p">,</span> <span class="n">original_error</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">decompress</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">json</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">json</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">BadPayload</span><span class="p">(</span><span class="s1">&#39;Could not zlib decompress the payload before &#39;</span>
                    <span class="s1">&#39;decoding the payload&#39;</span><span class="p">,</span> <span class="n">original_error</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">URLSafeSerializerMixin</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">load_payload</span><span class="p">(</span><span class="n">json</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">dump_payload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="n">json</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">URLSafeSerializerMixin</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">dump_payload</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">is_compressed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">compressed</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">json</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">compressed</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">json</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">json</span> <span class="o">=</span> <span class="n">compressed</span>
            <span class="n">is_compressed</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">base64d</span> <span class="o">=</span> <span class="n">base64_encode</span><span class="p">(</span><span class="n">json</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_compressed</span><span class="p">:</span>
            <span class="n">base64d</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">base64d</span>
        <span class="k">return</span> <span class="n">base64d</span>


<span class="k">class</span> <span class="nc">URLSafeTimedSerializer</span><span class="p">(</span><span class="n">URLSafeSerializerMixin</span><span class="p">,</span> <span class="n">TimedSerializer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Works like :class:`TimedSerializer` but dumps and loads into a URL</span>
<span class="sd">    safe string consisting of the upper and lowercase character of the</span>
<span class="sd">    alphabet as well as ``&#39;_&#39;``, ``&#39;-&#39;`` and ``&#39;.&#39;``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">default_serializer</span> <span class="o">=</span> <span class="n">compact_json</span>
</pre></div>


<p>主要关注<code>dump_payload</code>、<code>dumps</code>，这是序列化session的主要过程。</p>
<p>可见，序列化的操作分如下几步：</p>
<ol>
<li>json.dumps 将对象转换成json字符串，作为数据</li>
<li>如果数据压缩后长度更短，则用zlib库进行压缩</li>
<li>将数据用base64编码</li>
<li>通过hmac算法计算数据的签名，将签名附在数据后，用“.”分割</li>
</ol>
<p>第4步就解决了用户篡改session的问题，因为在不知道secret_key的情况下，是无法伪造签名的。</p>
<p>最后，我们在cookie中就能看到设置好的session了：</p>
<p><a href="../media/attachment/2018/03/26/18db98ef-c8ec-435e-a21a-f8eaa8c97631.png"><img alt="693b25ce-0a26-43b2-b8c2-80e8786cc9b8.png" src="../media/attachment/2018/03/26/18db98ef-c8ec-435e-a21a-f8eaa8c97631.95a9fc66c7c4.png" /></a></p>
<p>注意到，在第4步中，flask仅仅对数据进行了签名。众所周知的是，签名的作用是防篡改，而无法防止被读取。而flask并没有提供加密操作，所以其session的全部内容都是可以在客户端读取的，这就可能造成一些安全问题。</p>
<h2 id="0x03-flasksession"><a class="toclink" href="#0x03-flasksession">0x03 flask客户端session导致敏感信息泄露</a></h2>
<p>我曾遇到过一个案例，目标是flask开发的一个简历管理系统，在测试其找回密码功能的时候，我收到了服务端设置的session。</p>
<p>我在0x02中说过，flask是一个客户端session，所以看目标为flask的站点的时候，我习惯性地去解密其session。编写如下代码解密session：</p>
<div class="codehilite"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">zlib</span>
<span class="kn">from</span> <span class="nn">base64</span> <span class="kn">import</span> <span class="n">b64decode</span>
<span class="kn">from</span> <span class="nn">flask.sessions</span> <span class="kn">import</span> <span class="n">session_json_serializer</span>
<span class="kn">from</span> <span class="nn">itsdangerous</span> <span class="kn">import</span> <span class="n">base64_decode</span>

<span class="k">def</span> <span class="nf">decryption</span><span class="p">(</span><span class="n">payload</span><span class="p">):</span>
    <span class="n">payload</span><span class="p">,</span> <span class="n">sig</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">payload</span><span class="p">,</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">decompress</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">payload</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">decompress</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">base64_decode</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Could not base64 decode the payload because of &#39;</span>
                         <span class="s1">&#39;an exception&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">decompress</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Could not zlib decompress the payload before &#39;</span>
                             <span class="s1">&#39;decoding the payload&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">session_json_serializer</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">decryption</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">()))</span>
</pre></div>


<p>例如，我解密0x02中演示的session：</p>
<p><a href="../media/attachment/2018/03/26/89c47e6d-b1de-4593-9f89-c43beb64dd2a.png"><img alt="789edad0-8216-43d3-b6eb-93557e03b63d.png" src="../media/attachment/2018/03/26/89c47e6d-b1de-4593-9f89-c43beb64dd2a.770a934a0daa.png" /></a></p>
<p>通过解密目标站点的session，我发现其设置了一个名为token、值是一串md5的键。猜测其为找回密码的认证，将其替换到找回密码链接的token中，果然能够进入修改密码页面。通过这个过程，我就能修改任意用户密码了。</p>
<p>这是一个比较典型的安全问题，目标网站通过session来储存随机token并认证用户是否真的在邮箱收到了这个token。但因为flask的session是存储在cookie中且仅签名而未加密，所以我们就可以直接读取这个token了。</p>
<h2 id="0x04-flask"><a class="toclink" href="#0x04-flask">0x04 flask验证码绕过漏洞</a></h2>
<p>这是客户端session的另一个常见漏洞场景。</p>
<p>我们用一个实际例子认识这一点：<a href="https://github.com/shonenada/flask-captcha">https://github.com/shonenada/flask-captcha</a> 。这是一个为flask提供验证码的项目，我们看到其中的view文件：</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">cStringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span> <span class="k">as</span> <span class="n">StringIO</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Blueprint</span><span class="p">,</span> <span class="n">make_response</span><span class="p">,</span> <span class="n">current_app</span><span class="p">,</span> <span class="n">session</span>
<span class="kn">from</span> <span class="nn">wheezy.captcha.image</span> <span class="kn">import</span> <span class="n">captcha</span>
<span class="kn">from</span> <span class="nn">wheezy.captcha.image</span> <span class="kn">import</span> <span class="n">background</span>
<span class="kn">from</span> <span class="nn">wheezy.captcha.image</span> <span class="kn">import</span> <span class="n">curve</span>
<span class="kn">from</span> <span class="nn">wheezy.captcha.image</span> <span class="kn">import</span> <span class="n">noise</span>
<span class="kn">from</span> <span class="nn">wheezy.captcha.image</span> <span class="kn">import</span> <span class="n">smooth</span>
<span class="kn">from</span> <span class="nn">wheezy.captcha.image</span> <span class="kn">import</span> <span class="n">text</span>
<span class="kn">from</span> <span class="nn">wheezy.captcha.image</span> <span class="kn">import</span> <span class="n">offset</span>
<span class="kn">from</span> <span class="nn">wheezy.captcha.image</span> <span class="kn">import</span> <span class="n">rotate</span>
<span class="kn">from</span> <span class="nn">wheezy.captcha.image</span> <span class="kn">import</span> <span class="n">warp</span>


<span class="n">captcha_bp</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="s1">&#39;captcha&#39;</span><span class="p">,</span> <span class="vm">__name__</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">sample_chars</span><span class="p">():</span>
    <span class="n">characters</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;CAPTCHA_CHARACTERS&#39;</span><span class="p">]</span>
    <span class="n">char_length</span> <span class="o">=</span> <span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;CAPTCHA_CHARS_LENGTH&#39;</span><span class="p">]</span>
    <span class="n">captcha_code</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">characters</span><span class="p">,</span> <span class="n">char_length</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">captcha_code</span>

<span class="nd">@captcha_bp.route</span><span class="p">(</span><span class="s1">&#39;/captcha&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s2">&quot;captcha&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">captcha_view</span><span class="p">():</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
    <span class="n">captcha_image</span> <span class="o">=</span> <span class="n">captcha</span><span class="p">(</span><span class="n">drawings</span><span class="o">=</span><span class="p">[</span>
        <span class="n">background</span><span class="p">(),</span>
        <span class="n">text</span><span class="p">(</span><span class="n">fonts</span><span class="o">=</span><span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;CAPTCHA_FONTS&#39;</span><span class="p">],</span>
             <span class="n">drawings</span><span class="o">=</span><span class="p">[</span><span class="n">warp</span><span class="p">(),</span> <span class="n">rotate</span><span class="p">(),</span> <span class="n">offset</span><span class="p">()]),</span>
        <span class="n">curve</span><span class="p">(),</span>
        <span class="n">noise</span><span class="p">(),</span>
        <span class="n">smooth</span><span class="p">(),</span>
    <span class="p">])</span>
    <span class="n">captcha_code</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sample_chars</span><span class="p">())</span>
    <span class="n">imgfile</span> <span class="o">=</span> <span class="n">captcha_image</span><span class="p">(</span><span class="n">captcha_code</span><span class="p">)</span>
    <span class="n">session</span><span class="p">[</span><span class="s1">&#39;captcha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">captcha_code</span>
    <span class="n">imgfile</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s1">&#39;PNG&#39;</span><span class="p">)</span>
    <span class="n">out</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">response</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="s1">&#39;image/png&#39;</span>
    <span class="k">return</span> <span class="n">response</span>
</pre></div>


<p>可见，其生成验证码后，就存储在session中了：<code>session['captcha'] = captcha_code</code>。</p>
<p>我们用浏览器访问<code>/captcha</code>，即可得到生成好的验证码图片，此时复制保存在cookie中的session值，用0x03中提供的脚本进行解码：</p>
<p><a href="../media/attachment/2018/03/26/668894a6-6f59-425b-b032-cba1370c39e9.png"><img alt="cf1b824b-9b61-4770-9224-1421e6fad65c.png" src="../media/attachment/2018/03/26/668894a6-6f59-425b-b032-cba1370c39e9.d200fedb421d.png" /></a></p>
<p>可见，我成功获取了验证码的值，进而可以绕过验证码的判断。</p>
<p>这也是客户端session的一种错误使用方法。</p>
<h2 id="0x05-codeigniter-214-session"><a class="toclink" href="#0x05-codeigniter-214-session">0x05 CodeIgniter 2.1.4 session伪造及对象注入漏洞</a></h2>
<p>Codeigniter 2的session也储存在session中，默认名为<code>ci_session</code>，默认值如下：</p>
<p><a href="../media/attachment/2018/03/26/cdd4d54b-8c8c-47f5-b364-e27d926ce1d2.png"><img alt="d2bd8335-a3e2-4f72-858f-4e93140dee6d.png" src="../media/attachment/2018/03/26/cdd4d54b-8c8c-47f5-b364-e27d926ce1d2.1f06e03915b6.png" /></a></p>
<p>可见，session数据被用PHP自带的serialize函数进行序列化，并签名后作为<code>ci_session</code>的值。原理上和flask如出一辙，我就不重述了。但好在codeigniter2支持对session进行加密，只需在配置文件中设置<code>$config['sess_encrypt_cookie']  = TRUE;</code>即可。</p>
<p>在CI2.1.4及以前的版本中，存在一个弱加密漏洞（ <a href="https://www.dionach.com/blog/codeigniter-session-decoding-vulnerability">https://www.dionach.com/blog/codeigniter-session-decoding-vulnerability</a> ），如果目标环境中没有安装Mcrypt扩展，则CI会使用一个相对比较弱的加密方式来处理session:</p>
<div class="codehilite"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">function</span> <span class="nf">_xor_encode</span><span class="p">(</span><span class="nv">$string</span><span class="p">,</span> <span class="nv">$key</span><span class="p">)</span>
<span class="p">{</span>
 <span class="nv">$rand</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
 <span class="k">while</span> <span class="p">(</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$rand</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span>
 <span class="p">{</span>
  <span class="nv">$rand</span> <span class="o">.=</span> <span class="nb">mt_rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">mt_getrandmax</span><span class="p">());</span>
 <span class="p">}</span>
 <span class="nv">$rand</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hash</span><span class="p">(</span><span class="nv">$rand</span><span class="p">);</span>
 <span class="nv">$enc</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
 <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$string</span><span class="p">);</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span>
 <span class="p">{</span>
  <span class="nv">$enc</span> <span class="o">.=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$rand</span><span class="p">,</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">%</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$rand</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="p">(</span><span class="nb">substr</span><span class="p">(</span><span class="nv">$rand</span><span class="p">,</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">%</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$rand</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$string</span><span class="p">,</span> <span class="nv">$i</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
 <span class="p">}</span>
 <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_xor_merge</span><span class="p">(</span><span class="nv">$enc</span><span class="p">,</span> <span class="nv">$key</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">_xor_merge</span><span class="p">(</span><span class="nv">$string</span><span class="p">,</span> <span class="nv">$key</span><span class="p">)</span>
<span class="p">{</span>
 <span class="nv">$hash</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hash</span><span class="p">(</span><span class="nv">$key</span><span class="p">);</span>
 <span class="nv">$str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
 <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$string</span><span class="p">);</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span>
 <span class="p">{</span>
  <span class="nv">$str</span> <span class="o">.=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$string</span><span class="p">,</span> <span class="nv">$i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$hash</span><span class="p">,</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">%</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$hash</span><span class="p">)),</span> <span class="mi">1</span><span class="p">);</span>
 <span class="p">}</span>
 <span class="k">return</span> <span class="nv">$str</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>其中用到了<code>mt_rand</code>、异或等存在大量缺陷的方法。我们通过几个简单的脚本（ <a href="https://github.com/Dionach/CodeIgniterXor">https://github.com/Dionach/CodeIgniterXor</a> ），即可在4秒到4分钟的时间，破解CI2的密钥。</p>
<p>获取到了密钥，我们即可篡改任意session，并自己签名及加密，最后伪造任意用户，注入任意对象，甚至通过反序列化操作造成更大的危害。</p>
<h2 id="0x06"><a class="toclink" href="#0x06">0x06 总结</a></h2>
<p>我以三个案例来说明了客户端session的安全问题。</p>
<p>上述三个问题，如果session是储存在服务器文件或数据库中，则不会出现。当然，考虑到flask和ci都是非常轻量的web框架，很可能运行在无法操作文件系统或没有数据库的服务器上，所以客户端session是无法避免的。</p>
<p>除此之外，我还能想到其他客户端session可能存在的安全隐患：</p>
<ol>
<li>签名使用hash函数而非hmac函数，导致利用hash长度扩展攻击来伪造session</li>
<li>任意文件读取导致密钥泄露，进一步造成身份伪造漏洞或反序列化漏洞（ <a href="http://www.loner.fm/drops/#!/drops/227.Codeigniter%20%E5%88%A9%E7%94%A8%E5%8A%A0%E5%AF%86Key%EF%BC%88%E5%AF%86%E9%92%A5%EF%BC%89%E7%9A%84%E5%AF%B9%E8%B1%A1%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E">http://www.loner.fm/drops/#!/drops/227.Codeigniter%20%E5%88%A9%E7%94%A8%E5%8A%A0%E5%AF%86Key%EF%BC%88%E5%AF%86%E9%92%A5%EF%BC%89%E7%9A%84%E5%AF%B9%E8%B1%A1%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E</a> ）</li>
<li>如果客户端session仅加密未签名，利用CBC字节翻转攻击，我们可以修改加密session中某部分数据，来达到身份伪造的目的</li>
</ol>
<p>上面说的几点，各位CTF出题人可以拿去做文章啦~嘿嘿。</p>
<p>相对的，作为一个开发者，如果我们使用的web框架或web语言的session是存储在客户端中，那就必须牢记下面几点：</p>
<ol>
<li>没有加密时，用户可以看到完整的session对象</li>
<li>加密/签名不完善或密钥泄露的情况下，用户可以修改任意session</li>
<li>使用强健的加密及签名算法，而不是自己造（反例discuz）</li>
</ol>
            </div>
            <div itemprop="keywords" class="tags-meta">
                标签:
                
                    <a href="../tag/flask.html">flask</a>
                
            </div>
            <br>
<!--MOB SHARE BEGIN-->
<div class="-mob-share-ui-button -mob-share-open">分享</div>
<div class="-mob-share-ui" style="display: none">
    <ul class="-mob-share-list">
        <li class="-mob-share-weibo"><p>新浪微博</p></li>
        <li class="-mob-share-qzone"><p>QQ空间</p></li>
        <li class="-mob-share-qq"><p>QQ好友</p></li>
        <li class="-mob-share-weixin"><p>微信</p></li>
        <li class="-mob-share-douban"><p>豆瓣</p></li>
        <li class="-mob-share-facebook"><p>Facebook</p></li>
        <li class="-mob-share-twitter"><p>Twitter</p></li>
        <li class="-mob-share-pocket"><p>Pocket</p></li>
        <li class="-mob-share-google"><p>Google+</p></li>
        <li class="-mob-share-youdao"><p>有道云笔记</p></li>
        <li class="-mob-share-mingdao"><p>明道</p></li>
        <li class="-mob-share-tumblr"><p>Tumblr</p></li>
        <li class="-mob-share-instapaper"><p>Instapaper</p></li>
        <li class="-mob-share-linkedin"><p>LinkedIn</p></li>
    </ul>
    <div class="-mob-share-close">取消</div>
</div>
<div class="-mob-share-ui-bg"></div>
<script id="-mob-share" src="https://f1.webshare.mob.com/code/mob-share.js?appkey=af155d9007c8"></script>
<!--MOB SHARE END-->

        <div class="qqlist">
          <h3>订阅本站<small>(RSS)</small></h3>
          <form method="post" target="_blank" action="https://list.qq.com/cgi-bin/qf_compose_send">
          <input type="hidden" value="qf_booked_feedback" name="t" />
          <input type="hidden" value="dace5c2b356504de449e7f3fc2bb59f3f6124d6563786446" name="id" />
          <input type="text" placeholder="E-mail" value="" class="rsstxt" name="to" id="to" />
          <button type="submit" >订阅&rarr;</button>
          </form>
        </div>


        </div>

        
        <div class="post-single type-post text-center">
            <h3 style="margin-top: 0">喜欢这篇文章，扫码和我成为赞友！</h3>
            <img src="../static/wx.jpg" width="280" alt="">
        </div>
        

        <!-- 评论位置 -->
        <div id="comments" class="comments">
          <h3>已有 9 条评论</h3>
            <ol class="comment-list">
            
            
              <li class="comment-body" id="comment-3641">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="../static/placeholder.jpg">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">JX</a></div>
                    <p>不错</p>
                    <span class="comment-time">时间: 2021-04-01 15:41</span>
                    <span class="comment-reply"><a href="#comment-3641" onclick="reply_to('3641','JX')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3454">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="../static/placeholder.jpg">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">im</a></div>
                    <p>session的加密解密过程都是一样的吗</p>
                    <span class="comment-time">时间: 2019-12-05 11:21</span>
                    <span class="comment-reply"><a href="#comment-3454" onclick="reply_to('3454','im')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3144">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="../static/placeholder.jpg">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">Peter</a></div>
                    <p>写的非常好，感谢！我有一个疑问，开头说“A用户的session无法被B用户获取”，这个是如何实现的呢？我想到一下session被窃取的场景：比如我同事打开我的浏览器复制了session的值，某攻击者通过JS脚本窃取（没有设置HTTPOnly）或是在传输过程中截获（非HTTPS且未开启secure选项）。这种情况下，session被窃取后，窃取者就可以使用我的账户访问网站。</p>
                    <span class="comment-time">时间: 2018-09-18 08:57</span>
                    <span class="comment-reply"><a href="#comment-3144" onclick="reply_to('3144','Peter')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3145">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="https://secure.gravatar.com/avatar/c4267eb6d17276fa31c547ac71611e90.jpg?s=100&amp;d=mm&amp;r=g">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="../index.html" target="_blank" rel="nofollow noopener">phithon</a></div>
                    <p>@Peter 你说的这种情况属于“中间人攻击”，我说的无法被B用户获取，是指网络上的A和B两个个体，不考虑中间人攻击的情况。</p>
                    <span class="comment-time">时间: 2018-09-18 14:14</span>
                    <span class="comment-reply"><a href="#comment-3145" onclick="reply_to('3145','phithon')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3094">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="https://secure.gravatar.com/avatar/ea05eeaac142783ab539e8c2a1857ce9.jpg?s=100&amp;d=mm&amp;r=g">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="http://xiaopo.me" target="_blank" rel="nofollow noopener">xiaopo</a></div>
                    <p>谢谢p牛文章，自己心中有个疑惑，加密/签名完整安全的机制（对于客户端session来说），是先加密session，然后对加密后的session再用hash(salt+加密session)签名防篡改，是这样吗？加密算法和签名算法的区别就是加密算法必须有相应的解密方法，而签名可以是hash这种单向算法，是这样吗？求p牛解惑，多谢。</p>
                    <span class="comment-time">时间: 2018-07-11 10:23</span>
                    <span class="comment-reply"><a href="#comment-3094" onclick="reply_to('3094','xiaopo')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3095">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="https://secure.gravatar.com/avatar/c4267eb6d17276fa31c547ac71611e90.jpg?s=100&amp;d=mm&amp;r=g">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="../index.html" target="_blank" rel="nofollow noopener">phithon</a></div>
                    <p>@xiaopo 可以这么理解。</p>
                    <span class="comment-time">时间: 2018-07-11 15:06</span>
                    <span class="comment-reply"><a href="#comment-3095" onclick="reply_to('3095','phithon')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3064">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="../static/placeholder.jpg">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">undefined</a></div>
                    <p>还可以，收集过一些基本文章做了写分析的猜想和实际利用，不精彩也不乏味</p>
                    <span class="comment-time">时间: 2018-04-19 17:03</span>
                    <span class="comment-reply"><a href="#comment-3064" onclick="reply_to('3064','undefined')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3087">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="../static/placeholder.jpg">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">number</a></div>
                    <p>@undefined @null 测试</p>
                    <span class="comment-time">时间: 2018-06-16 15:41</span>
                    <span class="comment-reply"><a href="#comment-3087" onclick="reply_to('3087','number')">回复</a></span>
                    </div>
                </div>
              </li>
            
              <li class="comment-body" id="comment-3052">
                <div class="clearfix">
                    <div class="comment-author">
                        <img src="https://secure.gravatar.com/avatar/b70a46f09148634901fa6e442fca8201.jpg?s=100&amp;d=mm&amp;r=g">
                    </div>
                    <div class="comment-meta">
                    <div class="fn"><a href="" target="_blank" rel="nofollow noopener">null</a></div>
                    <p>还可以，收集过一些基本文章做了写分析的猜想和实际利用，不精彩也不乏味</p>
                    <span class="comment-time">时间: 2018-03-30 15:35</span>
                    <span class="comment-reply"><a href="#comment-3052" onclick="reply_to('3052','null')">回复</a></span>
                    </div>
                </div>
              </li>
            
            
            </ol>
            
        </div>

        <div id="reply"></div>
        <div id="comment-place">
            <div id="comment-post" class="respond none-resize">
             <div id="respond">
                <h3 id="response">添加新评论</h3>
                <form method="post" id="comment-form" role="form" action="#comments">
                    <p>
                        <label for="author" class="required">称呼</label>
                        <input type="text" name="nickname" placeholder="昵称" maxlength="64" required id="id_nickname">
                    </p>
                    <p>
                        <label for="mail">Email</label>
                        <input type="text" name="email" placeholder="邮箱（可留空）" maxlength="254" id="id_email">
                    </p>
                    <p>
                        <label for="url">网站</label>
                        <input type="text" name="url" placeholder="链接（可留空）" maxlength="200" id="id_url">
                    </p>
                    <p>
                        <label for="textarea" class="required">内容</label>
                        <textarea name="content" cols="40" rows="6" required id="id_content">
</textarea>
                    </p>
                    <p>
                        <label style="float:left;">验证码</label>
                        <div class="row gx-2" style="margin-top: 8px"><div class="col-6"><input autocomplete="off" id="id_captcha_1" name="captcha_1" type="text" placeholder="验证码" /> <input id="id_captcha_0" name="captcha_0" type="hidden" value="2ad5962a95b25d53e7cb9ff673bec1e014a7b562" />
</div><div class="col-6">
<img src="../captcha/image/2ad5962a95b25d53e7cb9ff673bec1e014a7b562/index.png" alt="captcha" class="captcha" /></div></div>
                    </p>
                    <p>
                        <button type="submit" class="submit">提交评论</button>
                        <input type="hidden" name="parent" id="id_parent">
                        <input type="hidden" name="archive" value="433" id="id_archive">
                        <input type="hidden" name="csrfmiddlewaretoken" value="SOvbHGZ9HQt1nJlHxGHF5g67vdqOaSXQEmT2fLAS5cHKVh95zHEq2J9cQAHZJu98">
                    </p>
                </form>
                </div>
            </div>
        </div>

    </div>
    



<div  class="col-5 columns" id="sidebar" role="complementary">

  <div class="widget widget_search">
    <h3>搜索</h3>
    <form action="https://www.leavesongs.com/search/" id="searchform" method="get">
        <input type="text" id="searchkey" name="keyword" value="" class="searchkey" placeholder="Search..."/>
        <button type="submit"  id="searchsubmit">Go</button>
    </form>
  </div>

  
  <div class="widget">
	<h3 class="widget-title">最新评论</h3>
	<ul class="widget-list" id="recent-comment">
    
    
        <li id="comment" class="clearfix">
            <img class="avatar" src="../static/placeholder.jpg" alt="%s" width="40" height="40">
            <div class="comments-link"><cite>木木</cite>：<a href="../THINK/europe-trip-2022.html#comment-4523">虽然物价对比不出什么，但是还是觉得很高昂</a></div>
        </li>
    
        <li id="comment" class="clearfix">
            <img class="avatar" src="../static/placeholder.jpg" alt="%s" width="40" height="40">
            <div class="comments-link"><cite>dongdong4fei</cite>：<a href="../THINK/using-chatgpt-for-antispam.html#comment-4520">肯德基疯狂星期四！ 疯狂星期四！  https://m.kfc.com.cn/wechatco...</a></div>
        </li>
    
        <li id="comment" class="clearfix">
            <img class="avatar" src="../static/placeholder.jpg" alt="%s" width="40" height="40">
            <div class="comments-link"><cite>dongdong4fei</cite>：<a href="../THINK/using-chatgpt-for-antispam.html#comment-4519">小猪咪小猪咪小猪咪</a></div>
        </li>
    
        <li id="comment" class="clearfix">
            <img class="avatar" src="../static/placeholder.jpg" alt="%s" width="40" height="40">
            <div class="comments-link"><cite>sam</cite>：<a href="javascript-prototype-pollution-attack.html#comment-4518">还得是P神，文章一看就懂</a></div>
        </li>
    
        <li id="comment" class="clearfix">
            <img class="avatar" src="../static/placeholder.jpg" alt="%s" width="40" height="40">
            <div class="comments-link"><cite>程序</cite>：<a href="discuz72-sql-injection.html#comment-4517">很不错的文章</a></div>
        </li>
    
    </ul>
  </div>

  <div class="widget widget-category">
	<h3>分类</h3>
	<ul id="blogsort" class="widget-list">
    
    
    <li>
        <a href="../sort/PENETRATION.html">网络安全<em>143</em></a>
    </li>
    
    <li>
        <a href="../sort/C.html">C/C++<em>32</em></a>
    </li>
    
    <li>
        <a href="../sort/THINK.html">心得与体会<em>24</em></a>
    </li>
    
    <li>
        <a href="../sort/PYTHON.html">Python<em>19</em></a>
    </li>
    
    <li>
        <a href="../sort/SHARE.html">资源分享<em>16</em></a>
    </li>
    
    </ul>
  </div>

  <div class="widget widget-tag">
	<h3>随机标签</h3>
	<div class="tag-cloud">
        
        
        <a rel="tag" href="../tag/%E5%A4%A7%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86.html">大文件处理</a>
        
        <a rel="tag" href="../tag/%E5%9B%9E%E8%B0%83%E5%90%8E%E9%97%A8.html">回调后门</a>
        
        <a rel="tag" href="../tag/iOS.html">iOS</a>
        
        <a rel="tag" href="../tag/%E4%BD%8D%E8%BF%90%E7%AE%97.html">位运算</a>
        
        <a rel="tag" href="../tag/%E6%A1%A5%E6%8E%A5.html">桥接</a>
        
        <a rel="tag" href="../tag/writeup.html">writeup</a>
        
        <a rel="tag" href="../tag/IIS.html">IIS</a>
        
        <a rel="tag" href="../tag/WTForm.html">WTForm</a>
        
        <a rel="tag" href="../tag/apache.html">apache</a>
        
        <a rel="tag" href="../tag/web%E6%8C%87%E7%BA%B9.html">web指纹</a>
        
        <a rel="tag" href="../tag/%E6%B1%89%E8%AF%BA%E5%A1%94.html">汉诺塔</a>
        
        <a rel="tag" href="../tag/cmd%E5%90%8E%E9%97%A8.html">cmd后门</a>
        
        <a rel="tag" href="../tag/Linux.html">Linux</a>
        
        <a rel="tag" href="../tag/CSP.html">CSP</a>
        
        <a rel="tag" href="../tag/%E5%9B%A2%E9%98%9F.html">团队</a>
        
        <a rel="tag" href="../tag/phpwind.html">phpwind</a>
        
        <a rel="tag" href="../tag/%E6%80%BB%E7%BB%93.html">总结</a>
        
        <a rel="tag" href="../tag/%E9%81%8D%E5%8E%86%E7%9B%AE%E5%BD%95.html">遍历目录</a>
        
        <a rel="tag" href="../tag/C-FREE.html">C-FREE</a>
        
        <a rel="tag" href="../tag/var_dump.html">var_dump</a>
        
        <a rel="tag" href="../tag/disable_functions.html">disable_functions</a>
        
        <a rel="tag" href="../tag/%E6%8A%A5%E7%BA%B8.html">报纸</a>
        
        <a rel="tag" href="../tag/%E8%B6%8A%E6%9D%83%E6%BC%8F%E6%B4%9E.html">越权漏洞</a>
        
        <a rel="tag" href="../tag/web%E5%BA%94%E7%94%A8.html">web应用</a>
        
        <a rel="tag" href="../tag/360webscan.html">360webscan</a>
        
        <a rel="tag" href="../tag/asyncore.html">asyncore</a>
        
        <a rel="tag" href="../tag/%E6%B2%99%E7%9B%92%E7%BB%95%E8%BF%87.html">沙盒绕过</a>
        
        <a rel="tag" href="../tag/fckeditor.html">fckeditor</a>
        
        <a rel="tag" href="../tag/%E6%95%B0%E6%8D%AE%E5%BA%93%E9%80%9F%E5%BA%A6.html">数据库速度</a>
        
        <a rel="tag" href="../tag/kali.html">kali</a>
        
    </div>
  </div>

  <div class="widget widget-recent-entries">
	<h3 class="widget-title">热门日志</h3>
	<ul id="hotlog" class="widget-list">
    
    
        <li><a href="../other/tinger.html">About.Me</a></li>
    
        <li><a href="detect-django.html">如何判断目标站点是否为Django开发</a></li>
    
        <li><a href="webshell-without-alphanum-advanced.html">无字母数字webshell之提高篇</a></li>
    
        <li><a href="webshell-without-alphanum.html">一些不包含数字和字母的webshell</a></li>
    
        <li><a href="php-filter-magic.html">谈一谈php://filter的妙用</a></li>
    
    </ul>
  </div>
  

</div>
</div>

<div id="footer">
	<!-- copyright -->
	<div class="container">
		<div class="row remove-bottom">
			<div class="col-6 columns">
			<h3>Little About</h3>
			<p>Phithon 非强迫症小青年  <br>
现居先 <br>
爱好：种花、买书、收藏明信片 <br>
欢迎各大组织收留 <br>
E-mail：root@leavesongs.com </p>
			</div>

			<div class="col-10 columns">

				<h3 class="mobile-hide">Follow me</h3>
        <div id="social-links">
          <a href="http://weibo.com/101yx" class="sweibo" target="_blank" title="新浪微博">新浪微博</a>
          <a href="javascript:alert(/没有腾讯微博哟/)" class="qweibo" target="_blank" title="腾讯微博">腾讯微博</a>
          <a href="javascript:alert(/墙外有什么/);window.open('http://google.com')" class="google" target="_blank" title="墙外的世界">google+</a>
          <a href="https://github.com/phith0n" class="github" target="_blank" title="Github">github</a>
          <a href="javascript:confirm(/mailto:root#leavesongs.com/)" class="mail" target="_blank" title="私信给我">私信给我</a>
          <a href="../feed/index.rss" target="_blank" class="rss" title="离别歌">RSS订阅</a>
        </div>
        <div class="bot-line"></div>
				<p class="copyright">
	Copyright &copy; Powered by talkbook
				&nbsp;&nbsp;<i>Designed and built with all the love in the world by <a href="../index.html" target="_blank">Phithon</a> && deepsky </i>
                    <a href="../index.html">更换模板</a>
				</p>
			</div>
		</div>
	</div>
	<!-- /copyright -->
</div>
<a href="#" id="go-top">Top ↑</a>
<script src="https://cdn.staticfile.org/jquery/1.12.4/jquery.min.js"></script>
<script src="https://cdn.staticfile.org/jquery.appear/0.4.1/jquery.appear.min.js"></script>
<script src="../static/deep/js/common_tpl.js" type="text/javascript"></script>
<script src="../static/deep/js/config.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-FF5KPQ1CZ6"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-FF5KPQ1CZ6');
</script>

<script src="https://cdn.staticfile.org/fancybox/2.1.7/js/jquery.fancybox.min.js"></script>
<script>
$(document).ready(function () {
    $(".entry a").each(function (i, e) {
        if(e.host != 'www.leavesongs.com') {
            e.target = '_blank';
        }
    });
    $(".entry img").each(function (i, e) {
        if(e.parentNode.tagName.toUpperCase() != 'A') {
            $(e).wrap('<a href="'+escapeHtml(e.src)+'" class="fancybox"></a>');
        } else {
            $(e.parentNode).addClass('fancybox');
        }
    });
    $('.fancybox').fancybox();
})
</script>

</body>

</html>