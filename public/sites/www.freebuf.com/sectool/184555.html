<!--
                              _.._        ,------------.
                           ,'      `.    ( We want you! )
                          /  __) __` \    `-,----------'
                         (  (`-`(-')  ) _.-'
                         /)  \  = /  (
                        /'    |--' .  \
                       (  ,---|  `-.)__`
                        )(  `-.,--'   _`-.
                       '/,'          (  Uu",
                        (_       ,    `/,-' )
                        `.__,  : `-'/  /`--'
                          |     `--'  |
                          `   `-._   /
                           \        (
                           /\ .      \.  freebuf
                          / |` \     ,-\
                         /  \| .)   /   \
                        ( ,'|\    ,'     :
                        | \,`.`--"/      }
                        `,'    \  |,'    /
                       / "-._   `-/      |
                       "-.   "-.,'|     ;
                      /        _/["---'""]
                     :        /  |"-     '
                     '           |      /
                                 `      |
-->
<!doctype html>
<html data-n-head-ssr>

<head>
  <title>伪造电子邮件以及制造电子邮件炸弹的攻防探讨 - FreeBuf网络安全行业门户</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" name="renderer" content="webkit"><meta data-n-head="ssr" http-equiv="X-UA-Compatible" content="IE=edge"><meta data-n-head="ssr" name="baidu-site-verification" content="nKKKqQxp6R"><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,inital-scal=1"><meta data-n-head="ssr" data-hid="description" name="description" content="想必熟悉 kali 或者接触过 smtp 相关分析的人都听说过 Swaks 这个工具，我用 Python 自己写了一个类似的工具，加上了邮件炸弹的功能，顺带分析一波原理。"><meta data-n-head="ssr" name="keywords" content="sectool,network,Kali,SMTP,邮件炸弹"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="https://www.freebuf.com/favicon.ico"><link data-n-head="ssr" rel="stylesheet" href="https://www.freebuf.com/style/editor.css"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.f2bddb9b2047fee49046.js" as="script"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.32658a830f395d50ed89.js" as="script"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.a53ea8b00779fcef0fe8.js" as="script"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.8c990f909effb6d618d3.css" as="style"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.e258e4cfb199b83189c6.js" as="script"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.19981de942074100ce9c.css" as="style"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.927944ae29787a1b414f.js" as="script"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.02cf93cfce14e2557064.js" as="script"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.d38dc245ca9b7dd8571d.js" as="script"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.e21c04f32fbd7819bb01.css" as="style"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.2ce4e8f001d4b2b67fbb.js" as="script"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.4a67fc481049623895c6.css" as="style"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.627b1661cc29c3e32429.js" as="script"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.7b5eb7ff4936b9e0c27a.css" as="style"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.9b4235960ae0c2cc9600.js" as="script"><link rel="stylesheet" href="https://www.freebuf.com/freebuf/2.1.0.8c990f909effb6d618d3.css"><link rel="stylesheet" href="https://www.freebuf.com/freebuf/2.1.0.19981de942074100ce9c.css"><link rel="stylesheet" href="https://www.freebuf.com/freebuf/2.1.0.e21c04f32fbd7819bb01.css"><link rel="stylesheet" href="https://www.freebuf.com/freebuf/2.1.0.4a67fc481049623895c6.css"><link rel="stylesheet" href="https://www.freebuf.com/freebuf/2.1.0.7b5eb7ff4936b9e0c27a.css">
</head>

<body>
  <div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div id="components-layout-demo-basic" class="public-header-article" data-v-55d8de90><section class="ant-layout" data-v-55d8de90><header class="articles-layout-header ant-layout-header" style="position:fixed;z-index:51;width:100%" data-v-55d8de90><div class="content-header" data-v-55d8de90><a href="https://www.freebuf.com/" class="logo-view nuxt-link-active" data-v-c5f1b53a data-v-55d8de90><img src="https://www.freebuf.com/images/logoMax.png" alt="freeBuf" style="color:#fff" data-v-c5f1b53a></a> <div class="main-view" data-v-6072cd9c data-v-55d8de90><div class="main-but" data-v-6072cd9c><span style="font-size:14px;display:inline-block;white-space:nowrap;letter-spacing:1px" data-v-6072cd9c>主站</span> <svg aria-hidden="true" class="svg-icon main-slider-cion" style="margin-left:3px" data-v-322983b7 data-v-6072cd9c><use xlink:href="#caret-down" data-v-322983b7></use></svg> <div class="main-but-view" data-v-6072cd9c><div data-v-6072cd9c><div class="tag-top" data-v-6072cd9c><p data-v-6072cd9c><svg aria-hidden="true" class="svg-icon tag-svg" data-v-322983b7 data-v-6072cd9c><use xlink:href="#heike" data-v-322983b7></use></svg><span data-v-6072cd9c>分类</span></p> <div class="tag-top-bottom" data-v-6072cd9c><span class="border-none" data-v-6072cd9c>
              漏洞
            </span> <span class="nuxt-link-active" data-v-6072cd9c>
              工具
            </span> <span data-v-6072cd9c>
              极客
            </span> <span data-v-6072cd9c>
              Web安全
            </span> <span data-v-6072cd9c>
              系统安全
            </span> <span data-v-6072cd9c>
              网络安全
            </span> <span data-v-6072cd9c>
              无线安全
            </span> <span class="border-none" data-v-6072cd9c>
              设备/客户端安全
            </span> <span data-v-6072cd9c>
              数据安全
            </span> <span data-v-6072cd9c>
              安全管理
            </span> <span data-v-6072cd9c>
              企业安全
            </span> <span data-v-6072cd9c>
              工控安全
            </span></div></div> <div class="tag-top" style="margin-top:10px" data-v-6072cd9c><p data-v-6072cd9c><svg aria-hidden="true" class="svg-icon tag-svg" data-v-322983b7 data-v-6072cd9c><use xlink:href="#eye-fill" data-v-322983b7></use></svg><span data-v-6072cd9c>特色</span></p> <div class="tag-top-bottom" data-v-6072cd9c><span class="border-none" data-v-6072cd9c>
              头条
            </span> <span data-v-6072cd9c>
              人物志
            </span> <span data-v-6072cd9c>
              活动
            </span> <span data-v-6072cd9c>
              视频
            </span> <span data-v-6072cd9c>
              观点
            </span> <span data-v-6072cd9c>
              招聘
            </span> <span data-v-6072cd9c>
              报告
            </span> <span data-v-6072cd9c>
              资讯
            </span> <span class="border-none" data-v-6072cd9c>
              区块链安全
            </span> <span data-v-6072cd9c>
              标准与合规
            </span> <span data-v-6072cd9c>
              容器安全
            </span> <span data-v-6072cd9c>
              公开课
            </span></div></div></div> <div class="tag-bottom" data-v-6072cd9c><a href="https://www.freebuf.com/report" target="_blank" class="left-slider-but" data-v-6072cd9c><svg aria-hidden="true" class="svg-icon tag-svg" data-v-322983b7 data-v-6072cd9c><use xlink:href="#file-text-fill" data-v-322983b7></use></svg><span data-v-6072cd9c>报告</span></a> <div role="separator" class="ant-divider ant-divider-vertical" style="margin:0 30px;background:#3a3a3a" data-v-6072cd9c></div> <a href="https://www.freebuf.com/column" data-v-6072cd9c><svg aria-hidden="true" class="svg-icon tag-svg" data-v-322983b7 data-v-6072cd9c><use xlink:href="#folder-open-fill" data-v-322983b7></use></svg><span data-v-6072cd9c>专辑</span></a></div></div></div></div> <div class="menu-view" data-v-377c74a3 data-v-55d8de90><ul role="menu" class="ant-menu ant-menu-horizontal ant-menu-root ant-menu-dark" data-v-377c74a3><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item" data-v-377c74a3><a href="https://live.freebuf.com" target="_blank" data-v-377c74a3>公开课</a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item" data-v-377c74a3><a href="https://shop.freebuf.com" target="_blank" data-v-377c74a3>商城</a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="menu-item-self ant-menu-submenu ant-menu-submenu-horizontal" data-v-377c74a3><div aria-haspopup="true" class="ant-menu-submenu-title"><span class="submenu-title-wrapper" data-v-377c74a3>
						用户服务
						<svg aria-hidden="true" class="svg-icon home-menu" data-v-322983b7 data-v-377c74a3><use xlink:href="#caret-down" data-v-322983b7></use></svg></span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="visibility:hidden;position:absolute"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li></ul> <div class="feature-column-container" data-v-05e06156 data-v-377c74a3><span class="feature-column-item" data-v-05e06156>行业服务
    <svg aria-hidden="true" class="svg-icon home-menu" data-v-322983b7 data-v-05e06156><use xlink:href="#caret-down" data-v-322983b7></use></svg></span> <div class="feature-column-menu" data-v-05e06156><div class="feature-column" data-v-05e06156><span data-v-05e06156><svg aria-hidden="true" class="svg-icon zhengfu" data-v-322983b7 data-v-05e06156><use xlink:href="#zhengfu" data-v-322983b7></use></svg>
        政 府
      </span> <div data-v-05e06156><span data-v-05e06156>
          CNCERT
          <span class="line" data-v-05e06156></span></span><span data-v-05e06156>
          CNNVD
          <!----></span></div></div> <div class="company-rewrite" data-v-05e06156><span data-v-05e06156>
        会员体系（甲方）
        <span class="line" data-v-05e06156></span></span><span data-v-05e06156>
        会员体系（厂商）
        <span class="line" data-v-05e06156></span></span><span data-v-05e06156>
        产品名录
        <span class="line" data-v-05e06156></span></span><span data-v-05e06156>
        企业空间
        <!----></span></div></div></div> <span class="wikibtn" data-v-377c74a3><a href="https://wiki.freebuf.com/page" target="_blank" data-v-377c74a3>知识大陆</a></span></div> <div class="user-view" data-v-55d8de90><div class="search-cloud"><i aria-label="icon: search" class="anticon anticon-search" style="color:rgba(255,255,255,.6)"><svg viewBox="64 64 896 896" focusable="false" data-icon="search" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M909.6 854.5L649.9 594.8C690.2 542.7 712 479 712 412c0-80.2-31.3-155.4-87.9-212.1-56.6-56.7-132-87.9-212.1-87.9s-155.5 31.3-212.1 87.9C143.2 256.5 112 331.8 112 412c0 80.1 31.3 155.5 87.9 212.1C256.5 680.8 331.8 712 412 712c67 0 130.6-21.8 182.7-62l259.7 259.6a8.2 8.2 0 0 0 11.6 0l43.6-43.5a8.2 8.2 0 0 0 0-11.6zM570.4 570.4C528 612.7 471.8 636 412 636s-116-23.3-158.4-65.6C211.3 528 188 471.8 188 412s23.3-116.1 65.6-158.4C296 211.3 352.2 188 412 188s116.1 23.2 158.4 65.6S636 352.2 636 412s-23.3 116.1-65.6 158.4z"></path></svg></i> <span class="ant-input-search ant-input-search-enter-button ant-input-group-wrapper"><span class="ant-input-wrapper ant-input-group"><input placeholder="搜索关键词..." class="ant-input"><span class="ant-input-group-addon"><button type="button" class="ant-btn ant-input-search-button"><span>搜索</span></button></span></span></span></div> <div class="guide-write-wrap"><button type="button" class="write-btn ant-btn ant-btn-primary ant-dropdown-trigger"><span>创作中心</span></button> <!----></div> <div class="tool-but-view album-square ant-dropdown-trigger"><svg aria-hidden="true" class="svg-icon" data-v-322983b7><use xlink:href="#album-square-hover" data-v-322983b7></use></svg></div> <div class="tool-but-view album-square ant-dropdown-trigger"><svg aria-hidden="true" class="svg-icon" data-v-322983b7><use xlink:href="#load-app" data-v-322983b7></use></svg></div> <div class="tool-but-view ant-dropdown-trigger"><svg aria-hidden="true" class="svg-icon" data-v-322983b7><use xlink:href="#calendar" data-v-322983b7></use></svg></div> <div class="tool-but-view ant-dropdown-trigger"><svg aria-hidden="true" class="svg-icon" data-v-322983b7><use xlink:href="#tool" data-v-322983b7></use></svg></div> <button type="button" class="login-register ant-btn ant-btn-primary"><a href="https://www.freebuf.com/oauth" class="login-but login-btn">登录</a><a href="https://account.tophant.com/register" class="login-but">注册</a></button></div></div></header> <main class="content-body ant-layout-content" style="padding:20px 0;margin-top:55px" data-v-55d8de90><div id="artical-detail-page" data-v-81187e68 data-v-55d8de90 data-v-55d8de90><div class="floating-view" data-v-a4133620 data-v-81187e68><!----> <div class="floating-view-item qianbao" data-v-a4133620></div> <div class="floating-view-item" data-v-a4133620><svg aria-hidden="true" class="svg-icon floating-icon" data-v-322983b7 data-v-a4133620><use xlink:href="#edit1" data-v-322983b7></use></svg></div> <div class="floating-view-item qrcode-box" data-v-a4133620><svg aria-hidden="true" class="svg-icon floating-icon" data-v-322983b7 data-v-a4133620><use xlink:href="#qrcode" data-v-322983b7></use></svg> <div class="qrcode-list" data-v-a4133620><div class="tab-view" data-v-a4133620><p data-v-a4133620><span class="active" data-v-a4133620>官方公众号</span><span data-v-a4133620>企业安全</span><span data-v-a4133620>新浪微博</span></p> <div class="qrcode-view" data-v-a4133620><img src="https://www.freebuf.com/images/gzh_code.jpg" alt data-v-a4133620> <p data-v-a4133620>FreeBuf.COM网络安全行业门户，每日发布专业的安全资讯、技术剖析。</p></div></div> <div class="sanjiao-view" data-v-a4133620></div></div></div> <div class="floating-view-item qrcode-xcx" data-v-a4133620><svg aria-hidden="true" class="svg-icon floating-icon" data-v-322983b7 data-v-a4133620><use xlink:href="#erweima" data-v-322983b7></use></svg> <div class="qrcode-list" data-v-a4133620><div class="tab-view" data-v-a4133620><div class="qrcode-view xcx-box" data-v-a4133620><img src="https://www.freebuf.com/images/xcx-code.jpg" alt="FreeBuf+小程序" style="color:#fff" data-v-a4133620> <p class="xcx-wiew" data-v-a4133620><span data-v-a4133620>FreeBuf+小程序</span><label data-v-a4133620>把安全装进口袋</label></p></div></div> <div class="sanjiao-view" data-v-a4133620></div></div></div> <div class="floating-view-item qrcode-xcx" data-v-a4133620><a href="https://wiki.freebuf.com/page" target="_blank" data-v-a4133620><svg aria-hidden="true" class="svg-icon" style="font-size:17px" data-v-322983b7 data-v-a4133620><use xlink:href="#wiki_tip" data-v-322983b7></use></svg></a></div> <div style="width:40px;height:40px" data-v-a4133620><!----></div> <!----> <!----> <!----></div> <div class="page-header" data-v-81187e68><div class="header-container" data-v-81187e68><div class="page-head-wrapper" data-v-81187e68><div class="title" data-v-81187e68>伪造电子邮件以及制造电子邮件炸弹的攻防探讨</div> <ul class="wrpper" data-v-81187e68><li class="auth" data-v-81187e68><a href="" data-v-81187e68><span class="img" data-v-81187e68><img src="" data-v-81187e68></span> <span class="name" data-v-81187e68></span></a></li> <li class="collet" data-v-81187e68><span class="focus" data-v-81187e68>
								关注
							</span></li> <!----></ul></div></div></div> <div class="container" data-v-81187e68><div class="aside-left" data-v-81187e68><div class="aside-left-wrapper" data-v-81187e68><ul class="tabs-panel" data-v-81187e68><li class="tab active" data-v-81187e68><a href="https://www.freebuf.com/sectool" target="_blank" data-v-81187e68>工具</a></li><li class="tab" data-v-81187e68><a href="https://www.freebuf.com/articles/network" target="_blank" data-v-81187e68>网络安全</a></li></ul> <div class="approve-panel" data-v-81187e68><div class="approve" data-v-81187e68><div data-v-81187e68><span class="ant-badge" data-v-81187e68><i aria-label="图标: like" class="anticon anticon-like" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="like" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M885.9 533.7c16.8-22.2 26.1-49.4 26.1-77.7 0-44.9-25.1-87.4-65.5-111.1a67.67 67.67 0 0 0-34.3-9.3H572.4l6-122.9c1.4-29.7-9.1-57.9-29.5-79.4A106.62 106.62 0 0 0 471 99.9c-52 0-98 35-111.8 85.1l-85.9 311H144c-17.7 0-32 14.3-32 32v364c0 17.7 14.3 32 32 32h601.3c9.2 0 18.2-1.8 26.5-5.4 47.6-20.3 78.3-66.8 78.3-118.4 0-12.6-1.8-25-5.4-37 16.8-22.2 26.1-49.4 26.1-77.7 0-12.6-1.8-25-5.4-37 16.8-22.2 26.1-49.4 26.1-77.7-.2-12.6-2-25.1-5.6-37.1zM184 852V568h81v284h-81zm636.4-353l-21.9 19 13.9 25.4a56.2 56.2 0 0 1 6.9 27.3c0 16.5-7.2 32.2-19.6 43l-21.9 19 13.9 25.4a56.2 56.2 0 0 1 6.9 27.3c0 16.5-7.2 32.2-19.6 43l-21.9 19 13.9 25.4a56.2 56.2 0 0 1 6.9 27.3c0 22.4-13.2 42.6-33.6 51.8H329V564.8l99.5-360.5a44.1 44.1 0 0 1 42.2-32.3c7.6 0 15.1 2.2 21.1 6.7 9.9 7.4 15.2 18.6 14.6 30.5l-9.6 198.4h314.4C829 418.5 840 436.9 840 456c0 16.5-7.2 32.1-19.6 43z"></path></svg></i><!----></span></div></div> <div class="approve" data-v-81187e68><div data-v-81187e68><span class="ant-badge" data-v-81187e68><i aria-label="图标: message" class="anticon anticon-message" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="message" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M464 512a48 48 0 1 0 96 0 48 48 0 1 0-96 0zm200 0a48 48 0 1 0 96 0 48 48 0 1 0-96 0zm-400 0a48 48 0 1 0 96 0 48 48 0 1 0-96 0zm661.2-173.6c-22.6-53.7-55-101.9-96.3-143.3a444.35 444.35 0 0 0-143.3-96.3C630.6 75.7 572.2 64 512 64h-2c-60.6.3-119.3 12.3-174.5 35.9a445.35 445.35 0 0 0-142 96.5c-40.9 41.3-73 89.3-95.2 142.8-23 55.4-34.6 114.3-34.3 174.9A449.4 449.4 0 0 0 112 714v152a46 46 0 0 0 46 46h152.1A449.4 449.4 0 0 0 510 960h2.1c59.9 0 118-11.6 172.7-34.3a444.48 444.48 0 0 0 142.8-95.2c41.3-40.9 73.8-88.7 96.5-142 23.6-55.2 35.6-113.9 35.9-174.5.3-60.9-11.5-120-34.8-175.6zm-151.1 438C704 845.8 611 884 512 884h-1.7c-60.3-.3-120.2-15.3-173.1-43.5l-8.4-4.5H188V695.2l-4.5-8.4C155.3 633.9 140.3 574 140 513.7c-.4-99.7 37.7-193.3 107.6-263.8 69.8-70.5 163.1-109.5 262.8-109.9h1.7c50 0 98.5 9.7 144.2 28.9 44.6 18.7 84.6 45.6 119 80 34.3 34.3 61.3 74.4 80 119 19.4 46.2 29.1 95.2 28.9 145.8-.6 99.6-39.7 192.9-110.1 262.7z"></path></svg></i><!----></span></div></div> <div class="approve" data-v-81187e68><div data-v-81187e68 data-v-81187e68><i aria-label="图标: star" class="anticon anticon-star" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="star" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M908.1 353.1l-253.9-36.9L540.7 86.1c-3.1-6.3-8.2-11.4-14.5-14.5-15.8-7.8-35-1.3-42.9 14.5L369.8 316.2l-253.9 36.9c-7 1-13.4 4.3-18.3 9.3a32.05 32.05 0 0 0 .6 45.3l183.7 179.1-43.4 252.9a31.95 31.95 0 0 0 46.4 33.7L512 754l227.1 119.4c6.2 3.3 13.4 4.4 20.3 3.2 17.4-3 29.1-19.5 26.1-36.9l-43.4-252.9 183.7-179.1c5-4.9 8.3-11.3 9.3-18.3 2.7-17.5-9.5-33.7-27-36.3zM664.8 561.6l36.1 210.3L512 672.7 323.1 772l36.1-210.3-152.8-149L417.6 382 512 190.7 606.4 382l211.2 30.7-152.8 148.9z"></path></svg></i></div></div> <div class="approve" data-v-81187e68><div data-v-81187e68 data-v-81187e68><svg aria-hidden="true" class="svg-icon" style="font-size:20px" data-v-322983b7 data-v-81187e68><use xlink:href="#collect" data-v-322983b7></use></svg></div></div> <div class="approve" data-v-81187e68><div class="share-draw" data-v-81187e68><i aria-label="图标: share-alt" class="anticon anticon-share-alt" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="share-alt" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M752 664c-28.5 0-54.8 10-75.4 26.7L469.4 540.8a160.68 160.68 0 0 0 0-57.6l207.2-149.9C697.2 350 723.5 360 752 360c66.2 0 120-53.8 120-120s-53.8-120-120-120-120 53.8-120 120c0 11.6 1.6 22.7 4.7 33.3L439.9 415.8C410.7 377.1 364.3 352 312 352c-88.4 0-160 71.6-160 160s71.6 160 160 160c52.3 0 98.7-25.1 127.9-63.8l196.8 142.5c-3.1 10.6-4.7 21.8-4.7 33.3 0 66.2 53.8 120 120 120s120-53.8 120-120-53.8-120-120-120zm0-476c28.7 0 52 23.3 52 52s-23.3 52-52 52-52-23.3-52-52 23.3-52 52-52zM312 600c-48.5 0-88-39.5-88-88s39.5-88 88-88 88 39.5 88 88-39.5 88-88 88zm440 236c-28.7 0-52-23.3-52-52s23.3-52 52-52 52 23.3 52 52-23.3 52-52 52z"></path></svg></i></div></div> <div style="display:none" data-v-81187e68><div class="approve" data-v-81187e68 data-v-81187e68><div class="share-draw" data-v-81187e68><i aria-label="图标: wechat" class="anticon anticon-wechat" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="wechat" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M690.1 377.4c5.9 0 11.8.2 17.6.5-24.4-128.7-158.3-227.1-319.9-227.1C209 150.8 64 271.4 64 420.2c0 81.1 43.6 154.2 111.9 203.6a21.5 21.5 0 0 1 9.1 17.6c0 2.4-.5 4.6-1.1 6.9-5.5 20.3-14.2 52.8-14.6 54.3-.7 2.6-1.7 5.2-1.7 7.9 0 5.9 4.8 10.8 10.8 10.8 2.3 0 4.2-.9 6.2-2l70.9-40.9c5.3-3.1 11-5 17.2-5 3.2 0 6.4.5 9.5 1.4 33.1 9.5 68.8 14.8 105.7 14.8 6 0 11.9-.1 17.8-.4-7.1-21-10.9-43.1-10.9-66 0-135.8 132.2-245.8 295.3-245.8zm-194.3-86.5c23.8 0 43.2 19.3 43.2 43.1s-19.3 43.1-43.2 43.1c-23.8 0-43.2-19.3-43.2-43.1s19.4-43.1 43.2-43.1zm-215.9 86.2c-23.8 0-43.2-19.3-43.2-43.1s19.3-43.1 43.2-43.1 43.2 19.3 43.2 43.1-19.4 43.1-43.2 43.1zm586.8 415.6c56.9-41.2 93.2-102 93.2-169.7 0-124-120.8-224.5-269.9-224.5-149 0-269.9 100.5-269.9 224.5S540.9 847.5 690 847.5c30.8 0 60.6-4.4 88.1-12.3 2.6-.8 5.2-1.2 7.9-1.2 5.2 0 9.9 1.6 14.3 4.1l59.1 34c1.7 1 3.3 1.7 5.2 1.7a9 9 0 0 0 6.4-2.6 9 9 0 0 0 2.6-6.4c0-2.2-.9-4.4-1.4-6.6-.3-1.2-7.6-28.3-12.2-45.3-.5-1.9-.9-3.8-.9-5.7.1-5.9 3.1-11.2 7.6-14.5zM600.2 587.2c-19.9 0-36-16.1-36-35.9 0-19.8 16.1-35.9 36-35.9s36 16.1 36 35.9c0 19.8-16.2 35.9-36 35.9zm179.9 0c-19.9 0-36-16.1-36-35.9 0-19.8 16.1-35.9 36-35.9s36 16.1 36 35.9a36.08 36.08 0 0 1-36 35.9z"></path></svg></i></div></div> <div class="approve" data-v-81187e68><div class="share-draw" data-v-81187e68><i aria-label="图标: weibo-circle" class="anticon anticon-weibo-circle" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="weibo-circle" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm-44.4 672C353.1 736 236 680.4 236 588.9c0-47.8 30.2-103.1 82.3-155.3 69.5-69.6 150.6-101.4 181.1-70.8 13.5 13.5 14.8 36.8 6.1 64.6-4.5 14 13.1 6.3 13.1 6.3 56.2-23.6 105.2-25 123.1.7 9.6 13.7 8.6 32.8-.2 55.1-4.1 10.2 1.3 11.8 9 14.1 31.7 9.8 66.9 33.6 66.9 75.5.2 69.5-99.7 156.9-249.8 156.9zm207.3-290.8a34.9 34.9 0 0 0-7.2-34.1 34.68 34.68 0 0 0-33.1-10.7 18.24 18.24 0 0 1-7.6-35.7c24.1-5.1 50.1 2.3 67.7 21.9 17.7 19.6 22.4 46.3 14.9 69.8a18.13 18.13 0 0 1-22.9 11.7 18.18 18.18 0 0 1-11.8-22.9zm106 34.3s0 .1 0 0a21.1 21.1 0 0 1-26.6 13.7 21.19 21.19 0 0 1-13.6-26.7c11-34.2 4-73.2-21.7-101.8a104.04 104.04 0 0 0-98.9-32.1 21.14 21.14 0 0 1-25.1-16.3 21.07 21.07 0 0 1 16.2-25.1c49.4-10.5 102.8 4.8 139.1 45.1 36.3 40.2 46.1 95.1 30.6 143.2zm-334.5 6.1c-91.4 9-160.7 65.1-154.7 125.2 5.9 60.1 84.8 101.5 176.2 92.5 91.4-9.1 160.7-65.1 154.7-125.3-5.9-60.1-84.8-101.5-176.2-92.4zm80.2 141.7c-18.7 42.3-72.3 64.8-117.8 50.1-43.9-14.2-62.5-57.7-43.3-96.8 18.9-38.4 68-60.1 111.5-48.8 45 11.7 68 54.2 49.6 95.5zm-93-32.2c-14.2-5.9-32.4.2-41.2 13.9-8.8 13.8-4.7 30.2 9.3 36.6 14.3 6.5 33.2.3 42-13.8 8.8-14.3 4.2-30.6-10.1-36.7zm34.9-14.5c-5.4-2.2-12.2.5-15.4 5.8-3.1 5.4-1.4 11.5 4.1 13.8 5.5 2.3 12.6-.3 15.8-5.8 3-5.6 1-11.8-4.5-13.8z"></path></svg></i></div></div> <div class="approve" data-v-81187e68><div class="share-draw" data-v-81187e68><i aria-label="图标: qq" class="anticon anticon-qq" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="qq" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M824.8 613.2c-16-51.4-34.4-94.6-62.7-165.3C766.5 262.2 689.3 112 511.5 112 331.7 112 256.2 265.2 261 447.9c-28.4 70.8-46.7 113.7-62.7 165.3-34 109.5-23 154.8-14.6 155.8 18 2.2 70.1-82.4 70.1-82.4 0 49 25.2 112.9 79.8 159-26.4 8.1-85.7 29.9-71.6 53.8 11.4 19.3 196.2 12.3 249.5 6.3 53.3 6 238.1 13 249.5-6.3 14.1-23.8-45.3-45.7-71.6-53.8 54.6-46.2 79.8-110.1 79.8-159 0 0 52.1 84.6 70.1 82.4 8.5-1.1 19.5-46.4-14.5-155.8z"></path></svg></i></div></div> <div class="approve" data-v-81187e68><div class="share-draw" data-v-81187e68><i aria-label="图标: link" class="anticon anticon-link" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="link" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M574 665.4a8.03 8.03 0 0 0-11.3 0L446.5 781.6c-53.8 53.8-144.6 59.5-204 0-59.5-59.5-53.8-150.2 0-204l116.2-116.2c3.1-3.1 3.1-8.2 0-11.3l-39.8-39.8a8.03 8.03 0 0 0-11.3 0L191.4 526.5c-84.6 84.6-84.6 221.5 0 306s221.5 84.6 306 0l116.2-116.2c3.1-3.1 3.1-8.2 0-11.3L574 665.4zm258.6-474c-84.6-84.6-221.5-84.6-306 0L410.3 307.6a8.03 8.03 0 0 0 0 11.3l39.7 39.7c3.1 3.1 8.2 3.1 11.3 0l116.2-116.2c53.8-53.8 144.6-59.5 204 0 59.5 59.5 53.8 150.2 0 204L665.3 562.6a8.03 8.03 0 0 0 0 11.3l39.8 39.8c3.1 3.1 8.2 3.1 11.3 0l116.2-116.2c84.5-84.6 84.5-221.5 0-306.1zM610.1 372.3a8.03 8.03 0 0 0-11.3 0L372.3 598.7a8.03 8.03 0 0 0 0 11.3l39.6 39.6c3.1 3.1 8.2 3.1 11.3 0l226.4-226.4c3.1-3.1 3.1-8.2 0-11.3l-39.5-39.6z"></path></svg></i></div></div></div></div></div></div> <div class="main" data-v-81187e68><div class="main-warpper" data-v-81187e68><div class="artical-header" data-v-81187e68><div class="title" data-v-81187e68><span class="title-span" data-v-81187e68>伪造电子邮件以及制造电子邮件炸弹的攻防探讨</span> <!----> <!----> <!----> <div class="origin-reward" data-v-81187e68><span class="origin" data-v-81187e68></span> <span class="reward" data-v-81187e68></span></div></div> <div class="author-info" data-v-81187e68><a href="" class="author" data-v-81187e68><i aria-label="图标: user" class="anticon anticon-user" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="user" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M858.5 763.6a374 374 0 0 0-80.6-119.5 375.63 375.63 0 0 0-119.5-80.6c-.4-.2-.8-.3-1.2-.5C719.5 518 760 444.7 760 362c0-137-111-248-248-248S264 225 264 362c0 82.7 40.5 156 102.8 201.1-.4.2-.8.3-1.2.5-44.8 18.9-85 46-119.5 80.6a375.63 375.63 0 0 0-80.6 119.5A371.7 371.7 0 0 0 136 901.8a8 8 0 0 0 8 8.2h60c4.4 0 7.9-3.5 8-7.8 2-77.2 33-149.5 87.8-204.3 56.7-56.7 132-87.9 212.2-87.9s155.5 31.2 212.2 87.9C779 752.7 810 825 812 902.2c.1 4.4 3.6 7.8 8 7.8h60a8 8 0 0 0 8-8.2c-1-47.8-10.9-94.3-29.5-138.2zM512 534c-45.9 0-89.1-17.9-121.6-50.4S340 407.9 340 362c0-45.9 17.9-89.1 50.4-121.6S466.1 190 512 190s89.1 17.9 121.6 50.4S684 316.1 684 362c0 45.9-17.9 89.1-50.4 121.6S557.9 534 512 534z"></path></svg></i>
								<!----> <!----></a> <span class="date" style="margin:0 15px" data-v-81187e68><i aria-label="图标: clock-circle" class="anticon anticon-clock-circle" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="clock-circle" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"></path><path d="M686.7 638.6L544.1 535.5V288c0-4.4-3.6-8-8-8H488c-4.4 0-8 3.6-8 8v275.4c0 2.6 1.2 5 3.3 6.5l165.4 120.6c3.6 2.6 8.6 1.8 11.2-1.7l28.6-39c2.6-3.7 1.8-8.7-1.8-11.2z"></path></svg></i>2018-09-25 08:00:37
							</span> <span class="review" style="margin-right:15px" data-v-81187e68><i aria-label="图标: fire" class="anticon anticon-fire" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="fire" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M834.1 469.2A347.49 347.49 0 0 0 751.2 354l-29.1-26.7a8.09 8.09 0 0 0-13 3.3l-13 37.3c-8.1 23.4-23 47.3-44.1 70.8-1.4 1.5-3 1.9-4.1 2-1.1.1-2.8-.1-4.3-1.5-1.4-1.2-2.1-3-2-4.8 3.7-60.2-14.3-128.1-53.7-202C555.3 171 510 123.1 453.4 89.7l-41.3-24.3c-5.4-3.2-12.3 1-12 7.3l2.2 48c1.5 32.8-2.3 61.8-11.3 85.9-11 29.5-26.8 56.9-47 81.5a295.64 295.64 0 0 1-47.5 46.1 352.6 352.6 0 0 0-100.3 121.5A347.75 347.75 0 0 0 160 610c0 47.2 9.3 92.9 27.7 136a349.4 349.4 0 0 0 75.5 110.9c32.4 32 70 57.2 111.9 74.7C418.5 949.8 464.5 959 512 959s93.5-9.2 136.9-27.3A348.6 348.6 0 0 0 760.8 857c32.4-32 57.8-69.4 75.5-110.9a344.2 344.2 0 0 0 27.7-136c0-48.8-10-96.2-29.9-140.9zM713 808.5c-53.7 53.2-125 82.4-201 82.4s-147.3-29.2-201-82.4c-53.5-53.1-83-123.5-83-198.4 0-43.5 9.8-85.2 29.1-124 18.8-37.9 46.8-71.8 80.8-97.9a349.6 349.6 0 0 0 58.6-56.8c25-30.5 44.6-64.5 58.2-101a240 240 0 0 0 12.1-46.5c24.1 22.2 44.3 49 61.2 80.4 33.4 62.6 48.8 118.3 45.8 165.7a74.01 74.01 0 0 0 24.4 59.8 73.36 73.36 0 0 0 53.4 18.8c19.7-1 37.8-9.7 51-24.4 13.3-14.9 24.8-30.1 34.4-45.6 14 17.9 25.7 37.4 35 58.4 15.9 35.8 24 73.9 24 113.1 0 74.9-29.5 145.4-83 198.4z"></path></svg></i>
							</span> <!----> <!----></div></div> <div class="artical-body" data-v-81187e68><div class="payread-panel" data-v-81187e68><div id="tinymce-editor" class="content-detail" data-v-81187e68><div><p><b style="color:#ef4747">*本文作者：Macr0phag3，本文属 FreeBuf 原创奖励计划，未经许可禁止转载。</b></p><h2>前言</h2><p><b style="color:#00b050">想必熟悉 kali 或者接触过 smtp 相关分析的人都听说过 Swaks 这个工具。它号称 SMTP 界的瑞士军刀。工具会使固然厉害，但是不知道原理总觉得缺了点什么。于是我就用 Python 自己写了一个类似的工具，加上了邮件炸弹的功能，顺带分析一波原理。</b></p><h2>SMTP 协议</h2><p>SMTP 协议即简单邮件传输协议，属于 TCP/IP 协议簇，它是一组用于由源地址到目的地址传送邮件的规则，由它来控制信件的中转方式。SMTP 服务器则是遵循 SMTP 协议的发送邮件服务器，用来发送或中转发出的电子邮件。</p><p>SMTP 模型如下：</p><p style="text-align:center"><img src="https://image.3001.net/images/20180914/1536920596_5b9b8c14db7fd.png!small" alt="SMTP 模型"></p><p>简单的通信过程如下（以 163 邮箱为例；以下返回均为正常情况）：</p><p>第一步是请求建立连接：</p><p>telnet：<code>telnet 163mx03.mxmail.netease.com 25</code></p><p>返回：<code>220 163.com Anti-spam GT for Coremail System (163com[20141201])</code></p><p>第二步是打开传输通道：</p><p>发送：<code>HELO &lt;domain> &lt;CRLF> </code>或 <code>EHLO &lt;domain/address-literal> &lt;CRLF></code>。有什么区别呢？EHLO 更新一些，会返回 smtp 服务器支持的命令，相对比 HELO 要有用，所以基本用的都是 EHLO。HELO / EHLO 命令用于主机介绍它自己，可以被翻译为 Hello, I am &lt;domain>.</p><p>返回：<code>250 OK</code> 或：</p><pre><code>250-mail
250-PIPELINING
250-AUTH LOGIN PLAIN
250-AUTH=LOGIN PLAIN
250-coremail 1Uxr2xKj7kG0xkI17xGrU7I0s8FY2U3Uj8Cz28x1UUUUU7Ic2I0Y2Urz44XGUCa0xDrUUUUj
250-STARTTLS
250-SIZE 73400320
250 8BITMIME</code></pre><p>可以看到，EHLO 返回信息更加详细。</p><p>第三步是 MAIL 命令：</p><p>发送：<code>MAIL FROM:&lt;发送者邮箱> &lt;CRLF></code></p><p>返回：<code>250 Mail OK</code></p><p>第四步是 RCPT 命令：</p><p>发送：<code>RCPT TO:&lt;接受者邮箱></code></p><p>返回：<code>250 Mail OK</code></p><p>第五步是 DATA 命令：</p><p>发送：<code>DATA &lt;CRLF></code></p><p>返回：<code>354 End data with &lt;CR>&lt;LF>.&lt;CR>&lt;LF></code></p><p>然后就可以输入邮件内容了，包括主题，邮件正文等等。</p><p>第五步结束后，服务端会返回邮件发送成功与否的情况：</p><p>返回：<code>&lt;= 250 Mail OK queued as mx13,P8CowAB3KDAxa5tbCxAiEg--.29768S2 1536912177</code></p><p>这样，一封简单的邮件就发出去了。当然，邮件服务器在这个过程中会做各种判断，以免轻易接受垃圾邮件。</p><p>完整的演示如下：</p><pre><code>&lt;= 220 163.com Anti-spam GT for Coremail System (163com[20141201])
=> ehlo antispam
&lt;= 250-mail
&lt;= 250-PIPELINING
&lt;= 250-AUTH LOGIN PLAIN
&lt;= 250-AUTH=LOGIN PLAIN
&lt;= 250-coremail 1Uxr2xKj7kG0xkI17xGrU7I0s8FY2U3Uj8Cz28x1UUUUU7Ic2I0Y2UFQXaMIUCa0xDrUUUUj
&lt;= 250-STARTTLS
&lt;= 250-SIZE 73400320
&lt;= 250 8BITMIME
=> mail from:&lt;hr@huawei.com>
&lt;= 250 Mail OK
=> rcpt to:&lt;手动打码@163.com>
&lt;= 250 Mail OK
=> data
&lt;= 354 End data with &lt;CR>&lt;LF>.&lt;CR>&lt;LF>
=> to: 手动打码@163.com
=> from: hr@huawei.com
=> subject: 这是一封垃圾邮件
=>
=> DKIM？听上去很好吃
=> SPF 不是防晒系数吗
=> 我觉得 SMTP 很安全啊
=> 我们不存在垃圾邮件，那些都是正常的邮件
=> 邮件炸弹也是不存在的
=> .
&lt;= 250 Mail OK queued as mx3,NcCowADX4z1_bJtbcsNOQw--.37583S2 1536912511</code></pre><p>邮箱结果：</p><p style="text-align:center"><img src="https://image.3001.net/images/20180914/1536920614_5b9b8c26a2753.png!small" alt="邮箱结果" width="690" height="514.452296819788"></p><p>那么，说了这么多 Telnet 发邮件，和正常发邮件的的方式很不一样。我们都是通过 web 界面或者 GUI 发的，如下：</p><p style="text-align:center"><img src="https://image.3001.net/images/20180914/1536920630_5b9b8c36efd6c.png!small" alt="通过 web 界面或者 GUI 发的"></p><p>而我们使用 Telnet 直接发邮件，实际上是在模拟第二个 Send。</p><p>说清楚 SMTP 了，接下来说伪造邮件发件人。</p><h2>伪造邮件发件人</h2><p>回顾之前的 Telnet 发邮件的过程，我们可以看到，我们使用 mail from: 声称自己是 hr@huawei.com，而且 SMTP 协议本身也不要求对此声明做认证，所以伪造就是这样达成的。那么，经过这么多年的发展，厂商有对此做出了什么努力来解决这一问题呢？</p><h3>SPF：发送方策略框架</h3><p>SPF 是为了防范垃圾邮件而提出来的一种 DNS 记录类型，它是一种 TXT 类型的记录，它用于登记某个域名拥有的用来外发邮件的所有 IP 地址。发送人向接收方发送一封电子邮件后，邮件接收服务器接收电子邮件并执行如下操作：</p><blockquote>    <p>检查哪一个域声称发送了该邮件并检查该域的 SPF 记录的 DNS。</p></blockquote><blockquote>    <p>确定发送服务器的 IP 地址是否与 SPF 记录中的某个已发布 IP 地址相匹配。</p></blockquote><blockquote>    <p>对电子邮件进行打分：如果 IP 地址匹配，则邮件通过身份验证并获得一个正分。如果 IP 地址不匹配，则邮件无法通过身份验证并获得一个负分。然后，对现有的防垃圾邮件筛选策略和启发式筛选应用这些结果。或者直接拒绝接受，返回 550 MI:SPF。</p></blockquote><p>我们查一下 163 的 SPF 记录：</p><pre><code>> nslookup -q=TXT 163.com
Server:        202.117.112.3
Address:    202.117.112.3#53

Non-authoritative answer:
163.com    text = "v=spf1 include:spf.163.com -all"

Authoritative answers can be found from:
163.com    nameserver = ns5.nease.net.
163.com    nameserver = ns3.nease.net.
163.com    nameserver = ns6.nease.net.
163.com    nameserver = ns1.nease.net.
163.com    nameserver = ns4.nease.net.
163.com    nameserver = ns8.166.com.
163.com    nameserver = ns2.166.com.
ns1.nease.net    internet address = 123.58.173.177
ns3.nease.net    internet address = 220.181.36.234
ns4.nease.net    internet address = 123.125.48.245
ns5.nease.net    internet address = 121.195.179.18
ns6.nease.net    internet address = 52.215.24.44</code></pre><p><code>v=spf1 include:spf.163.com -all</code>是什么意思呢？</p><p>SPF 记录包含在一个 TXT 记录之中，格式如下：</p><pre><code>v=spf1 [[pre] type [ext] ] ... [mod]</code></pre><p>1、v=spf1：SPF 的版本。如果使用 Sender ID 的话，这个字段就应该是 v=spf2</p><p>2、pre：定义匹配时的返回值。可能的返回值包括：</p><blockquote>    <p>+: 缺省值。在测试完成的时候表示通过。</p></blockquote><blockquote>    <p>-: 表示测试失败。这个值通常是 -all，表示没有其他任何匹配发生。</p></blockquote><blockquote>    <p>~: 表示软失败，通常表示测试没有完成。</p></blockquote><blockquote>    <p>?: 表示不置可否。这个值也通常在测试没有完成的时候使用。</p></blockquote><p>3、type：定义使用的确认测试的类型：</p><blockquote>    <p>include：包含一个给定的域名的测试。以 include:domain 的形式书写。</p></blockquote><blockquote>    <p>all：终止测试序列。比如，如果选项是 -all，那么到达这条记录也就意味着测试失败了。但是如果无法确定，可以使用"?all"来表示，这样，测试将被接受。</p></blockquote><blockquote>    <p>ip4：使用 IPv4 进行验证。这个可以以 ip4:ipv4 或 ip4:ipv4/cidr 的形式使用。</p></blockquote><p>4、ext：定义对 type 的可选扩展。如果没有这个字段，那么仅使用单个记录进行问询。</p><p>5、mod：这是最后的类型指示，作为记录的一个修正值。</p><p>测试后有以下结果：</p><blockquote>    <p>通过；SPF记录指定要允许发送的主机；接受</p>    <p>硬失败；SPF记录已将主机指定为不允许发送；拒绝</p>    <p>软失败；SPF记录已将主机指定为不被允许发送但正在转换；接受但标记</p>    <p>中性；SPF记录明确指出，对有效性无关；接受</p>    <p>没有；该域没有SPF记录，或者SPF记录不对结果进行评估；接受</p></blockquote><p>所以，当我们声称 hr@qq.com 向 163 发送邮件的时候，163 会不予接受（因为 qq 是有 spf 记录的）：</p><pre><code>&lt;= 220 163.com Anti-spam GT for Coremail System (163com[20141201])
=> ehlo antispam
&lt;= 250-mail
&lt;= 250-PIPELINING
&lt;= 250-AUTH LOGIN PLAIN
&lt;= 250-AUTH=LOGIN PLAIN
&lt;= 250-coremail 1Uxr2xKj7kG0xkI17xGrU7I0s8FY2U3Uj8Cz28x1UUUUU7Ic2I0Y2UFsDjanUCa0xDrUUUUj
&lt;= 250-STARTTLS
&lt;= 250-SIZE 73400320
&lt;= 250 8BITMIME
=> mail from:&lt;hr@qq.com>
&lt;= 550 MI:SPF 163 mx45,X8CowEB5qUXsdZtbeT4JTQ--.35331S2 1536914924 http://mail.163.com/help/help_spam_16.htm?ip=手动打码&hostid=mx45&time=1536914924</code></pre><h3>DKIM 与 DMARC</h3><p>DKIM 是一种防范电子邮件欺诈的验证技术，通过消息加密认证的方式对邮件发送域名进行验证。</p><p>DMARC 是一种基于现有的SPF和DKIM协议的可扩展电子邮件认证协议，在邮件收发双方建立了邮件反馈机制，便于邮件发送方和邮件接收方共同对域名的管理进行完善和监督。</p><p>感兴趣的话可以自行查阅资料。</p><h3>漏网之鱼</h3><p>又说了那么多，那么是否有了 SPF 可以一劳永逸呢？其实并不是。拿 163 与 qq 举例，查到发送方的 spf 记录，并且是标记的是硬失败，当然是最好的，直接进行判断。但是如果发送方用的是软失败甚至没有 spf 记录呢？比如 huawei.com 就是软失败：</p><pre><code>huawei.com text = "v=spf1 ip4:45.249.212.32 ip4:45.249.212.35 ip4:119.145.14.93 ip4:58.251.152.93 ip4:194.213.3.17 ip4:206.16.17.72 ip4:45.249.212.255 ip4:45.249.212.187/29 ip4:45.249.212.191 ip4:185.176.76.210 ~all"</code></pre><p>如果出现这样的情况，就得看厂商怎么做了，一般来说都是放行。</p><h2>邮件炸弹</h2><p>说完了伪造发件人，再来说说邮件炸弹。</p><p>电子邮件炸弹是最古老的匿名攻击之一，通过设置一台机器不断的大量的向同一地址发送电子邮件，攻击者能够耗尽接受者网络的宽带。由于这种攻击方式简单易用，也有很多发匿名邮件的工具，而且只要对方获悉你的电子邮件地址就可以进行攻击，所以这是大家最值得防范的一个攻击手段。</p><p>既然能伪造发件人，那么发送邮件炸弹看上去也不难。事实上的确如此。另外，由于大量的请求以及链接，会触发接收方各种抵制。接下来通过邮件炸弹的三种不同的方式谈谈。</p><h3>单线程</h3><p>单线程，发就好了，拿起死循环就是干：<code>while 1: xxxx</code></p><h3>多线程：短连接</h3><p>短连接就是我们最容易想到的，多线程，每个线程发起一次链接请求，发完一封就停止。线程数少点还好，一多就疯狂提示：421 Too many connections。在 ehlo antispam 的时候就被干掉了。实测大多数情况，100 线程发 能成功 20 封就已经很好了。而且发完一封就释放链接，蛮浪费的。而且在 smtp 服务器对频繁的连接请求很敏感的时候， ip 容易被 ban（如 qq）。</p><h3>多线程：长连接</h3><p>长连接：设定好线程数后，一旦 ehlo antispam 成功，就不停地重复 mail from 到 data，邮件发送成功后也不释放链接，一直发。若接收方 smtp 服务器强制释放此链接，则重新 ehlo antispam。这样的话，如果不手动停止，就会一直尝试链接、发邮件。轰炸效率 plus。</p><h3>email_hack</h3><p>根据上述的原理以及想法，我自己写了一个命令行的工具：email_hack</p><pre><code>usage: email_hack.py [-h] -faddr FROM_ADDRESS -taddr TO_ADDRESS
                     [-tnum THREADS_NUM] [-v VERBOSE] [-c CRAZY_MODE]

optional arguments:
  -h, --help            show this help message and exit
  -faddr FROM_ADDRESS, --from_address FROM_ADDRESS
                        fake from address
  -taddr TO_ADDRESS, --to_address TO_ADDRESS
                        the address you want to delivery
  -tnum THREADS_NUM, --threads_num THREADS_NUM
                        how many threads you want
  -v VERBOSE, --verbose VERBOSE
                        verbose level
  -c CRAZY_MODE, --crazy_mode CRAZY_MODE
                        Keep sending fake email (** Use with caution **)</code></pre><p>详细内容可以到 gayhub 看看：<a href="https://github.com/Macr0phag3/email_hack" ref="nofollow">https://github.com/Macr0phag3/email_hack</a>。</p><p><b>伪造邮件效果：</b></p><p>163：</p><p style="text-align:center"><img src="https://image.3001.net/images/20180914/1536920720_5b9b8c90bb57d.png!small" alt="163邮箱"></p><p>qq：</p><p style="text-align:center"><img src="https://image.3001.net/images/20180917/1537184300_5b9f922c878c9.png!small" alt="QQ邮箱"></p><p><b>邮件炸弹效果：</b></p><p style="text-align:center"><img src="https://image.3001.net/images/20180914/1536920662_5b9b8c5616d0a.png!small" alt="邮件炸弹效果"></p><p style="text-align:center"><img src="https://image.3001.net/images/20180914/1536920678_5b9b8c660d5b2.png!small" alt="邮件炸弹效果"></p><h2>防御方法</h2><h3>伪造邮件发件人</h3><p>厂商：对 spf 记录采用 硬失败 的标记。且验证时预到软失败标记的时候，尽可能拒绝。有可能的话， 上DKIM 与 DMARC</p><p>用户：对于很重要的邮件信息，不妨查看一下邮件原文。</p><p style="text-align:center"><img src="https://image.3001.net/images/20180917/1537184545_5b9f9321c34d3.png!small"></p><p style="text-align:center"><img src="https://image.3001.net/images/20180917/1537184759_5b9f93f786f5b.png!small" alt="查看一下邮件原文"></p><p>若只有 一个 Received ，且列出的 IP 与宣称的地址不一致，则就是伪造的。虽然 Received 头可以伪造，但是新的 Received 头会添加在消息的头部，所以，如果存在伪造的 Received，那么它总是在后面。</p><p>若有多个 Received，第一个 Received 中 是正规的（网易、腾讯等等） SMTP 服务器 转发过的，那么肯定是经过验证的合法用户才能转发过来，因为这些厂商都不会开匿名转发，此时只需要看 IP 与宣称身份是否一致，一致就 OK。若看着就 不正规，则就要小心一些了。</p><p>举2个例子：</p><p>未被伪造：</p><p style="text-align:center"><img src="https://image.3001.net/images/20180917/1537186883_5b9f9c43d8a0b.png!small" alt="未被伪造"></p><p style="text-align:center"><img src="https://image.3001.net/images/20180917/1537187010_5b9f9cc23e20d.png!small" alt="未被伪造"></p><p>伪造：</p><p style="text-align:center"><img src="https://image.3001.net/images/20180917/1537187530_5b9f9eca3bed6.png!small" alt="伪造"></p><p style="text-align:center"><img src="https://image.3001.net/images/20180917/1537187456_5b9f9e8022bdb.png!small" alt="伪造"></p><h3>邮件炸弹</h3><p>对大量并发的连接请求，不但要拒绝，而且要禁止其 IP 一段时间。经过测试，qq 在大量请求后会进行封禁，163只是拒绝连接，返回类似 “请15分钟后再试”，其实还是可以接着发起连接请求的... ╮(╯▽╰)╭。最后，在邮件多次发送失败的时候，直接断开连接，不要保留通道，强制发送端重新发起连接请求。</p><p><b style="color:#ef4747">*本文作者：Macr0phag3，本文属 FreeBuf 原创奖励计划，未经许可禁止转载。</b></p></div></div> <!----> <div class="other-panel" data-v-81187e68><!----> <!----></div> <!----> <!----></div> <div class="tags-panel" data-v-81187e68><p data-v-81187e68><span data-v-81187e68>本文作者：，</span> <span data-v-81187e68>
									转载请注明来自<a href="https://www.freebuf.com" class="net" data-v-81187e68>FreeBuf.COM</a></span></p> <div data-v-81187e68><span class="tag" data-v-81187e68><span class="spot" data-v-81187e68><i class="pot" data-v-81187e68></i></span> <span class="txt" data-v-81187e68># Kali</span></span><span class="tag" data-v-81187e68><span class="spot" data-v-81187e68><i class="pot" data-v-81187e68></i></span> <span class="txt" data-v-81187e68># SMTP</span></span><span class="tag" data-v-81187e68><span class="spot" data-v-81187e68><i class="pot" data-v-81187e68></i></span> <span class="txt" data-v-81187e68># 邮件炸弹</span></span></div></div></div></div> <div class="remix-module" data-v-81187e68><div class="module-title" data-v-81187e68><div class="title" data-v-81187e68>
							被以下专辑收录，发现更多精彩内容
							<!----></div></div> <div class="content column-module" data-v-81187e68><div class="add column-tag" style="background:#f1fff9" data-v-81187e68>
							+ 收入我的专辑
						</div> <div class="add column-tag" style="background:#f1fff9" data-v-81187e68>
							+ 加入我的收藏
						</div>  <div class="add column-tag" style="display:none" data-v-81187e68><span data-v-81187e68>展开更多</span> <span class="arrow" data-v-81187e68><i aria-label="图标: down" class="anticon anticon-down" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></i></span></div></div></div> <div class="comment" data-v-81187e68><div class="module-title" data-v-81187e68><div class="title" data-v-81187e68>
							评论<!----> <span class="sort" data-v-81187e68><i aria-label="图标: swap" class="anticon anticon-swap" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="swap" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M847.9 592H152c-4.4 0-8 3.6-8 8v60c0 4.4 3.6 8 8 8h605.2L612.9 851c-4.1 5.2-.4 13 6.3 13h72.5c4.9 0 9.5-2.2 12.6-6.1l168.8-214.1c16.5-21 1.6-51.8-25.2-51.8zM872 356H266.8l144.3-183c4.1-5.2.4-13-6.3-13h-72.5c-4.9 0-9.5 2.2-12.6 6.1L150.9 380.2c-16.5 21-1.6 51.8 25.1 51.8h696c4.4 0 8-3.6 8-8v-60c0-4.4-3.6-8-8-8z"></path></svg></i>按热度排序
							</span></div></div> <div class="intro-list" data-v-81187e68></div> <!----> <div class="bottom-comment-region" data-v-81187e68><div class="input-item" data-v-96500214 data-v-81187e68><div class="avatar" data-v-96500214><div class="img" data-v-96500214><img src="https://image.3001.net/images/index/wp-user-avatar-50x50.png" data-v-96500214></div></div> <div class="content nologin" data-v-96500214><p data-v-96500214>请<span data-v-96500214>登录</span>/<span data-v-96500214>注册</span>后在FreeBuf发布内容哦</p></div></div></div></div> <div class="introduce" data-v-81187e68><div class="module-title" data-v-81187e68><div class="title" data-v-81187e68>
							相关推荐
						</div></div> <div class="intro-list" data-v-81187e68></div></div></div> <div class="aside-right" data-v-81187e68><div class="module-top" data-v-81187e68><div class="author-panel" data-v-81187e68><div class="top-panel" data-v-81187e68><div class="avatar" data-v-81187e68><span data-v-81187e68><img src="" data-v-81187e68>\
								</span></div> <div class="info" data-v-81187e68><div class="name-info" data-v-81187e68><span class="name" data-v-81187e68></span> <!----> <!----> <!----></div> <div class="desc text-line-3" data-v-81187e68>
									
								</div> <p class="follow-view" data-v-81187e68><button type="button" class="focus ant-btn ant-btn-colorBorder" style="margin-top:20px;width:132px" data-v-81187e68><span>关 注</span></button></p></div></div> <ul class="number-panel" data-v-81187e68><li class="item" data-v-81187e68><span class="num" data-v-81187e68>0</span> <span data-v-81187e68>文章数</span></li> <li class="item" data-v-81187e68><span class="num" data-v-81187e68>0</span> <span data-v-81187e68>评论数</span></li> <li class="item" data-v-81187e68><span class="num" data-v-81187e68>0</span> <span data-v-81187e68>关注者</span></li></ul></div> <!----> <!----></div> <div class="module-middle" data-v-81187e68></div> <!----></div></div> <div class="foot" data-v-81187e68><div class="foot-wraper" data-v-81187e68><div class="foot-container" data-v-81187e68><div class="foot-left" data-v-81187e68><div class="focusInput" data-v-81187e68>
								请 <a href="https://www.freebuf.com/oauth" data-v-81187e68>登录</a> /
								<a href="https://account.tophant.com/register.html" data-v-81187e68>注册</a>后在FreeBuf发布内容哦
							</div></div> <div class="foot-right" data-v-81187e68><span class="approve-num" data-v-81187e68><svg aria-hidden="true" class="svg-icon" style="font-size:20px;margin-right:3px" data-v-322983b7 data-v-81187e68><use xlink:href="#like-fill" data-v-322983b7></use></svg>
						</span> <span class="comment-num" style="margin-left:30px" data-v-81187e68><svg aria-hidden="true" class="svg-icon" style="font-size:20px;margin-right:3px" data-v-322983b7 data-v-81187e68><use xlink:href="#message-fill" data-v-322983b7></use></svg>
						</span></div></div> <div class="foot-container" style="display:none" data-v-81187e68><div class="foot-left" data-v-81187e68><textarea placeholder="请输入您的评论..." maxlength="500" class="ant-input" data-v-81187e68></textarea></div> <div class="foot-right" data-v-81187e68><label class="ant-checkbox-wrapper" data-v-81187e68><span class="ant-checkbox"><input type="checkbox" class="ant-checkbox-input"><span class="ant-checkbox-inner"></span></span><span>
							匿名
						</span></label> <button type="button" class="join ant-btn" data-v-81187e68><span>发 表</span></button> <button type="button" class="cancel ant-btn" data-v-81187e68><span>取 消</span></button> <label class="ant-checkbox-wrapper ant-checkbox-wrapper-checked" style="display:none" data-v-81187e68><span class="ant-checkbox ant-checkbox-checked"><input type="checkbox" checked class="ant-checkbox-input"><span class="ant-checkbox-inner"></span></span><span>
							有人回复时邮件通知我
						</span></label></div></div></div></div> <!----> <!----> <!----> <div data-v-2a4dba56 data-v-81187e68><!----></div> <!----> <!----> <!----> <!----></div></main> <footer class="ant-layout-footer" data-v-55d8de90><div class="footer" data-v-1d178813 data-v-55d8de90><div class="container" data-v-1d178813><div class="footer-left" data-v-1d178813><img src="https://www.freebuf.com/images/logo_b.png" data-v-1d178813> <p data-v-1d178813><span data-v-1d178813>本站由</span>阿里云 提供计算与安全服务</p></div> <div class="footer-center clearfix" data-v-1d178813><div class="footer-list" data-v-1d178813><h3 data-v-1d178813>用户服务</h3> <ul data-v-1d178813><li data-v-1d178813><a target="_blank" href="https://www.freebuf.com/write" data-v-1d178813>有奖投稿</a></li> <li data-v-1d178813><a target="_blank" href="https://www.vulbox.com/bounties/detail-72" data-v-1d178813>提交漏洞</a></li> <li data-v-1d178813><a target="_blank" href="https://www.vulbox.com/projects/list" data-v-1d178813>参与众测</a></li> <li data-v-1d178813><a target="_blank" href="https://shop.freebuf.com" data-v-1d178813>商城</a></li></ul></div> <div class="footer-list" data-v-1d178813><h3 data-v-1d178813>企业服务</h3> <ul data-v-1d178813><li data-v-1d178813><a target="_blank" href="https://company.freebuf.com" data-v-1d178813>安全咨询</a></li> <li data-v-1d178813><a target="_blank" href="https://www.freebuf.com/news/307349.html" data-v-1d178813>产业全景图</a></li> <li data-v-1d178813><a target="_blank" href="https://www.vulbox.com/service/src" data-v-1d178813>企业SRC</a></li> <li data-v-1d178813><a target="_blank" href="https://www.vulbox.com/" data-v-1d178813>安全众测</a></li></ul></div> <div class="footer-list" data-v-1d178813><h3 data-v-1d178813>合作信息</h3> <ul data-v-1d178813><li data-v-1d178813><a target="_blank" href="https://www.tophant.com/" data-v-1d178813>斗象官网</a></li> <li data-v-1d178813><a target="_blank" href="https://www.freebuf.com/advertise" data-v-1d178813>广告投放</a></li> <li data-v-1d178813><a target="_blank" href="mailto:help@freebuf.com" data-v-1d178813>联系我们</a></li> <li data-v-1d178813><a target="_blank" href="https://www.freebuf.com/friends" data-v-1d178813>友情链接</a></li></ul></div> <div class="footer-list" data-v-1d178813><h3 data-v-1d178813>关于我们</h3> <ul data-v-1d178813><li data-v-1d178813><a target="_blank" href="https://www.freebuf.com/news/others/864.html" data-v-1d178813>关于我们</a></li> <li data-v-1d178813><a target="_blank" href="https://www.freebuf.com/jobs/40386.html" data-v-1d178813>加入我们</a></li> <li data-v-1d178813><div class="weixin-pannel weixin" data-v-1d178813 data-v-1d178813><a href="javascript:;" class="g-icon-qr1" data-v-1d178813>微信公众号</a></div></li> <li data-v-1d178813><a target="_blank" href="http://weibo.com/freebuf" data-v-1d178813>新浪微博</a></li></ul></div> <div class="footer-list" data-v-1d178813><h3 data-v-1d178813>战略伙伴</h3> <ul data-v-1d178813><li style="padding:0 0 10px" data-v-1d178813><a rel="nofollow" target="_blank" href="http://www.aliyun.com/?freebuf" data-v-1d178813><img src="https://image.3001.net/images/20191017/1571306518_5da83c1686dd9.png" data-v-1d178813></a></li> <li style="padding:0 0 10px" data-v-1d178813><a rel="nofollow" target="_blank" href="http://www.upyun.com/?freebuf" data-v-1d178813><img src="https://image.3001.net/images/20191017/1571310907_5da84d3bbdf2c.png" data-v-1d178813></a></li> <li style="padding:0 0 10px" data-v-1d178813><a rel="nofollow" target="_blank" href="https://www.trustasia.com/?freebuf" data-v-1d178813><img src="https://image.3001.net/images/20191017/1571306606_5da83c6e8de1c.png" data-v-1d178813></a></li></ul></div></div> <div class="footer-right" data-v-1d178813><h3 data-v-1d178813>FreeBuf+小程序</h3> <img src="https://www.freebuf.com/images/xcx-code.png" alt data-v-1d178813> <p data-v-1d178813>扫码把安全装进口袋</p></div></div> <div class="copyright" data-v-1d178813><div class="container" data-v-1d178813><ul class="clearfix" data-v-1d178813><li data-v-1d178813><a href="https://www.tophant.com/" target="_blank" data-v-1d178813>斗象科技</a></li> <li data-v-1d178813><a href="https://www.freebuf.com" target="_blank" data-v-1d178813>FreeBuf</a></li> <li data-v-1d178813><a href="https://www.vulbox.com/" target="_blank" data-v-1d178813>漏洞盒子</a></li> <li data-v-1d178813><a href="https://www.tophant.ai/" target="_blank" data-v-1d178813>斗象智能安全平台</a></li> <li data-v-1d178813><a href="https://www.freebuf.com/dis" target="_blank" data-v-1d178813>免责条款</a></li> <li data-v-1d178813><a href="https://my.freebuf.com/AgreeProtocol/duty" target="_blank" data-v-1d178813>协议条款</a></li></ul> <p data-v-1d178813>
        Copyright © 2020 WWW.FREEBUF.COM All Rights Reserved
        <a rel="nofollow" target="_blank" href="https://beian.miit.gov.cn/#/Integrated/index" data-v-1d178813>
             沪ICP备13033796号
        </a> <span style="padding:0 8px" data-v-1d178813>|</span> <a rel="nofollow" target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=31011502009321" data-v-1d178813>
          沪公安网备
          <img src="https://image.3001.net/images/20200106/1578291342_5e12d08ec2379.png" style="display:inline-block;width:14px;height:12px;position:relative;top:1px;left:3px" data-v-1d178813></a></p></div></div></div></footer></section></div></div></div><script>window.__NUXT__=function(e,t){return{layout:"articles",data:[{articalId:"184555",jobPosition:e,serverData:{post_title:"伪造电子邮件以及制造电子邮件炸弹的攻防探讨",post_author:t,nickname:t,post_date:"2018-09-25 08:00:37",post_picture:"http://image.3001.net/images/20180919/15373284302211.png!small",category:[{name:"工具",slug:"sectool",url:"https://www.freebuf.com/sectool"},{name:"网络安全",slug:"network",url:"https://www.freebuf.com/articles/network"}],tag:[{tag_id:"1248",name:"Kali",url:"https://www.freebuf.com/tag/kali"},{tag_id:"11479",name:"SMTP",url:"https://www.freebuf.com/tag/smtp"},{tag_id:"11647",name:"邮件炸弹",url:"https://www.freebuf.com/tag/%25e9%2582%25ae%25e4%25bb%25b6%25e7%2582%25b8%25e5%25bc%25b9"}],post_desc:"想必熟悉 kali 或者接触过 smtp 相关分析的人都听说过 Swaks 这个工具，我用 Python 自己写了一个类似的工具，加上了邮件炸弹的功能，顺带分析一波原理。",paid_read:e,vip_read:e,paid_read_amount:0,post_content:'<p><b style="color: rgb(239, 71, 71);">*本文作者：Macr0phag3，本文属 FreeBuf 原创奖励计划，未经许可禁止转载。</b></p><h2>前言</h2><p><b style="color: rgb(0, 176, 80);">想必熟悉 kali 或者接触过 smtp 相关分析的人都听说过 Swaks 这个工具。它号称 SMTP 界的瑞士军刀。工具会使固然厉害，但是不知道原理总觉得缺了点什么。于是我就用 Python 自己写了一个类似的工具，加上了邮件炸弹的功能，顺带分析一波原理。</b></p><h2>SMTP 协议</h2><p>SMTP 协议即简单邮件传输协议，属于 TCP/IP 协议簇，它是一组用于由源地址到目的地址传送邮件的规则，由它来控制信件的中转方式。SMTP 服务器则是遵循 SMTP 协议的发送邮件服务器，用来发送或中转发出的电子邮件。</p><p>SMTP 模型如下：</p><p style="text-align: center;"><img src="https://image.3001.net/images/20180914/1536920596_5b9b8c14db7fd.png!small" alt="SMTP 模型"></p><p>简单的通信过程如下（以 163 邮箱为例；以下返回均为正常情况）：</p><p>第一步是请求建立连接：</p><p>telnet：<code>telnet 163mx03.mxmail.netease.com 25</code></p><p>返回：<code>220 163.com Anti-spam GT for Coremail System (163com[20141201])</code></p><p>第二步是打开传输通道：</p><p>发送：<code>HELO &lt;domain&gt; &lt;CRLF&gt; </code>或 <code>EHLO &lt;domain/address-literal&gt; &lt;CRLF&gt;</code>。有什么区别呢？EHLO 更新一些，会返回 smtp 服务器支持的命令，相对比 HELO 要有用，所以基本用的都是 EHLO。HELO / EHLO 命令用于主机介绍它自己，可以被翻译为 Hello, I am &lt;domain&gt;.</p><p>返回：<code>250 OK</code> 或：</p><pre><code>250-mail\r\n250-PIPELINING\r\n250-AUTH LOGIN PLAIN\r\n250-AUTH=LOGIN PLAIN\r\n250-coremail 1Uxr2xKj7kG0xkI17xGrU7I0s8FY2U3Uj8Cz28x1UUUUU7Ic2I0Y2Urz44XGUCa0xDrUUUUj\r\n250-STARTTLS\r\n250-SIZE 73400320\r\n250 8BITMIME</code></pre><p>可以看到，EHLO 返回信息更加详细。</p><p>第三步是 MAIL 命令：</p><p>发送：<code>MAIL FROM:&lt;发送者邮箱&gt; &lt;CRLF&gt;</code></p><p>返回：<code>250 Mail OK</code></p><p>第四步是 RCPT 命令：</p><p>发送：<code>RCPT TO:&lt;接受者邮箱&gt;</code></p><p>返回：<code>250 Mail OK</code></p><p>第五步是 DATA 命令：</p><p>发送：<code>DATA &lt;CRLF&gt;</code></p><p>返回：<code>354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;</code></p><p>然后就可以输入邮件内容了，包括主题，邮件正文等等。</p><p>第五步结束后，服务端会返回邮件发送成功与否的情况：</p><p>返回：<code>&lt;= 250 Mail OK queued as mx13,P8CowAB3KDAxa5tbCxAiEg--.29768S2 1536912177</code></p><p>这样，一封简单的邮件就发出去了。当然，邮件服务器在这个过程中会做各种判断，以免轻易接受垃圾邮件。</p><p>完整的演示如下：</p><pre><code>&lt;= 220 163.com Anti-spam GT for Coremail System (163com[20141201])\r\n=&gt; ehlo antispam\r\n&lt;= 250-mail\r\n&lt;= 250-PIPELINING\r\n&lt;= 250-AUTH LOGIN PLAIN\r\n&lt;= 250-AUTH=LOGIN PLAIN\r\n&lt;= 250-coremail 1Uxr2xKj7kG0xkI17xGrU7I0s8FY2U3Uj8Cz28x1UUUUU7Ic2I0Y2UFQXaMIUCa0xDrUUUUj\r\n&lt;= 250-STARTTLS\r\n&lt;= 250-SIZE 73400320\r\n&lt;= 250 8BITMIME\r\n=&gt; mail from:&lt;hr@huawei.com&gt;\r\n&lt;= 250 Mail OK\r\n=&gt; rcpt to:&lt;手动打码@163.com&gt;\r\n&lt;= 250 Mail OK\r\n=&gt; data\r\n&lt;= 354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;\r\n=&gt; to: 手动打码@163.com\r\n=&gt; from: hr@huawei.com\r\n=&gt; subject: 这是一封垃圾邮件\r\n=&gt;\r\n=&gt; DKIM？听上去很好吃\r\n=&gt; SPF 不是防晒系数吗\r\n=&gt; 我觉得 SMTP 很安全啊\r\n=&gt; 我们不存在垃圾邮件，那些都是正常的邮件\r\n=&gt; 邮件炸弹也是不存在的\r\n=&gt; .\r\n&lt;= 250 Mail OK queued as mx3,NcCowADX4z1_bJtbcsNOQw--.37583S2 1536912511</code></pre><p>邮箱结果：</p><p style="text-align: center;"><img src="https://image.3001.net/images/20180914/1536920614_5b9b8c26a2753.png!small" alt="邮箱结果" width="690" height="514.452296819788"></p><p>那么，说了这么多 Telnet 发邮件，和正常发邮件的的方式很不一样。我们都是通过 web 界面或者 GUI 发的，如下：</p><p style="text-align: center;"><img src="https://image.3001.net/images/20180914/1536920630_5b9b8c36efd6c.png!small" alt="通过 web 界面或者 GUI 发的"></p><p>而我们使用 Telnet 直接发邮件，实际上是在模拟第二个 Send。</p><p>说清楚 SMTP 了，接下来说伪造邮件发件人。</p><h2>伪造邮件发件人</h2><p>回顾之前的 Telnet 发邮件的过程，我们可以看到，我们使用 mail from: 声称自己是 hr@huawei.com，而且 SMTP 协议本身也不要求对此声明做认证，所以伪造就是这样达成的。那么，经过这么多年的发展，厂商有对此做出了什么努力来解决这一问题呢？</p><h3>SPF：发送方策略框架</h3><p>SPF 是为了防范垃圾邮件而提出来的一种 DNS 记录类型，它是一种 TXT 类型的记录，它用于登记某个域名拥有的用来外发邮件的所有 IP 地址。发送人向接收方发送一封电子邮件后，邮件接收服务器接收电子邮件并执行如下操作：</p><blockquote>    <p>检查哪一个域声称发送了该邮件并检查该域的 SPF 记录的 DNS。</p></blockquote><blockquote>    <p>确定发送服务器的 IP 地址是否与 SPF 记录中的某个已发布 IP 地址相匹配。</p></blockquote><blockquote>    <p>对电子邮件进行打分：如果 IP 地址匹配，则邮件通过身份验证并获得一个正分。如果 IP 地址不匹配，则邮件无法通过身份验证并获得一个负分。然后，对现有的防垃圾邮件筛选策略和启发式筛选应用这些结果。或者直接拒绝接受，返回 550 MI:SPF。</p></blockquote><p>我们查一下 163 的 SPF 记录：</p><pre><code>&gt; nslookup -q=TXT 163.com\r\nServer:        202.117.112.3\r\nAddress:    202.117.112.3#53\r\n\r\nNon-authoritative answer:\r\n163.com    text = "v=spf1 include:spf.163.com -all"\r\n\r\nAuthoritative answers can be found from:\r\n163.com    nameserver = ns5.nease.net.\r\n163.com    nameserver = ns3.nease.net.\r\n163.com    nameserver = ns6.nease.net.\r\n163.com    nameserver = ns1.nease.net.\r\n163.com    nameserver = ns4.nease.net.\r\n163.com    nameserver = ns8.166.com.\r\n163.com    nameserver = ns2.166.com.\r\nns1.nease.net    internet address = 123.58.173.177\r\nns3.nease.net    internet address = 220.181.36.234\r\nns4.nease.net    internet address = 123.125.48.245\r\nns5.nease.net    internet address = 121.195.179.18\r\nns6.nease.net    internet address = 52.215.24.44</code></pre><p><code>v=spf1 include:spf.163.com -all</code>是什么意思呢？</p><p>SPF 记录包含在一个 TXT 记录之中，格式如下：</p><pre><code>v=spf1 [[pre] type [ext] ] ... [mod]</code></pre><p>1、v=spf1：SPF 的版本。如果使用 Sender ID 的话，这个字段就应该是 v=spf2</p><p>2、pre：定义匹配时的返回值。可能的返回值包括：</p><blockquote>    <p>+: 缺省值。在测试完成的时候表示通过。</p></blockquote><blockquote>    <p>-: 表示测试失败。这个值通常是 -all，表示没有其他任何匹配发生。</p></blockquote><blockquote>    <p>~: 表示软失败，通常表示测试没有完成。</p></blockquote><blockquote>    <p>?: 表示不置可否。这个值也通常在测试没有完成的时候使用。</p></blockquote><p>3、type：定义使用的确认测试的类型：</p><blockquote>    <p>include：包含一个给定的域名的测试。以 include:domain 的形式书写。</p></blockquote><blockquote>    <p>all：终止测试序列。比如，如果选项是 -all，那么到达这条记录也就意味着测试失败了。但是如果无法确定，可以使用"?all"来表示，这样，测试将被接受。</p></blockquote><blockquote>    <p>ip4：使用 IPv4 进行验证。这个可以以 ip4:ipv4 或 ip4:ipv4/cidr 的形式使用。</p></blockquote><p>4、ext：定义对 type 的可选扩展。如果没有这个字段，那么仅使用单个记录进行问询。</p><p>5、mod：这是最后的类型指示，作为记录的一个修正值。</p><p>测试后有以下结果：</p><blockquote>    <p>通过；SPF记录指定要允许发送的主机；接受</p>    <p>硬失败；SPF记录已将主机指定为不允许发送；拒绝</p>    <p>软失败；SPF记录已将主机指定为不被允许发送但正在转换；接受但标记</p>    <p>中性；SPF记录明确指出，对有效性无关；接受</p>    <p>没有；该域没有SPF记录，或者SPF记录不对结果进行评估；接受</p></blockquote><p>所以，当我们声称 hr@qq.com 向 163 发送邮件的时候，163 会不予接受（因为 qq 是有 spf 记录的）：</p><pre><code>&lt;= 220 163.com Anti-spam GT for Coremail System (163com[20141201])\r\n=&gt; ehlo antispam\r\n&lt;= 250-mail\r\n&lt;= 250-PIPELINING\r\n&lt;= 250-AUTH LOGIN PLAIN\r\n&lt;= 250-AUTH=LOGIN PLAIN\r\n&lt;= 250-coremail 1Uxr2xKj7kG0xkI17xGrU7I0s8FY2U3Uj8Cz28x1UUUUU7Ic2I0Y2UFsDjanUCa0xDrUUUUj\r\n&lt;= 250-STARTTLS\r\n&lt;= 250-SIZE 73400320\r\n&lt;= 250 8BITMIME\r\n=&gt; mail from:&lt;hr@qq.com&gt;\r\n&lt;= 550 MI:SPF 163 mx45,X8CowEB5qUXsdZtbeT4JTQ--.35331S2 1536914924 http://mail.163.com/help/help_spam_16.htm?ip=手动打码&amp;hostid=mx45&amp;time=1536914924</code></pre><h3>DKIM 与 DMARC</h3><p>DKIM 是一种防范电子邮件欺诈的验证技术，通过消息加密认证的方式对邮件发送域名进行验证。</p><p>DMARC 是一种基于现有的SPF和DKIM协议的可扩展电子邮件认证协议，在邮件收发双方建立了邮件反馈机制，便于邮件发送方和邮件接收方共同对域名的管理进行完善和监督。</p><p>感兴趣的话可以自行查阅资料。</p><h3>漏网之鱼</h3><p>又说了那么多，那么是否有了 SPF 可以一劳永逸呢？其实并不是。拿 163 与 qq 举例，查到发送方的 spf 记录，并且是标记的是硬失败，当然是最好的，直接进行判断。但是如果发送方用的是软失败甚至没有 spf 记录呢？比如 huawei.com 就是软失败：</p><pre><code>huawei.com text = "v=spf1 ip4:45.249.212.32 ip4:45.249.212.35 ip4:119.145.14.93 ip4:58.251.152.93 ip4:194.213.3.17 ip4:206.16.17.72 ip4:45.249.212.255 ip4:45.249.212.187/29 ip4:45.249.212.191 ip4:185.176.76.210 ~all"</code></pre><p>如果出现这样的情况，就得看厂商怎么做了，一般来说都是放行。</p><h2>邮件炸弹</h2><p>说完了伪造发件人，再来说说邮件炸弹。</p><p>电子邮件炸弹是最古老的匿名攻击之一，通过设置一台机器不断的大量的向同一地址发送电子邮件，攻击者能够耗尽接受者网络的宽带。由于这种攻击方式简单易用，也有很多发匿名邮件的工具，而且只要对方获悉你的电子邮件地址就可以进行攻击，所以这是大家最值得防范的一个攻击手段。</p><p>既然能伪造发件人，那么发送邮件炸弹看上去也不难。事实上的确如此。另外，由于大量的请求以及链接，会触发接收方各种抵制。接下来通过邮件炸弹的三种不同的方式谈谈。</p><h3>单线程</h3><p>单线程，发就好了，拿起死循环就是干：<code>while 1: xxxx</code></p><h3>多线程：短连接</h3><p>短连接就是我们最容易想到的，多线程，每个线程发起一次链接请求，发完一封就停止。线程数少点还好，一多就疯狂提示：421 Too many connections。在 ehlo antispam 的时候就被干掉了。实测大多数情况，100 线程发 能成功 20 封就已经很好了。而且发完一封就释放链接，蛮浪费的。而且在 smtp 服务器对频繁的连接请求很敏感的时候， ip 容易被 ban（如 qq）。</p><h3>多线程：长连接</h3><p>长连接：设定好线程数后，一旦 ehlo antispam 成功，就不停地重复 mail from 到 data，邮件发送成功后也不释放链接，一直发。若接收方 smtp 服务器强制释放此链接，则重新 ehlo antispam。这样的话，如果不手动停止，就会一直尝试链接、发邮件。轰炸效率 plus。</p><h3>email_hack</h3><p>根据上述的原理以及想法，我自己写了一个命令行的工具：email_hack</p><pre><code>usage: email_hack.py [-h] -faddr FROM_ADDRESS -taddr TO_ADDRESS\r\n                     [-tnum THREADS_NUM] [-v VERBOSE] [-c CRAZY_MODE]\r\n\r\noptional arguments:\r\n  -h, --help            show this help message and exit\r\n  -faddr FROM_ADDRESS, --from_address FROM_ADDRESS\r\n                        fake from address\r\n  -taddr TO_ADDRESS, --to_address TO_ADDRESS\r\n                        the address you want to delivery\r\n  -tnum THREADS_NUM, --threads_num THREADS_NUM\r\n                        how many threads you want\r\n  -v VERBOSE, --verbose VERBOSE\r\n                        verbose level\r\n  -c CRAZY_MODE, --crazy_mode CRAZY_MODE\r\n                        Keep sending fake email (** Use with caution **)</code></pre><p>详细内容可以到 gayhub 看看：<a href="https://github.com/Macr0phag3/email_hack" ref="nofollow">https://github.com/Macr0phag3/email_hack</a>。</p><p><b>伪造邮件效果：</b></p><p>163：</p><p style="text-align: center;"><img src="https://image.3001.net/images/20180914/1536920720_5b9b8c90bb57d.png!small" alt="163邮箱"></p><p>qq：</p><p style="text-align: center;"><img src="https://image.3001.net/images/20180917/1537184300_5b9f922c878c9.png!small" alt="QQ邮箱"></p><p><b>邮件炸弹效果：</b></p><p style="text-align: center;"><img src="https://image.3001.net/images/20180914/1536920662_5b9b8c5616d0a.png!small" alt="邮件炸弹效果"></p><p style="text-align: center;"><img src="https://image.3001.net/images/20180914/1536920678_5b9b8c660d5b2.png!small" alt="邮件炸弹效果"></p><h2>防御方法</h2><h3>伪造邮件发件人</h3><p>厂商：对 spf 记录采用 硬失败 的标记。且验证时预到软失败标记的时候，尽可能拒绝。有可能的话， 上DKIM 与 DMARC</p><p>用户：对于很重要的邮件信息，不妨查看一下邮件原文。</p><p style="text-align: center;"><img src="https://image.3001.net/images/20180917/1537184545_5b9f9321c34d3.png!small"></p><p style="text-align: center;"><img src="https://image.3001.net/images/20180917/1537184759_5b9f93f786f5b.png!small" alt="查看一下邮件原文"></p><p>若只有 一个 Received ，且列出的 IP 与宣称的地址不一致，则就是伪造的。虽然 Received 头可以伪造，但是新的 Received 头会添加在消息的头部，所以，如果存在伪造的 Received，那么它总是在后面。</p><p>若有多个 Received，第一个 Received 中 是正规的（网易、腾讯等等） SMTP 服务器 转发过的，那么肯定是经过验证的合法用户才能转发过来，因为这些厂商都不会开匿名转发，此时只需要看 IP 与宣称身份是否一致，一致就 OK。若看着就 不正规，则就要小心一些了。</p><p>举2个例子：</p><p>未被伪造：</p><p style="text-align: center;"><img src="https://image.3001.net/images/20180917/1537186883_5b9f9c43d8a0b.png!small" alt="未被伪造"></p><p style="text-align: center;"><img src="https://image.3001.net/images/20180917/1537187010_5b9f9cc23e20d.png!small" alt="未被伪造"></p><p>伪造：</p><p style="text-align: center;"><img src="https://image.3001.net/images/20180917/1537187530_5b9f9eca3bed6.png!small" alt="伪造"></p><p style="text-align: center;"><img src="https://image.3001.net/images/20180917/1537187456_5b9f9e8022bdb.png!small" alt="伪造"></p><h3>邮件炸弹</h3><p>对大量并发的连接请求，不但要拒绝，而且要禁止其 IP 一段时间。经过测试，qq 在大量请求后会进行封禁，163只是拒绝连接，返回类似 “请15分钟后再试”，其实还是可以接着发起连接请求的... ╮(╯▽╰)╭。最后，在邮件多次发送失败的时候，直接断开连接，不要保留通道，强制发送端重新发起连接请求。</p><p><b style="color: rgb(239, 71, 71);">*本文作者：Macr0phag3，本文属 FreeBuf 原创奖励计划，未经许可禁止转载。</b></p>',is_original:!0,is_reward:!0,is_reproduce:e,post_list:[]},serverMemuRender:e}],fetch:[],error:null,state:{counter:0,userInfo:{userInfo:{},skinData:{skin:"classical",vip:e,vip_time:""},dynamicCount:"",columnNumber:"",keyAuth:"",messageCount:{},isParty:e,guestRemind:e}},serverRendered:!0,routePath:"/sectool/184555.html"}}(!1,"Macr0phag3")</script><script src="https://www.freebuf.com/freebuf/2.1.0.f2bddb9b2047fee49046.js" defer></script><script src="https://www.freebuf.com/freebuf/2.1.0.9b4235960ae0c2cc9600.js" defer></script><script src="https://www.freebuf.com/freebuf/2.1.0.32658a830f395d50ed89.js" defer></script><script src="https://www.freebuf.com/freebuf/2.1.0.a53ea8b00779fcef0fe8.js" defer></script><script src="https://www.freebuf.com/freebuf/2.1.0.e258e4cfb199b83189c6.js" defer></script><script src="https://www.freebuf.com/freebuf/2.1.0.927944ae29787a1b414f.js" defer></script><script src="https://www.freebuf.com/freebuf/2.1.0.02cf93cfce14e2557064.js" defer></script><script src="https://www.freebuf.com/freebuf/2.1.0.d38dc245ca9b7dd8571d.js" defer></script><script src="https://www.freebuf.com/freebuf/2.1.0.2ce4e8f001d4b2b67fbb.js" defer></script><script src="https://www.freebuf.com/freebuf/2.1.0.627b1661cc29c3e32429.js" defer></script>
</body>
<script>var _hmt=_hmt||[];_hmt.push(["_setAccount","cc53db168808048541c6735ce30421f5"]),function(){var c=document.createElement("script");c.src="https://hm.baidu.com/hm.js?cc53db168808048541c6735ce30421f5";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(c,e)}()</script>
</html>
